<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › brcm80211 › brcmsmac › mac80211_if.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../../index.html"></a><h1>mac80211_if.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (c) 2010 Broadcom Corporation</span>
<span class="cm"> *</span>
<span class="cm"> * Permission to use, copy, modify, and/or distribute this software for any</span>
<span class="cm"> * purpose with or without fee is hereby granted, provided that the above</span>
<span class="cm"> * copyright notice and this permission notice appear in all copies.</span>
<span class="cm"> *</span>
<span class="cm"> * THE SOFTWARE IS PROVIDED &quot;AS IS&quot; AND THE AUTHOR DISCLAIMS ALL WARRANTIES</span>
<span class="cm"> * WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF</span>
<span class="cm"> * MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY</span>
<span class="cm"> * SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES</span>
<span class="cm"> * WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION</span>
<span class="cm"> * OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF OR IN</span>
<span class="cm"> * CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.</span>
<span class="cm"> */</span>

<span class="cp">#define __UNDEF_NO_VERSION__</span>
<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/bcma/bcma.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>
<span class="cp">#include &lt;defs.h&gt;</span>
<span class="cp">#include &quot;phy/phy_int.h&quot;</span>
<span class="cp">#include &quot;d11.h&quot;</span>
<span class="cp">#include &quot;channel.h&quot;</span>
<span class="cp">#include &quot;scb.h&quot;</span>
<span class="cp">#include &quot;pub.h&quot;</span>
<span class="cp">#include &quot;ucode_loader.h&quot;</span>
<span class="cp">#include &quot;mac80211_if.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>

<span class="cp">#define N_TX_QUEUES	4 </span><span class="cm">/* #tx queues on mac80211&lt;-&gt;driver interface */</span><span class="cp"></span>

<span class="cm">/* Flags we support */</span>
<span class="cp">#define MAC_FILTERS (FIF_PROMISC_IN_BSS | \</span>
<span class="cp">	FIF_ALLMULTI | \</span>
<span class="cp">	FIF_FCSFAIL | \</span>
<span class="cp">	FIF_CONTROL | \</span>
<span class="cp">	FIF_OTHER_BSS | \</span>
<span class="cp">	FIF_BCN_PRBRESP_PROMISC | \</span>
<span class="cp">	FIF_PSPOLL)</span>

<span class="cp">#define CHAN2GHZ(channel, freqency, chflags)  { \</span>
<span class="cp">	.band = IEEE80211_BAND_2GHZ, \</span>
<span class="cp">	.center_freq = (freqency), \</span>
<span class="cp">	.hw_value = (channel), \</span>
<span class="cp">	.flags = chflags, \</span>
<span class="cp">	.max_antenna_gain = 0, \</span>
<span class="cp">	.max_power = 19, \</span>
<span class="cp">}</span>

<span class="cp">#define CHAN5GHZ(channel, chflags)  { \</span>
<span class="cp">	.band = IEEE80211_BAND_5GHZ, \</span>
<span class="cp">	.center_freq = 5000 + 5*(channel), \</span>
<span class="cp">	.hw_value = (channel), \</span>
<span class="cp">	.flags = chflags, \</span>
<span class="cp">	.max_antenna_gain = 0, \</span>
<span class="cp">	.max_power = 21, \</span>
<span class="cp">}</span>

<span class="cp">#define RATE(rate100m, _flags) { \</span>
<span class="cp">	.bitrate = (rate100m), \</span>
<span class="cp">	.flags = (_flags), \</span>
<span class="cp">	.hw_value = (rate100m / 5), \</span>
<span class="cp">}</span>

<span class="k">struct</span> <span class="n">firmware_hdr</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">brcms_firmwares</span><span class="p">[</span><span class="n">MAX_FW_IMAGES</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;brcm/bcm43xx&quot;</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">n_adapters_found</span><span class="p">;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Broadcom Corporation&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Broadcom 802.11n wireless LAN driver.&quot;</span><span class="p">);</span>
<span class="n">MODULE_SUPPORTED_DEVICE</span><span class="p">(</span><span class="s">&quot;Broadcom 802.11n WLAN cards&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual BSD/GPL&quot;</span><span class="p">);</span>


<span class="cm">/* recognized BCMA Core IDs */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">bcma_device_id</span> <span class="n">brcms_coreid_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">BCMA_CORE</span><span class="p">(</span><span class="n">BCMA_MANUF_BCM</span><span class="p">,</span> <span class="n">BCMA_CORE_80211</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="n">BCMA_ANY_CLASS</span><span class="p">),</span>
	<span class="n">BCMA_CORE</span><span class="p">(</span><span class="n">BCMA_MANUF_BCM</span><span class="p">,</span> <span class="n">BCMA_CORE_80211</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="n">BCMA_ANY_CLASS</span><span class="p">),</span>
	<span class="n">BCMA_CORETABLE_END</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">bcma</span><span class="p">,</span> <span class="n">brcms_coreid_table</span><span class="p">);</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">msglevel</span> <span class="o">=</span> <span class="mh">0xdeadbeef</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">msglevel</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="cp">#endif				</span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">brcms_2ghz_chantable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CHAN2GHZ</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2412</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN2GHZ</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2417</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN2GHZ</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2422</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN2GHZ</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2427</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN2GHZ</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2432</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2GHZ</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2437</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2GHZ</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2442</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">CHAN2GHZ</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2447</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN2GHZ</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2452</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN2GHZ</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2457</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN2GHZ</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">2462</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN2GHZ</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">2467</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN2GHZ</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">2472</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN2GHZ</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">2484</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">brcms_5ghz_nphy_chantable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* UNII-1 */</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">40</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">44</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="cm">/* UNII-2 */</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">52</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">56</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="cm">/* MID */</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">104</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">108</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">112</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">116</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">124</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">132</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">136</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">140</span><span class="p">,</span>
		 <span class="n">IEEE80211_CHAN_RADAR</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_IBSS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span> <span class="o">|</span>
		 <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="cm">/* UNII-3 */</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">149</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">153</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">157</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">161</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span><span class="p">),</span>
	<span class="n">CHAN5GHZ</span><span class="p">(</span><span class="mi">165</span><span class="p">,</span> <span class="n">IEEE80211_CHAN_NO_HT40PLUS</span> <span class="o">|</span> <span class="n">IEEE80211_CHAN_NO_HT40MINUS</span><span class="p">)</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * The rate table is used for both 2.4G and 5G rates. The</span>
<span class="cm"> * latter being a subset as it does not support CCK rates.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">legacy_ratetable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">55</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">110</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">120</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">240</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">360</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">480</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATE</span><span class="p">(</span><span class="mi">540</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">brcms_band_2GHz_nphy_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">brcms_2ghz_chantable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">brcms_2ghz_chantable</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">legacy_ratetable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">legacy_ratetable</span><span class="p">),</span>
	<span class="p">.</span><span class="n">ht_cap</span> <span class="o">=</span> <span class="p">{</span>
		   <span class="cm">/* from include/linux/ieee80211.h */</span>
		   <span class="p">.</span><span class="n">cap</span> <span class="o">=</span> <span class="n">IEEE80211_HT_CAP_GRN_FLD</span> <span class="o">|</span>
			  <span class="n">IEEE80211_HT_CAP_SGI_20</span> <span class="o">|</span> <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">,</span>
		   <span class="p">.</span><span class="n">ht_supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		   <span class="p">.</span><span class="n">ampdu_factor</span> <span class="o">=</span> <span class="n">IEEE80211_HT_MAX_AMPDU_64K</span><span class="p">,</span>
		   <span class="p">.</span><span class="n">ampdu_density</span> <span class="o">=</span> <span class="n">AMPDU_DEF_MPDU_DENSITY</span><span class="p">,</span>
		   <span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="p">{</span>
			   <span class="cm">/* placeholders for now */</span>
			   <span class="p">.</span><span class="n">rx_mask</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
			   <span class="p">.</span><span class="n">rx_highest</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span>
			   <span class="p">.</span><span class="n">tx_params</span> <span class="o">=</span> <span class="n">IEEE80211_HT_MCS_TX_DEFINED</span><span class="p">}</span>
		   <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">brcms_band_5GHz_nphy_template</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">brcms_5ghz_nphy_chantable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">brcms_5ghz_nphy_chantable</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">legacy_ratetable</span> <span class="o">+</span> <span class="n">BRCMS_LEGACY_5G_RATE_OFFSET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">legacy_ratetable</span><span class="p">)</span> <span class="o">-</span>
			<span class="n">BRCMS_LEGACY_5G_RATE_OFFSET</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ht_cap</span> <span class="o">=</span> <span class="p">{</span>
		   <span class="p">.</span><span class="n">cap</span> <span class="o">=</span> <span class="n">IEEE80211_HT_CAP_GRN_FLD</span> <span class="o">|</span> <span class="n">IEEE80211_HT_CAP_SGI_20</span> <span class="o">|</span>
			  <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">,</span>
		   <span class="p">.</span><span class="n">ht_supported</span> <span class="o">=</span> <span class="nb">true</span><span class="p">,</span>
		   <span class="p">.</span><span class="n">ampdu_factor</span> <span class="o">=</span> <span class="n">IEEE80211_HT_MAX_AMPDU_64K</span><span class="p">,</span>
		   <span class="p">.</span><span class="n">ampdu_density</span> <span class="o">=</span> <span class="n">AMPDU_DEF_MPDU_DENSITY</span><span class="p">,</span>
		   <span class="p">.</span><span class="n">mcs</span> <span class="o">=</span> <span class="p">{</span>
			   <span class="cm">/* placeholders for now */</span>
			   <span class="p">.</span><span class="n">rx_mask</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">},</span>
			   <span class="p">.</span><span class="n">rx_highest</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">500</span><span class="p">),</span>
			   <span class="p">.</span><span class="n">tx_params</span> <span class="o">=</span> <span class="n">IEEE80211_HT_MCS_TX_DEFINED</span><span class="p">}</span>
		   <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* flags the given rate in rateset as requested */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_set_basic_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcm_rateset</span> <span class="o">*</span><span class="n">rs</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rate</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_br</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">rs</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">!=</span> <span class="p">(</span><span class="n">rs</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_br</span><span class="p">)</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">BRCMS_RATE_FLAG</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rs</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">BRCMS_RATE_MASK</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_ops_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;ops-&gt;tx called while down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">brcms_c_sendpkt_mac80211</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>
 <span class="nl">done:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcms_ops_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">blocked</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">blocked</span> <span class="o">=</span> <span class="n">brcms_rfkill_set_hw_state</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">blocked</span><span class="p">)</span>
		<span class="n">wiphy_rfkill_stop_polling</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/* avoid acknowledging frames before a non-monitor device is added */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">mute_tx</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcms_up</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: brcms_up() returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			  <span class="n">err</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_ops_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">brcms_c_chipmatch</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">vendorid</span><span class="p">,</span>
				   <span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">deviceid</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
			  <span class="s">&quot;wl: brcms_ops_stop: chipmatch failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* put driver in down state */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">brcms_down</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcms_ops_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="cm">/* Just STA for now */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: Attempt to add type %d, only&quot;</span>
			  <span class="s">&quot; STA for now</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">mute_tx</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">brcms_c_mute</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_ops_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcms_ops_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">new_int</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_LISTEN_INTERVAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_c_set_beacon_listen_interval</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span>
						   <span class="n">conf</span><span class="o">-&gt;</span><span class="n">listen_interval</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_MONITOR</span><span class="p">)</span>
		<span class="n">wiphy_dbg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: change monitor mode: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_MONITOR</span> <span class="o">?</span>
			  <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_PS</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: change power-save mode: %s (implement)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_PS</span> <span class="o">?</span>
			  <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_POWER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcms_c_set_tx_power</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: Error setting power_level</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">config_out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">new_int</span> <span class="o">=</span> <span class="n">brcms_c_get_tx_power</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_int</span> <span class="o">!=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">)</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: Power level req != actual, %d %d&quot;</span>
				  <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">,</span>
				  <span class="n">new_int</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_CHANNEL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_HT20</span> <span class="o">||</span>
		    <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel_type</span> <span class="o">==</span> <span class="n">NL80211_CHAN_NO_HT</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">brcms_c_set_channel</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span>
						  <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_RETRY_LIMITS</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">brcms_c_set_rate_limit</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span>
					     <span class="n">conf</span><span class="o">-&gt;</span><span class="n">short_frame_max_tx_count</span><span class="p">,</span>
					     <span class="n">conf</span><span class="o">-&gt;</span><span class="n">long_frame_max_tx_count</span><span class="p">);</span>

 <span class="nl">config_out:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_ops_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ASSOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* association status changed (associated/disassociated)</span>
<span class="cm">		 * also implies a change in the AID.</span>
<span class="cm">		 */</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: %s: %sassociated</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">assoc</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;dis&quot;</span><span class="p">);</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">brcms_c_associate_upd</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">assoc</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s8</span> <span class="n">val</span><span class="p">;</span>

		<span class="cm">/* slot timing changed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">use_short_slot</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">brcms_c_set_shortslot_override</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_HT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* 802.11n parameters changed */</span>
		<span class="n">u16</span> <span class="n">mode</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">ht_operation_mode</span><span class="p">;</span>

		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_N_CFG</span><span class="p">,</span>
			<span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_OP_MODE_PROTECTION</span><span class="p">);</span>
		<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_N_NONGF</span><span class="p">,</span>
			<span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_OP_MODE_NON_GF_STA_PRSNT</span><span class="p">);</span>
		<span class="n">brcms_c_protection_upd</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">BRCMS_PROT_N_OBSS</span><span class="p">,</span>
			<span class="n">mode</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_OP_MODE_NON_HT_STA_PRSNT</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BASIC_RATES</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">bi</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">br_mask</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">rate</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">brcm_rateset</span> <span class="n">rs</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

		<span class="cm">/* retrieve the current rates */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">brcms_c_get_current_rateset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">br_mask</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">;</span>
		<span class="n">bi</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">brcms_c_get_curband</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">)];</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bi</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* convert to internal rate value */</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">bi</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mi">10</span><span class="p">;</span>

			<span class="cm">/* set/clear basic rate flag */</span>
			<span class="n">brcms_set_basic_rate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">br_mask</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">br_mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* update the rate set */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">brcms_c_set_rateset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;changing basic rates failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">error</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Beacon interval changed */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">brcms_c_set_beacon_period</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BSSID</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* BSSID changed, for whatever reason (IBSS and managed mode) */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">brcms_c_set_addrmatch</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">RCM_BSSID_OFFSET</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON</span><span class="p">)</span>
		<span class="cm">/* Beacon data changed, retrieve new beacon (beaconing modes) */</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: beacon changed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_ENABLED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Beaconing should be enabled/disabled (beaconing modes) */</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: Beacon enabled: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			  <span class="n">info</span><span class="o">-&gt;</span><span class="n">enable_beacon</span> <span class="o">?</span> <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_CQM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Connection quality monitor config changed */</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: cqm change: threshold %d, hys %d &quot;</span>
			  <span class="s">&quot; (implement)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cqm_rssi_thold</span><span class="p">,</span>
			  <span class="n">info</span><span class="o">-&gt;</span><span class="n">cqm_rssi_hyst</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_IBSS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* IBSS join status changed */</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: IBSS joined: %s (implement)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			  <span class="n">info</span><span class="o">-&gt;</span><span class="n">ibss_joined</span> <span class="o">?</span> <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ARP_FILTER</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Hardware ARP filter address list or state changed */</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: arp filtering: enabled %s, count %d&quot;</span>
			  <span class="s">&quot; (implement)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">arp_filter_enabled</span> <span class="o">?</span>
			  <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">arp_addr_cnt</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_QOS</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * QoS for this association was enabled/disabled.</span>
<span class="cm">		 * Note that it is only ever disabled for station mode.</span>
<span class="cm">		 */</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: qos enabled: %s (implement)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			  <span class="n">info</span><span class="o">-&gt;</span><span class="n">qos</span> <span class="o">?</span> <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">brcms_ops_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed_flags</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">,</span> <span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="n">changed_flags</span> <span class="o">&amp;=</span> <span class="n">MAC_FILTERS</span><span class="p">;</span>
	<span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;=</span> <span class="n">MAC_FILTERS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">)</span>
		<span class="n">wiphy_dbg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;FIF_PROMISC_IN_BSS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">FIF_ALLMULTI</span><span class="p">)</span>
		<span class="n">wiphy_dbg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;FIF_ALLMULTI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">FIF_FCSFAIL</span><span class="p">)</span>
		<span class="n">wiphy_dbg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;FIF_FCSFAIL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">)</span>
		<span class="n">wiphy_dbg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;FIF_CONTROL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">FIF_OTHER_BSS</span><span class="p">)</span>
		<span class="n">wiphy_dbg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;FIF_OTHER_BSS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PSPOLL</span><span class="p">)</span>
		<span class="n">wiphy_dbg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;FIF_PSPOLL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">changed_flags</span> <span class="o">&amp;</span> <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">)</span>
		<span class="n">wiphy_dbg</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;FIF_BCN_PRBRESP_PROMISC</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">brcms_c_mac_promisc</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_ops_sw_scan_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">brcms_c_scan_start</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_ops_sw_scan_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">brcms_c_scan_stop</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcms_ops_conf_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">queue</span><span class="p">,</span>
		  <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">brcms_c_wme_setparams</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">queue</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcms_ops_sta_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
	       <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pri_scb</span><span class="p">;</span>

	<span class="n">brcms_c_init_scb</span><span class="p">(</span><span class="n">scb</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">global_ampdu</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">scb_ampdu</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">global_ampdu</span><span class="o">-&gt;</span><span class="n">scb</span> <span class="o">=</span> <span class="n">scb</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">global_ampdu</span><span class="o">-&gt;</span><span class="n">max_pdu</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * minstrel_ht initiates addBA on our behalf by calling</span>
<span class="cm">	 * ieee80211_start_tx_ba_session()</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">brcms_ops_ampdu_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
		    <span class="k">enum</span> <span class="n">ieee80211_ampdu_mlme_action</span> <span class="n">action</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">ssn</span><span class="p">,</span>
		    <span class="n">u8</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">scb</span> <span class="o">*</span><span class="n">scb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pri_scb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">scb</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">SCB_MAGIC</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIDRM</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_START</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_STOP</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_START</span>:
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">brcms_c_aggregatable</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;START: tid %d is not agg</span><span class="se">\&#39;</span><span class="s">able</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">tid</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ieee80211_start_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_STOP</span>:
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">brcms_c_ampdu_flush</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">ieee80211_stop_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_OPERATIONAL</span>:
		<span class="cm">/*</span>
<span class="cm">		 * BA window size from ADDBA response (&#39;buf_size&#39;) defines how</span>
<span class="cm">		 * many outstanding MPDUs are allowed for the BA stream by</span>
<span class="cm">		 * recipient and traffic class. &#39;ampdu_factor&#39; gives maximum</span>
<span class="cm">		 * AMPDU size.</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">brcms_c_ampdu_tx_operational</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span>
			<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">IEEE80211_HT_MAX_AMPDU_FACTOR</span> <span class="o">+</span>
			 <span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ampdu_factor</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="cm">/* Power save wakeup */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: Invalid command, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_ops_rfkill_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">blocked</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">blocked</span> <span class="o">=</span> <span class="n">brcms_c_check_radio_disabled</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">blocked</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_ops_flush</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">bool</span> <span class="n">drop</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">no_printk</span><span class="p">(</span><span class="s">&quot;%s: drop = %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">drop</span> <span class="o">?</span> <span class="s">&quot;true&quot;</span> <span class="o">:</span> <span class="s">&quot;false&quot;</span><span class="p">);</span>

	<span class="cm">/* wait for packet queue and dma fifos to run empty */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">brcms_c_wait_for_tx_completion</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">drop</span><span class="p">);</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">brcms_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">brcms_ops_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">brcms_ops_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">brcms_ops_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span> <span class="o">=</span> <span class="n">brcms_ops_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span> <span class="o">=</span> <span class="n">brcms_ops_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">brcms_ops_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span> <span class="o">=</span> <span class="n">brcms_ops_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span> <span class="o">=</span> <span class="n">brcms_ops_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sw_scan_start</span> <span class="o">=</span> <span class="n">brcms_ops_sw_scan_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sw_scan_complete</span> <span class="o">=</span> <span class="n">brcms_ops_sw_scan_complete</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conf_tx</span> <span class="o">=</span> <span class="n">brcms_ops_conf_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_add</span> <span class="o">=</span> <span class="n">brcms_ops_sta_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ampdu_action</span> <span class="o">=</span> <span class="n">brcms_ops_ampdu_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rfkill_poll</span> <span class="o">=</span> <span class="n">brcms_ops_rfkill_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush</span> <span class="o">=</span> <span class="n">brcms_ops_flush</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * is called in brcms_bcma_probe() context, therefore no locking required.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcms_set_hint</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">abbrev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">regulatory_hint</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">abbrev</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_dpc</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>

	<span class="n">wl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* call the common second level interrupt handler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">resched</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">brcms_c_intrsupd</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">resched</span> <span class="o">=</span> <span class="n">brcms_c_dpc</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* brcms_c_dpc() may bring the driver down */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

	<span class="cm">/* re-schedule dpc */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">resched</span><span class="p">)</span>
		<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="cm">/* re-enable interrupts */</span>
		<span class="n">brcms_intrson</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

 <span class="nl">done:</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Precondition: Since this function is called in brcms_pci_probe() context,</span>
<span class="cm"> * no locking is required.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcms_request_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">device</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">fw_name</span><span class="p">[</span><span class="mi">100</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_firmware</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FW_IMAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">brcms_firmwares</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">fw_name</span><span class="p">,</span> <span class="s">&quot;%s-%d.fw&quot;</span><span class="p">,</span> <span class="n">brcms_firmwares</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="n">UCODE_LOADER_API_VER</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_bin</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: fail to load firmware %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">fw_name</span><span class="p">,</span> <span class="s">&quot;%s_hdr-%d.fw&quot;</span><span class="p">,</span> <span class="n">brcms_firmwares</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="n">UCODE_LOADER_API_VER</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_hdr</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">fw_name</span><span class="p">,</span> <span class="n">device</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: fail to load firmware %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">fw_name</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">hdr_num_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_hdr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">/</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">firmware_hdr</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_cnt</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">brcms_ucode_data_init</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ucode</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Precondition: Since this function is called in brcms_pci_probe() context,</span>
<span class="cm"> * no locking is required.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_release_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FW_IMAGES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_bin</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">release_firmware</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_hdr</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * This function frees the WL per-device resources.</span>
<span class="cm"> *</span>
<span class="cm"> * This function frees resources owned by the WL device pointed to</span>
<span class="cm"> * by the wl parameter.</span>
<span class="cm"> *</span>
<span class="cm"> * precondition: can both be called locked and unlocked</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_timer</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>

	<span class="cm">/* free ucode data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_cnt</span><span class="p">)</span>
		<span class="n">brcms_ucode_data_free</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ucode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>

	<span class="cm">/* kill dpc */</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">)</span>
		<span class="n">brcms_c_module_unregister</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="s">&quot;linux&quot;</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>

	<span class="cm">/* free common resources */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">brcms_c_detach</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* virtual interface deletion is deferred so we cannot spinwait */</span>

	<span class="cm">/* wait for all pending callbacks to complete */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">schedule</span><span class="p">();</span>

	<span class="cm">/* free timers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">t</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">;</span> <span class="n">t</span><span class="p">;</span> <span class="n">t</span> <span class="o">=</span> <span class="n">next</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">next</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* called from both kernel as from this kernel module (error flow on attach)</span>
<span class="cm">* precondition: perimeter lock is not acquired.</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">bcma_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="n">wiphy_rfkill_stop_polling</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
		<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">brcms_free</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">bcma_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">brcms_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">ours</span><span class="p">,</span> <span class="n">wantdpc</span><span class="p">;</span>

	<span class="n">wl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">);</span>

	<span class="cm">/* call common first level interrupt handler */</span>
	<span class="n">ours</span> <span class="o">=</span> <span class="n">brcms_c_isr</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wantdpc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ours</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* if more to do... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wantdpc</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* ...and call the second level interrupt handler */</span>
			<span class="cm">/* schedule dpc */</span>
			<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">ours</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * is called in brcms_pci_probe() context, therefore no locking required.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee_hw_rate_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_c_info</span> <span class="o">*</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">band</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">has_5g</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">phy_type</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">phy_type</span> <span class="o">=</span> <span class="n">brcms_c_get_phy_type</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">PHY_TYPE_N</span> <span class="o">||</span> <span class="n">phy_type</span> <span class="o">==</span> <span class="n">PHY_TYPE_LCN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">band</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">BAND_2G_INDEX</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
		<span class="o">*</span><span class="n">band</span> <span class="o">=</span> <span class="n">brcms_band_2GHz_nphy_template</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">PHY_TYPE_LCN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Single stream */</span>
			<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">band</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_highest</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">72</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Assume all bands use the same phy.  True for 11n devices. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">_nbands</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">has_5g</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_type</span> <span class="o">==</span> <span class="n">PHY_TYPE_N</span> <span class="o">||</span> <span class="n">phy_type</span> <span class="o">==</span> <span class="n">PHY_TYPE_LCN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">band</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">bandstate</span><span class="p">[</span><span class="n">BAND_5G_INDEX</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
			<span class="o">*</span><span class="n">band</span> <span class="o">=</span> <span class="n">brcms_band_5GHz_nphy_template</span><span class="p">;</span>
			<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="n">band</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * is called in brcms_pci_probe() context, therefore no locking required.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ieee_hw_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_HW_SIGNAL_DBM</span>
	    <span class="cm">/* | IEEE80211_HW_CONNECTION_MONITOR  What is this? */</span>
	    <span class="o">|</span> <span class="n">IEEE80211_HW_REPORTS_TX_ACK_STATUS</span>
	    <span class="o">|</span> <span class="n">IEEE80211_HW_AMPDU_AGGREGATION</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">extra_tx_headroom</span> <span class="o">=</span> <span class="n">brcms_c_get_header_len</span><span class="p">();</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="n">N_TX_QUEUES</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rates</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>	<span class="cm">/* Primary rate and 1 fallback rate */</span>

	<span class="cm">/* channel change time is dependent on chip and band  */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">channel_change_time</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rate_control_algorithm</span> <span class="o">=</span> <span class="s">&quot;minstrel_ht&quot;</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">sta_data_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ieee_hw_rate_init</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * attach to the WL device.</span>
<span class="cm"> *</span>
<span class="cm"> * Attach to the WL device identified by vendor and device parameters.</span>
<span class="cm"> * regs is a host accessible memory address pointing to WL device registers.</span>
<span class="cm"> *</span>
<span class="cm"> * brcms_attach is not defined as static because in the case where no bus</span>
<span class="cm"> * is defined, wl_attach will never be called, and thus, gcc will issue</span>
<span class="cm"> * a warning that this function is defined but not used if we declare</span>
<span class="cm"> * it as static.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * is called in brcms_bcma_probe() context, therefore no locking required.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="nf">brcms_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unit</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">perm</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>

	<span class="n">unit</span> <span class="o">=</span> <span class="n">n_adapters_found</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unit</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* allocate private info */</span>
	<span class="n">hw</span> <span class="o">=</span> <span class="n">bcma_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hw</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">hw</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="n">WARN_ON</span><span class="p">(</span><span class="n">wl</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* setup the bottom half handler */</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tasklet</span><span class="p">,</span> <span class="n">brcms_dpc</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">wl</span><span class="p">);</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">);</span>

	<span class="cm">/* prepare ucode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">brcms_request_fw</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">pdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: Failed to find firmware usually in &quot;</span>
			  <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="s">&quot;/lib/firmware/brcm&quot;</span><span class="p">);</span>
		<span class="n">brcms_release_fw</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
		<span class="n">brcms_remove</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* common load-time initialization */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span> <span class="o">=</span> <span class="n">brcms_c_attach</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">wl</span><span class="p">,</span> <span class="n">pdev</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">err</span><span class="p">);</span>
	<span class="n">brcms_release_fw</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: attach() failed with code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span> <span class="o">=</span> <span class="n">brcms_c_pub</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>

	<span class="cm">/* register our interrupt handler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">brcms_isr</span><span class="p">,</span>
			<span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">wl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: request_irq() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="cm">/* register module */</span>
	<span class="n">brcms_c_module_register</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="p">,</span> <span class="s">&quot;linux&quot;</span><span class="p">,</span> <span class="n">wl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee_hw_init</span><span class="p">(</span><span class="n">hw</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: %s: ieee_hw_init failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">perm</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">cur_etheraddr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">perm</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">perm</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: ieee80211_register_hw failed, status&quot;</span>
			  <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">srom_ccode</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="n">brcms_set_hint</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">srom_ccode</span><span class="p">))</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: regulatory_hint failed, status %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">n_adapters_found</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">wl</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">brcms_free</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/**</span>
<span class="cm"> * determines if a device is a WL device, and if so, attaches it.</span>
<span class="cm"> *</span>
<span class="cm"> * This function determines if a device pointed to by pdev is a WL device,</span>
<span class="cm"> * and if so, performs a brcms_attach() on it.</span>
<span class="cm"> *</span>
<span class="cm"> * Perimeter lock is initialized in the course of this function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">brcms_bcma_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;mfg %x core %x rev %d class %d irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">manuf</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">rev</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">class</span><span class="p">,</span>
		 <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">manuf</span> <span class="o">!=</span> <span class="n">BCMA_MANUF_BCM</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">id</span> <span class="o">!=</span> <span class="n">BCMA_CORE_80211</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">ieee80211_alloc_hw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">brcms_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: ieee80211_alloc_hw failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">bcma_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">hw</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl</span><span class="p">));</span>

	<span class="n">wl</span> <span class="o">=</span> <span class="n">brcms_attach</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: brcms_attach failed!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcms_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">bcma_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">wl</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: %s: no driver private struct!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* only need to flag hw is down for proper resume */</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">hw_up</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;brcms_suspend ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">brcms_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">bcma_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;brcms_resume ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bcma_driver</span> <span class="n">brcms_bcma_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>     <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">brcms_bcma_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>  <span class="o">=</span> <span class="n">brcms_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>   <span class="o">=</span> <span class="n">brcms_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">brcms_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">brcms_coreid_table</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * This is the main entry point for the brcmsmac driver.</span>
<span class="cm"> *</span>
<span class="cm"> * This function is scheduled upon module initialization and</span>
<span class="cm"> * does the driver registration, which result in brcms_bcma_probe()</span>
<span class="cm"> * call resulting in the driver bringup.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">brcms_driver_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">bcma_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">brcms_bcma_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: register returned %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">error</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">brcms_driver_work</span><span class="p">,</span> <span class="n">brcms_driver_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">brcms_module_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msglevel</span> <span class="o">!=</span> <span class="mh">0xdeadbeef</span><span class="p">)</span>
		<span class="n">brcm_msg_level</span> <span class="o">=</span> <span class="n">msglevel</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">brcms_driver_work</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * This function unloads the brcmsmac driver from the system.</span>
<span class="cm"> *</span>
<span class="cm"> * This function unconditionally unloads the brcmsmac driver module from the</span>
<span class="cm"> * system.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">brcms_module_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">brcms_driver_work</span><span class="p">);</span>
	<span class="n">bcma_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">brcms_bcma_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">brcms_module_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">brcms_module_exit</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * precondition: perimeter lock has been acquired</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_txflowcontrol</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcms_if</span> <span class="o">*</span><span class="n">wlif</span><span class="p">,</span>
			 <span class="n">bool</span> <span class="n">state</span><span class="p">,</span> <span class="kt">int</span> <span class="n">prio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;Shouldn&#39;t be here %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * precondition: perimeter lock has been acquired</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
	<span class="n">brcms_reset</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">brcms_c_init</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">mute_tx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * precondition: perimeter lock has been acquired</span>
<span class="cm"> */</span>
<span class="n">uint</span> <span class="nf">brcms_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BCMMSG</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
	<span class="n">brcms_c_reset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>

	<span class="cm">/* dpc will not be rescheduled */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">resched</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_fatal_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;wl%d: fatal error, reinitializing</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">unit</span><span class="p">);</span>
	<span class="n">brcms_reset</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">ieee80211_restart_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * These are interrupt on/off entry points. Disable interrupts</span>
<span class="cm"> * during interrupt state transition.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_intrson</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">brcms_c_intrson</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">brcms_intrsoff</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">brcms_c_intrsoff</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">brcms_intrsrestore</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">macintmask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">brcms_c_intrsrestore</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">,</span> <span class="n">macintmask</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">isr_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * precondition: perimeter lock has been acquired</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">brcms_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">up</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">brcms_c_up</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * precondition: perimeter lock has been acquired</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">uint</span> <span class="n">callbacks</span><span class="p">,</span> <span class="n">ret_val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* call common down function */</span>
	<span class="n">ret_val</span> <span class="o">=</span> <span class="n">brcms_c_down</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>
	<span class="n">callbacks</span> <span class="o">=</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">)</span> <span class="o">-</span> <span class="n">ret_val</span><span class="p">;</span>

	<span class="cm">/* wait for down callbacks to complete */</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* For HIGH_only driver, it&#39;s important to actually schedule other work,</span>
<span class="cm">	 * not just spin wait since everything runs at schedule level</span>
<span class="cm">	 */</span>
	<span class="n">SPINWAIT</span><span class="p">((</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">callbacks</span><span class="p">),</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">* precondition: perimeter lock is not acquired</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_brcms_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_timer</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">brcms_timer</span><span class="p">,</span>
					     <span class="n">dly_wrk</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">periodic</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">);</span>
			<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span><span class="p">,</span>
						     <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">dly_wrk</span><span class="p">,</span>
						     <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">ms</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">t</span><span class="o">-&gt;</span><span class="n">fn</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Adds a timer to the list. Caller supplies a timer function.</span>
<span class="cm"> * Is called from wlc.</span>
<span class="cm"> *</span>
<span class="cm"> * precondition: perimeter lock has been acquired</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">brcms_timer</span> <span class="o">*</span><span class="nf">brcms_init_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				     <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">fn</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">),</span>
				     <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_timer</span> <span class="o">*</span><span class="n">t</span><span class="p">;</span>

	<span class="n">t</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_timer</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">t</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">dly_wrk</span><span class="p">,</span> <span class="n">_brcms_timer</span><span class="p">);</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wl</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">timers</span> <span class="o">=</span> <span class="n">t</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">t</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * adds only the kernel timer since it&#39;s going to be more accurate</span>
<span class="cm"> * as well as it&#39;s easier to make it periodic</span>
<span class="cm"> *</span>
<span class="cm"> * precondition: perimeter lock has been acquired</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_add_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_timer</span> <span class="o">*</span><span class="n">t</span><span class="p">,</span> <span class="n">uint</span> <span class="n">ms</span><span class="p">,</span> <span class="kt">int</span> <span class="n">periodic</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">)</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: Already set. Name: %s, per %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">periodic</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">ms</span> <span class="o">=</span> <span class="n">ms</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">periodic</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span> <span class="n">periodic</span><span class="p">;</span>
	<span class="n">t</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">);</span>

	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">dly_wrk</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">ms</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * return true if timer successfully deleted, false if still pending</span>
<span class="cm"> *</span>
<span class="cm"> * precondition: perimeter lock has been acquired</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">brcms_del_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_timer</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">set</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">t</span><span class="o">-&gt;</span><span class="n">set</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">dly_wrk</span><span class="p">))</span>
			<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">callbacks</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * precondition: perimeter lock has been acquired</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_free_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_timer</span> <span class="o">*</span><span class="n">t</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">brcms_timer</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* delete the timer in case it is active */</span>
	<span class="n">brcms_del_timer</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">timers</span> <span class="o">==</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">timers</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">timers</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">timers</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">==</span> <span class="n">t</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="cp">#endif</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">t</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * precondition: perimeter lock has been acquired</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">brcms_ucode_init_buf</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="kt">void</span> <span class="o">**</span><span class="n">pbuf</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">firmware_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">firmware_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_hdr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">entry</span> <span class="o">&lt;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">hdr_num_entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		     <span class="n">entry</span><span class="o">++</span><span class="p">,</span> <span class="n">hdr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pdata</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_bin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
				<span class="o">*</span><span class="n">pbuf</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">pdata</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">pbuf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;ERROR: ucode buf tag:%d can not be found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">idx</span><span class="p">);</span>
	<span class="o">*</span><span class="n">pbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">fail:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Precondition: Since this function is called in brcms_bcma_probe() context,</span>
<span class="cm"> * no locking is required.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">brcms_ucode_init_uint</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">n_bytes</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">firmware_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_cnt</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">firmware_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_hdr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">entry</span> <span class="o">&lt;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">hdr_num_entries</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		     <span class="n">entry</span><span class="o">++</span><span class="p">,</span> <span class="n">hdr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">idx</span><span class="p">)</span> <span class="o">==</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pdata</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_bin</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span>
					<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
						  <span class="s">&quot;ERROR: fw hdr len</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOMSG</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="o">*</span><span class="n">n_bytes</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">pdata</span><span class="p">));</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;ERROR: ucode tag:%d can not be found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMSG</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * precondition: can both be called locked and unlocked</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_ucode_free_buf</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * checks validity of all firmware images loaded from user space</span>
<span class="cm"> *</span>
<span class="cm"> * Precondition: Since this function is called in brcms_bcma_probe() context,</span>
<span class="cm"> * no locking is required.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">brcms_check_firmwares</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">firmware_hdr</span> <span class="o">*</span><span class="n">ucode_hdr</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_FW_IMAGES</span> <span class="o">&amp;&amp;</span> <span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fw</span> <span class="o">=</span>  <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_bin</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">fw_hdr</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_hdr</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fw</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">fw_hdr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fw</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">fw_hdr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: invalid bin/hdr fw</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">__func__</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">%</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">firmware_hdr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: non integral fw hdr file &quot;</span>
				<span class="s">&quot;size %zu/%zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">firmware_hdr</span><span class="p">));</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">MIN_FW_SIZE</span> <span class="o">||</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">MAX_FW_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: out of bounds fw file size &quot;</span>
				  <span class="s">&quot;%zu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* check if ucode section overruns firmware image */</span>
			<span class="n">ucode_hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">firmware_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">fw_hdr</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">entry</span> <span class="o">&lt;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">hdr_num_entries</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span>
			     <span class="o">!</span><span class="n">rc</span><span class="p">;</span> <span class="n">entry</span><span class="o">++</span><span class="p">,</span> <span class="n">ucode_hdr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ucode_hdr</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">+</span>
				    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ucode_hdr</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span> <span class="o">&gt;</span>
				    <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
						  <span class="s">&quot;%s: conflicting bin/hdr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						  <span class="n">__func__</span><span class="p">);</span>
					<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_cnt</span> <span class="o">!=</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wiphy_err</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="s">&quot;%s: invalid fw_cnt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">fw_cnt</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * precondition: perimeter lock has been acquired</span>
<span class="cm"> */</span>
<span class="n">bool</span> <span class="nf">brcms_rfkill_set_hw_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">blocked</span> <span class="o">=</span> <span class="n">brcms_c_check_radio_disabled</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">wlc</span><span class="p">);</span>

	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">blocked</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">blocked</span><span class="p">)</span>
		<span class="n">wiphy_rfkill_start_polling</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">pub</span><span class="o">-&gt;</span><span class="n">ieee_hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">blocked</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * precondition: perimeter lock has been acquired</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">brcms_msleep</span><span class="p">(</span><span class="k">struct</span> <span class="n">brcms_info</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="n">uint</span> <span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">ms</span><span class="p">);</span>
	<span class="n">spin_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:5}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../../javascript/docco.min.js"></script>
</html>
