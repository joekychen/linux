<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › b43legacy › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *</span>
<span class="cm"> *  Broadcom B43legacy wireless driver</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2005 Martin Langer &lt;martin-langer@gmx.de&gt;</span>
<span class="cm"> *  Copyright (c) 2005-2008 Stefano Brivio &lt;stefano.brivio@polimi.it&gt;</span>
<span class="cm"> *  Copyright (c) 2005, 2006 Michael Buesch &lt;m@bues.ch&gt;</span>
<span class="cm"> *  Copyright (c) 2005 Danny van Dyk &lt;kugelfang@gentoo.org&gt;</span>
<span class="cm"> *  Copyright (c) 2005 Andreas Jaggi &lt;andreas.jaggi@waterwave.ch&gt;</span>
<span class="cm"> *  Copyright (c) 2007 Larry Finger &lt;Larry.Finger@lwfinger.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  Some parts of the code in this file are derived from the ipw2200</span>
<span class="cm"> *  driver  Copyright(c) 2003 - 2004 Intel Corporation.</span>

<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; see the file COPYING.  If not, write to</span>
<span class="cm"> *  the Free Software Foundation, Inc., 51 Franklin Steet, Fifth Floor,</span>
<span class="cm"> *  Boston, MA 02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/dst.h&gt;</span>
<span class="cp">#include &lt;asm/unaligned.h&gt;</span>

<span class="cp">#include &quot;b43legacy.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>
<span class="cp">#include &quot;debugfs.h&quot;</span>
<span class="cp">#include &quot;phy.h&quot;</span>
<span class="cp">#include &quot;dma.h&quot;</span>
<span class="cp">#include &quot;pio.h&quot;</span>
<span class="cp">#include &quot;sysfs.h&quot;</span>
<span class="cp">#include &quot;xmit.h&quot;</span>
<span class="cp">#include &quot;radio.h&quot;</span>


<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Broadcom B43legacy wireless driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Martin Langer&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Stefano Brivio&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Michael Buesch&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;b43legacy/ucode2.fw&quot;</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="s">&quot;b43legacy/ucode4.fw&quot;</span><span class="p">);</span>

<span class="cp">#if defined(CONFIG_B43LEGACY_DMA) &amp;&amp; defined(CONFIG_B43LEGACY_PIO)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_pio</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">pio</span><span class="p">,</span> <span class="n">modparam_pio</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">pio</span><span class="p">,</span> <span class="s">&quot;enable(1) / disable(0) PIO mode&quot;</span><span class="p">);</span>
<span class="cp">#elif defined(CONFIG_B43LEGACY_DMA)</span>
<span class="cp"># define modparam_pio	0</span>
<span class="cp">#elif defined(CONFIG_B43LEGACY_PIO)</span>
<span class="cp"># define modparam_pio	1</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_bad_frames_preempt</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">bad_frames_preempt</span><span class="p">,</span> <span class="n">modparam_bad_frames_preempt</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">bad_frames_preempt</span><span class="p">,</span> <span class="s">&quot;enable(1) / disable(0) Bad Frames&quot;</span>
		 <span class="s">&quot; Preemption&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">modparam_fwpostfix</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">fwpostfix</span><span class="p">,</span> <span class="n">modparam_fwpostfix</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fwpostfix</span><span class="p">,</span> <span class="s">&quot;Postfix for the firmware files to load.&quot;</span><span class="p">);</span>

<span class="cm">/* The following table supports BCM4301, BCM4303 and BCM4306/2 devices. */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ssb_device_id</span> <span class="n">b43legacy_ssb_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SSB_DEVICE</span><span class="p">(</span><span class="n">SSB_VENDOR_BROADCOM</span><span class="p">,</span> <span class="n">SSB_DEV_80211</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
	<span class="n">SSB_DEVICE</span><span class="p">(</span><span class="n">SSB_VENDOR_BROADCOM</span><span class="p">,</span> <span class="n">SSB_DEV_80211</span><span class="p">,</span> <span class="mi">4</span><span class="p">),</span>
	<span class="n">SSB_DEVTABLE_END</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">ssb</span><span class="p">,</span> <span class="n">b43legacy_ssb_tbl</span><span class="p">);</span>


<span class="cm">/* Channel and ratetables are shared for all devices.</span>
<span class="cm"> * They can&#39;t be const, because ieee80211 puts some precalculated</span>
<span class="cm"> * data in there. This data is the same for all devices, so we don&#39;t</span>
<span class="cm"> * get concurrency issues */</span>
<span class="cp">#define RATETAB_ENT(_rateid, _flags) \</span>
<span class="cp">	{								\</span>
<span class="cp">		.bitrate	= B43legacy_RATE_TO_100KBPS(_rateid),	\</span>
<span class="cp">		.hw_value	= (_rateid),				\</span>
<span class="cp">		.flags		= (_flags),				\</span>
<span class="cp">	}</span>
<span class="cm">/*</span>
<span class="cm"> * NOTE: When changing this, sync with xmit.c&#39;s</span>
<span class="cm"> *	 b43legacy_plcp_get_bitrate_idx_* functions!</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">__b43legacy_ratetable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43legacy_CCK_RATE_1MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43legacy_CCK_RATE_2MB</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43legacy_CCK_RATE_5MB</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43legacy_CCK_RATE_11MB</span><span class="p">,</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43legacy_OFDM_RATE_6MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43legacy_OFDM_RATE_9MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43legacy_OFDM_RATE_12MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43legacy_OFDM_RATE_18MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43legacy_OFDM_RATE_24MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43legacy_OFDM_RATE_36MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43legacy_OFDM_RATE_48MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	<span class="n">RATETAB_ENT</span><span class="p">(</span><span class="n">B43legacy_OFDM_RATE_54MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
<span class="p">};</span>
<span class="cp">#define b43legacy_b_ratetable		(__b43legacy_ratetable + 0)</span>
<span class="cp">#define b43legacy_b_ratetable_size	4</span>
<span class="cp">#define b43legacy_g_ratetable		(__b43legacy_ratetable + 0)</span>
<span class="cp">#define b43legacy_g_ratetable_size	12</span>

<span class="cp">#define CHANTAB_ENT(_chanid, _freq) \</span>
<span class="cp">	{							\</span>
<span class="cp">		.center_freq	= (_freq),			\</span>
<span class="cp">		.hw_value	= (_chanid),			\</span>
<span class="cp">	}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">b43legacy_bg_chantable</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">CHANTAB_ENT</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2412</span><span class="p">),</span>
	<span class="n">CHANTAB_ENT</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2417</span><span class="p">),</span>
	<span class="n">CHANTAB_ENT</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2422</span><span class="p">),</span>
	<span class="n">CHANTAB_ENT</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2427</span><span class="p">),</span>
	<span class="n">CHANTAB_ENT</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">2432</span><span class="p">),</span>
	<span class="n">CHANTAB_ENT</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">2437</span><span class="p">),</span>
	<span class="n">CHANTAB_ENT</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">2442</span><span class="p">),</span>
	<span class="n">CHANTAB_ENT</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">2447</span><span class="p">),</span>
	<span class="n">CHANTAB_ENT</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">2452</span><span class="p">),</span>
	<span class="n">CHANTAB_ENT</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">2457</span><span class="p">),</span>
	<span class="n">CHANTAB_ENT</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="mi">2462</span><span class="p">),</span>
	<span class="n">CHANTAB_ENT</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">2467</span><span class="p">),</span>
	<span class="n">CHANTAB_ENT</span><span class="p">(</span><span class="mi">13</span><span class="p">,</span> <span class="mi">2472</span><span class="p">),</span>
	<span class="n">CHANTAB_ENT</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">2484</span><span class="p">),</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">b43legacy_band_2GHz_BPHY</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">b43legacy_bg_chantable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">b43legacy_bg_chantable</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">b43legacy_b_ratetable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">b43legacy_b_ratetable_size</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">b43legacy_band_2GHz_GPHY</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">b43legacy_bg_chantable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">b43legacy_bg_chantable</span><span class="p">),</span>
	<span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">b43legacy_g_ratetable</span><span class="p">,</span>
	<span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">b43legacy_g_ratetable_size</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">b43legacy_wireless_core_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">b43legacy_wireless_core_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">b43legacy_wireless_core_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">b43legacy_wireless_core_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_ratelimit</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span> <span class="o">||</span> <span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* We are up and running.</span>
<span class="cm">	 * Ratelimit the messages to avoid DoS over the net. */</span>
	<span class="k">return</span> <span class="n">net_ratelimit</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacyinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43legacy_ratelimit</span><span class="p">(</span><span class="n">wl</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;b43legacy-%s: %pV&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">wl</span> <span class="o">&amp;&amp;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">?</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;wlan&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacyerr</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43legacy_ratelimit</span><span class="p">(</span><span class="n">wl</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;b43legacy-%s ERROR: %pV&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">wl</span> <span class="o">&amp;&amp;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">?</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;wlan&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacywarn</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43legacy_ratelimit</span><span class="p">(</span><span class="n">wl</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;b43legacy-%s warning: %pV&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">wl</span> <span class="o">&amp;&amp;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">?</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;wlan&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#if B43legacy_DEBUG</span>
<span class="kt">void</span> <span class="nf">b43legacydbg</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">va_format</span> <span class="n">vaf</span><span class="p">;</span>
	<span class="kt">va_list</span> <span class="n">args</span><span class="p">;</span>

	<span class="n">va_start</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="n">fmt</span><span class="p">);</span>

	<span class="n">vaf</span><span class="p">.</span><span class="n">fmt</span> <span class="o">=</span> <span class="n">fmt</span><span class="p">;</span>
	<span class="n">vaf</span><span class="p">.</span><span class="n">va</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">args</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;b43legacy-%s debug: %pV&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">wl</span> <span class="o">&amp;&amp;</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">)</span> <span class="o">?</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">)</span> <span class="o">:</span> <span class="s">&quot;wlan&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vaf</span><span class="p">);</span>

	<span class="n">va_end</span><span class="p">(</span><span class="n">args</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_ram_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span>
				<span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">offset</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">B43legacy_MACCTL_BE</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">swab32</span><span class="p">(</span><span class="n">val</span><span class="p">);</span>

	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_RAM_CONTROL</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_RAM_DATA</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="kt">void</span> <span class="nf">b43legacy_shm_control_word</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">routing</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>

	<span class="cm">/* &quot;offset&quot; is the WORD offset. */</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">routing</span><span class="p">;</span>
	<span class="n">control</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">control</span> <span class="o">|=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_SHM_CONTROL</span><span class="p">,</span> <span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u32</span> <span class="nf">b43legacy_shm_read32</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		       <span class="n">u16</span> <span class="n">routing</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">routing</span> <span class="o">==</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">B43legacy_WARN_ON</span><span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Unaligned access */</span>
			<span class="n">b43legacy_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">B43legacy_MMIO_SHM_DATA_UNALIGNED</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">b43legacy_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span>
						     <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">|=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_SHM_DATA</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacy_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_SHM_DATA</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">b43legacy_shm_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">routing</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">routing</span> <span class="o">==</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">B43legacy_WARN_ON</span><span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Unaligned access */</span>
			<span class="n">b43legacy_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					     <span class="n">B43legacy_MMIO_SHM_DATA_UNALIGNED</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacy_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_SHM_DATA</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_shm_write32</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">routing</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span>
			   <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">routing</span> <span class="o">==</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">B43legacy_WARN_ON</span><span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Unaligned access */</span>
			<span class="n">b43legacy_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">mmiowb</span><span class="p">();</span>
			<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">B43legacy_MMIO_SHM_DATA_UNALIGNED</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">value</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
			<span class="n">mmiowb</span><span class="p">();</span>
			<span class="n">b43legacy_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span>
						   <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">mmiowb</span><span class="p">();</span>
			<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_SHM_DATA</span><span class="p">,</span>
					  <span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacy_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_SHM_DATA</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_shm_write16</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">routing</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span>
			   <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">routing</span> <span class="o">==</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">B43legacy_WARN_ON</span><span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Unaligned access */</span>
			<span class="n">b43legacy_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">mmiowb</span><span class="p">();</span>
			<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">B43legacy_MMIO_SHM_DATA_UNALIGNED</span><span class="p">,</span>
					  <span class="n">value</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">offset</span> <span class="o">&gt;&gt;=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacy_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">routing</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_SHM_DATA</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Read HostFlags */</span>
<span class="n">u32</span> <span class="nf">b43legacy_hf_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
				   <span class="n">B43legacy_SHM_SH_HOSTFHI</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
				    <span class="n">B43legacy_SHM_SH_HOSTFLO</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write HostFlags */</span>
<span class="kt">void</span> <span class="nf">b43legacy_hf_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
			      <span class="n">B43legacy_SHM_SH_HOSTFLO</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">));</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
			      <span class="n">B43legacy_SHM_SH_HOSTFHI</span><span class="p">,</span>
			      <span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_tsf_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">tsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We need to be careful. As we read the TSF from multiple</span>
<span class="cm">	 * registers, we should take care of register overflows.</span>
<span class="cm">	 * In theory, the whole tsf read process should be atomic.</span>
<span class="cm">	 * We try to be atomic here, by restaring the read process,</span>
<span class="cm">	 * if any of the high registers changed (overflew).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">low</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">high</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">high2</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">high</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">B43legacy_MMIO_REV3PLUS_TSF_HIGH</span><span class="p">);</span>
			<span class="n">low</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">B43legacy_MMIO_REV3PLUS_TSF_LOW</span><span class="p">);</span>
			<span class="n">high2</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">B43legacy_MMIO_REV3PLUS_TSF_HIGH</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">high</span> <span class="o">!=</span> <span class="n">high2</span><span class="p">));</span>

		<span class="o">*</span><span class="n">tsf</span> <span class="o">=</span> <span class="n">high</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tsf</span> <span class="o">&lt;&lt;=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tsf</span> <span class="o">|=</span> <span class="n">low</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u64</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">v0</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">v1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">v2</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">v3</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">test1</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">test2</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">test3</span><span class="p">;</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">v3</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_3</span><span class="p">);</span>
			<span class="n">v2</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_2</span><span class="p">);</span>
			<span class="n">v1</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_1</span><span class="p">);</span>
			<span class="n">v0</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_0</span><span class="p">);</span>

			<span class="n">test3</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_3</span><span class="p">);</span>
			<span class="n">test2</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_2</span><span class="p">);</span>
			<span class="n">test1</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">v3</span> <span class="o">!=</span> <span class="n">test3</span> <span class="o">||</span> <span class="n">v2</span> <span class="o">!=</span> <span class="n">test2</span> <span class="o">||</span> <span class="n">v1</span> <span class="o">!=</span> <span class="n">test1</span><span class="p">);</span>

		<span class="o">*</span><span class="n">tsf</span> <span class="o">=</span> <span class="n">v3</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tsf</span> <span class="o">&lt;&lt;=</span> <span class="mi">48</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">v2</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">&lt;&lt;=</span> <span class="mi">32</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tsf</span> <span class="o">|=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">v1</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tsf</span> <span class="o">|=</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="o">*</span><span class="n">tsf</span> <span class="o">|=</span> <span class="n">v0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_time_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_TBTTHOLD</span><span class="p">;</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_time_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_TBTTHOLD</span><span class="p">;</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_tsf_write_locked</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Be careful with the in-progress timer.</span>
<span class="cm">	 * First zero out the low register, so we have a full</span>
<span class="cm">	 * register-overflow duration to complete the operation.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">lo</span> <span class="o">=</span> <span class="p">(</span><span class="n">tsf</span> <span class="o">&amp;</span> <span class="mh">0x00000000FFFFFFFFULL</span><span class="p">);</span>
		<span class="n">u32</span> <span class="n">hi</span> <span class="o">=</span> <span class="p">(</span><span class="n">tsf</span> <span class="o">&amp;</span> <span class="mh">0xFFFFFFFF00000000ULL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>

		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_REV3PLUS_TSF_LOW</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mmiowb</span><span class="p">();</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_REV3PLUS_TSF_HIGH</span><span class="p">,</span>
				    <span class="n">hi</span><span class="p">);</span>
		<span class="n">mmiowb</span><span class="p">();</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_REV3PLUS_TSF_LOW</span><span class="p">,</span>
				    <span class="n">lo</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">v0</span> <span class="o">=</span> <span class="p">(</span><span class="n">tsf</span> <span class="o">&amp;</span> <span class="mh">0x000000000000FFFFULL</span><span class="p">);</span>
		<span class="n">u16</span> <span class="n">v1</span> <span class="o">=</span> <span class="p">(</span><span class="n">tsf</span> <span class="o">&amp;</span> <span class="mh">0x00000000FFFF0000ULL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">v2</span> <span class="o">=</span> <span class="p">(</span><span class="n">tsf</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF00000000ULL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
		<span class="n">u16</span> <span class="n">v3</span> <span class="o">=</span> <span class="p">(</span><span class="n">tsf</span> <span class="o">&amp;</span> <span class="mh">0xFFFF000000000000ULL</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">48</span><span class="p">;</span>

		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">mmiowb</span><span class="p">();</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_3</span><span class="p">,</span> <span class="n">v3</span><span class="p">);</span>
		<span class="n">mmiowb</span><span class="p">();</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_2</span><span class="p">,</span> <span class="n">v2</span><span class="p">);</span>
		<span class="n">mmiowb</span><span class="p">();</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_1</span><span class="p">,</span> <span class="n">v1</span><span class="p">);</span>
		<span class="n">mmiowb</span><span class="p">();</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_0</span><span class="p">,</span> <span class="n">v0</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_tsf_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">tsf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacy_time_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_tsf_write_locked</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tsf</span><span class="p">);</span>
	<span class="n">b43legacy_time_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span>
<span class="kt">void</span> <span class="nf">b43legacy_macfilter_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">zero_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac</span><span class="p">)</span>
		<span class="n">mac</span> <span class="o">=</span> <span class="n">zero_addr</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">|=</span> <span class="mh">0x0020</span><span class="p">;</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACFILTER_CONTROL</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACFILTER_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACFILTER_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
	<span class="n">data</span> <span class="o">=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">data</span> <span class="o">|=</span> <span class="n">mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACFILTER_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_write_mac_bssid_templates</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">zero_addr</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac_bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bssid</span><span class="p">)</span>
		<span class="n">bssid</span> <span class="o">=</span> <span class="n">zero_addr</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mac</span><span class="p">)</span>
		<span class="n">mac</span> <span class="o">=</span> <span class="n">zero_addr</span><span class="p">;</span>

	<span class="n">b43legacy_macfilter_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MACFILTER_BSSID</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_bssid</span><span class="p">,</span> <span class="n">mac</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac_bssid</span> <span class="o">+</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="cm">/* Write our MAC address and BSSID to template ram */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">mac_bssid</span><span class="p">);</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span>  <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">mac_bssid</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">mac_bssid</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">mac_bssid</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">mac_bssid</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">b43legacy_ram_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x20</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">b43legacy_ram_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x78</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">b43legacy_ram_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x478</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_upload_card_macaddress</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacy_write_mac_bssid_templates</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_macfilter_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MACFILTER_SELF</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_set_slot_time</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">u16</span> <span class="n">slot_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* slot_time is in usec. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">B43legacy_PHYTYPE_G</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x684</span><span class="p">,</span> <span class="mi">510</span> <span class="o">+</span> <span class="n">slot_time</span><span class="p">);</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0010</span><span class="p">,</span>
			      <span class="n">slot_time</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_short_slot_timing_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacy_set_slot_time</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_short_slot_timing_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacy_set_slot_time</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">20</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Synchronize IRQ top- and bottom-half.</span>
<span class="cm"> * IRQs must be masked before calling this.</span>
<span class="cm"> * This must not be called with the irq_lock held.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_synchronize_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">isr_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* DummyTransmission function, as documented on</span>
<span class="cm"> * http://bcm-specs.sipsolutions.net/DummyTransmission</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">b43legacy_dummy_transmission</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">max_loop</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0x00000000</span><span class="p">,</span>
		<span class="mh">0x00D40000</span><span class="p">,</span>
		<span class="mh">0x00000000</span><span class="p">,</span>
		<span class="mh">0x01000000</span><span class="p">,</span>
		<span class="mh">0x00000000</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_B</span>:
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_G</span>:
		<span class="n">max_loop</span> <span class="o">=</span> <span class="mh">0xFA</span><span class="p">;</span>
		<span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x000B846E</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43legacy_ram_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* dummy read follows */</span>
	<span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>

	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0568</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x07C0</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x050C</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0508</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x050A</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x054C</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x056A</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">);</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0568</span><span class="p">,</span> <span class="mh">0x0826</span><span class="p">);</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0500</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0502</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&lt;=</span> <span class="mh">0x5</span><span class="p">)</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">,</span> <span class="mh">0x0017</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max_loop</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x050E</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x0A</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x050E</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0400</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mh">0x0A</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0690</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0100</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&lt;=</span> <span class="mh">0x5</span><span class="p">)</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">,</span> <span class="mh">0x0037</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Turn the Analog ON/OFF */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_switch_analog</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_PHY0</span><span class="p">,</span> <span class="n">on</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mh">0xF4</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_wireless_core_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmslow</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macctl</span><span class="p">;</span>

	<span class="n">flags</span> <span class="o">|=</span> <span class="n">B43legacy_TMSLOW_PHYCLKEN</span><span class="p">;</span>
	<span class="n">flags</span> <span class="o">|=</span> <span class="n">B43legacy_TMSLOW_PHYRESET</span><span class="p">;</span>
	<span class="n">ssb_device_enable</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span> <span class="cm">/* Wait for the PLL to turn on. */</span>

	<span class="cm">/* Now take the PHY out of Reset again */</span>
	<span class="n">tmslow</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">);</span>
	<span class="n">tmslow</span> <span class="o">|=</span> <span class="n">SSB_TMSLOW_FGC</span><span class="p">;</span>
	<span class="n">tmslow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_TMSLOW_PHYRESET</span><span class="p">;</span>
	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span> <span class="n">tmslow</span><span class="p">);</span>
	<span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">tmslow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSB_TMSLOW_FGC</span><span class="p">;</span>
	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span> <span class="n">tmslow</span><span class="p">);</span>
	<span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Turn Analog ON */</span>
	<span class="n">b43legacy_switch_analog</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">macctl</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
	<span class="n">macctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_GMODE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">B43legacy_TMSLOW_GMODE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_GMODE</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_IHR_ENABLED</span><span class="p">;</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span> <span class="n">macctl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_irq_transmit_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">v0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">v1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43legacy_txstatus</span> <span class="n">stat</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v0</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_XMITSTAT_0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">v0</span> <span class="o">&amp;</span> <span class="mh">0x00000001</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">v1</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_XMITSTAT_1</span><span class="p">);</span>

		<span class="n">stat</span><span class="p">.</span><span class="n">cookie</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">seq</span> <span class="o">=</span> <span class="p">(</span><span class="n">v1</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">phy_stat</span> <span class="o">=</span> <span class="p">((</span><span class="n">v1</span> <span class="o">&amp;</span> <span class="mh">0x00FF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">v0</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">frame_count</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">rts_count</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0F00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">supp_reason</span> <span class="o">=</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x001C</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">pm_indicated</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0080</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">intermediate</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0040</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">for_ampdu</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0020</span><span class="p">);</span>
		<span class="n">stat</span><span class="p">.</span><span class="n">acked</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">);</span>

		<span class="n">b43legacy_handle_txstatus</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">stat</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">drain_txstatus_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="cm">/* Read all entries from the microcode TXstatus FIFO</span>
<span class="cm">	 * and throw them away.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dummy</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_XMITSTAT_0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dummy</span> <span class="o">&amp;</span> <span class="mh">0x00000001</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dummy</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_XMITSTAT_1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">b43legacy_jssi_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x40A</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">|=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x408</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_jssi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">jssi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x408</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">jssi</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">));</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x40A</span><span class="p">,</span>
			      <span class="p">(</span><span class="n">jssi</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_generate_noise_sample</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacy_jssi_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x7F7F7F7F</span><span class="p">);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCMD</span><span class="p">,</span>
			  <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCMD</span><span class="p">)</span>
			  <span class="o">|</span> <span class="n">B43legacy_MACCMD_BGNOISE</span><span class="p">);</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">channel_at_start</span> <span class="o">!=</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_calculate_link_quality</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Top half of Link Quality calculation. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">calculation_running</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">channel_at_start</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">calculation_running</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">nr_samples</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">b43legacy_generate_noise_sample</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_irq_noise</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">noise</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">average</span><span class="p">;</span>

	<span class="cm">/* Bottom half of Link Quality calculation. */</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">calculation_running</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">channel_at_start</span> <span class="o">!=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">drop_calculation</span><span class="p">;</span>
	<span class="o">*</span><span class="p">((</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span><span class="n">noise</span><span class="p">)</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">b43legacy_jssi_read</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7F</span> <span class="o">||</span> <span class="n">noise</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7F</span> <span class="o">||</span>
	    <span class="n">noise</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7F</span> <span class="o">||</span> <span class="n">noise</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7F</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">generate_new</span><span class="p">;</span>

	<span class="cm">/* Get the noise samples. */</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">nr_samples</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">nr_samples</span><span class="p">;</span>
	<span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">noise</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">noise</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">noise</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">noise</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">[</span><span class="n">noise</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">[</span><span class="n">noise</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">[</span><span class="n">noise</span><span class="p">[</span><span class="mi">2</span><span class="p">]];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">[</span><span class="n">noise</span><span class="p">[</span><span class="mi">3</span><span class="p">]];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">nr_samples</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">nr_samples</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Calculate the Link Quality by the noise samples. */</span>
		<span class="n">average</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
				<span class="n">average</span> <span class="o">+=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">];</span>
		<span class="p">}</span>
		<span class="n">average</span> <span class="o">/=</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
		<span class="n">average</span> <span class="o">*=</span> <span class="mi">125</span><span class="p">;</span>
		<span class="n">average</span> <span class="o">+=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="n">average</span> <span class="o">/=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
					     <span class="mh">0x40C</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">/</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">average</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">average</span> <span class="o">-=</span> <span class="mi">25</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">average</span> <span class="o">-=</span> <span class="mi">72</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">average</span> <span class="o">-=</span> <span class="mi">48</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">link_noise</span> <span class="o">=</span> <span class="n">average</span><span class="p">;</span>
<span class="nl">drop_calculation:</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">.</span><span class="n">calculation_running</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">generate_new:</span>
	<span class="n">b43legacy_generate_noise_sample</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_irq_tbtt_indication</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_is_mode</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* TODO: PS TBTT */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="cm">/*FIXME: the last PSpoll frame was sent successfully */</span><span class="p">)</span>
			<span class="n">b43legacy_power_saving_ctl_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_is_mode</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dfq_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_irq_atim_end</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dfq_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCMD</span><span class="p">,</span>
				  <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCMD</span><span class="p">)</span>
				  <span class="o">|</span> <span class="n">B43legacy_MACCMD_DFQ_VALID</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dfq_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_irq_pmq</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* TODO: AP mode. */</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_PS_STATUS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x00000008</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* 16bit write is odd, but correct. */</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_PS_STATUS</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_write_template_common</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">,</span>
					    <span class="n">u16</span> <span class="n">ram_offset</span><span class="p">,</span>
					    <span class="n">u16</span> <span class="n">shm_size_offset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43legacy_plcp_hdr4</span> <span class="n">plcp</span><span class="p">;</span>

	<span class="n">plcp</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">b43legacy_generate_plcp_hdr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plcp</span><span class="p">,</span> <span class="n">size</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="n">b43legacy_ram_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ram_offset</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">plcp</span><span class="p">.</span><span class="n">data</span><span class="p">));</span>
	<span class="n">ram_offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="cm">/* The PLCP is 6 bytes long, but we only wrote 4 bytes, yet.</span>
<span class="cm">	 * So leave the first two bytes of the next write blank.</span>
<span class="cm">	 */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
	<span class="n">b43legacy_ram_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ram_offset</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="n">ram_offset</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">0</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">b43legacy_ram_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ram_offset</span> <span class="o">+</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">2</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="n">shm_size_offset</span><span class="p">,</span>
			      <span class="n">size</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_plcp_hdr6</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Convert a b43legacy antenna number value to the PHY TX control value. */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43legacy_antenna_to_phyctl</span><span class="p">(</span><span class="kt">int</span> <span class="n">antenna</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">antenna</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_ANTENNA0</span>:
		<span class="k">return</span> <span class="n">B43legacy_TX4_PHY_ANT0</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43legacy_ANTENNA1</span>:
		<span class="k">return</span> <span class="n">B43legacy_TX4_PHY_ANT1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">B43legacy_TX4_PHY_ANTLAST</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_write_beacon_template</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">u16</span> <span class="n">ram_offset</span><span class="p">,</span>
					    <span class="n">u16</span> <span class="n">shm_size_offset</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">variable_len</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">bcn</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tim_found</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">antenna</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="p">);</span>

	<span class="n">bcn</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
		  <span class="mh">0x200</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_plcp_hdr6</span><span class="p">));</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">ieee80211_get_tx_rate</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>

	<span class="n">b43legacy_write_template_common</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">bcn</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ram_offset</span><span class="p">,</span>
					<span class="n">shm_size_offset</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="cm">/* Write the PHY TX control parameters. */</span>
	<span class="n">antenna</span> <span class="o">=</span> <span class="n">B43legacy_ANTENNA_DEFAULT</span><span class="p">;</span>
	<span class="n">antenna</span> <span class="o">=</span> <span class="n">b43legacy_antenna_to_phyctl</span><span class="p">(</span><span class="n">antenna</span><span class="p">);</span>
	<span class="n">ctl</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
				   <span class="n">B43legacy_SHM_SH_BEACPHYCTL</span><span class="p">);</span>
	<span class="cm">/* We can&#39;t send beacons with short preamble. Would get PHY errors. */</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_TX4_PHY_SHORTPRMBL</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_TX4_PHY_ANT</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_TX4_PHY_ENC</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">|=</span> <span class="n">antenna</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43legacy_TX4_PHY_ENC_CCK</span><span class="p">;</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
			      <span class="n">B43legacy_SHM_SH_BEACPHYCTL</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>

	<span class="cm">/* Find the position of the TIM and the DTIM_period value</span>
<span class="cm">	 * and write them to SHM. */</span>
	<span class="n">ie</span> <span class="o">=</span> <span class="n">bcn</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">;</span>
	<span class="n">variable_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">variable_len</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kt">uint8_t</span> <span class="n">ie_id</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">;</span>

		<span class="n">ie_id</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">ie_len</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ie_id</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">tim_position</span><span class="p">;</span>
			<span class="n">u16</span> <span class="n">dtim_period</span><span class="p">;</span>
			<span class="cm">/* This is the TIM Information Element */</span>

			<span class="cm">/* Check whether the ie_len is in the beacon data range. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">variable_len</span> <span class="o">&lt;</span> <span class="n">ie_len</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="cm">/* A valid TIM is at least 4 bytes long. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ie_len</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">tim_found</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

			<span class="n">tim_position</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_plcp_hdr6</span><span class="p">);</span>
			<span class="n">tim_position</span> <span class="o">+=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span><span class="p">,</span>
						 <span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">);</span>
			<span class="n">tim_position</span> <span class="o">+=</span> <span class="n">i</span><span class="p">;</span>

			<span class="n">dtim_period</span> <span class="o">=</span> <span class="n">ie</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">3</span><span class="p">];</span>

			<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
					<span class="n">B43legacy_SHM_SH_TIMPOS</span><span class="p">,</span> <span class="n">tim_position</span><span class="p">);</span>
			<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
					<span class="n">B43legacy_SHM_SH_DTIMP</span><span class="p">,</span> <span class="n">dtim_period</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">i</span> <span class="o">+=</span> <span class="n">ie_len</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tim_found</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacywarn</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Did not find a valid TIM IE in the &quot;</span>
			      <span class="s">&quot;beacon template packet. AP or IBSS operation &quot;</span>
			      <span class="s">&quot;may be broken.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Updated beacon template</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_write_probe_resp_plcp</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">u16</span> <span class="n">shm_offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">size</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_plcp_hdr4</span> <span class="n">plcp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">dur</span><span class="p">;</span>

	<span class="n">plcp</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">b43legacy_generate_plcp_hdr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">plcp</span><span class="p">,</span> <span class="n">size</span> <span class="o">+</span> <span class="n">FCS_LEN</span><span class="p">,</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
	<span class="n">dur</span> <span class="o">=</span> <span class="n">ieee80211_generic_frame_duration</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span>
					       <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">,</span>
					       <span class="n">size</span><span class="p">,</span>
					       <span class="n">rate</span><span class="p">);</span>
	<span class="cm">/* Write PLCP in two parts and timing for packet transfer */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">plcp</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="n">shm_offset</span><span class="p">,</span>
			      <span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xFFFF</span><span class="p">);</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="n">shm_offset</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
			      <span class="n">tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="n">shm_offset</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span>
			      <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">dur</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Instead of using custom probe response template, this function</span>
<span class="cm"> * just patches custom beacon template by:</span>
<span class="cm"> * 1) Changing packet type</span>
<span class="cm"> * 2) Patching duration field</span>
<span class="cm"> * 3) Stripping TIM</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="nf">b43legacy_generate_probe_resp</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">u16</span> <span class="o">*</span><span class="n">dest_size</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">src_data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">dest_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">src_size</span><span class="p">,</span> <span class="n">elem_size</span><span class="p">,</span> <span class="n">src_pos</span><span class="p">,</span> <span class="n">dest_pos</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">dur</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ie_start</span><span class="p">;</span>

	<span class="n">src_size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">src_data</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Get the start offset of the variable IEs in the packet. */</span>
	<span class="n">ie_start</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">probe_resp</span><span class="p">.</span><span class="n">variable</span><span class="p">);</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">ie_start</span> <span class="o">!=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span><span class="p">,</span>
					       <span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">src_size</span> <span class="o">&lt;</span> <span class="n">ie_start</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">dest_data</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">src_size</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">dest_data</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Copy the static data and all Information Elements, except the TIM. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dest_data</span><span class="p">,</span> <span class="n">src_data</span><span class="p">,</span> <span class="n">ie_start</span><span class="p">);</span>
	<span class="n">src_pos</span> <span class="o">=</span> <span class="n">ie_start</span><span class="p">;</span>
	<span class="n">dest_pos</span> <span class="o">=</span> <span class="n">ie_start</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span> <span class="p">;</span> <span class="n">src_pos</span> <span class="o">&lt;</span> <span class="n">src_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span> <span class="n">src_pos</span> <span class="o">+=</span> <span class="n">elem_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">elem_size</span> <span class="o">=</span> <span class="n">src_data</span><span class="p">[</span><span class="n">src_pos</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">src_data</span><span class="p">[</span><span class="n">src_pos</span><span class="p">]</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* This is the TIM. */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">dest_data</span> <span class="o">+</span> <span class="n">dest_pos</span><span class="p">,</span> <span class="n">src_data</span> <span class="o">+</span> <span class="n">src_pos</span><span class="p">,</span> <span class="n">elem_size</span><span class="p">);</span>
		<span class="n">dest_pos</span> <span class="o">+=</span> <span class="n">elem_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">dest_size</span> <span class="o">=</span> <span class="n">dest_pos</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">dest_data</span><span class="p">;</span>

	<span class="cm">/* Set the frame control. */</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_FTYPE_MGMT</span> <span class="o">|</span>
					 <span class="n">IEEE80211_STYPE_PROBE_RESP</span><span class="p">);</span>
	<span class="n">dur</span> <span class="o">=</span> <span class="n">ieee80211_generic_frame_duration</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span>
					       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span>
					       <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">,</span>
					       <span class="o">*</span><span class="n">dest_size</span><span class="p">,</span>
					       <span class="n">rate</span><span class="p">);</span>
	<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">duration_id</span> <span class="o">=</span> <span class="n">dur</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dest_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_write_probe_resp_template</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">u16</span> <span class="n">ram_offset</span><span class="p">,</span>
						<span class="n">u16</span> <span class="n">shm_size_offset</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">probe_resp_data</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">;</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">probe_resp_data</span> <span class="o">=</span> <span class="n">b43legacy_generate_probe_resp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">probe_resp_data</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Looks like PLCP headers plus packet timings are stored for</span>
<span class="cm">	 * all possible basic rates</span>
<span class="cm">	 */</span>
	<span class="n">b43legacy_write_probe_resp_plcp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x31A</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">b43legacy_b_ratetable</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43legacy_write_probe_resp_plcp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x32C</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">b43legacy_b_ratetable</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">b43legacy_write_probe_resp_plcp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x33E</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">b43legacy_b_ratetable</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">b43legacy_write_probe_resp_plcp</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x350</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">b43legacy_b_ratetable</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">((</span><span class="kt">size_t</span><span class="p">)</span><span class="n">size</span><span class="p">,</span>
		   <span class="mh">0x200</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_plcp_hdr6</span><span class="p">));</span>
	<span class="n">b43legacy_write_template_common</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">probe_resp_data</span><span class="p">,</span>
					<span class="n">size</span><span class="p">,</span> <span class="n">ram_offset</span><span class="p">,</span>
					<span class="n">shm_size_offset</span><span class="p">,</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">probe_resp_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_upload_beacon0</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon0_uploaded</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">b43legacy_write_beacon_template</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x68</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>
	<span class="cm">/* FIXME: Probe resp upload doesn&#39;t really belong here,</span>
<span class="cm">	 *        but we don&#39;t use that feature anyway. */</span>
	<span class="n">b43legacy_write_probe_resp_template</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x268</span><span class="p">,</span> <span class="mh">0x4A</span><span class="p">,</span>
				      <span class="o">&amp;</span><span class="n">__b43legacy_ratetable</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon0_uploaded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_upload_beacon1</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon1_uploaded</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">b43legacy_write_beacon_template</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x468</span><span class="p">,</span> <span class="mh">0x1A</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon1_uploaded</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_irq_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">beacon0_valid</span><span class="p">,</span> <span class="n">beacon1_valid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">b43legacy_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* This is the bottom half of the asynchronous beacon update. */</span>

	<span class="cm">/* Ignore interrupt in the future. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_IRQ_BEACON</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCMD</span><span class="p">);</span>
	<span class="n">beacon0_valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">B43legacy_MACCMD_BEACON0_VALID</span><span class="p">);</span>
	<span class="n">beacon1_valid</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">&amp;</span> <span class="n">B43legacy_MACCMD_BEACON1_VALID</span><span class="p">);</span>

	<span class="cm">/* Schedule interrupt manually, if busy. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">beacon0_valid</span> <span class="o">&amp;&amp;</span> <span class="n">beacon1_valid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_REASON</span><span class="p">,</span> <span class="n">B43legacy_IRQ_BEACON</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">|=</span> <span class="n">B43legacy_IRQ_BEACON</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_templates_virgin</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* We never uploaded a beacon before.</span>
<span class="cm">		 * Upload both templates now, but only mark one valid. */</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_templates_virgin</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">b43legacy_upload_beacon0</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">b43legacy_upload_beacon1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCMD</span><span class="p">);</span>
		<span class="n">cmd</span> <span class="o">|=</span> <span class="n">B43legacy_MACCMD_BEACON0_VALID</span><span class="p">;</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beacon0_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_upload_beacon0</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCMD</span><span class="p">);</span>
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">B43legacy_MACCMD_BEACON0_VALID</span><span class="p">;</span>
			<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">beacon1_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_upload_beacon1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">cmd</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCMD</span><span class="p">);</span>
			<span class="n">cmd</span> <span class="o">|=</span> <span class="n">B43legacy_MACCMD_BEACON1_VALID</span><span class="p">;</span>
			<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_beacon_update_trigger_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">b43legacy_wl</span><span class="p">,</span>
					 <span class="n">beacon_update_trigger</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
		<span class="cm">/* Update beacon right away or defer to IRQ. */</span>
		<span class="n">handle_irq_beacon</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="cm">/* The handler might have updated the IRQ mask. */</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_MASK</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
		<span class="n">mmiowb</span><span class="p">();</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Asynchronously update the packet templates in template RAM.</span>
<span class="cm"> * Locking: Requires wl-&gt;irq_lock to be locked. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_update_templates</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">beacon</span><span class="p">;</span>
	<span class="cm">/* This is the top half of the ansynchronous beacon update. The bottom</span>
<span class="cm">	 * half is the beacon IRQ. Beacon update must be asynchronous to avoid</span>
<span class="cm">	 * sending an invalid beacon. This can happen for example, if the</span>
<span class="cm">	 * firmware transmits a beacon while we are updating it. */</span>

	<span class="cm">/* We could modify the existing beacon and set the aid bit in the TIM</span>
<span class="cm">	 * field, but that would probably require resizing and moving of data</span>
<span class="cm">	 * within the beacon template. Simply request a new beacon and let</span>
<span class="cm">	 * mac80211 do the hard work. */</span>
	<span class="n">beacon</span> <span class="o">=</span> <span class="n">ieee80211_beacon_get</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">beacon</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="p">)</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span> <span class="o">=</span> <span class="n">beacon</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon0_uploaded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon1_uploaded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_update_trigger</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_set_beacon_int</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="n">u16</span> <span class="n">beacon_int</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacy_time_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_CFP_REP</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">beacon_int</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_CFP_START</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">beacon_int</span> <span class="o">&lt;&lt;</span> <span class="mi">10</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x606</span><span class="p">,</span> <span class="p">(</span><span class="n">beacon_int</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x610</span><span class="p">,</span> <span class="n">beacon_int</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43legacy_time_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Set beacon interval to %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">beacon_int</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_irq_ucode_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="cm">/* Interrupt handler bottom-half */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_interrupt_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reason</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">dma_reason</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">)];</span>
	<span class="n">u32</span> <span class="n">merged_dma_reason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span>
			  <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">);</span>

	<span class="n">reason</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_reason</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dma_reason</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dma_reason</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">merged_dma_reason</span> <span class="o">|=</span> <span class="n">dma_reason</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43legacy_IRQ_MAC_TXERR</span><span class="p">))</span>
		<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;MAC transmission error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43legacy_IRQ_PHY_TXERR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;PHY transmission error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rmb</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">txerr_cnt</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Too many PHY TX errors, &quot;</span>
					      <span class="s">&quot;restarting the controller</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">b43legacy_controller_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PHY TX errors&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">merged_dma_reason</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">B43legacy_DMAIRQ_FATALMASK</span> <span class="o">|</span>
					  <span class="n">B43legacy_DMAIRQ_NONFATALMASK</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">merged_dma_reason</span> <span class="o">&amp;</span> <span class="n">B43legacy_DMAIRQ_FATALMASK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Fatal DMA error: &quot;</span>
			       <span class="s">&quot;0x%08X, 0x%08X, 0x%08X, &quot;</span>
			       <span class="s">&quot;0x%08X, 0x%08X, 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dma_reason</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dma_reason</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			       <span class="n">dma_reason</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dma_reason</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			       <span class="n">dma_reason</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">dma_reason</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">b43legacy_controller_restart</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DMA error&quot;</span><span class="p">);</span>
			<span class="n">mmiowb</span><span class="p">();</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">merged_dma_reason</span> <span class="o">&amp;</span> <span class="n">B43legacy_DMAIRQ_NONFATALMASK</span><span class="p">)</span>
			<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;DMA error: &quot;</span>
			       <span class="s">&quot;0x%08X, 0x%08X, 0x%08X, &quot;</span>
			       <span class="s">&quot;0x%08X, 0x%08X, 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">dma_reason</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dma_reason</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			       <span class="n">dma_reason</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dma_reason</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
			       <span class="n">dma_reason</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">dma_reason</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43legacy_IRQ_UCODE_DEBUG</span><span class="p">))</span>
		<span class="n">handle_irq_ucode_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43legacy_IRQ_TBTT_INDI</span><span class="p">)</span>
		<span class="n">handle_irq_tbtt_indication</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43legacy_IRQ_ATIM_END</span><span class="p">)</span>
		<span class="n">handle_irq_atim_end</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43legacy_IRQ_BEACON</span><span class="p">)</span>
		<span class="n">handle_irq_beacon</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43legacy_IRQ_PMQ</span><span class="p">)</span>
		<span class="n">handle_irq_pmq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43legacy_IRQ_TXFIFO_FLUSH_OK</span><span class="p">)</span>
		<span class="p">;</span><span class="cm">/*TODO*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43legacy_IRQ_NOISESAMPLE_OK</span><span class="p">)</span>
		<span class="n">handle_irq_noise</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Check the DMA reason registers for received data. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">B43legacy_DMAIRQ_RX_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_using_pio</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">b43legacy_pio_rx</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pio</span><span class="p">.</span><span class="n">queue0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43legacy_dma_rx</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">rx_ring0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">B43legacy_DMAIRQ_RX_DONE</span><span class="p">);</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">B43legacy_DMAIRQ_RX_DONE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">B43legacy_DMAIRQ_RX_DONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_using_pio</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">b43legacy_pio_rx</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pio</span><span class="p">.</span><span class="n">queue3</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43legacy_dma_rx</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">.</span><span class="n">rx_ring3</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">B43legacy_DMAIRQ_RX_DONE</span><span class="p">);</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">B43legacy_DMAIRQ_RX_DONE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43legacy_IRQ_TX_OK</span><span class="p">)</span>
		<span class="n">handle_irq_transmit_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pio_irq_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">base</span><span class="p">,</span> <span class="kt">int</span> <span class="n">queueidx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">rxctl</span><span class="p">;</span>

	<span class="n">rxctl</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">B43legacy_PIO_RXCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxctl</span> <span class="o">&amp;</span> <span class="n">B43legacy_PIO_RXCTL_DATAAVAILABLE</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="n">queueidx</span><span class="p">]</span> <span class="o">|=</span> <span class="n">B43legacy_DMAIRQ_RX_DONE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="n">queueidx</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_DMAIRQ_RX_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_interrupt_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_using_pio</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">reason</span> <span class="o">&amp;</span> <span class="n">B43legacy_IRQ_PIO_WORKAROUND</span><span class="p">)))</span> <span class="p">{</span>
		<span class="cm">/* Apply a PIO specific workaround to the dma_reasons */</span>
		<span class="n">pio_irq_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_PIO1_BASE</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">pio_irq_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_PIO2_BASE</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">pio_irq_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_PIO3_BASE</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">pio_irq_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_PIO4_BASE</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_REASON</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>

	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_DMA0_REASON</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_DMA1_REASON</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_DMA2_REASON</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_DMA3_REASON</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_DMA4_REASON</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_DMA5_REASON</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* Interrupt handler top-half */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">b43legacy_interrupt_handler</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">irqreturn_t</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reason</span><span class="p">;</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">))</span>
		<span class="cm">/* This can only happen on shared IRQ lines. */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">reason</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_REASON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="mh">0xffffffff</span><span class="p">)</span> <span class="cm">/* shared IRQ */</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="n">reason</span> <span class="o">&amp;=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">reason</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					      <span class="n">B43legacy_MMIO_DMA0_REASON</span><span class="p">)</span>
					      <span class="o">&amp;</span> <span class="mh">0x0001DC00</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					      <span class="n">B43legacy_MMIO_DMA1_REASON</span><span class="p">)</span>
					      <span class="o">&amp;</span> <span class="mh">0x0000DC00</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					      <span class="n">B43legacy_MMIO_DMA2_REASON</span><span class="p">)</span>
					      <span class="o">&amp;</span> <span class="mh">0x0000DC00</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					      <span class="n">B43legacy_MMIO_DMA3_REASON</span><span class="p">)</span>
					      <span class="o">&amp;</span> <span class="mh">0x0001DC00</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					      <span class="n">B43legacy_MMIO_DMA4_REASON</span><span class="p">)</span>
					      <span class="o">&amp;</span> <span class="mh">0x0000DC00</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					      <span class="n">B43legacy_MMIO_DMA5_REASON</span><span class="p">)</span>
					      <span class="o">&amp;</span> <span class="mh">0x0000DC00</span><span class="p">;</span>

	<span class="n">b43legacy_interrupt_ack</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
	<span class="cm">/* Disable all IRQs. They are enabled again in the bottom half. */</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Save the reason code and call our bottom half. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_reason</span> <span class="o">=</span> <span class="n">reason</span><span class="p">;</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">isr_tasklet</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_release_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">ucode</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">ucode</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">pcm</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">pcm</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">initvals</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">initvals</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">initvals_band</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">initvals_band</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_print_fw_helptext</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;You must go to http://linuxwireless.org/en/users/&quot;</span>
		     <span class="s">&quot;Drivers/b43#devicefirmware &quot;</span>
		     <span class="s">&quot;and download the correct firmware (version 3).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">do_request_fw</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">**</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">path</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">modparam_fwpostfix</span><span class="p">)</span> <span class="o">+</span> <span class="mi">32</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">b43legacy_fw_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">name</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">path</span><span class="p">),</span>
		 <span class="s">&quot;b43legacy%s/%s.fw&quot;</span><span class="p">,</span>
		 <span class="n">modparam_fwpostfix</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Firmware file </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> not found &quot;</span>
		       <span class="s">&quot;or load failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">fw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_fw_header</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_fw_header</span> <span class="o">*</span><span class="p">)((</span><span class="o">*</span><span class="n">fw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_FW_TYPE_UCODE</span>:
	<span class="k">case</span> <span class="n">B43legacy_FW_TYPE_PCM</span>:
		<span class="n">size</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">!=</span> <span class="p">(</span><span class="o">*</span><span class="n">fw</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_fw_header</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
		<span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">B43legacy_FW_TYPE_IV</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">ver</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_format:</span>
	<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Firmware file </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> format error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">b43legacy_one_core_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">b43legacy_one_core_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">b43legacy_wl</span><span class="p">,</span> <span class="n">firmware_load</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43legacy_firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">rev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">filename</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">ucode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;ucode2&quot;</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;ucode4&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;ucode5&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">do_request_fw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">ucode</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_load</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;pcm4&quot;</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;pcm5&quot;</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">do_request_fw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">pcm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_load</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_B</span>:
		<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_G</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">))</span>
				<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;b0g0initvals5&quot;</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">rev</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;b0g0initvals2&quot;</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">do_request_fw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_load</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals_band</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_B</span>:
		<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_G</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">))</span>
				<span class="n">filename</span> <span class="o">=</span> <span class="s">&quot;b0g0bsinitvals5&quot;</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">11</span><span class="p">)</span>
				<span class="n">filename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">rev</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
				<span class="n">filename</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">err_no_initvals</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">do_request_fw</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals_band</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_load</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_one_core_detach</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_one_core_detach:</span>
	<span class="n">b43legacy_one_core_detach</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">err_load:</span>
	<span class="n">b43legacy_print_fw_helptext</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">err_no_initvals:</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;No Initial Values firmware file for PHY %u, &quot;</span>
	       <span class="s">&quot;core rev %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">,</span> <span class="n">rev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">b43legacy_release_firmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_upload_microcode</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">size_t</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_fw_header</span><span class="p">);</span>
	<span class="k">const</span> <span class="n">__be32</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fwrev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fwpatch</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fwdate</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">fwtime</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">macctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Jump the microcode PSM to offset 0 */</span>
	<span class="n">macctl</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">macctl</span> <span class="o">&amp;</span> <span class="n">B43legacy_MACCTL_PSM_RUN</span><span class="p">);</span>
	<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_PSM_JMP0</span><span class="p">;</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span> <span class="n">macctl</span><span class="p">);</span>
	<span class="cm">/* Zero out all microcode PSM registers and shared memory. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_WIRELESS</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4096</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Upload Microcode. */</span>
	<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">ucode</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">ucode</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
	<span class="n">b43legacy_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">B43legacy_SHM_UCODE</span> <span class="o">|</span>
				   <span class="n">B43legacy_SHM_AUTOINC_W</span><span class="p">,</span>
				   <span class="mh">0x0000</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_SHM_DATA</span><span class="p">,</span>
				    <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">pcm</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Upload PCM data. */</span>
		<span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">pcm</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">);</span>
		<span class="n">b43legacy_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_HW</span><span class="p">,</span> <span class="mh">0x01EA</span><span class="p">);</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_SHM_DATA</span><span class="p">,</span> <span class="mh">0x00004000</span><span class="p">);</span>
		<span class="cm">/* No need for autoinc bit in SHM_HW */</span>
		<span class="n">b43legacy_shm_control_word</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_HW</span><span class="p">,</span> <span class="mh">0x01EB</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_SHM_DATA</span><span class="p">,</span>
					  <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_REASON</span><span class="p">,</span>
			  <span class="n">B43legacy_IRQ_ALL</span><span class="p">);</span>

	<span class="cm">/* Start the microcode PSM */</span>
	<span class="n">macctl</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
	<span class="n">macctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_PSM_JMP0</span><span class="p">;</span>
	<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_PSM_RUN</span><span class="p">;</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span> <span class="n">macctl</span><span class="p">);</span>

	<span class="cm">/* Wait for the microcode to load and respond */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_REASON</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="n">B43legacy_IRQ_MAC_SUSPENDED</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">B43legacy_IRQWAIT_MAX_RETRIES</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Microcode not responding</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">b43legacy_print_fw_helptext</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* dummy read follows */</span>
	<span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_REASON</span><span class="p">);</span>

	<span class="cm">/* Get and check the revisions. */</span>
	<span class="n">fwrev</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
				     <span class="n">B43legacy_SHM_SH_UCODEREV</span><span class="p">);</span>
	<span class="n">fwpatch</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
				       <span class="n">B43legacy_SHM_SH_UCODEPATCH</span><span class="p">);</span>
	<span class="n">fwdate</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
				      <span class="n">B43legacy_SHM_SH_UCODEDATE</span><span class="p">);</span>
	<span class="n">fwtime</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
				      <span class="n">B43legacy_SHM_SH_UCODETIME</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fwrev</span> <span class="o">&gt;</span> <span class="mh">0x128</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;YOU ARE TRYING TO LOAD V4 FIRMWARE.&quot;</span>
			     <span class="s">&quot; Only firmware from binary drivers version 3.x&quot;</span>
			     <span class="s">&quot; is supported. You must change your firmware&quot;</span>
			     <span class="s">&quot; files.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">b43legacy_print_fw_helptext</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacyinfo</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Loading firmware version 0x%X, patch level %u &quot;</span>
		      <span class="s">&quot;(20%.2i-%.2i-%.2i %.2i:%.2i:%.2i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fwrev</span><span class="p">,</span> <span class="n">fwpatch</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">fwdate</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="p">(</span><span class="n">fwdate</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">,</span> <span class="n">fwdate</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
		      <span class="p">(</span><span class="n">fwtime</span> <span class="o">&gt;&gt;</span> <span class="mi">11</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">,</span> <span class="p">(</span><span class="n">fwtime</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">,</span>
		      <span class="n">fwtime</span> <span class="o">&amp;</span> <span class="mh">0x1F</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">rev</span> <span class="o">=</span> <span class="n">fwrev</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">patch</span> <span class="o">=</span> <span class="n">fwpatch</span><span class="p">;</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span> <span class="s">&quot;%u.%u&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">rev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">.</span><span class="n">patch</span><span class="p">);</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">hw_version</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">coreid</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">macctl</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
	<span class="n">macctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_PSM_RUN</span><span class="p">;</span>
	<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_PSM_JMP0</span><span class="p">;</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span> <span class="n">macctl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_write_initvals</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">b43legacy_iv</span> <span class="o">*</span><span class="n">ivals</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
				    <span class="kt">size_t</span> <span class="n">array_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">b43legacy_iv</span> <span class="o">*</span><span class="n">iv</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">bit32</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_iv</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">iv</span> <span class="o">=</span> <span class="n">ivals</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">array_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">offset_size</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
		<span class="n">array_size</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">offset_size</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">offset_size</span><span class="p">);</span>
		<span class="n">bit32</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="n">B43legacy_IV_32BIT</span><span class="p">);</span>
		<span class="n">offset</span> <span class="o">&amp;=</span> <span class="n">B43legacy_IV_OFFSET_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="mh">0x1000</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bit32</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">array_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">d32</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
			<span class="n">array_size</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">d32</span><span class="p">);</span>

			<span class="n">value</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">d32</span><span class="p">);</span>
			<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="n">iv</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">b43legacy_iv</span> <span class="o">*</span><span class="p">)((</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">iv</span> <span class="o">+</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">)</span> <span class="o">+</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">__be32</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">array_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">d16</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>
			<span class="n">array_size</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">d16</span><span class="p">);</span>

			<span class="n">value</span> <span class="o">=</span> <span class="n">be16_to_cpu</span><span class="p">(</span><span class="n">iv</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">.</span><span class="n">d16</span><span class="p">);</span>
			<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="n">iv</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">b43legacy_iv</span> <span class="o">*</span><span class="p">)((</span><span class="k">const</span> <span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span><span class="n">iv</span> <span class="o">+</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">)</span> <span class="o">+</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">__be16</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">array_size</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_format</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_format:</span>
	<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Initial Values Firmware file-format error.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">b43legacy_print_fw_helptext</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EPROTO</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_upload_initvals</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">size_t</span> <span class="n">hdr_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_fw_header</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">b43legacy_fw_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43legacy_firmware</span> <span class="o">*</span><span class="n">fw</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">fw</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">b43legacy_iv</span> <span class="o">*</span><span class="n">ivals</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">b43legacy_fw_header</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">ivals</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">b43legacy_iv</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_write_initvals</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ivals</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
				 <span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals_band</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">b43legacy_fw_header</span> <span class="o">*</span><span class="p">)</span>
		      <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals_band</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
		<span class="n">ivals</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">b43legacy_iv</span> <span class="o">*</span><span class="p">)(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals_band</span><span class="o">-&gt;</span><span class="n">data</span>
			<span class="o">+</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">be32_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_write_initvals</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ivals</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
					 <span class="n">fw</span><span class="o">-&gt;</span><span class="n">initvals_band</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initialize the GPIOs</span>
<span class="cm"> * http://bcm-specs.sipsolutions.net/GPIO</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_gpio_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">gpiodev</span><span class="p">,</span> <span class="o">*</span><span class="n">pcidev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">set</span><span class="p">;</span>

	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span>
			  <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">)</span>
			  <span class="o">&amp;</span> <span class="mh">0xFFFF3FFF</span><span class="p">);</span>

	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GPIO_MASK</span><span class="p">,</span>
			  <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			  <span class="n">B43legacy_MMIO_GPIO_MASK</span><span class="p">)</span>
			  <span class="o">|</span> <span class="mh">0x000F</span><span class="p">);</span>

	<span class="n">mask</span> <span class="o">=</span> <span class="mh">0x0000001F</span><span class="p">;</span>
	<span class="n">set</span> <span class="o">=</span> <span class="mh">0x0000000F</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4301</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mh">0x0060</span><span class="p">;</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="mh">0x0060</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43legacy_BFL_PACTRL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GPIO_MASK</span><span class="p">,</span>
				  <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">B43legacy_MMIO_GPIO_MASK</span><span class="p">)</span>
				  <span class="o">|</span> <span class="mh">0x0200</span><span class="p">);</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="mh">0x0200</span><span class="p">;</span>
		<span class="n">set</span> <span class="o">|=</span> <span class="mh">0x0200</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">mask</span>  <span class="o">|=</span> <span class="mh">0x0010</span><span class="p">;</span> <span class="cm">/* FIXME: This is redundant. */</span>

<span class="cp">#ifdef CONFIG_SSB_DRIVER_PCICORE</span>
	<span class="n">pcidev</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">pcicore</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">gpiodev</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">.</span><span class="n">dev</span> <span class="o">?</span> <span class="o">:</span> <span class="n">pcidev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpiodev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">gpiodev</span><span class="p">,</span> <span class="n">B43legacy_GPIO_CONTROL</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">ssb_read32</span><span class="p">(</span><span class="n">gpiodev</span><span class="p">,</span> <span class="n">B43legacy_GPIO_CONTROL</span><span class="p">)</span>
		     <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">set</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Turn off all GPIO stuff. Call this on module unload, for example. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_gpio_cleanup</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">gpiodev</span><span class="p">,</span> <span class="o">*</span><span class="n">pcidev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SSB_DRIVER_PCICORE</span>
	<span class="n">pcidev</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">pcicore</span><span class="p">.</span><span class="n">dev</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">gpiodev</span> <span class="o">=</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">.</span><span class="n">dev</span> <span class="o">?</span> <span class="o">:</span> <span class="n">pcidev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">gpiodev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">gpiodev</span><span class="p">,</span> <span class="n">B43legacy_GPIO_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/EnableMac */</span>
<span class="kt">void</span> <span class="nf">b43legacy_mac_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mac_suspended</span><span class="o">--</span><span class="p">;</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mac_suspended</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">irqs_disabled</span><span class="p">());</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mac_suspended</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span>
				  <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">)</span>
				  <span class="o">|</span> <span class="n">B43legacy_MACCTL_ENABLED</span><span class="p">);</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_REASON</span><span class="p">,</span>
				  <span class="n">B43legacy_IRQ_MAC_SUSPENDED</span><span class="p">);</span>
		<span class="cm">/* the next two are dummy reads */</span>
		<span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
		<span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_REASON</span><span class="p">);</span>
		<span class="n">b43legacy_power_saving_ctl_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>

		<span class="cm">/* Re-enable IRQs. */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_MASK</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/SuspendMAC */</span>
<span class="kt">void</span> <span class="nf">b43legacy_mac_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">irqs_disabled</span><span class="p">());</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mac_suspended</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mac_suspended</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Mask IRQs before suspending MAC. Otherwise</span>
<span class="cm">		 * the MAC stays busy and won&#39;t suspend. */</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
		<span class="n">b43legacy_synchronize_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">b43legacy_power_saving_ctl_bits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span>
				  <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">)</span>
				  <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_ENABLED</span><span class="p">);</span>
		<span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_REASON</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					       <span class="n">B43legacy_MMIO_GEN_IRQ_REASON</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">B43legacy_IRQ_MAC_SUSPENDED</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;MAC suspend failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mac_suspended</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_adjust_opmode</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ctl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cfp_pretbtt</span><span class="p">;</span>

	<span class="n">ctl</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
	<span class="cm">/* Reset status to STA infrastructure mode. */</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_AP</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_KEEP_CTL</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_KEEP_BADPLCP</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_KEEP_BAD</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_PROMISC</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_BEACPROMISC</span><span class="p">;</span>
	<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_INFRA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">))</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_AP</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span>
		<span class="n">ctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_INFRA</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_CONTROL</span><span class="p">)</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_KEEP_CTL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_FCSFAIL</span><span class="p">)</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_KEEP_BAD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PLCPFAIL</span><span class="p">)</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_KEEP_BADPLCP</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">)</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_PROMISC</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;</span> <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">)</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_BEACPROMISC</span><span class="p">;</span>

	<span class="cm">/* Workaround: On old hardware the HW-MAC-address-filter</span>
<span class="cm">	 * doesn&#39;t work properly, so always run promisc in filter</span>
<span class="cm">	 * it in software. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">ctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_PROMISC</span><span class="p">;</span>

	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span> <span class="n">ctl</span><span class="p">);</span>

	<span class="n">cfp_pretbtt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">B43legacy_MACCTL_INFRA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">B43legacy_MACCTL_AP</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4306</span> <span class="o">&amp;&amp;</span>
		    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">cfp_pretbtt</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">cfp_pretbtt</span> <span class="o">=</span> <span class="mi">50</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x612</span><span class="p">,</span> <span class="n">cfp_pretbtt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_rate_memory_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">rate</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">is_ofdm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">offset</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_ofdm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mh">0x480</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">b43legacy_plcp_get_ratecode_ofdm</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mh">0x4C0</span><span class="p">;</span>
		<span class="n">offset</span> <span class="o">+=</span> <span class="p">(</span><span class="n">b43legacy_plcp_get_ratecode_cck</span><span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x000F</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="mh">0x20</span><span class="p">,</span>
			      <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
			      <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="n">offset</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_rate_memory_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_G</span>:
		<span class="n">b43legacy_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_OFDM_RATE_6MB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43legacy_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_OFDM_RATE_12MB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43legacy_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_OFDM_RATE_18MB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43legacy_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_OFDM_RATE_24MB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43legacy_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_OFDM_RATE_36MB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43legacy_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_OFDM_RATE_48MB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43legacy_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_OFDM_RATE_54MB</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="cm">/* fallthrough */</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_B</span>:
		<span class="n">b43legacy_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_CCK_RATE_1MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43legacy_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_CCK_RATE_2MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43legacy_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_CCK_RATE_5MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43legacy_rate_memory_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_CCK_RATE_11MB</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Set the TX-Antenna for management frames sent by firmware. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_mgmtframe_txantenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="kt">int</span> <span class="n">antenna</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ant</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">antenna</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_ANTENNA0</span>:
		<span class="n">ant</span> <span class="o">|=</span> <span class="n">B43legacy_TX4_PHY_ANT0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43legacy_ANTENNA1</span>:
		<span class="n">ant</span> <span class="o">|=</span> <span class="n">B43legacy_TX4_PHY_ANT1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43legacy_ANTENNA_AUTO</span>:
		<span class="n">ant</span> <span class="o">|=</span> <span class="n">B43legacy_TX4_PHY_ANTLAST</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME We also need to set the other flags of the PHY control</span>
<span class="cm">	 * field somewhere. */</span>

	<span class="cm">/* For Beacons */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
				   <span class="n">B43legacy_SHM_SH_BEACPHYCTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43legacy_TX4_PHY_ANT</span><span class="p">)</span> <span class="o">|</span> <span class="n">ant</span><span class="p">;</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
			      <span class="n">B43legacy_SHM_SH_BEACPHYCTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="cm">/* For ACK/CTS */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
				   <span class="n">B43legacy_SHM_SH_ACKCTSPHYCTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43legacy_TX4_PHY_ANT</span><span class="p">)</span> <span class="o">|</span> <span class="n">ant</span><span class="p">;</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
			      <span class="n">B43legacy_SHM_SH_ACKCTSPHYCTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="cm">/* For Probe Resposes */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
				   <span class="n">B43legacy_SHM_SH_PRPHYCTL</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">B43legacy_TX4_PHY_ANT</span><span class="p">)</span> <span class="o">|</span> <span class="n">ant</span><span class="p">;</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
			      <span class="n">B43legacy_SHM_SH_PRPHYCTL</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This is the opposite of b43legacy_chip_init() */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_chip_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacy_radio_turn_off</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">b43legacy_gpio_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* firmware is released later */</span>
<span class="p">}</span>

<span class="cm">/* Initialize the chip</span>
<span class="cm"> * http://bcm-specs.sipsolutions.net/ChipInit</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_chip_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value32</span><span class="p">,</span> <span class="n">macctl</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">value16</span><span class="p">;</span>

	<span class="cm">/* Initialize the MAC control */</span>
	<span class="n">macctl</span> <span class="o">=</span> <span class="n">B43legacy_MACCTL_IHR_ENABLED</span> <span class="o">|</span> <span class="n">B43legacy_MACCTL_SHM_ENABLED</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span><span class="p">)</span>
		<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_GMODE</span><span class="p">;</span>
	<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_INFRA</span><span class="p">;</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span> <span class="n">macctl</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_upload_microcode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* firmware is released later */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_gpio_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span> <span class="cm">/* firmware is released later */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_upload_initvals</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_gpio_clean</span><span class="p">;</span>
	<span class="n">b43legacy_radio_turn_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E6</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_phy_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_radio_off</span><span class="p">;</span>

	<span class="cm">/* Select initial Interference Mitigation. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">interfmode</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">interfmode</span> <span class="o">=</span> <span class="n">B43legacy_INTERFMODE_NONE</span><span class="p">;</span>
	<span class="n">b43legacy_radio_set_interference_mitigation</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">b43legacy_phy_set_antenna_diversity</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_mgmtframe_txantenna</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_ANTENNA_DEFAULT</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">value16</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005E</span><span class="p">);</span>
		<span class="n">value16</span> <span class="o">|=</span> <span class="mh">0x0004</span><span class="p">;</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005E</span><span class="p">,</span> <span class="n">value16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">,</span> <span class="mh">0x01000000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x010C</span><span class="p">,</span> <span class="mh">0x01000000</span><span class="p">);</span>

	<span class="n">value32</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
	<span class="n">value32</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_INFRA</span><span class="p">;</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span> <span class="n">value32</span><span class="p">);</span>
	<span class="n">value32</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
	<span class="n">value32</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_INFRA</span><span class="p">;</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span> <span class="n">value32</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_using_pio</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0210</span><span class="p">,</span> <span class="mh">0x00000100</span><span class="p">);</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0230</span><span class="p">,</span> <span class="mh">0x00000100</span><span class="p">);</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0250</span><span class="p">,</span> <span class="mh">0x00000100</span><span class="p">);</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0270</span><span class="p">,</span> <span class="mh">0x00000100</span><span class="p">);</span>
		<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0034</span><span class="p">,</span>
				      <span class="mh">0x0000</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Probe Response Timeout value */</span>
	<span class="cm">/* FIXME: Default to 0, has to be set by ioctl probably... :-/ */</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0074</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="cm">/* Initially set the wireless operation mode. */</span>
	<span class="n">b43legacy_adjust_opmode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x060E</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0610</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0604</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0606</span><span class="p">,</span> <span class="mh">0x0200</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0188</span><span class="p">,</span> <span class="mh">0x80000000</span><span class="p">);</span>
		<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x018C</span><span class="p">,</span> <span class="mh">0x02000000</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_REASON</span><span class="p">,</span> <span class="mh">0x00004000</span><span class="p">);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_DMA0_IRQ_MASK</span><span class="p">,</span> <span class="mh">0x0001DC00</span><span class="p">);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_DMA1_IRQ_MASK</span><span class="p">,</span> <span class="mh">0x0000DC00</span><span class="p">);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_DMA2_IRQ_MASK</span><span class="p">,</span> <span class="mh">0x0000DC00</span><span class="p">);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_DMA3_IRQ_MASK</span><span class="p">,</span> <span class="mh">0x0001DC00</span><span class="p">);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_DMA4_IRQ_MASK</span><span class="p">,</span> <span class="mh">0x0000DC00</span><span class="p">);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_DMA5_IRQ_MASK</span><span class="p">,</span> <span class="mh">0x0000DC00</span><span class="p">);</span>

	<span class="n">value32</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">);</span>
	<span class="n">value32</span> <span class="o">|=</span> <span class="n">B43legacy_TMSLOW_MACPHYCLKEN</span><span class="p">;</span>
	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span> <span class="n">value32</span><span class="p">);</span>

	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_POWERUP_DELAY</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chipco</span><span class="p">.</span><span class="n">fast_pwrup_delay</span><span class="p">);</span>

	<span class="cm">/* PHY TX errors counter. */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">txerr_cnt</span><span class="p">,</span> <span class="n">B43legacy_PHY_TX_BADNESS_LIMIT</span><span class="p">);</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Chip initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_radio_off:</span>
	<span class="n">b43legacy_radio_turn_off</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">err_gpio_clean:</span>
	<span class="n">b43legacy_gpio_cleanup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_periodic_every120sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">B43legacy_PHYTYPE_G</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">b43legacy_mac_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_phy_lo_g_measure</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_mac_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_periodic_every60sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacy_phy_lo_mark_all_unused</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43legacy_BFL_RSSI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacy_mac_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">b43legacy_calc_nrssi_slope</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">b43legacy_mac_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_periodic_every30sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Update device statistics. */</span>
	<span class="n">b43legacy_calculate_link_quality</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_periodic_every15sec</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacy_phy_xmitpower</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span> <span class="cm">/* FIXME: unless scanning? */</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">txerr_cnt</span><span class="p">,</span> <span class="n">B43legacy_PHY_TX_BADNESS_LIMIT</span><span class="p">);</span>
	<span class="n">wmb</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">do_periodic_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">periodic_state</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">b43legacy_periodic_every120sec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">b43legacy_periodic_every60sec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">b43legacy_periodic_every30sec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_periodic_every15sec</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Periodic work locking policy:</span>
<span class="cm"> * 	The whole periodic work handler is protected by</span>
<span class="cm"> * 	wl-&gt;mutex. If another lock is needed somewhere in the</span>
<span class="cm"> * 	pwork callchain, it&#39;s acquired in-place, where it&#39;s needed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_periodic_work_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">b43legacy_wldev</span><span class="p">,</span>
					     <span class="n">periodic_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_DBG_PWORK_STOP</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_requeue</span><span class="p">;</span>

	<span class="n">do_periodic_work</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">periodic_state</span><span class="o">++</span><span class="p">;</span>
<span class="nl">out_requeue:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_debug</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_DBG_PWORK_FAST</span><span class="p">))</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">delay</span> <span class="o">=</span> <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">HZ</span> <span class="o">*</span> <span class="mi">15</span><span class="p">);</span>
	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">periodic_work</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_periodic_tasks_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">work</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">periodic_work</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">periodic_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="n">b43legacy_periodic_work_handler</span><span class="p">);</span>
	<span class="n">ieee80211_queue_delayed_work</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Validate access to the chip (SHM) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_validate_chipaccess</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">shm_backup</span><span class="p">;</span>

	<span class="n">shm_backup</span> <span class="o">=</span> <span class="n">b43legacy_shm_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43legacy_shm_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0xAA5555AA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_shm_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span>
				 <span class="mh">0xAA5555AA</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">b43legacy_shm_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x55AAAA55</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_shm_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span>
				 <span class="mh">0x55AAAA55</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">b43legacy_shm_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">shm_backup</span><span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">value</span> <span class="o">|</span> <span class="n">B43legacy_MACCTL_GMODE</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="n">B43legacy_MACCTL_GMODE</span> <span class="o">|</span> <span class="n">B43legacy_MACCTL_IHR_ENABLED</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_REASON</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Failed to validate the chipaccess</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_security_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_nr_keys</span> <span class="o">=</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="mi">58</span> <span class="o">:</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_nr_keys</span> <span class="o">&gt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ktp</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
					<span class="mh">0x0056</span><span class="p">);</span>
	<span class="cm">/* KTP is a word address, but we address SHM bytewise.</span>
<span class="cm">	 * So multiply by two.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ktp</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
		<span class="cm">/* Number of RCMTA address slots */</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_RCMTA_COUNT</span><span class="p">,</span>
				  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_nr_keys</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_B43LEGACY_HWRNG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_rng_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">hwrng</span> <span class="o">*</span><span class="n">rng</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="p">)</span><span class="n">rng</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Don&#39;t take wl-&gt;mutex here, as it could deadlock with</span>
<span class="cm">	 * hwrng internal locking. It&#39;s not needed to take</span>
<span class="cm">	 * wl-&gt;mutex here, anyway. */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_RNG</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u16</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_rng_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_B43LEGACY_HWRNG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng_initialized</span><span class="p">)</span>
		<span class="n">hwrng_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_rng_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_B43LEGACY_HWRNG</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng_name</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng_name</span><span class="p">),</span>
		 <span class="s">&quot;%s_%s&quot;</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">wiphy_name</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">));</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng_name</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">data_read</span> <span class="o">=</span> <span class="n">b43legacy_rng_read</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">.</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wl</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng_initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">hwrng_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">rng_initialized</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Failed to register the random &quot;</span>
		       <span class="s">&quot;number generator (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_tx_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">b43legacy_wl</span><span class="p">,</span>
				  <span class="n">tx_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queue_num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">dev</span> <span class="o">||</span> <span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">queue_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">queue_num</span> <span class="o">&lt;</span> <span class="n">B43legacy_QOS_QUEUE_NUM</span><span class="p">;</span> <span class="n">queue_num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_using_pio</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_pio_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_dma_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue_stopped</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">ieee80211_stop_queue</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">queue_num</span><span class="p">);</span>
				<span class="n">skb_queue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">queue_num</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span><span class="p">))</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span> <span class="cm">/* Drop it */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue_stopped</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_op_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43legacy_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Too short, this can&#39;t be a valid frame. */</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">skb_shinfo</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">nr_frags</span><span class="p">);</span>

	<span class="n">skb_queue_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">queue_mapping</span><span class="p">],</span> <span class="n">skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue_stopped</span><span class="p">[</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">queue_mapping</span><span class="p">])</span>
		<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ieee80211_stop_queue</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">queue_mapping</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_op_conf_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="n">u16</span> <span class="n">queue</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_tx_queue_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_op_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ieee80211_low_level_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43legacy_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">ieee_stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">stats</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">phymode_to_string</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phymode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phymode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYMODE_B</span>:
		<span class="k">return</span> <span class="s">&quot;B&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYMODE_G</span>:
		<span class="k">return</span> <span class="s">&quot;G&quot;</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">find_wldev_for_phymode</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phymode</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">**</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">bool</span> <span class="o">*</span><span class="n">gmode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">d</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">d</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">possible_phymodes</span> <span class="o">&amp;</span> <span class="n">phymode</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Ok, this device supports the PHY-mode.</span>
<span class="cm">			 * Set the gmode bit. */</span>
			<span class="o">*</span><span class="n">gmode</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ESRCH</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_put_phy_into_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmslow</span><span class="p">;</span>

	<span class="n">tmslow</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">);</span>
	<span class="n">tmslow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_TMSLOW_GMODE</span><span class="p">;</span>
	<span class="n">tmslow</span> <span class="o">|=</span> <span class="n">B43legacy_TMSLOW_PHYRESET</span><span class="p">;</span>
	<span class="n">tmslow</span> <span class="o">|=</span> <span class="n">SSB_TMSLOW_FGC</span><span class="p">;</span>
	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span> <span class="n">tmslow</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">tmslow</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">);</span>
	<span class="n">tmslow</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SSB_TMSLOW_FGC</span><span class="p">;</span>
	<span class="n">tmslow</span> <span class="o">|=</span> <span class="n">B43legacy_TMSLOW_PHYRESET</span><span class="p">;</span>
	<span class="n">ssb_write32</span><span class="p">(</span><span class="n">sdev</span><span class="p">,</span> <span class="n">SSB_TMSLOW</span><span class="p">,</span> <span class="n">tmslow</span><span class="p">);</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Expects wl-&gt;mutex locked */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_switch_phymode</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">uninitialized_var</span><span class="p">(</span><span class="n">up_dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">down_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">gmode</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prev_status</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">find_wldev_for_phymode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">new_mode</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">up_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gmode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Could not find a device for %s-PHY mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">phymode_to_string</span><span class="p">(</span><span class="n">new_mode</span><span class="p">));</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">up_dev</span> <span class="o">==</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span> <span class="o">==</span> <span class="o">!!</span><span class="n">gmode</span><span class="p">))</span>
		<span class="cm">/* This device is already running. */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Reconfiguring PHYmode to %s-PHY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">phymode_to_string</span><span class="p">(</span><span class="n">new_mode</span><span class="p">));</span>
	<span class="n">down_dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>

	<span class="n">prev_status</span> <span class="o">=</span> <span class="n">b43legacy_status</span><span class="p">(</span><span class="n">down_dev</span><span class="p">);</span>
	<span class="cm">/* Shutdown the currently running core. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">)</span>
		<span class="n">b43legacy_wireless_core_stop</span><span class="p">(</span><span class="n">down_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">)</span>
		<span class="n">b43legacy_wireless_core_exit</span><span class="p">(</span><span class="n">down_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">down_dev</span> <span class="o">!=</span> <span class="n">up_dev</span><span class="p">)</span>
		<span class="cm">/* We switch to a different core, so we put PHY into</span>
<span class="cm">		 * RESET on the old core. */</span>
		<span class="n">b43legacy_put_phy_into_reset</span><span class="p">(</span><span class="n">down_dev</span><span class="p">);</span>

	<span class="cm">/* Now start the new core. */</span>
	<span class="n">up_dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span> <span class="o">=</span> <span class="n">gmode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_wireless_core_init</span><span class="p">(</span><span class="n">up_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Fatal: Could not initialize device&quot;</span>
				     <span class="s">&quot; for newly selected %s-PHY mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				     <span class="n">phymode_to_string</span><span class="p">(</span><span class="n">new_mode</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">init_failure</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_wireless_core_start</span><span class="p">(</span><span class="n">up_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Fatal: Could not start device for &quot;</span>
			       <span class="s">&quot;newly selected %s-PHY mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">phymode_to_string</span><span class="p">(</span><span class="n">new_mode</span><span class="p">));</span>
			<span class="n">b43legacy_wireless_core_exit</span><span class="p">(</span><span class="n">up_dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">init_failure</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">up_dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">prev_status</span><span class="p">);</span>

	<span class="n">b43legacy_shm_write32</span><span class="p">(</span><span class="n">up_dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x003E</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span> <span class="o">=</span> <span class="n">up_dev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">init_failure:</span>
	<span class="cm">/* Whoops, failed to init the new core. No core is operating now. */</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Write the short and long frame retry limit values. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_set_retry_limits</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">short_retry</span><span class="p">,</span>
				       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">long_retry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The retry limit is a 4-bit counter. Enforce this to avoid overflowing</span>
<span class="cm">	 * the chip-internal counter. */</span>
	<span class="n">short_retry</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">short_retry</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mh">0xF</span><span class="p">);</span>
	<span class="n">long_retry</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">long_retry</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="mh">0xF</span><span class="p">);</span>

	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_WIRELESS</span><span class="p">,</span> <span class="mh">0x0006</span><span class="p">,</span> <span class="n">short_retry</span><span class="p">);</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_WIRELESS</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">,</span> <span class="n">long_retry</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_op_dev_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				   <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43legacy_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_phymode</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">antenna_tx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">antenna_tx</span> <span class="o">=</span> <span class="n">B43legacy_ANTENNA_DEFAULT</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_CHANGE_RETRY_LIMITS</span><span class="p">)</span>
		<span class="n">b43legacy_set_retry_limits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					   <span class="n">conf</span><span class="o">-&gt;</span><span class="n">short_frame_max_tx_count</span><span class="p">,</span>
					   <span class="n">conf</span><span class="o">-&gt;</span><span class="n">long_frame_max_tx_count</span><span class="p">);</span>
	<span class="n">changed</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_CONF_CHANGE_RETRY_LIMITS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">changed</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock_mutex</span><span class="p">;</span>

	<span class="cm">/* Switch the PHY mode (if necessary). */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_2GHZ</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_B</span><span class="p">)</span>
			<span class="n">new_phymode</span> <span class="o">=</span> <span class="n">B43legacy_PHYMODE_B</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">new_phymode</span> <span class="o">=</span> <span class="n">B43legacy_PHYMODE_G</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_switch_phymode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">new_phymode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unlock_mutex</span><span class="p">;</span>

	<span class="cm">/* Disable IRQs while reconfiguring the device.</span>
<span class="cm">	 * This makes it possible to drop the spinlock throughout</span>
<span class="cm">	 * the reconfiguration process. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock_mutex</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">b43legacy_synchronize_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Switch to the requested channel.</span>
<span class="cm">	 * The firmware takes care of races with the TX handler. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span> <span class="o">!=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">)</span>
		<span class="n">b43legacy_radio_selectchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">radiotap_enabled</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CONF_MONITOR</span><span class="p">);</span>

	<span class="cm">/* Adjust the desired TX power level. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">!=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">power_level</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">power_level</span><span class="p">;</span>
			<span class="n">b43legacy_phy_xmitpower</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Antennas for RX and management frame TX. */</span>
	<span class="n">b43legacy_mgmtframe_txantenna</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">antenna_tx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">radio_enabled</span> <span class="o">!=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">radio_enabled</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_radio_turn_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">b43legacyinfo</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Radio turned on by software</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_hw_enable</span><span class="p">)</span>
				<span class="n">b43legacyinfo</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;The hardware RF-kill&quot;</span>
					      <span class="s">&quot; button still turns the radio&quot;</span>
					      <span class="s">&quot; physically off. Press the&quot;</span>
					      <span class="s">&quot; button to turn it on.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43legacy_radio_turn_off</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43legacyinfo</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Radio turned off by&quot;</span>
				      <span class="s">&quot; software</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">out_unlock_mutex:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_update_basic_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">brates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span> <span class="o">=</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rate</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">basic</span><span class="p">,</span> <span class="n">direct</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">basic_offset</span><span class="p">,</span> <span class="n">rateptr</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_is_cck_rate</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">direct</span> <span class="o">=</span> <span class="n">B43legacy_SHM_SH_CCKDIRECT</span><span class="p">;</span>
			<span class="n">basic</span> <span class="o">=</span> <span class="n">B43legacy_SHM_SH_CCKBASIC</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">b43legacy_plcp_get_ratecode_cck</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">&amp;=</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">direct</span> <span class="o">=</span> <span class="n">B43legacy_SHM_SH_OFDMDIRECT</span><span class="p">;</span>
			<span class="n">basic</span> <span class="o">=</span> <span class="n">B43legacy_SHM_SH_OFDMBASIC</span><span class="p">;</span>
			<span class="n">offset</span> <span class="o">=</span> <span class="n">b43legacy_plcp_get_ratecode_ofdm</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
			<span class="n">offset</span> <span class="o">&amp;=</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">rate</span> <span class="o">=</span> <span class="n">ieee80211_get_response_rate</span><span class="p">(</span><span class="n">sband</span><span class="p">,</span> <span class="n">brates</span><span class="p">,</span> <span class="n">rate</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_is_cck_rate</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">basic_offset</span> <span class="o">=</span> <span class="n">b43legacy_plcp_get_ratecode_cck</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
			<span class="n">basic_offset</span> <span class="o">&amp;=</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">basic_offset</span> <span class="o">=</span> <span class="n">b43legacy_plcp_get_ratecode_ofdm</span><span class="p">(</span><span class="n">rate</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">);</span>
			<span class="n">basic_offset</span> <span class="o">&amp;=</span> <span class="mh">0xF</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Get the pointer that we need to point to</span>
<span class="cm">		 * from the direct map</span>
<span class="cm">		 */</span>
		<span class="n">rateptr</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
					       <span class="n">direct</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">basic_offset</span><span class="p">);</span>
		<span class="cm">/* and write it to the basic map */</span>
		<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
				      <span class="n">basic</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">offset</span><span class="p">,</span> <span class="n">rateptr</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_op_bss_info_changed</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">ieee80211_bss_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43legacy_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">!=</span> <span class="n">vif</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>

	<span class="cm">/* Disable IRQs while reconfiguring the device.</span>
<span class="cm">	 * This makes it possible to drop the spinlock throughout</span>
<span class="cm">	 * the reconfiguration process. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unlock_mutex</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BSSID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacy_synchronize_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">b43legacy_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">||</span>
		     <span class="n">b43legacy_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)))</span>
			<span class="n">b43legacy_update_templates</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BSSID</span><span class="p">)</span>
			<span class="n">b43legacy_write_mac_bssid_templates</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">b43legacy_mac_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BEACON_INT</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">b43legacy_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">||</span>
	     <span class="n">b43legacy_is_mode</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)))</span>
		<span class="n">b43legacy_set_beacon_int</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">beacon_int</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_BASIC_RATES</span><span class="p">)</span>
		<span class="n">b43legacy_update_basic_rates</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">basic_rates</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">BSS_CHANGED_ERP_SLOT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">use_short_slot</span><span class="p">)</span>
			<span class="n">b43legacy_short_slot_timing_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43legacy_short_slot_timing_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43legacy_mac_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>
	<span class="cm">/* XXX: why? */</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
 <span class="nl">out_unlock_mutex:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_op_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed</span><span class="p">,</span>
					  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">fflags</span><span class="p">,</span><span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43legacy_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">fflags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="o">*</span><span class="n">fflags</span> <span class="o">&amp;=</span> <span class="n">FIF_PROMISC_IN_BSS</span> <span class="o">|</span>
		  <span class="n">FIF_ALLMULTI</span> <span class="o">|</span>
		  <span class="n">FIF_FCSFAIL</span> <span class="o">|</span>
		  <span class="n">FIF_PLCPFAIL</span> <span class="o">|</span>
		  <span class="n">FIF_CONTROL</span> <span class="o">|</span>
		  <span class="n">FIF_OTHER_BSS</span> <span class="o">|</span>
		  <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">;</span>

	<span class="n">changed</span> <span class="o">&amp;=</span> <span class="n">FIF_PROMISC_IN_BSS</span> <span class="o">|</span>
		   <span class="n">FIF_ALLMULTI</span> <span class="o">|</span>
		   <span class="n">FIF_FCSFAIL</span> <span class="o">|</span>
		   <span class="n">FIF_PLCPFAIL</span> <span class="o">|</span>
		   <span class="n">FIF_CONTROL</span> <span class="o">|</span>
		   <span class="n">FIF_OTHER_BSS</span> <span class="o">|</span>
		   <span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="o">*</span><span class="n">fflags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;&amp;</span> <span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">)</span>
		<span class="n">b43legacy_adjust_opmode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Locking: wl-&gt;mutex */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_wireless_core_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queue_num</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Disable and sync interrupts. We must do this before than</span>
<span class="cm">	 * setting the status to INITIALIZED, as the interrupt handler</span>
<span class="cm">	 * won&#39;t care about IRQs then. */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_MASK</span><span class="p">);</span> <span class="cm">/* flush */</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">b43legacy_synchronize_irq</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">b43legacy_set_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="cm">/* Must unlock as it would otherwise deadlock. No races here.</span>
<span class="cm">	 * Cancel the possibly running self-rearming periodic work. */</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">periodic_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Drain all TX queues. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">queue_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">queue_num</span> <span class="o">&lt;</span> <span class="n">B43legacy_QOS_QUEUE_NUM</span><span class="p">;</span> <span class="n">queue_num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">skb_queue_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]))</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb_dequeue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]));</span>
	<span class="p">}</span>

<span class="n">b43legacy_mac_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Wireless interface stopped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Locking: wl-&gt;mutex */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_wireless_core_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">);</span>

	<span class="n">drain_txstatus_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">b43legacy_interrupt_handler</span><span class="p">,</span>
			  <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Cannot request IRQ-%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* We are ready to run. */</span>
	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">b43legacy_set_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">);</span>

	<span class="cm">/* Start data flow (TX/RX) */</span>
	<span class="n">b43legacy_mac_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_GEN_IRQ_MASK</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span><span class="p">);</span>

	<span class="cm">/* Start maintenance work */</span>
	<span class="n">b43legacy_periodic_tasks_setup</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Wireless interface started</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get PHY and RADIO versioning numbers */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_phy_versioning</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">analog_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_type</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">phy_rev</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">radio_manuf</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">radio_ver</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">radio_rev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unsupported</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Get PHY versioning */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_PHY_VER</span><span class="p">);</span>
	<span class="n">analog_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">B43legacy_PHYVER_ANALOG</span><span class="p">)</span>
		      <span class="o">&gt;&gt;</span> <span class="n">B43legacy_PHYVER_ANALOG_SHIFT</span><span class="p">;</span>
	<span class="n">phy_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">B43legacy_PHYVER_TYPE</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">B43legacy_PHYVER_TYPE_SHIFT</span><span class="p">;</span>
	<span class="n">phy_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="n">B43legacy_PHYVER_VERSION</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_B</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_rev</span> <span class="o">!=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">phy_rev</span> <span class="o">!=</span> <span class="mi">4</span>
		    <span class="o">&amp;&amp;</span> <span class="n">phy_rev</span> <span class="o">!=</span> <span class="mi">6</span> <span class="o">&amp;&amp;</span> <span class="n">phy_rev</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_G</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy_rev</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unsupported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;FOUND UNSUPPORTED PHY &quot;</span>
		       <span class="s">&quot;(Analog %u, Type %u, Revision %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">analog_type</span><span class="p">,</span> <span class="n">phy_type</span><span class="p">,</span> <span class="n">phy_rev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Found PHY: Analog %u, Type %u, Revision %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">analog_type</span><span class="p">,</span> <span class="n">phy_type</span><span class="p">,</span> <span class="n">phy_rev</span><span class="p">);</span>


	<span class="cm">/* Get RADIO versioning */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4317</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x3205017F</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x4205017F</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="mh">0x5205017F</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_RADIO_CONTROL</span><span class="p">,</span>
				  <span class="n">B43legacy_RADIOCTL_ID</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_RADIO_DATA_HIGH</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&lt;&lt;=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_RADIO_CONTROL</span><span class="p">,</span>
				  <span class="n">B43legacy_RADIOCTL_ID</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_RADIO_DATA_LOW</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">radio_manuf</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x00000FFF</span><span class="p">);</span>
	<span class="n">radio_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0x0FFFF000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">radio_rev</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xF0000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">phy_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_B</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">radio_ver</span> <span class="o">&amp;</span> <span class="mh">0xFFF0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x2050</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_G</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2050</span><span class="p">)</span>
			<span class="n">unsupported</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unsupported</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;FOUND UNSUPPORTED RADIO &quot;</span>
		       <span class="s">&quot;(Manuf 0x%X, Version 0x%X, Revision %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">radio_manuf</span><span class="p">,</span> <span class="n">radio_ver</span><span class="p">,</span> <span class="n">radio_rev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Found Radio: Manuf 0x%X, Version 0x%X,&quot;</span>
		     <span class="s">&quot; Revision %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">radio_manuf</span><span class="p">,</span> <span class="n">radio_ver</span><span class="p">,</span> <span class="n">radio_rev</span><span class="p">);</span>


	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_manuf</span> <span class="o">=</span> <span class="n">radio_manuf</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">=</span> <span class="n">radio_ver</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">=</span> <span class="n">radio_rev</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">=</span> <span class="n">analog_type</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">phy_type</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">=</span> <span class="n">phy_rev</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_struct_phy_for_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_lopair</span> <span class="o">*</span><span class="n">lo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">minlowsig</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">minlowsig</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">minlowsigpos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">minlowsigpos</span><span class="p">));</span>

	<span class="cm">/* Assume the radio is enabled. If it&#39;s not enabled, the state will</span>
<span class="cm">	 * immediately get fixed on the first periodic work run. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">radio_hw_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">savedpctlreg</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_wlan_automatic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_hw_rssi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">lo</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">_lo_pairs</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lo</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">lo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_lopair</span><span class="p">)</span> <span class="o">*</span>
				     <span class="n">B43legacy_LO_COUNT</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">max_lb_gain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">trsw_rx_gain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set default attenuation values. */</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">bbatt</span> <span class="o">=</span> <span class="n">b43legacy_default_baseband_attenuation</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">rfatt</span> <span class="o">=</span> <span class="n">b43legacy_default_radio_attenuation</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">txctl1</span> <span class="o">=</span> <span class="n">b43legacy_default_txctl1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">txpwr_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* NRSSI */</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssislope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">lofcal</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">initval</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">interfmode</span> <span class="o">=</span> <span class="n">B43legacy_INTERFMODE_NONE</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_struct_wldev_for_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Flags */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dfq_valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Stats */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">));</span>

	<span class="n">setup_struct_phy_for_init</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">);</span>

	<span class="cm">/* IRQ related flags */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_reason</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma_reason</span><span class="p">));</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">B43legacy_IRQ_MASKTEMPLATE</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mac_suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Noise calculation context */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">noisecalc</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_set_synth_pu_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">bool</span> <span class="n">idle</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">pu_delay</span> <span class="o">=</span> <span class="mi">1050</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_is_mode</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span> <span class="o">||</span> <span class="n">idle</span><span class="p">)</span>
		<span class="n">pu_delay</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">))</span>
		<span class="n">pu_delay</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">pu_delay</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="mi">2400</span><span class="p">);</span>

	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
			      <span class="n">B43legacy_SHM_SH_SPUWKUP</span><span class="p">,</span> <span class="n">pu_delay</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set the TSF CFP pre-TargetBeaconTransmissionTime. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_set_pretbtt</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">pretbtt</span><span class="p">;</span>

	<span class="cm">/* The time value is in microseconds. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_is_mode</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">))</span>
		<span class="n">pretbtt</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">pretbtt</span> <span class="o">=</span> <span class="mi">250</span><span class="p">;</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
			      <span class="n">B43legacy_SHM_SH_PRETBTT</span><span class="p">,</span> <span class="n">pretbtt</span><span class="p">);</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_TSF_CFP_PRETBTT</span><span class="p">,</span> <span class="n">pretbtt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Shutdown a wireless core */</span>
<span class="cm">/* Locking: wl-&gt;mutex */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_wireless_core_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">macctl</span><span class="p">;</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">b43legacy_set_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_STAT_UNINIT</span><span class="p">);</span>

	<span class="cm">/* Stop the microcode PSM. */</span>
	<span class="n">macctl</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
	<span class="n">macctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_PSM_RUN</span><span class="p">;</span>
	<span class="n">macctl</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_PSM_JMP0</span><span class="p">;</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span> <span class="n">macctl</span><span class="p">);</span>

	<span class="n">b43legacy_leds_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_rng_exit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">b43legacy_pio_free</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_dma_free</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_chip_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_radio_turn_off</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">b43legacy_switch_analog</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dyn_tssi_tbl</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">tssi2dbm</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">lo_control</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">lo_control</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_beacon</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ssb_device_disable</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ssb_bus_may_powerdown</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">prepare_phy_data_for_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Set default attenuation values. */</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">bbatt</span> <span class="o">=</span> <span class="n">b43legacy_default_baseband_attenuation</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">rfatt</span> <span class="o">=</span> <span class="n">b43legacy_default_radio_attenuation</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">txctl1</span> <span class="o">=</span> <span class="n">b43legacy_default_txctl1</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">txctl2</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">txpwr_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* NRSSI */</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssislope</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1000</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">lofcal</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">initval</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_wlan_automatic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_hw_rssi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">antenna_diversity</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">minlowsig</span><span class="p">,</span> <span class="mh">0xFF</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">minlowsig</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">minlowsigpos</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">minlowsigpos</span><span class="p">));</span>

	<span class="cm">/* Flags */</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">calibrated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">_lo_pairs</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">_lo_pairs</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_lopair</span><span class="p">)</span> <span class="o">*</span> <span class="n">B43legacy_LO_COUNT</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">loopback_gain</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">loopback_gain</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* Initialize a wireless core */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_wireless_core_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B43legacy_STAT_UNINIT</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_bus_powerup</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ssb_device_is_enabled</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">?</span> <span class="n">B43legacy_TMSLOW_GMODE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">b43legacy_wireless_core_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_B</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_G</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">_lo_pairs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_lopair</span><span class="p">)</span>
					 <span class="o">*</span> <span class="n">B43legacy_LO_COUNT</span><span class="p">,</span>
					 <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">_lo_pairs</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">setup_struct_wldev_for_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_phy_init_tssi2dbm_table</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_kfree_lo_control</span><span class="p">;</span>

	<span class="cm">/* Enable IRQ routing to this device. */</span>
	<span class="n">ssb_pcicore_dev_irqvecs_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pcicore</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">prepare_phy_data_for_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_phy_calibrate</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_chip_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_kfree_tssitbl</span><span class="p">;</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
			      <span class="n">B43legacy_SHM_SH_WLCOREREV</span><span class="p">,</span>
			      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span><span class="p">);</span>
	<span class="n">hf</span> <span class="o">=</span> <span class="n">b43legacy_hf_read</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_G</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hf</span> <span class="o">|=</span> <span class="n">B43legacy_HF_SYMW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">hf</span> <span class="o">|=</span> <span class="n">B43legacy_HF_GDCW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span> <span class="n">B43legacy_BFL_PACTRL</span><span class="p">)</span>
			<span class="n">hf</span> <span class="o">|=</span> <span class="n">B43legacy_HF_OFDMPABOOST</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hf</span> <span class="o">|=</span> <span class="n">B43legacy_HF_SYMW</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span><span class="p">)</span>
			<span class="n">hf</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_HF_GDCW</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacy_hf_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">hf</span><span class="p">);</span>

	<span class="n">b43legacy_set_retry_limits</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				   <span class="n">B43legacy_DEFAULT_SHORT_RETRY_LIMIT</span><span class="p">,</span>
				   <span class="n">B43legacy_DEFAULT_LONG_RETRY_LIMIT</span><span class="p">);</span>

	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
			      <span class="mh">0x0044</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
			      <span class="mh">0x0046</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Disable sending probe responses from firmware.</span>
<span class="cm">	 * Setting the MaxTime to one usec will always trigger</span>
<span class="cm">	 * a timeout, so we never send any probe resp.</span>
<span class="cm">	 * A timeout of zero is infinite. */</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
			      <span class="n">B43legacy_SHM_SH_PRMAXTIME</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">b43legacy_rate_memory_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Minimum Contention Window */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_B</span><span class="p">)</span>
		<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_WIRELESS</span><span class="p">,</span>
				      <span class="mh">0x0003</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_WIRELESS</span><span class="p">,</span>
				      <span class="mh">0x0003</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>
	<span class="cm">/* Maximum Contention Window */</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_WIRELESS</span><span class="p">,</span>
			      <span class="mh">0x0004</span><span class="p">,</span> <span class="mi">1023</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_using_pio</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_pio_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_dma_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
				<span class="n">b43legacy_qos_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">err</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_chip_exit</span><span class="p">;</span>

	<span class="n">b43legacy_set_synth_pu_delay</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">ssb_bus_powerup</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Enable dynamic PCTL */</span>
	<span class="n">b43legacy_upload_card_macaddress</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_security_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_rng_init</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>

	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">b43legacy_set_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">);</span>

	<span class="n">b43legacy_leds_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_chip_exit:</span>
	<span class="n">b43legacy_chip_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err_kfree_tssitbl:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">dyn_tssi_tbl</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">tssi2dbm</span><span class="p">);</span>
<span class="nl">err_kfree_lo_control:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">lo_control</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">lo_control</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ssb_bus_may_powerdown</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="n">B43legacy_STAT_UNINIT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_op_add_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43legacy_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="cm">/* TODO: allow WDS/AP devices to coexist */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_AP</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_WDS</span> <span class="o">&amp;&amp;</span>
	    <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">operating</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_mutex_unlock</span><span class="p">;</span>

	<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Adding Interface type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">operating</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="n">vif</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">if_type</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">b43legacy_adjust_opmode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_set_pretbtt</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_set_synth_pu_delay</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43legacy_upload_card_macaddress</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out_mutex_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_op_remove_interface</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43legacy_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Removing Interface type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">operating</span><span class="p">);</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">!=</span> <span class="n">vif</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">operating</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">b43legacy_adjust_opmode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">b43legacy_upload_card_macaddress</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_op_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43legacy_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">did_init</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Kill all old instance specific information to make sure</span>
<span class="cm">	 * the card won&#39;t use it in the short timeframe between start</span>
<span class="cm">	 * and mac80211 reconfiguring it. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mac_addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon0_uploaded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon1_uploaded</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_templates_virgin</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">radio_enabled</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_wireless_core_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out_mutex_unlock</span><span class="p">;</span>
		<span class="n">did_init</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_wireless_core_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">did_init</span><span class="p">)</span>
				<span class="n">b43legacy_wireless_core_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_mutex_unlock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">wiphy_rfkill_start_polling</span><span class="p">(</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">);</span>

<span class="nl">out_mutex_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_op_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43legacy_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>

	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_update_trigger</span><span class="p">));</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">)</span>
		<span class="n">b43legacy_wireless_core_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_wireless_core_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">radio_enabled</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_op_beacon_set_tim</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">bool</span> <span class="n">set</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43legacy_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">b43legacy_update_templates</span><span class="p">(</span><span class="n">wl</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_op_get_survey</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">survey_info</span> <span class="o">*</span><span class="n">survey</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43legacy_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">=</span> <span class="n">SURVEY_INFO_NOISE_DBM</span><span class="p">;</span>
	<span class="n">survey</span><span class="o">-&gt;</span><span class="n">noise</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">link_noise</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">b43legacy_hw_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx</span>			<span class="o">=</span> <span class="n">b43legacy_op_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conf_tx</span>		<span class="o">=</span> <span class="n">b43legacy_op_conf_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span>		<span class="o">=</span> <span class="n">b43legacy_op_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span>	<span class="o">=</span> <span class="n">b43legacy_op_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span>			<span class="o">=</span> <span class="n">b43legacy_op_dev_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span>	<span class="o">=</span> <span class="n">b43legacy_op_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span>	<span class="o">=</span> <span class="n">b43legacy_op_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_stats</span>		<span class="o">=</span> <span class="n">b43legacy_op_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span>			<span class="o">=</span> <span class="n">b43legacy_op_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span>			<span class="o">=</span> <span class="n">b43legacy_op_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tim</span>		<span class="o">=</span> <span class="n">b43legacy_op_beacon_set_tim</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_survey</span>		<span class="o">=</span> <span class="n">b43legacy_op_get_survey</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rfkill_poll</span>		<span class="o">=</span> <span class="n">b43legacy_rfkill_poll</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Hard-reset the chip. Do not call this directly.</span>
<span class="cm"> * Use b43legacy_controller_restart()</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_chip_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">b43legacy_wldev</span><span class="p">,</span> <span class="n">restart_work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">prev_status</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">prev_status</span> <span class="o">=</span> <span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* Bring the device down... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">)</span>
		<span class="n">b43legacy_wireless_core_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">)</span>
		<span class="n">b43legacy_wireless_core_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* ...and up again. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_wireless_core_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">prev_status</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_wireless_core_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_wireless_core_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span> <span class="cm">/* Failed to init the dev. */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Controller restart FAILED</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">b43legacyinfo</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Controller restarted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_setup_modes</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">have_bphy</span><span class="p">,</span>
				 <span class="kt">int</span> <span class="n">have_gphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">possible_phymodes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">have_bphy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">b43legacy_band_2GHz_BPHY</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">possible_phymodes</span> <span class="o">|=</span> <span class="n">B43legacy_PHYMODE_B</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">have_gphy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span>
			<span class="o">&amp;</span><span class="n">b43legacy_band_2GHz_GPHY</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">possible_phymodes</span> <span class="o">|=</span> <span class="n">B43legacy_PHYMODE_G</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_wireless_core_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* We release firmware that late to not be required to re-request</span>
<span class="cm">	 * is all the time when we reinit the core. */</span>
	<span class="n">b43legacy_release_firmware</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_wireless_core_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">bustype</span> <span class="o">==</span> <span class="n">SSB_BUSTYPE_PCI</span><span class="p">)</span> <span class="o">?</span> <span class="n">bus</span><span class="o">-&gt;</span><span class="n">host_pci</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">have_bphy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">have_gphy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Do NOT do any device initialization here.</span>
<span class="cm">	 * Do it in wireless_core_init() instead.</span>
<span class="cm">	 * This function is for gathering basic information about the HW, only.</span>
<span class="cm">	 * Also some structs may be set up here. But most likely you want to</span>
<span class="cm">	 * have that in core_init(), too.</span>
<span class="cm">	 */</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_bus_powerup</span><span class="p">(</span><span class="n">bus</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Bus powerup failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Get the PHY type. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">tmshigh</span><span class="p">;</span>

		<span class="n">tmshigh</span> <span class="o">=</span> <span class="n">ssb_read32</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">SSB_TMSHIGH</span><span class="p">);</span>
		<span class="n">have_gphy</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">tmshigh</span> <span class="o">&amp;</span> <span class="n">B43legacy_TMSHIGH_GPHY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">have_gphy</span><span class="p">)</span>
			<span class="n">have_bphy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">have_gphy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">have_bphy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span> <span class="o">=</span> <span class="p">(</span><span class="n">have_gphy</span> <span class="o">||</span> <span class="n">have_bphy</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">radio_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span> <span class="o">?</span> <span class="n">B43legacy_TMSLOW_GMODE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">b43legacy_wireless_core_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_phy_versioning</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_powerdown</span><span class="p">;</span>
	<span class="cm">/* Check if this device supports multiband. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="mh">0x4312</span> <span class="o">&amp;&amp;</span>
	     <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="mh">0x4319</span> <span class="o">&amp;&amp;</span>
	     <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="mh">0x4324</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* No multiband support. */</span>
		<span class="n">have_bphy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">have_gphy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_B</span>:
			<span class="n">have_bphy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_G</span>:
			<span class="n">have_gphy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span> <span class="o">=</span> <span class="p">(</span><span class="n">have_gphy</span> <span class="o">||</span> <span class="n">have_bphy</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">.</span><span class="n">gmode</span> <span class="o">?</span> <span class="n">B43legacy_TMSLOW_GMODE</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">b43legacy_wireless_core_reset</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_validate_chipaccess</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_powerdown</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_setup_modes</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">have_bphy</span><span class="p">,</span> <span class="n">have_gphy</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_powerdown</span><span class="p">;</span>

	<span class="cm">/* Now set some default &quot;current_dev&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span><span class="p">)</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">,</span> <span class="n">b43legacy_chip_reset</span><span class="p">);</span>

	<span class="n">b43legacy_radio_turn_off</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">b43legacy_switch_analog</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ssb_device_disable</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ssb_bus_may_powerdown</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_powerdown:</span>
	<span class="n">ssb_bus_may_powerdown</span><span class="p">(</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_one_core_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">wldev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>

	<span class="cm">/* Do not cancel ieee80211-workqueue based work here.</span>
<span class="cm">	 * See comment in b43legacy_remove(). */</span>

	<span class="n">wldev</span> <span class="o">=</span> <span class="n">ssb_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">wl</span> <span class="o">=</span> <span class="n">wldev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="n">b43legacy_debugfs_remove_device</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
	<span class="n">b43legacy_wireless_core_detach</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">nr_devs</span><span class="o">--</span><span class="p">;</span>
	<span class="n">ssb_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_one_core_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">wldev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">wldev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wldev</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wldev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">wldev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">wldev</span><span class="o">-&gt;</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wl</span><span class="p">;</span>
	<span class="n">b43legacy_set_status</span><span class="p">(</span><span class="n">wldev</span><span class="p">,</span> <span class="n">B43legacy_STAT_UNINIT</span><span class="p">);</span>
	<span class="n">wldev</span><span class="o">-&gt;</span><span class="n">bad_frames_preempt</span> <span class="o">=</span> <span class="n">modparam_bad_frames_preempt</span><span class="p">;</span>
	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">isr_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">b43legacy_interrupt_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wldev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">modparam_pio</span><span class="p">)</span>
		<span class="n">wldev</span><span class="o">-&gt;</span><span class="n">__using_pio</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_wireless_core_attach</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_kfree_wldev</span><span class="p">;</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">nr_devs</span><span class="o">++</span><span class="p">;</span>
	<span class="n">ssb_set_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wldev</span><span class="p">);</span>
	<span class="n">b43legacy_debugfs_add_device</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_kfree_wldev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_sprom_fixup</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* boardflags workarounds */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_APPLE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="mh">0x4E</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">board_rev</span> <span class="o">&gt;</span> <span class="mh">0x40</span><span class="p">)</span>
		<span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">boardflags_lo</span> <span class="o">|=</span> <span class="n">B43legacy_BFL_PACTRL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_wireless_exit</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">ssb_set_devtypedata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_wireless_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ssb_sprom</span> <span class="o">*</span><span class="n">sprom</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">queue_num</span><span class="p">;</span>

	<span class="n">b43legacy_sprom_fixup</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">);</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">ieee80211_alloc_hw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">b43legacy_hw_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacyerr</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;Could not allocate ieee80211 device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* fill hw info */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_HW_RX_INCLUDES_FCS</span> <span class="o">|</span>
		    <span class="n">IEEE80211_HW_SIGNAL_DBM</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_AP</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_WDS</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* FIXME: hardware has more queues */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_rates</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_valid_ether_addr</span><span class="p">(</span><span class="n">sprom</span><span class="o">-&gt;</span><span class="n">et1mac</span><span class="p">))</span>
		<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">et1mac</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">sprom</span><span class="o">-&gt;</span><span class="n">il0mac</span><span class="p">);</span>

	<span class="cm">/* Get and initialize struct b43legacy_wl */</span>
	<span class="n">wl</span> <span class="o">=</span> <span class="n">hw_to_b43legacy_wl</span><span class="p">(</span><span class="n">hw</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">wl</span><span class="p">));</span>
	<span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">irq_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">leds_lock</span><span class="p">);</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">beacon_update_trigger</span><span class="p">,</span> <span class="n">b43legacy_beacon_update_trigger_work</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_work</span><span class="p">,</span> <span class="n">b43legacy_tx_work</span><span class="p">);</span>

	<span class="cm">/* Initialize queues and flags. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">queue_num</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">queue_num</span> <span class="o">&lt;</span> <span class="n">B43legacy_QOS_QUEUE_NUM</span><span class="p">;</span> <span class="n">queue_num</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_queue_head_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]);</span>
		<span class="n">wl</span><span class="o">-&gt;</span><span class="n">tx_queue_stopped</span><span class="p">[</span><span class="n">queue_num</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ssb_set_devtypedata</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>
	<span class="n">b43legacyinfo</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Broadcom %04X WLAN found (core revision %u)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="k">const</span> <span class="k">struct</span> <span class="n">ssb_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">first</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">wl</span> <span class="o">=</span> <span class="n">ssb_get_devtypedata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Probing the first core - setup common struct b43legacy_wl */</span>
		<span class="n">first</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_wireless_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="n">wl</span> <span class="o">=</span> <span class="n">ssb_get_devtypedata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_one_core_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_wireless_exit</span><span class="p">;</span>

	<span class="cm">/* setup and start work to load firmware */</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">firmware_load</span><span class="p">,</span> <span class="n">b43legacy_request_firmware</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">firmware_load</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_wireless_exit:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span>
		<span class="n">b43legacy_wireless_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">ssb_get_devtypedata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">wldev</span> <span class="o">=</span> <span class="n">ssb_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* We must cancel any work here before unregistering from ieee80211,</span>
<span class="cm">	 * as the ieee80211 unreg will destroy the workqueue. */</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">firmware_load</span><span class="p">);</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">wl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">current_dev</span> <span class="o">==</span> <span class="n">wldev</span><span class="p">)</span>
		<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">b43legacy_one_core_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">devlist</span><span class="p">))</span>
		<span class="cm">/* Last core on the chip unregistered.</span>
<span class="cm">		 * We can destroy common struct b43legacy_wl.</span>
<span class="cm">		 */</span>
		<span class="n">b43legacy_wireless_exit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">wl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Perform a hardware reset. This can be called from any context. */</span>
<span class="kt">void</span> <span class="nf">b43legacy_controller_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Must avoid requeueing, if we are in shutdown. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_status</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">b43legacyinfo</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Controller RESET (%s) ...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">);</span>
	<span class="n">ieee80211_queue_work</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">restart_work</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">wldev</span> <span class="o">=</span> <span class="n">ssb_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wldev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>

	<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Suspending...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wldev</span><span class="o">-&gt;</span><span class="n">suspend_init_status</span> <span class="o">=</span> <span class="n">b43legacy_status</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">suspend_init_status</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">)</span>
		<span class="n">b43legacy_wireless_core_stop</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">suspend_init_status</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">)</span>
		<span class="n">b43legacy_wireless_core_exit</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Device suspended.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">b43legacy_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">ssb_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">wldev</span> <span class="o">=</span> <span class="n">ssb_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">b43legacy_wl</span> <span class="o">*</span><span class="n">wl</span> <span class="o">=</span> <span class="n">wldev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Resuming...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">suspend_init_status</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_INITIALIZED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_wireless_core_init</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Resume failed at core init</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wldev</span><span class="o">-&gt;</span><span class="n">suspend_init_status</span> <span class="o">&gt;=</span> <span class="n">B43legacy_STAT_STARTED</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_wireless_core_start</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_wireless_core_exit</span><span class="p">(</span><span class="n">wldev</span><span class="p">);</span>
			<span class="n">b43legacyerr</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Resume failed at core start</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Device resumed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wl</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else	</span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>
<span class="cp"># define b43legacy_suspend	NULL</span>
<span class="cp"># define b43legacy_resume		NULL</span>
<span class="cp">#endif	</span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ssb_driver</span> <span class="n">b43legacy_ssb_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">b43legacy_ssb_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">b43legacy_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">b43legacy_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="n">b43legacy_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>		<span class="o">=</span> <span class="n">b43legacy_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_print_driverinfo</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">feat_pci</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">feat_leds</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		   <span class="o">*</span><span class="n">feat_pio</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">feat_dma</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_B43LEGACY_PCI_AUTOSELECT</span>
	<span class="n">feat_pci</span> <span class="o">=</span> <span class="s">&quot;P&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43LEGACY_LEDS</span>
	<span class="n">feat_leds</span> <span class="o">=</span> <span class="s">&quot;L&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43LEGACY_PIO</span>
	<span class="n">feat_pio</span> <span class="o">=</span> <span class="s">&quot;I&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_B43LEGACY_DMA</span>
	<span class="n">feat_dma</span> <span class="o">=</span> <span class="s">&quot;D&quot;</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Broadcom 43xx-legacy driver loaded &quot;</span>
	       <span class="s">&quot;[ Features: %s%s%s%s ]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">feat_pci</span><span class="p">,</span> <span class="n">feat_leds</span><span class="p">,</span> <span class="n">feat_pio</span><span class="p">,</span> <span class="n">feat_dma</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">b43legacy_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">b43legacy_debugfs_init</span><span class="p">();</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">ssb_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b43legacy_ssb_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_dfs_exit</span><span class="p">;</span>

	<span class="n">b43legacy_print_driverinfo</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">err_dfs_exit:</span>
	<span class="n">b43legacy_debugfs_exit</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">b43legacy_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ssb_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">b43legacy_ssb_driver</span><span class="p">);</span>
	<span class="n">b43legacy_debugfs_exit</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">b43legacy_init</span><span class="p">)</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">b43legacy_exit</span><span class="p">)</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
