<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › b43legacy › radio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>radio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>

<span class="cm">  Broadcom B43legacy wireless driver</span>

<span class="cm">  Copyright (c) 2005 Martin Langer &lt;martin-langer@gmx.de&gt;,</span>
<span class="cm">		     Stefano Brivio &lt;stefano.brivio@polimi.it&gt;</span>
<span class="cm">		     Michael Buesch &lt;m@bues.ch&gt;</span>
<span class="cm">		     Danny van Dyk &lt;kugelfang@gentoo.org&gt;</span>
<span class="cm">		     Andreas Jaggi &lt;andreas.jaggi@waterwave.ch&gt;</span>
<span class="cm">  Copyright (c) 2007 Larry Finger &lt;Larry.Finger@lwfinger.net&gt;</span>

<span class="cm">  Some parts of the code in this file are derived from the ipw2200</span>
<span class="cm">  driver  Copyright(c) 2003 - 2004 Intel Corporation.</span>

<span class="cm">  This program is free software; you can redistribute it and/or modify</span>
<span class="cm">  it under the terms of the GNU General Public License as published by</span>
<span class="cm">  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm">  (at your option) any later version.</span>

<span class="cm">  This program is distributed in the hope that it will be useful,</span>
<span class="cm">  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm">  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm">  GNU General Public License for more details.</span>

<span class="cm">  You should have received a copy of the GNU General Public License</span>
<span class="cm">  along with this program; see the file COPYING.  If not, write to</span>
<span class="cm">  the Free Software Foundation, Inc., 51 Franklin Steet, Fifth Floor,</span>
<span class="cm">  Boston, MA 02110-1301, USA.</span>

<span class="cm">*/</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &quot;b43legacy.h&quot;</span>
<span class="cp">#include &quot;main.h&quot;</span>
<span class="cp">#include &quot;phy.h&quot;</span>
<span class="cp">#include &quot;radio.h&quot;</span>
<span class="cp">#include &quot;ilt.h&quot;</span>


<span class="cm">/* Table for b43legacy_radio_calibrationvalue() */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">rcc_table</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x0002</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="mh">0x000F</span><span class="p">,</span>
	<span class="mh">0x0006</span><span class="p">,</span> <span class="mh">0x0007</span><span class="p">,</span> <span class="mh">0x0005</span><span class="p">,</span> <span class="mh">0x000F</span><span class="p">,</span>
	<span class="mh">0x000A</span><span class="p">,</span> <span class="mh">0x000B</span><span class="p">,</span> <span class="mh">0x0009</span><span class="p">,</span> <span class="mh">0x000F</span><span class="p">,</span>
	<span class="mh">0x000E</span><span class="p">,</span> <span class="mh">0x000F</span><span class="p">,</span> <span class="mh">0x000D</span><span class="p">,</span> <span class="mh">0x000F</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Reverse the bits of a 4bit value.</span>
<span class="cm"> * Example:  1101 is flipped 1011</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">flip_4bit</span><span class="p">(</span><span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">flipped</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>

	<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">value</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x000F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0000</span><span class="p">));</span>

	<span class="n">flipped</span> <span class="o">|=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">flipped</span> <span class="o">|=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">flipped</span> <span class="o">|=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0004</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">flipped</span> <span class="o">|=</span> <span class="p">(</span><span class="n">value</span> <span class="o">&amp;</span> <span class="mh">0x0008</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">flipped</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get the freq, as it has to be written to the device. */</span>
<span class="k">static</span> <span class="kr">inline</span>
<span class="n">u16</span> <span class="nf">channel2freq_bg</span><span class="p">(</span><span class="n">u8</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Frequencies are given as frequencies_bg[index] + 2.4GHz</span>
<span class="cm">	 * Starting with channel 1</span>
<span class="cm">	 */</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">frequencies_bg</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mi">12</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span>
		<span class="mi">32</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span>
		<span class="mi">52</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span>
		<span class="mi">72</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">channel</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">14</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;b43legacy: Channel %d is out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">channel</span><span class="p">);</span>
		<span class="n">dump_stack</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">2412</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">frequencies_bg</span><span class="p">[</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_radio_lock</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">B43legacy_MACCTL_RADIOLOCK</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">B43legacy_MACCTL_RADIOLOCK</span><span class="p">;</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_radio_unlock</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_PHY_VER</span><span class="p">);</span> <span class="cm">/* dummy read */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">b43legacy_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">);</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">B43legacy_MACCTL_RADIOLOCK</span><span class="p">));</span>
	<span class="n">status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">B43legacy_MACCTL_RADIOLOCK</span><span class="p">;</span>
	<span class="n">b43legacy_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_MACCTL</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">b43legacy_radio_read16</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_B</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2053</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mh">0x70</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x80</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="n">offset</span> <span class="o">+=</span> <span class="mh">0x70</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span><span class="p">)</span>
			<span class="n">offset</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_G</span>:
		<span class="n">offset</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_RADIO_CONTROL</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_RADIO_DATA_LOW</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_radio_write16</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_RADIO_CONTROL</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_RADIO_DATA_LOW</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_set_all_gains</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">s16</span> <span class="n">first</span><span class="p">,</span> <span class="n">s16</span> <span class="n">second</span><span class="p">,</span> <span class="n">s16</span> <span class="n">third</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">start</span> <span class="o">=</span> <span class="mh">0x08</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">end</span> <span class="o">=</span> <span class="mh">0x18</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span> <span class="o">=</span> <span class="mh">0x0400</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mh">0x5000</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="mh">0x20</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43legacy_ilt_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">first</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43legacy_ilt_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">second</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">third</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">third</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">u16</span><span class="p">)</span><span class="n">third</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xBFBF</span><span class="p">)</span>
				    <span class="o">|</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xBFBF</span><span class="p">)</span>
				    <span class="o">|</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xBFBF</span><span class="p">)</span>
				    <span class="o">|</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43legacy_dummy_transmission</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_set_original_gains</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">offset</span> <span class="o">=</span> <span class="mh">0x0400</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">start</span> <span class="o">=</span> <span class="mh">0x0008</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">end</span> <span class="o">=</span> <span class="mh">0x0018</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="mh">0x5000</span><span class="p">;</span>
		<span class="n">start</span> <span class="o">=</span> <span class="mh">0x0010</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="mh">0x0020</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0xFFFC</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mh">0x0002</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">b43legacy_ilt_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">b43legacy_ilt_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">i</span><span class="p">,</span> <span class="n">i</span> <span class="o">-</span> <span class="n">start</span><span class="p">);</span>

	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xBFBF</span><span class="p">)</span>
			    <span class="o">|</span> <span class="mh">0x4040</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xBFBF</span><span class="p">)</span>
			    <span class="o">|</span> <span class="mh">0x4040</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xBFBF</span><span class="p">)</span>
			    <span class="o">|</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="n">b43legacy_dummy_transmission</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Synthetic PU workaround */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_synth_pu_workaround</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">u8</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2050</span> <span class="o">||</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span>
		<span class="cm">/* We do not need the workaround. */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_CHANNEL</span><span class="p">,</span>
				  <span class="n">channel2freq_bg</span><span class="p">(</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">4</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_CHANNEL</span><span class="p">,</span>
				  <span class="n">channel2freq_bg</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_CHANNEL</span><span class="p">,</span>
			  <span class="n">channel2freq_bg</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">b43legacy_radio_aci_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">saved</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rssi</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">temp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">saved</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">);</span>
	<span class="n">b43legacy_radio_selectchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">,</span> <span class="p">(</span><span class="n">saved</span> <span class="o">&amp;</span> <span class="mh">0xFFF8</span><span class="p">)</span> <span class="o">|</span> <span class="mi">5</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_hw_rssi</span><span class="p">)</span>
		<span class="n">rssi</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rssi</span> <span class="o">=</span> <span class="n">saved</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
	<span class="cm">/* clamp temp to signed 5bit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">rssi</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
			<span class="n">temp</span> <span class="o">-=</span> <span class="mi">64</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&lt;</span> <span class="n">rssi</span><span class="p">)</span>
			<span class="n">j</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">,</span> <span class="n">saved</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u8</span> <span class="nf">b43legacy_radio_aci_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ret</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">channel</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_G</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">b43legacy_phy_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_radio_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span>
			    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFC</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">,</span>
			    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">)</span>
			    <span class="o">&amp;</span> <span class="mh">0x7FFF</span><span class="p">);</span>
	<span class="n">b43legacy_set_all_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">channel</span> <span class="o">-</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">channel</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">?</span> <span class="n">channel</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">13</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">channel</span> <span class="o">-</span> <span class="n">i</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_radio_aci_detect</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43legacy_radio_selectchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFC</span><span class="p">)</span>
			    <span class="o">|</span> <span class="mh">0x0003</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">,</span>
			    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0403</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFF8</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">,</span>
			    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">)</span>
			    <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">b43legacy_set_original_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">&lt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">?</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">:</span> <span class="mi">13</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ret</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacy_radio_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">b43legacy_phy_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">[</span><span class="n">channel</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/NRSSILookupTable */</span>
<span class="kt">void</span> <span class="nf">b43legacy_nrssi_hw_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">s16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_NRSSILT_CTRL</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">mmiowb</span><span class="p">();</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_NRSSILT_DATA</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/NRSSILookupTable */</span>
<span class="n">s16</span> <span class="nf">b43legacy_nrssi_hw_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_NRSSILT_CTRL</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_NRSSILT_DATA</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/NRSSILookupTable */</span>
<span class="kt">void</span> <span class="nf">b43legacy_nrssi_hw_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_nrssi_hw_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">-=</span> <span class="n">val</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="o">-</span><span class="mi">32</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>
		<span class="n">b43legacy_nrssi_hw_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/NRSSILookupTable */</span>
<span class="kt">void</span> <span class="nf">b43legacy_nrssi_mem_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">delta</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="mh">0x1F</span> <span class="o">-</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">delta</span><span class="p">)</span> <span class="o">*</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssislope</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">/=</span> <span class="mh">0x10000</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">+=</span> <span class="mh">0x3A</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3F</span><span class="p">);</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi_lt</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">b43legacy_calc_nrssi_offset</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">backup</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">s16</span> <span class="n">v47F</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">saved</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="n">backup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0814</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">);</span>

	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0429</span><span class="p">,</span>
			    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0429</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FFF</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3FFF</span><span class="p">)</span>
			    <span class="o">|</span> <span class="mh">0x4000</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span>
			    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000C</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFF3</span><span class="p">)</span>
			    <span class="o">|</span> <span class="mh">0x0004</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span>
			    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002F</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x080F</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0810</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">);</span>

		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002F</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x080F</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0810</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0040</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0040</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0200</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span>
				<span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0070</span><span class="p">);</span>
	<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span>
				<span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0080</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>

	<span class="n">v47F</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)((</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x003F</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
		<span class="n">v47F</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">==</span> <span class="mi">31</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007B</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
			<span class="n">v47F</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)((</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span>
							 <span class="o">&amp;</span> <span class="mh">0x003F</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
				<span class="n">v47F</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">&lt;</span> <span class="mi">31</span> <span class="o">&amp;&amp;</span> <span class="n">saved</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
				<span class="n">saved</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">saved</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
			<span class="n">saved</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span>
					<span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="mh">0x007F</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0814</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0814</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0001</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFE</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000C</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000C</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0030</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0030</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="mh">0x0480</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="mh">0x0810</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x000D</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="mh">0x0122</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">,</span>
					    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">)</span>
					    <span class="o">|</span> <span class="mh">0x2000</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0814</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0814</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0004</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFB</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF9F</span><span class="p">)</span>
				    <span class="o">|</span> <span class="mh">0x0040</span><span class="p">);</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span>
					<span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">)</span>
					<span class="o">|</span> <span class="mh">0x000F</span><span class="p">);</span>
		<span class="n">b43legacy_set_all_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span>
					<span class="p">(</span><span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="mh">0x00F0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000F</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">30</span><span class="p">);</span>
		<span class="n">v47F</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)((</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x003F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
			<span class="n">v47F</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">==</span> <span class="o">-</span><span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007B</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
				<span class="n">v47F</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)((</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047F</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
								 <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x003F</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
					<span class="n">v47F</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">v47F</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">31</span> <span class="o">&amp;&amp;</span> <span class="n">saved</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
					<span class="n">saved</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">saved</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
				<span class="n">saved</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">saved</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007B</span><span class="p">,</span> <span class="n">saved</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002F</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x080F</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0810</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0814</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x000A</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
	<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
	<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span>
			    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1</span> <span class="o">|</span> <span class="mh">0x2</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0429</span><span class="p">,</span>
			    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0429</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>
	<span class="n">b43legacy_set_original_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">18</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">19</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0001</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_calc_nrssi_slope</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">backup</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">nrssi0</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">nrssi1</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_B</span>:
		<span class="n">backup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002A</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E2</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E6</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">);</span>

		<span class="n">tmp</span>  <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x007F</span> <span class="o">:</span> <span class="mh">0x000F</span><span class="p">;</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">,</span> <span class="mh">0x00FF</span><span class="p">);</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03EC</span><span class="p">,</span> <span class="mh">0x7F7F</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0020</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002A</span><span class="p">,</span> <span class="mh">0x08A3</span><span class="p">);</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span>
					<span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">)</span>
					<span class="o">|</span> <span class="mh">0x0080</span><span class="p">);</span>

		<span class="n">nrssi0</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0027</span><span class="p">);</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span>
					<span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="mh">0x007F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E6</span><span class="p">,</span> <span class="mh">0x0040</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E6</span><span class="p">,</span> <span class="mh">0x0122</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">,</span>
					  <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x2000</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="mh">0x3F3F</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xF330</span><span class="p">);</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">);</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span>
					<span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="mh">0x00F0</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="mh">0x0480</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="mh">0x0810</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x000D</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

		<span class="n">nrssi1</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0027</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E2</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002A</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">b43legacy_synth_pu_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03F4</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>

		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nrssi0</span> <span class="o">==</span> <span class="n">nrssi1</span><span class="p">)</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssislope</span> <span class="o">=</span> <span class="mh">0x00010000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssislope</span> <span class="o">=</span> <span class="mh">0x00400000</span> <span class="o">/</span> <span class="p">(</span><span class="n">nrssi0</span> <span class="o">-</span> <span class="n">nrssi1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">nrssi0</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrssi0</span><span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrssi1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_G</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">b43legacy_calc_nrssi_offset</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0x7FFF</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFFC</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E2</span><span class="p">);</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E2</span><span class="p">,</span>
				  <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E2</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E6</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">backup</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">);</span>
			<span class="n">backup</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002F</span><span class="p">);</span>
			<span class="n">backup</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x080F</span><span class="p">);</span>
			<span class="n">backup</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						<span class="n">B43legacy_PHY_G_LO_CONTROL</span><span class="p">);</span>
			<span class="n">backup</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">);</span>
			<span class="n">backup</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">);</span>
			<span class="n">backup</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">);</span>
			<span class="n">backup</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_LO_CONTROL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">4</span>: <span class="k">case</span> <span class="mi">6</span>: <span class="k">case</span> <span class="mi">7</span>:
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">,</span>
						    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="mh">0x0478</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0100</span><span class="p">);</span>
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">,</span>
						    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="mh">0x0801</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0040</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">3</span>: <span class="k">case</span> <span class="mi">5</span>:
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">,</span>
						    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="mh">0x0801</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFBF</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">,</span>
					    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">)</span>
					    <span class="o">|</span> <span class="mh">0x0040</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span>
					    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">)</span>
					    <span class="o">|</span> <span class="mh">0x0200</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span>
					<span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">)</span>
					<span class="o">|</span> <span class="mh">0x0070</span><span class="p">);</span>
		<span class="n">b43legacy_set_all_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span>
					<span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="mh">0x00F7</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0xFFCF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0030</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0xFFCF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0010</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span>
					<span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">)</span>
					<span class="o">|</span> <span class="mh">0x0080</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>

		<span class="n">nrssi0</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)((</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x003F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nrssi0</span> <span class="o">&gt;=</span> <span class="mh">0x0020</span><span class="p">)</span>
			<span class="n">nrssi0</span> <span class="o">-=</span> <span class="mh">0x0040</span><span class="p">;</span>

		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span>
					<span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="mh">0x007F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0xFF9F</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0040</span><span class="p">);</span>

		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">,</span>
				  <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x2000</span><span class="p">);</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span>
					<span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">)</span>
					<span class="o">|</span> <span class="mh">0x000F</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xF330</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0xFFCF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0020</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0xFFCF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0020</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">b43legacy_set_all_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="mh">0x001F</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF0F</span><span class="p">;</span>
			<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x0060</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFFF0</span><span class="p">;</span>
			<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="mh">0x0009</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="mh">0x0480</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="mh">0x0810</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x000D</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">nrssi1</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)((</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x047F</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x003F</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nrssi1</span> <span class="o">&gt;=</span> <span class="mh">0x0020</span><span class="p">)</span>
			<span class="n">nrssi1</span> <span class="o">-=</span> <span class="mh">0x0040</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nrssi0</span> <span class="o">==</span> <span class="n">nrssi1</span><span class="p">)</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssislope</span> <span class="o">=</span> <span class="mh">0x00010000</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssislope</span> <span class="o">=</span> <span class="mh">0x00400000</span> <span class="o">/</span> <span class="p">(</span><span class="n">nrssi0</span> <span class="o">-</span> <span class="n">nrssi1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nrssi0</span> <span class="o">&gt;=</span> <span class="o">-</span><span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrssi1</span><span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">nrssi0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002E</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002F</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x080F</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_LO_CONTROL</span><span class="p">,</span>
					    <span class="n">backup</span><span class="p">[</span><span class="mi">13</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
					    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0xFFCF</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span>
					    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0xFFCF</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x007A</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E2</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E6</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
		<span class="n">b43legacy_synth_pu_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0003</span><span class="p">);</span>
		<span class="n">b43legacy_set_original_gains</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">)</span>
				    <span class="o">|</span> <span class="mh">0x8000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0801</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0014</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0478</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">b43legacy_nrssi_mem_update</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">b43legacy_calc_nrssi_threshold</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_calc_nrssi_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">threshold</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">a</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">b</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">tmp16</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp_u16</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_B</span>: <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2050</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span>
		    <span class="n">B43legacy_BFL_RSSI</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">threshold</span> <span class="o">=</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">threshold</span> <span class="o">+=</span> <span class="mi">20</span> <span class="o">*</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">threshold</span> <span class="o">/=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">threshold</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>

		<span class="n">threshold</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">threshold</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mh">0x3E</span><span class="p">);</span>
		<span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">);</span> <span class="cm">/* dummy read */</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0020</span><span class="p">,</span> <span class="p">(((</span><span class="n">u16</span><span class="p">)</span><span class="n">threshold</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
				    <span class="o">|</span> <span class="mh">0x001C</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0087</span><span class="p">,</span> <span class="mh">0x0E0D</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0086</span><span class="p">,</span> <span class="mh">0x0C0B</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0085</span><span class="p">,</span> <span class="mh">0x0A09</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0084</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0083</span><span class="p">,</span> <span class="mh">0x0808</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0082</span><span class="p">,</span> <span class="mh">0x0604</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0081</span><span class="p">,</span> <span class="mh">0x0302</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0080</span><span class="p">,</span> <span class="mh">0x0100</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_G</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">boardflags_lo</span> <span class="o">&amp;</span>
		    <span class="n">B43legacy_BFL_RSSI</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">tmp16</span> <span class="o">=</span> <span class="n">b43legacy_nrssi_hw_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp16</span> <span class="o">&gt;=</span> <span class="mh">0x20</span><span class="p">)</span>
				<span class="n">tmp16</span> <span class="o">-=</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp16</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">,</span>
						    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="mh">0x048A</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x09EB</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">,</span>
						    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="mh">0x048A</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0AED</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">interfmode</span> <span class="o">==</span>
			    <span class="n">B43legacy_RADIO_INTERFMODE_NONWLAN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">a</span> <span class="o">=</span> <span class="mh">0xE</span><span class="p">;</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mh">0xA</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_wlan_automatic</span> <span class="o">&amp;&amp;</span>
				    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_enable</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">a</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mh">0x12</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">a</span> <span class="o">=</span> <span class="mh">0xE</span><span class="p">;</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mh">0x11</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">*</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">a</span> <span class="o">+=</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
				<span class="n">a</span> <span class="o">+=</span> <span class="mi">31</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">a</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">a</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">a</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>

			<span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">b</span> <span class="o">+=</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">nrssi</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="mi">32</span><span class="p">)</span>
				<span class="n">b</span> <span class="o">+=</span> <span class="mi">31</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">b</span> <span class="o">+=</span> <span class="mi">32</span><span class="p">;</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">b</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">;</span>
			<span class="n">b</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="o">-</span><span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">);</span>

			<span class="n">tmp_u16</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">;</span>
			<span class="n">tmp_u16</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">b</span> <span class="o">&amp;</span> <span class="mh">0x0000003F</span><span class="p">);</span>
			<span class="n">tmp_u16</span> <span class="o">|=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x0000003F</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">,</span> <span class="n">tmp_u16</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Stack implementation to save/restore values from the</span>
<span class="cm"> * interference mitigation code.</span>
<span class="cm"> * It is save to restore values in random order.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">_stack_save</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">_stackptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="o">*</span><span class="n">stackidx</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">,</span> <span class="n">u16</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">stackptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">_stackptr</span><span class="p">[</span><span class="o">*</span><span class="n">stackidx</span><span class="p">]);</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xE000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0000</span><span class="p">));</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">));</span>
	<span class="o">*</span><span class="n">stackptr</span> <span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="o">*</span><span class="n">stackptr</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">id</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="p">;</span>
	<span class="o">*</span><span class="n">stackptr</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">(</span><span class="o">*</span><span class="n">stackidx</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">stackidx</span> <span class="o">&lt;</span> <span class="n">B43legacy_INTERFSTACK_SIZE</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span> <span class="nf">_stack_restore</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="n">stackptr</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">size_t</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0xE000</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0000</span><span class="p">));</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">id</span> <span class="o">&amp;</span> <span class="mh">0xF8</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">B43legacy_INTERFSTACK_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">stackptr</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">*</span><span class="n">stackptr</span> <span class="o">&amp;</span> <span class="mh">0x00001FFF</span><span class="p">)</span> <span class="o">!=</span> <span class="n">offset</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(((</span><span class="o">*</span><span class="n">stackptr</span> <span class="o">&amp;</span> <span class="mh">0x00007000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">)</span> <span class="o">!=</span> <span class="n">id</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="k">return</span> <span class="p">((</span><span class="o">*</span><span class="n">stackptr</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define phy_stacksave(offset)					\</span>
<span class="cp">	do {							\</span>
<span class="cp">		_stack_save(stack, &amp;stackidx, 0x1, (offset),	\</span>
<span class="cp">			    b43legacy_phy_read(dev, (offset)));	\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define phy_stackrestore(offset)				\</span>
<span class="cp">	do {							\</span>
<span class="cp">		b43legacy_phy_write(dev, (offset),		\</span>
<span class="cp">				    _stack_restore(stack, 0x1,	\</span>
<span class="cp">				    (offset)));			\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define radio_stacksave(offset)						\</span>
<span class="cp">	do {								\</span>
<span class="cp">		_stack_save(stack, &amp;stackidx, 0x2, (offset),		\</span>
<span class="cp">			    b43legacy_radio_read16(dev, (offset)));	\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define radio_stackrestore(offset)					\</span>
<span class="cp">	do {								\</span>
<span class="cp">		b43legacy_radio_write16(dev, (offset),			\</span>
<span class="cp">					_stack_restore(stack, 0x2,	\</span>
<span class="cp">					(offset)));			\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define ilt_stacksave(offset)					\</span>
<span class="cp">	do {							\</span>
<span class="cp">		_stack_save(stack, &amp;stackidx, 0x3, (offset),	\</span>
<span class="cp">			    b43legacy_ilt_read(dev, (offset)));	\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define ilt_stackrestore(offset)				\</span>
<span class="cp">	do {							\</span>
<span class="cp">		b43legacy_ilt_write(dev, (offset),		\</span>
<span class="cp">				  _stack_restore(stack, 0x3,	\</span>
<span class="cp">						 (offset)));	\</span>
<span class="cp">	} while (0)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">b43legacy_radio_interference_mitigation_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					       <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">flipped</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp32</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">stackidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">stack</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">interfstack</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_RADIO_INTERFMODE_NONWLAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">,</span>
					    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">)</span>
					    <span class="o">|</span> <span class="mh">0x0800</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">,</span>
					    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">B43legacy_PHY_G_CRS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x4000</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">radio_stacksave</span><span class="p">(</span><span class="mh">0x0078</span><span class="p">);</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x001E</span><span class="p">);</span>
		<span class="n">flipped</span> <span class="o">=</span> <span class="n">flip_4bit</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flipped</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="o">&amp;&amp;</span> <span class="n">flipped</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">flipped</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">flipped</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">flipped</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
		<span class="n">flipped</span> <span class="o">=</span> <span class="n">flip_4bit</span><span class="p">(</span><span class="n">flipped</span><span class="p">);</span>
		<span class="n">flipped</span> <span class="o">=</span> <span class="p">(</span><span class="n">flipped</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0020</span><span class="p">;</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">,</span> <span class="n">flipped</span><span class="p">);</span>

		<span class="n">b43legacy_calc_nrssi_threshold</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0406</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0406</span><span class="p">,</span> <span class="mh">0x7E28</span><span class="p">);</span>

		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0800</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_RADIO_BITFIELD</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">B43legacy_PHY_RADIO_BITFIELD</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1000</span><span class="p">);</span>

		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A0</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC0C0</span><span class="p">)</span>
				    <span class="o">|</span> <span class="mh">0x0008</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A1</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC0C0</span><span class="p">)</span>
				    <span class="o">|</span> <span class="mh">0x0605</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A2</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC0C0</span><span class="p">)</span>
				    <span class="o">|</span> <span class="mh">0x0204</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A8</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC0C0</span><span class="p">)</span>
				    <span class="o">|</span> <span class="mh">0x0803</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AB</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xC0C0</span><span class="p">)</span>
				    <span class="o">|</span> <span class="mh">0x0605</span><span class="p">);</span>

		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A7</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A7</span><span class="p">,</span> <span class="mh">0x0002</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A3</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A3</span><span class="p">,</span> <span class="mh">0x287A</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A9</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A9</span><span class="p">,</span> <span class="mh">0x2027</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0493</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0493</span><span class="p">,</span> <span class="mh">0x32F5</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AA</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AA</span><span class="p">,</span> <span class="mh">0x2027</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AC</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AC</span><span class="p">,</span> <span class="mh">0x32F5</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43legacy_RADIO_INTERFMODE_MANUALWLAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0800</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_enable</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

		<span class="n">phy_stacksave</span><span class="p">(</span><span class="n">B43legacy_PHY_RADIO_BITFIELD</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="n">B43legacy_PHY_G_CRS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0406</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04C0</span><span class="p">);</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04C1</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0033</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A7</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A3</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A9</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AA</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AC</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0493</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A1</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A0</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A2</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x048A</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04A8</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AB</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AD</span><span class="p">);</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x04AD</span><span class="p">);</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0415</span><span class="p">);</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0416</span><span class="p">);</span>
			<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x0417</span><span class="p">);</span>
			<span class="n">ilt_stacksave</span><span class="p">(</span><span class="mh">0x1A00</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">);</span>
			<span class="n">ilt_stacksave</span><span class="p">(</span><span class="mh">0x1A00</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x042B</span><span class="p">);</span>
		<span class="n">phy_stacksave</span><span class="p">(</span><span class="mh">0x048C</span><span class="p">);</span>

		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_RADIO_BITFIELD</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">B43legacy_PHY_RADIO_BITFIELD</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x1000</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">B43legacy_PHY_G_CRS</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xFFFC</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0002</span><span class="p">);</span>

		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">,</span> <span class="mh">0x0800</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A3</span><span class="p">,</span> <span class="mh">0x2027</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A9</span><span class="p">,</span> <span class="mh">0x1CA8</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0493</span><span class="p">,</span> <span class="mh">0x287A</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AA</span><span class="p">,</span> <span class="mh">0x1CA8</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AC</span><span class="p">,</span> <span class="mh">0x287A</span><span class="p">);</span>

		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xFFC0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x001A</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A7</span><span class="p">,</span> <span class="mh">0x000D</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0406</span><span class="p">,</span> <span class="mh">0xFF0D</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04C0</span><span class="p">,</span> <span class="mh">0xFFFF</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04C1</span><span class="p">,</span> <span class="mh">0x00A9</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04C0</span><span class="p">,</span> <span class="mh">0x00C1</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04C1</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xC0FF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1800</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A1</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xFFC0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0015</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xCFFF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1000</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xF0FF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0A00</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xCFFF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1000</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xF0FF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0800</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xFFCF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0010</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AB</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xFFF0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0005</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xFFCF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0010</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A8</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xFFF0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0006</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xF0FF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0800</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A0</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xF0FF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0500</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04A2</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xFFF0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x000B</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">,</span>
					    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x8000</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0415</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0415</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x36D8</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0416</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0416</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x36D8</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0417</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0417</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0xFE00</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x016D</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">,</span>
					    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">)</span>
					    <span class="o">|</span> <span class="mh">0x1000</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048A</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0x9FFF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x2000</span><span class="p">);</span>
			<span class="n">tmp32</span> <span class="o">=</span> <span class="n">b43legacy_shm_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
					    <span class="n">B43legacy_UCODEFLAGS_OFFSET</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tmp32</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">tmp32</span> <span class="o">|=</span> <span class="mh">0x800</span><span class="p">;</span>
				<span class="n">b43legacy_shm_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
					    <span class="n">B43legacy_UCODEFLAGS_OFFSET</span><span class="p">,</span>
					    <span class="n">tmp32</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">,</span>
					    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">)</span>
					    <span class="o">|</span> <span class="mh">0x0800</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048C</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x048C</span><span class="p">)</span>
				    <span class="o">&amp;</span> <span class="mh">0xF0FF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0200</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AE</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AE</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0xFF00</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x007F</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AD</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AD</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x1300</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_ilt_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1A00</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x007F</span><span class="p">);</span>
			<span class="n">b43legacy_ilt_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x1A00</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x007F</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AD</span><span class="p">,</span>
					    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x04AD</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0x00FF</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43legacy_calc_nrssi_slope</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">b43legacy_radio_interference_mitigation_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp32</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">stack</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">interfstack</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_RADIO_INTERFMODE_NONWLAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">,</span>
					    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0800</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">,</span>
					    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">B43legacy_PHY_G_CRS</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x4000</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0078</span><span class="p">);</span>
		<span class="n">b43legacy_calc_nrssi_threshold</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0406</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x042B</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0800</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bad_frames_preempt</span><span class="p">)</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_RADIO_BITFIELD</span><span class="p">,</span>
					    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">B43legacy_PHY_RADIO_BITFIELD</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">));</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">,</span>
				    <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">)</span>
				    <span class="o">|</span> <span class="mh">0x4000</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A0</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A1</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A2</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A8</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AB</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A7</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A3</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A9</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0493</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AA</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AC</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43legacy_RADIO_INTERFMODE_MANUALWLAN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0033</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0800</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="n">B43legacy_PHY_RADIO_BITFIELD</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="n">B43legacy_PHY_G_CRS</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0033</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A3</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A9</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0493</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AA</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AC</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A0</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A7</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04C0</span><span class="p">);</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04C1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0406</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A1</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AB</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A8</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AD</span><span class="p">);</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04AD</span><span class="p">);</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0415</span><span class="p">);</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0416</span><span class="p">);</span>
			<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x0417</span><span class="p">);</span>
			<span class="n">ilt_stackrestore</span><span class="p">(</span><span class="mh">0x1A00</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">);</span>
			<span class="n">ilt_stackrestore</span><span class="p">(</span><span class="mh">0x1A00</span> <span class="o">+</span> <span class="mh">0x3</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A2</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x04A8</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x042B</span><span class="p">);</span>
		<span class="n">phy_stackrestore</span><span class="p">(</span><span class="mh">0x048C</span><span class="p">);</span>
		<span class="n">tmp32</span> <span class="o">=</span> <span class="n">b43legacy_shm_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
					     <span class="n">B43legacy_UCODEFLAGS_OFFSET</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp32</span> <span class="o">&amp;</span> <span class="mh">0x800</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tmp32</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x800</span><span class="p">;</span>
			<span class="n">b43legacy_shm_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
					      <span class="n">B43legacy_UCODEFLAGS_OFFSET</span><span class="p">,</span>
					      <span class="n">tmp32</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">b43legacy_calc_nrssi_slope</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#undef phy_stacksave</span>
<span class="cp">#undef phy_stackrestore</span>
<span class="cp">#undef radio_stacksave</span>
<span class="cp">#undef radio_stackrestore</span>
<span class="cp">#undef ilt_stacksave</span>
<span class="cp">#undef ilt_stackrestore</span>

<span class="kt">int</span> <span class="nf">b43legacy_radio_set_interference_mitigation</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">currentmode</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">B43legacy_PHYTYPE_G</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_wlan_automatic</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_RADIO_INTERFMODE_AUTOWLAN</span>:
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_wlan_automatic</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_enable</span><span class="p">)</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">B43legacy_RADIO_INTERFMODE_MANUALWLAN</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">B43legacy_RADIO_INTERFMODE_NONE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">B43legacy_RADIO_INTERFMODE_NONE</span>:
	<span class="k">case</span> <span class="n">B43legacy_RADIO_INTERFMODE_NONWLAN</span>:
	<span class="k">case</span> <span class="n">B43legacy_RADIO_INTERFMODE_MANUALWLAN</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">currentmode</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">interfmode</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">currentmode</span> <span class="o">==</span> <span class="n">mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">currentmode</span> <span class="o">!=</span> <span class="n">B43legacy_RADIO_INTERFMODE_NONE</span><span class="p">)</span>
		<span class="n">b43legacy_radio_interference_mitigation_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">currentmode</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">B43legacy_RADIO_INTERFMODE_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_enable</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">phy</span><span class="o">-&gt;</span><span class="n">aci_hw_rssi</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">b43legacy_radio_interference_mitigation_enable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">interfmode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">b43legacy_radio_calibrationvalue</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0060</span><span class="p">);</span>
	<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x001E</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rcc_table</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&amp;</span> <span class="mh">0x0001</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">|=</span> <span class="mh">0x0020</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define LPD(L, P, D)    (((L) &lt;&lt; 2) | ((P) &lt;&lt; 1) | ((D) &lt;&lt; 0))</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43legacy_get_812_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lpd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">loop_or</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">adj_loopback_gain</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">loopback_gain</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">loop</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">extern_lna_control</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">has_loopback_gain</span><span class="p">(</span><span class="n">phy</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">boardflags_lo</span>
		    <span class="o">&amp;</span> <span class="n">B43legacy_BFL_EXTLNA</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">lpd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
				<span class="k">return</span> <span class="mh">0x0FB2</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
				<span class="k">return</span> <span class="mh">0x00B2</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
				<span class="k">return</span> <span class="mh">0x30B2</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>:
				<span class="k">return</span> <span class="mh">0x30B3</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">lpd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
				<span class="k">return</span> <span class="mh">0x8FB2</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
				<span class="k">return</span> <span class="mh">0x80B2</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
				<span class="k">return</span> <span class="mh">0x20B2</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>:
				<span class="k">return</span> <span class="mh">0x20B3</span><span class="p">;</span>
			<span class="nl">default:</span>
				<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">adj_loopback_gain</span> <span class="o">+=</span> <span class="mh">0x003E</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">adj_loopback_gain</span> <span class="o">+=</span> <span class="mh">0x0026</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adj_loopback_gain</span> <span class="o">&gt;=</span> <span class="mh">0x46</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adj_loopback_gain</span> <span class="o">-=</span> <span class="mh">0x46</span><span class="p">;</span>
			<span class="n">extern_lna_control</span> <span class="o">=</span> <span class="mh">0x3000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adj_loopback_gain</span> <span class="o">&gt;=</span> <span class="mh">0x3A</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adj_loopback_gain</span> <span class="o">-=</span> <span class="mh">0x3A</span><span class="p">;</span>
			<span class="n">extern_lna_control</span> <span class="o">=</span> <span class="mh">0x2000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adj_loopback_gain</span> <span class="o">&gt;=</span> <span class="mh">0x2E</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">adj_loopback_gain</span> <span class="o">-=</span> <span class="mh">0x2E</span><span class="p">;</span>
			<span class="n">extern_lna_control</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">adj_loopback_gain</span> <span class="o">-=</span> <span class="mh">0x10</span><span class="p">;</span>
			<span class="n">extern_lna_control</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">loop</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">loop</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">adj_loopback_gain</span> <span class="o">-</span> <span class="mi">6</span> <span class="o">*</span> <span class="n">loop</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">loop_or</span> <span class="o">=</span> <span class="p">(</span><span class="n">loop</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">extern_lna_control</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">boardflags_lo</span>
		    <span class="o">&amp;</span> <span class="n">B43legacy_BFL_EXTLNA</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">extern_lna_control</span><span class="p">)</span>
				<span class="n">loop_or</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">lpd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
				<span class="k">return</span> <span class="mh">0x8F92</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
				<span class="k">return</span> <span class="p">(</span><span class="mh">0x8092</span> <span class="o">|</span> <span class="n">loop_or</span><span class="p">);</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
				<span class="k">return</span> <span class="p">(</span><span class="mh">0x2092</span> <span class="o">|</span> <span class="n">loop_or</span><span class="p">);</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>:
				<span class="k">return</span> <span class="p">(</span><span class="mh">0x2093</span> <span class="o">|</span> <span class="n">loop_or</span><span class="p">);</span>
			<span class="nl">default:</span>
				<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">lpd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
				<span class="k">return</span> <span class="mh">0x0F92</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>:
				<span class="k">return</span> <span class="p">(</span><span class="mh">0x0092</span> <span class="o">|</span> <span class="n">loop_or</span><span class="p">);</span>
			<span class="k">case</span> <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>:
				<span class="k">return</span> <span class="p">(</span><span class="mh">0x0093</span> <span class="o">|</span> <span class="n">loop_or</span><span class="p">);</span>
			<span class="nl">default:</span>
				<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">b43legacy_radio_init2050</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">backup</span><span class="p">[</span><span class="mi">21</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tmp2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">backup</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">14</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">15</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">17</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">18</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03EC</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">,</span> <span class="mh">0x00FF</span><span class="p">);</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03EC</span><span class="p">,</span> <span class="mh">0x3F3F</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">backup</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">);</span>
			<span class="n">backup</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">);</span>
			<span class="n">backup</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0814</span><span class="p">);</span>
			<span class="n">backup</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">);</span>
			<span class="n">backup</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						       <span class="n">B43legacy_PHY_G_CRS</span><span class="p">);</span>
			<span class="n">backup</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0814</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0814</span><span class="p">)</span>
					    <span class="o">|</span> <span class="mh">0x0003</span><span class="p">));</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0xFFFC</span><span class="p">));</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">B43legacy_PHY_G_CRS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FFF</span><span class="p">));</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0xFFFC</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* loopback gain enabled */</span>
				<span class="n">backup</span><span class="p">[</span><span class="mi">19</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x080F</span><span class="p">);</span>
				<span class="n">backup</span><span class="p">[</span><span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0810</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
					<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x080F</span><span class="p">,</span>
							    <span class="mh">0xC020</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x080F</span><span class="p">,</span>
							    <span class="mh">0x8020</span><span class="p">);</span>
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0810</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
					    <span class="n">b43legacy_get_812_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">||</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">boardflags_lo</span>
			    <span class="o">&amp;</span> <span class="n">B43legacy_BFL_EXTLNA</span><span class="p">))</span>
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span> <span class="mh">0x01B3</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span> <span class="mh">0x09B3</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_PHY_RADIO</span><span class="p">,</span>
			<span class="p">(</span><span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_PHY_RADIO</span><span class="p">)</span>
					  <span class="o">|</span> <span class="mh">0x8000</span><span class="p">));</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0035</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0035</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0035</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF7F</span><span class="p">));</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">11</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E6</span><span class="p">);</span>
	<span class="n">backup</span><span class="p">[</span><span class="mi">12</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">);</span>

	<span class="cm">/* Initialization */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E6</span><span class="p">,</span> <span class="mh">0x0122</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0003</span><span class="p">)</span>
					    <span class="o">&amp;</span> <span class="mh">0xFFBF</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0040</span><span class="p">);</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x2000</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">b43legacy_radio_calibrationvalue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_B</span><span class="p">)</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">,</span> <span class="mh">0x0026</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
				    <span class="n">b43legacy_get_812_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xBFAF</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002B</span><span class="p">,</span> <span class="mh">0x1403</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
				    <span class="n">b43legacy_get_812_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">LPD</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xBFA0</span><span class="p">);</span>
	<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">,</span>
				<span class="p">(</span><span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">)</span>
				<span class="o">|</span> <span class="mh">0x0004</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="mh">0x001F</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span>
					<span class="p">(</span><span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="mh">0xFFF0</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x0009</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="mh">0x0480</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="mh">0xC810</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x000D</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
					    <span class="n">b43legacy_get_812_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xAFB0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
					    <span class="n">b43legacy_get_812_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xEFB0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
					    <span class="n">b43legacy_get_812_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xFFF0</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">20</span><span class="p">);</span>
		<span class="n">tmp1</span> <span class="o">+=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002D</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
					    <span class="n">b43legacy_get_812_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					    <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xAFB0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">tmp1</span><span class="o">++</span><span class="p">;</span>
	<span class="n">tmp1</span> <span class="o">&gt;&gt;=</span> <span class="mi">9</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">,</span> <span class="p">(</span><span class="n">flip_4bit</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="o">|</span> <span class="mh">0x0020</span><span class="p">);</span>
		<span class="n">backup</span><span class="p">[</span><span class="mi">13</span><span class="p">]</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0078</span><span class="p">);</span>
		<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="mh">0x0D80</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="mh">0xC810</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x000D</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
						    <span class="n">b43legacy_get_812_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xAFB0</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
						    <span class="n">b43legacy_get_812_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xEFB0</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
						    <span class="n">b43legacy_get_812_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)));</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xFFF0</span><span class="p">);</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
			<span class="n">tmp2</span> <span class="o">+=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x002D</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="mh">0x0000</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span>
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span>
						    <span class="n">b43legacy_get_812_value</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
						    <span class="n">LPD</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)));</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xAFB0</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">tmp2</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tmp2</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tmp1</span> <span class="o">&lt;</span> <span class="n">tmp2</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Restore the registers */</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0051</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
	<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">15</span><span class="p">]);</span>
	<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x005A</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0059</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">17</span><span class="p">]);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">18</span><span class="p">]);</span>
	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03E6</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">11</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">analog</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0035</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">10</span><span class="p">]);</span>
	<span class="n">b43legacy_radio_selectchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0030</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x03EC</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_PHY_RADIO</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					  <span class="n">B43legacy_MMIO_PHY_RADIO</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FFF</span><span class="p">));</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0811</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0812</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0814</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0815</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_G_CRS</span><span class="p">,</span>
					    <span class="n">backup</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0802</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">9</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">rev</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x080F</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">19</span><span class="p">]);</span>
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0810</span><span class="p">,</span> <span class="n">backup</span><span class="p">[</span><span class="mi">20</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">15</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">backup</span><span class="p">[</span><span class="mi">13</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span>
<span class="n">u16</span> <span class="nf">freq_r3A_value</span><span class="p">(</span><span class="n">u16</span> <span class="n">frequency</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">5091</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mh">0x0040</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">5321</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mh">0x0000</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="mi">5806</span><span class="p">)</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mh">0x0080</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mh">0x0040</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_radio_set_tx_iq</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">data_high</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x90</span><span class="p">,</span> <span class="mh">0xD0</span> <span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">data_low</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>  <span class="o">=</span> <span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x0A</span> <span class="p">};</span>
	<span class="n">u16</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x001E</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">==</span> <span class="p">(</span><span class="n">data_high</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|</span> <span class="n">data_low</span><span class="p">[</span><span class="n">j</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0069</span><span class="p">,</span> <span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">j</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
						    <span class="mh">0x00C0</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">b43legacy_radio_selectchannel</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">channel</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">synthetic_pu_workaround</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_B</span>:
		<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_G</span>:
			<span class="n">channel</span> <span class="o">=</span> <span class="n">B43legacy_RADIO_DEFAULT_CHANNEL_BG</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="cm">/* TODO: Check if channel is valid - return -EINVAL if not */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">synthetic_pu_workaround</span><span class="p">)</span>
		<span class="n">b43legacy_synth_pu_workaround</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_CHANNEL</span><span class="p">,</span>
			  <span class="n">channel2freq_bg</span><span class="p">(</span><span class="n">channel</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="mi">14</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">country_code</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>   <span class="cm">/* JAPAN) */</span>
			<span class="n">b43legacy_shm_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
					      <span class="n">B43legacy_UCODEFLAGS_OFFSET</span><span class="p">,</span>
					      <span class="n">b43legacy_shm_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					      <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
					      <span class="n">B43legacy_UCODEFLAGS_OFFSET</span><span class="p">)</span>
					      <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">b43legacy_shm_write32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
					      <span class="n">B43legacy_UCODEFLAGS_OFFSET</span><span class="p">,</span>
					      <span class="n">b43legacy_shm_read32</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					      <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span>
					      <span class="n">B43legacy_UCODEFLAGS_OFFSET</span><span class="p">)</span>
					      <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">));</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">,</span>
				  <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">11</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">b43legacy_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">,</span>
				  <span class="n">b43legacy_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				  <span class="n">B43legacy_MMIO_CHANNEL_EXT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF7BF</span><span class="p">);</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="cm">/*XXX: Using the longer of 2 timeouts (8000 vs 2000 usecs). Specs states</span>
<span class="cm">	 *     that 2000 usecs might suffice. */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_radio_set_txantenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">&lt;&lt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFCFF</span><span class="p">;</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0022</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x03A8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFCFF</span><span class="p">;</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x03A8</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">val</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">b43legacy_shm_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0054</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFCFF</span><span class="p">;</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0054</span><span class="p">,</span> <span class="n">tmp</span> <span class="o">|</span> <span class="n">val</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/TX_Gain_Base_Band */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43legacy_get_txgain_base_band</span><span class="p">(</span><span class="n">u16</span> <span class="n">txpower</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;=</span> <span class="mi">54</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;=</span> <span class="mi">49</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;=</span> <span class="mi">44</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/TX_Gain_Radio_Frequency_Power_Amplifier */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43legacy_get_txgain_freq_power_amp</span><span class="p">(</span><span class="n">u16</span> <span class="n">txpower</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;=</span> <span class="mi">25</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* http://bcm-specs.sipsolutions.net/TX_Gain_Digital_Analog_Converter */</span>
<span class="k">static</span> <span class="n">u16</span> <span class="nf">b43legacy_get_txgain_dac</span><span class="p">(</span><span class="n">u16</span> <span class="n">txpower</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;=</span> <span class="mi">54</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">txpower</span> <span class="o">-</span> <span class="mi">53</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;=</span> <span class="mi">49</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">txpower</span> <span class="o">-</span> <span class="mi">42</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;=</span> <span class="mi">44</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">txpower</span> <span class="o">-</span> <span class="mi">37</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">txpower</span> <span class="o">-</span> <span class="mi">32</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;=</span> <span class="mi">25</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">txpower</span> <span class="o">-</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">txpower</span> <span class="o">-</span> <span class="mi">13</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;=</span> <span class="mi">12</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">txpower</span> <span class="o">-</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">txpower</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_radio_set_txpower_a</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">txpower</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pamp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">dac</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ilt</span><span class="p">;</span>

	<span class="n">txpower</span> <span class="o">=</span> <span class="n">clamp_val</span><span class="p">(</span><span class="n">txpower</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">63</span><span class="p">);</span>

	<span class="n">pamp</span> <span class="o">=</span> <span class="n">b43legacy_get_txgain_freq_power_amp</span><span class="p">(</span><span class="n">txpower</span><span class="p">);</span>
	<span class="n">pamp</span> <span class="o">&lt;&lt;=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">pamp</span> <span class="o">&amp;=</span> <span class="mh">0x00E0</span><span class="p">;</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0019</span><span class="p">,</span> <span class="n">pamp</span><span class="p">);</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">b43legacy_get_txgain_base_band</span><span class="p">(</span><span class="n">txpower</span><span class="p">);</span>
	<span class="n">base</span> <span class="o">&amp;=</span> <span class="mh">0x000F</span><span class="p">;</span>
	<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0017</span><span class="p">,</span> <span class="n">base</span> <span class="o">|</span> <span class="mh">0x0020</span><span class="p">);</span>

	<span class="n">ilt</span> <span class="o">=</span> <span class="n">b43legacy_ilt_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3001</span><span class="p">);</span>
	<span class="n">ilt</span> <span class="o">&amp;=</span> <span class="mh">0x0007</span><span class="p">;</span>

	<span class="n">dac</span> <span class="o">=</span> <span class="n">b43legacy_get_txgain_dac</span><span class="p">(</span><span class="n">txpower</span><span class="p">);</span>
	<span class="n">dac</span> <span class="o">&lt;&lt;=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="n">dac</span> <span class="o">|=</span> <span class="n">ilt</span><span class="p">;</span>

	<span class="n">b43legacy_ilt_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x3001</span><span class="p">,</span> <span class="n">dac</span><span class="p">);</span>

	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">txpwr_offset</span> <span class="o">=</span> <span class="n">txpower</span><span class="p">;</span>

	<span class="cm">/* TODO: FuncPlaceholder (Adjust BB loft cancel) */</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_radio_set_txpower_bg</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				    <span class="n">u16</span> <span class="n">baseband_attenuation</span><span class="p">,</span>
				    <span class="n">u16</span> <span class="n">radio_attenuation</span><span class="p">,</span>
				    <span class="n">u16</span> <span class="n">txpower</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">baseband_attenuation</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
		<span class="n">baseband_attenuation</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">bbatt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">radio_attenuation</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
		<span class="n">radio_attenuation</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">rfatt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txpower</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
		<span class="n">txpower</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">txctl1</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">bbatt</span> <span class="o">=</span> <span class="n">baseband_attenuation</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">rfatt</span> <span class="o">=</span> <span class="n">radio_attenuation</span><span class="p">;</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">txctl1</span> <span class="o">=</span> <span class="n">txpower</span><span class="p">;</span>

	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">baseband_attenuation</span> <span class="o">&gt;</span> <span class="mi">11</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">radio_attenuation</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">radio_attenuation</span> <span class="o">&gt;</span> <span class="mi">31</span><span class="p">);</span>
	<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">txpower</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">);</span>

	<span class="n">b43legacy_phy_set_baseband_attenuation</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">baseband_attenuation</span><span class="p">);</span>
	<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0043</span><span class="p">,</span> <span class="n">radio_attenuation</span><span class="p">);</span>
	<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0064</span><span class="p">,</span>
			      <span class="n">radio_attenuation</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span><span class="p">)</span>
		<span class="n">b43legacy_radio_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">,</span>
					<span class="p">(</span><span class="n">b43legacy_radio_read16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0052</span><span class="p">)</span>
					<span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x0070</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">txpower</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0070</span><span class="p">));</span>
	<span class="cm">/* FIXME: The spec is very weird and unclear here. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_G</span><span class="p">)</span>
		<span class="n">b43legacy_phy_lo_adjust</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">b43legacy_default_baseband_attenuation</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">==</span> <span class="mh">0x2050</span> <span class="o">&amp;&amp;</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">b43legacy_default_radio_attenuation</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">att</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mh">0x2053</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="n">att</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mh">0x2050</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">att</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_G</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_bcm_board_vendor</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="mh">0x421</span> <span class="o">&amp;&amp;</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">board_rev</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span>
					<span class="n">att</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_bcm_board_vendor</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="mh">0x416</span><span class="p">)</span>
					<span class="n">att</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">att</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_bcm_board_vendor</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="mh">0x421</span> <span class="o">&amp;&amp;</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">board_rev</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span>
					<span class="n">att</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">att</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_G</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">is_bcm_board_vendor</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="mh">0x421</span> <span class="o">&amp;&amp;</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">board_rev</span> <span class="o">&gt;=</span> <span class="mi">30</span><span class="p">)</span>
					<span class="n">att</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_bcm_board_vendor</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span>
					 <span class="mh">0x416</span><span class="p">)</span>
					<span class="n">att</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">chip_id</span> <span class="o">==</span> <span class="mh">0x4320</span><span class="p">)</span>
					<span class="n">att</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">att</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">att</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
			<span class="n">att</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">case</span> <span class="mi">5</span>:
			<span class="n">att</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="n">att</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">8</span>:
			<span class="n">att</span> <span class="o">=</span> <span class="mh">0x1A</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">9</span>:
		<span class="nl">default:</span>
			<span class="n">att</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_bcm_board_vendor</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">boardinfo</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="mh">0x421</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">board_rev</span> <span class="o">&lt;</span> <span class="mh">0x43</span><span class="p">)</span>
			<span class="n">att</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">sprom</span><span class="p">.</span><span class="n">board_rev</span> <span class="o">&lt;</span> <span class="mh">0x51</span><span class="p">)</span>
			<span class="n">att</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">att</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
		<span class="n">att</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">att</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">u16</span> <span class="nf">b43legacy_default_txctl1</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_ver</span> <span class="o">!=</span> <span class="mh">0x2050</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_rev</span> <span class="o">==</span> <span class="mi">8</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_radio_turn_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_on</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_B</span>:
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_G</span>:
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0x8000</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xCC00</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">gmode</span> <span class="o">?</span> <span class="mh">0x00C0</span> <span class="o">:</span> <span class="mh">0x0000</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_off_context</span><span class="p">.</span><span class="n">valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Restore the RFover values. */</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_RFOVER</span><span class="p">,</span>
					    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_off_context</span><span class="p">.</span><span class="n">rfover</span><span class="p">);</span>
			<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_RFOVERVAL</span><span class="p">,</span>
					    <span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_off_context</span><span class="p">.</span><span class="n">rfoverval</span><span class="p">);</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_off_context</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">phy</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">b43legacy_radio_selectchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">B43legacy_RADIO_DEFAULT_CHANNEL_BG</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">|=</span> <span class="n">b43legacy_radio_selectchannel</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">B43legacy_WARN_ON</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">B43legacy_BUG_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_radio_turn_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">force</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">B43legacy_PHYTYPE_G</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">revision</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">rfover</span><span class="p">,</span> <span class="n">rfoverval</span><span class="p">;</span>

		<span class="n">rfover</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_RFOVER</span><span class="p">);</span>
		<span class="n">rfoverval</span> <span class="o">=</span> <span class="n">b43legacy_phy_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_RFOVERVAL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">force</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_off_context</span><span class="p">.</span><span class="n">rfover</span> <span class="o">=</span> <span class="n">rfover</span><span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_off_context</span><span class="p">.</span><span class="n">rfoverval</span> <span class="o">=</span> <span class="n">rfoverval</span><span class="p">;</span>
			<span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_off_context</span><span class="p">.</span><span class="n">valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_RFOVER</span><span class="p">,</span> <span class="n">rfover</span> <span class="o">|</span> <span class="mh">0x008C</span><span class="p">);</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_PHY_RFOVERVAL</span><span class="p">,</span>
				    <span class="n">rfoverval</span> <span class="o">&amp;</span> <span class="mh">0xFF73</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">b43legacy_phy_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x0015</span><span class="p">,</span> <span class="mh">0xAA00</span><span class="p">);</span>
	<span class="n">phy</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">b43legacydbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">wl</span><span class="p">,</span> <span class="s">&quot;Radio initialized</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">b43legacy_radio_clear_tssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">b43legacy_wldev</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">b43legacy_phy</span> <span class="o">*</span><span class="n">phy</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">phy</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">phy</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_B</span>:
	<span class="k">case</span> <span class="n">B43legacy_PHYTYPE_G</span>:
		<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0058</span><span class="p">,</span>
				      <span class="mh">0x7F7F</span><span class="p">);</span>
		<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x005a</span><span class="p">,</span>
				      <span class="mh">0x7F7F</span><span class="p">);</span>
		<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0070</span><span class="p">,</span>
				      <span class="mh">0x7F7F</span><span class="p">);</span>
		<span class="n">b43legacy_shm_write16</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">B43legacy_SHM_SHARED</span><span class="p">,</span> <span class="mh">0x0072</span><span class="p">,</span>
				      <span class="mh">0x7F7F</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
