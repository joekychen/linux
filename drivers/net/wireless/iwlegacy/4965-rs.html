<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › iwlegacy › 4965-rs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>4965-rs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2005 - 2011 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> *  Intel Linux Wireless &lt;ilw@linux.intel.com&gt;</span>
<span class="cm"> * Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &quot;4965.h&quot;</span>

<span class="cp">#define IL4965_RS_NAME &quot;iwl-4965-rs&quot;</span>

<span class="cp">#define NUM_TRY_BEFORE_ANT_TOGGLE 1</span>
<span class="cp">#define IL_NUMBER_TRY      1</span>
<span class="cp">#define IL_HT_NUMBER_TRY   3</span>

<span class="cp">#define RATE_MAX_WINDOW		62	</span><span class="cm">/* # tx in history win */</span><span class="cp"></span>
<span class="cp">#define RATE_MIN_FAILURE_TH		6	</span><span class="cm">/* min failures to calc tpt */</span><span class="cp"></span>
<span class="cp">#define RATE_MIN_SUCCESS_TH		8	</span><span class="cm">/* min successes to calc tpt */</span><span class="cp"></span>

<span class="cm">/* max allowed rate miss before sync LQ cmd */</span>
<span class="cp">#define IL_MISSED_RATE_MAX		15</span>
<span class="cm">/* max time to accum history 2 seconds */</span>
<span class="cp">#define RATE_SCALE_FLUSH_INTVL   (3*HZ)</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">rs_ht_to_legacy</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">RATE_6M_IDX</span><span class="p">,</span> <span class="n">RATE_6M_IDX</span><span class="p">,</span>
	<span class="n">RATE_6M_IDX</span><span class="p">,</span> <span class="n">RATE_6M_IDX</span><span class="p">,</span>
	<span class="n">RATE_6M_IDX</span><span class="p">,</span>
	<span class="n">RATE_6M_IDX</span><span class="p">,</span> <span class="n">RATE_9M_IDX</span><span class="p">,</span>
	<span class="n">RATE_12M_IDX</span><span class="p">,</span> <span class="n">RATE_18M_IDX</span><span class="p">,</span>
	<span class="n">RATE_24M_IDX</span><span class="p">,</span> <span class="n">RATE_36M_IDX</span><span class="p">,</span>
	<span class="n">RATE_48M_IDX</span><span class="p">,</span> <span class="n">RATE_54M_IDX</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ant_toggle_lookup</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/*ANT_NONE -&gt; */</span> <span class="n">ANT_NONE</span><span class="p">,</span>
	<span class="cm">/*ANT_A    -&gt; */</span> <span class="n">ANT_B</span><span class="p">,</span>
	<span class="cm">/*ANT_B    -&gt; */</span> <span class="n">ANT_C</span><span class="p">,</span>
	<span class="cm">/*ANT_AB   -&gt; */</span> <span class="n">ANT_BC</span><span class="p">,</span>
	<span class="cm">/*ANT_C    -&gt; */</span> <span class="n">ANT_A</span><span class="p">,</span>
	<span class="cm">/*ANT_AC   -&gt; */</span> <span class="n">ANT_AB</span><span class="p">,</span>
	<span class="cm">/*ANT_BC   -&gt; */</span> <span class="n">ANT_AC</span><span class="p">,</span>
	<span class="cm">/*ANT_ABC  -&gt; */</span> <span class="n">ANT_ABC</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define IL_DECLARE_RATE_INFO(r, s, ip, in, rp, rn, pp, np)    \</span>
<span class="cp">	[RATE_##r##M_IDX] = { RATE_##r##M_PLCP,      \</span>
<span class="cp">				    RATE_SISO_##s##M_PLCP, \</span>
<span class="cp">				    RATE_MIMO2_##s##M_PLCP,\</span>
<span class="cp">				    RATE_##r##M_IEEE,      \</span>
<span class="cp">				    RATE_##ip##M_IDX,    \</span>
<span class="cp">				    RATE_##in##M_IDX,    \</span>
<span class="cp">				    RATE_##rp##M_IDX,    \</span>
<span class="cp">				    RATE_##rn##M_IDX,    \</span>
<span class="cp">				    RATE_##pp##M_IDX,    \</span>
<span class="cp">				    RATE_##np##M_IDX }</span>

<span class="cm">/*</span>
<span class="cm"> * Parameter order:</span>
<span class="cm"> *   rate, ht rate, prev rate, next rate, prev tgg rate, next tgg rate</span>
<span class="cm"> *</span>
<span class="cm"> * If there isn&#39;t a valid next or previous rate then INV is used which</span>
<span class="cm"> * maps to RATE_INVALID</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">il_rate_info</span> <span class="n">il_rates</span><span class="p">[</span><span class="n">RATE_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IL_DECLARE_RATE_INFO</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">INV</span><span class="p">,</span> <span class="n">INV</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">INV</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">INV</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>	<span class="cm">/*  1mbps */</span>
	<span class="n">IL_DECLARE_RATE_INFO</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">INV</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span>		<span class="cm">/*  2mbps */</span>
	<span class="n">IL_DECLARE_RATE_INFO</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="n">INV</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>	<span class="cm">/*5.5mbps */</span>
	<span class="n">IL_DECLARE_RATE_INFO</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span> <span class="n">INV</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>	<span class="cm">/* 11mbps */</span>
	<span class="n">IL_DECLARE_RATE_INFO</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>		<span class="cm">/*  6mbps */</span>
	<span class="n">IL_DECLARE_RATE_INFO</span><span class="p">(</span><span class="mi">9</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">11</span><span class="p">),</span>	<span class="cm">/*  9mbps */</span>
	<span class="n">IL_DECLARE_RATE_INFO</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">18</span><span class="p">),</span>	<span class="cm">/* 12mbps */</span>
	<span class="n">IL_DECLARE_RATE_INFO</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">24</span><span class="p">),</span>	<span class="cm">/* 18mbps */</span>
	<span class="n">IL_DECLARE_RATE_INFO</span><span class="p">(</span><span class="mi">24</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">36</span><span class="p">),</span>	<span class="cm">/* 24mbps */</span>
	<span class="n">IL_DECLARE_RATE_INFO</span><span class="p">(</span><span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">48</span><span class="p">),</span>	<span class="cm">/* 36mbps */</span>
	<span class="n">IL_DECLARE_RATE_INFO</span><span class="p">(</span><span class="mi">48</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">54</span><span class="p">),</span>	<span class="cm">/* 48mbps */</span>
	<span class="n">IL_DECLARE_RATE_INFO</span><span class="p">(</span><span class="mi">54</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">INV</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">INV</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">INV</span><span class="p">),</span><span class="cm">/* 54mbps */</span>
	<span class="n">IL_DECLARE_RATE_INFO</span><span class="p">(</span><span class="mi">60</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">INV</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">INV</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="n">INV</span><span class="p">),</span><span class="cm">/* 60mbps */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_hwrate_to_plcp_idx</span><span class="p">(</span><span class="n">u32</span> <span class="n">rate_n_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* HT rate format */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_HT_MSK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">RATE_MIMO2_6M_PLCP</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">RATE_MIMO2_6M_PLCP</span><span class="p">;</span>

		<span class="n">idx</span> <span class="o">+=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>
		<span class="cm">/* skip 9M not supported in ht */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">RATE_9M_IDX</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">IL_FIRST_OFDM_RATE</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">IL_LAST_OFDM_RATE</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>

		<span class="cm">/* legacy rate format, search for match in table */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">il_rates</span><span class="p">);</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">il_rates</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">plcp</span> <span class="o">==</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">il4965_rs_rate_scale_perform</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">il4965_rs_fill_link_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rate_n_flags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">il4965_rs_stay_in_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span>
				    <span class="n">bool</span> <span class="n">force_search</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_MAC80211_DEBUGFS</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">il4965_rs_dbgfs_set_mcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span>
				    <span class="n">u32</span> <span class="o">*</span><span class="n">rate_n_flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_dbgfs_set_mcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">rate_n_flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/**</span>
<span class="cm"> * The following tables contain the expected throughput metrics for all rates</span>
<span class="cm"> *</span>
<span class="cm"> *	1, 2, 5.5, 11, 6, 9, 12, 18, 24, 36, 48, 54, 60 MBits</span>
<span class="cm"> *</span>
<span class="cm"> * where invalid entries are zeros.</span>
<span class="cm"> *</span>
<span class="cm"> * CCK rates are only valid in legacy table and will only be used in G</span>
<span class="cm"> * (2.4 GHz) band.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">s32</span> <span class="n">expected_tpt_legacy</span><span class="p">[</span><span class="n">RATE_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">7</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">s32</span> <span class="n">expected_tpt_siso20MHz</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">RATE_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">183</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">202</span><span class="p">},</span>	<span class="cm">/* Norm */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">167</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">202</span><span class="p">,</span> <span class="mi">210</span><span class="p">},</span>	<span class="cm">/* SGI */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">319</span><span class="p">,</span> <span class="mi">351</span><span class="p">,</span> <span class="mi">381</span><span class="p">},</span>	<span class="cm">/* AGG */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">53</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">275</span><span class="p">,</span> <span class="mi">348</span><span class="p">,</span> <span class="mi">381</span><span class="p">,</span> <span class="mi">413</span><span class="p">},</span>	<span class="cm">/* AGG+SGI */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">s32</span> <span class="n">expected_tpt_siso40MHz</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">RATE_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">257</span><span class="p">},</span>	<span class="cm">/* Norm */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">169</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">257</span><span class="p">,</span> <span class="mi">264</span><span class="p">},</span>	<span class="cm">/* SGI */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">259</span><span class="p">,</span> <span class="mi">328</span><span class="p">,</span> <span class="mi">451</span><span class="p">,</span> <span class="mi">553</span><span class="p">,</span> <span class="mi">598</span><span class="p">,</span> <span class="mi">640</span><span class="p">},</span>	<span class="cm">/* AGG */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">282</span><span class="p">,</span> <span class="mi">357</span><span class="p">,</span> <span class="mi">487</span><span class="p">,</span> <span class="mi">593</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">683</span><span class="p">},</span>	<span class="cm">/* AGG+SGI */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">s32</span> <span class="n">expected_tpt_mimo2_20MHz</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">RATE_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">250</span><span class="p">},</span>	<span class="cm">/* Norm */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="mi">221</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">256</span><span class="p">},</span>	<span class="cm">/* SGI */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">317</span><span class="p">,</span> <span class="mi">436</span><span class="p">,</span> <span class="mi">534</span><span class="p">,</span> <span class="mi">578</span><span class="p">,</span> <span class="mi">619</span><span class="p">},</span>	<span class="cm">/* AGG */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">273</span><span class="p">,</span> <span class="mi">344</span><span class="p">,</span> <span class="mi">470</span><span class="p">,</span> <span class="mi">573</span><span class="p">,</span> <span class="mi">619</span><span class="p">,</span> <span class="mi">660</span><span class="p">},</span>	<span class="cm">/* AGG+SGI */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">s32</span> <span class="n">expected_tpt_mimo2_40MHz</span><span class="p">[</span><span class="mi">4</span><span class="p">][</span><span class="n">RATE_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="mi">264</span><span class="p">,</span> <span class="mi">279</span><span class="p">,</span> <span class="mi">285</span><span class="p">,</span> <span class="mi">289</span><span class="p">},</span>	<span class="cm">/* Norm */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">270</span><span class="p">,</span> <span class="mi">284</span><span class="p">,</span> <span class="mi">289</span><span class="p">,</span> <span class="mi">293</span><span class="p">},</span>	<span class="cm">/* SGI */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">327</span><span class="p">,</span> <span class="mi">446</span><span class="p">,</span> <span class="mi">545</span><span class="p">,</span> <span class="mi">708</span><span class="p">,</span> <span class="mi">828</span><span class="p">,</span> <span class="mi">878</span><span class="p">,</span> <span class="mi">922</span><span class="p">},</span>	<span class="cm">/* AGG */</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">355</span><span class="p">,</span> <span class="mi">481</span><span class="p">,</span> <span class="mi">584</span><span class="p">,</span> <span class="mi">752</span><span class="p">,</span> <span class="mi">872</span><span class="p">,</span> <span class="mi">922</span><span class="p">,</span> <span class="mi">966</span><span class="p">},</span>	<span class="cm">/* AGG+SGI */</span>
<span class="p">};</span>

<span class="cm">/* mbps, mcs */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">il_rate_mcs_info</span> <span class="n">il_rate_mcs</span><span class="p">[</span><span class="n">RATE_COUNT</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;1&quot;</span><span class="p">,</span> <span class="s">&quot;BPSK DSSS&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;2&quot;</span><span class="p">,</span> <span class="s">&quot;QPSK DSSS&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;5.5&quot;</span><span class="p">,</span> <span class="s">&quot;BPSK CCK&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;11&quot;</span><span class="p">,</span> <span class="s">&quot;QPSK CCK&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;6&quot;</span><span class="p">,</span> <span class="s">&quot;BPSK 1/2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;9&quot;</span><span class="p">,</span> <span class="s">&quot;BPSK 1/2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;12&quot;</span><span class="p">,</span> <span class="s">&quot;QPSK 1/2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;18&quot;</span><span class="p">,</span> <span class="s">&quot;QPSK 3/4&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;24&quot;</span><span class="p">,</span> <span class="s">&quot;16QAM 1/2&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;36&quot;</span><span class="p">,</span> <span class="s">&quot;16QAM 3/4&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;48&quot;</span><span class="p">,</span> <span class="s">&quot;64QAM 2/3&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;54&quot;</span><span class="p">,</span> <span class="s">&quot;64QAM 3/4&quot;</span><span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;60&quot;</span><span class="p">,</span> <span class="s">&quot;64QAM 5/6&quot;</span><span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define MCS_IDX_PER_STREAM	(8)</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span>
<span class="nf">il4965_rs_extract_rate</span><span class="p">(</span><span class="n">u32</span> <span class="n">rate_n_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_rate_scale_clear_win</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_rate_scale_data</span> <span class="o">*</span><span class="n">win</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">stamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span>
<span class="nf">il4965_rs_is_valid_ant</span><span class="p">(</span><span class="n">u8</span> <span class="n">valid_antenna</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ant_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">ant_type</span> <span class="o">&amp;</span> <span class="n">valid_antenna</span><span class="p">)</span> <span class="o">==</span> <span class="n">ant_type</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	removes the old data from the stats. All data that is older than</span>
<span class="cm"> *	TID_MAX_TIME_DIFF, will be deleted.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_tl_rm_old_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_traffic_load</span> <span class="o">*</span><span class="n">tl</span><span class="p">,</span> <span class="n">u32</span> <span class="n">curr_time</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* The oldest age we want to keep */</span>
	<span class="n">u32</span> <span class="n">oldest_time</span> <span class="o">=</span> <span class="n">curr_time</span> <span class="o">-</span> <span class="n">TID_MAX_TIME_DIFF</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">tl</span><span class="o">-&gt;</span><span class="n">queue_count</span> <span class="o">&amp;&amp;</span> <span class="n">tl</span><span class="o">-&gt;</span><span class="n">time_stamp</span> <span class="o">&lt;</span> <span class="n">oldest_time</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tl</span><span class="o">-&gt;</span><span class="n">total</span> <span class="o">-=</span> <span class="n">tl</span><span class="o">-&gt;</span><span class="n">packet_count</span><span class="p">[</span><span class="n">tl</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">];</span>
		<span class="n">tl</span><span class="o">-&gt;</span><span class="n">packet_count</span><span class="p">[</span><span class="n">tl</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tl</span><span class="o">-&gt;</span><span class="n">time_stamp</span> <span class="o">+=</span> <span class="n">TID_QUEUE_CELL_SPACING</span><span class="p">;</span>
		<span class="n">tl</span><span class="o">-&gt;</span><span class="n">queue_count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">tl</span><span class="o">-&gt;</span><span class="n">head</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tl</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">&gt;=</span> <span class="n">TID_QUEUE_MAX_SIZE</span><span class="p">)</span>
			<span class="n">tl</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	increment traffic load value for tid and also remove</span>
<span class="cm"> *	any old values if passed the certain time period</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">il4965_rs_tl_add_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">curr_time</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">time_diff</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_traffic_load</span> <span class="o">*</span><span class="n">tl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">qc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">return</span> <span class="n">MAX_TID_COUNT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tid</span> <span class="o">&gt;=</span> <span class="n">TID_MAX_LOAD_COUNT</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">MAX_TID_COUNT</span><span class="p">;</span>

	<span class="n">tl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lq_data</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

	<span class="n">curr_time</span> <span class="o">-=</span> <span class="n">curr_time</span> <span class="o">%</span> <span class="n">TID_ROUND_VALUE</span><span class="p">;</span>

	<span class="cm">/* Happens only for the first packet. Initialize the data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tl</span><span class="o">-&gt;</span><span class="n">queue_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tl</span><span class="o">-&gt;</span><span class="n">total</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tl</span><span class="o">-&gt;</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="n">curr_time</span><span class="p">;</span>
		<span class="n">tl</span><span class="o">-&gt;</span><span class="n">queue_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">tl</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tl</span><span class="o">-&gt;</span><span class="n">packet_count</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">MAX_TID_COUNT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">time_diff</span> <span class="o">=</span> <span class="n">TIME_WRAP_AROUND</span><span class="p">(</span><span class="n">tl</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">,</span> <span class="n">curr_time</span><span class="p">);</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">time_diff</span> <span class="o">/</span> <span class="n">TID_QUEUE_CELL_SPACING</span><span class="p">;</span>

	<span class="cm">/* The history is too long: remove data that is older than */</span>
	<span class="cm">/* TID_MAX_TIME_DIFF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">TID_QUEUE_MAX_SIZE</span><span class="p">)</span>
		<span class="n">il4965_rs_tl_rm_old_stats</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">curr_time</span><span class="p">);</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">tl</span><span class="o">-&gt;</span><span class="n">head</span> <span class="o">+</span> <span class="n">idx</span><span class="p">)</span> <span class="o">%</span> <span class="n">TID_QUEUE_MAX_SIZE</span><span class="p">;</span>
	<span class="n">tl</span><span class="o">-&gt;</span><span class="n">packet_count</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">tl</span><span class="o">-&gt;</span><span class="n">packet_count</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tl</span><span class="o">-&gt;</span><span class="n">total</span> <span class="o">=</span> <span class="n">tl</span><span class="o">-&gt;</span><span class="n">total</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tl</span><span class="o">-&gt;</span><span class="n">queue_count</span><span class="p">)</span>
		<span class="n">tl</span><span class="o">-&gt;</span><span class="n">queue_count</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">tid</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm">	get the traffic load value for tid</span>
<span class="cm">*/</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">il4965_rs_tl_get_load</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">curr_time</span> <span class="o">=</span> <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">time_diff</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_traffic_load</span> <span class="o">*</span><span class="n">tl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&gt;=</span> <span class="n">TID_MAX_LOAD_COUNT</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_data</span><span class="o">-&gt;</span><span class="n">load</span><span class="p">[</span><span class="n">tid</span><span class="p">]);</span>

	<span class="n">curr_time</span> <span class="o">-=</span> <span class="n">curr_time</span> <span class="o">%</span> <span class="n">TID_ROUND_VALUE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">tl</span><span class="o">-&gt;</span><span class="n">queue_count</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">time_diff</span> <span class="o">=</span> <span class="n">TIME_WRAP_AROUND</span><span class="p">(</span><span class="n">tl</span><span class="o">-&gt;</span><span class="n">time_stamp</span><span class="p">,</span> <span class="n">curr_time</span><span class="p">);</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">time_diff</span> <span class="o">/</span> <span class="n">TID_QUEUE_CELL_SPACING</span><span class="p">;</span>

	<span class="cm">/* The history is too long: remove data that is older than */</span>
	<span class="cm">/* TID_MAX_TIME_DIFF */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">TID_QUEUE_MAX_SIZE</span><span class="p">)</span>
		<span class="n">il4965_rs_tl_rm_old_stats</span><span class="p">(</span><span class="n">tl</span><span class="p">,</span> <span class="n">curr_time</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tl</span><span class="o">-&gt;</span><span class="n">total</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_rs_tl_turn_on_agg_for_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_data</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">load</span><span class="p">;</span>

	<span class="n">load</span> <span class="o">=</span> <span class="n">il4965_rs_tl_get_load</span><span class="p">(</span><span class="n">lq_data</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">load</span> <span class="o">&gt;</span> <span class="n">IL_AGG_LOAD_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;Starting Tx agg: STA: %pM tid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_start_tx_ba_session</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="mi">5000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * driver and mac80211 is out of sync</span>
<span class="cm">			 * this might be cause by reloading firmware</span>
<span class="cm">			 * stop the tx ba session here</span>
<span class="cm">			 */</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Fail start Tx agg on tid: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
			<span class="n">ieee80211_stop_tx_ba_session</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;Aggregation not enabled for tid %d because load = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">tid</span><span class="p">,</span> <span class="n">load</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_tl_turn_on_agg</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_data</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">&lt;</span> <span class="n">TID_MAX_LOAD_COUNT</span><span class="p">)</span>
		<span class="n">il4965_rs_tl_turn_on_agg_for_tid</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">lq_data</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;tid exceeds max load count: %d/%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span>
		       <span class="n">TID_MAX_LOAD_COUNT</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">il4965_get_il4965_num_of_ant_from_rate</span><span class="p">(</span><span class="n">u32</span> <span class="n">rate_n_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!!</span><span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_ANT_A_MSK</span><span class="p">)</span> <span class="o">+</span>
	    <span class="o">!!</span><span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_ANT_B_MSK</span><span class="p">)</span> <span class="o">+</span>
	    <span class="o">!!</span><span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_ANT_C_MSK</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Static function to get the expected throughput from an il_scale_tbl_info</span>
<span class="cm"> * that wraps a NULL pointer check</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s32</span>
<span class="nf">il4965_get_expected_tpt</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rs_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span><span class="p">[</span><span class="n">rs_idx</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_rs_collect_tx_data - Update the success/failure sliding win</span>
<span class="cm"> *</span>
<span class="cm"> * We keep a sliding win of the last 62 packets transmitted</span>
<span class="cm"> * at this rate.  win-&gt;data contains the bitmask of successful</span>
<span class="cm"> * packets.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_rs_collect_tx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scale_idx</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">attempts</span><span class="p">,</span> <span class="kt">int</span> <span class="n">successes</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rate_scale_data</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u64</span> <span class="n">mask</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u64</span><span class="p">)</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">RATE_MAX_WINDOW</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">s32</span> <span class="n">fail_count</span><span class="p">,</span> <span class="n">tpt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scale_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">scale_idx</span> <span class="o">&gt;=</span> <span class="n">RATE_COUNT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Select win for current tx bit rate */</span>
	<span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">scale_idx</span><span class="p">]);</span>

	<span class="cm">/* Get expected throughput */</span>
	<span class="n">tpt</span> <span class="o">=</span> <span class="n">il4965_get_expected_tpt</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="n">scale_idx</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Keep track of only the latest 62 tx frame attempts in this rate&#39;s</span>
<span class="cm">	 * history win; anything older isn&#39;t really relevant any more.</span>
<span class="cm">	 * If we have filled up the sliding win, drop the oldest attempt;</span>
<span class="cm">	 * if the oldest attempt (highest bit in bitmap) shows &quot;success&quot;,</span>
<span class="cm">	 * subtract &quot;1&quot; from the success counter (this is the main reason</span>
<span class="cm">	 * we keep these bitmaps!).</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">attempts</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;=</span> <span class="n">RATE_MAX_WINDOW</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* remove earliest */</span>
			<span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">=</span> <span class="n">RATE_MAX_WINDOW</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">win</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
				<span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Increment frames-attempted counter */</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Shift bitmap by one frame to throw away oldest history */</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* Mark the most recent #successes attempts as successful */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">successes</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span><span class="o">++</span><span class="p">;</span>
			<span class="n">win</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">successes</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">attempts</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate current success ratio, avoid divide-by-0! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">=</span>
		    <span class="mi">128</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span><span class="p">)</span> <span class="o">/</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>

	<span class="n">fail_count</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span><span class="p">;</span>

	<span class="cm">/* Calculate average throughput, if we have enough history. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fail_count</span> <span class="o">&gt;=</span> <span class="n">RATE_MIN_FAILURE_TH</span> <span class="o">||</span>
	    <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span> <span class="o">&gt;=</span> <span class="n">RATE_MIN_SUCCESS_TH</span><span class="p">)</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span> <span class="o">=</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">*</span> <span class="n">tpt</span> <span class="o">+</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="mi">128</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>

	<span class="cm">/* Tag this win as having been updated */</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Fill uCode API rate_n_flags field, based on &quot;search&quot; or &quot;active&quot; table.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u32</span>
<span class="nf">il4965_rate_n_flags_from_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">use_green</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rate_n_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">il_rates</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">plcp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">IL_FIRST_CCK_RATE</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span> <span class="o">&lt;=</span> <span class="n">IL_LAST_CCK_RATE</span><span class="p">)</span>
			<span class="n">rate_n_flags</span> <span class="o">|=</span> <span class="n">RATE_MCS_CCK_MSK</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_Ht</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;</span> <span class="n">IL_LAST_OFDM_RATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Invalid HT rate idx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">IL_LAST_OFDM_RATE</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">RATE_MCS_HT_MSK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_siso</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span>
			<span class="n">rate_n_flags</span> <span class="o">|=</span> <span class="n">il_rates</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">plcp_siso</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">rate_n_flags</span> <span class="o">|=</span> <span class="n">il_rates</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">plcp_mimo2</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Invalid tbl-&gt;lq_type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rate_n_flags</span> <span class="o">|=</span>
	    <span class="p">((</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">&lt;&lt;</span> <span class="n">RATE_MCS_ANT_POS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_ANT_ABC_MSK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_Ht</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_dup</span><span class="p">)</span>
				<span class="n">rate_n_flags</span> <span class="o">|=</span> <span class="n">RATE_MCS_DUP_MSK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">rate_n_flags</span> <span class="o">|=</span> <span class="n">RATE_MCS_HT40_MSK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span><span class="p">)</span>
			<span class="n">rate_n_flags</span> <span class="o">|=</span> <span class="n">RATE_MCS_SGI_MSK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">use_green</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rate_n_flags</span> <span class="o">|=</span> <span class="n">RATE_MCS_GF_MSK</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_siso</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rate_n_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RATE_MCS_SGI_MSK</span><span class="p">;</span>
				<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;GF was set with SGI:SISO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">rate_n_flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Interpret uCode API&#39;s rate_n_flags format,</span>
<span class="cm"> * fill &quot;search&quot; or &quot;active&quot; tx mode table.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_rs_get_tbl_info_from_mcs</span><span class="p">(</span><span class="k">const</span> <span class="n">u32</span> <span class="n">rate_n_flags</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">rate_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">ant_msk</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_ANT_ABC_MSK</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">il4965_num_of_ant</span> <span class="o">=</span>
	    <span class="n">il4965_get_il4965_num_of_ant_from_rate</span><span class="p">(</span><span class="n">rate_n_flags</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">mcs</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">tbl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_scale_tbl_info</span><span class="p">));</span>
	<span class="o">*</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="n">il4965_hwrate_to_plcp_idx</span><span class="p">(</span><span class="n">rate_n_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">rate_idx</span> <span class="o">==</span> <span class="n">RATE_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">rate_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* default legacy setup */</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_dup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">=</span> <span class="p">(</span><span class="n">ant_msk</span> <span class="o">&gt;&gt;</span> <span class="n">RATE_MCS_ANT_POS</span><span class="p">);</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">=</span> <span class="n">LQ_NONE</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_search</span> <span class="o">=</span> <span class="n">IL_MAX_SEARCH</span><span class="p">;</span>

	<span class="cm">/* legacy rate format */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_HT_MSK</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">il4965_num_of_ant</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
				<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">=</span> <span class="n">LQ_A</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">=</span> <span class="n">LQ_G</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* HT rate format */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_SGI_MSK</span><span class="p">)</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_HT40_MSK</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_DUP_MSK</span><span class="p">))</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_DUP_MSK</span><span class="p">)</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_dup</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">mcs</span> <span class="o">=</span> <span class="n">il4965_rs_extract_rate</span><span class="p">(</span><span class="n">rate_n_flags</span><span class="p">);</span>

		<span class="cm">/* SISO */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mcs</span> <span class="o">&lt;=</span> <span class="n">RATE_SISO_60M_PLCP</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">il4965_num_of_ant</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">=</span> <span class="n">LQ_SISO</span><span class="p">;</span>	<span class="cm">/*else NONE */</span>
			<span class="cm">/* MIMO2 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">il4965_num_of_ant</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">=</span> <span class="n">LQ_MIMO2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* switch to another antenna/antennas and return 1 */</span>
<span class="cm">/* if no other valid antenna found, return 0 */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_rs_toggle_antenna</span><span class="p">(</span><span class="n">u32</span> <span class="n">valid_ant</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">rate_n_flags</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">new_ant_type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">||</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">&gt;</span> <span class="n">ANT_ABC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il4965_rs_is_valid_ant</span><span class="p">(</span><span class="n">valid_ant</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">new_ant_type</span> <span class="o">=</span> <span class="n">ant_toggle_lookup</span><span class="p">[</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span><span class="p">];</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">new_ant_type</span> <span class="o">!=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="n">il4965_rs_is_valid_ant</span><span class="p">(</span><span class="n">valid_ant</span><span class="p">,</span> <span class="n">new_ant_type</span><span class="p">))</span>
		<span class="n">new_ant_type</span> <span class="o">=</span> <span class="n">ant_toggle_lookup</span><span class="p">[</span><span class="n">new_ant_type</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_ant_type</span> <span class="o">==</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">=</span> <span class="n">new_ant_type</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rate_n_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RATE_MCS_ANT_ABC_MSK</span><span class="p">;</span>
	<span class="o">*</span><span class="n">rate_n_flags</span> <span class="o">|=</span> <span class="n">new_ant_type</span> <span class="o">&lt;&lt;</span> <span class="n">RATE_MCS_ANT_POS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Green-field mode is valid if the station supports it and</span>
<span class="cm"> * there are no non-GF stations present in the BSS.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">il4965_rs_use_green</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_GRN_FLD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	       <span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">non_gf_sta_present</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_rs_get_supported_rates - get the available rates</span>
<span class="cm"> *</span>
<span class="cm"> * if management frame or broadcast frame only return</span>
<span class="cm"> * basic available rates.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u16</span>
<span class="nf">il4965_rs_get_supported_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">il_table_type</span> <span class="n">rate_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">rate_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_legacy_rate</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_siso</span><span class="p">(</span><span class="n">rate_type</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_siso_rate</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_mimo2_rate</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span>
<span class="nf">il4965_rs_get_adjacent_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rate_mask</span><span class="p">,</span>
			    <span class="kt">int</span> <span class="n">rate_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">high</span> <span class="o">=</span> <span class="n">RATE_INVALID</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">low</span> <span class="o">=</span> <span class="n">RATE_INVALID</span><span class="p">;</span>

	<span class="cm">/* 802.11A or ht walks to the next literal adjacent rate in</span>
<span class="cm">	 * the rate table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_a_band</span><span class="p">(</span><span class="n">rate_type</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">rate_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

		<span class="cm">/* Find the previous rate that is in the rate mask */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">low</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Find the next rate that is in the rate mask */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">high</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">low</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">low</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">low</span> <span class="o">=</span> <span class="n">il_rates</span><span class="p">[</span><span class="n">low</span><span class="p">].</span><span class="n">prev_rs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">==</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">low</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Skipping masked lower rate: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">low</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">high</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">high</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">high</span> <span class="o">=</span> <span class="n">il_rates</span><span class="p">[</span><span class="n">high</span><span class="p">].</span><span class="n">next_rs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">==</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">high</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Skipping masked higher rate: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">il4965_rs_get_lower_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="n">u8</span> <span class="n">scale_idx</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">ht_possible</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">low</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rate_mask</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">high_low</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">switch_to_legacy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">is_green</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_green</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">;</span>

	<span class="cm">/* check if we need to switch from HT to legacy rates.</span>
<span class="cm">	 * assumption is that mandatory rates (1Mbps or 6Mbps)</span>
<span class="cm">	 * are always supported (spec demand) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">ht_possible</span> <span class="o">||</span> <span class="o">!</span><span class="n">scale_idx</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">switch_to_legacy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">scale_idx</span> <span class="o">=</span> <span class="n">rs_ht_to_legacy</span><span class="p">[</span><span class="n">scale_idx</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">=</span> <span class="n">LQ_A</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">=</span> <span class="n">LQ_G</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">il4965_num_of_ant</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">=</span>
			    <span class="n">il4965_first_antenna</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">);</span>

		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_search</span> <span class="o">=</span> <span class="n">IL_MAX_SEARCH</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rate_mask</span> <span class="o">=</span> <span class="n">il4965_rs_get_supported_rates</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">);</span>

	<span class="cm">/* Mask with station rate restriction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* supp_rates has no CCK bits in A mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">rate_mask</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span>
				   <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span> <span class="o">&lt;&lt;</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">rate_mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If we switched from HT to legacy, check current rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">switch_to_legacy</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">scale_idx</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">low</span> <span class="o">=</span> <span class="n">scale_idx</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">high_low</span> <span class="o">=</span>
	    <span class="n">il4965_rs_get_adjacent_rate</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">,</span> <span class="n">scale_idx</span><span class="p">,</span> <span class="n">rate_mask</span><span class="p">,</span>
					<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">);</span>
	<span class="n">low</span> <span class="o">=</span> <span class="n">high_low</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">==</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
		<span class="n">low</span> <span class="o">=</span> <span class="n">scale_idx</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">il4965_rate_n_flags_from_tbl</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">is_green</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Simple function to compare two rate scale table types</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">bool</span>
<span class="nf">il4965_table_type_matches</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">a</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">&amp;&amp;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">&amp;&amp;</span>
		<span class="n">a</span><span class="o">-&gt;</span><span class="n">is_SGI</span> <span class="o">==</span> <span class="n">b</span><span class="o">-&gt;</span><span class="n">is_SGI</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * mac80211 sends us Tx status</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_tx_status</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il_r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">il_sta</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">legacy_success</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retries</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rs_idx</span><span class="p">,</span> <span class="n">mac_idx</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span> <span class="o">=</span> <span class="n">il_sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_link_quality_cmd</span> <span class="o">*</span><span class="n">table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">il_r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">mac80211_rate_control_flags</span> <span class="n">mac_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tx_rate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="n">tbl_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">curr_tbl</span><span class="p">,</span> <span class="o">*</span><span class="n">other_tbl</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_tbl</span><span class="p">;</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;get frame ack response, update rate scale win</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Treat uninitialized rate scaling data same as non-existing. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lq_sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Station rate scaling not created yet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Rate scaling not initialized yet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* This packet was aggregated but doesn&#39;t carry status info */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_STAT_AMPDU</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Ignore this Tx frame response if its initial rate doesn&#39;t match</span>
<span class="cm">	 * that of latest Link Quality command.  There may be stragglers</span>
<span class="cm">	 * from a previous Link Quality command, but we&#39;re no longer interested</span>
<span class="cm">	 * in those; they&#39;re either from the &quot;active&quot; mode while we&#39;re trying</span>
<span class="cm">	 * to check &quot;search&quot; mode, or a prior &quot;search&quot; mode after we&#39;ve moved</span>
<span class="cm">	 * to a new &quot;search&quot; mode (which might become the new &quot;active&quot; mode).</span>
<span class="cm">	 */</span>
	<span class="n">table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">;</span>
	<span class="n">tx_rate</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">rs_table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rate_n_flags</span><span class="p">);</span>
	<span class="n">il4965_rs_get_tbl_info_from_mcs</span><span class="p">(</span><span class="n">tx_rate</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tbl_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">rs_idx</span> <span class="o">-=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>
	<span class="n">mac_flags</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
	<span class="n">mac_idx</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>
	<span class="cm">/* For HT packets, map MCS to PLCP */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mac_idx</span> <span class="o">&amp;=</span> <span class="n">RATE_MCS_CODE_MSK</span><span class="p">;</span>	<span class="cm">/* Remove # of streams */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_idx</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">RATE_9M_IDX</span> <span class="o">-</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">))</span>
			<span class="n">mac_idx</span><span class="o">++</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * mac80211 HT idx is always zero-idxed; we need to move</span>
<span class="cm">		 * HT OFDM rates after CCK rates in 2.4 GHz band</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">)</span>
			<span class="n">mac_idx</span> <span class="o">+=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Here we actually compare this rate to the latest LQ command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mac_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">tbl_type</span><span class="p">.</span><span class="n">is_SGI</span> <span class="o">!=</span> <span class="o">!!</span><span class="p">(</span><span class="n">mac_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tbl_type</span><span class="p">.</span><span class="n">is_ht40</span> <span class="o">!=</span> <span class="o">!!</span><span class="p">(</span><span class="n">mac_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tbl_type</span><span class="p">.</span><span class="n">is_dup</span> <span class="o">!=</span> <span class="o">!!</span><span class="p">(</span><span class="n">mac_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_DUP_DATA</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">tbl_type</span><span class="p">.</span><span class="n">ant_type</span> <span class="o">!=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">antenna</span> <span class="o">||</span>
	    <span class="o">!!</span><span class="p">(</span><span class="n">tx_rate</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_HT_MSK</span><span class="p">)</span> <span class="o">!=</span> <span class="o">!!</span><span class="p">(</span><span class="n">mac_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">)</span>
	    <span class="o">||</span> <span class="o">!!</span><span class="p">(</span><span class="n">tx_rate</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_GF_MSK</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="o">!!</span><span class="p">(</span><span class="n">mac_flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_GREEN_FIELD</span><span class="p">)</span> <span class="o">||</span> <span class="n">rs_idx</span> <span class="o">!=</span> <span class="n">mac_idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;initial rate %d does not match %d (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mac_idx</span><span class="p">,</span>
		       <span class="n">rs_idx</span><span class="p">,</span> <span class="n">tx_rate</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * Since rates mis-match, the last LQ command may have failed.</span>
<span class="cm">		 * After IL_MISSED_RATE_MAX mis-matches, resync the uCode with</span>
<span class="cm">		 * ... driver.</span>
<span class="cm">		 */</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">missed_rate_counter</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">missed_rate_counter</span> <span class="o">&gt;</span> <span class="n">IL_MISSED_RATE_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">missed_rate_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">il_send_lq_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">,</span> <span class="n">CMD_ASYNC</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* Regardless, ignore this status info for outdated rate */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="cm">/* Rate did match, so reset the missed_rate_counter */</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">missed_rate_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Figure out if rate scale algorithm is in active or search table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il4965_table_type_matches</span>
	    <span class="p">(</span><span class="o">&amp;</span><span class="n">tbl_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">])))</span> <span class="p">{</span>
		<span class="n">curr_tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">]);</span>
		<span class="n">other_tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">il4965_table_type_matches</span>
		<span class="p">(</span><span class="o">&amp;</span><span class="n">tbl_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">curr_tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">]);</span>
		<span class="n">other_tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Neither active nor search matches tx rate</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tmp_tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">]);</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;active- lq:%x, ant:%x, SGI:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp_tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">,</span>
		       <span class="n">tmp_tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span><span class="p">,</span> <span class="n">tmp_tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span><span class="p">);</span>
		<span class="n">tmp_tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">]);</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;search- lq:%x, ant:%x, SGI:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tmp_tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">,</span>
		       <span class="n">tmp_tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span><span class="p">,</span> <span class="n">tmp_tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span><span class="p">);</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;actual- lq:%x, ant:%x, SGI:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tbl_type</span><span class="p">.</span><span class="n">lq_type</span><span class="p">,</span>
		       <span class="n">tbl_type</span><span class="p">.</span><span class="n">ant_type</span><span class="p">,</span> <span class="n">tbl_type</span><span class="p">.</span><span class="n">is_SGI</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * no matching table found, let&#39;s by-pass the data collection</span>
<span class="cm">		 * and continue to perform rate scale to find the rate table</span>
<span class="cm">		 */</span>
		<span class="n">il4965_rs_stay_in_table</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Updating the frame history depends on whether packets were</span>
<span class="cm">	 * aggregated.</span>
<span class="cm">	 *</span>
<span class="cm">	 * For aggregation, all packets were transmitted at the same rate, the</span>
<span class="cm">	 * first idx into rate scale table.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_STAT_AMPDU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tx_rate</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">rs_table</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">rate_n_flags</span><span class="p">);</span>
		<span class="n">il4965_rs_get_tbl_info_from_mcs</span><span class="p">(</span><span class="n">tx_rate</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tbl_type</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">rs_idx</span><span class="p">);</span>
		<span class="n">il4965_rs_collect_tx_data</span><span class="p">(</span><span class="n">curr_tbl</span><span class="p">,</span> <span class="n">rs_idx</span><span class="p">,</span>
					  <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_len</span><span class="p">,</span>
					  <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span><span class="p">);</span>

		<span class="cm">/* Update success/fail counts if not searching for new mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">stay_in_tbl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">total_success</span> <span class="o">+=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span><span class="p">;</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">total_failed</span> <span class="o">+=</span>
			    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_len</span> <span class="o">-</span>
			     <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * For legacy, update frame history with for each Tx retry.</span>
<span class="cm">		 */</span>
		<span class="n">retries</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* HW doesn&#39;t send more than 15 retries */</span>
		<span class="n">retries</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">retries</span><span class="p">,</span> <span class="mi">15</span><span class="p">);</span>

		<span class="cm">/* The last transmission may have been successful */</span>
		<span class="n">legacy_success</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">);</span>
		<span class="cm">/* Collect data for each rate used during failed TX attempts */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">retries</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">tx_rate</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">rs_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rate_n_flags</span><span class="p">);</span>
			<span class="n">il4965_rs_get_tbl_info_from_mcs</span><span class="p">(</span><span class="n">tx_rate</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span>
							<span class="o">&amp;</span><span class="n">tbl_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs_idx</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Only collect stats if retried rate is in the same RS</span>
<span class="cm">			 * table as active/search.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">il4965_table_type_matches</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tbl_type</span><span class="p">,</span> <span class="n">curr_tbl</span><span class="p">))</span>
				<span class="n">tmp_tbl</span> <span class="o">=</span> <span class="n">curr_tbl</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">il4965_table_type_matches</span>
				 <span class="p">(</span><span class="o">&amp;</span><span class="n">tbl_type</span><span class="p">,</span> <span class="n">other_tbl</span><span class="p">))</span>
				<span class="n">tmp_tbl</span> <span class="o">=</span> <span class="n">other_tbl</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">il4965_rs_collect_tx_data</span><span class="p">(</span><span class="n">tmp_tbl</span><span class="p">,</span> <span class="n">rs_idx</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
						  <span class="n">i</span> <span class="o">&lt;</span>
						  <span class="n">retries</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">legacy_success</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Update success/fail counts if not searching for new mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">stay_in_tbl</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">total_success</span> <span class="o">+=</span> <span class="n">legacy_success</span><span class="p">;</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">total_failed</span> <span class="o">+=</span> <span class="n">retries</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">legacy_success</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* The last TX rate is cached in lq_sta; it&#39;s set in if/else above */</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_rate_n_flags</span> <span class="o">=</span> <span class="n">tx_rate</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="cm">/* See if there&#39;s a better rate or modulation mode to try. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">])</span>
		<span class="n">il4965_rs_rate_scale_perform</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Begin a period of staying with a selected modulation mode.</span>
<span class="cm"> * Set &quot;stay_in_tbl&quot; flag to prevent any mode switches.</span>
<span class="cm"> * Set frame tx success limits according to legacy vs. high-throughput,</span>
<span class="cm"> * and reset overall (spanning all rates) tx success history stats.</span>
<span class="cm"> * These control how long we stay using same modulation mode before</span>
<span class="cm"> * searching for a new mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_set_stay_in_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u8</span> <span class="n">is_legacy</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;we are staying in the same table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">stay_in_tbl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* only place this gets set */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_legacy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">table_count_limit</span> <span class="o">=</span> <span class="n">IL_LEGACY_TBL_COUNT</span><span class="p">;</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_failure_limit</span> <span class="o">=</span> <span class="n">IL_LEGACY_FAILURE_LIMIT</span><span class="p">;</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_success_limit</span> <span class="o">=</span> <span class="n">IL_LEGACY_SUCCESS_LIMIT</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">table_count_limit</span> <span class="o">=</span> <span class="n">IL_NONE_LEGACY_TBL_COUNT</span><span class="p">;</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_failure_limit</span> <span class="o">=</span> <span class="n">IL_NONE_LEGACY_FAILURE_LIMIT</span><span class="p">;</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_success_limit</span> <span class="o">=</span> <span class="n">IL_NONE_LEGACY_SUCCESS_LIMIT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">table_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">total_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">total_success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">flush_timer</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">action_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find correct throughput table for given mode of modulation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_set_expected_tpt_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Used to choose among HT tables */</span>
	<span class="n">s32</span><span class="p">(</span><span class="o">*</span><span class="n">ht_tbl_pointer</span><span class="p">)[</span><span class="n">RATE_COUNT</span><span class="p">];</span>

	<span class="cm">/* Check for invalid LQ type */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="o">!</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_Ht</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span> <span class="o">=</span> <span class="n">expected_tpt_legacy</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Legacy rates have only one table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span> <span class="o">=</span> <span class="n">expected_tpt_legacy</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Choose among many HT tables depending on number of streams</span>
<span class="cm">	 * (SISO/MIMO2), channel width (20/40), SGI, and aggregation</span>
<span class="cm">	 * status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_siso</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span> <span class="o">||</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_dup</span><span class="p">))</span>
		<span class="n">ht_tbl_pointer</span> <span class="o">=</span> <span class="n">expected_tpt_siso20MHz</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_siso</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span>
		<span class="n">ht_tbl_pointer</span> <span class="o">=</span> <span class="n">expected_tpt_siso40MHz</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_mimo2</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span> <span class="o">||</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_dup</span><span class="p">))</span>
		<span class="n">ht_tbl_pointer</span> <span class="o">=</span> <span class="n">expected_tpt_mimo2_20MHz</span><span class="p">;</span>
	<span class="k">else</span>			<span class="cm">/* if (is_mimo2(tbl-&gt;lq_type)) &lt;-- must be true */</span>
		<span class="n">ht_tbl_pointer</span> <span class="o">=</span> <span class="n">expected_tpt_mimo2_40MHz</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_agg</span><span class="p">)</span>	<span class="cm">/* Normal */</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span> <span class="o">=</span> <span class="n">ht_tbl_pointer</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_agg</span><span class="p">)</span>	<span class="cm">/* SGI */</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span> <span class="o">=</span> <span class="n">ht_tbl_pointer</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span> <span class="o">&amp;&amp;</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_agg</span><span class="p">)</span>	<span class="cm">/* AGG */</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span> <span class="o">=</span> <span class="n">ht_tbl_pointer</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">else</span>			<span class="cm">/* AGG+SGI */</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span> <span class="o">=</span> <span class="n">ht_tbl_pointer</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find starting rate for new &quot;search&quot; high-throughput mode of modulation.</span>
<span class="cm"> * Goal is to find lowest expected rate (under perfect conditions) that is</span>
<span class="cm"> * above the current measured throughput of &quot;active&quot; mode, to give new mode</span>
<span class="cm"> * a fair chance to prove itself without too many challenges.</span>
<span class="cm"> *</span>
<span class="cm"> * This gets called when transitioning to more aggressive modulation</span>
<span class="cm"> * (i.e. legacy to SISO or MIMO, or SISO to MIMO), as well as less aggressive</span>
<span class="cm"> * (i.e. MIMO to SISO).  When moving to MIMO, bit rate will typically need</span>
<span class="cm"> * to decrease to match &quot;active&quot; throughput.  When moving from MIMO to SISO,</span>
<span class="cm"> * bit rate will typically need to increase, but not if performance was bad.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">s32</span>
<span class="nf">il4965_rs_get_best_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span>	<span class="cm">/* &quot;search&quot; */</span>
			<span class="n">u16</span> <span class="n">rate_mask</span><span class="p">,</span> <span class="n">s8</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* &quot;active&quot; values */</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">active_tbl</span> <span class="o">=</span>
	    <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">]);</span>
	<span class="n">s32</span> <span class="n">active_sr</span> <span class="o">=</span> <span class="n">active_tbl</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">success_ratio</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">active_tpt</span> <span class="o">=</span> <span class="n">active_tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="cm">/* expected &quot;search&quot; throughput */</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">tpt_tbl</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span><span class="p">;</span>

	<span class="n">s32</span> <span class="n">new_rate</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">start_hi</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">high_low</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

	<span class="n">new_rate</span> <span class="o">=</span> <span class="n">high</span> <span class="o">=</span> <span class="n">low</span> <span class="o">=</span> <span class="n">start_hi</span> <span class="o">=</span> <span class="n">RATE_INVALID</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">high_low</span> <span class="o">=</span>
		    <span class="n">il4965_rs_get_adjacent_rate</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">rate_mask</span><span class="p">,</span>
						<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">);</span>

		<span class="n">low</span> <span class="o">=</span> <span class="n">high_low</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">high_low</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Lower the &quot;search&quot; bit rate, to give new &quot;search&quot; mode</span>
<span class="cm">		 * approximately the same throughput as &quot;active&quot; if:</span>
<span class="cm">		 *</span>
<span class="cm">		 * 1) &quot;Active&quot; mode has been working modestly well (but not</span>
<span class="cm">		 *    great), and expected &quot;search&quot; throughput (under perfect</span>
<span class="cm">		 *    conditions) at candidate rate is above the actual</span>
<span class="cm">		 *    measured &quot;active&quot; throughput (but less than expected</span>
<span class="cm">		 *    &quot;active&quot; throughput under perfect conditions).</span>
<span class="cm">		 * OR</span>
<span class="cm">		 * 2) &quot;Active&quot; mode has been working perfectly or very well</span>
<span class="cm">		 *    and expected &quot;search&quot; throughput (under perfect</span>
<span class="cm">		 *    conditions) at candidate rate is above expected</span>
<span class="cm">		 *    &quot;active&quot; throughput (under perfect conditions).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="mi">100</span> <span class="o">*</span> <span class="n">tpt_tbl</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_tpt</span> <span class="o">&amp;&amp;</span>
		     <span class="p">(</span><span class="n">active_sr</span> <span class="o">&gt;</span> <span class="n">RATE_DECREASE_TH</span> <span class="o">&amp;&amp;</span> <span class="n">active_sr</span> <span class="o">&lt;=</span> <span class="n">RATE_HIGH_TH</span>
		      <span class="o">&amp;&amp;</span> <span class="n">tpt_tbl</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">active_tpt</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">active_sr</span> <span class="o">&gt;=</span> <span class="n">RATE_SCALE_SWITCH</span> <span class="o">&amp;&amp;</span>
		     <span class="n">tpt_tbl</span><span class="p">[</span><span class="n">rate</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">active_tpt</span><span class="p">))</span> <span class="p">{</span>

			<span class="cm">/* (2nd or later pass)</span>
<span class="cm">			 * If we&#39;ve already tried to raise the rate, and are</span>
<span class="cm">			 * now trying to lower it, use the higher rate. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">start_hi</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">new_rate</span> <span class="o">=</span> <span class="n">start_hi</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">new_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>

			<span class="cm">/* Loop again with lower rate */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
				<span class="n">rate</span> <span class="o">=</span> <span class="n">low</span><span class="p">;</span>

			<span class="cm">/* Lower rate not available, use the original */</span>
			<span class="k">else</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Else try to raise the &quot;search&quot; rate to match &quot;active&quot; */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* (2nd or later pass)</span>
<span class="cm">			 * If we&#39;ve already tried to lower the rate, and are</span>
<span class="cm">			 * now trying to raise it, use the lower rate. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_rate</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Loop again with higher rate */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">start_hi</span> <span class="o">=</span> <span class="n">high</span><span class="p">;</span>
				<span class="n">rate</span> <span class="o">=</span> <span class="n">high</span><span class="p">;</span>

				<span class="cm">/* Higher rate not available, use the original */</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">new_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">new_rate</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up search table for MIMO2</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_rs_switch_to_mimo2</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">rate_mask</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">is_green</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_green</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf_is_ht</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SM_PS</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">WLAN_HT_CAP_SM_PS_STATIC</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Need both Tx chains/antennas to support MIMO */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">tx_chains_num</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: try to switch to MIMO2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">=</span> <span class="n">LQ_MIMO2</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_dup</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_dup</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_search</span> <span class="o">=</span> <span class="n">IL_MAX_SEARCH</span><span class="p">;</span>
	<span class="n">rate_mask</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_mimo2_rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_ht40_tx_allowed</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">))</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">il4965_rs_set_expected_tpt_table</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="n">tbl</span><span class="p">);</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">il4965_rs_get_best_rate</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">rate_mask</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: MIMO2 best rate %d mask %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">rate_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="n">RATE_INVALID</span> <span class="o">||</span> <span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rate</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rate_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Can&#39;t switch with idx %d rate mask %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span>
		       <span class="n">rate_mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span> <span class="o">=</span>
	    <span class="n">il4965_rate_n_flags_from_tbl</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">is_green</span><span class="p">);</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: Switch to new mcs %X idx is green %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span><span class="p">,</span>
	       <span class="n">is_green</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set up search table for SISO</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_rs_switch_to_siso</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">rate_mask</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">is_green</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_green</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf_is_ht</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">.</span><span class="n">ht_supported</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: try to switch to SISO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_dup</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_dup</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">=</span> <span class="n">LQ_SISO</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">max_search</span> <span class="o">=</span> <span class="n">IL_MAX_SEARCH</span><span class="p">;</span>
	<span class="n">rate_mask</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_siso_rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_ht40_tx_allowed</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">))</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_green</span><span class="p">)</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/*11n spec: no SGI in SISO+Greenfield */</span>

	<span class="n">il4965_rs_set_expected_tpt_table</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="n">tbl</span><span class="p">);</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">il4965_rs_get_best_rate</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">rate_mask</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: get best rate %d mask %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">rate_mask</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">==</span> <span class="n">RATE_INVALID</span> <span class="o">||</span> <span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rate</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rate_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;can not switch with idx %d rate mask %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span>
		       <span class="n">rate_mask</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span> <span class="o">=</span>
	    <span class="n">il4965_rate_n_flags_from_tbl</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">rate</span><span class="p">,</span> <span class="n">is_green</span><span class="p">);</span>
	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: Switch to new mcs %X idx is green %X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span><span class="p">,</span>
	       <span class="n">is_green</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try to switch to new modulation mode from legacy</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_rs_move_legacy_other</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">search_tbl</span> <span class="o">=</span>
	    <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">)]);</span>
	<span class="k">struct</span> <span class="n">il_rate_scale_data</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="n">u32</span> <span class="n">sz</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_scale_tbl_info</span><span class="p">)</span> <span class="o">-</span>
	     <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_rate_scale_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">RATE_COUNT</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">start_action</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">valid_tx_ant</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_chains_num</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">tx_chains_num</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">update_search_tbl_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">IL_LEGACY_SWITCH_SISO</span><span class="p">;</span>

	<span class="n">start_action</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">action_counter</span><span class="o">++</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IL_LEGACY_SWITCH_ANTENNA1</span>:
		<span class="k">case</span> <span class="n">IL_LEGACY_SWITCH_ANTENNA2</span>:
			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: Legacy toggle Antenna</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">IL_LEGACY_SWITCH_ANTENNA1</span> <span class="o">&amp;&amp;</span>
			     <span class="n">tx_chains_num</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">IL_LEGACY_SWITCH_ANTENNA2</span> <span class="o">&amp;&amp;</span>
			     <span class="n">tx_chains_num</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Don&#39;t change antenna if success has been great */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">&gt;=</span> <span class="n">IL_RS_GOOD_RATIO</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* Set up search table to try other antenna */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">search_tbl</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">il4965_rs_toggle_antenna</span>
			    <span class="p">(</span><span class="n">valid_tx_ant</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span><span class="p">,</span>
			     <span class="n">search_tbl</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">update_search_tbl_counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">il4965_rs_set_expected_tpt_table</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span>
								 <span class="n">search_tbl</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IL_LEGACY_SWITCH_SISO</span>:
			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: Legacy switch to SISO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* Set up search table to try SISO */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">search_tbl</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
			<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span>
			    <span class="n">il4965_rs_switch_to_siso</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span>
						     <span class="n">search_tbl</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">action_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IL_LEGACY_SWITCH_MIMO2_AB</span>:
		<span class="k">case</span> <span class="n">IL_LEGACY_SWITCH_MIMO2_AC</span>:
		<span class="k">case</span> <span class="n">IL_LEGACY_SWITCH_MIMO2_BC</span>:
			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: Legacy switch to MIMO2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* Set up search table to try MIMO */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">search_tbl</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
			<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">IL_LEGACY_SWITCH_MIMO2_AB</span><span class="p">)</span>
				<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">=</span> <span class="n">ANT_AB</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">IL_LEGACY_SWITCH_MIMO2_AC</span><span class="p">)</span>
				<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">=</span> <span class="n">ANT_AC</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">=</span> <span class="n">ANT_BC</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il4965_rs_is_valid_ant</span>
			    <span class="p">(</span><span class="n">valid_tx_ant</span><span class="p">,</span> <span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span>
			    <span class="n">il4965_rs_switch_to_mimo2</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span>
						      <span class="n">search_tbl</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">action_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">&gt;</span> <span class="n">IL_LEGACY_SWITCH_MIMO2_BC</span><span class="p">)</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">IL_LEGACY_SWITCH_ANTENNA1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">start_action</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">=</span> <span class="n">LQ_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">search_better_tbl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">&gt;</span> <span class="n">IL_LEGACY_SWITCH_MIMO2_BC</span><span class="p">)</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">IL_LEGACY_SWITCH_ANTENNA1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">update_search_tbl_counter</span><span class="p">)</span>
		<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try to switch to new modulation mode from SISO</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_rs_move_siso_to_other</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">is_green</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_green</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">search_tbl</span> <span class="o">=</span>
	    <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">)]);</span>
	<span class="k">struct</span> <span class="n">il_rate_scale_data</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta_ht_cap</span> <span class="o">*</span><span class="n">ht_cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sz</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_scale_tbl_info</span><span class="p">)</span> <span class="o">-</span>
	     <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_rate_scale_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">RATE_COUNT</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">start_action</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">valid_tx_ant</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_chains_num</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">tx_chains_num</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">update_search_tbl_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">start_action</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">action_counter</span><span class="o">++</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IL_SISO_SWITCH_ANTENNA1</span>:
		<span class="k">case</span> <span class="n">IL_SISO_SWITCH_ANTENNA2</span>:
			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: SISO toggle Antenna</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">IL_SISO_SWITCH_ANTENNA1</span> <span class="o">&amp;&amp;</span>
			     <span class="n">tx_chains_num</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">IL_SISO_SWITCH_ANTENNA2</span> <span class="o">&amp;&amp;</span>
			     <span class="n">tx_chains_num</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">&gt;=</span> <span class="n">IL_RS_GOOD_RATIO</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">search_tbl</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">il4965_rs_toggle_antenna</span>
			    <span class="p">(</span><span class="n">valid_tx_ant</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span><span class="p">,</span>
			     <span class="n">search_tbl</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">update_search_tbl_counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IL_SISO_SWITCH_MIMO2_AB</span>:
		<span class="k">case</span> <span class="n">IL_SISO_SWITCH_MIMO2_AC</span>:
		<span class="k">case</span> <span class="n">IL_SISO_SWITCH_MIMO2_BC</span>:
			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: SISO switch to MIMO2</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">search_tbl</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
			<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">IL_SISO_SWITCH_MIMO2_AB</span><span class="p">)</span>
				<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">=</span> <span class="n">ANT_AB</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">IL_SISO_SWITCH_MIMO2_AC</span><span class="p">)</span>
				<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">=</span> <span class="n">ANT_AC</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">=</span> <span class="n">ANT_BC</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il4965_rs_is_valid_ant</span>
			    <span class="p">(</span><span class="n">valid_tx_ant</span><span class="p">,</span> <span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span>
			    <span class="n">il4965_rs_switch_to_mimo2</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span>
						      <span class="n">search_tbl</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IL_SISO_SWITCH_GI</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_20</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: SISO toggle SGI/NGI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">search_tbl</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_green</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;SGI was set in GF+SISO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span> <span class="o">=</span> <span class="o">!</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span><span class="p">;</span>
			<span class="n">il4965_rs_set_expected_tpt_table</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="n">search_tbl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s32</span> <span class="n">tpt</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_tpt</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tpt</span> <span class="o">&gt;=</span> <span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span> <span class="o">=</span>
			    <span class="n">il4965_rate_n_flags_from_tbl</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">search_tbl</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
							 <span class="n">is_green</span><span class="p">);</span>
			<span class="n">update_search_tbl_counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">&gt;</span> <span class="n">IL_SISO_SWITCH_GI</span><span class="p">)</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">IL_SISO_SWITCH_ANTENNA1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">start_action</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">=</span> <span class="n">LQ_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">search_better_tbl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">&gt;</span> <span class="n">IL_SISO_SWITCH_GI</span><span class="p">)</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">IL_SISO_SWITCH_ANTENNA1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">update_search_tbl_counter</span><span class="p">)</span>
		<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Try to switch to new modulation mode from MIMO2</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_rs_move_mimo2_to_other</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s8</span> <span class="n">is_green</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_green</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">search_tbl</span> <span class="o">=</span>
	    <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">)]);</span>
	<span class="k">struct</span> <span class="n">il_rate_scale_data</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta_ht_cap</span> <span class="o">*</span><span class="n">ht_cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sz</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_scale_tbl_info</span><span class="p">)</span> <span class="o">-</span>
	     <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_rate_scale_data</span><span class="p">)</span> <span class="o">*</span> <span class="n">RATE_COUNT</span><span class="p">));</span>
	<span class="n">u8</span> <span class="n">start_action</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">valid_tx_ant</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tx_chains_num</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">tx_chains_num</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">update_search_tbl_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">start_action</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">action_counter</span><span class="o">++</span><span class="p">;</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IL_MIMO2_SWITCH_ANTENNA1</span>:
		<span class="k">case</span> <span class="n">IL_MIMO2_SWITCH_ANTENNA2</span>:
			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: MIMO2 toggle Antennas</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tx_chains_num</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">&gt;=</span> <span class="n">IL_RS_GOOD_RATIO</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">memcpy</span><span class="p">(</span><span class="n">search_tbl</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">il4965_rs_toggle_antenna</span>
			    <span class="p">(</span><span class="n">valid_tx_ant</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span><span class="p">,</span>
			     <span class="n">search_tbl</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">update_search_tbl_counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IL_MIMO2_SWITCH_SISO_A</span>:
		<span class="k">case</span> <span class="n">IL_MIMO2_SWITCH_SISO_B</span>:
		<span class="k">case</span> <span class="n">IL_MIMO2_SWITCH_SISO_C</span>:
			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: MIMO2 switch to SISO</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* Set up new search table for SISO */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">search_tbl</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">IL_MIMO2_SWITCH_SISO_A</span><span class="p">)</span>
				<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">=</span> <span class="n">ANT_A</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">IL_MIMO2_SWITCH_SISO_B</span><span class="p">)</span>
				<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">=</span> <span class="n">ANT_B</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">=</span> <span class="n">ANT_C</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il4965_rs_is_valid_ant</span>
			    <span class="p">(</span><span class="n">valid_tx_ant</span><span class="p">,</span> <span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">ret</span> <span class="o">=</span>
			    <span class="n">il4965_rs_switch_to_siso</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span>
						     <span class="n">search_tbl</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IL_MIMO2_SWITCH_GI</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_20</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span> <span class="o">&amp;&amp;</span>
			    <span class="o">!</span><span class="p">(</span><span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">cap</span> <span class="o">&amp;</span> <span class="n">IEEE80211_HT_CAP_SGI_40</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: MIMO2 toggle SGI/NGI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* Set up new search table for MIMO2 */</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">search_tbl</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">sz</span><span class="p">);</span>
			<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span> <span class="o">=</span> <span class="o">!</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span><span class="p">;</span>
			<span class="n">il4965_rs_set_expected_tpt_table</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="n">search_tbl</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * If active table already uses the fastest possible</span>
<span class="cm">			 * modulation (dual stream with short guard interval),</span>
<span class="cm">			 * and it&#39;s working well, there&#39;s no need to look</span>
<span class="cm">			 * for a better type of modulation!</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s32</span> <span class="n">tpt</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_tpt</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tpt</span> <span class="o">&gt;=</span> <span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span> <span class="o">=</span>
			    <span class="n">il4965_rate_n_flags_from_tbl</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">search_tbl</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
							 <span class="n">is_green</span><span class="p">);</span>
			<span class="n">update_search_tbl_counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="p">}</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">&gt;</span> <span class="n">IL_MIMO2_SWITCH_GI</span><span class="p">)</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">IL_MIMO2_SWITCH_ANTENNA1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="n">start_action</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">=</span> <span class="n">LQ_NONE</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">search_better_tbl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">&gt;</span> <span class="n">IL_MIMO2_SWITCH_GI</span><span class="p">)</span>
		<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">IL_MIMO2_SWITCH_ANTENNA1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">update_search_tbl_counter</span><span class="p">)</span>
		<span class="n">search_tbl</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check whether we should continue using same modulation mode, or</span>
<span class="cm"> * begin search for a new mode, based on:</span>
<span class="cm"> * 1) # tx successes or failures while using this mode</span>
<span class="cm"> * 2) # times calling this function</span>
<span class="cm"> * 3) elapsed time in this mode (not used, for now)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_stay_in_table</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span> <span class="n">bool</span> <span class="n">force_search</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">active_tbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flush_interval_passed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">;</span>

	<span class="n">il</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">;</span>
	<span class="n">active_tbl</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">active_tbl</span><span class="p">]);</span>

	<span class="cm">/* If we&#39;ve been disallowing search, see if we should now allow it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">stay_in_tbl</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Elapsed time using current modulation mode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">flush_timer</span><span class="p">)</span>
			<span class="n">flush_interval_passed</span> <span class="o">=</span>
			    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span>
				       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">flush_timer</span> <span class="o">+</span>
						       <span class="n">RATE_SCALE_FLUSH_INTVL</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * Check if we should allow search for new modulation mode.</span>
<span class="cm">		 * If many frames have failed or succeeded, or we&#39;ve used</span>
<span class="cm">		 * this same modulation for a long time, allow search, and</span>
<span class="cm">		 * reset history stats that keep track of whether we should</span>
<span class="cm">		 * allow a new search.  Also (below) reset all bitmaps and</span>
<span class="cm">		 * stats in active history.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">force_search</span> <span class="o">||</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">total_failed</span> <span class="o">&gt;</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_failure_limit</span> <span class="o">||</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">total_success</span> <span class="o">&gt;</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_success_limit</span> <span class="o">||</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">search_better_tbl</span> <span class="o">&amp;&amp;</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">flush_timer</span> <span class="o">&amp;&amp;</span>
		     <span class="n">flush_interval_passed</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: stay is expired %d %d %d</span><span class="se">\n</span><span class="s">:&quot;</span><span class="p">,</span>
			       <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">total_failed</span><span class="p">,</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">total_success</span><span class="p">,</span>
			       <span class="n">flush_interval_passed</span><span class="p">);</span>

			<span class="cm">/* Allow search for new mode */</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">stay_in_tbl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* only place reset */</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">total_failed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">total_success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">flush_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Else if we&#39;ve used this modulation mode enough repetitions</span>
<span class="cm">			 * (regardless of elapsed time or success/failure), reset</span>
<span class="cm">			 * history bitmaps and rate-specific stats for all rates in</span>
<span class="cm">			 * active table.</span>
<span class="cm">			 */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">table_count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">table_count</span> <span class="o">&gt;=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">table_count_limit</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">table_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: stay in table clear win</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
					<span class="n">il4965_rs_rate_scale_clear_win</span><span class="p">(</span><span class="o">&amp;</span>
								       <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span>
									<span class="n">win</span>
									<span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* If transitioning to allow &quot;search&quot;, reset all history</span>
<span class="cm">		 * bitmaps and stats in active table (this will become the new</span>
<span class="cm">		 * &quot;search&quot; table). */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">stay_in_tbl</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">il4965_rs_rate_scale_clear_win</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * setup rate table in uCode</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_update_rate_tbl</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">is_green</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">;</span>

	<span class="cm">/* Update uCode&#39;s rate table. */</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">il4965_rate_n_flags_from_tbl</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">is_green</span><span class="p">);</span>
	<span class="n">il4965_rs_fill_link_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="n">il_send_lq_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">,</span> <span class="n">CMD_ASYNC</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Do rate scaling and search for new modulation mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_rate_scale_perform</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">low</span> <span class="o">=</span> <span class="n">RATE_INVALID</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">high</span> <span class="o">=</span> <span class="n">RATE_INVALID</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_rate_scale_data</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">current_tpt</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">low_tpt</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">high_tpt</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fail_count</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">scale_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rate_mask</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">update_lq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">,</span> <span class="o">*</span><span class="n">tbl1</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rate_scale_idx_msk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">is_green</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">active_tbl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">done_search</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">high_low</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">sr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span> <span class="o">=</span> <span class="n">MAX_TID_COUNT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_tid_data</span> <span class="o">*</span><span class="n">tid_data</span><span class="p">;</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;rate scale calculate new rate for skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Send management frames and NO_ACK data using lowest rate. */</span>
	<span class="cm">/* TODO: this could probably be improved.. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>

	<span class="n">tid</span> <span class="o">=</span> <span class="n">il4965_rs_tl_add_packet</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tid</span> <span class="o">!=</span> <span class="n">MAX_TID_COUNT</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">tx_agg_tid_en</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tid</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">tid_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">IL_AGG_OFF</span><span class="p">)</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_agg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_agg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_agg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Select rate-scale / modulation-mode table to work with in</span>
<span class="cm">	 * the rest of this function:  &quot;search&quot; if searching for better</span>
<span class="cm">	 * modulation mode, or &quot;active&quot; if doing rate scaling within a mode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">search_better_tbl</span><span class="p">)</span>
		<span class="n">active_tbl</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">active_tbl</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">active_tbl</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_green</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_green</span> <span class="o">=</span> <span class="n">il4965_rs_use_green</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="n">is_green</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_green</span><span class="p">;</span>

	<span class="cm">/* current tx rate */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span><span class="p">;</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Rate scale idx %d for type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">);</span>

	<span class="cm">/* rates available for this association, and for modulation mode */</span>
	<span class="n">rate_mask</span> <span class="o">=</span> <span class="n">il4965_rs_get_supported_rates</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">);</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;mask 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate_mask</span><span class="p">);</span>

	<span class="cm">/* mask with station rate restriction */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="cm">/* supp_rates has no CCK bits in A mode */</span>
			<span class="n">rate_scale_idx_msk</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span>
				   <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span> <span class="o">&lt;&lt;</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">rate_scale_idx_msk</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span>
		<span class="n">rate_scale_idx_msk</span> <span class="o">=</span> <span class="n">rate_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rate_scale_idx_msk</span><span class="p">)</span>
		<span class="n">rate_scale_idx_msk</span> <span class="o">=</span> <span class="n">rate_mask</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">idx</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">rate_scale_idx_msk</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Current Rate is not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">search_better_tbl</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* revert to active table if search table is not valid */</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">=</span> <span class="n">LQ_NONE</span><span class="p">;</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">search_better_tbl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">]);</span>
			<span class="cm">/* get &quot;active&quot; rate info */</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">il4965_hwrate_to_plcp_idx</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span><span class="p">);</span>
			<span class="n">il4965_rs_update_rate_tbl</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
						      <span class="n">is_green</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get expected throughput table and history win for current rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;tbl-&gt;expected_tpt is NULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* force user max rate if set by user */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_rate_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_rate_idx</span> <span class="o">&lt;</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_rate_idx</span><span class="p">;</span>
		<span class="n">update_lq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">lq_update</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If there is not enough history to calculate actual average</span>
<span class="cm">	 * throughput, keep analyzing results of more tx frames, without</span>
<span class="cm">	 * changing rate or mode (bypass most of the rest of this function).</span>
<span class="cm">	 * Set up new rate table in uCode only if old rate is not supported</span>
<span class="cm">	 * in current association (use new rate found above).</span>
<span class="cm">	 */</span>
	<span class="n">fail_count</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fail_count</span> <span class="o">&lt;</span> <span class="n">RATE_MIN_FAILURE_TH</span> <span class="o">&amp;&amp;</span>
	    <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span> <span class="o">&lt;</span> <span class="n">RATE_MIN_SUCCESS_TH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: still below TH. succ=%d total=%d &quot;</span> <span class="s">&quot;for idx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span><span class="p">,</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

		<span class="cm">/* Can&#39;t calculate this yet; not enough history */</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>

		<span class="cm">/* Should we stay with this modulation mode,</span>
<span class="cm">		 * or search for a new one? */</span>
		<span class="n">il4965_rs_stay_in_table</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Else we have enough samples; calculate estimate of</span>
<span class="cm">	 * actual average throughput */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span> <span class="o">!=</span>
	    <span class="p">((</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">*</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="mi">128</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;expected_tpt should have been calculated by now</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">*</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="mi">128</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If we are searching for better modulation mode, check success. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">search_better_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If good success, continue using the &quot;search&quot; mode;</span>
<span class="cm">		 * no need to send new link quality command, since we&#39;re</span>
<span class="cm">		 * continuing to use the setup that we&#39;ve been trying. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span> <span class="o">&gt;</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_tpt</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: SWITCHING TO NEW TBL &quot;</span>
			       <span class="s">&quot;suc=%d cur-tpt=%d old-tpt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span><span class="p">,</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span><span class="p">,</span>
			       <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_tpt</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span>
				<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">enable_counter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="cm">/* Swap tables; &quot;search&quot; becomes &quot;active&quot; */</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span> <span class="o">=</span> <span class="n">active_tbl</span><span class="p">;</span>
			<span class="n">current_tpt</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span><span class="p">;</span>

			<span class="cm">/* Else poor success; go back to mode in &quot;active&quot; table */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: GOING BACK TO THE OLD TBL &quot;</span>
			       <span class="s">&quot;suc=%d cur-tpt=%d old-tpt=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span><span class="p">,</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span><span class="p">,</span>
			       <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_tpt</span><span class="p">);</span>

			<span class="cm">/* Nullify &quot;search&quot; table */</span>
			<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span> <span class="o">=</span> <span class="n">LQ_NONE</span><span class="p">;</span>

			<span class="cm">/* Revert to &quot;active&quot; table */</span>
			<span class="n">active_tbl</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">;</span>
			<span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">active_tbl</span><span class="p">]);</span>

			<span class="cm">/* Revert to &quot;active&quot; rate and throughput info */</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">il4965_hwrate_to_plcp_idx</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span><span class="p">);</span>
			<span class="n">current_tpt</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_tpt</span><span class="p">;</span>

			<span class="cm">/* Need to set up a new rate table in uCode */</span>
			<span class="n">update_lq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Either way, we&#39;ve made a decision; modulation mode</span>
<span class="cm">		 * search is done, allow rate adjustment next time. */</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">search_better_tbl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">done_search</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* Don&#39;t switch modes below! */</span>
		<span class="k">goto</span> <span class="n">lq_update</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* (Else) not in search of better modulation mode, try for better</span>
<span class="cm">	 * starting rate, while staying in this mode. */</span>
	<span class="n">high_low</span> <span class="o">=</span>
	    <span class="n">il4965_rs_get_adjacent_rate</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">rate_scale_idx_msk</span><span class="p">,</span>
					<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">);</span>
	<span class="n">low</span> <span class="o">=</span> <span class="n">high_low</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">high_low</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* If user set max rate, dont allow higher than user constrain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_rate_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_rate_idx</span> <span class="o">&lt;</span> <span class="n">high</span><span class="p">)</span>
		<span class="n">high</span> <span class="o">=</span> <span class="n">RATE_INVALID</span><span class="p">;</span>

	<span class="n">sr</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span><span class="p">;</span>

	<span class="cm">/* Collect measured throughputs for current and adjacent rates */</span>
	<span class="n">current_tpt</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
		<span class="n">low_tpt</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">low</span><span class="p">].</span><span class="n">average_tpt</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
		<span class="n">high_tpt</span> <span class="o">=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">high</span><span class="p">].</span><span class="n">average_tpt</span><span class="p">;</span>

	<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Too many failures, decrease rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sr</span> <span class="o">&lt;=</span> <span class="n">RATE_DECREASE_TH</span> <span class="o">||</span> <span class="n">current_tpt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;decrease rate because of low success_ratio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">scale_action</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="cm">/* No throughput measured yet for adjacent rates; try increase. */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">low_tpt</span> <span class="o">==</span> <span class="n">IL_INVALID_VALUE</span> <span class="o">&amp;&amp;</span> <span class="n">high_tpt</span> <span class="o">==</span> <span class="n">IL_INVALID_VALUE</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span> <span class="o">&amp;&amp;</span> <span class="n">sr</span> <span class="o">&gt;=</span> <span class="n">RATE_INCREASE_TH</span><span class="p">)</span>
			<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
			<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Both adjacent throughputs are measured, but neither one has better</span>
<span class="cm">	 * throughput; we&#39;re using the best rate, don&#39;t change it! */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">low_tpt</span> <span class="o">!=</span> <span class="n">IL_INVALID_VALUE</span> <span class="o">&amp;&amp;</span> <span class="n">high_tpt</span> <span class="o">!=</span> <span class="n">IL_INVALID_VALUE</span> <span class="o">&amp;&amp;</span>
		 <span class="n">low_tpt</span> <span class="o">&lt;</span> <span class="n">current_tpt</span> <span class="o">&amp;&amp;</span> <span class="n">high_tpt</span> <span class="o">&lt;</span> <span class="n">current_tpt</span><span class="p">)</span>
		<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* At least one adjacent rate&#39;s throughput is measured,</span>
<span class="cm">	 * and may have better performance. */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Higher adjacent rate&#39;s throughput is measured */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">high_tpt</span> <span class="o">!=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Higher rate has better throughput */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">high_tpt</span> <span class="o">&gt;</span> <span class="n">current_tpt</span> <span class="o">&amp;&amp;</span> <span class="n">sr</span> <span class="o">&gt;=</span> <span class="n">RATE_INCREASE_TH</span><span class="p">)</span>
				<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="cm">/* Lower adjacent rate&#39;s throughput is measured */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">low_tpt</span> <span class="o">!=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Lower rate has better throughput */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">low_tpt</span> <span class="o">&gt;</span> <span class="n">current_tpt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;decrease rate because of low tpt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">scale_action</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sr</span> <span class="o">&gt;=</span> <span class="n">RATE_INCREASE_TH</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Sanity check; asked for decrease, but success rate or throughput</span>
<span class="cm">	 * has been good at old rate.  Don&#39;t change it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scale_action</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">low</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">sr</span> <span class="o">&gt;</span> <span class="n">RATE_HIGH_TH</span> <span class="o">||</span> <span class="n">current_tpt</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span><span class="p">[</span><span class="n">low</span><span class="p">]))</span>
		<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scale_action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
		<span class="cm">/* Decrease starting rate, update uCode&#39;s rate table */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">update_lq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">low</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* Increase starting rate, update uCode&#39;s rate table */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">update_lq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">high</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="cm">/* No change */</span>
	<span class="nl">default:</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;choose rate scale idx %d action %d low %d &quot;</span> <span class="s">&quot;high %d type %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">idx</span><span class="p">,</span> <span class="n">scale_action</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">);</span>

<span class="nl">lq_update:</span>
	<span class="cm">/* Replace uCode&#39;s rate table for the destination station. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">update_lq</span><span class="p">)</span>
		<span class="n">il4965_rs_update_rate_tbl</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">is_green</span><span class="p">);</span>

	<span class="cm">/* Should we stay with this modulation mode,</span>
<span class="cm">	 * or search for a new one? */</span>
	<span class="n">il4965_rs_stay_in_table</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Search for new modulation mode if we&#39;re:</span>
<span class="cm">	 * 1)  Not changing rates right now</span>
<span class="cm">	 * 2)  Not just finishing up a search</span>
<span class="cm">	 * 3)  Allowing a new search</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">update_lq</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">done_search</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">stay_in_tbl</span> <span class="o">&amp;&amp;</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Save current throughput to compare with &quot;search&quot; throughput */</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_tpt</span> <span class="o">=</span> <span class="n">current_tpt</span><span class="p">;</span>

		<span class="cm">/* Select a new &quot;search&quot; modulation mode to try.</span>
<span class="cm">		 * If one is found, set up the new &quot;search&quot; table. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span>
			<span class="n">il4965_rs_move_legacy_other</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">is_siso</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span>
			<span class="n">il4965_rs_move_siso_to_other</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span>
						     <span class="n">idx</span><span class="p">);</span>
		<span class="k">else</span>		<span class="cm">/* (is_mimo2(tbl-&gt;lq_type)) */</span>
			<span class="n">il4965_rs_move_mimo2_to_other</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span>
						      <span class="n">idx</span><span class="p">);</span>

		<span class="cm">/* If new &quot;search&quot; mode was selected, set up in uCode table */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">search_better_tbl</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Access the &quot;search&quot; table, clear its history. */</span>
			<span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">)]);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">il4965_rs_rate_scale_clear_win</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>

			<span class="cm">/* Use new &quot;search&quot; start rate */</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">il4965_hwrate_to_plcp_idx</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span><span class="p">);</span>

			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Switch current  mcs: %X idx: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">il4965_rs_fill_link_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span><span class="p">);</span>
			<span class="n">il_send_lq_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">,</span> <span class="n">CMD_ASYNC</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">done_search</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">done_search</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">stay_in_tbl</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If the &quot;active&quot; (non-search) mode was legacy,</span>
<span class="cm">		 * and we&#39;ve tried switching antennas,</span>
<span class="cm">		 * but we haven&#39;t been able to try HT modes (not available),</span>
<span class="cm">		 * stay with best antenna legacy modulation for a while</span>
<span class="cm">		 * before next round of mode comparisons. */</span>
		<span class="n">tbl1</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl1</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">conf_is_ht</span><span class="p">(</span><span class="n">conf</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">action_counter</span> <span class="o">&gt;</span> <span class="n">tbl1</span><span class="o">-&gt;</span><span class="n">max_search</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ: STAY in legacy table</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">il4965_rs_set_stay_in_table</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* If we&#39;re in an HT mode, and all 3 mode switch actions</span>
<span class="cm">		 * have been tried and compared, stay in this best modulation</span>
<span class="cm">		 * mode for a while before next round of mode comparisons. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">enable_counter</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">action_counter</span> <span class="o">&gt;=</span> <span class="n">tbl1</span><span class="o">-&gt;</span><span class="n">max_search</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_tpt</span> <span class="o">&gt;</span> <span class="n">IL_AGG_TPT_THREHOLD</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">tx_agg_tid_en</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tid</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
			    <span class="n">tid</span> <span class="o">!=</span> <span class="n">MAX_TID_COUNT</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">tid_data</span> <span class="o">=</span>
				    <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">IL_AGG_OFF</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;try to aggregate tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					       <span class="n">tid</span><span class="p">);</span>
					<span class="n">il4965_rs_tl_turn_on_agg</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span>
								 <span class="n">lq_sta</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="n">il4965_rs_set_stay_in_table</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span> <span class="o">=</span>
	    <span class="n">il4965_rate_n_flags_from_tbl</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">is_green</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_rs_initialize_lq - Initialize a station&#39;s hardware rate table</span>
<span class="cm"> *</span>
<span class="cm"> * The uCode&#39;s station table contains a table of fallback rates</span>
<span class="cm"> * for automatic fallback during transmission.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: This sets up a default set of values.  These will be replaced later</span>
<span class="cm"> *       if the driver&#39;s iwl-4965-rs rate scaling algorithm is used, instead of</span>
<span class="cm"> *       rc80211_simple.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: Run C_ADD_STA command to set up station table entry, before</span>
<span class="cm"> *       calling this function (which runs C_TX_LINK_QUALITY_CMD,</span>
<span class="cm"> *       which requires station table entry to exist).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_initialize_lq</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">use_green</span> <span class="o">=</span> <span class="n">il4965_rs_use_green</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">active_tbl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">valid_tx_ant</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_station_priv</span> <span class="o">*</span><span class="n">sta_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span> <span class="o">||</span> <span class="o">!</span><span class="n">lq_sta</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">sta_priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span><span class="p">;</span>

	<span class="n">valid_tx_ant</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">search_better_tbl</span><span class="p">)</span>
		<span class="n">active_tbl</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">active_tbl</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">;</span>

	<span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">active_tbl</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="n">RATE_COUNT</span><span class="p">)</span>
		<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">il_rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">plcp</span><span class="p">;</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">=</span> <span class="n">il4965_first_antenna</span><span class="p">(</span><span class="n">valid_tx_ant</span><span class="p">);</span>
	<span class="n">rate</span> <span class="o">|=</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span> <span class="o">&lt;&lt;</span> <span class="n">RATE_MCS_ANT_POS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">IL_FIRST_CCK_RATE</span> <span class="o">&amp;&amp;</span> <span class="n">i</span> <span class="o">&lt;=</span> <span class="n">IL_LAST_CCK_RATE</span><span class="p">)</span>
		<span class="n">rate</span> <span class="o">|=</span> <span class="n">RATE_MCS_CCK_MSK</span><span class="p">;</span>

	<span class="n">il4965_rs_get_tbl_info_from_mcs</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rate_idx</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il4965_rs_is_valid_ant</span><span class="p">(</span><span class="n">valid_tx_ant</span><span class="p">,</span> <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">ant_type</span><span class="p">))</span>
		<span class="n">il4965_rs_toggle_antenna</span><span class="p">(</span><span class="n">valid_tx_ant</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rate</span><span class="p">,</span> <span class="n">tbl</span><span class="p">);</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">il4965_rate_n_flags_from_tbl</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">tbl</span><span class="p">,</span> <span class="n">rate_idx</span><span class="p">,</span> <span class="n">use_green</span><span class="p">);</span>
	<span class="n">tbl</span><span class="o">-&gt;</span><span class="n">current_rate</span> <span class="o">=</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">il4965_rs_set_expected_tpt_table</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="n">tbl</span><span class="p">);</span>
	<span class="n">il4965_rs_fill_link_cmd</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">sta_id</span><span class="p">].</span><span class="n">lq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">;</span>
	<span class="n">il_send_lq_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_get_rate</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il_r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">il_sta</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ieee80211_tx_rate_control</span> <span class="o">*</span><span class="n">txrc</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">txrc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span> <span class="o">=</span> <span class="n">txrc</span><span class="o">-&gt;</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="n">__maybe_unused</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">il_r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span> <span class="o">=</span> <span class="n">il_sta</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_idx</span><span class="p">;</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;rate scale calculate new rate for skb</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Get max rate if user set max rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_rate_idx</span> <span class="o">=</span> <span class="n">txrc</span><span class="o">-&gt;</span><span class="n">max_rate_idx</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span> <span class="o">&amp;&amp;</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_rate_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_rate_idx</span> <span class="o">+=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_rate_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_rate_idx</span> <span class="o">&gt;=</span> <span class="n">RATE_COUNT</span><span class="p">)</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_rate_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Treat uninitialized rate scaling data same as non-existing. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Rate scaling not initialized yet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">il_sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send management frames and NO_ACK data using lowest rate. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_control_send_low</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">il_sta</span><span class="p">,</span> <span class="n">txrc</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lq_sta</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rate_idx</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_HT_MSK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rate_idx</span> <span class="o">-=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>
		<span class="cm">/* 6M and 9M shared same MCS idx */</span>
		<span class="n">rate_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate_idx</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">rate_idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">il4965_rs_extract_rate</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_rate_n_flags</span><span class="p">)</span> <span class="o">&gt;=</span>
		    <span class="n">RATE_MIMO2_6M_PLCP</span><span class="p">)</span>
			<span class="n">rate_idx</span> <span class="o">=</span> <span class="n">rate_idx</span> <span class="o">+</span> <span class="n">MCS_IDX_PER_STREAM</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_SGI_MSK</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
			    <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_DUP_MSK</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
			    <span class="n">IEEE80211_TX_RC_DUP_DATA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_HT40_MSK</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
			    <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_GF_MSK</span><span class="p">)</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
			    <span class="n">IEEE80211_TX_RC_GREEN_FIELD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Check for invalid rates */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rate_idx</span> <span class="o">&gt;=</span> <span class="n">RATE_COUNT_LEGACY</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span> <span class="o">&amp;&amp;</span>
		     <span class="n">rate_idx</span> <span class="o">&lt;</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">))</span>
			<span class="n">rate_idx</span> <span class="o">=</span> <span class="n">rate_lowest_index</span><span class="p">(</span><span class="n">sband</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="cm">/* On valid 5 GHz rate, adjust idx */</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">rate_idx</span> <span class="o">-=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">rate_idx</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">il4965_rs_alloc_sta</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il_rate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_station_priv</span> <span class="o">*</span><span class="n">sta_priv</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">il_station_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">;</span>

	<span class="n">il</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">il_rate</span><span class="p">;</span>
	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;create station rate scale win</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">&amp;</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">lq_sta</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called after adding a new station to initialize rate scaling</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">il4965_rs_rate_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta_ht_cap</span> <span class="o">*</span><span class="n">ht_cap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">ht_cap</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_station_priv</span> <span class="o">*</span><span class="n">sta_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>

	<span class="n">sta_priv</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_station_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">lq_sta</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">lq_sta</span><span class="p">;</span>
	<span class="n">sband</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>

	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">sta_id</span> <span class="o">=</span> <span class="n">sta_id</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">LQ_SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">il4965_rs_rate_scale_clear_win</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span>
						       <span class="n">win</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">flush_timer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">LQ_SIZE</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">il4965_rs_rate_scale_clear_win</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span>
						       <span class="n">win</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;LQ:&quot;</span> <span class="s">&quot;*** rate scale station global init for station %d ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">sta_id</span><span class="p">);</span>
	<span class="cm">/* TODO: what is a good starting rate for STA? About middle? Maybe not</span>
<span class="cm">	 * the lowest or the highest rate.. Could consider using RSSI from</span>
<span class="cm">	 * previous packets? Need to have IEEE 802.1X auth succeed immediately</span>
<span class="cm">	 * after assoc.. */</span>

	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_dup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">max_rate_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">missed_rate_counter</span> <span class="o">=</span> <span class="n">IL_MISSED_RATE_MAX</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_green</span> <span class="o">=</span> <span class="n">il4965_rs_use_green</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_legacy_rate</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">active_rate</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="mh">0x1000</span><span class="p">);</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * active_siso_rate mask includes 9 MBits (bit 5), and CCK (bits 0-3),</span>
<span class="cm">	 * supp_rates[] does not; shift to convert format, force 9 MBits off.</span>
<span class="cm">	 */</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_siso_rate</span> <span class="o">=</span> <span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_siso_rate</span> <span class="o">|=</span> <span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_siso_rate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="mh">0x2</span><span class="p">);</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_siso_rate</span> <span class="o">&lt;&lt;=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>

	<span class="cm">/* Same here */</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_mimo2_rate</span> <span class="o">=</span> <span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_mimo2_rate</span> <span class="o">|=</span> <span class="n">ht_cap</span><span class="o">-&gt;</span><span class="n">mcs</span><span class="p">.</span><span class="n">rx_mask</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_mimo2_rate</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="mh">0x2</span><span class="p">);</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_mimo2_rate</span> <span class="o">&lt;&lt;=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>

	<span class="cm">/* These values will be overridden later */</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">general_params</span><span class="p">.</span><span class="n">single_stream_ant_msk</span> <span class="o">=</span>
	    <span class="n">il4965_first_antenna</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">);</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">general_params</span><span class="p">.</span><span class="n">dual_stream_ant_msk</span> <span class="o">=</span>
	    <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">il4965_first_antenna</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span>
							       <span class="n">valid_tx_ant</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">general_params</span><span class="p">.</span><span class="n">dual_stream_ant_msk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">general_params</span><span class="p">.</span><span class="n">dual_stream_ant_msk</span> <span class="o">=</span> <span class="n">ANT_AB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">il4965_num_of_ant</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">general_params</span><span class="p">.</span><span class="n">dual_stream_ant_msk</span> <span class="o">=</span>
		    <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* as default allow aggregation for all tids */</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">tx_agg_tid_en</span> <span class="o">=</span> <span class="n">IL_AGG_ALL_TID</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">drv</span> <span class="o">=</span> <span class="n">il</span><span class="p">;</span>

	<span class="cm">/* Set last_txrate_idx to lowest rate */</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span> <span class="o">=</span> <span class="n">rate_lowest_index</span><span class="p">(</span><span class="n">sband</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span> <span class="o">+=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_agg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MAC80211_DEBUGFS</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">dbg_fixed_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">il4965_rs_initialize_lq</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_fill_link_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span>
			<span class="n">u32</span> <span class="n">new_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="n">tbl_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">repeat_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ant_toggle_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">use_ht_possible</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">valid_tx_ant</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_link_quality_cmd</span> <span class="o">*</span><span class="n">lq_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">;</span>

	<span class="cm">/* Override starting rate (idx 0) if needed for debug purposes */</span>
	<span class="n">il4965_rs_dbgfs_set_mcs</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_rate</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="cm">/* Interpret new_rate (rate_n_flags) */</span>
	<span class="n">il4965_rs_get_tbl_info_from_mcs</span><span class="p">(</span><span class="n">new_rate</span><span class="p">,</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tbl_type</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">rate_idx</span><span class="p">);</span>

	<span class="cm">/* How many times should we repeat the initial rate? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl_type</span><span class="p">.</span><span class="n">lq_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ant_toggle_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">repeat_rate</span> <span class="o">=</span> <span class="n">IL_NUMBER_TRY</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">repeat_rate</span> <span class="o">=</span> <span class="n">IL_HT_NUMBER_TRY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lq_cmd</span><span class="o">-&gt;</span><span class="n">general_params</span><span class="p">.</span><span class="n">mimo_delimiter</span> <span class="o">=</span>
	    <span class="n">is_mimo</span><span class="p">(</span><span class="n">tbl_type</span><span class="p">.</span><span class="n">lq_type</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Fill 1st table entry (idx 0) */</span>
	<span class="n">lq_cmd</span><span class="o">-&gt;</span><span class="n">rs_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">new_rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il4965_num_of_ant</span><span class="p">(</span><span class="n">tbl_type</span><span class="p">.</span><span class="n">ant_type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lq_cmd</span><span class="o">-&gt;</span><span class="n">general_params</span><span class="p">.</span><span class="n">single_stream_ant_msk</span> <span class="o">=</span>
		    <span class="n">tbl_type</span><span class="p">.</span><span class="n">ant_type</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">il4965_num_of_ant</span><span class="p">(</span><span class="n">tbl_type</span><span class="p">.</span><span class="n">ant_type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lq_cmd</span><span class="o">-&gt;</span><span class="n">general_params</span><span class="p">.</span><span class="n">dual_stream_ant_msk</span> <span class="o">=</span> <span class="n">tbl_type</span><span class="p">.</span><span class="n">ant_type</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* otherwise we don&#39;t modify the existing value */</span>
	<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="n">repeat_rate</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="p">)</span>
		<span class="n">valid_tx_ant</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">;</span>

	<span class="cm">/* Fill rest of rate table */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">LINK_QUAL_MAX_RETRY_NUM</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Repeat initial/next rate.</span>
<span class="cm">		 * For legacy IL_NUMBER_TRY == 1, this loop will not execute.</span>
<span class="cm">		 * For HT IL_HT_NUMBER_TRY == 3, this executes twice. */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">repeat_rate</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">LINK_QUAL_MAX_RETRY_NUM</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl_type</span><span class="p">.</span><span class="n">lq_type</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ant_toggle_cnt</span> <span class="o">&lt;</span> <span class="n">NUM_TRY_BEFORE_ANT_TOGGLE</span><span class="p">)</span>
					<span class="n">ant_toggle_cnt</span><span class="o">++</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">il</span> <span class="o">&amp;&amp;</span>
					 <span class="n">il4965_rs_toggle_antenna</span><span class="p">(</span><span class="n">valid_tx_ant</span><span class="p">,</span>
								  <span class="o">&amp;</span><span class="n">new_rate</span><span class="p">,</span>
								  <span class="o">&amp;</span><span class="n">tbl_type</span><span class="p">))</span>
					<span class="n">ant_toggle_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* Override next rate if needed for debug purposes */</span>
			<span class="n">il4965_rs_dbgfs_set_mcs</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_rate</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

			<span class="cm">/* Fill next table entry */</span>
			<span class="n">lq_cmd</span><span class="o">-&gt;</span><span class="n">rs_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">rate_n_flags</span> <span class="o">=</span>
			    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">new_rate</span><span class="p">);</span>
			<span class="n">repeat_rate</span><span class="o">--</span><span class="p">;</span>
			<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">il4965_rs_get_tbl_info_from_mcs</span><span class="p">(</span><span class="n">new_rate</span><span class="p">,</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">tbl_type</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rate_idx</span><span class="p">);</span>

		<span class="cm">/* Indicate to uCode which entries might be MIMO.</span>
<span class="cm">		 * If initial rate was MIMO, this will finally end up</span>
<span class="cm">		 * as (IL_HT_NUMBER_TRY * 2), after 2nd pass, otherwise 0. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_mimo</span><span class="p">(</span><span class="n">tbl_type</span><span class="p">.</span><span class="n">lq_type</span><span class="p">))</span>
			<span class="n">lq_cmd</span><span class="o">-&gt;</span><span class="n">general_params</span><span class="p">.</span><span class="n">mimo_delimiter</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

		<span class="cm">/* Get next rate */</span>
		<span class="n">new_rate</span> <span class="o">=</span>
		    <span class="n">il4965_rs_get_lower_rate</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tbl_type</span><span class="p">,</span> <span class="n">rate_idx</span><span class="p">,</span>
					     <span class="n">use_ht_possible</span><span class="p">);</span>

		<span class="cm">/* How many times should we repeat the next rate? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl_type</span><span class="p">.</span><span class="n">lq_type</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ant_toggle_cnt</span> <span class="o">&lt;</span> <span class="n">NUM_TRY_BEFORE_ANT_TOGGLE</span><span class="p">)</span>
				<span class="n">ant_toggle_cnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">il</span> <span class="o">&amp;&amp;</span>
				 <span class="n">il4965_rs_toggle_antenna</span><span class="p">(</span><span class="n">valid_tx_ant</span><span class="p">,</span>
							  <span class="o">&amp;</span><span class="n">new_rate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tbl_type</span><span class="p">))</span>
				<span class="n">ant_toggle_cnt</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

			<span class="n">repeat_rate</span> <span class="o">=</span> <span class="n">IL_NUMBER_TRY</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">repeat_rate</span> <span class="o">=</span> <span class="n">IL_HT_NUMBER_TRY</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Don&#39;t allow HT rates after next pass.</span>
<span class="cm">		 * il4965_rs_get_lower_rate() will change type to LQ_A or LQ_G. */</span>
		<span class="n">use_ht_possible</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Override next rate if needed for debug purposes */</span>
		<span class="n">il4965_rs_dbgfs_set_mcs</span><span class="p">(</span><span class="n">lq_sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_rate</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

		<span class="cm">/* Fill next table entry */</span>
		<span class="n">lq_cmd</span><span class="o">-&gt;</span><span class="n">rs_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">new_rate</span><span class="p">);</span>

		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">repeat_rate</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lq_cmd</span><span class="o">-&gt;</span><span class="n">agg_params</span><span class="p">.</span><span class="n">agg_frame_cnt_limit</span> <span class="o">=</span> <span class="n">LINK_QUAL_AGG_FRAME_LIMIT_DEF</span><span class="p">;</span>
	<span class="n">lq_cmd</span><span class="o">-&gt;</span><span class="n">agg_params</span><span class="p">.</span><span class="n">agg_dis_start_th</span> <span class="o">=</span> <span class="n">LINK_QUAL_AGG_DISABLE_START_DEF</span><span class="p">;</span>

	<span class="n">lq_cmd</span><span class="o">-&gt;</span><span class="n">agg_params</span><span class="p">.</span><span class="n">agg_time_limit</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">LINK_QUAL_AGG_TIME_LIMIT_DEF</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">il4965_rs_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debugfsdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* rate scale requires free function to be implemented */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il_rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_free_sta</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il_r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">il_sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="n">__maybe_unused</span> <span class="o">=</span> <span class="n">il_r</span><span class="p">;</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MAC80211_DEBUGFS</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_dbgfs_set_mcs</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="n">rate_n_flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">valid_tx_ant</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ant_sel_tx</span><span class="p">;</span>

	<span class="n">il</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">;</span>
	<span class="n">valid_tx_ant</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">dbg_fixed_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ant_sel_tx</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">lq_sta</span><span class="o">-&gt;</span>
		      <span class="n">dbg_fixed_rate</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_ANT_ABC_MSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		     <span class="n">RATE_MCS_ANT_POS</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">valid_tx_ant</span> <span class="o">&amp;</span> <span class="n">ant_sel_tx</span><span class="p">)</span> <span class="o">==</span> <span class="n">ant_sel_tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">dbg_fixed_rate</span><span class="p">;</span>
			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Fixed rate ON</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">dbg_fixed_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">IL_ERR</span>
			    <span class="p">(</span><span class="s">&quot;Invalid antenna selection 0x%X, Valid is 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">ant_sel_tx</span><span class="p">,</span> <span class="n">valid_tx_ant</span><span class="p">);</span>
			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Fixed rate OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Fixed rate OFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il4965_rs_sta_dbgfs_scale_table_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				      <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">parsed_rate</span><span class="p">;</span>

	<span class="n">il</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">));</span>
	<span class="n">buf_size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">count</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">user_buf</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">parsed_rate</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">dbg_fixed_rate</span> <span class="o">=</span> <span class="n">parsed_rate</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">dbg_fixed_rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_legacy_rate</span> <span class="o">=</span> <span class="mh">0x0FFF</span><span class="p">;</span>	<span class="cm">/* 1 - 54 MBits, includes CCK */</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_siso_rate</span> <span class="o">=</span> <span class="mh">0x1FD0</span><span class="p">;</span>	<span class="cm">/* 6 - 60 MBits, no 9, no CCK */</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_mimo2_rate</span> <span class="o">=</span> <span class="mh">0x1FD0</span><span class="p">;</span>	<span class="cm">/* 6 - 60 MBits, no 9, no CCK */</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;sta_id %d rate 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">sta_id</span><span class="p">,</span>
	       <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">dbg_fixed_rate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">dbg_fixed_rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">il4965_rs_fill_link_cmd</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">dbg_fixed_rate</span><span class="p">);</span>
		<span class="n">il_send_lq_cmd</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">,</span> <span class="n">CMD_ASYNC</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il4965_rs_sta_dbgfs_scale_table_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				     <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">]);</span>

	<span class="n">il</span> <span class="o">=</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">;</span>
	<span class="n">buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot;sta_id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">sta_id</span><span class="p">);</span>
	<span class="n">desc</span> <span class="o">+=</span>
	    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot;failed=%d success=%d rate=0%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">total_failed</span><span class="p">,</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">total_success</span><span class="p">,</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_legacy_rate</span><span class="p">);</span>
	<span class="n">desc</span> <span class="o">+=</span>
	    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot;fixed rate 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">dbg_fixed_rate</span><span class="p">);</span>
	<span class="n">desc</span> <span class="o">+=</span>
	    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot;valid_tx_ant %s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span> <span class="o">&amp;</span> <span class="n">ANT_A</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ANT_A,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span> <span class="o">&amp;</span> <span class="n">ANT_B</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ANT_B,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span> <span class="o">&amp;</span> <span class="n">ANT_C</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ANT_C&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="n">desc</span> <span class="o">+=</span>
	    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot;lq type %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">(</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;legacy&quot;</span> <span class="o">:</span> <span class="s">&quot;HT&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_Ht</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">+=</span>
		    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">is_siso</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;SISO&quot;</span> <span class="o">:</span> <span class="s">&quot;MIMO2&quot;</span><span class="p">);</span>
		<span class="n">desc</span> <span class="o">+=</span>
		    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_ht40</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;40MHz&quot;</span> <span class="o">:</span> <span class="s">&quot;20MHz&quot;</span><span class="p">);</span>
		<span class="n">desc</span> <span class="o">+=</span>
		    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot; %s %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">is_SGI</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;SGI&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_green</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;GF enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_agg</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;AGG on&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">desc</span> <span class="o">+=</span>
	    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot;last tx rate=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_rate_n_flags</span><span class="p">);</span>
	<span class="n">desc</span> <span class="o">+=</span>
	    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span>
		    <span class="s">&quot;general:&quot;</span> <span class="s">&quot;flags=0x%X mimo-d=%d s-ant0x%x d-ant=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">general_params</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">general_params</span><span class="p">.</span><span class="n">mimo_delimiter</span><span class="p">,</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">general_params</span><span class="p">.</span><span class="n">single_stream_ant_msk</span><span class="p">,</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">general_params</span><span class="p">.</span><span class="n">dual_stream_ant_msk</span><span class="p">);</span>

	<span class="n">desc</span> <span class="o">+=</span>
	    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span>
		    <span class="s">&quot;agg:&quot;</span>
		    <span class="s">&quot;time_limit=%d dist_start_th=%d frame_cnt_limit=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">agg_params</span><span class="p">.</span><span class="n">agg_time_limit</span><span class="p">),</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">agg_params</span><span class="p">.</span><span class="n">agg_dis_start_th</span><span class="p">,</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">agg_params</span><span class="p">.</span><span class="n">agg_frame_cnt_limit</span><span class="p">);</span>

	<span class="n">desc</span> <span class="o">+=</span>
	    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span>
		    <span class="s">&quot;Start idx [0]=0x%x [1]=0x%x [2]=0x%x [3]=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">general_params</span><span class="p">.</span><span class="n">start_rate_idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">general_params</span><span class="p">.</span><span class="n">start_rate_idx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">general_params</span><span class="p">.</span><span class="n">start_rate_idx</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">general_params</span><span class="p">.</span><span class="n">start_rate_idx</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LINK_QUAL_MAX_RETRY_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span>
		    <span class="n">il4965_hwrate_to_plcp_idx</span><span class="p">(</span><span class="n">le32_to_cpu</span>
					      <span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">rs_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
					       <span class="n">rate_n_flags</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">is_legacy</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">desc</span> <span class="o">+=</span>
			    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot; rate[%d] 0x%X %smbps</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
				    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">rs_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						<span class="n">rate_n_flags</span><span class="p">),</span>
				    <span class="n">il_rate_mcs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">mbps</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">desc</span> <span class="o">+=</span>
			    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot; rate[%d] 0x%X %smbps (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">i</span><span class="p">,</span>
				    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq</span><span class="p">.</span><span class="n">rs_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span>
						<span class="n">rate_n_flags</span><span class="p">),</span>
				    <span class="n">il_rate_mcs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">mbps</span><span class="p">,</span>
				    <span class="n">il_rate_mcs</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">mcs</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rs_sta_dbgfs_scale_table_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">il4965_rs_sta_dbgfs_scale_table_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">il4965_rs_sta_dbgfs_scale_table_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il4965_rs_sta_dbgfs_stats_table_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				     <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LQ_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">+=</span>
		    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span>
			    <span class="s">&quot;%s type=%d SGI=%d HT40=%d DUP=%d GF=%d</span><span class="se">\n</span><span class="s">&quot;</span>
			    <span class="s">&quot;rate=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span> <span class="o">==</span> <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;*&quot;</span> <span class="o">:</span> <span class="s">&quot;x&quot;</span><span class="p">,</span>
			    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lq_type</span><span class="p">,</span>
			    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_SGI</span><span class="p">,</span>
			    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_ht40</span><span class="p">,</span>
			    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">is_dup</span><span class="p">,</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">is_green</span><span class="p">,</span>
			    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">current_rate</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">desc</span> <span class="o">+=</span>
			    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span>
				    <span class="s">&quot;counter=%d success=%d %%=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">win</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">counter</span><span class="p">,</span>
				    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">win</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">success_counter</span><span class="p">,</span>
				    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">win</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">success_ratio</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rs_sta_dbgfs_stats_table_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">il4965_rs_sta_dbgfs_stats_table_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il4965_rs_sta_dbgfs_rate_scale_data_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
					 <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">buff</span><span class="p">[</span><span class="mi">120</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_scale_tbl_info</span> <span class="o">*</span><span class="n">tbl</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">lq_info</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">active_tbl</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_Ht</span><span class="p">(</span><span class="n">tbl</span><span class="o">-&gt;</span><span class="n">lq_type</span><span class="p">))</span>
		<span class="n">desc</span> <span class="o">+=</span>
		    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot;Bit Rate= %d Mb/s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">tbl</span><span class="o">-&gt;</span><span class="n">expected_tpt</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span><span class="p">]);</span>
	<span class="k">else</span>
		<span class="n">desc</span> <span class="o">+=</span>
		    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot;Bit Rate= %d Mb/s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">il_rates</span><span class="p">[</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span><span class="p">].</span><span class="n">ieee</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rs_sta_dbgfs_rate_scale_data_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">il4965_rs_sta_dbgfs_rate_scale_data_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_add_debugfs</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">il_sta</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span> <span class="o">=</span> <span class="n">il_sta</span><span class="p">;</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">rs_sta_dbgfs_scale_table_file</span> <span class="o">=</span>
	    <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;rate_scale_table&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span>
				<span class="n">lq_sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs_sta_dbgfs_scale_table_ops</span><span class="p">);</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">rs_sta_dbgfs_stats_table_file</span> <span class="o">=</span>
	    <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;rate_stats_table&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rs_sta_dbgfs_stats_table_ops</span><span class="p">);</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">rs_sta_dbgfs_rate_scale_data_file</span> <span class="o">=</span>
	    <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;rate_scale_data&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rs_sta_dbgfs_rate_scale_data_ops</span><span class="p">);</span>
	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">rs_sta_dbgfs_tx_agg_tid_en_file</span> <span class="o">=</span>
	    <span class="n">debugfs_create_u8</span><span class="p">(</span><span class="s">&quot;tx_agg_tid_enable&quot;</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">tx_agg_tid_en</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_remove_debugfs</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">il_sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_lq_sta</span> <span class="o">*</span><span class="n">lq_sta</span> <span class="o">=</span> <span class="n">il_sta</span><span class="p">;</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">rs_sta_dbgfs_scale_table_file</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">rs_sta_dbgfs_stats_table_file</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">rs_sta_dbgfs_rate_scale_data_file</span><span class="p">);</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">rs_sta_dbgfs_tx_agg_tid_en_file</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Initialization of rate scaling information is done by driver after</span>
<span class="cm"> * the station is added. Since mac80211 calls this function before a</span>
<span class="cm"> * station is added we ignore it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rs_rate_init_stub</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il_r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">il_sta</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rate_control_ops</span> <span class="n">rs_4965_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">IL4965_RS_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_status</span> <span class="o">=</span> <span class="n">il4965_rs_tx_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span> <span class="o">=</span> <span class="n">il4965_rs_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_init</span> <span class="o">=</span> <span class="n">il4965_rs_rate_init_stub</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">il4965_rs_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">il4965_rs_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_sta</span> <span class="o">=</span> <span class="n">il4965_rs_alloc_sta</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_sta</span> <span class="o">=</span> <span class="n">il4965_rs_free_sta</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_MAC80211_DEBUGFS</span>
	<span class="p">.</span><span class="n">add_sta_debugfs</span> <span class="o">=</span> <span class="n">il4965_rs_add_debugfs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_sta_debugfs</span> <span class="o">=</span> <span class="n">il4965_rs_remove_debugfs</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="kt">int</span>
<span class="nf">il4965_rate_control_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ieee80211_rate_control_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_4965_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_rate_control_unregister</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee80211_rate_control_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_4965_ops</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
