<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › iwlegacy › 3945-rs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>3945-rs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2005 - 2011 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> *  Intel Linux Wireless &lt;ilw@linux.intel.com&gt;</span>
<span class="cm"> * Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>

<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;linux/workqueue.h&gt;</span>

<span class="cp">#include &quot;commands.h&quot;</span>
<span class="cp">#include &quot;3945.h&quot;</span>

<span class="cp">#define RS_NAME &quot;iwl-3945-rs&quot;</span>

<span class="k">static</span> <span class="n">s32</span> <span class="n">il3945_expected_tpt_g</span><span class="p">[</span><span class="n">RATE_COUNT_3945</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">7</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">202</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">s32</span> <span class="n">il3945_expected_tpt_g_prot</span><span class="p">[</span><span class="n">RATE_COUNT_3945</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">7</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">125</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">s32</span> <span class="n">il3945_expected_tpt_a</span><span class="p">[</span><span class="n">RATE_COUNT_3945</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">186</span>
<span class="p">};</span>

<span class="k">static</span> <span class="n">s32</span> <span class="n">il3945_expected_tpt_b</span><span class="p">[</span><span class="n">RATE_COUNT_3945</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">7</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">il3945_tpt_entry</span> <span class="p">{</span>
	<span class="n">s8</span> <span class="n">min_rssi</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">idx</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">il3945_tpt_entry</span> <span class="n">il3945_tpt_table_a</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="n">RATE_54M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span> <span class="n">RATE_48M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">72</span><span class="p">,</span> <span class="n">RATE_36M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="n">RATE_24M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">84</span><span class="p">,</span> <span class="n">RATE_18M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">85</span><span class="p">,</span> <span class="n">RATE_12M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">87</span><span class="p">,</span> <span class="n">RATE_9M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">89</span><span class="p">,</span> <span class="n">RATE_6M_IDX</span><span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">il3945_tpt_entry</span> <span class="n">il3945_tpt_table_g</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">60</span><span class="p">,</span> <span class="n">RATE_54M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">64</span><span class="p">,</span> <span class="n">RATE_48M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">68</span><span class="p">,</span> <span class="n">RATE_36M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">80</span><span class="p">,</span> <span class="n">RATE_24M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">84</span><span class="p">,</span> <span class="n">RATE_18M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">85</span><span class="p">,</span> <span class="n">RATE_12M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">86</span><span class="p">,</span> <span class="n">RATE_11M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">88</span><span class="p">,</span> <span class="n">RATE_5M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="n">RATE_2M_IDX</span><span class="p">},</span>
	<span class="p">{</span><span class="o">-</span><span class="mi">92</span><span class="p">,</span> <span class="n">RATE_1M_IDX</span><span class="p">}</span>
<span class="p">};</span>

<span class="cp">#define RATE_MAX_WINDOW		62</span>
<span class="cp">#define RATE_FLUSH		(3*HZ)</span>
<span class="cp">#define RATE_WIN_FLUSH		(HZ/2)</span>
<span class="cp">#define IL39_RATE_HIGH_TH	11520</span>
<span class="cp">#define IL_SUCCESS_UP_TH	8960</span>
<span class="cp">#define IL_SUCCESS_DOWN_TH	10880</span>
<span class="cp">#define RATE_MIN_FAILURE_TH	6</span>
<span class="cp">#define RATE_MIN_SUCCESS_TH	8</span>
<span class="cp">#define RATE_DECREASE_TH	1920</span>
<span class="cp">#define RATE_RETRY_TH		15</span>

<span class="k">static</span> <span class="n">u8</span>
<span class="nf">il3945_get_rate_idx_by_rssi</span><span class="p">(</span><span class="n">s32</span> <span class="n">rssi</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">table_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il3945_tpt_entry</span> <span class="o">*</span><span class="n">tpt_table</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;</span> <span class="n">IL_MIN_RSSI_VAL</span> <span class="o">||</span> <span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">IL_MAX_RSSI_VAL</span><span class="p">)</span>
		<span class="n">rssi</span> <span class="o">=</span> <span class="n">IL_MIN_RSSI_VAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">band</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_2GHZ</span>:
		<span class="n">tpt_table</span> <span class="o">=</span> <span class="n">il3945_tpt_table_g</span><span class="p">;</span>
		<span class="n">table_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">il3945_tpt_table_g</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_5GHZ</span>:
		<span class="n">tpt_table</span> <span class="o">=</span> <span class="n">il3945_tpt_table_a</span><span class="p">;</span>
		<span class="n">table_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">il3945_tpt_table_a</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">table_size</span> <span class="o">&amp;&amp;</span> <span class="n">rssi</span> <span class="o">&lt;</span> <span class="n">tpt_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">min_rssi</span><span class="p">)</span>
		<span class="n">idx</span><span class="o">++</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">table_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">tpt_table</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_clear_win</span><span class="p">(</span><span class="k">struct</span> <span class="n">il3945_rate_scale_data</span> <span class="o">*</span><span class="n">win</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">stamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_rate_scale_flush_wins - flush out the rate scale wins</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the number of wins that have gathered data but were</span>
<span class="cm"> * not flushed.  If there were any that were not flushed, then</span>
<span class="cm"> * reschedule the rate flushing routine.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_rate_scale_flush_wins</span><span class="p">(</span><span class="k">struct</span> <span class="n">il3945_rs_sta</span> <span class="o">*</span><span class="n">rs_sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">unflushed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="n">__maybe_unused</span> <span class="o">=</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">il</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For each rate, if we have collected data on that rate</span>
<span class="cm">	 * and it has been more than RATE_WIN_FLUSH</span>
<span class="cm">	 * since we flushed, clear out the gathered stats</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT_3945</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">counter</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">stamp</span> <span class="o">+</span> <span class="n">RATE_WIN_FLUSH</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;flushing %d samples of rate &quot;</span> <span class="s">&quot;idx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">counter</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="n">il3945_clear_win</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">unflushed</span><span class="o">++</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">unflushed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define RATE_FLUSH_MAX              5000	</span><span class="cm">/* msec */</span><span class="cp"></span>
<span class="cp">#define RATE_FLUSH_MIN              50	</span><span class="cm">/* msec */</span><span class="cp"></span>
<span class="cp">#define IL_AVERAGE_PACKETS             1500</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_bg_rate_scale_flush</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il3945_rs_sta</span> <span class="o">*</span><span class="n">rs_sta</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="n">__maybe_unused</span> <span class="o">=</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">il</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">unflushed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">packet_count</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span> <span class="n">pps</span><span class="p">;</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">unflushed</span> <span class="o">=</span> <span class="n">il3945_rate_scale_flush_wins</span><span class="p">(</span><span class="n">rs_sta</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Number of packets Rx&#39;d since last time this timer ran */</span>
	<span class="n">packet_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">-</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_tx_packets</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_tx_packets</span> <span class="o">=</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">tx_packets</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unflushed</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">duration</span> <span class="o">=</span>
		    <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">jiffies</span> <span class="o">-</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_partial_flush</span><span class="p">);</span>

		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Tx&#39;d %d packets in %dms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">packet_count</span><span class="p">,</span> <span class="n">duration</span><span class="p">);</span>

		<span class="cm">/* Determine packets per second */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">duration</span><span class="p">)</span>
			<span class="n">pps</span> <span class="o">=</span> <span class="p">(</span><span class="n">packet_count</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">duration</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">pps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pps</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">duration</span> <span class="o">=</span> <span class="p">(</span><span class="n">IL_AVERAGE_PACKETS</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">/</span> <span class="n">pps</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">duration</span> <span class="o">&lt;</span> <span class="n">RATE_FLUSH_MIN</span><span class="p">)</span>
				<span class="n">duration</span> <span class="o">=</span> <span class="n">RATE_FLUSH_MIN</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">duration</span> <span class="o">&gt;</span> <span class="n">RATE_FLUSH_MAX</span><span class="p">)</span>
				<span class="n">duration</span> <span class="o">=</span> <span class="n">RATE_FLUSH_MAX</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">duration</span> <span class="o">=</span> <span class="n">RATE_FLUSH_MAX</span><span class="p">;</span>

		<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">flush_time</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">duration</span><span class="p">);</span>

		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;new flush period: %d msec ave %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">duration</span><span class="p">,</span>
		       <span class="n">packet_count</span><span class="p">);</span>

		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">rate_scale_flush</span><span class="p">,</span>
			  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">flush_time</span><span class="p">);</span>

		<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_partial_flush</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">flush_time</span> <span class="o">=</span> <span class="n">RATE_FLUSH</span><span class="p">;</span>
		<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">flush_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* If there weren&#39;t any unflushed entries, we don&#39;t schedule the timer</span>
<span class="cm">	 * to run again */</span>

	<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_flush</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_collect_tx_data - Update the success/failure sliding win</span>
<span class="cm"> *</span>
<span class="cm"> * We keep a sliding win of the last 64 packets transmitted</span>
<span class="cm"> * at this rate.  win-&gt;data contains the bitmask of successful</span>
<span class="cm"> * packets.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_collect_tx_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">il3945_rs_sta</span> <span class="o">*</span><span class="n">rs_sta</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">il3945_rate_scale_data</span> <span class="o">*</span><span class="n">win</span><span class="p">,</span> <span class="kt">int</span> <span class="n">success</span><span class="p">,</span>
		       <span class="kt">int</span> <span class="n">retries</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">fail_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="n">__maybe_unused</span> <span class="o">=</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">il</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retries</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;leave: retries == 0 -- should be at least 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Keep track of only the latest 62 tx frame attempts in this rate&#39;s</span>
<span class="cm">	 * history win; anything older isn&#39;t really relevant any more.</span>
<span class="cm">	 * If we have filled up the sliding win, drop the oldest attempt;</span>
<span class="cm">	 * if the oldest attempt (highest bit in bitmap) shows &quot;success&quot;,</span>
<span class="cm">	 * subtract &quot;1&quot; from the success counter (this is the main reason</span>
<span class="cm">	 * we keep these bitmaps!).</span>
<span class="cm">	 * */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;=</span> <span class="n">RATE_MAX_WINDOW</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* remove earliest */</span>
			<span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">=</span> <span class="n">RATE_MAX_WINDOW</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">RATE_MAX_WINDOW</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">win</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">RATE_MAX_WINDOW</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
				<span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span><span class="o">--</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Increment frames-attempted counter */</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Shift bitmap by one frame (throw away oldest history),</span>
<span class="cm">		 * OR in &quot;1&quot;, and increment &quot;success&quot; if this</span>
<span class="cm">		 * frame was successful. */</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">success</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span><span class="o">++</span><span class="p">;</span>
			<span class="n">win</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">|=</span> <span class="mh">0x1</span><span class="p">;</span>
			<span class="n">success</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">retries</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Calculate current success ratio, avoid divide-by-0! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">=</span>
		    <span class="mi">128</span> <span class="o">*</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span><span class="p">)</span> <span class="o">/</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>

	<span class="n">fail_count</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span><span class="p">;</span>

	<span class="cm">/* Calculate average throughput, if we have enough history. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fail_count</span> <span class="o">&gt;=</span> <span class="n">RATE_MIN_FAILURE_TH</span> <span class="o">||</span>
	    <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span> <span class="o">&gt;=</span> <span class="n">RATE_MIN_SUCCESS_TH</span><span class="p">)</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span> <span class="o">=</span>
		    <span class="p">((</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">*</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">expected_tpt</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span>
		      <span class="mi">64</span><span class="p">)</span> <span class="o">/</span> <span class="mi">128</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>

	<span class="cm">/* Tag this win as having been updated */</span>
	<span class="n">win</span><span class="o">-&gt;</span><span class="n">stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called after adding a new station to initialize rate scaling</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">il3945_rs_rate_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il3945_sta_priv</span> <span class="o">*</span><span class="n">psta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il3945_rs_sta</span> <span class="o">*</span><span class="n">rs_sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">bcast_id</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">psta</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il3945_sta_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">rs_sta</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psta</span><span class="o">-&gt;</span><span class="n">rs_sta</span><span class="p">;</span>
	<span class="n">sband</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>

	<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">il</span> <span class="o">=</span> <span class="n">il</span><span class="p">;</span>

	<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">start_rate</span> <span class="o">=</span> <span class="n">RATE_INVALID</span><span class="p">;</span>

	<span class="cm">/* default to just 802.11b */</span>
	<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">expected_tpt</span> <span class="o">=</span> <span class="n">il3945_expected_tpt_b</span><span class="p">;</span>

	<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_partial_flush</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_flush</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">flush_time</span> <span class="o">=</span> <span class="n">RATE_FLUSH</span><span class="p">;</span>
	<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_tx_packets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">rate_scale_flush</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">rs_sta</span><span class="p">;</span>
	<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">rate_scale_flush</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">il3945_bg_rate_scale_flush</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT_3945</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">il3945_clear_win</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* TODO: what is a good starting rate for STA? About middle? Maybe not</span>
<span class="cm">	 * the lowest or the highest rate.. Could consider using RSSI from</span>
<span class="cm">	 * previous packets? Need to have IEEE 802.1X auth succeed immediately</span>
<span class="cm">	 * after assoc.. */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">n_bitrates</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">sta_supp_rates</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>
	<span class="cm">/* For 5 GHz band it start at IL_FIRST_OFDM_RATE */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span> <span class="o">+=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">sta_supp_rates</span> <span class="o">&lt;&lt;=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">used</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IL_STA_UCODE_INPROGRESS</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">il3945_rs_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">debugfsdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* rate scale requires free function to be implemented */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_rs_free</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">il3945_rs_alloc_sta</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il_priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il3945_rs_sta</span> <span class="o">*</span><span class="n">rs_sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il3945_sta_priv</span> <span class="o">*</span><span class="n">psta</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="n">__maybe_unused</span> <span class="o">=</span> <span class="n">il_priv</span><span class="p">;</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rs_sta</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psta</span><span class="o">-&gt;</span><span class="n">rs_sta</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">rate_scale_flush</span><span class="p">);</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rs_sta</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_rs_free_sta</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il_priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">il_sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il3945_rs_sta</span> <span class="o">*</span><span class="n">rs_sta</span> <span class="o">=</span> <span class="n">il_sta</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Be careful not to use any members of il3945_rs_sta (like trying</span>
<span class="cm">	 * to use il_priv to print out debugging) since it may not be fully</span>
<span class="cm">	 * initialized at this point.</span>
<span class="cm">	 */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">rate_scale_flush</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_rs_tx_status - Update rate control values based on Tx results</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: Uses il_priv-&gt;retry_rate for the # of retries attempted by</span>
<span class="cm"> * the hardware for each rate.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_rs_tx_status</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il_rate</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">il_sta</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s8</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">current_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">scale_rate_idx</span><span class="p">,</span> <span class="n">first_idx</span><span class="p">,</span> <span class="n">last_idx</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">il_rate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il3945_rs_sta</span> <span class="o">*</span><span class="n">rs_sta</span> <span class="o">=</span> <span class="n">il_sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">retries</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span><span class="p">;</span>
	<span class="cm">/* Sanity Check for retries */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="n">RATE_RETRY_TH</span><span class="p">)</span>
		<span class="n">retries</span> <span class="o">=</span> <span class="n">RATE_RETRY_TH</span><span class="p">;</span>

	<span class="n">first_idx</span> <span class="o">=</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">bitrates</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span><span class="p">].</span><span class="n">hw_value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">first_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">first_idx</span> <span class="o">&gt;=</span> <span class="n">RATE_COUNT_3945</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;leave: Rate out of bounds: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">first_idx</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il_sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;leave: No STA il data to update!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Treat uninitialized rate scaling data same as non-existing. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">il</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;leave: STA il data uninitialized!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>

	<span class="n">scale_rate_idx</span> <span class="o">=</span> <span class="n">first_idx</span><span class="p">;</span>
	<span class="n">last_idx</span> <span class="o">=</span> <span class="n">first_idx</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Update the win for each rate.  We determine which rates</span>
<span class="cm">	 * were Tx&#39;d based on the total number of retries vs. the number</span>
<span class="cm">	 * of retries configured for each rate -- currently set to the</span>
<span class="cm">	 * il value &#39;retry_rate&#39; vs. rate specific</span>
<span class="cm">	 *</span>
<span class="cm">	 * On exit from this while loop last_idx indicates the rate</span>
<span class="cm">	 * at which the frame was finally transmitted (or failed if no</span>
<span class="cm">	 * ACK)</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">retry_rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">current_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">last_idx</span> <span class="o">=</span> <span class="n">scale_rate_idx</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">current_count</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">retry_rate</span><span class="p">;</span>
			<span class="n">last_idx</span> <span class="o">=</span> <span class="n">il3945_rs_next_rate</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">scale_rate_idx</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Update this rate accounting for as many retries</span>
<span class="cm">		 * as was used for it (per current_count) */</span>
		<span class="n">il3945_collect_tx_data</span><span class="p">(</span><span class="n">rs_sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">scale_rate_idx</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span>
				       <span class="n">current_count</span><span class="p">,</span> <span class="n">scale_rate_idx</span><span class="p">);</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Update rate %d for %d retries.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scale_rate_idx</span><span class="p">,</span>
		       <span class="n">current_count</span><span class="p">);</span>

		<span class="n">retries</span> <span class="o">-=</span> <span class="n">current_count</span><span class="p">;</span>

		<span class="n">scale_rate_idx</span> <span class="o">=</span> <span class="n">last_idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Update the last idx win with success/failure based on ACK */</span>
	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Update rate %d with %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">last_idx</span><span class="p">,</span>
	       <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;success&quot;</span> <span class="o">:</span> <span class="s">&quot;failure&quot;</span><span class="p">);</span>
	<span class="n">il3945_collect_tx_data</span><span class="p">(</span><span class="n">rs_sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">last_idx</span><span class="p">],</span>
			       <span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			       <span class="n">last_idx</span><span class="p">);</span>

	<span class="cm">/* We updated the rate scale win -- if its been more than</span>
<span class="cm">	 * flush_time since the last run, schedule the flush</span>
<span class="cm">	 * again */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">flush_pending</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_flush</span> <span class="o">+</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">flush_time</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_partial_flush</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">flush_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">rate_scale_flush</span><span class="p">,</span>
			  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">flush_time</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u16</span>
<span class="nf">il3945_get_adjacent_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">il3945_rs_sta</span> <span class="o">*</span><span class="n">rs_sta</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u16</span> <span class="n">rate_mask</span><span class="p">,</span>
			 <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">high</span> <span class="o">=</span> <span class="n">RATE_INVALID</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">low</span> <span class="o">=</span> <span class="n">RATE_INVALID</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="n">__maybe_unused</span> <span class="o">=</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">il</span><span class="p">;</span>

	<span class="cm">/* 802.11A walks to the next literal adjacent rate in</span>
<span class="cm">	 * the rate table */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>

		<span class="cm">/* Find the previous rate that is in the rate mask */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">low</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Find the next rate that is in the rate mask */</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT_3945</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">,</span> <span class="n">mask</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">high</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">low</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">low</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">tgg</span><span class="p">)</span>
			<span class="n">low</span> <span class="o">=</span> <span class="n">il3945_rates</span><span class="p">[</span><span class="n">low</span><span class="p">].</span><span class="n">prev_rs_tgg</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">low</span> <span class="o">=</span> <span class="n">il3945_rates</span><span class="p">[</span><span class="n">low</span><span class="p">].</span><span class="n">prev_rs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">==</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">low</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Skipping masked lower rate: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">low</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">high</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">high</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">tgg</span><span class="p">)</span>
			<span class="n">high</span> <span class="o">=</span> <span class="n">il3945_rates</span><span class="p">[</span><span class="n">high</span><span class="p">].</span><span class="n">next_rs_tgg</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">high</span> <span class="o">=</span> <span class="n">il3945_rates</span><span class="p">[</span><span class="n">high</span><span class="p">].</span><span class="n">next_rs</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">==</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">high</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Skipping masked higher rate: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">high</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">low</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_rs_get_rate - find the rate for the requested packet</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the ieee80211_rate structure allocated by the driver.</span>
<span class="cm"> *</span>
<span class="cm"> * The rate control algorithm has no internal mapping between hw_mode&#39;s</span>
<span class="cm"> * rate ordering and the rate ordering used by the rate control algorithm.</span>
<span class="cm"> *</span>
<span class="cm"> * The rate control algorithm uses a single table of rates that goes across</span>
<span class="cm"> * the entire A/B/G spectrum vs. being limited to just one particular</span>
<span class="cm"> * hw_mode.</span>
<span class="cm"> *</span>
<span class="cm"> * As such, we can&#39;t convert the idx obtained below into the hw_mode&#39;s</span>
<span class="cm"> * rate table and must reference the driver allocated rate table</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_rs_get_rate</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il_r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">il_sta</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ieee80211_tx_rate_control</span> <span class="o">*</span><span class="n">txrc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span> <span class="o">=</span> <span class="n">txrc</span><span class="o">-&gt;</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">txrc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">low</span> <span class="o">=</span> <span class="n">RATE_INVALID</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">high</span> <span class="o">=</span> <span class="n">RATE_INVALID</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">high_low</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il3945_rs_sta</span> <span class="o">*</span><span class="n">rs_sta</span> <span class="o">=</span> <span class="n">il_sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il3945_rate_scale_data</span> <span class="o">*</span><span class="n">win</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">current_tpt</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">low_tpt</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">high_tpt</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">fail_count</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">scale_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rate_mask</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">max_rate_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="n">__maybe_unused</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">il_r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Treat uninitialized rate scaling data same as non-existing. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rs_sta</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">il</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Rate scaling information not initialized yet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">il_sta</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rate_control_send_low</span><span class="p">(</span><span class="n">sta</span><span class="p">,</span> <span class="n">il_sta</span><span class="p">,</span> <span class="n">txrc</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">rate_mask</span> <span class="o">=</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">supp_rates</span><span class="p">[</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">];</span>

	<span class="cm">/* get user max rate if set */</span>
	<span class="n">max_rate_idx</span> <span class="o">=</span> <span class="n">txrc</span><span class="o">-&gt;</span><span class="n">max_rate_idx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span> <span class="o">&amp;&amp;</span> <span class="n">max_rate_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">max_rate_idx</span> <span class="o">+=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_rate_idx</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">max_rate_idx</span> <span class="o">&gt;=</span> <span class="n">RATE_COUNT</span><span class="p">)</span>
		<span class="n">max_rate_idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span> <span class="o">&amp;</span> <span class="mh">0xffff</span><span class="p">,</span> <span class="n">RATE_COUNT_3945</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">rate_mask</span> <span class="o">=</span> <span class="n">rate_mask</span> <span class="o">&lt;&lt;</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* for recent assoc, choose best rate regarding</span>
<span class="cm">	 * to rssi value</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">start_rate</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">start_rate</span> <span class="o">&lt;</span> <span class="n">idx</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">start_rate</span><span class="p">)))</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">start_rate</span><span class="p">;</span>
		<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">start_rate</span> <span class="o">=</span> <span class="n">RATE_INVALID</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* force user max rate if set by user */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_rate_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">max_rate_idx</span> <span class="o">&lt;</span> <span class="n">idx</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">max_rate_idx</span><span class="p">))</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">max_rate_idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">win</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>

	<span class="n">fail_count</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span> <span class="o">-</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fail_count</span> <span class="o">&lt;</span> <span class="n">RATE_MIN_FAILURE_TH</span> <span class="o">&amp;&amp;</span>
	    <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span> <span class="o">&lt;</span> <span class="n">RATE_MIN_SUCCESS_TH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Invalid average_tpt on rate %d: &quot;</span>
		       <span class="s">&quot;counter: %d, success_counter: %d, &quot;</span>
		       <span class="s">&quot;expected_tpt is %sNULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">counter</span><span class="p">,</span>
		       <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_counter</span><span class="p">,</span>
		       <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">expected_tpt</span> <span class="o">?</span> <span class="s">&quot;not &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

		<span class="cm">/* Can&#39;t calculate this yet; not enough history */</span>
		<span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span> <span class="o">=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="n">current_tpt</span> <span class="o">=</span> <span class="n">win</span><span class="o">-&gt;</span><span class="n">average_tpt</span><span class="p">;</span>

	<span class="n">high_low</span> <span class="o">=</span>
	    <span class="n">il3945_get_adjacent_rate</span><span class="p">(</span><span class="n">rs_sta</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">rate_mask</span><span class="p">,</span> <span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
	<span class="n">low</span> <span class="o">=</span> <span class="n">high_low</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">high</span> <span class="o">=</span> <span class="p">(</span><span class="n">high_low</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="cm">/* If user set max rate, dont allow higher than user constrain */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">max_rate_idx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">max_rate_idx</span> <span class="o">&lt;</span> <span class="n">high</span><span class="p">)</span>
		<span class="n">high</span> <span class="o">=</span> <span class="n">RATE_INVALID</span><span class="p">;</span>

	<span class="cm">/* Collect Measured throughputs of adjacent rates */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
		<span class="n">low_tpt</span> <span class="o">=</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">low</span><span class="p">].</span><span class="n">average_tpt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
		<span class="n">high_tpt</span> <span class="o">=</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">high</span><span class="p">].</span><span class="n">average_tpt</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Low success ratio , need to drop the rate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">&lt;</span> <span class="n">RATE_DECREASE_TH</span> <span class="o">||</span> <span class="o">!</span><span class="n">current_tpt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;decrease rate because of low success_ratio</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">scale_action</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* No throughput measured yet for adjacent rates,</span>
<span class="cm">		 * try increase */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">low_tpt</span> <span class="o">==</span> <span class="n">IL_INVALID_VALUE</span> <span class="o">&amp;&amp;</span> <span class="n">high_tpt</span> <span class="o">==</span> <span class="n">IL_INVALID_VALUE</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span> <span class="o">&amp;&amp;</span>
		    <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">&gt;=</span> <span class="n">RATE_INCREASE_TH</span><span class="p">)</span>
			<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
			<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Both adjacent throughputs are measured, but neither one has</span>
<span class="cm">		 * better throughput; we&#39;re using the best rate, don&#39;t change</span>
<span class="cm">		 * it! */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">low_tpt</span> <span class="o">!=</span> <span class="n">IL_INVALID_VALUE</span> <span class="o">&amp;&amp;</span> <span class="n">high_tpt</span> <span class="o">!=</span> <span class="n">IL_INVALID_VALUE</span>
		   <span class="o">&amp;&amp;</span> <span class="n">low_tpt</span> <span class="o">&lt;</span> <span class="n">current_tpt</span> <span class="o">&amp;&amp;</span> <span class="n">high_tpt</span> <span class="o">&lt;</span> <span class="n">current_tpt</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;No action -- low [%d] &amp; high [%d] &lt; &quot;</span>
		       <span class="s">&quot;current_tpt [%d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">low_tpt</span><span class="p">,</span> <span class="n">high_tpt</span><span class="p">,</span> <span class="n">current_tpt</span><span class="p">);</span>
		<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* At least one of the rates has better throughput */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">high_tpt</span> <span class="o">!=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* High rate has better throughput, Increase</span>
<span class="cm">			 * rate */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">high_tpt</span> <span class="o">&gt;</span> <span class="n">current_tpt</span> <span class="o">&amp;&amp;</span>
			    <span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">&gt;=</span> <span class="n">RATE_INCREASE_TH</span><span class="p">)</span>
				<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;decrease rate because of high tpt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">low_tpt</span> <span class="o">!=</span> <span class="n">IL_INVALID_VALUE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">low_tpt</span> <span class="o">&gt;</span> <span class="n">current_tpt</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;decrease rate because of low tpt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">scale_action</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">&gt;=</span> <span class="n">RATE_INCREASE_TH</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Lower rate has better</span>
<span class="cm">				 * throughput,decrease rate */</span>
				<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Sanity check; asked for decrease, but success rate or throughput</span>
<span class="cm">	 * has been good at old rate.  Don&#39;t change it. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scale_action</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">low</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">win</span><span class="o">-&gt;</span><span class="n">success_ratio</span> <span class="o">&gt;</span> <span class="n">RATE_HIGH_TH</span> <span class="o">||</span>
	     <span class="n">current_tpt</span> <span class="o">&gt;</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">expected_tpt</span><span class="p">[</span><span class="n">low</span><span class="p">]))</span>
		<span class="n">scale_action</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">scale_action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="o">-</span><span class="mi">1</span>:
		<span class="cm">/* Decrese rate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">low</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">low</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* Increase rate */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">high</span> <span class="o">!=</span> <span class="n">RATE_INVALID</span><span class="p">)</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">high</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="nl">default:</span>
		<span class="cm">/* No change */</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Selected %d (action %d) - low %d high %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">scale_action</span><span class="p">,</span>
	       <span class="n">low</span><span class="p">,</span> <span class="n">high</span><span class="p">);</span>

<span class="nl">out:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sband</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">))</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>
		<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span> <span class="o">=</span> <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;leave: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_MAC80211_DEBUGFS</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_sta_dbgfs_stats_table_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">user_buf</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">buff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">desc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il3945_rs_sta</span> <span class="o">*</span><span class="n">lq_sta</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="n">buff</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="mi">1024</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buff</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">desc</span> <span class="o">+=</span>
	    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span>
		    <span class="s">&quot;tx packets=%d last rate idx=%d</span><span class="se">\n</span><span class="s">&quot;</span>
		    <span class="s">&quot;rate=0x%X flush time %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="p">,</span>
		    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">last_txrate_idx</span><span class="p">,</span> <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">start_rate</span><span class="p">,</span>
		    <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">flush_time</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT_3945</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">+=</span>
		    <span class="n">sprintf</span><span class="p">(</span><span class="n">buff</span> <span class="o">+</span> <span class="n">desc</span><span class="p">,</span> <span class="s">&quot;counter=%d success=%d %%=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">counter</span><span class="p">,</span>
			    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">success_counter</span><span class="p">,</span>
			    <span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">win</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">success_ratio</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">simple_read_from_buffer</span><span class="p">(</span><span class="n">user_buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">ppos</span><span class="p">,</span> <span class="n">buff</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buff</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">rs_sta_dbgfs_stats_table_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">il3945_sta_dbgfs_stats_table_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">simple_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">default_llseek</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_add_debugfs</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">il_sta</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">dir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il3945_rs_sta</span> <span class="o">*</span><span class="n">lq_sta</span> <span class="o">=</span> <span class="n">il_sta</span><span class="p">;</span>

	<span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">rs_sta_dbgfs_stats_table_file</span> <span class="o">=</span>
	    <span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;rate_stats_table&quot;</span><span class="p">,</span> <span class="mo">0600</span><span class="p">,</span> <span class="n">dir</span><span class="p">,</span> <span class="n">lq_sta</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">rs_sta_dbgfs_stats_table_ops</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_remove_debugfs</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">il_sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il3945_rs_sta</span> <span class="o">*</span><span class="n">lq_sta</span> <span class="o">=</span> <span class="n">il_sta</span><span class="p">;</span>
	<span class="n">debugfs_remove</span><span class="p">(</span><span class="n">lq_sta</span><span class="o">-&gt;</span><span class="n">rs_sta_dbgfs_stats_table_file</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Initialization of rate scaling information is done by driver after</span>
<span class="cm"> * the station is added. Since mac80211 calls this function before a</span>
<span class="cm"> * station is added we ignore it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_rs_rate_init_stub</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">il_r</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">il_sta</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">rate_control_ops</span> <span class="n">rs_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">module</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">RS_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_status</span> <span class="o">=</span> <span class="n">il3945_rs_tx_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_rate</span> <span class="o">=</span> <span class="n">il3945_rs_get_rate</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rate_init</span> <span class="o">=</span> <span class="n">il3945_rs_rate_init_stub</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc</span> <span class="o">=</span> <span class="n">il3945_rs_alloc</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free</span> <span class="o">=</span> <span class="n">il3945_rs_free</span><span class="p">,</span>
	<span class="p">.</span><span class="n">alloc_sta</span> <span class="o">=</span> <span class="n">il3945_rs_alloc_sta</span><span class="p">,</span>
	<span class="p">.</span><span class="n">free_sta</span> <span class="o">=</span> <span class="n">il3945_rs_free_sta</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_MAC80211_DEBUGFS</span>
	<span class="p">.</span><span class="n">add_sta_debugfs</span> <span class="o">=</span> <span class="n">il3945_add_debugfs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_sta_debugfs</span> <span class="o">=</span> <span class="n">il3945_remove_debugfs</span><span class="p">,</span>
<span class="cp">#endif</span>

<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">il3945_rate_scale_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="n">s32</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">rssi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il3945_rs_sta</span> <span class="o">*</span><span class="n">rs_sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il3945_sta_priv</span> <span class="o">*</span><span class="n">psta</span><span class="p">;</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>

	<span class="n">sta</span> <span class="o">=</span> <span class="n">ieee80211_find_sta</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Unable to find station to initialize rate scaling.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rcu_read_unlock</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psta</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">rs_sta</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">psta</span><span class="o">-&gt;</span><span class="n">rs_sta</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">tgg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_2GHZ</span>:
		<span class="cm">/* TODO: this always does G, not a regression */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_FLG_TGG_PROTECT_MSK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">tgg</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">expected_tpt</span> <span class="o">=</span> <span class="n">il3945_expected_tpt_g_prot</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">expected_tpt</span> <span class="o">=</span> <span class="n">il3945_expected_tpt_g</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_5GHZ</span>:
		<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">expected_tpt</span> <span class="o">=</span> <span class="n">il3945_expected_tpt_a</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_NUM_BANDS</span>:
		<span class="n">BUG</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rssi</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">last_rx_rssi</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">rssi</span> <span class="o">=</span> <span class="n">IL_MIN_RSSI_VAL</span><span class="p">;</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;Network RSSI: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rssi</span><span class="p">);</span>

	<span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">start_rate</span> <span class="o">=</span> <span class="n">il3945_get_rate_idx_by_rssi</span><span class="p">(</span><span class="n">rssi</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;leave: rssi %d assign rate idx: &quot;</span> <span class="s">&quot;%d (plcp 0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rssi</span><span class="p">,</span>
	       <span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">start_rate</span><span class="p">,</span> <span class="n">il3945_rates</span><span class="p">[</span><span class="n">rs_sta</span><span class="o">-&gt;</span><span class="n">start_rate</span><span class="p">].</span><span class="n">plcp</span><span class="p">);</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il3945_rate_control_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ieee80211_rate_control_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_ops</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il3945_rate_control_unregister</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ieee80211_rate_control_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rs_ops</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
