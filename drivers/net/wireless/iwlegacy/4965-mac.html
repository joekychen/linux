<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › iwlegacy › 4965-mac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>4965-mac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2003 - 2011 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Portions of this file are derived from the ipw3945 project, as well</span>
<span class="cm"> * as portions of the ieee80211 subsystem header files.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> *  Intel Linux Wireless &lt;ilw@linux.intel.com&gt;</span>
<span class="cm"> * Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pci-aspm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>

<span class="cp">#include &lt;net/mac80211.h&gt;</span>

<span class="cp">#include &lt;asm/div64.h&gt;</span>

<span class="cp">#define DRV_NAME        &quot;iwl4965&quot;</span>

<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &quot;4965.h&quot;</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * module boiler plate</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="cm">/*</span>
<span class="cm"> * module name, copyright, version, etc.</span>
<span class="cm"> */</span>
<span class="cp">#define DRV_DESCRIPTION	&quot;Intel(R) Wireless WiFi 4965 driver for Linux&quot;</span>

<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
<span class="cp">#define VD &quot;d&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define VD</span>
<span class="cp">#endif</span>

<span class="cp">#define DRV_VERSION     IWLWIFI_VERSION VD</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESCRIPTION</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRV_COPYRIGHT</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;iwl4965&quot;</span><span class="p">);</span>

<span class="kt">void</span>
<span class="nf">il4965_check_abort_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u8</span> <span class="n">frame_count</span><span class="p">,</span> <span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">frame_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">==</span> <span class="n">TX_STATUS_FAIL_RFKILL_FLUSH</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Tx flush command to flush out all frames</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">tx_flush</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * EEPROM</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">il_mod_params</span> <span class="n">il4965_mod_params</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">amsdu_size_8K</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart_fw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="cm">/* the rest are 0 by default */</span>
<span class="p">};</span>

<span class="kt">void</span>
<span class="nf">il4965_rx_queue_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_queue</span> <span class="o">*</span><span class="n">rxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_free</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">);</span>
	<span class="cm">/* Fill the rx_used queue with _all_ of the Rx buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_FREE_BUFFERS</span> <span class="o">+</span> <span class="n">RX_QUEUE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* In the reset function, these buffers may have been allocated</span>
<span class="cm">		 * to an SKB, so we need to unmap and free potential storage */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page_dma</span><span class="p">,</span>
				       <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span><span class="p">,</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">__il_free_pages</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">);</span>
			<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_QUEUE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* Set us so that we have processed and used all buffers, but have</span>
<span class="cm">	 * not restocked the Rx queue with fresh buffers */</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write_actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_rx_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_queue</span> <span class="o">*</span><span class="n">rxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">rb_size</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u32</span> <span class="n">rfdnlog</span> <span class="o">=</span> <span class="n">RX_QUEUE_SIZE_LOG</span><span class="p">;</span>	<span class="cm">/* 256 RBDs */</span>
	<span class="n">u32</span> <span class="n">rb_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mod_params</span><span class="o">-&gt;</span><span class="n">amsdu_size_8K</span><span class="p">)</span>
		<span class="n">rb_size</span> <span class="o">=</span> <span class="n">FH49_RCSR_RX_CONFIG_REG_VAL_RB_SIZE_8K</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rb_size</span> <span class="o">=</span> <span class="n">FH49_RCSR_RX_CONFIG_REG_VAL_RB_SIZE_4K</span><span class="p">;</span>

	<span class="cm">/* Stop Rx DMA */</span>
	<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_MEM_RCSR_CHNL0_CONFIG_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Reset driver&#39;s Rx queue write idx */</span>
	<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_RSCSR_CHNL0_RBDCB_WPTR_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Tell device where to find RBD circular buffer in DRAM */</span>
	<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_RSCSR_CHNL0_RBDCB_BASE_REG</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">bd_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>

	<span class="cm">/* Tell device where in DRAM to update its Rx status */</span>
	<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_RSCSR_CHNL0_STTS_WPTR_REG</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rb_stts_dma</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="cm">/* Enable Rx DMA</span>
<span class="cm">	 * Direct rx interrupts to hosts</span>
<span class="cm">	 * Rx buffer size 4 or 8k</span>
<span class="cm">	 * RB timeout 0x10</span>
<span class="cm">	 * 256 RBDs</span>
<span class="cm">	 */</span>
	<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_MEM_RCSR_CHNL0_CONFIG_REG</span><span class="p">,</span>
	      <span class="n">FH49_RCSR_RX_CONFIG_CHNL_EN_ENABLE_VAL</span> <span class="o">|</span>
	      <span class="n">FH49_RCSR_CHNL0_RX_CONFIG_IRQ_DEST_INT_HOST_VAL</span> <span class="o">|</span>
	      <span class="n">FH49_RCSR_CHNL0_RX_CONFIG_SINGLE_FRAME_MSK</span> <span class="o">|</span>
	      <span class="n">rb_size</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">rb_timeout</span> <span class="o">&lt;&lt;</span> <span class="n">FH49_RCSR_RX_CONFIG_REG_IRQ_RBTH_POS</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">rfdnlog</span> <span class="o">&lt;&lt;</span> <span class="n">FH49_RCSR_RX_CONFIG_RBDCB_SIZE_POS</span><span class="p">));</span>

	<span class="cm">/* Set interrupt coalescing timer to default (2048 usecs) */</span>
	<span class="n">il_write8</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT_COALESCING</span><span class="p">,</span> <span class="n">IL_HOST_INT_TIMEOUT_DEF</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_set_pwr_vmain</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
<span class="cm">/*</span>
<span class="cm"> * (for documentation purposes)</span>
<span class="cm"> * to set power to V_AUX, do:</span>

<span class="cm">		if (pci_pme_capable(il-&gt;pci_dev, PCI_D3cold))</span>
<span class="cm">			il_set_bits_mask_prph(il, APMG_PS_CTRL_REG,</span>
<span class="cm">					       APMG_PS_CTRL_VAL_PWR_SRC_VAUX,</span>
<span class="cm">					       ~APMG_PS_CTRL_MSK_PWR_SRC);</span>
<span class="cm"> */</span>

	<span class="n">il_set_bits_mask_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">APMG_PS_CTRL_REG</span><span class="p">,</span>
			      <span class="n">APMG_PS_CTRL_VAL_PWR_SRC_VMAIN</span><span class="p">,</span>
			      <span class="o">~</span><span class="n">APMG_PS_CTRL_MSK_PWR_SRC</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_hw_nic_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il_apm_init</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="cm">/* Set interrupt coalescing calibration timer to default (512 usecs) */</span>
	<span class="n">il_write8</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT_COALESCING</span><span class="p">,</span> <span class="n">IL_HOST_INT_CALIB_TIMEOUT_DEF</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">il4965_set_pwr_vmain</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il4965_nic_config</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/* Allocate the RX queue, or reset if it is already allocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">il_rx_queue_alloc</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to initialize Rx queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">il4965_rx_queue_reset</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxq</span><span class="p">);</span>

	<span class="n">il4965_rx_replenish</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">il4965_rx_init</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxq</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">need_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">il_rx_queue_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxq</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Allocate or reset and init all Tx and Command queues */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_txq_ctx_alloc</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">il4965_txq_ctx_reset</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">S_INIT</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_dma_addr2rbd_ptr - convert a DMA address to a uCode read buffer ptr</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">__le32</span>
<span class="nf">il4965_dma_addr2rbd_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="p">(</span><span class="n">dma_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_rx_queue_restock - refill RX queue from pre-allocated pool</span>
<span class="cm"> *</span>
<span class="cm"> * If there are slots in the RX queue that need to be restocked,</span>
<span class="cm"> * and we have free pre-allocated buffers, fill the ranks as much</span>
<span class="cm"> * as we can, pulling from rx_free.</span>
<span class="cm"> *</span>
<span class="cm"> * This moves the &#39;write&#39; idx forward to catch up with &#39;processed&#39;, and</span>
<span class="cm"> * also updates the memory address in the firmware to reference the new</span>
<span class="cm"> * target buffer.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">il4965_rx_queue_restock</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">il_rx_queue_space</span><span class="p">(</span><span class="n">rxq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The overwritten rxb must be a used one */</span>
		<span class="n">rxb</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">];</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rxb</span> <span class="o">&amp;&amp;</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>

		<span class="cm">/* Get next free Rx buffer, remove from free list */</span>
		<span class="n">element</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_free</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">rxb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>

		<span class="cm">/* Point to Rx buffer via next RBD in circular buffer */</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">il4965_dma_addr2rbd_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page_dma</span><span class="p">);</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">]</span> <span class="o">=</span> <span class="n">rxb</span><span class="p">;</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RX_QUEUE_MASK</span><span class="p">;</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* If the pre-allocated buffer pool is dropping low, schedule to</span>
<span class="cm">	 * refill it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span> <span class="o">&lt;=</span> <span class="n">RX_LOW_WATERMARK</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rx_replenish</span><span class="p">);</span>

	<span class="cm">/* If we&#39;ve added more space for the firmware to place data, tell it.</span>
<span class="cm">	 * Increment device&#39;s write pointer in multiples of 8. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write_actual</span> <span class="o">!=</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">need_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">il_rx_queue_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_rx_replenish - Move all used packet from rx_used to rx_free</span>
<span class="cm"> *</span>
<span class="cm"> * When moving to rx_free an SKB is allocated for the slot.</span>
<span class="cm"> *</span>
<span class="cm"> * Also restock the Rx queue via il_rx_queue_restock.</span>
<span class="cm"> * This is called as a scheduled work item (except for during initialization)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rx_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">gfp_t</span> <span class="n">gfp_mask</span> <span class="o">=</span> <span class="n">priority</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span> <span class="o">&gt;</span> <span class="n">RX_LOW_WATERMARK</span><span class="p">)</span>
			<span class="n">gfp_mask</span> <span class="o">|=</span> <span class="n">__GFP_NOWARN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">gfp_mask</span> <span class="o">|=</span> <span class="n">__GFP_COMP</span><span class="p">;</span>

		<span class="cm">/* Alloc a new receive buffer */</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;alloc_pages failed, &quot;</span> <span class="s">&quot;order: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span> <span class="o">&lt;=</span> <span class="n">RX_LOW_WATERMARK</span> <span class="o">&amp;&amp;</span>
			    <span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Failed to alloc_pages with %s. &quot;</span>
				       <span class="s">&quot;Only %u free buffers remaining.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">priority</span> <span class="o">==</span>
				       <span class="n">GFP_ATOMIC</span> <span class="o">?</span> <span class="s">&quot;GFP_ATOMIC&quot;</span> <span class="o">:</span> <span class="s">&quot;GFP_KERNEL&quot;</span><span class="p">,</span>
				       <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="p">);</span>
			<span class="cm">/* We don&#39;t reschedule replenish work here -- we will</span>
<span class="cm">			 * call the restock method and if it still needs</span>
<span class="cm">			 * more buffers it will schedule replenish */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">__free_pages</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">element</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">rxb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">);</span>
		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
		<span class="cm">/* Get physical address of the RB */</span>
		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page_dma</span> <span class="o">=</span>
		    <span class="n">pci_map_page</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span><span class="p">,</span>
				 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="cm">/* dma address must be no more than 36 bits */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page_dma</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">36</span><span class="p">));</span>
		<span class="cm">/* and also 256 byte aligned! */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page_dma</span> <span class="o">&amp;</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">8</span><span class="p">));</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_free</span><span class="p">);</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">alloc_rxb_page</span><span class="o">++</span><span class="p">;</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_rx_replenish</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">il4965_rx_allocate</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il4965_rx_queue_restock</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_rx_replenish_now</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">il4965_rx_allocate</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="n">il4965_rx_queue_restock</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Assumes that the skb field of the buffers in &#39;pool&#39; is kept accurate.</span>
<span class="cm"> * If an SKB has been detached, the POOL needs to have its SKB set to NULL</span>
<span class="cm"> * This free routine walks the list of POOL entries and if SKB is set to</span>
<span class="cm"> * non NULL it is unmapped and freed</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">il4965_rx_queue_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_queue</span> <span class="o">*</span><span class="n">rxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_QUEUE_SIZE</span> <span class="o">+</span> <span class="n">RX_FREE_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page_dma</span><span class="p">,</span>
				       <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span><span class="p">,</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">__il_free_pages</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">);</span>
			<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">RX_QUEUE_SIZE</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">,</span>
			  <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">bd_dma</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_rb_status</span><span class="p">),</span>
			  <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rb_stts</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rb_stts_dma</span><span class="p">);</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">bd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rb_stts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_rxq_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_MEM_RCSR_CHNL0_CONFIG_REG</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">_il_poll_bit</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_MEM_RSSR_RX_STATUS_REG</span><span class="p">,</span>
			   <span class="n">FH49_RSSR_CHNL0_RX_STATUS_CHNL_IDLE</span><span class="p">,</span>
			   <span class="n">FH49_RSSR_CHNL0_RX_STATUS_CHNL_IDLE</span><span class="p">,</span>
			   <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Can&#39;t stop Rx DMA.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_hwrate_to_mac80211_idx</span><span class="p">(</span><span class="n">u32</span> <span class="n">rate_n_flags</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">band_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* HT rate format: mac80211 wants an MCS number, which is just LSB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_HT_MSK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">idx</span><span class="p">;</span>
		<span class="cm">/* Legacy rate format, search for match in table */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">band_offset</span> <span class="o">=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">band_offset</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT_LEGACY</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">il_rates</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">plcp</span> <span class="o">==</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">band_offset</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_calc_rssi</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_phy_res</span> <span class="o">*</span><span class="n">rx_resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* data from PHY/DSP regarding signal strength, etc.,</span>
<span class="cm">	 *   contents are always there, not configurable by host.  */</span>
	<span class="k">struct</span> <span class="n">il4965_rx_non_cfg_phy</span> <span class="o">*</span><span class="n">ncphy</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">il4965_rx_non_cfg_phy</span> <span class="o">*</span><span class="p">)</span><span class="n">rx_resp</span><span class="o">-&gt;</span><span class="n">non_cfg_phy_buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">agc</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ncphy</span><span class="o">-&gt;</span><span class="n">agc_info</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IL49_AGC_DB_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="n">IL49_AGC_DB_POS</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">valid_antennae</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rx_resp</span><span class="o">-&gt;</span><span class="n">phy_flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IL49_RX_PHY_FLAGS_ANTENNAE_MASK</span><span class="p">)</span>
	    <span class="o">&gt;&gt;</span> <span class="n">IL49_RX_PHY_FLAGS_ANTENNAE_OFFSET</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">max_rssi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Find max rssi among 3 possible receivers.</span>
<span class="cm">	 * These values are measured by the digital signal processor (DSP).</span>
<span class="cm">	 * They should stay fairly constant even as the signal strength varies,</span>
<span class="cm">	 *   if the radio&#39;s automatic gain control (AGC) is working right.</span>
<span class="cm">	 * AGC value (see below) will provide the &quot;interesting&quot; info. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">valid_antennae</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span>
			<span class="n">max_rssi</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">ncphy</span><span class="o">-&gt;</span><span class="n">rssi_info</span><span class="p">[</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">],</span> <span class="n">max_rssi</span><span class="p">);</span>

	<span class="n">D_STATS</span><span class="p">(</span><span class="s">&quot;Rssi In A %d B %d C %d Max %d AGC dB %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ncphy</span><span class="o">-&gt;</span><span class="n">rssi_info</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ncphy</span><span class="o">-&gt;</span><span class="n">rssi_info</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ncphy</span><span class="o">-&gt;</span><span class="n">rssi_info</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
		<span class="n">max_rssi</span><span class="p">,</span> <span class="n">agc</span><span class="p">);</span>

	<span class="cm">/* dBm = max_rssi dB - agc dB - constant.</span>
<span class="cm">	 * Higher AGC (higher radio gain) means lower signal. */</span>
	<span class="k">return</span> <span class="n">max_rssi</span> <span class="o">-</span> <span class="n">agc</span> <span class="o">-</span> <span class="n">IL4965_RSSI_OFFSET</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">il4965_translate_rx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u32</span> <span class="n">decrypt_in</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">decrypt_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">decrypt_in</span> <span class="o">&amp;</span> <span class="n">RX_RES_STATUS_STATION_FOUND</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">RX_RES_STATUS_STATION_FOUND</span><span class="p">)</span>
		<span class="n">decrypt_out</span> <span class="o">|=</span>
		    <span class="p">(</span><span class="n">RX_RES_STATUS_STATION_FOUND</span> <span class="o">|</span>
		     <span class="n">RX_RES_STATUS_NO_STATION_INFO_MISMATCH</span><span class="p">);</span>

	<span class="n">decrypt_out</span> <span class="o">|=</span> <span class="p">(</span><span class="n">decrypt_in</span> <span class="o">&amp;</span> <span class="n">RX_RES_STATUS_SEC_TYPE_MSK</span><span class="p">);</span>

	<span class="cm">/* packet was not encrypted */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">decrypt_in</span> <span class="o">&amp;</span> <span class="n">RX_RES_STATUS_SEC_TYPE_MSK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">RX_RES_STATUS_SEC_TYPE_NONE</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">decrypt_out</span><span class="p">;</span>

	<span class="cm">/* packet was encrypted with unknown alg */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">decrypt_in</span> <span class="o">&amp;</span> <span class="n">RX_RES_STATUS_SEC_TYPE_MSK</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">RX_RES_STATUS_SEC_TYPE_ERR</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">decrypt_out</span><span class="p">;</span>

	<span class="cm">/* decryption was not done in HW */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">decrypt_in</span> <span class="o">&amp;</span> <span class="n">RX_MPDU_RES_STATUS_DEC_DONE_MSK</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">RX_MPDU_RES_STATUS_DEC_DONE_MSK</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">decrypt_out</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">decrypt_in</span> <span class="o">&amp;</span> <span class="n">RX_RES_STATUS_SEC_TYPE_MSK</span><span class="p">)</span> <span class="p">{</span>

	<span class="k">case</span> <span class="n">RX_RES_STATUS_SEC_TYPE_CCMP</span>:
		<span class="cm">/* alg is CCM: check MIC only */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">decrypt_in</span> <span class="o">&amp;</span> <span class="n">RX_MPDU_RES_STATUS_MIC_OK</span><span class="p">))</span>
			<span class="cm">/* Bad MIC */</span>
			<span class="n">decrypt_out</span> <span class="o">|=</span> <span class="n">RX_RES_STATUS_BAD_ICV_MIC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">decrypt_out</span> <span class="o">|=</span> <span class="n">RX_RES_STATUS_DECRYPT_OK</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RX_RES_STATUS_SEC_TYPE_TKIP</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">decrypt_in</span> <span class="o">&amp;</span> <span class="n">RX_MPDU_RES_STATUS_TTAK_OK</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Bad TTAK */</span>
			<span class="n">decrypt_out</span> <span class="o">|=</span> <span class="n">RX_RES_STATUS_BAD_KEY_TTAK</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* fall through if TTAK OK */</span>
	<span class="nl">default:</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">decrypt_in</span> <span class="o">&amp;</span> <span class="n">RX_MPDU_RES_STATUS_ICV_OK</span><span class="p">))</span>
			<span class="n">decrypt_out</span> <span class="o">|=</span> <span class="n">RX_RES_STATUS_BAD_ICV_MIC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">decrypt_out</span> <span class="o">|=</span> <span class="n">RX_RES_STATUS_DECRYPT_OK</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_RX</span><span class="p">(</span><span class="s">&quot;decrypt_in:0x%x  decrypt_out = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">decrypt_in</span><span class="p">,</span> <span class="n">decrypt_out</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">decrypt_out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_pass_packet_to_mac80211</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			       <span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">ampdu_status</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>

	<span class="cm">/* We only process data packets if the interface is open */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">is_open</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_DROP</span><span class="p">(</span><span class="s">&quot;Dropping packet while interface is not open.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* In case of HW accelerated crypto and bad decryption, drop */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mod_params</span><span class="o">-&gt;</span><span class="n">sw_crypto</span> <span class="o">&amp;&amp;</span>
	    <span class="n">il_set_decrypted_flag</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">ampdu_status</span><span class="p">,</span> <span class="n">stats</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="mi">128</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;dev_alloc_skb failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skb_add_rx_frag</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">hdr</span> <span class="o">-</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">),</span> <span class="n">len</span><span class="p">,</span>
			<span class="n">len</span><span class="p">);</span>

	<span class="n">il_update_stats</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">IEEE80211_SKB_RXCB</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span> <span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">stats</span><span class="p">));</span>

	<span class="n">ieee80211_rx</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">alloc_rxb_page</span><span class="o">--</span><span class="p">;</span>
	<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Called for N_RX (legacy ABG frames), or</span>
<span class="cm"> * N_RX_MPDU (HT high-throughput N frames). */</span>
<span class="kt">void</span>
<span class="nf">il4965_hdl_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">header</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_rx_status</span> <span class="n">rx_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">il_rx_phy_res</span> <span class="o">*</span><span class="n">phy_res</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">rx_pkt_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_rx_mpdu_res_start</span> <span class="o">*</span><span class="n">amsdu</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ampdu_status</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate_n_flags</span><span class="p">;</span>

	<span class="cm">/**</span>
<span class="cm">	 * N_RX and N_RX_MPDU are handled differently.</span>
<span class="cm">	 *	N_RX: physical layer info is in this buffer</span>
<span class="cm">	 *	N_RX_MPDU: physical layer info was sent in separate</span>
<span class="cm">	 *		command and cached in il-&gt;last_phy_res</span>
<span class="cm">	 *</span>
<span class="cm">	 * Here we set up local variables depending on which command is</span>
<span class="cm">	 * received.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">N_RX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phy_res</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_rx_phy_res</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">;</span>
		<span class="n">header</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">phy_res</span><span class="p">)</span> <span class="o">+</span>
					     <span class="n">phy_res</span><span class="o">-&gt;</span><span class="n">cfg_phy_cnt</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">phy_res</span><span class="o">-&gt;</span><span class="n">byte_count</span><span class="p">);</span>
		<span class="n">rx_pkt_status</span> <span class="o">=</span>
		    <span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">phy_res</span><span class="p">)</span> <span class="o">+</span>
				 <span class="n">phy_res</span><span class="o">-&gt;</span><span class="n">cfg_phy_cnt</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">ampdu_status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rx_pkt_status</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">last_phy_res_valid</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;MPDU frame without cached PHY data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">phy_res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">last_phy_res</span><span class="p">;</span>
		<span class="n">amsdu</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_rx_mpdu_res_start</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">;</span>
		<span class="n">header</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">amsdu</span><span class="p">));</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">amsdu</span><span class="o">-&gt;</span><span class="n">byte_count</span><span class="p">);</span>
		<span class="n">rx_pkt_status</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">amsdu</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">ampdu_status</span> <span class="o">=</span>
		    <span class="n">il4965_translate_rx_status</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rx_pkt_status</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">unlikely</span><span class="p">(</span><span class="n">phy_res</span><span class="o">-&gt;</span><span class="n">cfg_phy_cnt</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">D_DROP</span><span class="p">(</span><span class="s">&quot;dsp size out of range [0,20]: %d/n&quot;</span><span class="p">,</span>
		       <span class="n">phy_res</span><span class="o">-&gt;</span><span class="n">cfg_phy_cnt</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx_pkt_status</span> <span class="o">&amp;</span> <span class="n">RX_RES_STATUS_NO_CRC32_ERROR</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">rx_pkt_status</span> <span class="o">&amp;</span> <span class="n">RX_RES_STATUS_NO_RXE_OVERFLOW</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_RX</span><span class="p">(</span><span class="s">&quot;Bad CRC or FIFO: 0x%08X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rx_pkt_status</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This will be used in several places later */</span>
	<span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">phy_res</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span><span class="p">);</span>

	<span class="cm">/* rx_status carries information about the packet to mac80211 */</span>
	<span class="n">rx_status</span><span class="p">.</span><span class="n">mactime</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">phy_res</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>
	<span class="n">rx_status</span><span class="p">.</span><span class="n">band</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">phy_res</span><span class="o">-&gt;</span>
	     <span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">RX_RES_PHY_FLAGS_BAND_24_MSK</span><span class="p">)</span> <span class="o">?</span> <span class="n">IEEE80211_BAND_2GHZ</span> <span class="o">:</span>
	    <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
	<span class="n">rx_status</span><span class="p">.</span><span class="n">freq</span> <span class="o">=</span>
	    <span class="n">ieee80211_channel_to_frequency</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">phy_res</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">),</span>
					   <span class="n">rx_status</span><span class="p">.</span><span class="n">band</span><span class="p">);</span>
	<span class="n">rx_status</span><span class="p">.</span><span class="n">rate_idx</span> <span class="o">=</span>
	    <span class="n">il4965_hwrate_to_mac80211_idx</span><span class="p">(</span><span class="n">rate_n_flags</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">.</span><span class="n">band</span><span class="p">);</span>
	<span class="n">rx_status</span><span class="p">.</span><span class="n">flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* TSF isn&#39;t reliable. In order to allow smooth user experience,</span>
<span class="cm">	 * this W/A doesn&#39;t propagate it to the mac80211 */</span>
	<span class="cm">/*rx_status.flag |= RX_FLAG_MACTIME_MPDU; */</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_beacon_time</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">phy_res</span><span class="o">-&gt;</span><span class="n">beacon_time_stamp</span><span class="p">);</span>

	<span class="cm">/* Find max signal strength (dBm) among 3 antenna/receiver chains */</span>
	<span class="n">rx_status</span><span class="p">.</span><span class="n">signal</span> <span class="o">=</span> <span class="n">il4965_calc_rssi</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">phy_res</span><span class="p">);</span>

	<span class="n">D_STATS</span><span class="p">(</span><span class="s">&quot;Rssi %d, TSF %llu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rx_status</span><span class="p">.</span><span class="n">signal</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rx_status</span><span class="p">.</span><span class="n">mactime</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * &quot;antenna number&quot;</span>
<span class="cm">	 *</span>
<span class="cm">	 * It seems that the antenna field in the phy flags value</span>
<span class="cm">	 * is actually a bit field. This is undefined by radiotap,</span>
<span class="cm">	 * it wants an actual antenna number but I always get &quot;7&quot;</span>
<span class="cm">	 * for most legacy frames I receive indicating that the</span>
<span class="cm">	 * same frame was received on all three RX chains.</span>
<span class="cm">	 *</span>
<span class="cm">	 * I think this field should be removed in favor of a</span>
<span class="cm">	 * new 802.11n radiotap field &quot;RX chains&quot; that is defined</span>
<span class="cm">	 * as a bitmask.</span>
<span class="cm">	 */</span>
	<span class="n">rx_status</span><span class="p">.</span><span class="n">antenna</span> <span class="o">=</span>
	    <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">phy_res</span><span class="o">-&gt;</span><span class="n">phy_flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RX_RES_PHY_FLAGS_ANTENNA_MSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
	    <span class="n">RX_RES_PHY_FLAGS_ANTENNA_POS</span><span class="p">;</span>

	<span class="cm">/* set the preamble flag if appropriate */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">phy_res</span><span class="o">-&gt;</span><span class="n">phy_flags</span> <span class="o">&amp;</span> <span class="n">RX_RES_PHY_FLAGS_SHORT_PREAMBLE_MSK</span><span class="p">)</span>
		<span class="n">rx_status</span><span class="p">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORTPRE</span><span class="p">;</span>

	<span class="cm">/* Set up the HT phy flags */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_HT_MSK</span><span class="p">)</span>
		<span class="n">rx_status</span><span class="p">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_HT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_HT40_MSK</span><span class="p">)</span>
		<span class="n">rx_status</span><span class="p">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_40MHZ</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_SGI_MSK</span><span class="p">)</span>
		<span class="n">rx_status</span><span class="p">.</span><span class="n">flag</span> <span class="o">|=</span> <span class="n">RX_FLAG_SHORT_GI</span><span class="p">;</span>

	<span class="n">il4965_pass_packet_to_mac80211</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">ampdu_status</span><span class="p">,</span> <span class="n">rxb</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">rx_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Cache phy data (Rx signal strength, etc) for HT frame (N_RX_PHY).</span>
<span class="cm"> * This will be used later in il_hdl_rx() for N_RX_MPDU. */</span>
<span class="kt">void</span>
<span class="nf">il4965_hdl_rx_phy</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">last_phy_res_valid</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">last_phy_res</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_rx_phy_res</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_get_channels_for_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			     <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span> <span class="n">u8</span> <span class="n">is_active</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">n_probes</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_scan_channel</span> <span class="o">*</span><span class="n">scan_ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">il_channel_info</span> <span class="o">*</span><span class="n">ch_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">passive_dwell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">active_dwell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">added</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">channel</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">il_get_hw_mode</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">band</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sband</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">active_dwell</span> <span class="o">=</span> <span class="n">il_get_active_dwell_time</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">n_probes</span><span class="p">);</span>
	<span class="n">passive_dwell</span> <span class="o">=</span> <span class="n">il_get_passive_dwell_time</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">passive_dwell</span> <span class="o">&lt;=</span> <span class="n">active_dwell</span><span class="p">)</span>
		<span class="n">passive_dwell</span> <span class="o">=</span> <span class="n">active_dwell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">added</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">!=</span> <span class="n">band</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">channel</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">channel</span><span class="p">);</span>

		<span class="n">ch_info</span> <span class="o">=</span> <span class="n">il_get_channel_info</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il_is_channel_valid</span><span class="p">(</span><span class="n">ch_info</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;Channel %d is INVALID for this band.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">channel</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_active</span> <span class="o">||</span> <span class="n">il_is_channel_passive</span><span class="p">(</span><span class="n">ch_info</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span><span class="p">))</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SCAN_CHANNEL_TYPE_PASSIVE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SCAN_CHANNEL_TYPE_ACTIVE</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">n_probes</span><span class="p">)</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|=</span> <span class="n">IL_SCAN_PROBE_MASK</span><span class="p">(</span><span class="n">n_probes</span><span class="p">);</span>

		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">active_dwell</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">active_dwell</span><span class="p">);</span>
		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">passive_dwell</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">passive_dwell</span><span class="p">);</span>

		<span class="cm">/* Set txpower levels to defaults */</span>
		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">dsp_atten</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>

		<span class="cm">/* NOTE: if we were doing 6Mb OFDM for scans we&#39;d use</span>
<span class="cm">		 * power level:</span>
<span class="cm">		 * scan_ch-&gt;tx_gain = ((1 &lt;&lt; 5) | (2 &lt;&lt; 3)) | 3;</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">tx_gain</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">tx_gain</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>

		<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;Scanning ch=%d prob=0x%X [%s %d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span>
		       <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">),</span>
		       <span class="p">(</span><span class="n">scan_ch</span><span class="o">-&gt;</span>
			<span class="n">type</span> <span class="o">&amp;</span> <span class="n">SCAN_CHANNEL_TYPE_ACTIVE</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ACTIVE&quot;</span> <span class="o">:</span> <span class="s">&quot;PASSIVE&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">scan_ch</span><span class="o">-&gt;</span>
			<span class="n">type</span> <span class="o">&amp;</span> <span class="n">SCAN_CHANNEL_TYPE_ACTIVE</span><span class="p">)</span> <span class="o">?</span> <span class="n">active_dwell</span> <span class="o">:</span>
		       <span class="n">passive_dwell</span><span class="p">);</span>

		<span class="n">scan_ch</span><span class="o">++</span><span class="p">;</span>
		<span class="n">added</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;total channels to scan %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">added</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">added</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_toggle_tx_ant</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">ant</span><span class="p">,</span> <span class="n">u8</span> <span class="n">valid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ind</span> <span class="o">=</span> <span class="o">*</span><span class="n">ant</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_ANT_NUM</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ind</span> <span class="o">=</span> <span class="p">(</span><span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">RATE_ANT_NUM</span> <span class="o">?</span> <span class="n">ind</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="n">ind</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">ant</span> <span class="o">=</span> <span class="n">ind</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_request_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_host_cmd</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">C_SCAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_scan_cmd</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CMD_SIZE_HUGE</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">il_scan_cmd</span> <span class="o">*</span><span class="n">scan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">cmd_len</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_chain</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">n_probes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rx_ant</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_rx_ant</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">chan_mod</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">active_chains</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">scan_tx_antennas</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_cmd</span> <span class="o">=</span>
		    <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_scan_cmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">IL_MAX_SCAN_SIZE</span><span class="p">,</span>
			    <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;fail to allocate memory for scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">scan</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_cmd</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_scan_cmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">IL_MAX_SCAN_SIZE</span><span class="p">);</span>

	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">quiet_plcp_th</span> <span class="o">=</span> <span class="n">IL_PLCP_QUIET_THRESH</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">quiet_time</span> <span class="o">=</span> <span class="n">IL_ACTIVE_QUIET_TIME</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_any_associated</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">interval</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">extra</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">suspend_time</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">scan_suspend_time</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Scanning while associated...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">interval</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">beacon_int</span><span class="p">;</span>

		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">suspend_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">max_out_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">200</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interval</span><span class="p">)</span>
			<span class="n">interval</span> <span class="o">=</span> <span class="n">suspend_time</span><span class="p">;</span>

		<span class="n">extra</span> <span class="o">=</span> <span class="p">(</span><span class="n">suspend_time</span> <span class="o">/</span> <span class="n">interval</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">22</span><span class="p">;</span>
		<span class="n">scan_suspend_time</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">extra</span> <span class="o">|</span> <span class="p">((</span><span class="n">suspend_time</span> <span class="o">%</span> <span class="n">interval</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">));</span>
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">suspend_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scan_suspend_time</span><span class="p">);</span>
		<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;suspend_time 0x%X beacon interval %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">scan_suspend_time</span><span class="p">,</span> <span class="n">interval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">n_ssids</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;Kicking off active scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">n_ssids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* always does wildcard anyway */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">scan</span><span class="o">-&gt;</span><span class="n">direct_scan</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">WLAN_EID_SSID</span><span class="p">;</span>
			<span class="n">scan</span><span class="o">-&gt;</span><span class="n">direct_scan</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span>
			    <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">direct_scan</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">ssid</span><span class="p">,</span>
			       <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">,</span>
			       <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">);</span>
			<span class="n">n_probes</span><span class="o">++</span><span class="p">;</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">is_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;Start passive scan.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">sta_id</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">bcast_id</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">stop_time</span><span class="p">.</span><span class="n">life_time</span> <span class="o">=</span> <span class="n">TX_CMD_LIFE_TIME_INFINITE</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_band</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_2GHZ</span>:
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RXON_FLG_BAND_24G_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_AUTO_DETECT_MSK</span><span class="p">;</span>
		<span class="n">chan_mod</span> <span class="o">=</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_FLG_CHANNEL_MODE_MSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
		    <span class="n">RXON_FLG_CHANNEL_MODE_POS</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan_mod</span> <span class="o">==</span> <span class="n">CHANNEL_MODE_PURE_40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">RATE_6M_PLCP</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">rate</span> <span class="o">=</span> <span class="n">RATE_1M_PLCP</span><span class="p">;</span>
			<span class="n">rate_flags</span> <span class="o">=</span> <span class="n">RATE_MCS_CCK_MSK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_5GHZ</span>:
		<span class="n">rate</span> <span class="o">=</span> <span class="n">RATE_6M_PLCP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Invalid scan band</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If active scanning is requested but a certain channel is</span>
<span class="cm">	 * marked passive, we can do active scanning if we detect</span>
<span class="cm">	 * transmissions.</span>
<span class="cm">	 *</span>
<span class="cm">	 * There is an issue with some firmware versions that triggers</span>
<span class="cm">	 * a sysassert on a &quot;good CRC threshold&quot; of zero (== disabled),</span>
<span class="cm">	 * on a radar channel even though this means that we should NOT</span>
<span class="cm">	 * send probes.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The &quot;good CRC threshold&quot; is the number of frames that we</span>
<span class="cm">	 * need to receive during our dwell time on a channel before</span>
<span class="cm">	 * sending out probes -- setting this to a huge value will</span>
<span class="cm">	 * mean we never reach it, but at the same time work around</span>
<span class="cm">	 * the aforementioned issue. Thus use IL_GOOD_CRC_TH_NEVER</span>
<span class="cm">	 * here instead of IL_GOOD_CRC_TH_DISABLED.</span>
<span class="cm">	 */</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">good_CRC_th</span> <span class="o">=</span>
	    <span class="n">is_active</span> <span class="o">?</span> <span class="n">IL_GOOD_CRC_TH_DEFAULT</span> <span class="o">:</span> <span class="n">IL_GOOD_CRC_TH_NEVER</span><span class="p">;</span>

	<span class="n">band</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_band</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">scan_rx_antennas</span><span class="p">[</span><span class="n">band</span><span class="p">])</span>
		<span class="n">rx_ant</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">scan_rx_antennas</span><span class="p">[</span><span class="n">band</span><span class="p">];</span>

	<span class="n">il4965_toggle_tx_ant</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_tx_ant</span><span class="p">[</span><span class="n">band</span><span class="p">],</span> <span class="n">scan_tx_antennas</span><span class="p">);</span>
	<span class="n">rate_flags</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_tx_ant</span><span class="p">[</span><span class="n">band</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="n">RATE_MCS_ANT_POS</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rate</span> <span class="o">|</span> <span class="n">rate_flags</span><span class="p">);</span>

	<span class="cm">/* In power save mode use one chain, otherwise use all chains */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_POWER_PMI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* rx_ant has been set to all valid chains previously */</span>
		<span class="n">active_chains</span> <span class="o">=</span>
		    <span class="n">rx_ant</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">chain_noise_data</span><span class="p">.</span><span class="n">active_chains</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">active_chains</span><span class="p">)</span>
			<span class="n">active_chains</span> <span class="o">=</span> <span class="n">rx_ant</span><span class="p">;</span>

		<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;chain_noise_data.active_chains: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">il</span><span class="o">-&gt;</span><span class="n">chain_noise_data</span><span class="p">.</span><span class="n">active_chains</span><span class="p">);</span>

		<span class="n">rx_ant</span> <span class="o">=</span> <span class="n">il4965_first_antenna</span><span class="p">(</span><span class="n">active_chains</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* MIMO is not used here, but value is required */</span>
	<span class="n">rx_chain</span> <span class="o">|=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_rx_ant</span> <span class="o">&lt;&lt;</span> <span class="n">RXON_RX_CHAIN_VALID_POS</span><span class="p">;</span>
	<span class="n">rx_chain</span> <span class="o">|=</span> <span class="n">rx_ant</span> <span class="o">&lt;&lt;</span> <span class="n">RXON_RX_CHAIN_FORCE_MIMO_SEL_POS</span><span class="p">;</span>
	<span class="n">rx_chain</span> <span class="o">|=</span> <span class="n">rx_ant</span> <span class="o">&lt;&lt;</span> <span class="n">RXON_RX_CHAIN_FORCE_SEL_POS</span><span class="p">;</span>
	<span class="n">rx_chain</span> <span class="o">|=</span> <span class="mh">0x1</span> <span class="o">&lt;&lt;</span> <span class="n">RXON_RX_CHAIN_DRIVER_FORCE_POS</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">rx_chain</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rx_chain</span><span class="p">);</span>

	<span class="n">cmd_len</span> <span class="o">=</span>
	    <span class="n">il_fill_probe_req</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			      <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">,</span>
			      <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">,</span>
			      <span class="n">IL_MAX_SCAN_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scan</span><span class="p">));</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd_len</span><span class="p">);</span>

	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">|=</span>
	    <span class="p">(</span><span class="n">RXON_FILTER_ACCEPT_GRP_MSK</span> <span class="o">|</span> <span class="n">RXON_FILTER_BCON_AWARE_MSK</span><span class="p">);</span>

	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel_count</span> <span class="o">=</span>
	    <span class="n">il4965_get_channels_for_scan</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">is_active</span><span class="p">,</span> <span class="n">n_probes</span><span class="p">,</span>
					 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">cmd_len</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;channel count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_scan_channel</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">scan</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">S_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il_send_cmd_sync</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_manage_ibss_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			   <span class="n">bool</span> <span class="n">add</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_vif_priv</span> <span class="o">*</span><span class="n">vif_priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">add</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">il4965_add_bssid_station</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">vif_priv</span><span class="o">-&gt;</span><span class="n">ibss_bssid_sta_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">il_remove_station</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">vif_priv</span><span class="o">-&gt;</span><span class="n">ibss_bssid_sta_id</span><span class="p">,</span>
				 <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_free_tfds_in_queue</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sta_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">freed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">tfds_in_queue</span> <span class="o">&gt;=</span> <span class="n">freed</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">tfds_in_queue</span> <span class="o">-=</span> <span class="n">freed</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;free more than tfds_in_queue (%u:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">tfds_in_queue</span><span class="p">,</span> <span class="n">freed</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">tfds_in_queue</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define IL_TX_QUEUE_MSK	0xfffff</span>

<span class="k">static</span> <span class="n">bool</span>
<span class="nf">il4965_is_single_rx_stream</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">.</span><span class="n">smps</span> <span class="o">==</span> <span class="n">IEEE80211_SMPS_STATIC</span> <span class="o">||</span>
	    <span class="n">il</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">.</span><span class="n">single_chain_sufficient</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IL_NUM_RX_CHAINS_MULTIPLE	3</span>
<span class="cp">#define IL_NUM_RX_CHAINS_SINGLE	2</span>
<span class="cp">#define IL_NUM_IDLE_CHAINS_DUAL	2</span>
<span class="cp">#define IL_NUM_IDLE_CHAINS_SINGLE	1</span>

<span class="cm">/*</span>
<span class="cm"> * Determine how many receiver/antenna chains to use.</span>
<span class="cm"> *</span>
<span class="cm"> * More provides better reception via diversity.  Fewer saves power</span>
<span class="cm"> * at the expense of throughput, but only when not in powersave to</span>
<span class="cm"> * start with.</span>
<span class="cm"> *</span>
<span class="cm"> * MIMO (dual stream) requires at least 2, but works better with 3.</span>
<span class="cm"> * This does not determine *which* chains to use, just how many.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_get_active_rx_chain_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* # of Rx chains to use when expecting MIMO. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il4965_is_single_rx_stream</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IL_NUM_RX_CHAINS_SINGLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">IL_NUM_RX_CHAINS_MULTIPLE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * When we are in power saving mode, unless device support spatial</span>
<span class="cm"> * multiplexing power save, use the active count for rx chain count.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_get_idle_rx_chain_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="kt">int</span> <span class="n">active_cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* # Rx chains when idling, depending on SMPS mode */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">.</span><span class="n">smps</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_SMPS_STATIC</span>:
	<span class="k">case</span> <span class="n">IEEE80211_SMPS_DYNAMIC</span>:
		<span class="k">return</span> <span class="n">IL_NUM_IDLE_CHAINS_SINGLE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_SMPS_OFF</span>:
		<span class="k">return</span> <span class="n">active_cnt</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">WARN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;invalid SMPS mode %d&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">.</span><span class="n">smps</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">active_cnt</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* up to 4 chains */</span>
<span class="k">static</span> <span class="n">u8</span>
<span class="nf">il4965_count_chain_bitmap</span><span class="p">(</span><span class="n">u32</span> <span class="n">chain_bitmap</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">res</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">=</span> <span class="p">(</span><span class="n">chain_bitmap</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">+=</span> <span class="p">(</span><span class="n">chain_bitmap</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">+=</span> <span class="p">(</span><span class="n">chain_bitmap</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">res</span> <span class="o">+=</span> <span class="p">(</span><span class="n">chain_bitmap</span> <span class="o">&amp;</span> <span class="n">BIT</span><span class="p">(</span><span class="mi">3</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_set_rxon_chain - Set up Rx chain usage in &quot;staging&quot; RXON image</span>
<span class="cm"> *</span>
<span class="cm"> * Selects how many and which Rx receivers/antennas/chains to use.</span>
<span class="cm"> * This should not be used for scan command ... it puts data in wrong place.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">il4965_set_rxon_chain</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bool</span> <span class="n">is_single</span> <span class="o">=</span> <span class="n">il4965_is_single_rx_stream</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">is_cam</span> <span class="o">=</span> <span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_POWER_PMI</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">idle_rx_cnt</span><span class="p">,</span> <span class="n">active_rx_cnt</span><span class="p">,</span> <span class="n">valid_rx_cnt</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">active_chains</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rx_chain</span><span class="p">;</span>

	<span class="cm">/* Tell uCode which antennas are actually connected.</span>
<span class="cm">	 * Before first association, we assume all antennas are connected.</span>
<span class="cm">	 * Just after first association, il4965_chain_noise_calibration()</span>
<span class="cm">	 *    checks which antennas actually *are* connected. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">chain_noise_data</span><span class="p">.</span><span class="n">active_chains</span><span class="p">)</span>
		<span class="n">active_chains</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">chain_noise_data</span><span class="p">.</span><span class="n">active_chains</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">active_chains</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_rx_ant</span><span class="p">;</span>

	<span class="n">rx_chain</span> <span class="o">=</span> <span class="n">active_chains</span> <span class="o">&lt;&lt;</span> <span class="n">RXON_RX_CHAIN_VALID_POS</span><span class="p">;</span>

	<span class="cm">/* How many receivers should we use? */</span>
	<span class="n">active_rx_cnt</span> <span class="o">=</span> <span class="n">il4965_get_active_rx_chain_count</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">idle_rx_cnt</span> <span class="o">=</span> <span class="n">il4965_get_idle_rx_chain_count</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">active_rx_cnt</span><span class="p">);</span>

	<span class="cm">/* correct rx chain count according hw settings</span>
<span class="cm">	 * and chain noise calibration</span>
<span class="cm">	 */</span>
	<span class="n">valid_rx_cnt</span> <span class="o">=</span> <span class="n">il4965_count_chain_bitmap</span><span class="p">(</span><span class="n">active_chains</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">valid_rx_cnt</span> <span class="o">&lt;</span> <span class="n">active_rx_cnt</span><span class="p">)</span>
		<span class="n">active_rx_cnt</span> <span class="o">=</span> <span class="n">valid_rx_cnt</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">valid_rx_cnt</span> <span class="o">&lt;</span> <span class="n">idle_rx_cnt</span><span class="p">)</span>
		<span class="n">idle_rx_cnt</span> <span class="o">=</span> <span class="n">valid_rx_cnt</span><span class="p">;</span>

	<span class="n">rx_chain</span> <span class="o">|=</span> <span class="n">active_rx_cnt</span> <span class="o">&lt;&lt;</span> <span class="n">RXON_RX_CHAIN_MIMO_CNT_POS</span><span class="p">;</span>
	<span class="n">rx_chain</span> <span class="o">|=</span> <span class="n">idle_rx_cnt</span> <span class="o">&lt;&lt;</span> <span class="n">RXON_RX_CHAIN_CNT_POS</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">rx_chain</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">rx_chain</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_single</span> <span class="o">&amp;&amp;</span> <span class="n">active_rx_cnt</span> <span class="o">&gt;=</span> <span class="n">IL_NUM_RX_CHAINS_SINGLE</span> <span class="o">&amp;&amp;</span> <span class="n">is_cam</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">rx_chain</span> <span class="o">|=</span> <span class="n">RXON_RX_CHAIN_MIMO_FORCE_MSK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">rx_chain</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_RX_CHAIN_MIMO_FORCE_MSK</span><span class="p">;</span>

	<span class="n">D_ASSOC</span><span class="p">(</span><span class="s">&quot;rx_chain=0x%X active=%d idle=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">rx_chain</span><span class="p">,</span>
		<span class="n">active_rx_cnt</span><span class="p">,</span> <span class="n">idle_rx_cnt</span><span class="p">);</span>

	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">active_rx_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">idle_rx_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		<span class="n">active_rx_cnt</span> <span class="o">&lt;</span> <span class="n">idle_rx_cnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">il4965_get_fh_string</span><span class="p">(</span><span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_CMD</span><span class="p">(</span><span class="n">FH49_RSCSR_CHNL0_STTS_WPTR_REG</span><span class="p">);</span>
		<span class="n">IL_CMD</span><span class="p">(</span><span class="n">FH49_RSCSR_CHNL0_RBDCB_BASE_REG</span><span class="p">);</span>
		<span class="n">IL_CMD</span><span class="p">(</span><span class="n">FH49_RSCSR_CHNL0_WPTR</span><span class="p">);</span>
		<span class="n">IL_CMD</span><span class="p">(</span><span class="n">FH49_MEM_RCSR_CHNL0_CONFIG_REG</span><span class="p">);</span>
		<span class="n">IL_CMD</span><span class="p">(</span><span class="n">FH49_MEM_RSSR_SHARED_CTRL_REG</span><span class="p">);</span>
		<span class="n">IL_CMD</span><span class="p">(</span><span class="n">FH49_MEM_RSSR_RX_STATUS_REG</span><span class="p">);</span>
		<span class="n">IL_CMD</span><span class="p">(</span><span class="n">FH49_MEM_RSSR_RX_ENABLE_ERR_IRQ2DRV</span><span class="p">);</span>
		<span class="n">IL_CMD</span><span class="p">(</span><span class="n">FH49_TSSR_TX_STATUS_REG</span><span class="p">);</span>
		<span class="n">IL_CMD</span><span class="p">(</span><span class="n">FH49_TSSR_TX_ERROR_REG</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_dump_fh</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="kt">char</span> <span class="o">**</span><span class="n">buf</span><span class="p">,</span> <span class="n">bool</span> <span class="n">display</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">bufsz</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">fh_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">FH49_RSCSR_CHNL0_STTS_WPTR_REG</span><span class="p">,</span>
		<span class="n">FH49_RSCSR_CHNL0_RBDCB_BASE_REG</span><span class="p">,</span>
		<span class="n">FH49_RSCSR_CHNL0_WPTR</span><span class="p">,</span>
		<span class="n">FH49_MEM_RCSR_CHNL0_CONFIG_REG</span><span class="p">,</span>
		<span class="n">FH49_MEM_RSSR_SHARED_CTRL_REG</span><span class="p">,</span>
		<span class="n">FH49_MEM_RSSR_RX_STATUS_REG</span><span class="p">,</span>
		<span class="n">FH49_MEM_RSSR_RX_ENABLE_ERR_IRQ2DRV</span><span class="p">,</span>
		<span class="n">FH49_TSSR_TX_STATUS_REG</span><span class="p">,</span>
		<span class="n">FH49_TSSR_TX_ERROR_REG</span>
	<span class="p">};</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">display</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bufsz</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fh_tbl</span><span class="p">)</span> <span class="o">*</span> <span class="mi">48</span> <span class="o">+</span> <span class="mi">40</span><span class="p">;</span>
		<span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">bufsz</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">pos</span> <span class="o">+=</span>
		    <span class="n">scnprintf</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">bufsz</span> <span class="o">-</span> <span class="n">pos</span><span class="p">,</span> <span class="s">&quot;FH register values:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fh_tbl</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pos</span> <span class="o">+=</span>
			    <span class="n">scnprintf</span><span class="p">(</span><span class="o">*</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="n">bufsz</span> <span class="o">-</span> <span class="n">pos</span><span class="p">,</span>
				      <span class="s">&quot;  %34s: 0X%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">il4965_get_fh_string</span><span class="p">(</span><span class="n">fh_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
				      <span class="n">il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">fh_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;FH register values:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">fh_tbl</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;  %34s: 0X%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il4965_get_fh_string</span><span class="p">(</span><span class="n">fh_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span>
		       <span class="n">il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">fh_tbl</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_hdl_missed_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">il_missed_beacon_notif</span> <span class="o">*</span><span class="n">missed_beacon</span><span class="p">;</span>

	<span class="n">missed_beacon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">missed_beacon</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">missed_beacon</span><span class="o">-&gt;</span><span class="n">consecutive_missed_beacons</span><span class="p">)</span> <span class="o">&gt;</span>
	    <span class="n">il</span><span class="o">-&gt;</span><span class="n">missed_beacon_threshold</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_CALIB</span><span class="p">(</span><span class="s">&quot;missed bcn cnsq %d totl %d rcd %d expctd %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">missed_beacon</span><span class="o">-&gt;</span><span class="n">consecutive_missed_beacons</span><span class="p">),</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">missed_beacon</span><span class="o">-&gt;</span><span class="n">total_missed_becons</span><span class="p">),</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">missed_beacon</span><span class="o">-&gt;</span><span class="n">num_recvd_beacons</span><span class="p">),</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">missed_beacon</span><span class="o">-&gt;</span><span class="n">num_expected_beacons</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
			<span class="n">il4965_init_sensitivity</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Calculate noise level, based on measurements during network silence just</span>
<span class="cm"> *   before arriving beacon.  This measurement can be done only if we know</span>
<span class="cm"> *   exactly when to expect beacons, therefore only when we&#39;re associated. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rx_calc_noise</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">stats_rx_non_phy</span> <span class="o">*</span><span class="n">rx_info</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_active_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total_silence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bcn_silence_a</span><span class="p">,</span> <span class="n">bcn_silence_b</span><span class="p">,</span> <span class="n">bcn_silence_c</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_rx_noise</span><span class="p">;</span>

	<span class="n">rx_info</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">rx</span><span class="p">.</span><span class="n">general</span><span class="p">);</span>
	<span class="n">bcn_silence_a</span> <span class="o">=</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rx_info</span><span class="o">-&gt;</span><span class="n">beacon_silence_rssi_a</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IN_BAND_FILTER</span><span class="p">;</span>
	<span class="n">bcn_silence_b</span> <span class="o">=</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rx_info</span><span class="o">-&gt;</span><span class="n">beacon_silence_rssi_b</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IN_BAND_FILTER</span><span class="p">;</span>
	<span class="n">bcn_silence_c</span> <span class="o">=</span>
	    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rx_info</span><span class="o">-&gt;</span><span class="n">beacon_silence_rssi_c</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IN_BAND_FILTER</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bcn_silence_a</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">total_silence</span> <span class="o">+=</span> <span class="n">bcn_silence_a</span><span class="p">;</span>
		<span class="n">num_active_rx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcn_silence_b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">total_silence</span> <span class="o">+=</span> <span class="n">bcn_silence_b</span><span class="p">;</span>
		<span class="n">num_active_rx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bcn_silence_c</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">total_silence</span> <span class="o">+=</span> <span class="n">bcn_silence_c</span><span class="p">;</span>
		<span class="n">num_active_rx</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Average among active antennas */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_active_rx</span><span class="p">)</span>
		<span class="n">last_rx_noise</span> <span class="o">=</span> <span class="p">(</span><span class="n">total_silence</span> <span class="o">/</span> <span class="n">num_active_rx</span><span class="p">)</span> <span class="o">-</span> <span class="mi">107</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">last_rx_noise</span> <span class="o">=</span> <span class="n">IL_NOISE_MEAS_NOT_AVAILABLE</span><span class="p">;</span>

	<span class="n">D_CALIB</span><span class="p">(</span><span class="s">&quot;inband silence a %u, b %u, c %u, dBm %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bcn_silence_a</span><span class="p">,</span>
		<span class="n">bcn_silence_b</span><span class="p">,</span> <span class="n">bcn_silence_c</span><span class="p">,</span> <span class="n">last_rx_noise</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUGFS</span>
<span class="cm">/*</span>
<span class="cm"> *  based on the assumption of all stats counter are in DWORD</span>
<span class="cm"> *  FIXME: This function is for debugging, do not deal with</span>
<span class="cm"> *  the case of counters roll-over.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_accumulative_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span> <span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">prev_stats</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">accum_stats</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">delta</span><span class="p">,</span> <span class="o">*</span><span class="n">max_delta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stats_general_common</span> <span class="o">*</span><span class="n">general</span><span class="p">,</span> <span class="o">*</span><span class="n">accum_general</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">stats_tx</span> <span class="o">*</span><span class="n">tx</span><span class="p">,</span> <span class="o">*</span><span class="n">accum_tx</span><span class="p">;</span>

	<span class="n">prev_stats</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">stats</span><span class="p">;</span>
	<span class="n">accum_stats</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">accum_stats</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_notif_stats</span><span class="p">);</span>
	<span class="n">general</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">general</span><span class="p">.</span><span class="n">common</span><span class="p">;</span>
	<span class="n">accum_general</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">accum_stats</span><span class="p">.</span><span class="n">general</span><span class="p">.</span><span class="n">common</span><span class="p">;</span>
	<span class="n">tx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">accum_tx</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">accum_stats</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">delta_stats</span><span class="p">;</span>
	<span class="n">max_delta</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">max_delta</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le32</span><span class="p">);</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">+=</span>
	     <span class="k">sizeof</span><span class="p">(</span><span class="n">__le32</span><span class="p">),</span> <span class="n">stats</span><span class="o">++</span><span class="p">,</span> <span class="n">prev_stats</span><span class="o">++</span><span class="p">,</span> <span class="n">delta</span><span class="o">++</span><span class="p">,</span> <span class="n">max_delta</span><span class="o">++</span><span class="p">,</span>
	     <span class="n">accum_stats</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">stats</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">prev_stats</span><span class="p">))</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">delta</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">stats</span><span class="p">)</span> <span class="o">-</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">prev_stats</span><span class="p">));</span>
			<span class="o">*</span><span class="n">accum_stats</span> <span class="o">+=</span> <span class="o">*</span><span class="n">delta</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">delta</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">max_delta</span><span class="p">)</span>
				<span class="o">*</span><span class="n">max_delta</span> <span class="o">=</span> <span class="o">*</span><span class="n">delta</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* reset accumulative stats for &quot;no-counter&quot; type stats */</span>
	<span class="n">accum_general</span><span class="o">-&gt;</span><span class="n">temperature</span> <span class="o">=</span> <span class="n">general</span><span class="o">-&gt;</span><span class="n">temperature</span><span class="p">;</span>
	<span class="n">accum_general</span><span class="o">-&gt;</span><span class="n">ttl_timestamp</span> <span class="o">=</span> <span class="n">general</span><span class="o">-&gt;</span><span class="n">ttl_timestamp</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="kt">void</span>
<span class="nf">il4965_hdl_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">recalib_seconds</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">change</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>

	<span class="n">D_RX</span><span class="p">(</span><span class="s">&quot;Statistics notification received (%d vs %d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_notif_stats</span><span class="p">),</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len_n_flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IL_RX_FRAME_SIZE_MSK</span><span class="p">);</span>

	<span class="n">change</span> <span class="o">=</span>
	    <span class="p">((</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">general</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">temperature</span> <span class="o">!=</span>
	      <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">general</span><span class="p">.</span><span class="n">common</span><span class="p">.</span><span class="n">temperature</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">((</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">STATS_REPLY_FLG_HT40_MODE_MSK</span><span class="p">)</span> <span class="o">!=</span>
	      <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">flag</span> <span class="o">&amp;</span> <span class="n">STATS_REPLY_FLG_HT40_MODE_MSK</span><span class="p">)));</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUGFS</span>
	<span class="n">il4965_accumulative_stats</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">stats</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* TODO: reading some of stats is unneeded */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">stats</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">stats</span><span class="p">));</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">S_STATS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Reschedule the stats timer to occur in recalib_seconds to ensure</span>
<span class="cm">	 * we get a thermal update even if the uCode doesn&#39;t give us one</span>
<span class="cm">	 */</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stats_periodic</span><span class="p">,</span>
		  <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">recalib_seconds</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">N_STATS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">il4965_rx_calc_noise</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">run_time_calib_work</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">change</span><span class="p">)</span>
		<span class="n">il4965_temperature_calib</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_hdl_c_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">flag</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">UCODE_STATS_CLEAR_MSK</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUGFS</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">accum_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_notif_stats</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">delta_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_notif_stats</span><span class="p">));</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">max_delta</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_notif_stats</span><span class="p">));</span>
<span class="cp">#endif</span>
		<span class="n">D_RX</span><span class="p">(</span><span class="s">&quot;Statistics have been cleared</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">il4965_hdl_stats</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxb</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * mac80211 queues, ACs, hardware queues, FIFOs.</span>
<span class="cm"> *</span>
<span class="cm"> * Cf. http://wireless.kernel.org/en/developers/Documentation/mac80211/queues</span>
<span class="cm"> *</span>
<span class="cm"> * Mac80211 uses the following numbers, which we get as from it</span>
<span class="cm"> * by way of skb_get_queue_mapping(skb):</span>
<span class="cm"> *</span>
<span class="cm"> *     VO      0</span>
<span class="cm"> *     VI      1</span>
<span class="cm"> *     BE      2</span>
<span class="cm"> *     BK      3</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Regular (not A-MPDU) frames are put into hardware queues corresponding</span>
<span class="cm"> * to the FIFOs, see comments in iwl-prph.h. Aggregated frames get their</span>
<span class="cm"> * own queue per aggregation session (RA/TID combination), such queues are</span>
<span class="cm"> * set up to map into FIFOs too, for which we need an AC-&gt;FIFO mapping. In</span>
<span class="cm"> * order to map frames to the right queue, we also need an AC-&gt;hw queue</span>
<span class="cm"> * mapping. This is implemented here.</span>
<span class="cm"> *</span>
<span class="cm"> * Due to the way hw queues are set up (by the hw specific modules like</span>
<span class="cm"> * 4965.c), the AC-&gt;hw queue mapping is the identity</span>
<span class="cm"> * mapping.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">tid_to_ac</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IEEE80211_AC_BE</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_BK</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_BK</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_BE</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_VI</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_VI</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_VO</span><span class="p">,</span>
	<span class="n">IEEE80211_AC_VO</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">il4965_get_ac_from_tid</span><span class="p">(</span><span class="n">u16</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">tid</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tid_to_ac</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">tid_to_ac</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

	<span class="cm">/* no support for TIDs 8-15 yet */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">il4965_get_fifo_from_tid</span><span class="p">(</span><span class="n">u16</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">ac_to_fifo</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="n">IL_TX_FIFO_VO</span><span class="p">,</span>
		<span class="n">IL_TX_FIFO_VI</span><span class="p">,</span>
		<span class="n">IL_TX_FIFO_BE</span><span class="p">,</span>
		<span class="n">IL_TX_FIFO_BK</span><span class="p">,</span>
	<span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">tid</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">tid_to_ac</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">ac_to_fifo</span><span class="p">[</span><span class="n">tid_to_ac</span><span class="p">[</span><span class="n">tid</span><span class="p">]];</span>

	<span class="cm">/* no support for TIDs 8-15 yet */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle build C_TX command notification.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_tx_cmd_build_basic</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">il_tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">std_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tx_flags</span> <span class="o">=</span> <span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span><span class="p">;</span>

	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">stop_time</span><span class="p">.</span><span class="n">life_time</span> <span class="o">=</span> <span class="n">TX_CMD_LIFE_TIME_INFINITE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_ACK_MSK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
			<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_probe_resp</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span>
			<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_TSF_MSK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">TX_CMD_FLG_ACK_MSK</span><span class="p">);</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_back_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_ACK_MSK</span> <span class="o">|</span> <span class="n">TX_CMD_FLG_IMM_BA_RSP_MASK</span><span class="p">;</span>

	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sta_id</span> <span class="o">=</span> <span class="n">std_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_MORE_FRAG_MSK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tid_tspec</span> <span class="o">=</span> <span class="n">qc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">il_tx_cmd_protection</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_flags</span><span class="p">);</span>

	<span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TX_CMD_FLG_ANT_SEL_MSK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_assoc_req</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">||</span> <span class="n">ieee80211_is_reassoc_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
			<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">pm_frame_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">pm_frame_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">pm_frame_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">driver_txop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="n">tx_flags</span><span class="p">;</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">next_frame_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_tx_cmd_build_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">__le16</span> <span class="n">fc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="n">rts_retry_limit</span> <span class="o">=</span> <span class="mi">60</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate_idx</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">data_retry_limit</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate_plcp</span><span class="p">;</span>

	<span class="cm">/* Set retry limit on DATA packets and Probe Responses */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_probe_resp</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">data_retry_limit</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">data_retry_limit</span> <span class="o">=</span> <span class="n">IL4965_DEFAULT_TX_RETRY</span><span class="p">;</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">data_retry_limit</span> <span class="o">=</span> <span class="n">data_retry_limit</span><span class="p">;</span>
	<span class="cm">/* Set retry limit on RTS packets */</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">rts_retry_limit</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">data_retry_limit</span><span class="p">,</span> <span class="n">rts_retry_limit</span><span class="p">);</span>

	<span class="cm">/* DATA packets will use the uCode station table for rate/antenna</span>
<span class="cm">	 * selection */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">initial_rate_idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_STA_RATE_MSK</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/**</span>
<span class="cm">	 * If the current TX rate stored in mac80211 has the MCS bit set, it&#39;s</span>
<span class="cm">	 * not really a TX rate.  Thus, we use the lowest supported rate for</span>
<span class="cm">	 * this band.  Also use the lowest supported rate if the stored rate</span>
<span class="cm">	 * idx is invalid.</span>
<span class="cm">	 */</span>
	<span class="n">rate_idx</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">idx</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">)</span> <span class="o">||</span> <span class="n">rate_idx</span> <span class="o">&lt;</span> <span class="mi">0</span>
	    <span class="o">||</span> <span class="n">rate_idx</span> <span class="o">&gt;</span> <span class="n">RATE_COUNT_LEGACY</span><span class="p">)</span>
		<span class="n">rate_idx</span> <span class="o">=</span>
		    <span class="n">rate_lowest_index</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">],</span>
				      <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">);</span>
	<span class="cm">/* For 5 GHZ band, remap mac80211 rate indices into driver indices */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">rate_idx</span> <span class="o">+=</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">;</span>
	<span class="cm">/* Get PLCP rate for tx_cmd-&gt;rate_n_flags */</span>
	<span class="n">rate_plcp</span> <span class="o">=</span> <span class="n">il_rates</span><span class="p">[</span><span class="n">rate_idx</span><span class="p">].</span><span class="n">plcp</span><span class="p">;</span>
	<span class="cm">/* Zero out flags for this packet */</span>
	<span class="n">rate_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set CCK flag as needed */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_idx</span> <span class="o">&gt;=</span> <span class="n">IL_FIRST_CCK_RATE</span> <span class="o">&amp;&amp;</span> <span class="n">rate_idx</span> <span class="o">&lt;=</span> <span class="n">IL_LAST_CCK_RATE</span><span class="p">)</span>
		<span class="n">rate_flags</span> <span class="o">|=</span> <span class="n">RATE_MCS_CCK_MSK</span><span class="p">;</span>

	<span class="cm">/* Set up antennas */</span>
	<span class="n">il4965_toggle_tx_ant</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mgmt_tx_ant</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">);</span>
	<span class="n">rate_flags</span> <span class="o">|=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mgmt_tx_ant</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">RATE_MCS_ANT_POS</span><span class="p">;</span>

	<span class="cm">/* Set the rate in the TX cmd */</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rate_plcp</span> <span class="o">|</span> <span class="n">rate_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_tx_cmd_build_hwcrypto</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">il_tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_frag</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sec_ctl</span> <span class="o">=</span> <span class="n">TX_CMD_SEC_CCM</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span>
			<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_AGG_CCMP_MSK</span><span class="p">;</span>
		<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;tx_cmd with AES hwcrypto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sec_ctl</span> <span class="o">=</span> <span class="n">TX_CMD_SEC_TKIP</span><span class="p">;</span>
		<span class="n">ieee80211_get_tkip_p2k</span><span class="p">(</span><span class="n">keyconf</span><span class="p">,</span> <span class="n">skb_frag</span><span class="p">,</span> <span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>
		<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;tx_cmd with tkip hwcrypto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sec_ctl</span> <span class="o">|=</span> <span class="n">TX_CMD_SEC_KEY128</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sec_ctl</span> <span class="o">|=</span>
		    <span class="p">(</span><span class="n">TX_CMD_SEC_WEP</span> <span class="o">|</span> <span class="p">(</span><span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span> <span class="o">&amp;</span> <span class="n">TX_CMD_SEC_MSK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		     <span class="n">TX_CMD_SEC_SHIFT</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>

		<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;Configuring packet for WEP encryption &quot;</span> <span class="s">&quot;with key %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unknown encode cipher %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * start C_TX command process</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">il4965_tx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_station_priv</span> <span class="o">*</span><span class="n">sta_priv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_device_cmd</span> <span class="o">*</span><span class="n">out_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_cmd_meta</span> <span class="o">*</span><span class="n">out_meta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txq_id</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">txcmd_phys</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">scratch_phys</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">firstlen</span><span class="p">,</span> <span class="n">secondlen</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">seq_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sta_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wait_write_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_agg</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_rfkill</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_DROP</span><span class="p">(</span><span class="s">&quot;Dropping - RF KILL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_auth</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;Sending AUTH frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_assoc_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;Sending ASSOC frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_reassoc_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;Sending REASSOC frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>

	<span class="cm">/* For management frames use broadcast id to do not break aggregation */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_is_data</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">sta_id</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">bcast_id</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Find idx into station table for destination station */</span>
		<span class="n">sta_id</span> <span class="o">=</span> <span class="n">il_sta_id_or_broadcast</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IL_INVALID_STATION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_DROP</span><span class="p">(</span><span class="s">&quot;Dropping - INVALID STATION: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;station Id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span>
		<span class="n">sta_priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_priv</span> <span class="o">&amp;&amp;</span> <span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">asleep</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_PS_BUFFER</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This sends an asynchronous command to the device,</span>
<span class="cm">		 * but we can rely on it being processed before the</span>
<span class="cm">		 * next frame is processed -- and the next frame to</span>
<span class="cm">		 * this station is the one that will consume this</span>
<span class="cm">		 * counter.</span>
<span class="cm">		 * For now set the counter to just 1 since we do not</span>
<span class="cm">		 * support uAPSD yet.</span>
<span class="cm">		 */</span>
		<span class="n">il4965_sta_modify_sleep_tx_count</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* FIXME: remove me ? */</span>
	<span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_SEND_AFTER_DTIM</span><span class="p">);</span>

	<span class="cm">/* Access category (AC) is also the queue number */</span>
	<span class="n">txq_id</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="cm">/* irqs already disabled/saved above when locking il-&gt;lock */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">qc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_CTL_TID_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">tid</span> <span class="o">&gt;=</span> <span class="n">MAX_TID_COUNT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">seq_number</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">seq_number</span><span class="p">;</span>
		<span class="n">seq_number</span> <span class="o">&amp;=</span> <span class="n">IEEE80211_SCTL_SEQ</span><span class="p">;</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">=</span>
		    <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">&amp;</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">IEEE80211_SCTL_FRAG</span><span class="p">);</span>
		<span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">seq_number</span><span class="p">);</span>
		<span class="n">seq_number</span> <span class="o">+=</span> <span class="mh">0x10</span><span class="p">;</span>
		<span class="cm">/* aggregation is on for this &lt;sta,tid&gt; */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span> <span class="o">&amp;&amp;</span>
		    <span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">IL_AGG_ON</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">txq_id</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">txq_id</span><span class="p">;</span>
			<span class="n">is_agg</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">];</span>
	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">il_queue_space</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">high_mark</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">tfds_in_queue</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">seq_number</span> <span class="o">=</span> <span class="n">seq_number</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">[</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">write_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* Set up first empty entry in queue&#39;s array of Tx/cmd buffers */</span>
	<span class="n">out_cmd</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">write_ptr</span><span class="p">];</span>
	<span class="n">out_meta</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">[</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">write_ptr</span><span class="p">];</span>
	<span class="n">tx_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">out_cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">tx</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">out_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_tx_cmd</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up the Tx-command (not MAC!) header.</span>
<span class="cm">	 * Store the chosen Tx queue and TFD idx within the sequence field;</span>
<span class="cm">	 * after Tx, uCode&#39;s Tx response will return this value so driver can</span>
<span class="cm">	 * locate the frame within the tx queue and do post-tx processing.</span>
<span class="cm">	 */</span>
	<span class="n">out_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">C_TX</span><span class="p">;</span>
	<span class="n">out_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">sequence</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span>
			<span class="p">(</span><span class="n">QUEUE_TO_SEQ</span><span class="p">(</span><span class="n">txq_id</span><span class="p">)</span> <span class="o">|</span> <span class="n">IDX_TO_SEQ</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">write_ptr</span><span class="p">)));</span>

	<span class="cm">/* Copy MAC header from skb into command buffer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>

	<span class="cm">/* Total # bytes to be transmitted */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="p">)</span>
		<span class="n">il4965_tx_cmd_build_hwcrypto</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">tx_cmd</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>

	<span class="cm">/* TODO need this for burst mode later on */</span>
	<span class="n">il4965_tx_cmd_build_basic</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">tx_cmd</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>

	<span class="n">il4965_tx_cmd_build_rate</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">tx_cmd</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">fc</span><span class="p">);</span>

	<span class="n">il_update_stats</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Use the first empty entry in this queue&#39;s command buffer array</span>
<span class="cm">	 * to contain the Tx command and MAC header concatenated together</span>
<span class="cm">	 * (payload data will be in another buffer).</span>
<span class="cm">	 * Size of this varies, due to varying MAC header length.</span>
<span class="cm">	 * If end is not dword aligned, we&#39;ll have 2 extra bytes at the end</span>
<span class="cm">	 * of the MAC header (device reads on dword boundaries).</span>
<span class="cm">	 * We&#39;ll tell device about this padding later.</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_tx_cmd</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_cmd_header</span><span class="p">)</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="n">firstlen</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* Tell NIC about any 2-byte padding after MAC header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">firstlen</span> <span class="o">!=</span> <span class="n">len</span><span class="p">)</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_MH_PAD_MSK</span><span class="p">;</span>

	<span class="cm">/* Physical address of this Tx command&#39;s header (not MAC header!),</span>
<span class="cm">	 * within command buffer array. */</span>
	<span class="n">txcmd_phys</span> <span class="o">=</span>
	    <span class="n">pci_map_single</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">firstlen</span><span class="p">,</span>
			   <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">out_meta</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">txcmd_phys</span><span class="p">);</span>
	<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">out_meta</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">firstlen</span><span class="p">);</span>
	<span class="cm">/* Add buffer containing Tx command and MAC(!) header to TFD&#39;s</span>
<span class="cm">	 * first entry */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">txq_attach_buf_to_tfd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">txcmd_phys</span><span class="p">,</span> <span class="n">firstlen</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">need_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wait_write_ptr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">need_update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up TFD&#39;s 2nd entry to point directly to remainder of skb,</span>
<span class="cm">	 * if any (802.11 null frames have no payload). */</span>
	<span class="n">secondlen</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">secondlen</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phys_addr</span> <span class="o">=</span>
		    <span class="n">pci_map_single</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">secondlen</span><span class="p">,</span>
				   <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">txq_attach_buf_to_tfd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="n">secondlen</span><span class="p">,</span>
					       <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">scratch_phys</span> <span class="o">=</span>
	    <span class="n">txcmd_phys</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_cmd_header</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_tx_cmd</span><span class="p">,</span> <span class="n">scratch</span><span class="p">);</span>

	<span class="cm">/* take back ownership of DMA buffer to enable update */</span>
	<span class="n">pci_dma_sync_single_for_cpu</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">txcmd_phys</span><span class="p">,</span> <span class="n">firstlen</span><span class="p">,</span>
				    <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">dram_lsb_ptr</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scratch_phys</span><span class="p">);</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">dram_msb_ptr</span> <span class="o">=</span> <span class="n">il_get_dma_hi_addr</span><span class="p">(</span><span class="n">scratch_phys</span><span class="p">);</span>

	<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;sequence nr = 0X%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">out_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">sequence</span><span class="p">));</span>
	<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;tx_flags = 0X%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span><span class="p">));</span>
	<span class="n">il_print_hex_dump</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL_DL_TX</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">tx_cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_cmd</span><span class="p">));</span>
	<span class="n">il_print_hex_dump</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL_DL_TX</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>

	<span class="cm">/* Set up entry for this TFD in Tx byte-count array */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">txq_update_byte_cnt_tbl</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>

	<span class="n">pci_dma_sync_single_for_device</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">txcmd_phys</span><span class="p">,</span> <span class="n">firstlen</span><span class="p">,</span>
				       <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="cm">/* Tell device the write idx *just past* this latest filled TFD */</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">write_ptr</span> <span class="o">=</span> <span class="n">il_queue_inc_wrap</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">write_ptr</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span><span class="p">);</span>
	<span class="n">il_txq_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * At this point the frame is &quot;transmitted&quot; successfully</span>
<span class="cm">	 * and we will get a TX status notification eventually,</span>
<span class="cm">	 * regardless of the value of ret. &quot;ret&quot; only indicates</span>
<span class="cm">	 * whether or not we should update the write pointer.</span>
<span class="cm">	 */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Avoid atomic ops if it isn&#39;t an associated client.</span>
<span class="cm">	 * Also, if this is a packet for aggregation, don&#39;t</span>
<span class="cm">	 * increase the counter because the ucode will stop</span>
<span class="cm">	 * aggregation queues when their respective station</span>
<span class="cm">	 * goes to sleep.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_priv</span> <span class="o">&amp;&amp;</span> <span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_agg</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">pending_frames</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_queue_space</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">high_mark</span> <span class="o">&amp;&amp;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_write_ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">need_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">il_txq_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">il_stop_queue</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">drop_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">il4965_alloc_dma_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_dma_ptr</span> <span class="o">*</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">addr</span> <span class="o">=</span>
	    <span class="n">dma_alloc_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">ptr</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">il4965_free_dma_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_dma_ptr</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_hw_txq_ctx_free - Free TXQ Context</span>
<span class="cm"> *</span>
<span class="cm"> * Destroy all TX DMA queues and structures</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">il4965_hw_txq_ctx_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">txq_id</span><span class="p">;</span>

	<span class="cm">/* Tx queues */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">txq_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">txq_id</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_txq_num</span><span class="p">;</span> <span class="n">txq_id</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txq_id</span> <span class="o">==</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cmd_queue</span><span class="p">)</span>
				<span class="n">il_cmd_queue_free</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">il_tx_queue_free</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">il4965_free_dma_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">kw</span><span class="p">);</span>

	<span class="n">il4965_free_dma_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scd_bc_tbls</span><span class="p">);</span>

	<span class="cm">/* free tx queue structure */</span>
	<span class="n">il_free_txq_mem</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_txq_ctx_alloc - allocate TX queue context</span>
<span class="cm"> * Allocate all Tx DMA structures and initialize them</span>
<span class="cm"> *</span>
<span class="cm"> * @param il</span>
<span class="cm"> * @return error code</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">il4965_txq_ctx_alloc</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* Free all tx/cmd queues and keep-warm buffer */</span>
	<span class="n">il4965_hw_txq_ctx_free</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span>
	    <span class="n">il4965_alloc_dma_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scd_bc_tbls</span><span class="p">,</span>
				 <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">scd_bc_tbls_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Scheduler BC Table allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_bc_tbls</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Alloc keep-warm buffer */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_alloc_dma_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">kw</span><span class="p">,</span> <span class="n">IL_KW_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Keep Warm allocation failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_kw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate tx queue structure */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">il_alloc_txq_mem</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Turn off all Tx DMA fifos */</span>
	<span class="n">il4965_txq_set_sched</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Tell NIC where to find the &quot;keep warm&quot; buffer */</span>
	<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_KW_MEM_ADDR_REG</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">kw</span><span class="p">.</span><span class="n">dma</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Alloc and init all Tx queues, including the command queue (#4/#9) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">txq_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">txq_id</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_txq_num</span><span class="p">;</span> <span class="n">txq_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">il_tx_queue_init</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Tx %d queue init failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">il4965_hw_txq_ctx_free</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il4965_free_dma_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">kw</span><span class="p">);</span>
<span class="nl">error_kw:</span>
	<span class="n">il4965_free_dma_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scd_bc_tbls</span><span class="p">);</span>
<span class="nl">error_bc_tbls:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_txq_ctx_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">txq_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Turn off all Tx DMA fifos */</span>
	<span class="n">il4965_txq_set_sched</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="cm">/* Tell NIC where to find the &quot;keep warm&quot; buffer */</span>
	<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_KW_MEM_ADDR_REG</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">kw</span><span class="p">.</span><span class="n">dma</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Alloc and init all Tx queues, including the command queue (#4) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">txq_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">txq_id</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_txq_num</span><span class="p">;</span> <span class="n">txq_id</span><span class="o">++</span><span class="p">)</span>
		<span class="n">il_tx_queue_reset</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_txq_ctx_unmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">txq_id</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* Unmap DMA from host system and free skb&#39;s */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">txq_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">txq_id</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_txq_num</span><span class="p">;</span> <span class="n">txq_id</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txq_id</span> <span class="o">==</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cmd_queue</span><span class="p">)</span>
			<span class="n">il_cmd_queue_unmap</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">il_tx_queue_unmap</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_txq_ctx_stop - Stop all Tx DMA channels</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">il4965_txq_ctx_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ch</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">_il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL49_SCD_TXFACT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Stop each Tx DMA channel, and wait for it to be idle */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ch</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">dma_chnl_num</span><span class="p">;</span> <span class="n">ch</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_TCSR_CHNL_TX_CONFIG_REG</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span>
		    <span class="n">_il_poll_bit</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_TSSR_TX_STATUS_REG</span><span class="p">,</span>
				 <span class="n">FH49_TSSR_TX_STATUS_REG_MSK_CHNL_IDLE</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span>
				 <span class="n">FH49_TSSR_TX_STATUS_REG_MSK_CHNL_IDLE</span><span class="p">(</span><span class="n">ch</span><span class="p">),</span>
				 <span class="mi">1000</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Timeout stopping DMA channel %d [0x%08x]&quot;</span><span class="p">,</span>
			       <span class="n">ch</span><span class="p">,</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_TSSR_TX_STATUS_REG</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Find first available (lowest unused) Tx Queue, mark it &quot;active&quot;.</span>
<span class="cm"> * Called only when finding queue for aggregation.</span>
<span class="cm"> * Should never return anything &lt; 7, because they should already</span>
<span class="cm"> * be in use as EDCA AC (0-3), Command (4), reserved (5, 6)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_txq_ctx_activate_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">txq_id</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">txq_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">txq_id</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_txq_num</span><span class="p">;</span> <span class="n">txq_id</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">txq_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq_ctx_active_msk</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">txq_id</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_tx_queue_stop_scheduler - Stop queue, but keep configuration</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_tx_queue_stop_scheduler</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u16</span> <span class="n">txq_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Simply stop the queue, but don&#39;t change any configuration;</span>
<span class="cm">	 * the SCD_ACT_EN bit is the write-enable mask for the ACTIVE bit. */</span>
	<span class="n">il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL49_SCD_QUEUE_STATUS_BITS</span><span class="p">(</span><span class="n">txq_id</span><span class="p">),</span>
		   <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="n">IL49_SCD_QUEUE_STTS_REG_POS_ACTIVE</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">IL49_SCD_QUEUE_STTS_REG_POS_SCD_ACT_EN</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_tx_queue_set_q2ratid - Map unique receiver/tid combination to a queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_tx_queue_set_q2ratid</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ra_tid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">txq_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tbl_dw_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">tbl_dw</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">scd_q2ratid</span><span class="p">;</span>

	<span class="n">scd_q2ratid</span> <span class="o">=</span> <span class="n">ra_tid</span> <span class="o">&amp;</span> <span class="n">IL_SCD_QUEUE_RA_TID_MAP_RATID_MSK</span><span class="p">;</span>

	<span class="n">tbl_dw_addr</span> <span class="o">=</span>
	    <span class="n">il</span><span class="o">-&gt;</span><span class="n">scd_base_addr</span> <span class="o">+</span> <span class="n">IL49_SCD_TRANSLATE_TBL_OFFSET_QUEUE</span><span class="p">(</span><span class="n">txq_id</span><span class="p">);</span>

	<span class="n">tbl_dw</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">tbl_dw_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txq_id</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
		<span class="n">tbl_dw</span> <span class="o">=</span> <span class="p">(</span><span class="n">scd_q2ratid</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">tbl_dw</span> <span class="o">&amp;</span> <span class="mh">0x0000FFFF</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tbl_dw</span> <span class="o">=</span> <span class="n">scd_q2ratid</span> <span class="o">|</span> <span class="p">(</span><span class="n">tbl_dw</span> <span class="o">&amp;</span> <span class="mh">0xFFFF0000</span><span class="p">);</span>

	<span class="n">il_write_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">tbl_dw_addr</span><span class="p">,</span> <span class="n">tbl_dw</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_tx_queue_agg_enable - Set up &amp; enable aggregation for selected queue</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE:  txq_id must be greater than IL49_FIRST_AMPDU_QUEUE,</span>
<span class="cm"> *        i.e. it must be one of the higher queues used for aggregation</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_txq_agg_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txq_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tx_fifo</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sta_id</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ssn_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ra_tid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">IL49_FIRST_AMPDU_QUEUE</span> <span class="o">&gt;</span> <span class="n">txq_id</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">IL49_FIRST_AMPDU_QUEUE</span> <span class="o">+</span>
	     <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_of_ampdu_queues</span> <span class="o">&lt;=</span> <span class="n">txq_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;queue number out of range: %d, must be %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">txq_id</span><span class="p">,</span> <span class="n">IL49_FIRST_AMPDU_QUEUE</span><span class="p">,</span>
			<span class="n">IL49_FIRST_AMPDU_QUEUE</span> <span class="o">+</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_of_ampdu_queues</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ra_tid</span> <span class="o">=</span> <span class="n">BUILD_RAxTID</span><span class="p">(</span><span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="cm">/* Modify device&#39;s station table to Tx this TID */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_sta_tx_modify_enable_tid</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Stop this Tx queue before configuring it */</span>
	<span class="n">il4965_tx_queue_stop_scheduler</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">);</span>

	<span class="cm">/* Map receiver-address / traffic-ID to this queue */</span>
	<span class="n">il4965_tx_queue_set_q2ratid</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">ra_tid</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">);</span>

	<span class="cm">/* Set this queue as a chain-building queue */</span>
	<span class="n">il_set_bits_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL49_SCD_QUEUECHAIN_SEL</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">txq_id</span><span class="p">));</span>

	<span class="cm">/* Place first TFD at idx corresponding to start sequence number.</span>
<span class="cm">	 * Assumes that ssn_idx is valid (!= 0xFFF) */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">read_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ssn_idx</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">write_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ssn_idx</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">il4965_set_wr_ptrs</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">ssn_idx</span><span class="p">);</span>

	<span class="cm">/* Set up Tx win size and frame limit for this queue */</span>
	<span class="n">il_write_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span>
			  <span class="n">il</span><span class="o">-&gt;</span><span class="n">scd_base_addr</span> <span class="o">+</span>
			  <span class="n">IL49_SCD_CONTEXT_QUEUE_OFFSET</span><span class="p">(</span><span class="n">txq_id</span><span class="p">),</span>
			  <span class="p">(</span><span class="n">SCD_WIN_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">IL49_SCD_QUEUE_CTX_REG1_WIN_SIZE_POS</span><span class="p">)</span>
			  <span class="o">&amp;</span> <span class="n">IL49_SCD_QUEUE_CTX_REG1_WIN_SIZE_MSK</span><span class="p">);</span>

	<span class="n">il_write_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span>
			  <span class="n">il</span><span class="o">-&gt;</span><span class="n">scd_base_addr</span> <span class="o">+</span>
			  <span class="n">IL49_SCD_CONTEXT_QUEUE_OFFSET</span><span class="p">(</span><span class="n">txq_id</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
			  <span class="p">(</span><span class="n">SCD_FRAME_LIMIT</span> <span class="o">&lt;&lt;</span>
			   <span class="n">IL49_SCD_QUEUE_CTX_REG2_FRAME_LIMIT_POS</span><span class="p">)</span> <span class="o">&amp;</span>
			  <span class="n">IL49_SCD_QUEUE_CTX_REG2_FRAME_LIMIT_MSK</span><span class="p">);</span>

	<span class="n">il_set_bits_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL49_SCD_INTERRUPT_MASK</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">txq_id</span><span class="p">));</span>

	<span class="cm">/* Set up Status area in SRAM, map to Tx DMA/FIFO, activate the queue */</span>
	<span class="n">il4965_tx_queue_set_status</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">],</span> <span class="n">tx_fifo</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_tx_agg_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">ssn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">sta_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tx_fifo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txq_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_tid_data</span> <span class="o">*</span><span class="n">tid_data</span><span class="p">;</span>

	<span class="cm">/* FIXME: warning if tx fifo not found ? */</span>
	<span class="n">tx_fifo</span> <span class="o">=</span> <span class="n">il4965_get_fifo_from_tid</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx_fifo</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">tx_fifo</span><span class="p">;</span>

	<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;%s on ra = %pM tid = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">il_sta_id</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IL_INVALID_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Start AGG on invalid station</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tid</span> <span class="o">&gt;=</span> <span class="n">MAX_TID_COUNT</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IL_AGG_OFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Start AGG when state is not IL_AGG_OFF !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">txq_id</span> <span class="o">=</span> <span class="n">il4965_txq_ctx_activate_free</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq_id</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;No free aggregation queue available</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tid_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
	<span class="o">*</span><span class="n">ssn</span> <span class="o">=</span> <span class="n">SEQ_TO_SN</span><span class="p">(</span><span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">seq_number</span><span class="p">);</span>
	<span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">txq_id</span> <span class="o">=</span> <span class="n">txq_id</span><span class="p">;</span>
	<span class="n">il_set_swq_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">],</span> <span class="n">il4965_get_ac_from_tid</span><span class="p">(</span><span class="n">tid</span><span class="p">),</span> <span class="n">txq_id</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_txq_agg_enable</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">tx_fifo</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="o">*</span><span class="n">ssn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">tid_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">tfds_in_queue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;HW queue is empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IL_AGG_ON</span><span class="p">;</span>
		<span class="n">ieee80211_start_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;HW queue is NOT empty: %d packets in HW queue</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">tfds_in_queue</span><span class="p">);</span>
		<span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IL_EMPTYING_HW_QUEUE_ADDBA</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * txq_id must be greater than IL49_FIRST_AMPDU_QUEUE</span>
<span class="cm"> * il-&gt;lock must be held by the caller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_txq_agg_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u16</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">u16</span> <span class="n">ssn_idx</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tx_fifo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">IL49_FIRST_AMPDU_QUEUE</span> <span class="o">&gt;</span> <span class="n">txq_id</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">IL49_FIRST_AMPDU_QUEUE</span> <span class="o">+</span>
	     <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_of_ampdu_queues</span> <span class="o">&lt;=</span> <span class="n">txq_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;queue number out of range: %d, must be %d to %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">txq_id</span><span class="p">,</span> <span class="n">IL49_FIRST_AMPDU_QUEUE</span><span class="p">,</span>
			<span class="n">IL49_FIRST_AMPDU_QUEUE</span> <span class="o">+</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_of_ampdu_queues</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">il4965_tx_queue_stop_scheduler</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">);</span>

	<span class="n">il_clear_bits_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL49_SCD_QUEUECHAIN_SEL</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">txq_id</span><span class="p">));</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">read_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ssn_idx</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">write_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="n">ssn_idx</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
	<span class="cm">/* supposes that ssn_idx is valid (!= 0xFFF) */</span>
	<span class="n">il4965_set_wr_ptrs</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">ssn_idx</span><span class="p">);</span>

	<span class="n">il_clear_bits_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL49_SCD_INTERRUPT_MASK</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">txq_id</span><span class="p">));</span>
	<span class="n">il_txq_ctx_deactivate</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">);</span>
	<span class="n">il4965_tx_queue_set_status</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">],</span> <span class="n">tx_fifo</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_tx_agg_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">tx_fifo_id</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">ssn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_tid_data</span> <span class="o">*</span><span class="n">tid_data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">write_ptr</span><span class="p">,</span> <span class="n">read_ptr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* FIXME: warning if tx_fifo_id not found ? */</span>
	<span class="n">tx_fifo_id</span> <span class="o">=</span> <span class="n">il4965_get_fifo_from_tid</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tx_fifo_id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">tx_fifo_id</span><span class="p">;</span>

	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">il_sta_id</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IL_INVALID_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Invalid station for AGG tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">tid_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>
	<span class="n">ssn</span> <span class="o">=</span> <span class="p">(</span><span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">seq_number</span> <span class="o">&amp;</span> <span class="n">IEEE80211_SCTL_SEQ</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">txq_id</span> <span class="o">=</span> <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">txq_id</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IL_EMPTYING_HW_QUEUE_ADDBA</span>:
		<span class="cm">/*</span>
<span class="cm">		 * This can happen if the peer stops aggregation</span>
<span class="cm">		 * again before we&#39;ve had a chance to drain the</span>
<span class="cm">		 * queue we selected previously, i.e. before the</span>
<span class="cm">		 * session was really started completely.</span>
<span class="cm">		 */</span>
		<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;AGG stop before setup done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">turn_off</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IL_AGG_ON</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Stopping AGG while state not ON or starting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">write_ptr</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">write_ptr</span><span class="p">;</span>
	<span class="n">read_ptr</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">].</span><span class="n">q</span><span class="p">.</span><span class="n">read_ptr</span><span class="p">;</span>

	<span class="cm">/* The queue is not empty */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">write_ptr</span> <span class="o">!=</span> <span class="n">read_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;Stopping a non empty AGG HW QUEUE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span>
		    <span class="n">IL_EMPTYING_HW_QUEUE_DELBA</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;HW queue is empty</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">turn_off:</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IL_AGG_OFF</span><span class="p">;</span>

	<span class="cm">/* do not restore/save irqs */</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * the only reason this call can fail is queue number out of range,</span>
<span class="cm">	 * which can happen if uCode is reloaded and all the station</span>
<span class="cm">	 * information are lost. if it is outside the range, there is no need</span>
<span class="cm">	 * to deactivate the uCode queue, just return &quot;success&quot; to allow</span>
<span class="cm">	 *  mac80211 to clean up it own data.</span>
<span class="cm">	 */</span>
	<span class="n">il4965_txq_agg_disable</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">ssn</span><span class="p">,</span> <span class="n">tx_fifo_id</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ieee80211_stop_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_txq_check_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">u8</span> <span class="n">tid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txq_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_tid_data</span> <span class="o">*</span><span class="n">tid_data</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">];</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IL_EMPTYING_HW_QUEUE_DELBA</span>:
		<span class="cm">/* We are reclaiming the last packet of the */</span>
		<span class="cm">/* aggregated HW queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">txq_id</span> <span class="o">==</span> <span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">txq_id</span> <span class="o">&amp;&amp;</span>
		    <span class="n">q</span><span class="o">-&gt;</span><span class="n">read_ptr</span> <span class="o">==</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">write_ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">ssn</span> <span class="o">=</span> <span class="n">SEQ_TO_SN</span><span class="p">(</span><span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">seq_number</span><span class="p">);</span>
			<span class="kt">int</span> <span class="n">tx_fifo</span> <span class="o">=</span> <span class="n">il4965_get_fifo_from_tid</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
			<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;HW queue empty: continue DELBA flow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">il4965_txq_agg_disable</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">ssn</span><span class="p">,</span> <span class="n">tx_fifo</span><span class="p">);</span>
			<span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IL_AGG_OFF</span><span class="p">;</span>
			<span class="n">ieee80211_stop_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IL_EMPTYING_HW_QUEUE_ADDBA</span>:
		<span class="cm">/* We are reclaiming the last packet of the queue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">tfds_in_queue</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;HW queue empty: continue ADDBA flow</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">tid_data</span><span class="o">-&gt;</span><span class="n">agg</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">IL_AGG_ON</span><span class="p">;</span>
			<span class="n">ieee80211_start_tx_ba_cb_irqsafe</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_non_agg_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_station_priv</span> <span class="o">*</span><span class="n">sta_priv</span><span class="p">;</span>

	<span class="n">rcu_read_lock</span><span class="p">();</span>
	<span class="n">sta</span> <span class="o">=</span> <span class="n">ieee80211_find_sta</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="n">addr1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta_priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
		<span class="cm">/* avoid atomic ops if this isn&#39;t a client */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">&amp;&amp;</span>
		    <span class="n">atomic_dec_return</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">pending_frames</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ieee80211_sta_block_awake</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rcu_read_unlock</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_tx_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="n">bool</span> <span class="n">is_agg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_agg</span><span class="p">)</span>
		<span class="n">il4965_non_agg_tx_status</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>

	<span class="n">ieee80211_tx_status_irqsafe</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_tx_queue_reclaim</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txq_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">il_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nfreed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span> <span class="o">||</span> <span class="n">il_queue_used</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Read idx for DMA queue txq id (%d), idx %d, &quot;</span>
		       <span class="s">&quot;is out of range [0-%d] %d %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span><span class="p">,</span>
		       <span class="n">q</span><span class="o">-&gt;</span><span class="n">write_ptr</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">read_ptr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">il_queue_inc_wrap</span><span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span><span class="p">);</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">read_ptr</span> <span class="o">!=</span> <span class="n">idx</span><span class="p">;</span>
	     <span class="n">q</span><span class="o">-&gt;</span><span class="n">read_ptr</span> <span class="o">=</span> <span class="n">il_queue_inc_wrap</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">read_ptr</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">skb</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">read_ptr</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span>
			<span class="n">nfreed</span><span class="o">++</span><span class="p">;</span>

		<span class="n">il4965_tx_status</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">txq_id</span> <span class="o">&gt;=</span> <span class="n">IL4965_FIRST_AMPDU_QUEUE</span><span class="p">);</span>

		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">read_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">txq_free_tfd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">nfreed</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_tx_status_reply_compressed_ba - Update tx status from block-ack</span>
<span class="cm"> *</span>
<span class="cm"> * Go through block-ack&#39;s bitmap of ACK&#39;d frames, update driver&#39;s record of</span>
<span class="cm"> * ACK vs. not.  This gets sent to mac80211, then to rate scaling algo.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_tx_status_reply_compressed_ba</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_ht_agg</span> <span class="o">*</span><span class="n">agg</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">il_compressed_ba_resp</span> <span class="o">*</span><span class="n">ba_resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="n">ack</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">seq_ctl</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">scd_flow</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">scd_flow</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">successes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bitmap</span><span class="p">,</span> <span class="n">sent_bitmap</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">wait_for_ba</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">))</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Received BA when not expected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Mark that the expected block-ack response arrived */</span>
	<span class="n">agg</span><span class="o">-&gt;</span><span class="n">wait_for_ba</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;BA %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">);</span>

	<span class="cm">/* Calculate shift to align block-ack bits with our Tx win bits */</span>
	<span class="n">sh</span> <span class="o">=</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">start_idx</span> <span class="o">-</span> <span class="n">SEQ_TO_IDX</span><span class="p">(</span><span class="n">seq_ctl</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>		<span class="cm">/* tbw something is wrong with indices */</span>
		<span class="n">sh</span> <span class="o">+=</span> <span class="mh">0x100</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">64</span> <span class="o">-</span> <span class="n">sh</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;more frames than bitmap size&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* don&#39;t use 64-bit values for now */</span>
	<span class="n">bitmap</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">sh</span><span class="p">;</span>

	<span class="cm">/* check for success or failure according to the</span>
<span class="cm">	 * transmitted bitmap and block-ack bitmap */</span>
	<span class="n">sent_bitmap</span> <span class="o">=</span> <span class="n">bitmap</span> <span class="o">&amp;</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">;</span>

	<span class="cm">/* For each frame attempted in aggregation,</span>
<span class="cm">	 * update driver&#39;s record of tx frame&#39;s status. */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">sent_bitmap</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ack</span> <span class="o">=</span> <span class="n">sent_bitmap</span> <span class="o">&amp;</span> <span class="mi">1ULL</span><span class="p">;</span>
		<span class="n">successes</span> <span class="o">+=</span> <span class="n">ack</span><span class="p">;</span>
		<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;%s ON i=%d idx=%d raw=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ack</span> <span class="o">?</span> <span class="s">&quot;ACK&quot;</span> <span class="o">:</span> <span class="s">&quot;NACK&quot;</span><span class="p">,</span>
			   <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">start_idx</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">sent_bitmap</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;Bitmap %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bitmap</span><span class="p">);</span>

	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">scd_flow</span><span class="p">].</span><span class="n">skbs</span><span class="p">[</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">start_idx</span><span class="p">]);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_AMPDU</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_ack_len</span> <span class="o">=</span> <span class="n">successes</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">ampdu_len</span> <span class="o">=</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">;</span>
	<span class="n">il4965_hwrate_to_tx_control</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span>
<span class="nf">il4965_is_tx_success</span><span class="p">(</span><span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">TX_STATUS_MSK</span><span class="p">;</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">TX_STATUS_SUCCESS</span> <span class="o">||</span> <span class="n">status</span> <span class="o">==</span> <span class="n">TX_STATUS_DIRECT_DONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span>
<span class="nf">il4965_find_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">IL_INVALID_STATION</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">)</span>
		<span class="n">start</span> <span class="o">=</span> <span class="n">IL_STA_ID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">bcast_id</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_stations</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">used</span> <span class="o">&amp;&amp;</span>
		    <span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">addr</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="n">D_ASSOC</span><span class="p">(</span><span class="s">&quot;can not find STA %pM total %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">num_stations</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="cm">/*</span>
<span class="cm">	 * It may be possible that more commands interacting with stations</span>
<span class="cm">	 * arrive before we completed processing the adding of</span>
<span class="cm">	 * station</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">IL_INVALID_STATION</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">ret</span><span class="p">].</span><span class="n">used</span> <span class="o">&amp;</span> <span class="n">IL_STA_UCODE_ACTIVE</span><span class="p">)</span> <span class="o">||</span>
	     <span class="p">((</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">ret</span><span class="p">].</span><span class="n">used</span> <span class="o">&amp;</span> <span class="n">IL_STA_UCODE_ACTIVE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	      <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">ret</span><span class="p">].</span><span class="n">used</span> <span class="o">&amp;</span> <span class="n">IL_STA_UCODE_INPROGRESS</span><span class="p">))))</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Requested station info for sta %d before ready.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">IL_INVALID_STATION</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_get_ra_sta_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IL_AP_ID</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">da</span> <span class="o">=</span> <span class="n">ieee80211_get_DA</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">il4965_find_station</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">da</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span>
<span class="nf">il4965_get_scd_ssn</span><span class="p">(</span><span class="k">struct</span> <span class="n">il4965_tx_resp</span> <span class="o">*</span><span class="n">tx_resp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">le32_to_cpup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status</span> <span class="o">+</span> <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">MAX_SN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span>
<span class="nf">il4965_tx_status_to_mac80211</span><span class="p">(</span><span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">status</span> <span class="o">&amp;=</span> <span class="n">TX_STATUS_MSK</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TX_STATUS_SUCCESS</span>:
	<span class="k">case</span> <span class="n">TX_STATUS_DIRECT_DONE</span>:
		<span class="k">return</span> <span class="n">IEEE80211_TX_STAT_ACK</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">TX_STATUS_FAIL_DEST_PS</span>:
		<span class="k">return</span> <span class="n">IEEE80211_TX_STAT_TX_FILTERED</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_tx_status_reply_tx - Handle Tx response for frames in aggregation queue</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_tx_status_reply_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_ht_agg</span> <span class="o">*</span><span class="n">agg</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">il4965_tx_resp</span> <span class="o">*</span><span class="n">tx_resp</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txq_id</span><span class="p">,</span>
			  <span class="n">u16</span> <span class="n">start_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">agg_tx_status</span> <span class="o">*</span><span class="n">frame_status</span> <span class="o">=</span> <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">agg_status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">sh</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">seq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">wait_for_ba</span><span class="p">)</span>
		<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;got tx response w/o block-ack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">agg</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">=</span> <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">;</span>
	<span class="n">agg</span><span class="o">-&gt;</span><span class="n">start_idx</span> <span class="o">=</span> <span class="n">start_idx</span><span class="p">;</span>
	<span class="n">agg</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">rate_n_flags</span><span class="p">;</span>
	<span class="n">agg</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* num frames attempted by Tx command */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Only one frame was attempted; no block-ack will arrive */</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">frame_status</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
		<span class="n">idx</span> <span class="o">=</span> <span class="n">start_idx</span><span class="p">;</span>

		<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;FrameCnt = %d, StartIdx=%d idx=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">agg</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">,</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">start_idx</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

		<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">].</span><span class="n">skbs</span><span class="p">[</span><span class="n">idx</span><span class="p">]);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">failure_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_TX_CTL_AMPDU</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">il4965_tx_status_to_mac80211</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="n">il4965_hwrate_to_tx_control</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rate_n_flags</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>

		<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;1 Frame 0x%x failure :%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span>
			   <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">failure_frame</span><span class="p">);</span>
		<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;Rate Info rate_n_flags=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rate_n_flags</span><span class="p">);</span>

		<span class="n">agg</span><span class="o">-&gt;</span><span class="n">wait_for_ba</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Two or more frames were attempted; expect block-ack */</span>
		<span class="n">u64</span> <span class="n">bitmap</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">start</span> <span class="o">=</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">start_idx</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

		<span class="cm">/* Construct bit-map of pending frames within Tx win */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">sc</span><span class="p">;</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">frame_status</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="p">);</span>
			<span class="n">seq</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">frame_status</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">sequence</span><span class="p">);</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">SEQ_TO_IDX</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>
			<span class="n">txq_id</span> <span class="o">=</span> <span class="n">SEQ_TO_QUEUE</span><span class="p">(</span><span class="n">seq</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span>
			    <span class="p">(</span><span class="n">AGG_TX_STATE_FEW_BYTES_MSK</span> <span class="o">|</span>
			     <span class="n">AGG_TX_STATE_ABORT_MSK</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;FrameCnt = %d, txq_id=%d idx=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">agg</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

			<span class="n">skb</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">].</span><span class="n">skbs</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

			<span class="n">sc</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="p">(</span><span class="n">SEQ_TO_SN</span><span class="p">(</span><span class="n">sc</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;BUG_ON idx doesn&#39;t match seq control&quot;</span>
				       <span class="s">&quot; idx=%d, seq_idx=%d, seq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
				       <span class="n">SEQ_TO_SN</span><span class="p">(</span><span class="n">sc</span><span class="p">),</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;AGG Frame i=%d idx %d seq=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
				   <span class="n">SEQ_TO_SN</span><span class="p">(</span><span class="n">sc</span><span class="p">));</span>

			<span class="n">sh</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">-</span> <span class="n">start</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sh</span> <span class="o">&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sh</span> <span class="o">=</span> <span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="mh">0xff</span><span class="p">;</span>
				<span class="n">bitmap</span> <span class="o">=</span> <span class="n">bitmap</span> <span class="o">&lt;&lt;</span> <span class="n">sh</span><span class="p">;</span>
				<span class="n">sh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">start</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sh</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">64</span><span class="p">)</span>
				<span class="n">sh</span> <span class="o">=</span> <span class="mh">0xff</span> <span class="o">-</span> <span class="p">(</span><span class="n">start</span> <span class="o">-</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sh</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sh</span> <span class="o">=</span> <span class="n">start</span> <span class="o">-</span> <span class="n">idx</span><span class="p">;</span>
				<span class="n">start</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>
				<span class="n">bitmap</span> <span class="o">=</span> <span class="n">bitmap</span> <span class="o">&lt;&lt;</span> <span class="n">sh</span><span class="p">;</span>
				<span class="n">sh</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">bitmap</span> <span class="o">|=</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">sh</span><span class="p">;</span>
			<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;start=%d bitmap=0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">start</span><span class="p">,</span>
				   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">bitmap</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">agg</span><span class="o">-&gt;</span><span class="n">bitmap</span> <span class="o">=</span> <span class="n">bitmap</span><span class="p">;</span>
		<span class="n">agg</span><span class="o">-&gt;</span><span class="n">start_idx</span> <span class="o">=</span> <span class="n">start</span><span class="p">;</span>
		<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;Frames %d start_idx=%d bitmap=0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">agg</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">,</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">start_idx</span><span class="p">,</span>
			   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bitmap</span><span class="p">)</span>
			<span class="n">agg</span><span class="o">-&gt;</span><span class="n">wait_for_ba</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_hdl_tx - Handle standard (non-aggregation) Tx response</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_hdl_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">sequence</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">sequence</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">txq_id</span> <span class="o">=</span> <span class="n">SEQ_TO_QUEUE</span><span class="p">(</span><span class="n">sequence</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">SEQ_TO_IDX</span><span class="p">(</span><span class="n">sequence</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">il_tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il4965_tx_resp</span> <span class="o">*</span><span class="n">tx_resp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">uninitialized_var</span><span class="p">(</span><span class="n">tid</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">sta_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">freed</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">n_bd</span> <span class="o">||</span> <span class="n">il_queue_used</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Read idx for DMA queue txq_id (%d) idx %d &quot;</span>
		       <span class="s">&quot;is out of range [0-%d] %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span>
		       <span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">n_bd</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">write_ptr</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">read_ptr</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">time_stamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">read_ptr</span><span class="p">];</span>
	<span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">qc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">il4965_get_ra_sta_id</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">sched_retry</span> <span class="o">&amp;&amp;</span> <span class="n">unlikely</span><span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IL_INVALID_STATION</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Station not known</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">sched_retry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">const</span> <span class="n">u32</span> <span class="n">scd_ssn</span> <span class="o">=</span> <span class="n">il4965_get_scd_ssn</span><span class="p">(</span><span class="n">tx_resp</span><span class="p">);</span>
		<span class="k">struct</span> <span class="n">il_ht_agg</span> <span class="o">*</span><span class="n">agg</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="o">!</span><span class="n">qc</span><span class="p">);</span>

		<span class="n">agg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">;</span>

		<span class="n">il4965_tx_status_reply_tx</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">agg</span><span class="p">,</span> <span class="n">tx_resp</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

		<span class="cm">/* check if BAR is needed */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">frame_count</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">il4965_is_tx_success</span><span class="p">(</span><span class="n">status</span><span class="p">))</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_STAT_AMPDU_NO_BACK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">read_ptr</span> <span class="o">!=</span> <span class="p">(</span><span class="n">scd_ssn</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">idx</span> <span class="o">=</span> <span class="n">il_queue_dec_wrap</span><span class="p">(</span><span class="n">scd_ssn</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">n_bd</span><span class="p">);</span>
			<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;Retry scheduler reclaim scd_ssn &quot;</span>
				   <span class="s">&quot;%d idx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scd_ssn</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="n">freed</span> <span class="o">=</span> <span class="n">il4965_tx_queue_reclaim</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">qc</span><span class="p">)</span>
				<span class="n">il4965_free_tfds_in_queue</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span>
							  <span class="n">freed</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span> <span class="o">&amp;&amp;</span>
			    <span class="n">il_queue_space</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">low_mark</span> <span class="o">&amp;&amp;</span>
			    <span class="n">agg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IL_EMPTYING_HW_QUEUE_DELBA</span><span class="p">)</span>
				<span class="n">il_wake_queue</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">count</span> <span class="o">=</span> <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">failure_frame</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">il4965_tx_status_to_mac80211</span><span class="p">(</span><span class="n">status</span><span class="p">);</span>
		<span class="n">il4965_hwrate_to_tx_control</span><span class="p">(</span><span class="n">il</span><span class="p">,</span>
					    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span><span class="p">),</span>
					    <span class="n">info</span><span class="p">);</span>

		<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;TXQ %d status %s (0x%08x) &quot;</span>
			   <span class="s">&quot;rate_n_flags 0x%x retries %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span>
			   <span class="n">il4965_get_tx_fail_reason</span><span class="p">(</span><span class="n">status</span><span class="p">),</span> <span class="n">status</span><span class="p">,</span>
			   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">rate_n_flags</span><span class="p">),</span>
			   <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">failure_frame</span><span class="p">);</span>

		<span class="n">freed</span> <span class="o">=</span> <span class="n">il4965_tx_queue_reclaim</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">qc</span> <span class="o">&amp;&amp;</span> <span class="n">likely</span><span class="p">(</span><span class="n">sta_id</span> <span class="o">!=</span> <span class="n">IL_INVALID_STATION</span><span class="p">))</span>
			<span class="n">il4965_free_tfds_in_queue</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">freed</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IL_INVALID_STATION</span><span class="p">)</span>
			<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;Station not known</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span> <span class="o">&amp;&amp;</span>
		    <span class="n">il_queue_space</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">low_mark</span><span class="p">)</span>
			<span class="n">il_wake_queue</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">qc</span> <span class="o">&amp;&amp;</span> <span class="n">likely</span><span class="p">(</span><span class="n">sta_id</span> <span class="o">!=</span> <span class="n">IL_INVALID_STATION</span><span class="p">))</span>
		<span class="n">il4965_txq_check_empty</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">);</span>

	<span class="n">il4965_check_abort_status</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">tx_resp</span><span class="o">-&gt;</span><span class="n">frame_count</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * translate ucode response to mac80211 tx status control values</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">il4965_hwrate_to_tx_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rate_n_flags</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_rate</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">rates</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">.</span><span class="n">antenna</span> <span class="o">=</span>
	    <span class="p">((</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_ANT_ABC_MSK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">RATE_MCS_ANT_POS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_HT_MSK</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_MCS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_GF_MSK</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_GREEN_FIELD</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_HT40_MSK</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_40_MHZ_WIDTH</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_DUP_MSK</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_DUP_DATA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate_n_flags</span> <span class="o">&amp;</span> <span class="n">RATE_MCS_SGI_MSK</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_TX_RC_SHORT_GI</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">idx</span> <span class="o">=</span> <span class="n">il4965_hwrate_to_mac80211_idx</span><span class="p">(</span><span class="n">rate_n_flags</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_hdl_compressed_ba - Handler for N_COMPRESSED_BA</span>
<span class="cm"> *</span>
<span class="cm"> * Handles block-acknowledge notification from device, which reports success</span>
<span class="cm"> * of frames sent via aggregation.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">il4965_hdl_compressed_ba</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">il_compressed_ba_resp</span> <span class="o">*</span><span class="n">ba_resp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">compressed_ba</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_ht_agg</span> <span class="o">*</span><span class="n">agg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sta_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">tid</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* &quot;flow&quot; corresponds to Tx queue */</span>
	<span class="n">u16</span> <span class="n">scd_flow</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">scd_flow</span><span class="p">);</span>

	<span class="cm">/* &quot;ssn&quot; is start of block-ack Tx win, corresponds to idx</span>
<span class="cm">	 * (in Tx queue&#39;s circular buffer) of first TFD/frame in win */</span>
	<span class="n">u16</span> <span class="n">ba_resp_scd_ssn</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">scd_ssn</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">scd_flow</span> <span class="o">&gt;=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_txq_num</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;BUG_ON scd_flow is bigger than number of queues</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">scd_flow</span><span class="p">];</span>
	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">sta_id</span><span class="p">;</span>
	<span class="n">tid</span> <span class="o">=</span> <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">;</span>
	<span class="n">agg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">tid</span><span class="p">[</span><span class="n">tid</span><span class="p">].</span><span class="n">agg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">txq_id</span> <span class="o">!=</span> <span class="n">scd_flow</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: this is a uCode bug which need to be addressed,</span>
<span class="cm">		 * log the information and return for now!</span>
<span class="cm">		 * since it is possible happen very often and in order</span>
<span class="cm">		 * not to fill the syslog, don&#39;t enable the logging by default</span>
<span class="cm">		 */</span>
		<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;BA scd_flow %d does not match txq_id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">scd_flow</span><span class="p">,</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">txq_id</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Find idx just before block-ack win */</span>
	<span class="n">idx</span> <span class="o">=</span> <span class="n">il_queue_dec_wrap</span><span class="p">(</span><span class="n">ba_resp_scd_ssn</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">n_bd</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;N_COMPRESSED_BA [%d] Received from %pM, &quot;</span> <span class="s">&quot;sta_id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">agg</span><span class="o">-&gt;</span><span class="n">wait_for_ba</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">sta_addr_lo32</span><span class="p">,</span>
		   <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">sta_id</span><span class="p">);</span>
	<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;TID = %d, SeqCtl = %d, bitmap = 0x%llx,&quot;</span> <span class="s">&quot;scd_flow = &quot;</span>
		   <span class="s">&quot;%d, scd_ssn = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">tid</span><span class="p">,</span> <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">seq_ctl</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">),</span>
		   <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">scd_flow</span><span class="p">,</span> <span class="n">ba_resp</span><span class="o">-&gt;</span><span class="n">scd_ssn</span><span class="p">);</span>
	<span class="n">D_TX_REPLY</span><span class="p">(</span><span class="s">&quot;DAT start_idx = %d, bitmap = 0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">agg</span><span class="o">-&gt;</span><span class="n">start_idx</span><span class="p">,</span>
		   <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">agg</span><span class="o">-&gt;</span><span class="n">bitmap</span><span class="p">);</span>

	<span class="cm">/* Update driver&#39;s record of ACK vs. not for each frame in win */</span>
	<span class="n">il4965_tx_status_reply_compressed_ba</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">agg</span><span class="p">,</span> <span class="n">ba_resp</span><span class="p">);</span>

	<span class="cm">/* Release all TFDs before the SSN, i.e. all TFDs in front of</span>
<span class="cm">	 * block-ack win (we assume that they&#39;ve been successfully</span>
<span class="cm">	 * transmitted ... if not, it&#39;s too late anyway). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">read_ptr</span> <span class="o">!=</span> <span class="p">(</span><span class="n">ba_resp_scd_ssn</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* calculate mac80211 ampdu sw queue to wake */</span>
		<span class="kt">int</span> <span class="n">freed</span> <span class="o">=</span> <span class="n">il4965_tx_queue_reclaim</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">scd_flow</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
		<span class="n">il4965_free_tfds_in_queue</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">freed</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">il_queue_space</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">low_mark</span> <span class="o">&amp;&amp;</span>
		    <span class="n">il</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span> <span class="o">&amp;&amp;</span>
		    <span class="n">agg</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">IL_EMPTYING_HW_QUEUE_DELBA</span><span class="p">)</span>
			<span class="n">il_wake_queue</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>

		<span class="n">il4965_txq_check_empty</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">scd_flow</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">il4965_get_tx_fail_reason</span><span class="p">(</span><span class="n">u32</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#define TX_STATUS_FAIL(x) case TX_STATUS_FAIL_ ## x: return #x</span>
<span class="cp">#define TX_STATUS_POSTPONE(x) case TX_STATUS_POSTPONE_ ## x: return #x</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_MSK</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TX_STATUS_SUCCESS</span>:
		<span class="k">return</span> <span class="s">&quot;SUCCESS&quot;</span><span class="p">;</span>
		<span class="n">TX_STATUS_POSTPONE</span><span class="p">(</span><span class="n">DELAY</span><span class="p">);</span>
		<span class="n">TX_STATUS_POSTPONE</span><span class="p">(</span><span class="n">FEW_BYTES</span><span class="p">);</span>
		<span class="n">TX_STATUS_POSTPONE</span><span class="p">(</span><span class="n">QUIET_PERIOD</span><span class="p">);</span>
		<span class="n">TX_STATUS_POSTPONE</span><span class="p">(</span><span class="n">CALC_TTAK</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">INTERNAL_CROSSED_RETRY</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">SHORT_LIMIT</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">LONG_LIMIT</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">FIFO_UNDERRUN</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">DRAIN_FLOW</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">RFKILL_FLUSH</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">LIFE_EXPIRE</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">DEST_PS</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">HOST_ABORTED</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">BT_RETRY</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">STA_INVALID</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">FRAG_DROPPED</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">TID_DISABLE</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">FIFO_FLUSHED</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">INSUFFICIENT_CF_POLL</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">PASSIVE_NO_RX</span><span class="p">);</span>
		<span class="n">TX_STATUS_FAIL</span><span class="p">(</span><span class="n">NO_BEACON_ON_RADAR</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>

<span class="cp">#undef TX_STATUS_FAIL</span>
<span class="cp">#undef TX_STATUS_POSTPONE</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_IWLEGACY_DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">il_link_quality_cmd</span> <span class="o">*</span>
<span class="nf">il4965_sta_alloc_lq</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_link_quality_cmd</span> <span class="o">*</span><span class="n">link_cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">rate_n_flags</span><span class="p">;</span>

	<span class="n">link_cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_link_quality_cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to allocate memory for LQ cmd.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Set up the rate scaling to start at selected rate, fall back</span>
<span class="cm">	 * all the way down to 1M in IEEE order, and then spin on 1M */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RATE_6M_IDX</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">r</span> <span class="o">=</span> <span class="n">RATE_1M_IDX</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;=</span> <span class="n">IL_FIRST_CCK_RATE</span> <span class="o">&amp;&amp;</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="n">IL_LAST_CCK_RATE</span><span class="p">)</span>
		<span class="n">rate_flags</span> <span class="o">|=</span> <span class="n">RATE_MCS_CCK_MSK</span><span class="p">;</span>

	<span class="n">rate_flags</span> <span class="o">|=</span>
	    <span class="n">il4965_first_antenna</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span>
				 <span class="n">valid_tx_ant</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">RATE_MCS_ANT_POS</span><span class="p">;</span>
	<span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">il_rates</span><span class="p">[</span><span class="n">r</span><span class="p">].</span><span class="n">plcp</span> <span class="o">|</span> <span class="n">rate_flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">LINK_QUAL_MAX_RETRY_NUM</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">link_cmd</span><span class="o">-&gt;</span><span class="n">rs_table</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">rate_n_flags</span><span class="p">;</span>

	<span class="n">link_cmd</span><span class="o">-&gt;</span><span class="n">general_params</span><span class="p">.</span><span class="n">single_stream_ant_msk</span> <span class="o">=</span>
	    <span class="n">il4965_first_antenna</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">);</span>

	<span class="n">link_cmd</span><span class="o">-&gt;</span><span class="n">general_params</span><span class="p">.</span><span class="n">dual_stream_ant_msk</span> <span class="o">=</span>
	    <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">il4965_first_antenna</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span>
							       <span class="n">valid_tx_ant</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_cmd</span><span class="o">-&gt;</span><span class="n">general_params</span><span class="p">.</span><span class="n">dual_stream_ant_msk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">link_cmd</span><span class="o">-&gt;</span><span class="n">general_params</span><span class="p">.</span><span class="n">dual_stream_ant_msk</span> <span class="o">=</span> <span class="n">ANT_AB</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">il4965_num_of_ant</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">link_cmd</span><span class="o">-&gt;</span><span class="n">general_params</span><span class="p">.</span><span class="n">dual_stream_ant_msk</span> <span class="o">=</span>
		    <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">link_cmd</span><span class="o">-&gt;</span><span class="n">agg_params</span><span class="p">.</span><span class="n">agg_dis_start_th</span> <span class="o">=</span> <span class="n">LINK_QUAL_AGG_DISABLE_START_DEF</span><span class="p">;</span>
	<span class="n">link_cmd</span><span class="o">-&gt;</span><span class="n">agg_params</span><span class="p">.</span><span class="n">agg_time_limit</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">LINK_QUAL_AGG_TIME_LIMIT_DEF</span><span class="p">);</span>

	<span class="n">link_cmd</span><span class="o">-&gt;</span><span class="n">sta_id</span> <span class="o">=</span> <span class="n">sta_id</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">link_cmd</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * il4965_add_bssid_station - Add the special IBSS BSSID station</span>
<span class="cm"> *</span>
<span class="cm"> * Function sleeps.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">il4965_add_bssid_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">sta_id_r</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sta_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_link_quality_cmd</span> <span class="o">*</span><span class="n">link_cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id_r</span><span class="p">)</span>
		<span class="o">*</span><span class="n">sta_id_r</span> <span class="o">=</span> <span class="n">IL_INVALID_STATION</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il_add_station_common</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to add station %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id_r</span><span class="p">)</span>
		<span class="o">*</span><span class="n">sta_id_r</span> <span class="o">=</span> <span class="n">sta_id</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">used</span> <span class="o">|=</span> <span class="n">IL_STA_LOCAL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Set up default rate scaling table in device&#39;s station table */</span>
	<span class="n">link_cmd</span> <span class="o">=</span> <span class="n">il4965_sta_alloc_lq</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to initialize rate scaling for station %pM.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il_send_lq_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">link_cmd</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Link quality command failed (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">lq</span> <span class="o">=</span> <span class="n">link_cmd</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_static_wepkey_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">bool</span> <span class="n">send_if_empty</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buff</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_wep_cmd</span><span class="p">)</span> <span class="o">+</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_wep_key</span><span class="p">)</span> <span class="o">*</span> <span class="n">WEP_KEYS_MAX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">il_wep_cmd</span> <span class="o">*</span><span class="n">wep_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_wep_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">buff</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">cmd_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_wep_cmd</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">il_host_cmd</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">C_WEPKEY</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">wep_cmd</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CMD_SYNC</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">bool</span> <span class="n">not_empty</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">might_sleep</span><span class="p">();</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">wep_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
	       <span class="n">cmd_size</span> <span class="o">+</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_wep_key</span><span class="p">)</span> <span class="o">*</span> <span class="n">WEP_KEYS_MAX</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WEP_KEYS_MAX</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">key_size</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_size</span><span class="p">;</span>

		<span class="n">wep_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_idx</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">key_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">wep_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_offset</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="n">not_empty</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">wep_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_offset</span> <span class="o">=</span> <span class="n">WEP_INVALID_OFFSET</span><span class="p">;</span>

		<span class="n">wep_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key_size</span> <span class="o">=</span> <span class="n">key_size</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wep_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">key</span><span class="p">,</span> <span class="n">key_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">wep_cmd</span><span class="o">-&gt;</span><span class="n">global_key_type</span> <span class="o">=</span> <span class="n">WEP_KEY_WEP_TYPE</span><span class="p">;</span>
	<span class="n">wep_cmd</span><span class="o">-&gt;</span><span class="n">num_keys</span> <span class="o">=</span> <span class="n">WEP_KEYS_MAX</span><span class="p">;</span>

	<span class="n">cmd_size</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_wep_key</span><span class="p">)</span> <span class="o">*</span> <span class="n">WEP_KEYS_MAX</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cmd_size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">not_empty</span> <span class="o">||</span> <span class="n">send_if_empty</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">il_send_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_restore_default_wep_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">il4965_static_wepkey_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_remove_default_wep_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">D_WEP</span><span class="p">(</span><span class="s">&quot;Removing default WEP key: idx=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_wep_key</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_rfkill</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_WEP</span><span class="p">(</span><span class="s">&quot;Not sending C_WEPKEY command due to RFKILL.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* but keys in device are clear anyway so return success */</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_static_wepkey_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">D_WEP</span><span class="p">(</span><span class="s">&quot;Remove default WEP key: idx=%d ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_set_default_wep_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">!=</span> <span class="n">WEP_KEY_LEN_128</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">!=</span> <span class="n">WEP_KEY_LEN_64</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_WEP</span><span class="p">(</span><span class="s">&quot;Bad WEP key length %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_KEY_FLAG_GENERATE_IV</span><span class="p">;</span>
	<span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">HW_KEY_DEFAULT</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">IL_AP_ID</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">key_size</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">wep_keys</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_static_wepkey_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">D_WEP</span><span class="p">(</span><span class="s">&quot;Set default WEP key: len=%d idx=%d ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_set_wep_dynamic_key_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">key_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_addsta_cmd</span> <span class="n">sta_cmd</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IEEE80211_KEY_FLAG_GENERATE_IV</span><span class="p">;</span>

	<span class="n">key_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">STA_KEY_FLG_WEP</span> <span class="o">|</span> <span class="n">STA_KEY_FLG_MAP_KEY_MSK</span><span class="p">);</span>
	<span class="n">key_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span> <span class="o">&lt;&lt;</span> <span class="n">STA_KEY_FLG_KEYID_POS</span><span class="p">);</span>
	<span class="n">key_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STA_KEY_FLG_INVALID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span> <span class="o">==</span> <span class="n">WEP_KEY_LEN_128</span><span class="p">)</span>
		<span class="n">key_flags</span> <span class="o">|=</span> <span class="n">STA_KEY_FLG_KEY_SIZE_MSK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">bcast_id</span><span class="p">)</span>
		<span class="n">key_flags</span> <span class="o">|=</span> <span class="n">STA_KEY_MULTICAST_MSK</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">.</span><span class="n">keylen</span> <span class="o">=</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">.</span><span class="n">keyidx</span> <span class="o">=</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span>
	       <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span>
	     <span class="n">key_flags</span> <span class="o">&amp;</span> <span class="n">STA_KEY_FLG_ENCRYPT_MSK</span><span class="p">)</span> <span class="o">==</span> <span class="n">STA_KEY_FLG_NO_ENC</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_offset</span> <span class="o">=</span>
		    <span class="n">il_get_free_ucode_key_idx</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="cm">/* else, we are overriding an existing key =&gt; no need to allocated room</span>
<span class="cm">	 * in uCode. */</span>

	<span class="n">WARN</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_offset</span> <span class="o">==</span> <span class="n">WEP_INVALID_OFFSET</span><span class="p">,</span>
	     <span class="s">&quot;no space for a new key&quot;</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_flags</span> <span class="o">=</span> <span class="n">key_flags</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">modify_mask</span> <span class="o">=</span> <span class="n">STA_MODIFY_KEY_MASK</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STA_CONTROL_MODIFY_MSK</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_addsta_cmd</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">il_send_add_sta</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta_cmd</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_set_ccmp_dynamic_key_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">key_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_addsta_cmd</span> <span class="n">sta_cmd</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">key_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">STA_KEY_FLG_CCMP</span> <span class="o">|</span> <span class="n">STA_KEY_FLG_MAP_KEY_MSK</span><span class="p">);</span>
	<span class="n">key_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span> <span class="o">&lt;&lt;</span> <span class="n">STA_KEY_FLG_KEYID_POS</span><span class="p">);</span>
	<span class="n">key_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STA_KEY_FLG_INVALID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">bcast_id</span><span class="p">)</span>
		<span class="n">key_flags</span> <span class="o">|=</span> <span class="n">STA_KEY_MULTICAST_MSK</span><span class="p">;</span>

	<span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_IV</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">.</span><span class="n">keylen</span> <span class="o">=</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span>
	     <span class="n">key_flags</span> <span class="o">&amp;</span> <span class="n">STA_KEY_FLG_ENCRYPT_MSK</span><span class="p">)</span> <span class="o">==</span> <span class="n">STA_KEY_FLG_NO_ENC</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_offset</span> <span class="o">=</span>
		    <span class="n">il_get_free_ucode_key_idx</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="cm">/* else, we are overriding an existing key =&gt; no need to allocated room</span>
<span class="cm">	 * in uCode. */</span>

	<span class="n">WARN</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_offset</span> <span class="o">==</span> <span class="n">WEP_INVALID_OFFSET</span><span class="p">,</span>
	     <span class="s">&quot;no space for a new key&quot;</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_flags</span> <span class="o">=</span> <span class="n">key_flags</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">modify_mask</span> <span class="o">=</span> <span class="n">STA_MODIFY_KEY_MASK</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STA_CONTROL_MODIFY_MSK</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_addsta_cmd</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">il_send_add_sta</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta_cmd</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_set_tkip_dynamic_key_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">key_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">key_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">STA_KEY_FLG_TKIP</span> <span class="o">|</span> <span class="n">STA_KEY_FLG_MAP_KEY_MSK</span><span class="p">);</span>
	<span class="n">key_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span> <span class="o">&lt;&lt;</span> <span class="n">STA_KEY_FLG_KEYID_POS</span><span class="p">);</span>
	<span class="n">key_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STA_KEY_FLG_INVALID</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">bcast_id</span><span class="p">)</span>
		<span class="n">key_flags</span> <span class="o">|=</span> <span class="n">STA_KEY_MULTICAST_MSK</span><span class="p">;</span>

	<span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_IV</span><span class="p">;</span>
	<span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_MMIC</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">.</span><span class="n">keylen</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span>
	     <span class="n">key_flags</span> <span class="o">&amp;</span> <span class="n">STA_KEY_FLG_ENCRYPT_MSK</span><span class="p">)</span> <span class="o">==</span> <span class="n">STA_KEY_FLG_NO_ENC</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_offset</span> <span class="o">=</span>
		    <span class="n">il_get_free_ucode_key_idx</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="cm">/* else, we are overriding an existing key =&gt; no need to allocated room</span>
<span class="cm">	 * in uCode. */</span>

	<span class="n">WARN</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_offset</span> <span class="o">==</span> <span class="n">WEP_INVALID_OFFSET</span><span class="p">,</span>
	     <span class="s">&quot;no space for a new key&quot;</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_flags</span> <span class="o">=</span> <span class="n">key_flags</span><span class="p">;</span>

	<span class="cm">/* This copy is acutally not needed: we get the key with each TX */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_update_tkip_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u32</span> <span class="n">iv32</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">phase1key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">sta_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_scan_cancel</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* cancel scan failed, just live w/ bad key and rely</span>
<span class="cm">		   briefly on SW decryption */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">il_sta_id_or_broadcast</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IL_INVALID_STATION</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">tkip_rx_tsc_byte2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">iv32</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">tkip_rx_ttak</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">phase1key</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">modify_mask</span> <span class="o">=</span> <span class="n">STA_MODIFY_KEY_MASK</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STA_CONTROL_MODIFY_MSK</span><span class="p">;</span>

	<span class="n">il_send_add_sta</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">,</span> <span class="n">CMD_ASYNC</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_remove_dynamic_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">key_flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">keyidx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_addsta_cmd</span> <span class="n">sta_cmd</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">key_mapping_keys</span><span class="o">--</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">key_flags</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_flags</span><span class="p">);</span>
	<span class="n">keyidx</span> <span class="o">=</span> <span class="p">(</span><span class="n">key_flags</span> <span class="o">&gt;&gt;</span> <span class="n">STA_KEY_FLG_KEYID_POS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">;</span>

	<span class="n">D_WEP</span><span class="p">(</span><span class="s">&quot;Remove dynamic key: idx=%d sta=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span> <span class="o">!=</span> <span class="n">keyidx</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We need to remove a key with idx different that the one</span>
<span class="cm">		 * in the uCode. This means that the key we need to remove has</span>
<span class="cm">		 * been replaced by another one with different idx.</span>
<span class="cm">		 * Don&#39;t do anything and return ok</span>
<span class="cm">		 */</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_offset</span> <span class="o">==</span> <span class="n">WEP_INVALID_OFFSET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Removing wrong key %d 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">,</span>
			<span class="n">key_flags</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_and_clear_bit</span>
	    <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_offset</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_key_table</span><span class="p">))</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;idx %d not used in uCode key table.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_offset</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_hw_key</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il4965_keyinfo</span><span class="p">));</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_flags</span> <span class="o">=</span>
	    <span class="n">STA_KEY_FLG_NO_ENC</span> <span class="o">|</span> <span class="n">STA_KEY_FLG_INVALID</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_offset</span> <span class="o">=</span> <span class="n">WEP_INVALID_OFFSET</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">modify_mask</span> <span class="o">=</span> <span class="n">STA_MODIFY_KEY_MASK</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STA_CONTROL_MODIFY_MSK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_rfkill</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_WEP</span>
		    <span class="p">(</span><span class="s">&quot;Not sending C_ADD_STA command because RFKILL enabled.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_addsta_cmd</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">il_send_add_sta</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta_cmd</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_set_dynamic_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span>
		       <span class="n">u8</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">key_mapping_keys</span><span class="o">++</span><span class="p">;</span>
	<span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">HW_KEY_DYNAMIC</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">ret</span> <span class="o">=</span>
		    <span class="n">il4965_set_ccmp_dynamic_key_info</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">keyconf</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="n">ret</span> <span class="o">=</span>
		    <span class="n">il4965_set_tkip_dynamic_key_info</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">keyconf</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_set_wep_dynamic_key_info</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">keyconf</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unknown alg: %s cipher = %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_WEP</span><span class="p">(</span><span class="s">&quot;Set dynamic key: cipher=%x len=%d idx=%d sta=%d ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_alloc_bcast_station - add broadcast station into driver&#39;s station table.</span>
<span class="cm"> *</span>
<span class="cm"> * This adds the broadcast station into the driver&#39;s station table</span>
<span class="cm"> * and marks it driver active, so that it will be restored to the</span>
<span class="cm"> * device at the next best time.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">il4965_alloc_bcast_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_link_quality_cmd</span> <span class="o">*</span><span class="n">link_cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sta_id</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">il_prep_station</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">il_bcast_addr</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IL_INVALID_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to prepare broadcast station</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">used</span> <span class="o">|=</span> <span class="n">IL_STA_DRIVER_ACTIVE</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">used</span> <span class="o">|=</span> <span class="n">IL_STA_BCAST</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">link_cmd</span> <span class="o">=</span> <span class="n">il4965_sta_alloc_lq</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span>
		    <span class="p">(</span><span class="s">&quot;Unable to initialize rate scaling for bcast station.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">lq</span> <span class="o">=</span> <span class="n">link_cmd</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_update_bcast_station - update broadcast station&#39;s LQ command</span>
<span class="cm"> *</span>
<span class="cm"> * Only used by iwl4965. Placed here to have all bcast station management</span>
<span class="cm"> * code together.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_update_bcast_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_link_quality_cmd</span> <span class="o">*</span><span class="n">link_cmd</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sta_id</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">bcast_id</span><span class="p">;</span>

	<span class="n">link_cmd</span> <span class="o">=</span> <span class="n">il4965_sta_alloc_lq</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">link_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to initialize rate scaling for bcast sta.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">lq</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">lq</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Bcast sta rate scaling has not been initialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">lq</span> <span class="o">=</span> <span class="n">link_cmd</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_update_bcast_stations</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">il4965_update_bcast_station</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_sta_tx_modify_enable_tid - Enable Tx for this TID in station table</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">il4965_sta_tx_modify_enable_tid</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sta_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_addsta_cmd</span> <span class="n">sta_cmd</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Remove &quot;disable&quot; flag, to enable Tx for this TID */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">modify_mask</span> <span class="o">=</span> <span class="n">STA_MODIFY_TID_DISABLE_TX</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">tid_disable_tx</span> <span class="o">&amp;=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">tid</span><span class="p">));</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STA_CONTROL_MODIFY_MSK</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_addsta_cmd</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">il_send_add_sta</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta_cmd</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_sta_rx_agg_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">,</span>
			<span class="n">u16</span> <span class="n">ssn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sta_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_addsta_cmd</span> <span class="n">sta_cmd</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">il_sta_id</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IL_INVALID_STATION</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">station_flags_msk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">modify_mask</span> <span class="o">=</span> <span class="n">STA_MODIFY_ADDBA_TID_MSK</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">add_immediate_ba_tid</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tid</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">add_immediate_ba_ssn</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ssn</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STA_CONTROL_MODIFY_MSK</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_addsta_cmd</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">il_send_add_sta</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta_cmd</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_sta_rx_agg_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="kt">int</span> <span class="n">tid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sta_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_addsta_cmd</span> <span class="n">sta_cmd</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">il_sta_id</span><span class="p">(</span><span class="n">sta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IL_INVALID_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Invalid station for AGG tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">station_flags_msk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">modify_mask</span> <span class="o">=</span> <span class="n">STA_MODIFY_DELBA_TID_MSK</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">remove_immediate_ba_tid</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">tid</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STA_CONTROL_MODIFY_MSK</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_addsta_cmd</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">il_send_add_sta</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta_cmd</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_sta_modify_sleep_tx_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sta_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">station_flags</span> <span class="o">|=</span> <span class="n">STA_FLG_PWR_SAVE_MSK</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">station_flags_msk</span> <span class="o">=</span> <span class="n">STA_FLG_PWR_SAVE_MSK</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">modify_mask</span> <span class="o">=</span>
	    <span class="n">STA_MODIFY_SLEEP_TX_COUNT_MSK</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sleep_tx_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cnt</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STA_CONTROL_MODIFY_MSK</span><span class="p">;</span>
	<span class="n">il_send_add_sta</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">,</span> <span class="n">CMD_ASYNC</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_update_chain_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rxon_chain</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rxon_chain</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">rx_chain</span> <span class="o">!=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">rx_chain</span><span class="p">)</span>
			<span class="n">il_commit_rxon</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_clear_free_frames</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;%d frames on pre-allocated heap on clear.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">frames_count</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">free_frames</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">element</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">free_frames</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_frame</span><span class="p">,</span> <span class="n">list</span><span class="p">));</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">frames_count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">frames_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;%d frames still in use.  Did we lose one?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">frames_count</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">frames_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">il_frame</span> <span class="o">*</span>
<span class="nf">il4965_get_free_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">free_frames</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frame</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frame</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Could not allocate frame!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">il</span><span class="o">-&gt;</span><span class="n">frames_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">frame</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">element</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">free_frames</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_frame</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_free_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frame</span><span class="p">));</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">free_frames</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">il4965_fill_beacon_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">left</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Parse the beacon frame to find the TIM element and set tim_idx &amp; tim_size */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_set_beacon_tim</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">il_tx_beacon_cmd</span> <span class="o">*</span><span class="n">tx_beacon_cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span> <span class="n">beacon</span><span class="p">,</span>
		      <span class="n">u32</span> <span class="n">frame_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">tim_idx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="n">mgmt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span><span class="n">beacon</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The idx is relative to frame start but we start looking at the</span>
<span class="cm">	 * variable-length part of the beacon.</span>
<span class="cm">	 */</span>
	<span class="n">tim_idx</span> <span class="o">=</span> <span class="n">mgmt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">.</span><span class="n">variable</span> <span class="o">-</span> <span class="n">beacon</span><span class="p">;</span>

	<span class="cm">/* Parse variable-length elements of beacon to find WLAN_EID_TIM */</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">tim_idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">frame_size</span> <span class="o">-</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">beacon</span><span class="p">[</span><span class="n">tim_idx</span><span class="p">]</span> <span class="o">!=</span> <span class="n">WLAN_EID_TIM</span><span class="p">))</span>
		<span class="n">tim_idx</span> <span class="o">+=</span> <span class="n">beacon</span><span class="p">[</span><span class="n">tim_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* If TIM field was found, set variables */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tim_idx</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">frame_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">beacon</span><span class="p">[</span><span class="n">tim_idx</span><span class="p">]</span> <span class="o">==</span> <span class="n">WLAN_EID_TIM</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tx_beacon_cmd</span><span class="o">-&gt;</span><span class="n">tim_idx</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">tim_idx</span><span class="p">);</span>
		<span class="n">tx_beacon_cmd</span><span class="o">-&gt;</span><span class="n">tim_size</span> <span class="o">=</span> <span class="n">beacon</span><span class="p">[</span><span class="n">tim_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Unable to find TIM Element in beacon</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">il4965_hw_get_beacon_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_tx_beacon_cmd</span> <span class="o">*</span><span class="n">tx_beacon_cmd</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">frame_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate_flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rate</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * We have to set up the TX command, the TX Beacon command, and the</span>
<span class="cm">	 * beacon contents.</span>
<span class="cm">	 */</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Trying to build beacon without beaconing enabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize memory */</span>
	<span class="n">tx_beacon_cmd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_beacon_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_beacon_cmd</span><span class="p">));</span>

	<span class="cm">/* Set up TX beacon contents */</span>
	<span class="n">frame_size</span> <span class="o">=</span>
	    <span class="n">il4965_fill_beacon_frame</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">tx_beacon_cmd</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">,</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_beacon_cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON_ONCE</span><span class="p">(</span><span class="n">frame_size</span> <span class="o">&gt;</span> <span class="n">MAX_MPDU_SIZE</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frame_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set up TX command fields */</span>
	<span class="n">tx_beacon_cmd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span> <span class="n">frame_size</span><span class="p">);</span>
	<span class="n">tx_beacon_cmd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">sta_id</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">bcast_id</span><span class="p">;</span>
	<span class="n">tx_beacon_cmd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">stop_time</span><span class="p">.</span><span class="n">life_time</span> <span class="o">=</span> <span class="n">TX_CMD_LIFE_TIME_INFINITE</span><span class="p">;</span>
	<span class="n">tx_beacon_cmd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">=</span>
	    <span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span> <span class="o">|</span> <span class="n">TX_CMD_FLG_TSF_MSK</span> <span class="o">|</span>
	    <span class="n">TX_CMD_FLG_STA_RATE_MSK</span><span class="p">;</span>

	<span class="cm">/* Set up TX beacon command fields */</span>
	<span class="n">il4965_set_beacon_tim</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">tx_beacon_cmd</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">tx_beacon_cmd</span><span class="o">-&gt;</span><span class="n">frame</span><span class="p">,</span>
			      <span class="n">frame_size</span><span class="p">);</span>

	<span class="cm">/* Set up packet rate and flags */</span>
	<span class="n">rate</span> <span class="o">=</span> <span class="n">il_get_lowest_plcp</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il4965_toggle_tx_ant</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mgmt_tx_ant</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span><span class="p">);</span>
	<span class="n">rate_flags</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mgmt_tx_ant</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">RATE_MCS_ANT_POS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">IL_FIRST_CCK_RATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&lt;=</span> <span class="n">IL_LAST_CCK_RATE</span><span class="p">))</span>
		<span class="n">rate_flags</span> <span class="o">|=</span> <span class="n">RATE_MCS_CCK_MSK</span><span class="p">;</span>
	<span class="n">tx_beacon_cmd</span><span class="o">-&gt;</span><span class="n">tx</span><span class="p">.</span><span class="n">rate_n_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rate</span> <span class="o">|</span> <span class="n">rate_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_beacon_cmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">frame_size</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_send_beacon_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="n">il4965_get_free_frame</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frame</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Could not obtain free frame buffer for beacon &quot;</span>
		       <span class="s">&quot;command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">frame_size</span> <span class="o">=</span> <span class="n">il4965_hw_get_beacon_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frame_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Error configuring the beacon command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">il4965_free_frame</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">il_send_cmd_pdu</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">C_TX_BEACON</span><span class="p">,</span> <span class="n">frame_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">il4965_free_frame</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">dma_addr_t</span>
<span class="nf">il4965_tfd_tb_get_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_tfd</span> <span class="o">*</span><span class="n">tfd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_tfd_tb</span> <span class="o">*</span><span class="n">tb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tfd</span><span class="o">-&gt;</span><span class="n">tbs</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="n">dma_addr_t</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">lo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="n">addr</span> <span class="o">|=</span>
		    <span class="p">((</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">hi_n_len</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		    <span class="mi">16</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span>
<span class="nf">il4965_tfd_tb_get_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_tfd</span> <span class="o">*</span><span class="n">tfd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_tfd_tb</span> <span class="o">*</span><span class="n">tb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tfd</span><span class="o">-&gt;</span><span class="n">tbs</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">hi_n_len</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">il4965_tfd_set_tb</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_tfd</span> <span class="o">*</span><span class="n">tfd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idx</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_tfd_tb</span> <span class="o">*</span><span class="n">tb</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tfd</span><span class="o">-&gt;</span><span class="n">tbs</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">hi_n_len</span> <span class="o">=</span> <span class="n">len</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tb</span><span class="o">-&gt;</span><span class="n">lo</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">dma_addr_t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span>
		<span class="n">hi_n_len</span> <span class="o">|=</span> <span class="p">((</span><span class="n">addr</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xF</span><span class="p">;</span>

	<span class="n">tb</span><span class="o">-&gt;</span><span class="n">hi_n_len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">hi_n_len</span><span class="p">);</span>

	<span class="n">tfd</span><span class="o">-&gt;</span><span class="n">num_tbs</span> <span class="o">=</span> <span class="n">idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span>
<span class="nf">il4965_tfd_get_num_tbs</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_tfd</span> <span class="o">*</span><span class="n">tfd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">tfd</span><span class="o">-&gt;</span><span class="n">num_tbs</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_hw_txq_free_tfd - Free all chunks referenced by TFD [txq-&gt;q.read_ptr]</span>
<span class="cm"> * @il - driver ilate data</span>
<span class="cm"> * @txq - tx queue</span>
<span class="cm"> *</span>
<span class="cm"> * Does NOT advance any TFD circular buffer read/write idxes</span>
<span class="cm"> * Does NOT free the TFD itself (which is within circular buffer)</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">il4965_hw_txq_free_tfd</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_tfd</span> <span class="o">*</span><span class="n">tfd_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_tfd</span> <span class="o">*</span><span class="p">)</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tfds</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_tfd</span> <span class="o">*</span><span class="n">tfd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">read_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">num_tbs</span><span class="p">;</span>

	<span class="n">tfd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tfd_tmp</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>

	<span class="cm">/* Sanity check on number of chunks */</span>
	<span class="n">num_tbs</span> <span class="o">=</span> <span class="n">il4965_tfd_get_num_tbs</span><span class="p">(</span><span class="n">tfd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num_tbs</span> <span class="o">&gt;=</span> <span class="n">IL_NUM_OF_TBS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Too many chunks: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">num_tbs</span><span class="p">);</span>
		<span class="cm">/* @todo issue fatal error, it is quite serious situation */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Unmap tx_cmd */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_tbs</span><span class="p">)</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dma_unmap_addr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">mapping</span><span class="p">),</span>
				 <span class="n">dma_unmap_len</span><span class="p">(</span><span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="n">len</span><span class="p">),</span>
				 <span class="n">PCI_DMA_BIDIRECTIONAL</span><span class="p">);</span>

	<span class="cm">/* Unmap chunks, if any. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">num_tbs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">il4965_tfd_tb_get_addr</span><span class="p">(</span><span class="n">tfd</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
				 <span class="n">il4965_tfd_tb_get_len</span><span class="p">(</span><span class="n">tfd</span><span class="p">,</span> <span class="n">i</span><span class="p">),</span>
				 <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>

	<span class="cm">/* free SKB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">read_ptr</span><span class="p">];</span>

		<span class="cm">/* can be called from irqs-disabled context */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">[</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">read_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_hw_txq_attach_buf_to_tfd</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
				<span class="n">dma_addr_t</span> <span class="n">addr</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">reset</span><span class="p">,</span> <span class="n">u8</span> <span class="n">pad</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_queue</span> <span class="o">*</span><span class="n">q</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_tfd</span> <span class="o">*</span><span class="n">tfd</span><span class="p">,</span> <span class="o">*</span><span class="n">tfd_tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">num_tbs</span><span class="p">;</span>

	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>
	<span class="n">tfd_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_tfd</span> <span class="o">*</span><span class="p">)</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">tfds</span><span class="p">;</span>
	<span class="n">tfd</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">tfd_tmp</span><span class="p">[</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">write_ptr</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reset</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">tfd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tfd</span><span class="p">));</span>

	<span class="n">num_tbs</span> <span class="o">=</span> <span class="n">il4965_tfd_get_num_tbs</span><span class="p">(</span><span class="n">tfd</span><span class="p">);</span>

	<span class="cm">/* Each TFD can point to a maximum 20 Tx buffers */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">num_tbs</span> <span class="o">&gt;=</span> <span class="n">IL_NUM_OF_TBS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Error can not send more than %d chunks</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">IL_NUM_OF_TBS</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">36</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">IL_TX_DMA_MASK</span><span class="p">))</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unaligned address = %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">addr</span><span class="p">);</span>

	<span class="n">il4965_tfd_set_tb</span><span class="p">(</span><span class="n">tfd</span><span class="p">,</span> <span class="n">num_tbs</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Tell nic where to find circular buffer of Tx Frame Descriptors for</span>
<span class="cm"> * given Tx queue, and enable the DMA channel used for that queue.</span>
<span class="cm"> *</span>
<span class="cm"> * 4965 supports up to 16 Tx queues in DRAM, mapped to up to 8 Tx DMA</span>
<span class="cm"> * channels supported in hardware.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">il4965_hw_tx_queue_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">txq_id</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>

	<span class="cm">/* Circular buffer (TFD queue in DRAM) physical base address */</span>
	<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_MEM_CBBC_QUEUE</span><span class="p">(</span><span class="n">txq_id</span><span class="p">),</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">dma_addr</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Generic RX handler implementations</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_hdl_alive</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">il_alive_resp</span> <span class="o">*</span><span class="n">palive</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">pwork</span><span class="p">;</span>

	<span class="n">palive</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">alive_frame</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Alive ucode status 0x%08X revision &quot;</span> <span class="s">&quot;0x%01X 0x%01X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">palive</span><span class="o">-&gt;</span><span class="n">is_valid</span><span class="p">,</span> <span class="n">palive</span><span class="o">-&gt;</span><span class="n">ver_type</span><span class="p">,</span> <span class="n">palive</span><span class="o">-&gt;</span><span class="n">ver_subtype</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">palive</span><span class="o">-&gt;</span><span class="n">ver_subtype</span> <span class="o">==</span> <span class="n">INITIALIZE_SUBTYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Initialization Alive received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">card_alive_init</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">alive_frame</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_init_alive_resp</span><span class="p">));</span>
		<span class="n">pwork</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">init_alive_start</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Runtime Alive received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">card_alive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">alive_frame</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_alive_resp</span><span class="p">));</span>
		<span class="n">pwork</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">alive_start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We delay the ALIVE response by 5ms to</span>
<span class="cm">	 * give the HW RF Kill time to activate... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">palive</span><span class="o">-&gt;</span><span class="n">is_valid</span> <span class="o">==</span> <span class="n">UCODE_VALID_OK</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="n">pwork</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;uCode did not respond OK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_bg_stats_periodic - Timer callback to queue stats</span>
<span class="cm"> *</span>
<span class="cm"> * This callback is provided in order to send a stats request.</span>
<span class="cm"> *</span>
<span class="cm"> * This timer function is continually reset to execute within</span>
<span class="cm"> * 60 seconds since the last N_STATS was received.  We need to</span>
<span class="cm"> * ensure we receive the stats in order to update the temperature</span>
<span class="cm"> * used for calibrating the TXPOWER.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_bg_stats_periodic</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* dont send host command if rf-kill is on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il_is_ready_rf</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">il_send_stats_request</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CMD_ASYNC</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_hdl_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">il4965_beacon_notif</span> <span class="o">*</span><span class="n">beacon</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">il4965_beacon_notif</span> <span class="o">*</span><span class="p">)</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">raw</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="n">u8</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">il4965_hw_get_rate</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">beacon_notify_hdr</span><span class="p">.</span><span class="n">rate_n_flags</span><span class="p">);</span>

	<span class="n">D_RX</span><span class="p">(</span><span class="s">&quot;beacon status %x retries %d iss %d tsf:0x%.8x%.8x rate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">beacon_notify_hdr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_MSK</span><span class="p">,</span>
	     <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">beacon_notify_hdr</span><span class="p">.</span><span class="n">failure_frame</span><span class="p">,</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ibss_mgr_status</span><span class="p">),</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">high_tsf</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">low_tsf</span><span class="p">),</span> <span class="n">rate</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ibss_manager</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ibss_mgr_status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_perform_ct_kill_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">D_POWER</span><span class="p">(</span><span class="s">&quot;Stop all queues</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span><span class="p">)</span>
		<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_SET</span><span class="p">,</span>
	       <span class="n">CSR_UCODE_DRV_GP1_REG_BIT_CT_KILL_EXIT</span><span class="p">);</span>
	<span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">_il_grab_nic_access</span><span class="p">(</span><span class="n">il</span><span class="p">)))</span>
		<span class="n">_il_release_nic_access</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Handle notification from uCode that card&#39;s power state is changing</span>
<span class="cm"> * due to software, hardware, or critical temperature RFKILL */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_hdl_card_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">card_state_notif</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">D_RF_KILL</span><span class="p">(</span><span class="s">&quot;Card state received: HW:%s SW:%s CT:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HW_CARD_DISABLED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Kill&quot;</span> <span class="o">:</span> <span class="s">&quot;On&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SW_CARD_DISABLED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Kill&quot;</span> <span class="o">:</span> <span class="s">&quot;On&quot;</span><span class="p">,</span>
		  <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CT_CARD_DISABLED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Reached&quot;</span> <span class="o">:</span> <span class="s">&quot;Not reached&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">SW_CARD_DISABLED</span> <span class="o">|</span> <span class="n">HW_CARD_DISABLED</span> <span class="o">|</span> <span class="n">CT_CARD_DISABLED</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_SET</span><span class="p">,</span>
		       <span class="n">CSR_UCODE_DRV_GP1_BIT_CMD_BLOCKED</span><span class="p">);</span>

		<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">HBUS_TARG_MBX_C</span><span class="p">,</span> <span class="n">HBUS_TARG_MBX_C_REG_BIT_CMD_BLOCKED</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_CARD_DISABLED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_CLR</span><span class="p">,</span>
			       <span class="n">CSR_UCODE_DRV_GP1_BIT_CMD_BLOCKED</span><span class="p">);</span>
			<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">HBUS_TARG_MBX_C</span><span class="p">,</span>
			      <span class="n">HBUS_TARG_MBX_C_REG_BIT_CMD_BLOCKED</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">CT_CARD_DISABLED</span><span class="p">)</span>
		<span class="n">il4965_perform_ct_kill_task</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HW_CARD_DISABLED</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_CARD_DISABLED</span><span class="p">))</span>
		<span class="n">il_scan_cancel</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)))</span>
		<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
					  <span class="n">test_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_setup_handlers - Initialize Rx handler callbacks</span>
<span class="cm"> *</span>
<span class="cm"> * Setup the RX handlers for each of the reply types sent from the uCode</span>
<span class="cm"> * to the host.</span>
<span class="cm"> *</span>
<span class="cm"> * This function chains into the hardware specific files for them to setup</span>
<span class="cm"> * any hardware specific handlers as well.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_setup_handlers</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_ALIVE</span><span class="p">]</span> <span class="o">=</span> <span class="n">il4965_hdl_alive</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_ERROR</span><span class="p">]</span> <span class="o">=</span> <span class="n">il_hdl_error</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_CHANNEL_SWITCH</span><span class="p">]</span> <span class="o">=</span> <span class="n">il_hdl_csa</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_SPECTRUM_MEASUREMENT</span><span class="p">]</span> <span class="o">=</span> <span class="n">il_hdl_spectrum_measurement</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_PM_SLEEP</span><span class="p">]</span> <span class="o">=</span> <span class="n">il_hdl_pm_sleep</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_PM_DEBUG_STATS</span><span class="p">]</span> <span class="o">=</span> <span class="n">il_hdl_pm_debug_stats</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_BEACON</span><span class="p">]</span> <span class="o">=</span> <span class="n">il4965_hdl_beacon</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The same handler is used for both the REPLY to a discrete</span>
<span class="cm">	 * stats request from the host as well as for the periodic</span>
<span class="cm">	 * stats notifications (after received beacons) from the uCode.</span>
<span class="cm">	 */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">C_STATS</span><span class="p">]</span> <span class="o">=</span> <span class="n">il4965_hdl_c_stats</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_STATS</span><span class="p">]</span> <span class="o">=</span> <span class="n">il4965_hdl_stats</span><span class="p">;</span>

	<span class="n">il_setup_rx_scan_handlers</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/* status change handler */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_CARD_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="n">il4965_hdl_card_state</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_MISSED_BEACONS</span><span class="p">]</span> <span class="o">=</span> <span class="n">il4965_hdl_missed_beacon</span><span class="p">;</span>
	<span class="cm">/* Rx handlers */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_RX_PHY</span><span class="p">]</span> <span class="o">=</span> <span class="n">il4965_hdl_rx_phy</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_RX_MPDU</span><span class="p">]</span> <span class="o">=</span> <span class="n">il4965_hdl_rx</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_RX</span><span class="p">]</span> <span class="o">=</span> <span class="n">il4965_hdl_rx</span><span class="p">;</span>
	<span class="cm">/* block ack */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_COMPRESSED_BA</span><span class="p">]</span> <span class="o">=</span> <span class="n">il4965_hdl_compressed_ba</span><span class="p">;</span>
	<span class="cm">/* Tx response */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">C_TX</span><span class="p">]</span> <span class="o">=</span> <span class="n">il4965_hdl_tx</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_rx_handle - Main entry function for receiving responses from uCode</span>
<span class="cm"> *</span>
<span class="cm"> * Uses the il-&gt;handlers callback function array to invoke</span>
<span class="cm"> * the appropriate handlers, including command responses,</span>
<span class="cm"> * frame-received notifications, and other notifications.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">il4965_rx_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reclaim</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fill_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total_empty</span><span class="p">;</span>

	<span class="cm">/* uCode&#39;s read idx (stored in shared DRAM) indicates the last Rx</span>
<span class="cm">	 * buffer that the driver may process (last buffer filled by ucode). */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rb_stts</span><span class="o">-&gt;</span><span class="n">closed_rb_num</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0FFF</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">;</span>

	<span class="cm">/* Rx interrupt, but nothing sent from uCode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">r</span><span class="p">)</span>
		<span class="n">D_RX</span><span class="p">(</span><span class="s">&quot;r = %d, i = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* calculate total frames need to be restock after handling RX */</span>
	<span class="n">total_empty</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write_actual</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total_empty</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">total_empty</span> <span class="o">+=</span> <span class="n">RX_QUEUE_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total_empty</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">RX_QUEUE_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">fill_rx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">rxb</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* If an RXB doesn&#39;t have a Rx queue slot associated with it,</span>
<span class="cm">		 * then a bug has been introduced in the queue refilling</span>
<span class="cm">		 * routines -- catch it here */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rxb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page_dma</span><span class="p">,</span>
			       <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span><span class="p">,</span>
			       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len_n_flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IL_RX_FRAME_SIZE_MSK</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>	<span class="cm">/* account for status word */</span>

		<span class="cm">/* Reclaim a command buffer only if this packet is a response</span>
<span class="cm">		 *   to a (driver-originated) command.</span>
<span class="cm">		 * If the packet (e.g. Rx frame) originated from uCode,</span>
<span class="cm">		 *   there is no command buffer to reclaim.</span>
<span class="cm">		 * Ucode should set SEQ_RX_FRAME bit if ucode-originated,</span>
<span class="cm">		 *   but apparently a few don&#39;t get set; catch them here. */</span>
		<span class="n">reclaim</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">sequence</span> <span class="o">&amp;</span> <span class="n">SEQ_RX_FRAME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">N_RX_PHY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">N_RX</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">N_RX_MPDU</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">N_COMPRESSED_BA</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">N_STATS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">C_TX</span><span class="p">);</span>

		<span class="cm">/* Based on type of command response or notification,</span>
<span class="cm">		 *   handle those that need handling via function in</span>
<span class="cm">		 *   handlers table.  See il4965_setup_handlers() */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">D_RX</span><span class="p">(</span><span class="s">&quot;r = %d, i = %d, %s, 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			     <span class="n">il_get_cmd_string</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">),</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">]</span> <span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* No handling needed */</span>
			<span class="n">D_RX</span><span class="p">(</span><span class="s">&quot;r %d i %d No handler needed for %s, 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span>
			     <span class="n">i</span><span class="p">,</span> <span class="n">il_get_cmd_string</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">),</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * XXX: After here, we should always check rxb-&gt;page</span>
<span class="cm">		 * against NULL before touching it or its virtual</span>
<span class="cm">		 * memory (pkt). Because some handler might have</span>
<span class="cm">		 * already taken or freed the pages.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reclaim</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Invoke any callbacks, transfer the buffer to caller,</span>
<span class="cm">			 * and fire off the (possibly) blocking il_send_cmd()</span>
<span class="cm">			 * as we reclaim the driver command queue */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">)</span>
				<span class="n">il_tx_cmd_complete</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxb</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Claim null rxb?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Reuse the page if possible. For notification packets and</span>
<span class="cm">		 * SKBs that fail to Rx correctly, add them back into the</span>
<span class="cm">		 * rx_free list for reuse later. */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page_dma</span> <span class="o">=</span>
			    <span class="n">pci_map_page</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span>
					 <span class="n">rx_page_order</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_free</span><span class="p">);</span>
			<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RX_QUEUE_MASK</span><span class="p">;</span>
		<span class="cm">/* If there are a lot of unused frames,</span>
<span class="cm">		 * restock the Rx queue so ucode wont assert. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fill_rx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">il4965_rx_replenish_now</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Backtrack one entry */</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fill_rx</span><span class="p">)</span>
		<span class="n">il4965_rx_replenish_now</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">il4965_rx_queue_restock</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* call this function to flush any scheduled tasklet */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">il4965_synchronize_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* wait to make sure we flush pending tasklet */</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_irq_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">inta</span><span class="p">,</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inta_fh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="n">u32</span> <span class="n">inta_mask</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Ack/clear/reset pending uCode interrupts.</span>
<span class="cm">	 * Note:  Some bits in CSR_INT are &quot;OR&quot; of bits in CSR_FH_INT_STATUS,</span>
<span class="cm">	 *  and will clear only when CSR_FH_INT_STATUS gets cleared. */</span>
	<span class="n">inta</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT</span><span class="p">);</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT</span><span class="p">,</span> <span class="n">inta</span><span class="p">);</span>

	<span class="cm">/* Ack/clear/reset pending flow-handler (DMA) interrupts.</span>
<span class="cm">	 * Any new interrupts that happen after this, either while we&#39;re</span>
<span class="cm">	 * in this tasklet, or later, will show up in next ISR/tasklet. */</span>
	<span class="n">inta_fh</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_FH_INT_STATUS</span><span class="p">);</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_FH_INT_STATUS</span><span class="p">,</span> <span class="n">inta_fh</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il_get_debug_level</span><span class="p">(</span><span class="n">il</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IL_DL_ISR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* just for debug */</span>
		<span class="n">inta_mask</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT_MASK</span><span class="p">);</span>
		<span class="n">D_ISR</span><span class="p">(</span><span class="s">&quot;inta 0x%08x, enabled 0x%08x, fh 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inta</span><span class="p">,</span>
		      <span class="n">inta_mask</span><span class="p">,</span> <span class="n">inta_fh</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Since CSR_INT and CSR_FH_INT_STATUS reads and clears are not</span>
<span class="cm">	 * atomic, make sure that inta covers all the interrupts that</span>
<span class="cm">	 * we&#39;ve discovered, even if FH interrupt came in just after</span>
<span class="cm">	 * reading CSR_INT. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta_fh</span> <span class="o">&amp;</span> <span class="n">CSR49_FH_INT_RX_MASK</span><span class="p">)</span>
		<span class="n">inta</span> <span class="o">|=</span> <span class="n">CSR_INT_BIT_FH_RX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta_fh</span> <span class="o">&amp;</span> <span class="n">CSR49_FH_INT_TX_MASK</span><span class="p">)</span>
		<span class="n">inta</span> <span class="o">|=</span> <span class="n">CSR_INT_BIT_FH_TX</span><span class="p">;</span>

	<span class="cm">/* Now service all interrupt bits discovered above. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_HW_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Hardware error detected.  Restarting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Tell the device to stop sending interrupts */</span>
		<span class="n">il_disable_interrupts</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

		<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">hw</span><span class="o">++</span><span class="p">;</span>
		<span class="n">il_irq_handle_error</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

		<span class="n">handled</span> <span class="o">|=</span> <span class="n">CSR_INT_BIT_HW_ERR</span><span class="p">;</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il_get_debug_level</span><span class="p">(</span><span class="n">il</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IL_DL_ISR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* NIC fires this, but we don&#39;t use it, redundant with WAKEUP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_SCD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_ISR</span><span class="p">(</span><span class="s">&quot;Scheduler finished to transmit &quot;</span>
			      <span class="s">&quot;the frame/frames.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">sch</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Alive notification via Rx interrupt will do the real work */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_ALIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_ISR</span><span class="p">(</span><span class="s">&quot;Alive interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">alive</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* Safely ignore these bits for debug checks below */</span>
	<span class="n">inta</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CSR_INT_BIT_SCD</span> <span class="o">|</span> <span class="n">CSR_INT_BIT_ALIVE</span><span class="p">);</span>

	<span class="cm">/* HW RF KILL switch toggled */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_RF_KILL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">hw_rf_kill</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_GP_CNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR_GP_CNTRL_REG_FLAG_HW_RF_KILL_SW</span><span class="p">))</span>
			<span class="n">hw_rf_kill</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;RF_KILL bit toggled to %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">hw_rf_kill</span> <span class="o">?</span> <span class="s">&quot;disable radio&quot;</span> <span class="o">:</span> <span class="s">&quot;enable radio&quot;</span><span class="p">);</span>

		<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">rfkill</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* driver only loads ucode once setting the interface up.</span>
<span class="cm">		 * the driver allows loading the ucode even if the radio</span>
<span class="cm">		 * is killed. Hence update the killswitch state here. The</span>
<span class="cm">		 * rfkill handler will care about restarting if needed.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_ALIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hw_rf_kill</span><span class="p">)</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
			<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">hw_rf_kill</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">handled</span> <span class="o">|=</span> <span class="n">CSR_INT_BIT_RF_KILL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Chip got too hot and stopped itself */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_CT_KILL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Microcode CT kill error detected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">ctkill</span><span class="o">++</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">CSR_INT_BIT_CT_KILL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Error detected by uCode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_SW_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Microcode SW error detected. &quot;</span> <span class="s">&quot; Restarting 0x%X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">inta</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">sw</span><span class="o">++</span><span class="p">;</span>
		<span class="n">il_irq_handle_error</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">CSR_INT_BIT_SW_ERR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * uCode wakes up after power-down sleep.</span>
<span class="cm">	 * Tell device about any new tx or host commands enqueued,</span>
<span class="cm">	 * and about any Rx buffers made available while asleep.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_WAKEUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_ISR</span><span class="p">(</span><span class="s">&quot;Wakeup interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">il_rx_queue_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_txq_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">il_txq_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">wakeup</span><span class="o">++</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">CSR_INT_BIT_WAKEUP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* All uCode command responses, including Tx command responses,</span>
<span class="cm">	 * Rx &quot;responses&quot; (frame-received notification), and other</span>
<span class="cm">	 * notifications from uCode come through here*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CSR_INT_BIT_FH_RX</span> <span class="o">|</span> <span class="n">CSR_INT_BIT_SW_RX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">il4965_rx_handle</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CSR_INT_BIT_FH_RX</span> <span class="o">|</span> <span class="n">CSR_INT_BIT_SW_RX</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* This &quot;Tx&quot; DMA channel is used only for loading uCode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_FH_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_ISR</span><span class="p">(</span><span class="s">&quot;uCode load interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">CSR_INT_BIT_FH_TX</span><span class="p">;</span>
		<span class="cm">/* Wake up uCode load routine, now that load is complete */</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_write_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">handled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unhandled INTA bits 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inta</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">handled</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">unhandled</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">inta_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Disabled INTA bits 0x%08x were pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">inta</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">inta_mask</span><span class="p">);</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;   with FH49_INT = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inta_fh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Re-enable all interrupts */</span>
	<span class="cm">/* only Re-enable if disabled by irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_INT_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="n">il_enable_interrupts</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="cm">/* Re-enable RF_KILL if it occurred */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">handled</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_RF_KILL</span><span class="p">)</span>
		<span class="n">il_enable_rfkill_int</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il_get_debug_level</span><span class="p">(</span><span class="n">il</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IL_DL_ISR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inta</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT</span><span class="p">);</span>
		<span class="n">inta_mask</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT_MASK</span><span class="p">);</span>
		<span class="n">inta_fh</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_FH_INT_STATUS</span><span class="p">);</span>
		<span class="n">D_ISR</span><span class="p">(</span><span class="s">&quot;End inta 0x%08x, enabled 0x%08x, fh 0x%08x, &quot;</span>
		      <span class="s">&quot;flags 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inta</span><span class="p">,</span> <span class="n">inta_mask</span><span class="p">,</span> <span class="n">inta_fh</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * sysfs attributes</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>

<span class="cm">/*</span>
<span class="cm"> * The following adds a new attribute to the sysfs representation</span>
<span class="cm"> * of this device driver (i.e. a new file in /sys/class/net/wlan0/device/)</span>
<span class="cm"> * used for controlling the debug level.</span>
<span class="cm"> *</span>
<span class="cm"> * See the level definitions in iwl for details.</span>
<span class="cm"> *</span>
<span class="cm"> * The debug_level being managed using sysfs below is a per device debug</span>
<span class="cm"> * level that is used instead of the global debug level if it (the per</span>
<span class="cm"> * device debug level) is set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il4965_show_debug_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il_get_debug_level</span><span class="p">(</span><span class="n">il</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il4965_store_debug_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;%s is not in hex or decimal form.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">debug_level</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">il4965_show_debug_level</span><span class="p">,</span>
		   <span class="n">il4965_store_debug_level</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_IWLEGACY_DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il4965_show_temperature</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il_is_alive</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">temperature</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">il4965_show_temperature</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il4965_show_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il_is_ready_rf</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">tx_power_user_lmt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il4965_store_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">IL_INFO</span><span class="p">(</span><span class="s">&quot;%s is not in decimal form.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">il_set_tx_power</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;failed setting tx power (0x%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">tx_power</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">il4965_show_tx_power</span><span class="p">,</span>
		   <span class="n">il4965_store_tx_power</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">il_sysfs_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_temperature</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_power</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="o">&amp;</span><span class="n">dev_attr_debug_level</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">il_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* put in device directory */</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">il_sysfs_entries</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * uCode download functions</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_dealloc_ucode_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">il_free_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">);</span>
	<span class="n">il_free_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">);</span>
	<span class="n">il_free_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">);</span>
	<span class="n">il_free_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init</span><span class="p">);</span>
	<span class="n">il_free_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init_data</span><span class="p">);</span>
	<span class="n">il_free_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_boot</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_nic_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Remove all resets to allow NIC to operate */</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">il4965_ucode_callback</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">ucode_raw</span><span class="p">,</span>
				  <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">il4965_mac_setup_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u32</span> <span class="n">max_probe_length</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__must_check</span>
<span class="nf">il4965_request_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">bool</span> <span class="n">first</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name_pre</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fw_name_pre</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">tag</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">fw_idx</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ucode_api_max</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">fw_idx</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">fw_idx</span><span class="o">--</span><span class="p">;</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">tag</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">fw_idx</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">fw_idx</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ucode_api_min</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;no suitable firmware found!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">firmware_name</span><span class="p">,</span> <span class="s">&quot;%s%s%s&quot;</span><span class="p">,</span> <span class="n">name_pre</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="s">&quot;.ucode&quot;</span><span class="p">);</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;attempting to load firmware &#39;%s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">firmware_name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">request_firmware_nowait</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">firmware_name</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="n">il</span><span class="p">,</span>
				       <span class="n">il4965_ucode_callback</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">il4965_firmware_pieces</span> <span class="p">{</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">inst</span><span class="p">,</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">init</span><span class="p">,</span> <span class="o">*</span><span class="n">init_data</span><span class="p">,</span> <span class="o">*</span><span class="n">boot</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">inst_size</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">init_size</span><span class="p">,</span> <span class="n">init_data_size</span><span class="p">,</span> <span class="n">boot_size</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">ucode_raw</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">il4965_firmware_pieces</span> <span class="o">*</span><span class="n">pieces</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_ucode_header</span> <span class="o">*</span><span class="n">ucode</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ucode_raw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">api_ver</span><span class="p">,</span> <span class="n">hdr_size</span><span class="p">;</span>
	<span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ucode</span><span class="o">-&gt;</span><span class="n">ver</span><span class="p">);</span>
	<span class="n">api_ver</span> <span class="o">=</span> <span class="n">IL_UCODE_API</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">api_ver</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">1</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">hdr_size</span> <span class="o">=</span> <span class="mi">24</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ucode_raw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">hdr_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;File size too small!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">pieces</span><span class="o">-&gt;</span><span class="n">inst_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ucode</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">inst_size</span><span class="p">);</span>
		<span class="n">pieces</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ucode</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">data_size</span><span class="p">);</span>
		<span class="n">pieces</span><span class="o">-&gt;</span><span class="n">init_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ucode</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">init_size</span><span class="p">);</span>
		<span class="n">pieces</span><span class="o">-&gt;</span><span class="n">init_data_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ucode</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">init_data_size</span><span class="p">);</span>
		<span class="n">pieces</span><span class="o">-&gt;</span><span class="n">boot_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ucode</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">boot_size</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">=</span> <span class="n">ucode</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Verify size of file vs. image size info in file&#39;s header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucode_raw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span>
	    <span class="n">hdr_size</span> <span class="o">+</span> <span class="n">pieces</span><span class="o">-&gt;</span><span class="n">inst_size</span> <span class="o">+</span> <span class="n">pieces</span><span class="o">-&gt;</span><span class="n">data_size</span> <span class="o">+</span>
	    <span class="n">pieces</span><span class="o">-&gt;</span><span class="n">init_size</span> <span class="o">+</span> <span class="n">pieces</span><span class="o">-&gt;</span><span class="n">init_data_size</span> <span class="o">+</span> <span class="n">pieces</span><span class="o">-&gt;</span><span class="n">boot_size</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;uCode file size %d does not match expected size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ucode_raw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pieces</span><span class="o">-&gt;</span><span class="n">inst</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="n">src</span> <span class="o">+=</span> <span class="n">pieces</span><span class="o">-&gt;</span><span class="n">inst_size</span><span class="p">;</span>
	<span class="n">pieces</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="n">src</span> <span class="o">+=</span> <span class="n">pieces</span><span class="o">-&gt;</span><span class="n">data_size</span><span class="p">;</span>
	<span class="n">pieces</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="n">src</span> <span class="o">+=</span> <span class="n">pieces</span><span class="o">-&gt;</span><span class="n">init_size</span><span class="p">;</span>
	<span class="n">pieces</span><span class="o">-&gt;</span><span class="n">init_data</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="n">src</span> <span class="o">+=</span> <span class="n">pieces</span><span class="o">-&gt;</span><span class="n">init_data_size</span><span class="p">;</span>
	<span class="n">pieces</span><span class="o">-&gt;</span><span class="n">boot</span> <span class="o">=</span> <span class="n">src</span><span class="p">;</span>
	<span class="n">src</span> <span class="o">+=</span> <span class="n">pieces</span><span class="o">-&gt;</span><span class="n">boot_size</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_ucode_callback - callback when firmware was loaded</span>
<span class="cm"> *</span>
<span class="cm"> * If loaded successfully, copies the firmware into buffers</span>
<span class="cm"> * for the card to fetch (via DMA).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_ucode_callback</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">ucode_raw</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_ucode_header</span> <span class="o">*</span><span class="n">ucode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il4965_firmware_pieces</span> <span class="n">pieces</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">api_max</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ucode_api_max</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">api_min</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ucode_api_min</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">api_ver</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">max_probe_length</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">standard_phy_calibration_size</span> <span class="o">=</span>
	    <span class="n">IL_DEFAULT_STANDARD_PHY_CALIBRATE_TBL_SIZE</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pieces</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pieces</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ucode_raw</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">fw_idx</span> <span class="o">&lt;=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ucode_api_max</span><span class="p">)</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;request for firmware file &#39;%s&#39; failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">il</span><span class="o">-&gt;</span><span class="n">firmware_name</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Loaded firmware file &#39;%s&#39; (%zd bytes).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">firmware_name</span><span class="p">,</span>
	       <span class="n">ucode_raw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="cm">/* Make sure that we got at least the API version number */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucode_raw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;File size way too small!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Data from ucode file:  header followed by uCode images */</span>
	<span class="n">ucode</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_ucode_header</span> <span class="o">*</span><span class="p">)</span><span class="n">ucode_raw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">il4965_load_firmware</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">ucode_raw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pieces</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>

	<span class="n">api_ver</span> <span class="o">=</span> <span class="n">IL_UCODE_API</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * api_ver should match the api version forming part of the</span>
<span class="cm">	 * firmware filename ... but we don&#39;t check for that and only rely</span>
<span class="cm">	 * on the API version read from firmware header from here on forward</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">api_ver</span> <span class="o">&lt;</span> <span class="n">api_min</span> <span class="o">||</span> <span class="n">api_ver</span> <span class="o">&gt;</span> <span class="n">api_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Driver unable to support your firmware API. &quot;</span>
		       <span class="s">&quot;Driver supports v%u, firmware is v%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">api_max</span><span class="p">,</span>
		       <span class="n">api_ver</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">api_ver</span> <span class="o">!=</span> <span class="n">api_max</span><span class="p">)</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Firmware has old API version. Expected v%u, &quot;</span>
		       <span class="s">&quot;got v%u. New firmware can be obtained &quot;</span>
		       <span class="s">&quot;from http://www.intellinuxwireless.org.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">api_max</span><span class="p">,</span>
		       <span class="n">api_ver</span><span class="p">);</span>

	<span class="n">IL_INFO</span><span class="p">(</span><span class="s">&quot;loaded firmware version %u.%u.%u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">IL_UCODE_MAJOR</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">),</span> <span class="n">IL_UCODE_MINOR</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">),</span>
		<span class="n">IL_UCODE_API</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">),</span> <span class="n">IL_UCODE_SERIAL</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">));</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span>
		 <span class="s">&quot;%u.%u.%u.%u&quot;</span><span class="p">,</span> <span class="n">IL_UCODE_MAJOR</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">),</span>
		 <span class="n">IL_UCODE_MINOR</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">),</span> <span class="n">IL_UCODE_API</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">),</span>
		 <span class="n">IL_UCODE_SERIAL</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * For any of the failures below (before allocating pci memory)</span>
<span class="cm">	 * we will try to load a version with a smaller API -- maybe the</span>
<span class="cm">	 * user just got a corrupted version of the latest API.</span>
<span class="cm">	 */</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;f/w package hdr ucode version raw = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;f/w package hdr runtime inst size = %Zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">inst_size</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;f/w package hdr runtime data size = %Zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">data_size</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;f/w package hdr init inst size = %Zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">init_size</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;f/w package hdr init data size = %Zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">init_data_size</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;f/w package hdr boot inst size = %Zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">boot_size</span><span class="p">);</span>

	<span class="cm">/* Verify that uCode images will fit in card&#39;s SRAM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pieces</span><span class="p">.</span><span class="n">inst_size</span> <span class="o">&gt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_inst_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;uCode instr len %Zd too large to fit in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pieces</span><span class="p">.</span><span class="n">inst_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pieces</span><span class="p">.</span><span class="n">data_size</span> <span class="o">&gt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;uCode data len %Zd too large to fit in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pieces</span><span class="p">.</span><span class="n">data_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pieces</span><span class="p">.</span><span class="n">init_size</span> <span class="o">&gt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_inst_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;uCode init instr len %Zd too large to fit in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pieces</span><span class="p">.</span><span class="n">init_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pieces</span><span class="p">.</span><span class="n">init_data_size</span> <span class="o">&gt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;uCode init data len %Zd too large to fit in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pieces</span><span class="p">.</span><span class="n">init_data_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pieces</span><span class="p">.</span><span class="n">boot_size</span> <span class="o">&gt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_bsm_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;uCode boot instr len %Zd too large to fit in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pieces</span><span class="p">.</span><span class="n">boot_size</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">try_again</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate ucode buffers for card&#39;s bus-master loading ... */</span>

	<span class="cm">/* Runtime instructions and 2 copies of data:</span>
<span class="cm">	 * 1) unmodified from disk</span>
<span class="cm">	 * 2) backup cache for save/restore during power-downs */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">.</span><span class="n">inst_size</span><span class="p">;</span>
	<span class="n">il_alloc_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">.</span><span class="n">data_size</span><span class="p">;</span>
	<span class="n">il_alloc_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">.</span><span class="n">data_size</span><span class="p">;</span>
	<span class="n">il_alloc_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">v_addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">.</span><span class="n">v_addr</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">.</span><span class="n">v_addr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pci_alloc</span><span class="p">;</span>

	<span class="cm">/* Initialization instructions and data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pieces</span><span class="p">.</span><span class="n">init_size</span> <span class="o">&amp;&amp;</span> <span class="n">pieces</span><span class="p">.</span><span class="n">init_data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">.</span><span class="n">init_size</span><span class="p">;</span>
		<span class="n">il_alloc_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init</span><span class="p">);</span>

		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init_data</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">.</span><span class="n">init_data_size</span><span class="p">;</span>
		<span class="n">il_alloc_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init_data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init</span><span class="p">.</span><span class="n">v_addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init_data</span><span class="p">.</span><span class="n">v_addr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_pci_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Bootstrap (instructions only, no data) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pieces</span><span class="p">.</span><span class="n">boot_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_boot</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">pieces</span><span class="p">.</span><span class="n">boot_size</span><span class="p">;</span>
		<span class="n">il_alloc_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_boot</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_boot</span><span class="p">.</span><span class="n">v_addr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_pci_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Now that we can no longer fail, copy information */</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_key_max_num</span> <span class="o">=</span> <span class="n">STA_KEY_MAX_NUM</span><span class="p">;</span>

	<span class="cm">/* Copy images into buffers for card&#39;s bus-master reads ... */</span>

	<span class="cm">/* Runtime instructions (first block of data in file) */</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Copying (but not loading) uCode instr len %Zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pieces</span><span class="p">.</span><span class="n">inst_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">inst</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">inst_size</span><span class="p">);</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;uCode instr buf vaddr = 0x%p, paddr = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">p_addr</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Runtime data</span>
<span class="cm">	 * NOTE:  Copy into backup buffer will be done in il_up()</span>
<span class="cm">	 */</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Copying (but not loading) uCode data len %Zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pieces</span><span class="p">.</span><span class="n">data_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">data_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">data_size</span><span class="p">);</span>

	<span class="cm">/* Initialization instructions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pieces</span><span class="p">.</span><span class="n">init_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Copying (but not loading) init instr len %Zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pieces</span><span class="p">.</span><span class="n">init_size</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">init</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">init_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Initialization data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pieces</span><span class="p">.</span><span class="n">init_data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Copying (but not loading) init data len %Zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pieces</span><span class="p">.</span><span class="n">init_data_size</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init_data</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">init_data</span><span class="p">,</span>
		       <span class="n">pieces</span><span class="p">.</span><span class="n">init_data_size</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Bootstrap instructions */</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Copying (but not loading) boot instr len %Zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pieces</span><span class="p">.</span><span class="n">boot_size</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_boot</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">boot</span><span class="p">,</span> <span class="n">pieces</span><span class="p">.</span><span class="n">boot_size</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * figure out the offset of chain noise reset and gain commands</span>
<span class="cm">	 * base on the size of standard phy calibration commands table size</span>
<span class="cm">	 */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">phy_calib_chain_noise_reset_cmd</span> <span class="o">=</span>
	    <span class="n">standard_phy_calibration_size</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">phy_calib_chain_noise_gain_cmd</span> <span class="o">=</span>
	    <span class="n">standard_phy_calibration_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/**************************************************</span>
<span class="cm">	 * This is still part of probe() in a sense...</span>
<span class="cm">	 *</span>
<span class="cm">	 * 9. Setup and register with mac80211 and debugfs</span>
<span class="cm">	 **************************************************/</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">il4965_mac_setup_register</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">max_probe_length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_unbind</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">il_dbgfs_register</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;failed to create debugfs files. Ignoring error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">err</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;failed to create sysfs device attributes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unbind</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We have our copies now, allow OS release its copies */</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">ucode_raw</span><span class="p">);</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">firmware_loading_complete</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">try_again:</span>
	<span class="cm">/* try next, if any */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il4965_request_firmware</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="nb">false</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_unbind</span><span class="p">;</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">ucode_raw</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">err_pci_alloc:</span>
	<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;failed to allocate pci memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">il4965_dealloc_ucode_pci</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">out_unbind:</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">firmware_loading_complete</span><span class="p">);</span>
	<span class="n">device_release_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">ucode_raw</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">desc_lookup_text</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;OK&quot;</span><span class="p">,</span>
	<span class="s">&quot;FAIL&quot;</span><span class="p">,</span>
	<span class="s">&quot;BAD_PARAM&quot;</span><span class="p">,</span>
	<span class="s">&quot;BAD_CHECKSUM&quot;</span><span class="p">,</span>
	<span class="s">&quot;NMI_INTERRUPT_WDG&quot;</span><span class="p">,</span>
	<span class="s">&quot;SYSASSERT&quot;</span><span class="p">,</span>
	<span class="s">&quot;FATAL_ERROR&quot;</span><span class="p">,</span>
	<span class="s">&quot;BAD_COMMAND&quot;</span><span class="p">,</span>
	<span class="s">&quot;HW_ERROR_TUNE_LOCK&quot;</span><span class="p">,</span>
	<span class="s">&quot;HW_ERROR_TEMPERATURE&quot;</span><span class="p">,</span>
	<span class="s">&quot;ILLEGAL_CHAN_FREQ&quot;</span><span class="p">,</span>
	<span class="s">&quot;VCC_NOT_STBL&quot;</span><span class="p">,</span>
	<span class="s">&quot;FH49_ERROR&quot;</span><span class="p">,</span>
	<span class="s">&quot;NMI_INTERRUPT_HOST&quot;</span><span class="p">,</span>
	<span class="s">&quot;NMI_INTERRUPT_ACTION_PT&quot;</span><span class="p">,</span>
	<span class="s">&quot;NMI_INTERRUPT_UNKNOWN&quot;</span><span class="p">,</span>
	<span class="s">&quot;UCODE_VERSION_MISMATCH&quot;</span><span class="p">,</span>
	<span class="s">&quot;HW_ERROR_ABS_LOCK&quot;</span><span class="p">,</span>
	<span class="s">&quot;HW_ERROR_CAL_LOCK_FAIL&quot;</span><span class="p">,</span>
	<span class="s">&quot;NMI_INTERRUPT_INST_ACTION_PT&quot;</span><span class="p">,</span>
	<span class="s">&quot;NMI_INTERRUPT_DATA_ACTION_PT&quot;</span><span class="p">,</span>
	<span class="s">&quot;NMI_TRM_HW_ER&quot;</span><span class="p">,</span>
	<span class="s">&quot;NMI_INTERRUPT_TRM&quot;</span><span class="p">,</span>
	<span class="s">&quot;NMI_INTERRUPT_BREAK_POINT&quot;</span><span class="p">,</span>
	<span class="s">&quot;DEBUG_0&quot;</span><span class="p">,</span>
	<span class="s">&quot;DEBUG_1&quot;</span><span class="p">,</span>
	<span class="s">&quot;DEBUG_2&quot;</span><span class="p">,</span>
	<span class="s">&quot;DEBUG_3&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">num</span><span class="p">;</span>
<span class="p">}</span> <span class="n">advanced_lookup</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	<span class="s">&quot;NMI_INTERRUPT_WDG&quot;</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">},</span> <span class="p">{</span>
	<span class="s">&quot;SYSASSERT&quot;</span><span class="p">,</span> <span class="mh">0x35</span><span class="p">},</span> <span class="p">{</span>
	<span class="s">&quot;UCODE_VERSION_MISMATCH&quot;</span><span class="p">,</span> <span class="mh">0x37</span><span class="p">},</span> <span class="p">{</span>
	<span class="s">&quot;BAD_COMMAND&quot;</span><span class="p">,</span> <span class="mh">0x38</span><span class="p">},</span> <span class="p">{</span>
	<span class="s">&quot;NMI_INTERRUPT_DATA_ACTION_PT&quot;</span><span class="p">,</span> <span class="mh">0x3C</span><span class="p">},</span> <span class="p">{</span>
	<span class="s">&quot;FATAL_ERROR&quot;</span><span class="p">,</span> <span class="mh">0x3D</span><span class="p">},</span> <span class="p">{</span>
	<span class="s">&quot;NMI_TRM_HW_ERR&quot;</span><span class="p">,</span> <span class="mh">0x46</span><span class="p">},</span> <span class="p">{</span>
	<span class="s">&quot;NMI_INTERRUPT_TRM&quot;</span><span class="p">,</span> <span class="mh">0x4C</span><span class="p">},</span> <span class="p">{</span>
	<span class="s">&quot;NMI_INTERRUPT_BREAK_POINT&quot;</span><span class="p">,</span> <span class="mh">0x54</span><span class="p">},</span> <span class="p">{</span>
	<span class="s">&quot;NMI_INTERRUPT_WDG_RXF_FULL&quot;</span><span class="p">,</span> <span class="mh">0x5C</span><span class="p">},</span> <span class="p">{</span>
	<span class="s">&quot;NMI_INTERRUPT_WDG_NO_RBD_RXF_FULL&quot;</span><span class="p">,</span> <span class="mh">0x64</span><span class="p">},</span> <span class="p">{</span>
	<span class="s">&quot;NMI_INTERRUPT_HOST&quot;</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">},</span> <span class="p">{</span>
	<span class="s">&quot;NMI_INTERRUPT_ACTION_PT&quot;</span><span class="p">,</span> <span class="mh">0x7C</span><span class="p">},</span> <span class="p">{</span>
	<span class="s">&quot;NMI_INTERRUPT_UNKNOWN&quot;</span><span class="p">,</span> <span class="mh">0x84</span><span class="p">},</span> <span class="p">{</span>
	<span class="s">&quot;NMI_INTERRUPT_INST_ACTION_PT&quot;</span><span class="p">,</span> <span class="mh">0x86</span><span class="p">},</span> <span class="p">{</span>
<span class="s">&quot;ADVANCED_SYSASSERT&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">},};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">il4965_desc_lookup</span><span class="p">(</span><span class="n">u32</span> <span class="n">num</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">desc_lookup_text</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">num</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">desc_lookup_text</span><span class="p">[</span><span class="n">num</span><span class="p">];</span>

	<span class="n">max</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">advanced_lookup</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">max</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">advanced_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">num</span> <span class="o">==</span> <span class="n">num</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">advanced_lookup</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ERROR_START_OFFSET  (1 * sizeof(u32))</span>
<span class="cp">#define ERROR_ELEM_SIZE     (7 * sizeof(u32))</span>

<span class="kt">void</span>
<span class="nf">il4965_dump_nic_error_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">data2</span><span class="p">,</span> <span class="n">line</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">desc</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">data1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">blink1</span><span class="p">,</span> <span class="n">blink2</span><span class="p">,</span> <span class="n">ilink1</span><span class="p">,</span> <span class="n">ilink2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pc</span><span class="p">,</span> <span class="n">hcmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_type</span> <span class="o">==</span> <span class="n">UCODE_INIT</span><span class="p">)</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">card_alive_init</span><span class="p">.</span><span class="n">error_event_table_ptr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">base</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">card_alive</span><span class="p">.</span><span class="n">error_event_table_ptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">is_valid_rtc_data_addr</span><span class="p">(</span><span class="n">base</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Not valid error log pointer 0x%08X for %s uCode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">base</span><span class="p">,</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_type</span> <span class="o">==</span> <span class="n">UCODE_INIT</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Init&quot;</span> <span class="o">:</span> <span class="s">&quot;RT&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ERROR_START_OFFSET</span> <span class="o">&lt;=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">ERROR_ELEM_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Start IWL Error Log Dump:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Status: 0x%08lX, count: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">desc</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">err_code</span> <span class="o">=</span> <span class="n">desc</span><span class="p">;</span>
	<span class="n">pc</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">blink1</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">blink2</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">ilink1</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">ilink2</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">data1</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">data2</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">8</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">line</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">9</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">time</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">11</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
	<span class="n">hcmd</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="mi">22</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

	<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Desc                                  Time       &quot;</span>
	       <span class="s">&quot;data1      data2      line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;%-28s (0x%04X) %010u 0x%08X 0x%08X %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">il4965_desc_lookup</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="n">desc</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>
	<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;pc      blink1  blink2  ilink1  ilink2  hcmd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;0x%05X 0x%05X 0x%05X 0x%05X 0x%05X 0x%05X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pc</span><span class="p">,</span> <span class="n">blink1</span><span class="p">,</span>
	       <span class="n">blink2</span><span class="p">,</span> <span class="n">ilink1</span><span class="p">,</span> <span class="n">ilink2</span><span class="p">,</span> <span class="n">hcmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_rf_kill_ct_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_ct_kill_config</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_CLR</span><span class="p">,</span>
	       <span class="n">CSR_UCODE_DRV_GP1_REG_BIT_CT_KILL_EXIT</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">critical_temperature_R</span> <span class="o">=</span>
	    <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">ct_kill_threshold</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il_send_cmd_pdu</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">C_CT_KILL_CONFIG</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;C_CT_KILL_CONFIG failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;C_CT_KILL_CONFIG &quot;</span> <span class="s">&quot;succeeded, &quot;</span>
		       <span class="s">&quot;critical temperature is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">ct_kill_threshold</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">s8</span> <span class="n">default_queue_to_tx_fifo</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">IL_TX_FIFO_VO</span><span class="p">,</span>
	<span class="n">IL_TX_FIFO_VI</span><span class="p">,</span>
	<span class="n">IL_TX_FIFO_BE</span><span class="p">,</span>
	<span class="n">IL_TX_FIFO_BK</span><span class="p">,</span>
	<span class="n">IL49_CMD_FIFO_NUM</span><span class="p">,</span>
	<span class="n">IL_TX_FIFO_UNUSED</span><span class="p">,</span>
	<span class="n">IL_TX_FIFO_UNUSED</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define IL_MASK(lo, hi) ((1 &lt;&lt; (hi)) | ((1 &lt;&lt; (hi)) - (1 &lt;&lt; (lo))))</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_alive_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">a</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">chan</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">reg_val</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Clear 4965&#39;s internal Tx Scheduler data base */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">scd_base_addr</span> <span class="o">=</span> <span class="n">il_rd_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL49_SCD_SRAM_BASE_ADDR</span><span class="p">);</span>
	<span class="n">a</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scd_base_addr</span> <span class="o">+</span> <span class="n">IL49_SCD_CONTEXT_DATA_OFFSET</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scd_base_addr</span> <span class="o">+</span> <span class="n">IL49_SCD_TX_STTS_BITMAP_OFFSET</span><span class="p">;</span> <span class="n">a</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">il_write_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">a</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scd_base_addr</span> <span class="o">+</span> <span class="n">IL49_SCD_TRANSLATE_TBL_OFFSET</span><span class="p">;</span> <span class="n">a</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">il_write_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(;</span>
	     <span class="n">a</span> <span class="o">&lt;</span>
	     <span class="n">il</span><span class="o">-&gt;</span><span class="n">scd_base_addr</span> <span class="o">+</span>
	     <span class="n">IL49_SCD_TRANSLATE_TBL_OFFSET_QUEUE</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_txq_num</span><span class="p">);</span>
	     <span class="n">a</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="n">il_write_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Tel 4965 where to find Tx byte count tables */</span>
	<span class="n">il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL49_SCD_DRAM_BASE_ADDR</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scd_bc_tbls</span><span class="p">.</span><span class="n">dma</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* Enable DMA channel */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">chan</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">chan</span> <span class="o">&lt;</span> <span class="n">FH49_TCSR_CHNL_NUM</span><span class="p">;</span> <span class="n">chan</span><span class="o">++</span><span class="p">)</span>
		<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_TCSR_CHNL_TX_CONFIG_REG</span><span class="p">(</span><span class="n">chan</span><span class="p">),</span>
		      <span class="n">FH49_TCSR_TX_CONFIG_REG_VAL_DMA_CHNL_ENABLE</span> <span class="o">|</span>
		      <span class="n">FH49_TCSR_TX_CONFIG_REG_VAL_DMA_CREDIT_ENABLE</span><span class="p">);</span>

	<span class="cm">/* Update FH chicken bits */</span>
	<span class="n">reg_val</span> <span class="o">=</span> <span class="n">il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_TX_CHICKEN_BITS_REG</span><span class="p">);</span>
	<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH49_TX_CHICKEN_BITS_REG</span><span class="p">,</span>
	      <span class="n">reg_val</span> <span class="o">|</span> <span class="n">FH49_TX_CHICKEN_BITS_SCD_AUTO_RETRY_EN</span><span class="p">);</span>

	<span class="cm">/* Disable chain mode for all queues */</span>
	<span class="n">il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL49_SCD_QUEUECHAIN_SEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Initialize each Tx queue (including the command queue) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_txq_num</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* TFD circular buffer read/write idxes */</span>
		<span class="n">il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL49_SCD_QUEUE_RDPTR</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">HBUS_TARG_WRPTR</span><span class="p">,</span> <span class="mi">0</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>

		<span class="cm">/* Max Tx Window size for Scheduler-ACK mode */</span>
		<span class="n">il_write_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span>
				  <span class="n">il</span><span class="o">-&gt;</span><span class="n">scd_base_addr</span> <span class="o">+</span>
				  <span class="n">IL49_SCD_CONTEXT_QUEUE_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">),</span>
				  <span class="p">(</span><span class="n">SCD_WIN_SIZE</span> <span class="o">&lt;&lt;</span>
				   <span class="n">IL49_SCD_QUEUE_CTX_REG1_WIN_SIZE_POS</span><span class="p">)</span> <span class="o">&amp;</span>
				  <span class="n">IL49_SCD_QUEUE_CTX_REG1_WIN_SIZE_MSK</span><span class="p">);</span>

		<span class="cm">/* Frame limit */</span>
		<span class="n">il_write_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span>
				  <span class="n">il</span><span class="o">-&gt;</span><span class="n">scd_base_addr</span> <span class="o">+</span>
				  <span class="n">IL49_SCD_CONTEXT_QUEUE_OFFSET</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">+</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
				  <span class="p">(</span><span class="n">SCD_FRAME_LIMIT</span> <span class="o">&lt;&lt;</span>
				   <span class="n">IL49_SCD_QUEUE_CTX_REG2_FRAME_LIMIT_POS</span><span class="p">)</span> <span class="o">&amp;</span>
				  <span class="n">IL49_SCD_QUEUE_CTX_REG2_FRAME_LIMIT_MSK</span><span class="p">);</span>

	<span class="p">}</span>
	<span class="n">il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL49_SCD_INTERRUPT_MASK</span><span class="p">,</span>
		   <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_txq_num</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Activate all Tx DMA/FIFO channels */</span>
	<span class="n">il4965_txq_set_sched</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL_MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>

	<span class="n">il4965_set_wr_ptrs</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL_DEFAULT_CMD_QUEUE_NUM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* make sure all queue are not stopped */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">queue_stopped</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">queue_stopped</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">queue_stop_count</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* reset to 0 to enable all the queue first */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">txq_ctx_active_msk</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Map each Tx/cmd queue to its corresponding fifo */</span>
	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">default_queue_to_tx_fifo</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">7</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">default_queue_to_tx_fifo</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ac</span> <span class="o">=</span> <span class="n">default_queue_to_tx_fifo</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">il_txq_ctx_activate</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ac</span> <span class="o">==</span> <span class="n">IL_TX_FIFO_UNUSED</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">il4965_tx_queue_set_status</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">ac</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il4965_alive_start - called after N_ALIVE notification received</span>
<span class="cm"> *                   from protocol/runtime uCode (initialization uCode&#39;s</span>
<span class="cm"> *                   Alive gets handled by il_init_alive_start()).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_alive_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Runtime Alive received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">card_alive</span><span class="p">.</span><span class="n">is_valid</span> <span class="o">!=</span> <span class="n">UCODE_VALID_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We had an error bringing up the hardware, so take it</span>
<span class="cm">		 * all the way back down so we can try again */</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Alive failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize uCode has loaded Runtime uCode ... verify inst image.</span>
<span class="cm">	 * This is a paranoid check, because we would not have gotten the</span>
<span class="cm">	 * &quot;runtime&quot; alive if code weren&#39;t properly loaded.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il4965_verify_ucode</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Runtime instruction load was bad;</span>
<span class="cm">		 * take it all the way back down so we can try again */</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Bad runtime uCode load.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_alive_notify</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Could not complete ALIVE transition [ntf]: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* After the ALIVE response, we can send host commands to the uCode */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">S_ALIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* Enable watchdog to monitor the driver tx queues */</span>
	<span class="n">il_setup_watchdog</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_rfkill</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">active_rate</span> <span class="o">=</span> <span class="n">RATES_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_associated</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">il_rxon_cmd</span> <span class="o">*</span><span class="n">active_rxon</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">il_rxon_cmd</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">;</span>
		<span class="cm">/* apply any changes in staging */</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">|=</span> <span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>
		<span class="n">active_rxon</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Initialize our rx_config data */</span>
		<span class="n">il_connection_init_rx_config</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rxon_chain</span><span class="p">)</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rxon_chain</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Configure bluetooth coexistence if enabled */</span>
	<span class="n">il_send_bt_config</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">il4965_reset_run_time_calib</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">S_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* Configure the adapter for unassociated operation */</span>
	<span class="n">il_commit_rxon</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/* At this point, the NIC is initialized and operational */</span>
	<span class="n">il4965_rf_kill_ct_config</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;ALIVE processing complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>

	<span class="n">il_power_update_mode</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Updated power mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">restart:</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">restart</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">il4965_cancel_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__il4965_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">exit_pending</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot; is going down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">il_scan_cancel_timeout</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>

	<span class="n">exit_pending</span> <span class="o">=</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* Stop TX queues watchdog. We need to have S_EXIT_PENDING bit set</span>
<span class="cm">	 * to prevent rearm timer */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>

	<span class="n">il_clear_ucode_stations</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/* FIXME: race conditions ? */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Remove all key information that is not stored as part</span>
<span class="cm">	 * of station information since mac80211 may not have had</span>
<span class="cm">	 * a chance to remove all the keys. When device is</span>
<span class="cm">	 * reconfigured by mac80211 after an error all keys will</span>
<span class="cm">	 * be reconfigured.</span>
<span class="cm">	 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">wep_keys</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">wep_keys</span><span class="p">));</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">key_mapping_keys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>

	<span class="n">il_dealloc_bcast_stations</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il_clear_driver_stations</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/* Unblock any waiting calls */</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>

	<span class="cm">/* Wipe out the EXIT_PENDING status bit if we are not actually</span>
<span class="cm">	 * exiting the module */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exit_pending</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* stop and reset the on-board processor */</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_RESET</span><span class="p">,</span> <span class="n">CSR_RESET_REG_FLAG_NEVO_RESET</span><span class="p">);</span>

	<span class="cm">/* tell the device to stop sending interrupts */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il_disable_interrupts</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il4965_synchronize_irq</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span><span class="p">)</span>
		<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* If we have not previously called il_init() then</span>
<span class="cm">	 * clear all bits but the RF Kill bit and return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il_is_init</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S_RFKILL</span> <span class="o">|</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_GEO_CONFIGURED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S_GEO_CONFIGURED</span> <span class="o">|</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S_EXIT_PENDING</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ...otherwise clear out all the status bits but the RF Kill</span>
<span class="cm">	 * bit and continue taking the NIC down. */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S_RFKILL</span> <span class="o">|</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_GEO_CONFIGURED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S_GEO_CONFIGURED</span> <span class="o">|</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_FW_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S_FW_ERROR</span> <span class="o">|</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S_EXIT_PENDING</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We disabled and synchronized interrupt, and priv-&gt;mutex is taken, so</span>
<span class="cm">	 * here is the only thread which will program device registers, but</span>
<span class="cm">	 * still have lockdep assertions, so we are taking reg_lock.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="cm">/* FIXME: il_grab_nic_access if rfkill is off ? */</span>

	<span class="n">il4965_txq_ctx_stop</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il4965_rxq_stop</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="cm">/* Power-down device&#39;s busmaster DMA clocks */</span>
	<span class="n">_il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">APMG_CLK_DIS_REG</span><span class="p">,</span> <span class="n">APMG_CLK_VAL_DMA_CLK_RQT</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="cm">/* Make sure (redundant) we&#39;ve released our request to stay awake */</span>
	<span class="n">_il_clear_bit</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_GP_CNTRL</span><span class="p">,</span> <span class="n">CSR_GP_CNTRL_REG_FLAG_MAC_ACCESS_REQ</span><span class="p">);</span>
	<span class="cm">/* Stop the device, and put it in low power state */</span>
	<span class="n">_il_apm_stop</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="n">il4965_txq_ctx_unmap</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">card_alive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_alive_resp</span><span class="p">));</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* clear out any free frames */</span>
	<span class="n">il4965_clear_free_frames</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">__il4965_down</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">il4965_cancel_deferred_work</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_set_hw_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">il_set_bit</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_HW_IF_CONFIG_REG</span><span class="p">,</span>
		   <span class="n">CSR_HW_IF_CONFIG_REG_BIT_NIC_READY</span><span class="p">);</span>

	<span class="cm">/* See if we got it */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">_il_poll_bit</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_HW_IF_CONFIG_REG</span><span class="p">,</span>
			   <span class="n">CSR_HW_IF_CONFIG_REG_BIT_NIC_READY</span><span class="p">,</span>
			   <span class="n">CSR_HW_IF_CONFIG_REG_BIT_NIC_READY</span><span class="p">,</span>
			   <span class="mi">100</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_ready</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;hardware %s ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_ready</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;&quot;</span> <span class="o">:</span> <span class="s">&quot;not&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_prepare_card_hw</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_ready</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">il4965_set_hw_ready</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_ready</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* If HW is not ready, prepare the conditions to check again */</span>
	<span class="n">il_set_bit</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_HW_IF_CONFIG_REG</span><span class="p">,</span> <span class="n">CSR_HW_IF_CONFIG_REG_PREPARE</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span>
	    <span class="n">_il_poll_bit</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_HW_IF_CONFIG_REG</span><span class="p">,</span>
			 <span class="o">~</span><span class="n">CSR_HW_IF_CONFIG_REG_BIT_NIC_PREPARE_DONE</span><span class="p">,</span>
			 <span class="n">CSR_HW_IF_CONFIG_REG_BIT_NIC_PREPARE_DONE</span><span class="p">,</span> <span class="mi">150000</span><span class="p">);</span>

	<span class="cm">/* HW should be ready by now, check again. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">)</span>
		<span class="n">il4965_set_hw_ready</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MAX_HW_RESTARTS 5</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__il4965_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Exit pending; will not bring the NIC up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">.</span><span class="n">v_addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">.</span><span class="n">v_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;ucode not available for device bringup</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_alloc_bcast_station</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">il_dealloc_bcast_stations</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">il4965_prepare_card_hw</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;HW not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If platform&#39;s RF_KILL switch is NOT set to KILL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_GP_CNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR_GP_CNTRL_REG_FLAG_HW_RF_KILL_SW</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

		<span class="n">il_enable_rfkill_int</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Radio disabled by HW RF Kill switch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

	<span class="cm">/* must be initialised before il_hw_nic_init */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">cmd_queue</span> <span class="o">=</span> <span class="n">IL_DEFAULT_CMD_QUEUE_NUM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_hw_nic_init</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to init nic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make sure rfkill handshake bits are cleared */</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_CLR</span><span class="p">,</span> <span class="n">CSR_UCODE_SW_BIT_RFKILL</span><span class="p">);</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_CLR</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_BIT_CMD_BLOCKED</span><span class="p">);</span>

	<span class="cm">/* clear (again), then enable host interrupts */</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">il_enable_interrupts</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/* really make sure rfkill handshake bits are cleared */</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_CLR</span><span class="p">,</span> <span class="n">CSR_UCODE_SW_BIT_RFKILL</span><span class="p">);</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_CLR</span><span class="p">,</span> <span class="n">CSR_UCODE_SW_BIT_RFKILL</span><span class="p">);</span>

	<span class="cm">/* Copy original ucode data image from disk into backup cache.</span>
<span class="cm">	 * This will be used to initialize the on-board processor&#39;s</span>
<span class="cm">	 * data SRAM for a clean start when the runtime program first loads. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span>
	       <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_HW_RESTARTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* load bootstrap state machine,</span>
<span class="cm">		 * load bootstrap program into processor&#39;s memory,</span>
<span class="cm">		 * prepare to load the &quot;initialize&quot; uCode */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">load_ucode</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to set up bootstrap uCode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* start card; &quot;initialize&quot; will load runtime ucode */</span>
		<span class="n">il4965_nic_start</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

		<span class="n">D_INFO</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot; is coming up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">__il4965_down</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* tried to restart and config the device for as long as our</span>
<span class="cm">	 * patience could withstand */</span>
	<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to initialize device after %d attempts.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Workqueue callbacks</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_bg_init_alive_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_priv</span><span class="p">,</span> <span class="n">init_alive_start</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">init_alive_start</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_bg_alive_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_priv</span><span class="p">,</span> <span class="n">alive_start</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">il4965_alive_start</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_bg_run_time_calib_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_priv</span><span class="p">,</span>
					  <span class="n">run_time_calib_work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">start_calib</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">il4965_chain_noise_calibration</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">stats</span><span class="p">);</span>
		<span class="n">il4965_sensitivity_calibration</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">stats</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_bg_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_priv</span><span class="p">,</span> <span class="n">restart</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">S_FW_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">is_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">__il4965_down</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">il4965_cancel_deferred_work</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="n">ieee80211_restart_hw</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">il4965_down</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">__il4965_up</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_bg_rx_replenish</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_priv</span><span class="p">,</span> <span class="n">rx_replenish</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">il4965_rx_replenish</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * mac80211 entry point functions</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#define UCODE_READY_TIMEOUT	(4 * HZ)</span>

<span class="cm">/*</span>
<span class="cm"> * Not a mac80211 entry point function, but it fits in with all the</span>
<span class="cm"> * other mac80211 functions grouped here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_mac_setup_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u32</span> <span class="n">max_probe_length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rate_control_algorithm</span> <span class="o">=</span> <span class="s">&quot;iwl-4965-rs&quot;</span><span class="p">;</span>

	<span class="cm">/* Tell mac80211 our characteristics */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span>
	    <span class="n">IEEE80211_HW_SIGNAL_DBM</span> <span class="o">|</span> <span class="n">IEEE80211_HW_AMPDU_AGGREGATION</span> <span class="o">|</span>
	    <span class="n">IEEE80211_HW_NEED_DTIM_PERIOD</span> <span class="o">|</span> <span class="n">IEEE80211_HW_SPECTRUM_MGMT</span> <span class="o">|</span>
	    <span class="n">IEEE80211_HW_REPORTS_TX_ACK_STATUS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">sku</span> <span class="o">&amp;</span> <span class="n">IL_SKU_N</span><span class="p">)</span>
		<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
		    <span class="n">IEEE80211_HW_SUPPORTS_DYNAMIC_SMPS</span> <span class="o">|</span>
		    <span class="n">IEEE80211_HW_SUPPORTS_STATIC_SMPS</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">sta_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_station_priv</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vif_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_vif_priv</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span>
	    <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
	    <span class="n">WIPHY_FLAG_CUSTOM_REGULATORY</span> <span class="o">|</span> <span class="n">WIPHY_FLAG_DISABLE_BEACON_HINTS</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For now, disable PS by default because it affects</span>
<span class="cm">	 * RX performance significantly.</span>
<span class="cm">	 */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">WIPHY_FLAG_PS_ON_BY_DEFAULT</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ssids</span> <span class="o">=</span> <span class="n">PROBE_OPTION_MAX</span><span class="p">;</span>
	<span class="cm">/* we create the 802.11 header and a zero-length SSID element */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ie_len</span> <span class="o">=</span> <span class="n">max_probe_length</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Default value; 4 EDCA QOS priorities */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">max_listen_interval</span> <span class="o">=</span> <span class="n">IL_CONN_MAX_LISTEN_INTERVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">n_channels</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span>
		    <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">n_channels</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span>
		    <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">];</span>

	<span class="n">il_leds_init</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Failed to register hw (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_mac_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* we should be verifying the device is ready to be opened */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__il4965_up</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_rfkill</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Start UP work done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Wait for START_ALIVE from Run Time ucode. Otherwise callbacks from</span>
<span class="cm">	 * mac80211 will not be run successfully. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">,</span>
				 <span class="n">test_bit</span><span class="p">(</span><span class="n">S_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span>
				 <span class="n">UCODE_READY_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;START_ALIVE timeout after %dms.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">UCODE_READY_TIMEOUT</span><span class="p">));</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">il4965_led_enable</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">is_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_mac_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">is_open</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">is_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">il4965_down</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>

	<span class="cm">/* User space software may expect getting rfkill changes</span>
<span class="cm">	 * even if interface is down */</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">il_enable_rfkill_int</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_mac_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">D_MACDUMP</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;dev-&gt;xmit(%d bytes) at rate 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
	     <span class="n">ieee80211_get_tx_rate</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il4965_tx_skb</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">D_MACDUMP</span><span class="p">(</span><span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_mac_update_tkip_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u32</span> <span class="n">iv32</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">phase1key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">il4965_update_tkip_key</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">keyconf</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">iv32</span><span class="p">,</span> <span class="n">phase1key</span><span class="p">);</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_mac_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">set_key_cmd</span> <span class="n">cmd</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sta_id</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_default_wep_key</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mod_params</span><span class="o">-&gt;</span><span class="n">sw_crypto</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave - hwcrypto disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">il_sta_id_or_broadcast</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IL_INVALID_STATION</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">il_scan_cancel_timeout</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * If we are getting WEP group key and we didn&#39;t receive any key mapping</span>
<span class="cm">	 * so far, we are in legacy wep mode (group key only), otherwise we are</span>
<span class="cm">	 * in 1X mode.</span>
<span class="cm">	 * In legacy wep mode, we use another host command to the uCode.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span> <span class="o">||</span>
	     <span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">sta</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SET_KEY</span><span class="p">)</span>
			<span class="n">is_default_wep_key</span> <span class="o">=</span> <span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">key_mapping_keys</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">is_default_wep_key</span> <span class="o">=</span>
			    <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">==</span> <span class="n">HW_KEY_DEFAULT</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SET_KEY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_default_wep_key</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_set_default_wep_key</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_set_dynamic_key</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>

		<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;enable hwcrypto key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISABLE_KEY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">is_default_wep_key</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_remove_default_wep_key</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_remove_dynamic_key</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>

		<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;disable hwcrypto key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_mac_ampdu_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
			<span class="k">enum</span> <span class="n">ieee80211_ampdu_mlme_action</span> <span class="n">action</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span> <span class="n">u16</span> <span class="n">tid</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span> <span class="n">ssn</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">buf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;A-MPDU action on addr %pM tid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">sku</span> <span class="o">&amp;</span> <span class="n">IL_SKU_N</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_START</span>:
		<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;start Rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_sta_rx_agg_start</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="o">*</span><span class="n">ssn</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_RX_STOP</span>:
		<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;stop Rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_sta_rx_agg_stop</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_START</span>:
		<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;start Tx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_tx_agg_start</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">,</span> <span class="n">ssn</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_STOP</span>:
		<span class="n">D_HT</span><span class="p">(</span><span class="s">&quot;stop Tx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_tx_agg_stop</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">vif</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">tid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_AMPDU_TX_OPERATIONAL</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il4965_mac_sta_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_station_priv</span> <span class="o">*</span><span class="n">sta_priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_ap</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sta_id</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;received request to add station %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;proceeding to add station %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">sta_id</span> <span class="o">=</span> <span class="n">IL_INVALID_STATION</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">pending_frames</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span>
	    <span class="n">il_add_station_common</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">is_ap</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to add station %pM (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="cm">/* Should we return success if return code is EEXIST ? */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">sta_id</span> <span class="o">=</span> <span class="n">sta_id</span><span class="p">;</span>

	<span class="cm">/* Initialize rate scaling */</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Initializing rate scaling for station %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">il4965_rs_rate_init</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_mac_channel_switch</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_channel_switch</span> <span class="o">*</span><span class="n">ch_switch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">il_channel_info</span> <span class="o">*</span><span class="n">ch_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">ch_switch</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_ht_config</span> <span class="o">*</span><span class="n">ht_conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">ch</span><span class="p">;</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_rfkill</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_CHANNEL_SWITCH_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il_is_associated</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_channel_switch</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">channel</span><span class="p">)</span> <span class="o">==</span> <span class="n">ch</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">ch_info</span> <span class="o">=</span> <span class="n">il_get_channel_info</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il_is_channel_valid</span><span class="p">(</span><span class="n">ch_info</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;invalid channel</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">.</span><span class="n">smps</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">smps_mode</span><span class="p">;</span>

	<span class="cm">/* Configure HT40 channels */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">enabled</span> <span class="o">=</span> <span class="n">conf_is_ht</span><span class="p">(</span><span class="n">conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">enabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht40_minus</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">extension_chan_offset</span> <span class="o">=</span>
			    <span class="n">IEEE80211_HT_PARAM_CHA_SEC_BELOW</span><span class="p">;</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conf_is_ht40_plus</span><span class="p">(</span><span class="n">conf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">extension_chan_offset</span> <span class="o">=</span>
			    <span class="n">IEEE80211_HT_PARAM_CHA_SEC_ABOVE</span><span class="p">;</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">extension_chan_offset</span> <span class="o">=</span>
			    <span class="n">IEEE80211_HT_PARAM_CHA_SEC_NONE</span><span class="p">;</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ht</span><span class="p">.</span><span class="n">is_40mhz</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">channel</span><span class="p">)</span> <span class="o">!=</span> <span class="n">ch</span><span class="p">))</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">il_set_rxon_channel</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>
	<span class="n">il_set_rxon_ht</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">ht_conf</span><span class="p">);</span>
	<span class="n">il_set_flags_for_band</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">il_set_rate</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * at this point, staging_rxon has the</span>
<span class="cm">	 * configuration for channel switch</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">S_CHANNEL_SWITCH_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">switch_channel</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_channel_switch</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">ch_switch</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_CHANNEL_SWITCH_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">switch_channel</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ieee80211_chswitch_done</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed_flags</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">,</span> <span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">filter_or</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">filter_nand</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define CHK(test, flag)	do { \</span>
<span class="cp">	if (*total_flags &amp; (test))		\</span>
<span class="cp">		filter_or |= (flag);		\</span>
<span class="cp">	else					\</span>
<span class="cp">		filter_nand |= (flag);		\</span>
<span class="cp">	} while (0)</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;Enter: changed: 0x%x, total: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">changed_flags</span><span class="p">,</span>
		   <span class="o">*</span><span class="n">total_flags</span><span class="p">);</span>

	<span class="n">CHK</span><span class="p">(</span><span class="n">FIF_OTHER_BSS</span> <span class="o">|</span> <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">,</span> <span class="n">RXON_FILTER_PROMISC_MSK</span><span class="p">);</span>
	<span class="cm">/* Setting _just_ RXON_FILTER_CTL2HOST_MSK causes FH errors */</span>
	<span class="n">CHK</span><span class="p">(</span><span class="n">FIF_CONTROL</span><span class="p">,</span> <span class="n">RXON_FILTER_CTL2HOST_MSK</span> <span class="o">|</span> <span class="n">RXON_FILTER_PROMISC_MSK</span><span class="p">);</span>
	<span class="n">CHK</span><span class="p">(</span><span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">,</span> <span class="n">RXON_FILTER_BCON_AWARE_MSK</span><span class="p">);</span>

<span class="cp">#undef CHK</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">filter_nand</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">|=</span> <span class="n">filter_or</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Not committing directly because hardware can perform a scan,</span>
<span class="cm">	 * but we&#39;ll eventually commit the filter flags change anyway.</span>
<span class="cm">	 */</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Receiving all multicast frames is always enabled by the</span>
<span class="cm">	 * default flags setup in il_connection_init_rx_config()</span>
<span class="cm">	 * since we currently do not support programming multicast</span>
<span class="cm">	 * filters into the device.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;=</span>
	    <span class="n">FIF_OTHER_BSS</span> <span class="o">|</span> <span class="n">FIF_ALLMULTI</span> <span class="o">|</span> <span class="n">FIF_PROMISC_IN_BSS</span> <span class="o">|</span>
	    <span class="n">FIF_BCN_PRBRESP_PROMISC</span> <span class="o">|</span> <span class="n">FIF_CONTROL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * driver setup and teardown</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_bg_txpower_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_priv</span><span class="p">,</span>
					  <span class="n">txpower_work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* If a scan happened to start before we got here</span>
<span class="cm">	 * then just return; the stats notification will</span>
<span class="cm">	 * kick off another scheduled work to compensate for</span>
<span class="cm">	 * any temperature delta we missed here. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_SCANNING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Regardless of if we are associated, we must reconfigure the</span>
<span class="cm">	 * TX power since frames can be sent on non-radar channels while</span>
<span class="cm">	 * not associated */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">send_tx_power</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/* Update last_temperature to keep is_calib_needed from running</span>
<span class="cm">	 * when it isn&#39;t needed... */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">last_temperature</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">temperature</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_setup_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">restart</span><span class="p">,</span> <span class="n">il4965_bg_restart</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rx_replenish</span><span class="p">,</span> <span class="n">il4965_bg_rx_replenish</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">run_time_calib_work</span><span class="p">,</span> <span class="n">il4965_bg_run_time_calib_work</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">init_alive_start</span><span class="p">,</span> <span class="n">il4965_bg_init_alive_start</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">alive_start</span><span class="p">,</span> <span class="n">il4965_bg_alive_start</span><span class="p">);</span>

	<span class="n">il_setup_scan_deferred_work</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txpower_work</span><span class="p">,</span> <span class="n">il4965_bg_txpower_work</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stats_periodic</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stats_periodic</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">il</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stats_periodic</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">il4965_bg_stats_periodic</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">il</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">il_bg_watchdog</span><span class="p">;</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">il4965_irq_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_cancel_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txpower_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">init_alive_start</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">alive_start</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">run_time_calib_work</span><span class="p">);</span>

	<span class="n">il_cancel_scan_deferred_work</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stats_periodic</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_init_hw_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT_LEGACY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">=</span> <span class="n">il_rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ieee</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>	<span class="cm">/* Rate scaling will work on idxes */</span>
		<span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="n">IL_FIRST_CCK_RATE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;=</span> <span class="n">IL_LAST_CCK_RATE</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If CCK != 1M then set short preamble rate flag.</span>
<span class="cm">			 */</span>
			<span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
			    <span class="p">(</span><span class="n">il_rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">plcp</span> <span class="o">==</span>
			     <span class="n">RATE_1M_PLCP</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Acquire il-&gt;lock before calling this function !</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">il4965_set_wr_ptrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">u32</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">HBUS_TARG_WRPTR</span><span class="p">,</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">txq_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
	<span class="n">il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL49_SCD_QUEUE_RDPTR</span><span class="p">(</span><span class="n">txq_id</span><span class="p">),</span> <span class="n">idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il4965_tx_queue_set_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_tx_queue</span> <span class="o">*</span><span class="n">txq</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">tx_fifo_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scd_retry</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">txq_id</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">.</span><span class="n">id</span><span class="p">;</span>

	<span class="cm">/* Find out whether to activate Tx queue */</span>
	<span class="kt">int</span> <span class="n">active</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">txq_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq_ctx_active_msk</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Set up and activate */</span>
	<span class="n">il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL49_SCD_QUEUE_STATUS_BITS</span><span class="p">(</span><span class="n">txq_id</span><span class="p">),</span>
		   <span class="p">(</span><span class="n">active</span> <span class="o">&lt;&lt;</span> <span class="n">IL49_SCD_QUEUE_STTS_REG_POS_ACTIVE</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">tx_fifo_id</span> <span class="o">&lt;&lt;</span> <span class="n">IL49_SCD_QUEUE_STTS_REG_POS_TXF</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">scd_retry</span> <span class="o">&lt;&lt;</span> <span class="n">IL49_SCD_QUEUE_STTS_REG_POS_WSL</span><span class="p">)</span> <span class="o">|</span>
		   <span class="p">(</span><span class="n">scd_retry</span> <span class="o">&lt;&lt;</span> <span class="n">IL49_SCD_QUEUE_STTS_REG_POS_SCD_ACK</span><span class="p">)</span> <span class="o">|</span>
		   <span class="n">IL49_SCD_QUEUE_STTS_REG_MSK</span><span class="p">);</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">sched_retry</span> <span class="o">=</span> <span class="n">scd_retry</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;%s %s Queue %d on AC %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">active</span> <span class="o">?</span> <span class="s">&quot;Activate&quot;</span> <span class="o">:</span> <span class="s">&quot;Deactivate&quot;</span><span class="p">,</span>
	       <span class="n">scd_retry</span> <span class="o">?</span> <span class="s">&quot;BA&quot;</span> <span class="o">:</span> <span class="s">&quot;AC&quot;</span><span class="p">,</span> <span class="n">txq_id</span><span class="p">,</span> <span class="n">tx_fifo_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">il4965_mac_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">il4965_mac_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">il4965_mac_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">il4965_mac_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span> <span class="o">=</span> <span class="n">il_mac_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span> <span class="o">=</span> <span class="n">il_mac_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_interface</span> <span class="o">=</span> <span class="n">il_mac_change_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">il_mac_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span> <span class="o">=</span> <span class="n">il4965_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_key</span> <span class="o">=</span> <span class="n">il4965_mac_set_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">update_tkip_key</span> <span class="o">=</span> <span class="n">il4965_mac_update_tkip_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conf_tx</span> <span class="o">=</span> <span class="n">il_mac_conf_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_tsf</span> <span class="o">=</span> <span class="n">il_mac_reset_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span> <span class="o">=</span> <span class="n">il_mac_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ampdu_action</span> <span class="o">=</span> <span class="n">il4965_mac_ampdu_action</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_scan</span> <span class="o">=</span> <span class="n">il_mac_hw_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_add</span> <span class="o">=</span> <span class="n">il4965_mac_sta_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_remove</span> <span class="o">=</span> <span class="n">il_mac_sta_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">channel_switch</span> <span class="o">=</span> <span class="n">il4965_mac_channel_switch</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_last_beacon</span> <span class="o">=</span> <span class="n">il_mac_tx_last_beacon</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_init_drv</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hcmd_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">free_frames</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ieee_channels</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ieee_rates</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">current_ht_config</span><span class="p">.</span><span class="n">smps</span> <span class="o">=</span> <span class="n">IEEE80211_SMPS_STATIC</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">missed_beacon_threshold</span> <span class="o">=</span> <span class="n">IL_MISSED_BEACON_THRESHOLD_DEF</span><span class="p">;</span>

	<span class="cm">/* initialize force reset */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">force_reset</span><span class="p">.</span><span class="n">reset_duration</span> <span class="o">=</span> <span class="n">IL_DELAY_NEXT_FORCE_FW_RELOAD</span><span class="p">;</span>

	<span class="cm">/* Choose which receivers/antennas to use */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rxon_chain</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_rxon_chain</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">il_init_scan_params</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il_init_channel_map</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;initializing regulatory failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il_init_geos</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;initializing geos failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_channel_map</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">il4965_init_hw_rates</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ieee_rates</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_channel_map:</span>
	<span class="n">il_free_channel_map</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_uninit_drv</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">il_free_geos</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il_free_channel_map</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_cmd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_hw_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_rev</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_HW_REV</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_wa_rev</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_HW_REV_WA_REG</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">rev_id</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">;</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;HW Revision ID = 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">rev_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">il_sensitivity_ranges</span> <span class="n">il4965_sensitivity</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">min_nrg_cck</span> <span class="o">=</span> <span class="mi">97</span><span class="p">,</span>
	<span class="p">.</span><span class="n">max_nrg_cck</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>	<span class="cm">/* not used, set to 0 */</span>

	<span class="p">.</span><span class="n">auto_corr_min_ofdm</span> <span class="o">=</span> <span class="mi">85</span><span class="p">,</span>
	<span class="p">.</span><span class="n">auto_corr_min_ofdm_mrc</span> <span class="o">=</span> <span class="mi">170</span><span class="p">,</span>
	<span class="p">.</span><span class="n">auto_corr_min_ofdm_x1</span> <span class="o">=</span> <span class="mi">105</span><span class="p">,</span>
	<span class="p">.</span><span class="n">auto_corr_min_ofdm_mrc_x1</span> <span class="o">=</span> <span class="mi">220</span><span class="p">,</span>

	<span class="p">.</span><span class="n">auto_corr_max_ofdm</span> <span class="o">=</span> <span class="mi">120</span><span class="p">,</span>
	<span class="p">.</span><span class="n">auto_corr_max_ofdm_mrc</span> <span class="o">=</span> <span class="mi">210</span><span class="p">,</span>
	<span class="p">.</span><span class="n">auto_corr_max_ofdm_x1</span> <span class="o">=</span> <span class="mi">140</span><span class="p">,</span>
	<span class="p">.</span><span class="n">auto_corr_max_ofdm_mrc_x1</span> <span class="o">=</span> <span class="mi">270</span><span class="p">,</span>

	<span class="p">.</span><span class="n">auto_corr_min_cck</span> <span class="o">=</span> <span class="mi">125</span><span class="p">,</span>
	<span class="p">.</span><span class="n">auto_corr_max_cck</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">auto_corr_min_cck_mrc</span> <span class="o">=</span> <span class="mi">200</span><span class="p">,</span>
	<span class="p">.</span><span class="n">auto_corr_max_cck_mrc</span> <span class="o">=</span> <span class="mi">400</span><span class="p">,</span>

	<span class="p">.</span><span class="n">nrg_th_cck</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nrg_th_ofdm</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>

	<span class="p">.</span><span class="n">barker_corr_th_min</span> <span class="o">=</span> <span class="mi">190</span><span class="p">,</span>
	<span class="p">.</span><span class="n">barker_corr_th_min_mrc</span> <span class="o">=</span> <span class="mi">390</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nrg_th_cca</span> <span class="o">=</span> <span class="mi">62</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il4965_set_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">bcast_id</span> <span class="o">=</span> <span class="n">IL4965_BROADCAST_ID</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_rxq_size</span> <span class="o">=</span> <span class="n">RX_QUEUE_SIZE</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_rxq_log</span> <span class="o">=</span> <span class="n">RX_QUEUE_SIZE_LOG</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mod_params</span><span class="o">-&gt;</span><span class="n">amsdu_size_8K</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">IL_RX_BUF_SIZE_8K</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">IL_RX_BUF_SIZE_4K</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_beacon_itrvl</span> <span class="o">=</span> <span class="n">IL_MAX_UCODE_BEACON_INTERVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mod_params</span><span class="o">-&gt;</span><span class="n">disable_11n</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">sku</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IL_SKU_N</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mod_params</span><span class="o">-&gt;</span><span class="n">num_of_queues</span> <span class="o">&gt;=</span> <span class="n">IL_MIN_NUM_QUEUES</span> <span class="o">&amp;&amp;</span>
	    <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mod_params</span><span class="o">-&gt;</span><span class="n">num_of_queues</span> <span class="o">&lt;=</span> <span class="n">IL49_NUM_QUEUES</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_of_queues</span> <span class="o">=</span>
		    <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">mod_params</span><span class="o">-&gt;</span><span class="n">num_of_queues</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_txq_num</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_of_queues</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">dma_chnl_num</span> <span class="o">=</span> <span class="n">FH49_TCSR_CHNL_NUM</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">scd_bc_tbls_size</span> <span class="o">=</span>
	    <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">num_of_queues</span> <span class="o">*</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il4965_scd_bc_tbl</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">tfd_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_tfd</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_stations</span> <span class="o">=</span> <span class="n">IL4965_STATION_COUNT</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_data_size</span> <span class="o">=</span> <span class="n">IL49_RTC_DATA_SIZE</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_inst_size</span> <span class="o">=</span> <span class="n">IL49_RTC_INST_SIZE</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">max_bsm_size</span> <span class="o">=</span> <span class="n">BSM_SRAM_SIZE</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">ht40_channel</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_wrt_ptr_reg</span> <span class="o">=</span> <span class="n">FH49_RSCSR_CHNL0_WPTR</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">tx_chains_num</span> <span class="o">=</span> <span class="n">il4965_num_of_ant</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">valid_tx_ant</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_chains_num</span> <span class="o">=</span> <span class="n">il4965_num_of_ant</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">valid_rx_ant</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_tx_ant</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">valid_tx_ant</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">valid_rx_ant</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">valid_rx_ant</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">ct_kill_threshold</span> <span class="o">=</span>
	   <span class="n">CELSIUS_TO_KELVIN</span><span class="p">(</span><span class="n">CT_KILL_THRESHOLD_LEGACY</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">sens</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il4965_sensitivity</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">beacon_time_tsf_bits</span> <span class="o">=</span> <span class="n">IL4965_EXT_BEACON_TIME_POS</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il4965_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_cfg</span> <span class="o">*</span><span class="p">)(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">pci_cmd</span><span class="p">;</span>

	<span class="cm">/************************</span>
<span class="cm">	 * 1. Allocating HW data</span>
<span class="cm">	 ************************/</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">ieee80211_alloc_hw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">il4965_mac_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;*** LOAD DRIVER ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il4965_ops</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUGFS</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">debugfs_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il4965_debugfs_ops</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">inta_mask</span> <span class="o">=</span> <span class="n">CSR_INI_SET_MASK</span><span class="p">;</span>

	<span class="cm">/**************************</span>
<span class="cm">	 * 2. Initializing PCI bus</span>
<span class="cm">	 **************************/</span>
	<span class="n">pci_disable_link_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
			       <span class="n">PCIE_LINK_STATE_L0S</span> <span class="o">|</span> <span class="n">PCIE_LINK_STATE_L1</span> <span class="o">|</span>
			       <span class="n">PCIE_LINK_STATE_CLKPM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_ieee80211_free_hw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">36</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">36</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
			<span class="n">err</span> <span class="o">=</span>
			    <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
		<span class="cm">/* both attempts failed: */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;No suitable DMA available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_pci_disable_device</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_pci_disable_device</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">il</span><span class="p">);</span>

	<span class="cm">/***********************</span>
<span class="cm">	 * 3. Read REV register</span>
<span class="cm">	 ***********************/</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_base</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_pci_release_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;pci_resource_len = 0x%08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;pci_resource_base = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_base</span><span class="p">);</span>

	<span class="cm">/* these spin locks will be used in apm_ops.init and EEPROM access</span>
<span class="cm">	 * we should init now</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * stop and reset the on-board processor just in case it is in a</span>
<span class="cm">	 * strange state ... like being left stranded by a primary kernel</span>
<span class="cm">	 * and this is now the kdump kernel trying to start up</span>
<span class="cm">	 */</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_RESET</span><span class="p">,</span> <span class="n">CSR_RESET_REG_FLAG_NEVO_RESET</span><span class="p">);</span>

	<span class="n">il4965_hw_detect</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">IL_INFO</span><span class="p">(</span><span class="s">&quot;Detected %s, REV=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_rev</span><span class="p">);</span>

	<span class="cm">/* We disable the RETRY_TIMEOUT register (0x41) to keep</span>
<span class="cm">	 * PCI Tx retries from interfering with C3 CPU state */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_CFG_RETRY_TIMEOUT</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="n">il4965_prepare_card_hw</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_ready</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Failed, HW not ready</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*****************</span>
<span class="cm">	 * 4. Read EEPROM</span>
<span class="cm">	 *****************/</span>
	<span class="cm">/* Read the EEPROM */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">il_eeprom_init</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to init EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">il4965_eeprom_check_version</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_eeprom</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_eeprom</span><span class="p">;</span>

	<span class="cm">/* extract MAC Address */</span>
	<span class="n">il4965_eeprom_get_mac</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;MAC address: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">addresses</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">addresses</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">n_addresses</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/************************</span>
<span class="cm">	 * 5. Setup HW constants</span>
<span class="cm">	 ************************/</span>
	<span class="n">il4965_set_hw_params</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/*******************</span>
<span class="cm">	 * 6. Setup il</span>
<span class="cm">	 *******************/</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">il4965_init_drv</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_eeprom</span><span class="p">;</span>
	<span class="cm">/* At this point both hw and il are initialized. */</span>

	<span class="cm">/********************</span>
<span class="cm">	 * 7. Setup services</span>
<span class="cm">	 ********************/</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il_disable_interrupts</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">il_isr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Error allocating IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_disable_msi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">il4965_setup_deferred_work</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il4965_setup_handlers</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/*********************************************</span>
<span class="cm">	 * 8. Enable interrupts and read RFKILL state</span>
<span class="cm">	 *********************************************/</span>

	<span class="cm">/* enable rfkill interrupt: hw bug w/a */</span>
	<span class="n">pci_read_config_word</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pci_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_cmd</span> <span class="o">&amp;</span> <span class="n">PCI_COMMAND_INTX_DISABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pci_cmd</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">PCI_COMMAND_INTX_DISABLE</span><span class="p">;</span>
		<span class="n">pci_write_config_word</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">PCI_COMMAND</span><span class="p">,</span> <span class="n">pci_cmd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">il_enable_rfkill_int</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/* If platform&#39;s RF_KILL switch is NOT set to KILL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_GP_CNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR_GP_CNTRL_REG_FLAG_HW_RF_KILL_SW</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
				  <span class="n">test_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

	<span class="n">il_power_initialize</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">firmware_loading_complete</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">il4965_request_firmware</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_destroy_workqueue</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_destroy_workqueue:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">il</span><span class="p">);</span>
<span class="nl">out_disable_msi:</span>
	<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">il4965_uninit_drv</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">out_free_eeprom:</span>
	<span class="n">il_eeprom_free</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">out_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_base</span><span class="p">);</span>
<span class="nl">out_pci_release_regions:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">out_pci_disable_device:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">out_ieee80211_free_hw:</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">il4965_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_4965</span><span class="p">.</span><span class="n">firmware_loading_complete</span><span class="p">);</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;*** UNLOAD DRIVER ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">il_dbgfs_unregister</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il_attribute_group</span><span class="p">);</span>

	<span class="cm">/* ieee80211_unregister_hw call wil cause il_mac_stop to</span>
<span class="cm">	 * to be called and il4965_down since we are removing the device</span>
<span class="cm">	 * we need to set S_EXIT_PENDING bit.</span>
<span class="cm">	 */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">il_leds_exit</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">il4965_down</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure device is reset to low power before unloading driver.</span>
<span class="cm">	 * This may be redundant with il4965_down(), but there are paths to</span>
<span class="cm">	 * run il4965_down() without calling apm_ops.stop(), and there are</span>
<span class="cm">	 * paths to avoid running il4965_down() at all before leaving driver.</span>
<span class="cm">	 * This (inexpensive) call *makes sure* device is reset.</span>
<span class="cm">	 */</span>
	<span class="n">il_apm_stop</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/* make sure we flush any pending irq or</span>
<span class="cm">	 * tasklet for the driver</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il_disable_interrupts</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">il4965_synchronize_irq</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">il4965_dealloc_ucode_pci</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">.</span><span class="n">bd</span><span class="p">)</span>
		<span class="n">il4965_rx_queue_free</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">);</span>
	<span class="n">il4965_hw_txq_ctx_free</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">il_eeprom_free</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/*netif_stop_queue(dev); */</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>

	<span class="cm">/* ieee80211_unregister_hw calls il_mac_stop, which flushes</span>
<span class="cm">	 * il-&gt;workqueue... so we can&#39;t take down the workqueue</span>
<span class="cm">	 * until now... */</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">il</span><span class="p">);</span>
	<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_base</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">il4965_uninit_drv</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="p">);</span>

	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Activate/Deactivate Tx DMA/FIFO channels according tx fifos mask</span>
<span class="cm"> * must be called under il-&gt;lock and mac access</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">il4965_txq_set_sched</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u32</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL49_SCD_TXFACT</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * driver and module entry point</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cm">/* Hardware specific file defines the PCI IDs table for that hardware module */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">il4965_hw_card_ids</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">IL_PCI_DEVICE</span><span class="p">(</span><span class="mh">0x4229</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">il4965_cfg</span><span class="p">)},</span>
	<span class="p">{</span><span class="n">IL_PCI_DEVICE</span><span class="p">(</span><span class="mh">0x4230</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">il4965_cfg</span><span class="p">)},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">il4965_hw_card_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">il4965_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">il4965_hw_card_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">il4965_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">il4965_pci_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="n">IL_LEGACY_PM_OPS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">il4965_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_DESCRIPTION</span> <span class="s">&quot;, &quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_COPYRIGHT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il4965_rate_control_register</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to register rate control algorithm: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il4965_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to initialize PCI module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_register</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">error_register:</span>
	<span class="n">il4965_rate_control_unregister</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">il4965_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il4965_driver</span><span class="p">);</span>
	<span class="n">il4965_rate_control_unregister</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">il4965_exit</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">il4965_init</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">il_debug_level</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;debug output mask&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">swcrypto</span><span class="p">,</span> <span class="n">il4965_mod_params</span><span class="p">.</span><span class="n">sw_crypto</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">swcrypto</span><span class="p">,</span> <span class="s">&quot;using crypto in software (default 0 [hardware])&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">queues_num</span><span class="p">,</span> <span class="n">il4965_mod_params</span><span class="p">.</span><span class="n">num_of_queues</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">queues_num</span><span class="p">,</span> <span class="s">&quot;number of hw queues.&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="mi">11</span><span class="n">n_disable</span><span class="p">,</span> <span class="n">il4965_mod_params</span><span class="p">.</span><span class="n">disable_11n</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="mi">11</span><span class="n">n_disable</span><span class="p">,</span> <span class="s">&quot;disable 11n functionality&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">amsdu_size_8K</span><span class="p">,</span> <span class="n">il4965_mod_params</span><span class="p">.</span><span class="n">amsdu_size_8K</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">amsdu_size_8K</span><span class="p">,</span> <span class="s">&quot;enable 8K amsdu size&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">fw_restart</span><span class="p">,</span> <span class="n">il4965_mod_params</span><span class="p">.</span><span class="n">restart_fw</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fw_restart</span><span class="p">,</span> <span class="s">&quot;restart firmware in case of error&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
