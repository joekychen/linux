<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › iwlegacy › 3945-mac.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>3945-mac.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright(c) 2003 - 2011 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Portions of this file are derived from the ipw3945 project, as well</span>
<span class="cm"> * as portions of the ieee80211 subsystem header files.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of version 2 of the GNU General Public License as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but WITHOUT</span>
<span class="cm"> * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or</span>
<span class="cm"> * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for</span>
<span class="cm"> * more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along with</span>
<span class="cm"> * this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 51 Franklin Street, Fifth Floor, Boston, MA 02110, USA</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> * Contact Information:</span>
<span class="cm"> *  Intel Linux Wireless &lt;ilw@linux.intel.com&gt;</span>
<span class="cm"> * Intel Corporation, 5200 N.E. Elam Young Parkway, Hillsboro, OR 97124-6497</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/pci-aspm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>

<span class="cp">#include &lt;net/ieee80211_radiotap.h&gt;</span>
<span class="cp">#include &lt;net/mac80211.h&gt;</span>

<span class="cp">#include &lt;asm/div64.h&gt;</span>

<span class="cp">#define DRV_NAME	&quot;iwl3945&quot;</span>

<span class="cp">#include &quot;commands.h&quot;</span>
<span class="cp">#include &quot;common.h&quot;</span>
<span class="cp">#include &quot;3945.h&quot;</span>
<span class="cp">#include &quot;iwl-spectrum.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * module name, copyright, version, etc.</span>
<span class="cm"> */</span>

<span class="cp">#define DRV_DESCRIPTION	\</span>
<span class="cp">&quot;Intel(R) PRO/Wireless 3945ABG/BG Network Connection driver for Linux&quot;</span>

<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
<span class="cp">#define VD &quot;d&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define VD</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * add &quot;s&quot; to indicate spectrum measurement included.</span>
<span class="cm"> * we add it here to be consistent with previous releases in which</span>
<span class="cm"> * this was configurable.</span>
<span class="cm"> */</span>
<span class="cp">#define DRV_VERSION  IWLWIFI_VERSION VD &quot;s&quot;</span>
<span class="cp">#define DRV_COPYRIGHT	&quot;Copyright(c) 2003-2011 Intel Corporation&quot;</span>
<span class="cp">#define DRV_AUTHOR     &quot;&lt;ilw@linux.intel.com&gt;&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRV_DESCRIPTION</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRV_VERSION</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRV_COPYRIGHT</span> <span class="s">&quot; &quot;</span> <span class="n">DRV_AUTHOR</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

 <span class="cm">/* module parameters */</span>
<span class="k">struct</span> <span class="n">il_mod_params</span> <span class="n">il3945_mod_params</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">sw_crypto</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">restart_fw</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_hw_scan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="cm">/* the rest are 0 by default */</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_get_antenna_flags - Get antenna flags for RXON command</span>
<span class="cm"> * @il: eeprom and antenna fields are used to determine antenna flags</span>
<span class="cm"> *</span>
<span class="cm"> * il-&gt;eeprom39  is used to determine if antenna AUX/MAIN are reversed</span>
<span class="cm"> * il3945_mod_params.antenna specifies the antenna diversity mode:</span>
<span class="cm"> *</span>
<span class="cm"> * IL_ANTENNA_DIVERSITY - NIC selects best antenna by itself</span>
<span class="cm"> * IL_ANTENNA_MAIN      - Force MAIN antenna</span>
<span class="cm"> * IL_ANTENNA_AUX       - Force AUX antenna</span>
<span class="cm"> */</span>
<span class="n">__le32</span>
<span class="nf">il3945_get_antenna_flags</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il3945_eeprom</span> <span class="o">*</span><span class="n">eeprom</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il3945_eeprom</span> <span class="o">*</span><span class="p">)</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">il3945_mod_params</span><span class="p">.</span><span class="n">antenna</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IL_ANTENNA_DIVERSITY</span>:
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IL_ANTENNA_MAIN</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">antenna_switch_type</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">RXON_FLG_DIS_DIV_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_ANT_B_MSK</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">RXON_FLG_DIS_DIV_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_ANT_A_MSK</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IL_ANTENNA_AUX</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">antenna_switch_type</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">RXON_FLG_DIS_DIV_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_ANT_A_MSK</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">RXON_FLG_DIS_DIV_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_ANT_B_MSK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* bad antenna selector value */</span>
	<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Bad antenna selector value (0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">il3945_mod_params</span><span class="p">.</span><span class="n">antenna</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* &quot;diversity&quot; is default if error */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_set_ccmp_dynamic_key_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">key_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">key_flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">STA_KEY_FLG_CCMP</span> <span class="o">|</span> <span class="n">STA_KEY_FLG_MAP_KEY_MSK</span><span class="p">);</span>
	<span class="n">key_flags</span> <span class="o">|=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span> <span class="o">&lt;&lt;</span> <span class="n">STA_KEY_FLG_KEYID_POS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">bcast_id</span><span class="p">)</span>
		<span class="n">key_flags</span> <span class="o">|=</span> <span class="n">STA_KEY_MULTICAST_MSK</span><span class="p">;</span>

	<span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IEEE80211_KEY_FLAG_GENERATE_IV</span><span class="p">;</span>
	<span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">;</span>
	<span class="n">key_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">STA_KEY_FLG_INVALID</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">.</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">.</span><span class="n">keylen</span> <span class="o">=</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span>
	     <span class="n">key_flags</span> <span class="o">&amp;</span> <span class="n">STA_KEY_FLG_ENCRYPT_MSK</span><span class="p">)</span> <span class="o">==</span> <span class="n">STA_KEY_FLG_NO_ENC</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_offset</span> <span class="o">=</span>
		    <span class="n">il_get_free_ucode_key_idx</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="cm">/* else, we are overriding an existing key =&gt; no need to allocated room</span>
<span class="cm">	 * in uCode. */</span>

	<span class="n">WARN</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_offset</span> <span class="o">==</span> <span class="n">WEP_INVALID_OFFSET</span><span class="p">,</span>
	     <span class="s">&quot;no space for a new key&quot;</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_flags</span> <span class="o">=</span> <span class="n">key_flags</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">modify_mask</span> <span class="o">=</span> <span class="n">STA_MODIFY_KEY_MASK</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STA_CONTROL_MODIFY_MSK</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;hwcrypto: modify ucode station key info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il_send_add_sta</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">,</span> <span class="n">CMD_ASYNC</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_set_tkip_dynamic_key_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_set_wep_dynamic_key_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_clear_sta_key_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">u8</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_addsta_cmd</span> <span class="n">sta_cmd</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_hw_key</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il4965_keyinfo</span><span class="p">));</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">key</span><span class="p">.</span><span class="n">key_flags</span> <span class="o">=</span> <span class="n">STA_KEY_FLG_NO_ENC</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">sta</span><span class="p">.</span><span class="n">modify_mask</span> <span class="o">=</span> <span class="n">STA_MODIFY_KEY_MASK</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">STA_CONTROL_MODIFY_MSK</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sta_cmd</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">sta</span><span class="p">,</span>
	       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_addsta_cmd</span><span class="p">));</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;hwcrypto: clear ucode station key info</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">il_send_add_sta</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta_cmd</span><span class="p">,</span> <span class="n">CMD_SYNC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_set_dynamic_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">keyconf</span><span class="p">,</span>
		       <span class="n">u8</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span> <span class="o">=</span> <span class="n">HW_KEY_DYNAMIC</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">il3945_set_ccmp_dynamic_key_info</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">keyconf</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">il3945_set_tkip_dynamic_key_info</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">keyconf</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="n">il3945_set_wep_dynamic_key_info</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">keyconf</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unknown alg: %s alg=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_WEP</span><span class="p">(</span><span class="s">&quot;Set dynamic key: alg=%x len=%d idx=%d sta=%d ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	      <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">,</span> <span class="n">keyconf</span><span class="o">-&gt;</span><span class="n">keyidx</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_remove_static_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_set_static_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span> <span class="o">||</span>
	    <span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Static key invalid: cipher %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_clear_free_frames</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;%d frames on pre-allocated heap on clear.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">frames_count</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">free_frames</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">element</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">free_frames</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il3945_frame</span><span class="p">,</span> <span class="n">list</span><span class="p">));</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">frames_count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">frames_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;%d frames still in use.  Did we lose one?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">frames_count</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">frames_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">il3945_frame</span> <span class="o">*</span>
<span class="nf">il3945_get_free_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il3945_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">free_frames</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">frame</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frame</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frame</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Could not allocate frame!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">il</span><span class="o">-&gt;</span><span class="n">frames_count</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">frame</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">element</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">free_frames</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
	<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il3945_frame</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_free_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il3945_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">frame</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">frame</span><span class="p">));</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">free_frames</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nf">il3945_fill_beacon_frame</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">left</span><span class="p">)</span>
<span class="p">{</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il_is_associated</span><span class="p">(</span><span class="n">il</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">left</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_send_beacon_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il3945_frame</span> <span class="o">*</span><span class="n">frame</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">frame_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rate</span><span class="p">;</span>

	<span class="n">frame</span> <span class="o">=</span> <span class="n">il3945_get_free_frame</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">frame</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Could not obtain free frame buffer for beacon &quot;</span>
		       <span class="s">&quot;command.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="n">il_get_lowest_plcp</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">frame_size</span> <span class="o">=</span> <span class="n">il3945_hw_get_beacon_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">frame</span><span class="p">,</span> <span class="n">rate</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">il_send_cmd_pdu</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">C_TX_BEACON</span><span class="p">,</span> <span class="n">frame_size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frame</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cmd</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">il3945_free_frame</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">frame</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_unset_hw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">shared_virt</span><span class="p">)</span>
		<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il3945_shared</span><span class="p">),</span>
				  <span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">shared_virt</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">shared_phys</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_build_tx_cmd_hwcrypto</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">il_device_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb_frag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sta_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il3945_tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il3945_tx_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">payload</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_hw_key</span> <span class="o">*</span><span class="n">keyinfo</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">keyinfo</span><span class="p">;</span>

	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sec_ctl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">keyinfo</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sec_ctl</span> <span class="o">=</span> <span class="n">TX_CMD_SEC_CCM</span><span class="p">;</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keyinfo</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keyinfo</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>
		<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;tx_cmd with AES hwcrypto</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sec_ctl</span> <span class="o">|=</span> <span class="n">TX_CMD_SEC_KEY128</span><span class="p">;</span>
		<span class="cm">/* fall through */</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sec_ctl</span> <span class="o">|=</span>
		    <span class="n">TX_CMD_SEC_WEP</span> <span class="o">|</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span>
				      <span class="n">hw_key_idx</span> <span class="o">&amp;</span> <span class="n">TX_CMD_SEC_MSK</span><span class="p">)</span> <span class="o">&lt;&lt;</span>
		    <span class="n">TX_CMD_SEC_SHIFT</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">keyinfo</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">keyinfo</span><span class="o">-&gt;</span><span class="n">keylen</span><span class="p">);</span>

		<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;Configuring packet for WEP encryption &quot;</span> <span class="s">&quot;with key %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		     <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="o">-&gt;</span><span class="n">hw_key_idx</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unknown encode cipher %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">keyinfo</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * handle build C_TX command notification.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_build_tx_cmd_basic</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_device_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span><span class="p">,</span> <span class="n">u8</span> <span class="n">std_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il3945_tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il3945_tx_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">payload</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tx_flags</span> <span class="o">=</span> <span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>

	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">stop_time</span><span class="p">.</span><span class="n">life_time</span> <span class="o">=</span> <span class="n">TX_CMD_LIFE_TIME_INFINITE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_TX_CTL_NO_ACK</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_ACK_MSK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
			<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_probe_resp</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">seq_ctrl</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">))</span>
			<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_TSF_MSK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="o">~</span><span class="n">TX_CMD_FLG_ACK_MSK</span><span class="p">);</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">sta_id</span> <span class="o">=</span> <span class="n">std_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_MORE_FRAG_MSK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tid_tspec</span> <span class="o">=</span> <span class="n">qc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
		<span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tx_flags</span> <span class="o">|=</span> <span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">il_tx_cmd_protection</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tx_flags</span><span class="p">);</span>

	<span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TX_CMD_FLG_ANT_SEL_MSK</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_mgmt</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_assoc_req</span><span class="p">(</span><span class="n">fc</span><span class="p">)</span> <span class="o">||</span> <span class="n">ieee80211_is_reassoc_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
			<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">pm_frame_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">pm_frame_timeout</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">timeout</span><span class="p">.</span><span class="n">pm_frame_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">driver_txop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="n">tx_flags</span><span class="p">;</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">next_frame_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * start C_TX command process</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_tx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="n">hdr</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hdr</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_tx_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">il3945_tx_cmd</span> <span class="o">*</span><span class="n">tx_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_tx_queue</span> <span class="o">*</span><span class="n">txq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_queue</span> <span class="o">*</span><span class="n">q</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_device_cmd</span> <span class="o">*</span><span class="n">out_cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_cmd_meta</span> <span class="o">*</span><span class="n">out_meta</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">phys_addr</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">txcmd_phys</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txq_id</span> <span class="o">=</span> <span class="n">skb_get_queue_mapping</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">unicast</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sta_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">fc</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">wait_write_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_rfkill</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_DROP</span><span class="p">(</span><span class="s">&quot;Dropping - RF KILL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ieee80211_get_tx_rate</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">info</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hw_value</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">IL_INVALID_RATE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;ERROR: No TX rate available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop_unlock</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">unicast</span> <span class="o">=</span> <span class="o">!</span><span class="n">is_multicast_ether_addr</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
	<span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fc</span> <span class="o">=</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_auth</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;Sending AUTH frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_assoc_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;Sending ASSOC frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_reassoc_req</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span>
		<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;Sending REASSOC frame</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">hdr_len</span> <span class="o">=</span> <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">fc</span><span class="p">);</span>

	<span class="cm">/* Find idx into station table for destination station */</span>
	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">il_sta_id_or_broadcast</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">sta</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IL_INVALID_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_DROP</span><span class="p">(</span><span class="s">&quot;Dropping - INVALID STATION: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">hdr</span><span class="o">-&gt;</span><span class="n">addr1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_RATE</span><span class="p">(</span><span class="s">&quot;station Id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ieee80211_is_data_qos</span><span class="p">(</span><span class="n">fc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="o">*</span><span class="n">qc</span> <span class="o">=</span> <span class="n">ieee80211_get_qos_ctl</span><span class="p">(</span><span class="n">hdr</span><span class="p">);</span>
		<span class="n">tid</span> <span class="o">=</span> <span class="n">qc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">IEEE80211_QOS_CTL_TID_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">tid</span> <span class="o">&gt;=</span> <span class="n">MAX_TID_COUNT</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Descriptor for chosen Tx queue */</span>
	<span class="n">txq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">txq_id</span><span class="p">];</span>
	<span class="n">q</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">q</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">il_queue_space</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">high_mark</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">drop</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">idx</span> <span class="o">=</span> <span class="n">il_get_cmd_idx</span><span class="p">(</span><span class="n">q</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">write_ptr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">txq</span><span class="o">-&gt;</span><span class="n">skbs</span><span class="p">[</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">write_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="cm">/* Init first empty entry in queue&#39;s array of Tx/cmd buffers */</span>
	<span class="n">out_cmd</span> <span class="o">=</span> <span class="n">txq</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">out_meta</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">txq</span><span class="o">-&gt;</span><span class="n">meta</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
	<span class="n">tx_cmd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il3945_tx_cmd</span> <span class="o">*</span><span class="p">)</span><span class="n">out_cmd</span><span class="o">-&gt;</span><span class="n">cmd</span><span class="p">.</span><span class="n">payload</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">out_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">out_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">tx_cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_cmd</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Set up the Tx-command (not MAC!) header.</span>
<span class="cm">	 * Store the chosen Tx queue and TFD idx within the sequence field;</span>
<span class="cm">	 * after Tx, uCode&#39;s Tx response will return this value so driver can</span>
<span class="cm">	 * locate the frame within the tx queue and do post-tx processing.</span>
<span class="cm">	 */</span>
	<span class="n">out_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">C_TX</span><span class="p">;</span>
	<span class="n">out_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">sequence</span> <span class="o">=</span>
	    <span class="n">cpu_to_le16</span><span class="p">((</span><span class="n">u16</span><span class="p">)</span>
			<span class="p">(</span><span class="n">QUEUE_TO_SEQ</span><span class="p">(</span><span class="n">txq_id</span><span class="p">)</span> <span class="o">|</span> <span class="n">IDX_TO_SEQ</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">write_ptr</span><span class="p">)));</span>

	<span class="cm">/* Copy MAC header from skb into command buffer */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">hdr_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">.</span><span class="n">hw_key</span><span class="p">)</span>
		<span class="n">il3945_build_tx_cmd_hwcrypto</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">out_cmd</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>

	<span class="cm">/* TODO need this for burst mode later on */</span>
	<span class="n">il3945_build_tx_cmd_basic</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">out_cmd</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>

	<span class="n">il3945_hw_build_tx_cmd_rate</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">out_cmd</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>

	<span class="cm">/* Total # bytes to be transmitted */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="n">il_update_stats</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span> <span class="n">fc</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_CMD_FLG_ANT_A_MSK</span><span class="p">;</span>
	<span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TX_CMD_FLG_ANT_B_MSK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ieee80211_has_morefrags</span><span class="p">(</span><span class="n">hdr</span><span class="o">-&gt;</span><span class="n">frame_control</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">need_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">wait_write_ptr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">txq</span><span class="o">-&gt;</span><span class="n">need_update</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;sequence nr = 0X%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">out_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">sequence</span><span class="p">));</span>
	<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;tx_flags = 0X%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">tx_flags</span><span class="p">));</span>
	<span class="n">il_print_hex_dump</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL_DL_TX</span><span class="p">,</span> <span class="n">tx_cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_cmd</span><span class="p">));</span>
	<span class="n">il_print_hex_dump</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">IL_DL_TX</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">tx_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span>
			  <span class="n">ieee80211_hdrlen</span><span class="p">(</span><span class="n">fc</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * Use the first empty entry in this queue&#39;s command buffer array</span>
<span class="cm">	 * to contain the Tx command and MAC header concatenated together</span>
<span class="cm">	 * (payload data will be in another buffer).</span>
<span class="cm">	 * Size of this varies, due to varying MAC header length.</span>
<span class="cm">	 * If end is not dword aligned, we&#39;ll have 2 extra bytes at the end</span>
<span class="cm">	 * of the MAC header (device reads on dword boundaries).</span>
<span class="cm">	 * We&#39;ll tell device about this padding later.</span>
<span class="cm">	 */</span>
	<span class="n">len</span> <span class="o">=</span>
	    <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il3945_tx_cmd</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_cmd_header</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">hdr_len</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mi">3</span><span class="p">;</span>

	<span class="cm">/* Physical address of this Tx command&#39;s header (not MAC header!),</span>
<span class="cm">	 * within command buffer array. */</span>
	<span class="n">txcmd_phys</span> <span class="o">=</span>
	    <span class="n">pci_map_single</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">out_cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
	<span class="cm">/* we do not map meta data ... so we can safely access address to</span>
<span class="cm">	 * provide to unmap command*/</span>
	<span class="n">dma_unmap_addr_set</span><span class="p">(</span><span class="n">out_meta</span><span class="p">,</span> <span class="n">mapping</span><span class="p">,</span> <span class="n">txcmd_phys</span><span class="p">);</span>
	<span class="n">dma_unmap_len_set</span><span class="p">(</span><span class="n">out_meta</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Add buffer containing Tx command and MAC(!) header to TFD&#39;s</span>
<span class="cm">	 * first entry */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">txq_attach_buf_to_tfd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">txcmd_phys</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Set up TFD&#39;s 2nd entry to point directly to remainder of skb,</span>
<span class="cm">	 * if any (802.11 null frames have no payload). */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">hdr_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">phys_addr</span> <span class="o">=</span>
		    <span class="n">pci_map_single</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">hdr_len</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
				   <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">txq_attach_buf_to_tfd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">,</span> <span class="n">phys_addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					       <span class="n">U32_PAD</span><span class="p">(</span><span class="n">len</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* Tell device the write idx *just past* this latest filled TFD */</span>
	<span class="n">q</span><span class="o">-&gt;</span><span class="n">write_ptr</span> <span class="o">=</span> <span class="n">il_queue_inc_wrap</span><span class="p">(</span><span class="n">q</span><span class="o">-&gt;</span><span class="n">write_ptr</span><span class="p">,</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">n_bd</span><span class="p">);</span>
	<span class="n">il_txq_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_queue_space</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">q</span><span class="o">-&gt;</span><span class="n">high_mark</span> <span class="o">&amp;&amp;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wait_write_ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">txq</span><span class="o">-&gt;</span><span class="n">need_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">il_txq_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">il_stop_queue</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">txq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">drop_unlock:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="nl">drop:</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_get_measurement</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">ieee80211_measurement_params</span> <span class="o">*</span><span class="n">params</span><span class="p">,</span> <span class="n">u8</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_spectrum_cmd</span> <span class="n">spectrum</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_host_cmd</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">C_SPECTRUM_MEASUREMENT</span><span class="p">,</span>
		<span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">spectrum</span><span class="p">,</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CMD_WANT_SKB</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="n">u32</span> <span class="n">add_time</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">start_time</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">spectrum_resp_status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">duration</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">duration</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_associated</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
		<span class="n">add_time</span> <span class="o">=</span>
		    <span class="n">il_usecs_to_beacons</span><span class="p">(</span><span class="n">il</span><span class="p">,</span>
					<span class="n">le64_to_cpu</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">start_time</span><span class="p">)</span> <span class="o">-</span>
					<span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">last_tsf</span><span class="p">,</span>
					<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">spectrum</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">spectrum</span><span class="p">));</span>

	<span class="n">spectrum</span><span class="p">.</span><span class="n">channel_count</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">spectrum</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span>
	    <span class="n">RXON_FLG_TSF2HOST_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_ANT_A_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_DIS_DIV_MSK</span><span class="p">;</span>
	<span class="n">spectrum</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="n">MEASUREMENT_FILTER_FLAG</span><span class="p">;</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">spectrum</span><span class="p">);</span>
	<span class="n">spectrum</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">spectrum</span><span class="p">.</span><span class="n">len</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_associated</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
		<span class="n">spectrum</span><span class="p">.</span><span class="n">start_time</span> <span class="o">=</span>
		    <span class="n">il_add_beacon_time</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">last_beacon_time</span><span class="p">,</span> <span class="n">add_time</span><span class="p">,</span>
				       <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">timing</span><span class="p">.</span><span class="n">beacon_interval</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">spectrum</span><span class="p">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spectrum</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">duration</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">duration</span> <span class="o">*</span> <span class="n">TIME_UNIT</span><span class="p">);</span>
	<span class="n">spectrum</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">channel</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="n">spectrum</span><span class="p">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_FLG_BAND_24G_MSK</span><span class="p">)</span>
		<span class="n">spectrum</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span>
		    <span class="n">RXON_FLG_BAND_24G_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_AUTO_DETECT_MSK</span> <span class="o">|</span>
		    <span class="n">RXON_FLG_TGG_PROTECT_MSK</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">il_send_cmd_sync</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">.</span><span class="n">reply_page</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IL_CMD_FAILED_MSK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Bad return from N_RX_ON_ASSOC command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spectrum_resp_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">spectrum</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">spectrum_resp_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="cm">/* Command will be handled */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">spectrum</span><span class="p">.</span><span class="n">id</span> <span class="o">!=</span> <span class="mh">0xff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Replaced existing measurement: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">spectrum</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">measurement_status</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">MEASUREMENT_READY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">measurement_status</span> <span class="o">|=</span> <span class="n">MEASUREMENT_ACTIVE</span><span class="p">;</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mi">1</span>:		<span class="cm">/* Command will not be handled */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">il_free_pages</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">cmd</span><span class="p">.</span><span class="n">reply_page</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_hdl_alive</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">il_alive_resp</span> <span class="o">*</span><span class="n">palive</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="o">*</span><span class="n">pwork</span><span class="p">;</span>

	<span class="n">palive</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">alive_frame</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Alive ucode status 0x%08X revision &quot;</span> <span class="s">&quot;0x%01X 0x%01X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">palive</span><span class="o">-&gt;</span><span class="n">is_valid</span><span class="p">,</span> <span class="n">palive</span><span class="o">-&gt;</span><span class="n">ver_type</span><span class="p">,</span> <span class="n">palive</span><span class="o">-&gt;</span><span class="n">ver_subtype</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">palive</span><span class="o">-&gt;</span><span class="n">ver_subtype</span> <span class="o">==</span> <span class="n">INITIALIZE_SUBTYPE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Initialization Alive received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">card_alive_init</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">alive_frame</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_alive_resp</span><span class="p">));</span>
		<span class="n">pwork</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">init_alive_start</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Runtime Alive received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">card_alive</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">alive_frame</span><span class="p">,</span>
		       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_alive_resp</span><span class="p">));</span>
		<span class="n">pwork</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">alive_start</span><span class="p">;</span>
		<span class="n">il3945_disable_events</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* We delay the ALIVE response by 5ms to</span>
<span class="cm">	 * give the HW RF Kill time to activate... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">palive</span><span class="o">-&gt;</span><span class="n">is_valid</span> <span class="o">==</span> <span class="n">UCODE_VALID_OK</span><span class="p">)</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="n">pwork</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;uCode did not respond OK.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_hdl_add_sta</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">D_RX</span><span class="p">(</span><span class="s">&quot;Received C_ADD_STA: 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_hdl_beacon</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">il3945_beacon_notif</span> <span class="o">*</span><span class="n">beacon</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">beacon_status</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="n">u8</span> <span class="n">rate</span> <span class="o">=</span> <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">beacon_notify_hdr</span><span class="p">.</span><span class="n">rate</span><span class="p">;</span>

	<span class="n">D_RX</span><span class="p">(</span><span class="s">&quot;beacon status %x retries %d iss %d &quot;</span> <span class="s">&quot;tsf %d %d rate %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">beacon_notify_hdr</span><span class="p">.</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TX_STATUS_MSK</span><span class="p">,</span>
	     <span class="n">beacon</span><span class="o">-&gt;</span><span class="n">beacon_notify_hdr</span><span class="p">.</span><span class="n">failure_frame</span><span class="p">,</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ibss_mgr_status</span><span class="p">),</span>
	     <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">high_tsf</span><span class="p">),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">low_tsf</span><span class="p">),</span> <span class="n">rate</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ibss_manager</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">beacon</span><span class="o">-&gt;</span><span class="n">ibss_mgr_status</span><span class="p">);</span>

<span class="p">}</span>

<span class="cm">/* Handle notification from uCode that card&#39;s power state is changing</span>
<span class="cm"> * due to software, hardware, or critical temperature RFKILL */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_hdl_card_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">card_state_notif</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">status</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Card state received: HW:%s SW:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HW_CARD_DISABLED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Kill&quot;</span> <span class="o">:</span> <span class="s">&quot;On&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SW_CARD_DISABLED</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Kill&quot;</span> <span class="o">:</span> <span class="s">&quot;On&quot;</span><span class="p">);</span>

	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_SET</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_BIT_CMD_BLOCKED</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">HW_CARD_DISABLED</span><span class="p">)</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">il_scan_cancel</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">)</span> <span class="o">!=</span>
	     <span class="n">test_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)))</span>
		<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span>
					  <span class="n">test_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
	<span class="k">else</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_setup_handlers - Initialize Rx handler callbacks</span>
<span class="cm"> *</span>
<span class="cm"> * Setup the RX handlers for each of the reply types sent from the uCode</span>
<span class="cm"> * to the host.</span>
<span class="cm"> *</span>
<span class="cm"> * This function chains into the hardware specific files for them to setup</span>
<span class="cm"> * any hardware specific handlers as well.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_setup_handlers</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_ALIVE</span><span class="p">]</span> <span class="o">=</span> <span class="n">il3945_hdl_alive</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">C_ADD_STA</span><span class="p">]</span> <span class="o">=</span> <span class="n">il3945_hdl_add_sta</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_ERROR</span><span class="p">]</span> <span class="o">=</span> <span class="n">il_hdl_error</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_CHANNEL_SWITCH</span><span class="p">]</span> <span class="o">=</span> <span class="n">il_hdl_csa</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_SPECTRUM_MEASUREMENT</span><span class="p">]</span> <span class="o">=</span> <span class="n">il_hdl_spectrum_measurement</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_PM_SLEEP</span><span class="p">]</span> <span class="o">=</span> <span class="n">il_hdl_pm_sleep</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_PM_DEBUG_STATS</span><span class="p">]</span> <span class="o">=</span> <span class="n">il_hdl_pm_debug_stats</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_BEACON</span><span class="p">]</span> <span class="o">=</span> <span class="n">il3945_hdl_beacon</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The same handler is used for both the REPLY to a discrete</span>
<span class="cm">	 * stats request from the host as well as for the periodic</span>
<span class="cm">	 * stats notifications (after received beacons) from the uCode.</span>
<span class="cm">	 */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">C_STATS</span><span class="p">]</span> <span class="o">=</span> <span class="n">il3945_hdl_c_stats</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_STATS</span><span class="p">]</span> <span class="o">=</span> <span class="n">il3945_hdl_stats</span><span class="p">;</span>

	<span class="n">il_setup_rx_scan_handlers</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">N_CARD_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="n">il3945_hdl_card_state</span><span class="p">;</span>

	<span class="cm">/* Set up hardware specific Rx handlers */</span>
	<span class="n">il3945_hw_handler_setup</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/************************** RX-FUNCTIONS ****************************/</span>
<span class="cm">/*</span>
<span class="cm"> * Rx theory of operation</span>
<span class="cm"> *</span>
<span class="cm"> * The host allocates 32 DMA target addresses and passes the host address</span>
<span class="cm"> * to the firmware at register IL_RFDS_TBL_LOWER + N * RFD_SIZE where N is</span>
<span class="cm"> * 0 to 31</span>
<span class="cm"> *</span>
<span class="cm"> * Rx Queue Indexes</span>
<span class="cm"> * The host/firmware share two idx registers for managing the Rx buffers.</span>
<span class="cm"> *</span>
<span class="cm"> * The READ idx maps to the first position that the firmware may be writing</span>
<span class="cm"> * to -- the driver can read up to (but not including) this position and get</span>
<span class="cm"> * good data.</span>
<span class="cm"> * The READ idx is managed by the firmware once the card is enabled.</span>
<span class="cm"> *</span>
<span class="cm"> * The WRITE idx maps to the last position the driver has read from -- the</span>
<span class="cm"> * position preceding WRITE is the last slot the firmware can place a packet.</span>
<span class="cm"> *</span>
<span class="cm"> * The queue is empty (no good data) if WRITE = READ - 1, and is full if</span>
<span class="cm"> * WRITE = READ.</span>
<span class="cm"> *</span>
<span class="cm"> * During initialization, the host sets up the READ queue position to the first</span>
<span class="cm"> * IDX position, and WRITE to the last (READ - 1 wrapped)</span>
<span class="cm"> *</span>
<span class="cm"> * When the firmware places a packet in a buffer, it will advance the READ idx</span>
<span class="cm"> * and fire the RX interrupt.  The driver can then query the READ idx and</span>
<span class="cm"> * process as many packets as possible, moving the WRITE idx forward as it</span>
<span class="cm"> * resets the Rx queue buffers with new memory.</span>
<span class="cm"> *</span>
<span class="cm"> * The management in the driver is as follows:</span>
<span class="cm"> * + A list of pre-allocated SKBs is stored in iwl-&gt;rxq-&gt;rx_free.  When</span>
<span class="cm"> *   iwl-&gt;rxq-&gt;free_count drops to or below RX_LOW_WATERMARK, work is scheduled</span>
<span class="cm"> *   to replenish the iwl-&gt;rxq-&gt;rx_free.</span>
<span class="cm"> * + In il3945_rx_replenish (scheduled) if &#39;processed&#39; != &#39;read&#39; then the</span>
<span class="cm"> *   iwl-&gt;rxq is replenished and the READ IDX is updated (updating the</span>
<span class="cm"> *   &#39;processed&#39; and &#39;read&#39; driver idxes as well)</span>
<span class="cm"> * + A received packet is processed and handed to the kernel network stack,</span>
<span class="cm"> *   detached from the iwl-&gt;rxq.  The driver &#39;processed&#39; idx is updated.</span>
<span class="cm"> * + The Host/Firmware iwl-&gt;rxq is replenished at tasklet time from the rx_free</span>
<span class="cm"> *   list. If there are no allocated buffers in iwl-&gt;rxq-&gt;rx_free, the READ</span>
<span class="cm"> *   IDX is not incremented and iwl-&gt;status(RX_STALLED) is set.  If there</span>
<span class="cm"> *   were enough free buffers and RX_STALLED is set it is cleared.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Driver sequence:</span>
<span class="cm"> *</span>
<span class="cm"> * il3945_rx_replenish()     Replenishes rx_free list from rx_used, and calls</span>
<span class="cm"> *                            il3945_rx_queue_restock</span>
<span class="cm"> * il3945_rx_queue_restock() Moves available buffers from rx_free into Rx</span>
<span class="cm"> *                            queue, updates firmware pointers, and updates</span>
<span class="cm"> *                            the WRITE idx.  If insufficient rx_free buffers</span>
<span class="cm"> *                            are available, schedules il3945_rx_replenish</span>
<span class="cm"> *</span>
<span class="cm"> * -- enable interrupts --</span>
<span class="cm"> * ISR - il3945_rx()         Detach il_rx_bufs from pool up to the</span>
<span class="cm"> *                            READ IDX, detaching the SKB from the pool.</span>
<span class="cm"> *                            Moves the packet buffer from queue to rx_used.</span>
<span class="cm"> *                            Calls il3945_rx_queue_restock to refill any empty</span>
<span class="cm"> *                            slots.</span>
<span class="cm"> * ...</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_dma_addr2rbd_ptr - convert a DMA address to a uCode read buffer ptr</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">__le32</span>
<span class="nf">il3945_dma_addr2rbd_ptr</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">dma_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">cpu_to_le32</span><span class="p">((</span><span class="n">u32</span><span class="p">)</span> <span class="n">dma_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_rx_queue_restock - refill RX queue from pre-allocated pool</span>
<span class="cm"> *</span>
<span class="cm"> * If there are slots in the RX queue that need to be restocked,</span>
<span class="cm"> * and we have free pre-allocated buffers, fill the ranks as much</span>
<span class="cm"> * as we can, pulling from rx_free.</span>
<span class="cm"> *</span>
<span class="cm"> * This moves the &#39;write&#39; idx forward to catch up with &#39;processed&#39;, and</span>
<span class="cm"> * also updates the memory address in the firmware to reference the new</span>
<span class="cm"> * target buffer.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_rx_queue_restock</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">write</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">write</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">il_rx_queue_space</span><span class="p">(</span><span class="n">rxq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Get next free Rx buffer, remove from free list */</span>
		<span class="n">element</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_free</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">rxb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>

		<span class="cm">/* Point to Rx buffer via next RBD in circular buffer */</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">il3945_dma_addr2rbd_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page_dma</span><span class="p">);</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">]</span> <span class="o">=</span> <span class="n">rxb</span><span class="p">;</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RX_QUEUE_MASK</span><span class="p">;</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="o">--</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="cm">/* If the pre-allocated buffer pool is dropping low, schedule to</span>
<span class="cm">	 * refill it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span> <span class="o">&lt;=</span> <span class="n">RX_LOW_WATERMARK</span><span class="p">)</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rx_replenish</span><span class="p">);</span>

	<span class="cm">/* If we&#39;ve added more space for the firmware to place data, tell it.</span>
<span class="cm">	 * Increment device&#39;s write pointer in multiples of 8. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write_actual</span> <span class="o">!=</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x7</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">abs</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">-</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">need_update</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">il_rx_queue_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_rx_replenish - Move all used packet from rx_used to rx_free</span>
<span class="cm"> *</span>
<span class="cm"> * When moving to rx_free an SKB is allocated for the slot.</span>
<span class="cm"> *</span>
<span class="cm"> * Also restock the Rx queue via il3945_rx_queue_restock.</span>
<span class="cm"> * This is called as a scheduled work item (except for during initialization)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_rx_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">priority</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">element</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">gfp_t</span> <span class="n">gfp_mask</span> <span class="o">=</span> <span class="n">priority</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span> <span class="o">&gt;</span> <span class="n">RX_LOW_WATERMARK</span><span class="p">)</span>
			<span class="n">gfp_mask</span> <span class="o">|=</span> <span class="n">__GFP_NOWARN</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">gfp_mask</span> <span class="o">|=</span> <span class="n">__GFP_COMP</span><span class="p">;</span>

		<span class="cm">/* Alloc a new receive buffer */</span>
		<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages</span><span class="p">(</span><span class="n">gfp_mask</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">page</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Failed to allocate SKB buffer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span> <span class="o">&lt;=</span> <span class="n">RX_LOW_WATERMARK</span> <span class="o">&amp;&amp;</span>
			    <span class="n">net_ratelimit</span><span class="p">())</span>
				<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Failed to allocate SKB buffer with %0x.&quot;</span>
				       <span class="s">&quot;Only %u free buffers remaining.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">priority</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="p">);</span>
			<span class="cm">/* We don&#39;t reschedule replenish work here -- we will</span>
<span class="cm">			 * call the restock method and if it still needs</span>
<span class="cm">			 * more buffers it will schedule replenish */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">__free_pages</span><span class="p">(</span><span class="n">page</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">element</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">.</span><span class="n">next</span><span class="p">;</span>
		<span class="n">rxb</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_buf</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="n">element</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">=</span> <span class="n">page</span><span class="p">;</span>
		<span class="cm">/* Get physical address of RB/SKB */</span>
		<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page_dma</span> <span class="o">=</span>
		    <span class="n">pci_map_page</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
				 <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span><span class="p">,</span>
				 <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_free</span><span class="p">);</span>
		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">alloc_rxb_page</span><span class="o">++</span><span class="p">;</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il3945_rx_queue_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_queue</span> <span class="o">*</span><span class="n">rxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_free</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">);</span>
	<span class="cm">/* Fill the rx_used queue with _all_ of the Rx buffers */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_FREE_BUFFERS</span> <span class="o">+</span> <span class="n">RX_QUEUE_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* In the reset function, these buffers may have been allocated</span>
<span class="cm">		 * to an SKB, so we need to unmap and free potential storage */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page_dma</span><span class="p">,</span>
				       <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span><span class="p">,</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">__il_free_pages</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">);</span>
			<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set us so that we have processed and used all buffers, but have</span>
<span class="cm">	 * not restocked the Rx queue with fresh buffers */</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write_actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il3945_rx_replenish</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">il3945_rx_allocate</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il3945_rx_queue_restock</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_rx_replenish_now</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">il3945_rx_allocate</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>

	<span class="n">il3945_rx_queue_restock</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Assumes that the skb field of the buffers in &#39;pool&#39; is kept accurate.</span>
<span class="cm"> * If an SKB has been detached, the POOL needs to have its SKB set to NULL</span>
<span class="cm"> * This free routine walks the list of POOL entries and if SKB is set to</span>
<span class="cm"> * non NULL it is unmapped and freed</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_rx_queue_free</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_rx_queue</span> <span class="o">*</span><span class="n">rxq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_QUEUE_SIZE</span> <span class="o">+</span> <span class="n">RX_FREE_BUFFERS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page_dma</span><span class="p">,</span>
				       <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span><span class="p">,</span>
				       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">__il_free_pages</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span><span class="p">);</span>
			<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">pool</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">page</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">RX_QUEUE_SIZE</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">bd</span><span class="p">,</span>
			  <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">bd_dma</span><span class="p">);</span>
	<span class="n">dma_free_coherent</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_rb_status</span><span class="p">),</span>
			  <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rb_stts</span><span class="p">,</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rb_stts_dma</span><span class="p">);</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">bd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rb_stts</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert linear signal-to-noise ratio into dB */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">ratio2dB</span><span class="p">[</span><span class="mi">100</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cm">/*	 0   1   2   3   4   5   6   7   8   9 */</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">17</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span>	<span class="cm">/* 00 - 09 */</span>
	<span class="mi">20</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span>	<span class="cm">/* 10 - 19 */</span>
	<span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span>	<span class="cm">/* 20 - 29 */</span>
	<span class="mi">29</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span>	<span class="cm">/* 30 - 39 */</span>
	<span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span>	<span class="cm">/* 40 - 49 */</span>
	<span class="mi">34</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span> <span class="mi">35</span><span class="p">,</span>	<span class="cm">/* 50 - 59 */</span>
	<span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span>	<span class="cm">/* 60 - 69 */</span>
	<span class="mi">37</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span>	<span class="cm">/* 70 - 79 */</span>
	<span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span>	<span class="cm">/* 80 - 89 */</span>
	<span class="mi">39</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">40</span>	<span class="cm">/* 90 - 99 */</span>
<span class="p">};</span>

<span class="cm">/* Calculates a relative dB value from a ratio of linear</span>
<span class="cm"> *   (i.e. not dB) signal levels.</span>
<span class="cm"> * Conversion assumes that levels are voltages (20*log), not powers (10*log). */</span>
<span class="kt">int</span>
<span class="nf">il3945_calc_db_from_ratio</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig_ratio</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* 1000:1 or higher just report as 60 dB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sig_ratio</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">60</span><span class="p">;</span>

	<span class="cm">/* 100:1 or higher, divide by 10 and use table,</span>
<span class="cm">	 *   add 20 dB to make up for divide by 10 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sig_ratio</span> <span class="o">&gt;=</span> <span class="mi">100</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">20</span> <span class="o">+</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ratio2dB</span><span class="p">[</span><span class="n">sig_ratio</span> <span class="o">/</span> <span class="mi">10</span><span class="p">];</span>

	<span class="cm">/* We shouldn&#39;t see this */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sig_ratio</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Use table for ratios 1:1 - 99:1 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">ratio2dB</span><span class="p">[</span><span class="n">sig_ratio</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_rx_handle - Main entry function for receiving responses from uCode</span>
<span class="cm"> *</span>
<span class="cm"> * Uses the il-&gt;handlers callback function array to invoke</span>
<span class="cm"> * the appropriate handlers, including command responses,</span>
<span class="cm"> * frame-received notifications, and other notifications.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_rx_handle</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_rx_buf</span> <span class="o">*</span><span class="n">rxb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_rx_pkt</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_rx_queue</span> <span class="o">*</span><span class="n">rxq</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reclaim</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">fill_rx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">total_empty</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* uCode&#39;s read idx (stored in shared DRAM) indicates the last Rx</span>
<span class="cm">	 * buffer that the driver may process (last buffer filled by ucode). */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rb_stts</span><span class="o">-&gt;</span><span class="n">closed_rb_num</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0FFF</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">;</span>

	<span class="cm">/* calculate total frames need to be restock after handling RX */</span>
	<span class="n">total_empty</span> <span class="o">=</span> <span class="n">r</span> <span class="o">-</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">write_actual</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">total_empty</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">total_empty</span> <span class="o">+=</span> <span class="n">RX_QUEUE_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">total_empty</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">RX_QUEUE_SIZE</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">fill_rx</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* Rx interrupt, but nothing sent from uCode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">r</span><span class="p">)</span>
		<span class="n">D_RX</span><span class="p">(</span><span class="s">&quot;r = %d, i = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>

		<span class="n">rxb</span> <span class="o">=</span> <span class="n">rxq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="cm">/* If an RXB doesn&#39;t have a Rx queue slot associated with it,</span>
<span class="cm">		 * then a bug has been introduced in the queue refilling</span>
<span class="cm">		 * routines -- catch it here */</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">rxb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

		<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">queue</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">pci_unmap_page</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page_dma</span><span class="p">,</span>
			       <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">rx_page_order</span><span class="p">,</span>
			       <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
		<span class="n">pkt</span> <span class="o">=</span> <span class="n">rxb_addr</span><span class="p">(</span><span class="n">rxb</span><span class="p">);</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">len_n_flags</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IL_RX_FRAME_SIZE_MSK</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">);</span>	<span class="cm">/* account for status word */</span>

		<span class="cm">/* Reclaim a command buffer only if this packet is a response</span>
<span class="cm">		 *   to a (driver-originated) command.</span>
<span class="cm">		 * If the packet (e.g. Rx frame) originated from uCode,</span>
<span class="cm">		 *   there is no command buffer to reclaim.</span>
<span class="cm">		 * Ucode should set SEQ_RX_FRAME bit if ucode-originated,</span>
<span class="cm">		 *   but apparently a few don&#39;t get set; catch them here. */</span>
		<span class="n">reclaim</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">sequence</span> <span class="o">&amp;</span> <span class="n">SEQ_RX_FRAME</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">N_STATS</span> <span class="o">&amp;&amp;</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">C_TX</span><span class="p">;</span>

		<span class="cm">/* Based on type of command response or notification,</span>
<span class="cm">		 *   handle those that need handling via function in</span>
<span class="cm">		 *   handlers table.  See il3945_setup_handlers() */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">D_RX</span><span class="p">(</span><span class="s">&quot;r = %d, i = %d, %s, 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
			     <span class="n">il_get_cmd_string</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">),</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">handlers</span><span class="p">[</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">]</span> <span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxb</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* No handling needed */</span>
			<span class="n">D_RX</span><span class="p">(</span><span class="s">&quot;r %d i %d No handler needed for %s, 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span>
			     <span class="n">i</span><span class="p">,</span> <span class="n">il_get_cmd_string</span><span class="p">(</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">),</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * XXX: After here, we should always check rxb-&gt;page</span>
<span class="cm">		 * against NULL before touching it or its virtual</span>
<span class="cm">		 * memory (pkt). Because some handler might have</span>
<span class="cm">		 * already taken or freed the pages.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">reclaim</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Invoke any callbacks, transfer the buffer to caller,</span>
<span class="cm">			 * and fire off the (possibly) blocking il_send_cmd()</span>
<span class="cm">			 * as we reclaim the driver command queue */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">)</span>
				<span class="n">il_tx_cmd_complete</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">rxb</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Claim null rxb?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Reuse the page if possible. For notification packets and</span>
<span class="cm">		 * SKBs that fail to Rx correctly, add them back into the</span>
<span class="cm">		 * rx_free list for reuse later. */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page_dma</span> <span class="o">=</span>
			    <span class="n">pci_map_page</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="n">rxb</span><span class="o">-&gt;</span><span class="n">page</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="n">PAGE_SIZE</span> <span class="o">&lt;&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span>
					 <span class="n">rx_page_order</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_free</span><span class="p">);</span>
			<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">free_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxb</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">rx_used</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rxq</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RX_QUEUE_MASK</span><span class="p">;</span>
		<span class="cm">/* If there are a lot of unused frames,</span>
<span class="cm">		 * restock the Rx queue so ucode won&#39;t assert. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fill_rx</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">count</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;=</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">il3945_rx_replenish_now</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Backtrack one entry */</span>
	<span class="n">rxq</span><span class="o">-&gt;</span><span class="n">read</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fill_rx</span><span class="p">)</span>
		<span class="n">il3945_rx_replenish_now</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">il3945_rx_queue_restock</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* call this function to flush any scheduled tasklet */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">il3945_synchronize_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* wait to make sure we flush pending tasklet */</span>
	<span class="n">synchronize_irq</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">tasklet_kill</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span>
<span class="nf">il3945_desc_lookup</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="s">&quot;FAIL&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="s">&quot;BAD_PARAM&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="s">&quot;BAD_CHECKSUM&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">return</span> <span class="s">&quot;NMI_INTERRUPT&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">return</span> <span class="s">&quot;SYSASSERT&quot;</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">6</span>:
		<span class="k">return</span> <span class="s">&quot;FATAL_ERROR&quot;</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;UNKNOWN&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define ERROR_START_OFFSET  (1 * sizeof(u32))</span>
<span class="cp">#define ERROR_ELEM_SIZE     (7 * sizeof(u32))</span>

<span class="kt">void</span>
<span class="nf">il3945_dump_nic_error_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">desc</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">data1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">blink1</span><span class="p">,</span> <span class="n">blink2</span><span class="p">,</span> <span class="n">ilink1</span><span class="p">,</span> <span class="n">ilink2</span><span class="p">;</span>

	<span class="n">base</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">card_alive</span><span class="p">.</span><span class="n">error_event_table_ptr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il3945_hw_valid_rtc_data_addr</span><span class="p">(</span><span class="n">base</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Not valid error log pointer 0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ERROR_START_OFFSET</span> <span class="o">&lt;=</span> <span class="n">count</span> <span class="o">*</span> <span class="n">ERROR_ELEM_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Start IWL Error Log Dump:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Status: 0x%08lX, count: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Desc       Time       asrtPC  blink2 &quot;</span>
	       <span class="s">&quot;ilink1  nmiPC   Line</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ERROR_START_OFFSET</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="n">ERROR_ELEM_SIZE</span><span class="p">)</span> <span class="o">+</span> <span class="n">ERROR_START_OFFSET</span><span class="p">;</span>
	     <span class="n">i</span> <span class="o">+=</span> <span class="n">ERROR_ELEM_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">desc</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">time</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">blink1</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">blink2</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">ilink1</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">ilink2</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">5</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>
		<span class="n">data1</span> <span class="o">=</span> <span class="n">il_read_targ_mem</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">));</span>

		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;%-13s (0x%X) %010u 0x%05X 0x%05X 0x%05X 0x%05X %u</span><span class="se">\n\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">il3945_desc_lookup</span><span class="p">(</span><span class="n">desc</span><span class="p">),</span> <span class="n">desc</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">blink1</span><span class="p">,</span> <span class="n">blink2</span><span class="p">,</span>
		       <span class="n">ilink1</span><span class="p">,</span> <span class="n">ilink2</span><span class="p">,</span> <span class="n">data1</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_irq_tasklet</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">inta</span><span class="p">,</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">inta_fh</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="n">u32</span> <span class="n">inta_mask</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Ack/clear/reset pending uCode interrupts.</span>
<span class="cm">	 * Note:  Some bits in CSR_INT are &quot;OR&quot; of bits in CSR_FH_INT_STATUS,</span>
<span class="cm">	 *  and will clear only when CSR_FH_INT_STATUS gets cleared. */</span>
	<span class="n">inta</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT</span><span class="p">);</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT</span><span class="p">,</span> <span class="n">inta</span><span class="p">);</span>

	<span class="cm">/* Ack/clear/reset pending flow-handler (DMA) interrupts.</span>
<span class="cm">	 * Any new interrupts that happen after this, either while we&#39;re</span>
<span class="cm">	 * in this tasklet, or later, will show up in next ISR/tasklet. */</span>
	<span class="n">inta_fh</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_FH_INT_STATUS</span><span class="p">);</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_FH_INT_STATUS</span><span class="p">,</span> <span class="n">inta_fh</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il_get_debug_level</span><span class="p">(</span><span class="n">il</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">IL_DL_ISR</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* just for debug */</span>
		<span class="n">inta_mask</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT_MASK</span><span class="p">);</span>
		<span class="n">D_ISR</span><span class="p">(</span><span class="s">&quot;inta 0x%08x, enabled 0x%08x, fh 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inta</span><span class="p">,</span>
		      <span class="n">inta_mask</span><span class="p">,</span> <span class="n">inta_fh</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Since CSR_INT and CSR_FH_INT_STATUS reads and clears are not</span>
<span class="cm">	 * atomic, make sure that inta covers all the interrupts that</span>
<span class="cm">	 * we&#39;ve discovered, even if FH interrupt came in just after</span>
<span class="cm">	 * reading CSR_INT. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta_fh</span> <span class="o">&amp;</span> <span class="n">CSR39_FH_INT_RX_MASK</span><span class="p">)</span>
		<span class="n">inta</span> <span class="o">|=</span> <span class="n">CSR_INT_BIT_FH_RX</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta_fh</span> <span class="o">&amp;</span> <span class="n">CSR39_FH_INT_TX_MASK</span><span class="p">)</span>
		<span class="n">inta</span> <span class="o">|=</span> <span class="n">CSR_INT_BIT_FH_TX</span><span class="p">;</span>

	<span class="cm">/* Now service all interrupt bits discovered above. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_HW_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Hardware error detected.  Restarting.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* Tell the device to stop sending interrupts */</span>
		<span class="n">il_disable_interrupts</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

		<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">hw</span><span class="o">++</span><span class="p">;</span>
		<span class="n">il_irq_handle_error</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

		<span class="n">handled</span> <span class="o">|=</span> <span class="n">CSR_INT_BIT_HW_ERR</span><span class="p">;</span>

		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il_get_debug_level</span><span class="p">(</span><span class="n">il</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IL_DL_ISR</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* NIC fires this, but we don&#39;t use it, redundant with WAKEUP */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_SCD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_ISR</span><span class="p">(</span><span class="s">&quot;Scheduler finished to transmit &quot;</span>
			      <span class="s">&quot;the frame/frames.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">sch</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Alive notification via Rx interrupt will do the real work */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_ALIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_ISR</span><span class="p">(</span><span class="s">&quot;Alive interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">alive</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="cm">/* Safely ignore these bits for debug checks below */</span>
	<span class="n">inta</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">CSR_INT_BIT_SCD</span> <span class="o">|</span> <span class="n">CSR_INT_BIT_ALIVE</span><span class="p">);</span>

	<span class="cm">/* Error detected by uCode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_SW_ERR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Microcode SW error detected. &quot;</span> <span class="s">&quot;Restarting 0x%X.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">inta</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">sw</span><span class="o">++</span><span class="p">;</span>
		<span class="n">il_irq_handle_error</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">CSR_INT_BIT_SW_ERR</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* uCode wakes up after power-down sleep */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_WAKEUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_ISR</span><span class="p">(</span><span class="s">&quot;Wakeup interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">il_rx_queue_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">);</span>
		<span class="n">il_txq_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">il_txq_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
		<span class="n">il_txq_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
		<span class="n">il_txq_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="n">il_txq_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">il_txq_update_write_ptr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

		<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">wakeup</span><span class="o">++</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">CSR_INT_BIT_WAKEUP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* All uCode command responses, including Tx command responses,</span>
<span class="cm">	 * Rx &quot;responses&quot; (frame-received notification), and other</span>
<span class="cm">	 * notifications from uCode come through here*/</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">CSR_INT_BIT_FH_RX</span> <span class="o">|</span> <span class="n">CSR_INT_BIT_SW_RX</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">il3945_rx_handle</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">rx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="p">(</span><span class="n">CSR_INT_BIT_FH_RX</span> <span class="o">|</span> <span class="n">CSR_INT_BIT_SW_RX</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="n">CSR_INT_BIT_FH_TX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_ISR</span><span class="p">(</span><span class="s">&quot;Tx interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">tx</span><span class="o">++</span><span class="p">;</span>

		<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_FH_INT_STATUS</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">));</span>
		<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">FH39_TCSR_CREDIT</span><span class="p">(</span><span class="n">FH39_SRVC_CHNL</span><span class="p">),</span> <span class="mh">0x0</span><span class="p">);</span>
		<span class="n">handled</span> <span class="o">|=</span> <span class="n">CSR_INT_BIT_FH_TX</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">handled</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unhandled INTA bits 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inta</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">handled</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">isr_stats</span><span class="p">.</span><span class="n">unhandled</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inta</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">inta_mask</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Disabled INTA bits 0x%08x were pending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">inta</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">inta_mask</span><span class="p">);</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;   with inta_fh = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inta_fh</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Re-enable all interrupts */</span>
	<span class="cm">/* only Re-enable if disabled by irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_INT_ENABLED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="n">il_enable_interrupts</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il_get_debug_level</span><span class="p">(</span><span class="n">il</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IL_DL_ISR</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">inta</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT</span><span class="p">);</span>
		<span class="n">inta_mask</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT_MASK</span><span class="p">);</span>
		<span class="n">inta_fh</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_FH_INT_STATUS</span><span class="p">);</span>
		<span class="n">D_ISR</span><span class="p">(</span><span class="s">&quot;End inta 0x%08x, enabled 0x%08x, fh 0x%08x, &quot;</span>
		      <span class="s">&quot;flags 0x%08lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inta</span><span class="p">,</span> <span class="n">inta_mask</span><span class="p">,</span> <span class="n">inta_fh</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_get_channels_for_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">,</span>
			     <span class="n">u8</span> <span class="n">is_active</span><span class="p">,</span> <span class="n">u8</span> <span class="n">n_probes</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">il3945_scan_channel</span> <span class="o">*</span><span class="n">scan_ch</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="o">*</span><span class="n">sband</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">il_channel_info</span> <span class="o">*</span><span class="n">ch_info</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">passive_dwell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">active_dwell</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">added</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">sband</span> <span class="o">=</span> <span class="n">il_get_hw_mode</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">band</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sband</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">active_dwell</span> <span class="o">=</span> <span class="n">il_get_active_dwell_time</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">n_probes</span><span class="p">);</span>
	<span class="n">passive_dwell</span> <span class="o">=</span> <span class="n">il_get_passive_dwell_time</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">vif</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">passive_dwell</span> <span class="o">&lt;=</span> <span class="n">active_dwell</span><span class="p">)</span>
		<span class="n">passive_dwell</span> <span class="o">=</span> <span class="n">active_dwell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">added</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">n_channels</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">!=</span> <span class="n">band</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">hw_value</span><span class="p">;</span>

		<span class="n">ch_info</span> <span class="o">=</span> <span class="n">il_get_channel_info</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il_is_channel_valid</span><span class="p">(</span><span class="n">ch_info</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;Channel %d is INVALID for this band.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">active_dwell</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">active_dwell</span><span class="p">);</span>
		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">passive_dwell</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">passive_dwell</span><span class="p">);</span>
		<span class="cm">/* If passive , set up for auto-switch</span>
<span class="cm">		 *  and use long active_dwell time.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_active</span> <span class="o">||</span> <span class="n">il_is_channel_passive</span><span class="p">(</span><span class="n">ch_info</span><span class="p">)</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_CHAN_PASSIVE_SCAN</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* passive */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">IL_UCODE_API</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">active_dwell</span> <span class="o">=</span>
				    <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">passive_dwell</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* active */</span>
		<span class="p">}</span>

		<span class="cm">/* Set direct probe bits. These may be used both for active</span>
<span class="cm">		 * scan channels (probes gets sent right away),</span>
<span class="cm">		 * or for passive channels (probes get se sent only after</span>
<span class="cm">		 * hearing clear Rx packet).*/</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IL_UCODE_API</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">n_probes</span><span class="p">)</span>
				<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|=</span> <span class="n">IL39_SCAN_PROBE_MASK</span><span class="p">(</span><span class="n">n_probes</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* uCode v1 does not allow setting direct probe bits on</span>
<span class="cm">			 * passive channel. */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">n_probes</span><span class="p">)</span>
				<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">|=</span> <span class="n">IL39_SCAN_PROBE_MASK</span><span class="p">(</span><span class="n">n_probes</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* Set txpower levels to defaults */</span>
		<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">.</span><span class="n">dsp_atten</span> <span class="o">=</span> <span class="mi">110</span><span class="p">;</span>
		<span class="cm">/* scan_pwr_info-&gt;tpc.dsp_atten; */</span>

		<span class="cm">/*scan_pwr_info-&gt;tpc.tx_gain; */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">band</span> <span class="o">==</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">)</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">.</span><span class="n">tx_gain</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">))</span> <span class="o">|</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">tpc</span><span class="p">.</span><span class="n">tx_gain</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">5</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
			<span class="cm">/* NOTE: if we were doing 6Mb OFDM for scans we&#39;d use</span>
<span class="cm">			 * power level:</span>
<span class="cm">			 * scan_ch-&gt;tpc.tx_gain = ((1 &lt;&lt; 5) | (2 &lt;&lt; 3)) | 3;</span>
<span class="cm">			 */</span>
		<span class="p">}</span>

		<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;Scanning %d [%s %d]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;ACTIVE&quot;</span> <span class="o">:</span> <span class="s">&quot;PASSIVE&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="n">scan_ch</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="n">active_dwell</span> <span class="o">:</span> <span class="n">passive_dwell</span><span class="p">);</span>

		<span class="n">scan_ch</span><span class="o">++</span><span class="p">;</span>
		<span class="n">added</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;total channels to scan %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">added</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">added</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_init_hw_rates</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="o">*</span><span class="n">rates</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RATE_COUNT_LEGACY</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bitrate</span> <span class="o">=</span> <span class="n">il3945_rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ieee</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
		<span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>	<span class="cm">/* Rate scaling will work on idxes */</span>
		<span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hw_value_short</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">IL39_LAST_OFDM_RATE</span> <span class="o">||</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">IL_FIRST_OFDM_RATE</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * If CCK != 1M then set short preamble rate flag.</span>
<span class="cm">			 */</span>
			<span class="n">rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span>
			    <span class="p">(</span><span class="n">il3945_rates</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">plcp</span> <span class="o">==</span>
			     <span class="mi">10</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/******************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * uCode download functions</span>
<span class="cm"> *</span>
<span class="cm"> ******************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_dealloc_ucode_pci</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">il_free_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">);</span>
	<span class="n">il_free_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">);</span>
	<span class="n">il_free_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">);</span>
	<span class="n">il_free_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init</span><span class="p">);</span>
	<span class="n">il_free_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init_data</span><span class="p">);</span>
	<span class="n">il_free_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_boot</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_verify_inst_full - verify runtime uCode image in card vs. host,</span>
<span class="cm"> *     looking at all data.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_verify_inst_full</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span> <span class="n">image</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">save_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">errcnt</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;ucode inst image size is %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">HBUS_TARG_MEM_RADDR</span><span class="p">,</span> <span class="n">IL39_RTC_INST_LOWER_BOUND</span><span class="p">);</span>

	<span class="n">errcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">image</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* read data comes through single port, auto-incr addr */</span>
		<span class="cm">/* NOTE: Use the debugless read so we don&#39;t flood kernel log</span>
<span class="cm">		 * if IL_DL_IO is set */</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">HBUS_TARG_MEM_RDAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">image</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;uCode INST section is invalid at &quot;</span>
			       <span class="s">&quot;offset 0x%x, is 0x%x, s/b 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">save_len</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">image</span><span class="p">));</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">errcnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errcnt</span> <span class="o">&gt;=</span> <span class="mi">20</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">errcnt</span><span class="p">)</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;ucode image in INSTRUCTION memory is good</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_verify_inst_sparse - verify runtime uCode image in card vs. host,</span>
<span class="cm"> *   using sample data 100 bytes apart.  If these sample points are good,</span>
<span class="cm"> *   it&#39;s a pretty good bet that everything between them is good, too.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_verify_inst_sparse</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="n">__le32</span> <span class="o">*</span> <span class="n">image</span><span class="p">,</span> <span class="n">u32</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">errcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;ucode inst image size is %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">image</span> <span class="o">+=</span> <span class="mi">100</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* read data comes through single port, auto-incr addr */</span>
		<span class="cm">/* NOTE: Use the debugless read so we don&#39;t flood kernel log</span>
<span class="cm">		 * if IL_DL_IO is set */</span>
		<span class="n">il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">HBUS_TARG_MEM_RADDR</span><span class="p">,</span> <span class="n">i</span> <span class="o">+</span> <span class="n">IL39_RTC_INST_LOWER_BOUND</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">HBUS_TARG_MEM_RDAT</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">!=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="n">image</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#if 0</span><span class="c">				/* Enable this if you want to see details */</span>
<span class="c">			IL_ERR(&quot;uCode INST section is invalid at &quot;</span>
<span class="c">			       &quot;offset 0x%x, is 0x%x, s/b 0x%x\n&quot;, i, val,</span>
<span class="c">			       *image);</span>
<span class="cp">#endif</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="n">errcnt</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">errcnt</span> <span class="o">&gt;=</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_verify_ucode - determine which instruction image is in SRAM,</span>
<span class="cm"> *    and verify its contents</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_verify_ucode</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">image</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Try bootstrap */</span>
	<span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_boot</span><span class="p">.</span><span class="n">v_addr</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_boot</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">il3945_verify_inst_sparse</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Bootstrap uCode is good in inst SRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try initialize */</span>
	<span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init</span><span class="p">.</span><span class="n">v_addr</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">il3945_verify_inst_sparse</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Initialize uCode is good in inst SRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try runtime/protocol */</span>
	<span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">v_addr</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">il3945_verify_inst_sparse</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Runtime uCode is good in inst SRAM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;NO VALID UCODE IMAGE IN INSTRUCTION SRAM!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Since nothing seems to match, show first several data entries in</span>
<span class="cm">	 * instruction SRAM, so maybe visual inspection will give a clue.</span>
<span class="cm">	 * Selection of bootstrap image (vs. other images) is arbitrary. */</span>
	<span class="n">image</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_boot</span><span class="p">.</span><span class="n">v_addr</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_boot</span><span class="p">.</span><span class="n">len</span><span class="p">;</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">il3945_verify_inst_full</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_nic_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Remove all resets to allow NIC to operate */</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_RESET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define IL3945_UCODE_GET(item)						\</span>
<span class="cp">static u32 il3945_ucode_get_##item(const struct il_ucode_header *ucode)\</span>
<span class="cp">{									\</span>
<span class="cp">	return le32_to_cpu(ucode-&gt;v1.item);				\</span>
<span class="cp">}</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">il3945_ucode_get_header_size</span><span class="p">(</span><span class="n">u32</span> <span class="n">api_ver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">24</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="o">*</span>
<span class="nf">il3945_ucode_get_data</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">il_ucode_header</span> <span class="o">*</span><span class="n">ucode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">ucode</span><span class="o">-&gt;</span><span class="n">v1</span><span class="p">.</span><span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">IL3945_UCODE_GET</span><span class="p">(</span><span class="n">inst_size</span><span class="p">);</span>
<span class="n">IL3945_UCODE_GET</span><span class="p">(</span><span class="n">data_size</span><span class="p">);</span>
<span class="n">IL3945_UCODE_GET</span><span class="p">(</span><span class="n">init_size</span><span class="p">);</span>
<span class="n">IL3945_UCODE_GET</span><span class="p">(</span><span class="n">init_data_size</span><span class="p">);</span>
<span class="n">IL3945_UCODE_GET</span><span class="p">(</span><span class="n">boot_size</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_read_ucode - Read uCode images from disk file.</span>
<span class="cm"> *</span>
<span class="cm"> * Copy into buffers for card to fetch via bus-mastering</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_read_ucode</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">il_ucode_header</span> <span class="o">*</span><span class="n">ucode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="n">idx</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">ucode_raw</span><span class="p">;</span>
	<span class="cm">/* firmware file name contains uCode/driver compatibility version */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name_pre</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">fw_name_pre</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">api_max</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ucode_api_max</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">api_min</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">ucode_api_min</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">25</span><span class="p">];</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">src</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">api_ver</span><span class="p">,</span> <span class="n">inst_size</span><span class="p">,</span> <span class="n">data_size</span><span class="p">,</span> <span class="n">init_size</span><span class="p">,</span> <span class="n">init_data_size</span><span class="p">,</span> <span class="n">boot_size</span><span class="p">;</span>

	<span class="cm">/* Ask kernel firmware_class module to get the boot firmware off disk.</span>
<span class="cm">	 * request_firmware() is synchronous, file is in memory on return. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="n">api_max</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">api_min</span><span class="p">;</span> <span class="n">idx</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s%u%s&quot;</span><span class="p">,</span> <span class="n">name_pre</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="s">&quot;.ucode&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ucode_raw</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;%s firmware file req failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">&lt;</span> <span class="n">api_max</span><span class="p">)</span>
				<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Loaded firmware %s, &quot;</span>
				       <span class="s">&quot;which is deprecated. &quot;</span>
				       <span class="s">&quot; Please use API v%u instead.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span>
				       <span class="n">api_max</span><span class="p">);</span>
			<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Got firmware &#39;%s&#39; file &quot;</span>
			       <span class="s">&quot;(%zd bytes) from disk</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">ucode_raw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>

	<span class="cm">/* Make sure that we got at least our header! */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucode_raw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">il3945_ucode_get_header_size</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;File size way too small!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Data from ucode file:  header followed by uCode images */</span>
	<span class="n">ucode</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_ucode_header</span> <span class="o">*</span><span class="p">)</span><span class="n">ucode_raw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ucode</span><span class="o">-&gt;</span><span class="n">ver</span><span class="p">);</span>
	<span class="n">api_ver</span> <span class="o">=</span> <span class="n">IL_UCODE_API</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">);</span>
	<span class="n">inst_size</span> <span class="o">=</span> <span class="n">il3945_ucode_get_inst_size</span><span class="p">(</span><span class="n">ucode</span><span class="p">);</span>
	<span class="n">data_size</span> <span class="o">=</span> <span class="n">il3945_ucode_get_data_size</span><span class="p">(</span><span class="n">ucode</span><span class="p">);</span>
	<span class="n">init_size</span> <span class="o">=</span> <span class="n">il3945_ucode_get_init_size</span><span class="p">(</span><span class="n">ucode</span><span class="p">);</span>
	<span class="n">init_data_size</span> <span class="o">=</span> <span class="n">il3945_ucode_get_init_data_size</span><span class="p">(</span><span class="n">ucode</span><span class="p">);</span>
	<span class="n">boot_size</span> <span class="o">=</span> <span class="n">il3945_ucode_get_boot_size</span><span class="p">(</span><span class="n">ucode</span><span class="p">);</span>
	<span class="n">src</span> <span class="o">=</span> <span class="n">il3945_ucode_get_data</span><span class="p">(</span><span class="n">ucode</span><span class="p">);</span>

	<span class="cm">/* api_ver should match the api version forming part of the</span>
<span class="cm">	 * firmware filename ... but we don&#39;t check for that and only rely</span>
<span class="cm">	 * on the API version read from firmware header from here on forward */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">api_ver</span> <span class="o">&lt;</span> <span class="n">api_min</span> <span class="o">||</span> <span class="n">api_ver</span> <span class="o">&gt;</span> <span class="n">api_max</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Driver unable to support your firmware API. &quot;</span>
		       <span class="s">&quot;Driver supports v%u, firmware is v%u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">api_max</span><span class="p">,</span>
		       <span class="n">api_ver</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">api_ver</span> <span class="o">!=</span> <span class="n">api_max</span><span class="p">)</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Firmware has old API version. Expected %u, &quot;</span>
		       <span class="s">&quot;got %u. New firmware can be obtained &quot;</span>
		       <span class="s">&quot;from http://www.intellinuxwireless.org.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">api_max</span><span class="p">,</span>
		       <span class="n">api_ver</span><span class="p">);</span>

	<span class="n">IL_INFO</span><span class="p">(</span><span class="s">&quot;loaded firmware version %u.%u.%u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">IL_UCODE_MAJOR</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">),</span> <span class="n">IL_UCODE_MINOR</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">),</span>
		<span class="n">IL_UCODE_API</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">),</span> <span class="n">IL_UCODE_SERIAL</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">));</span>

	<span class="n">snprintf</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">),</span>
		 <span class="s">&quot;%u.%u.%u.%u&quot;</span><span class="p">,</span> <span class="n">IL_UCODE_MAJOR</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">),</span>
		 <span class="n">IL_UCODE_MINOR</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">),</span> <span class="n">IL_UCODE_API</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">),</span>
		 <span class="n">IL_UCODE_SERIAL</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">));</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;f/w package hdr ucode version raw = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_ver</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;f/w package hdr runtime inst size = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inst_size</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;f/w package hdr runtime data size = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;f/w package hdr init inst size = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">init_size</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;f/w package hdr init data size = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">init_data_size</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;f/w package hdr boot inst size = %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">boot_size</span><span class="p">);</span>

	<span class="cm">/* Verify size of file vs. image size info in file&#39;s header */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ucode_raw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">!=</span>
	    <span class="n">il3945_ucode_get_header_size</span><span class="p">(</span><span class="n">api_ver</span><span class="p">)</span> <span class="o">+</span> <span class="n">inst_size</span> <span class="o">+</span> <span class="n">data_size</span> <span class="o">+</span>
	    <span class="n">init_size</span> <span class="o">+</span> <span class="n">init_data_size</span> <span class="o">+</span> <span class="n">boot_size</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;uCode file size %zd does not match expected size</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">ucode_raw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Verify that uCode images will fit in card&#39;s SRAM */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inst_size</span> <span class="o">&gt;</span> <span class="n">IL39_MAX_INST_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;uCode instr len %d too large to fit in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">inst_size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data_size</span> <span class="o">&gt;</span> <span class="n">IL39_MAX_DATA_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;uCode data len %d too large to fit in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data_size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_size</span> <span class="o">&gt;</span> <span class="n">IL39_MAX_INST_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;uCode init instr len %d too large to fit in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">init_size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_data_size</span> <span class="o">&gt;</span> <span class="n">IL39_MAX_DATA_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;uCode init data len %d too large to fit in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">init_data_size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boot_size</span> <span class="o">&gt;</span> <span class="n">IL39_MAX_BSM_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;uCode boot instr len %d too large to fit in</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">boot_size</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate ucode buffers for card&#39;s bus-master loading ... */</span>

	<span class="cm">/* Runtime instructions and 2 copies of data:</span>
<span class="cm">	 * 1) unmodified from disk</span>
<span class="cm">	 * 2) backup cache for save/restore during power-downs */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">inst_size</span><span class="p">;</span>
	<span class="n">il_alloc_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="n">il_alloc_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="n">il_alloc_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">v_addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">.</span><span class="n">v_addr</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">.</span><span class="n">v_addr</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_pci_alloc</span><span class="p">;</span>

	<span class="cm">/* Initialization instructions and data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_size</span> <span class="o">&amp;&amp;</span> <span class="n">init_data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">init_size</span><span class="p">;</span>
		<span class="n">il_alloc_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init</span><span class="p">);</span>

		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init_data</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">init_data_size</span><span class="p">;</span>
		<span class="n">il_alloc_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init_data</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init</span><span class="p">.</span><span class="n">v_addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init_data</span><span class="p">.</span><span class="n">v_addr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_pci_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Bootstrap (instructions only, no data) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">boot_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_boot</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">boot_size</span><span class="p">;</span>
		<span class="n">il_alloc_fw_desc</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_boot</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_boot</span><span class="p">.</span><span class="n">v_addr</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_pci_alloc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Copy images into buffers for card&#39;s bus-master reads ... */</span>

	<span class="cm">/* Runtime instructions (first block of data in file) */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">inst_size</span><span class="p">;</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Copying (but not loading) uCode instr len %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">src</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;uCode instr buf vaddr = 0x%p, paddr = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">p_addr</span><span class="p">);</span>

	<span class="cm">/* Runtime data (2nd block)</span>
<span class="cm">	 * NOTE:  Copy into backup buffer will be done in il3945_up()  */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">data_size</span><span class="p">;</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Copying (but not loading) uCode data len %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">src</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Initialization instructions (3rd block) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">init_size</span><span class="p">;</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Copying (but not loading) init instr len %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialization data (4th block) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">init_data_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">init_data_size</span><span class="p">;</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Copying (but not loading) init data len %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_init_data</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">src</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Bootstrap instructions (5th block) */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">boot_size</span><span class="p">;</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Copying (but not loading) boot instr len %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_boot</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* We have our copies now, allow OS release its copies */</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">ucode_raw</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_pci_alloc:</span>
	<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;failed to allocate pci memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">il3945_dealloc_ucode_pci</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

<span class="nl">err_release:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">ucode_raw</span><span class="p">);</span>

<span class="nl">error:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_set_ucode_ptrs - Set uCode address location</span>
<span class="cm"> *</span>
<span class="cm"> * Tell initialization uCode where to find runtime uCode.</span>
<span class="cm"> *</span>
<span class="cm"> * BSM registers initially contain pointers to initialization uCode.</span>
<span class="cm"> * We need to replace them to load runtime uCode inst and data,</span>
<span class="cm"> * and to save runtime data when powering down.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_set_ucode_ptrs</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dma_addr_t</span> <span class="n">pinst</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">pdata</span><span class="p">;</span>

	<span class="cm">/* bits 31:0 for 3945 */</span>
	<span class="n">pinst</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">p_addr</span><span class="p">;</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">.</span><span class="n">p_addr</span><span class="p">;</span>

	<span class="cm">/* Tell bootstrap uCode where to find image to load */</span>
	<span class="n">il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">BSM_DRAM_INST_PTR_REG</span><span class="p">,</span> <span class="n">pinst</span><span class="p">);</span>
	<span class="n">il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">BSM_DRAM_DATA_PTR_REG</span><span class="p">,</span> <span class="n">pdata</span><span class="p">);</span>
	<span class="n">il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">BSM_DRAM_DATA_BYTECOUNT_REG</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Inst byte count must be last to set up, bit 31 signals uCode</span>
<span class="cm">	 *   that all new ptr/size info is in place */</span>
	<span class="n">il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">BSM_DRAM_INST_BYTECOUNT_REG</span><span class="p">,</span>
		   <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">len</span> <span class="o">|</span> <span class="n">BSM_DRAM_INST_LOAD</span><span class="p">);</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Runtime uCode pointers are set.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_init_alive_start - Called after N_ALIVE notification received</span>
<span class="cm"> *</span>
<span class="cm"> * Called after N_ALIVE notification received from &quot;initialize&quot; uCode.</span>
<span class="cm"> *</span>
<span class="cm"> * Tell &quot;initialize&quot; uCode to go ahead and load the runtime uCode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_init_alive_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Check alive response for &quot;valid&quot; sign from uCode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">card_alive_init</span><span class="p">.</span><span class="n">is_valid</span> <span class="o">!=</span> <span class="n">UCODE_VALID_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We had an error bringing up the hardware, so take it</span>
<span class="cm">		 * all the way back down so we can try again */</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Initialize Alive failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Bootstrap uCode has loaded initialize uCode ... verify inst image.</span>
<span class="cm">	 * This is a paranoid check, because we would not have gotten the</span>
<span class="cm">	 * &quot;initialize&quot; alive if code weren&#39;t properly loaded.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il3945_verify_ucode</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Runtime instruction load was bad;</span>
<span class="cm">		 * take it all the way back down so we can try again */</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Bad </span><span class="se">\&quot;</span><span class="s">initialize</span><span class="se">\&quot;</span><span class="s"> uCode load.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send pointers to protocol/runtime uCode image ... init code will</span>
<span class="cm">	 * load and launch runtime uCode, which will send us another &quot;Alive&quot;</span>
<span class="cm">	 * notification. */</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Initialization Alive received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il3945_set_ucode_ptrs</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Runtime instruction load won&#39;t happen;</span>
<span class="cm">		 * take it all the way back down so we can try again */</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Couldn&#39;t set up uCode pointers.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>

<span class="nl">restart:</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">restart</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * il3945_alive_start - called after N_ALIVE notification received</span>
<span class="cm"> *                   from protocol/runtime uCode (initialization uCode&#39;s</span>
<span class="cm"> *                   Alive gets handled by il3945_init_alive_start()).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_alive_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">thermal_spin</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rfkill</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Runtime Alive received.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">card_alive</span><span class="p">.</span><span class="n">is_valid</span> <span class="o">!=</span> <span class="n">UCODE_VALID_OK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* We had an error bringing up the hardware, so take it</span>
<span class="cm">		 * all the way back down so we can try again */</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Alive failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize uCode has loaded Runtime uCode ... verify inst image.</span>
<span class="cm">	 * This is a paranoid check, because we would not have gotten the</span>
<span class="cm">	 * &quot;runtime&quot; alive if code weren&#39;t properly loaded.  */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il3945_verify_ucode</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Runtime instruction load was bad;</span>
<span class="cm">		 * take it all the way back down so we can try again */</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Bad runtime uCode load.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">restart</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rfkill</span> <span class="o">=</span> <span class="n">il_rd_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">APMG_RFKILL_REG</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;RFKILL status: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rfkill</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rfkill</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="cm">/* if RFKILL is not on, then wait for thermal</span>
<span class="cm">		 * sensor in adapter to kick in */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">il3945_hw_get_temperature</span><span class="p">(</span><span class="n">il</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">thermal_spin</span><span class="o">++</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">thermal_spin</span><span class="p">)</span>
			<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Thermal calibration took %dus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">thermal_spin</span> <span class="o">*</span> <span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* After the ALIVE response, we can send commands to 3945 uCode */</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">S_ALIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* Enable watchdog to monitor the driver tx queues */</span>
	<span class="n">il_setup_watchdog</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_rfkill</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ieee80211_wake_queues</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">active_rate</span> <span class="o">=</span> <span class="n">RATES_MASK_3945</span><span class="p">;</span>

	<span class="n">il_power_update_mode</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_associated</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">il3945_rxon_cmd</span> <span class="o">*</span><span class="n">active_rxon</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">il3945_rxon_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">);</span>

		<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">|=</span> <span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>
		<span class="n">active_rxon</span><span class="o">-&gt;</span><span class="n">filter_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Initialize our rx_config data */</span>
		<span class="n">il_connection_init_rx_config</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Configure Bluetooth device coexistence support */</span>
	<span class="n">il_send_bt_config</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">S_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* Configure the adapter for unassociated operation */</span>
	<span class="n">il3945_commit_rxon</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">il3945_reg_txpower_periodic</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;ALIVE processing complete.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">restart:</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">restart</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">il3945_cancel_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__il3945_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">exit_pending</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot; is going down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">il_scan_cancel_timeout</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>

	<span class="n">exit_pending</span> <span class="o">=</span> <span class="n">test_and_set_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* Stop TX queues watchdog. We need to have S_EXIT_PENDING bit set</span>
<span class="cm">	 * to prevent rearm timer */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>

	<span class="cm">/* Station information will now be cleared in device */</span>
	<span class="n">il_clear_ucode_stations</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il_dealloc_bcast_stations</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il_clear_driver_stations</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/* Unblock any waiting calls */</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>

	<span class="cm">/* Wipe out the EXIT_PENDING status bit if we are not actually</span>
<span class="cm">	 * exiting the module */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">exit_pending</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* stop and reset the on-board processor */</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_RESET</span><span class="p">,</span> <span class="n">CSR_RESET_REG_FLAG_NEVO_RESET</span><span class="p">);</span>

	<span class="cm">/* tell the device to stop sending interrupts */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il_disable_interrupts</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il3945_synchronize_irq</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span><span class="p">)</span>
		<span class="n">ieee80211_stop_queues</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* If we have not previously called il3945_init() then</span>
<span class="cm">	 * clear all bits but the RF Kill bits and return */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il_is_init</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S_RFKILL</span> <span class="o">|</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_GEO_CONFIGURED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S_GEO_CONFIGURED</span> <span class="o">|</span>
		    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S_EXIT_PENDING</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* ...otherwise clear out all the status bits but the RF Kill</span>
<span class="cm">	 * bit and continue taking the NIC down. */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">&amp;=</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S_RFKILL</span> <span class="o">|</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_GEO_CONFIGURED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S_GEO_CONFIGURED</span> <span class="o">|</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_FW_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S_FW_ERROR</span> <span class="o">|</span>
	    <span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">S_EXIT_PENDING</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We disabled and synchronized interrupt, and priv-&gt;mutex is taken, so</span>
<span class="cm">	 * here is the only thread which will program device registers, but</span>
<span class="cm">	 * still have lockdep assertions, so we are taking reg_lock.</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="cm">/* FIXME: il_grab_nic_access if rfkill is off ? */</span>

	<span class="n">il3945_hw_txq_ctx_stop</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il3945_hw_rxq_stop</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="cm">/* Power-down device&#39;s busmaster DMA clocks */</span>
	<span class="n">_il_wr_prph</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">APMG_CLK_DIS_REG</span><span class="p">,</span> <span class="n">APMG_CLK_VAL_DMA_CLK_RQT</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>
	<span class="cm">/* Stop the device, and put it in low power state */</span>
	<span class="n">_il_apm_stop</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>

	<span class="n">il3945_hw_txq_ctx_free</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">card_alive</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_alive_resp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* clear out any free frames */</span>
	<span class="n">il3945_clear_free_frames</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">__il3945_down</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">il3945_cancel_deferred_work</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define MAX_HW_RESTARTS 5</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_alloc_bcast_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sta_id</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">sta_id</span> <span class="o">=</span> <span class="n">il_prep_station</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">il_bcast_addr</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IL_INVALID_STATION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to prepare broadcast station</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">used</span> <span class="o">|=</span> <span class="n">IL_STA_DRIVER_ACTIVE</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">stations</span><span class="p">[</span><span class="n">sta_id</span><span class="p">].</span><span class="n">used</span> <span class="o">|=</span> <span class="n">IL_STA_BCAST</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">__il3945_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">il3945_alloc_bcast_station</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Exit pending; will not bring the NIC up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">.</span><span class="n">v_addr</span> <span class="o">||</span> <span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">.</span><span class="n">v_addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;ucode not available for device bring up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If platform&#39;s RF_KILL switch is NOT set to KILL */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_GP_CNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR_GP_CNTRL_REG_FLAG_HW_RF_KILL_SW</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Radio disabled by HW RF Kill switch</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">il3945_hw_nic_init</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to int nic</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* make sure rfkill handshake bits are cleared */</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_CLR</span><span class="p">,</span> <span class="n">CSR_UCODE_SW_BIT_RFKILL</span><span class="p">);</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_CLR</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_BIT_CMD_BLOCKED</span><span class="p">);</span>

	<span class="cm">/* clear (again), then enable host interrupts */</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_INT</span><span class="p">,</span> <span class="mh">0xFFFFFFFF</span><span class="p">);</span>
	<span class="n">il_enable_interrupts</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/* really make sure rfkill handshake bits are cleared */</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_CLR</span><span class="p">,</span> <span class="n">CSR_UCODE_SW_BIT_RFKILL</span><span class="p">);</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_UCODE_DRV_GP1_CLR</span><span class="p">,</span> <span class="n">CSR_UCODE_SW_BIT_RFKILL</span><span class="p">);</span>

	<span class="cm">/* Copy original ucode data image from disk into backup cache.</span>
<span class="cm">	 * This will be used to initialize the on-board processor&#39;s</span>
<span class="cm">	 * data SRAM for a clean start when the runtime program first loads. */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data_backup</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">.</span><span class="n">v_addr</span><span class="p">,</span>
	       <span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_data</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* We return success when we resume from suspend and rf_kill is on. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_HW_RESTARTS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* load bootstrap state machine,</span>
<span class="cm">		 * load bootstrap program into processor&#39;s memory,</span>
<span class="cm">		 * prepare to load the &quot;initialize&quot; uCode */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">load_ucode</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to set up bootstrap uCode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* start card; &quot;initialize&quot; will load runtime ucode */</span>
		<span class="n">il3945_nic_start</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

		<span class="n">D_INFO</span><span class="p">(</span><span class="n">DRV_NAME</span> <span class="s">&quot; is coming up</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">__il3945_down</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="cm">/* tried to restart and config the device for as long as our</span>
<span class="cm">	 * patience could withstand */</span>
	<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to initialize device after %d attempts.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * Workqueue callbacks</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_bg_init_alive_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_priv</span><span class="p">,</span> <span class="n">init_alive_start</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">il3945_init_alive_start</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_bg_alive_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_priv</span><span class="p">,</span> <span class="n">alive_start</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">||</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">txq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">il3945_alive_start</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * 3945 cannot interrupt driver when hardware rf kill switch toggles;</span>
<span class="cm"> * driver must poll CSR_GP_CNTRL_REG register for change.  This register</span>
<span class="cm"> * *is* readable even when device has been SW_RESET into low power mode</span>
<span class="cm"> * (e.g. during RF KILL).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_rfkill_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_priv</span><span class="p">,</span> <span class="n">_3945</span><span class="p">.</span><span class="n">rfkill_poll</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">old_rfkill</span> <span class="o">=</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">bool</span> <span class="n">new_rfkill</span> <span class="o">=</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">_il_rd</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_GP_CNTRL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CSR_GP_CNTRL_REG_FLAG_HW_RF_KILL_SW</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_rfkill</span> <span class="o">!=</span> <span class="n">old_rfkill</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_rfkill</span><span class="p">)</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_RFKILL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="n">wiphy_rfkill_set_hw_state</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">new_rfkill</span><span class="p">);</span>

		<span class="n">D_RF_KILL</span><span class="p">(</span><span class="s">&quot;RF_KILL bit toggled to %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">new_rfkill</span> <span class="o">?</span> <span class="s">&quot;disable radio&quot;</span> <span class="o">:</span> <span class="s">&quot;enable radio&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Keep this running, even if radio now enabled.  This will be</span>
<span class="cm">	 * cancelled in mac_start() if system decides to start again */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">rfkill_poll</span><span class="p">,</span>
			   <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>

<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">il3945_request_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_host_cmd</span> <span class="n">cmd</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">id</span> <span class="o">=</span> <span class="n">C_SCAN</span><span class="p">,</span>
		<span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il3945_scan_cmd</span><span class="p">),</span>
		<span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">CMD_SIZE_HUGE</span><span class="p">,</span>
	<span class="p">};</span>
	<span class="k">struct</span> <span class="n">il3945_scan_cmd</span> <span class="o">*</span><span class="n">scan</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">n_probes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">ieee80211_band</span> <span class="n">band</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_active</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">lockdep_assert_held</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_cmd</span> <span class="o">=</span>
		    <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il3945_scan_cmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">IL_MAX_SCAN_SIZE</span><span class="p">,</span>
			    <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_cmd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;Fail to allocate scan memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">scan</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_cmd</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">scan</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il3945_scan_cmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">IL_MAX_SCAN_SIZE</span><span class="p">);</span>

	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">quiet_plcp_th</span> <span class="o">=</span> <span class="n">IL_PLCP_QUIET_THRESH</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">quiet_time</span> <span class="o">=</span> <span class="n">IL_ACTIVE_QUIET_TIME</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il_is_associated</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">interval</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">extra</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">suspend_time</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
		<span class="n">u32</span> <span class="n">scan_suspend_time</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>

		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Scanning while associated...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">interval</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">beacon_int</span><span class="p">;</span>

		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">suspend_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">max_out_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">200</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">interval</span><span class="p">)</span>
			<span class="n">interval</span> <span class="o">=</span> <span class="n">suspend_time</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * suspend time format:</span>
<span class="cm">		 *  0-19: beacon interval in usec (time before exec.)</span>
<span class="cm">		 * 20-23: 0</span>
<span class="cm">		 * 24-31: number of beacons (suspend between channels)</span>
<span class="cm">		 */</span>

		<span class="n">extra</span> <span class="o">=</span> <span class="p">(</span><span class="n">suspend_time</span> <span class="o">/</span> <span class="n">interval</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
		<span class="n">scan_suspend_time</span> <span class="o">=</span>
		    <span class="mh">0xFF0FFFFF</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">extra</span> <span class="o">|</span> <span class="p">((</span><span class="n">suspend_time</span> <span class="o">%</span> <span class="n">interval</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1024</span><span class="p">));</span>

		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">suspend_time</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">scan_suspend_time</span><span class="p">);</span>
		<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;suspend_time 0x%X beacon interval %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">scan_suspend_time</span><span class="p">,</span> <span class="n">interval</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">n_ssids</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;Kicking off active scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">n_ssids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* always does wildcard anyway */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="n">scan</span><span class="o">-&gt;</span><span class="n">direct_scan</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">id</span> <span class="o">=</span> <span class="n">WLAN_EID_SSID</span><span class="p">;</span>
			<span class="n">scan</span><span class="o">-&gt;</span><span class="n">direct_scan</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span>
			    <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">direct_scan</span><span class="p">[</span><span class="n">p</span><span class="p">].</span><span class="n">ssid</span><span class="p">,</span>
			       <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid</span><span class="p">,</span>
			       <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ssids</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ssid_len</span><span class="p">);</span>
			<span class="n">n_probes</span><span class="o">++</span><span class="p">;</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">is_active</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;Kicking off passive scan.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* We don&#39;t build a direct scan probe request; the uCode will do</span>
<span class="cm">	 * that based on the direct_mask added to each channel entry */</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">tx_flags</span> <span class="o">=</span> <span class="n">TX_CMD_FLG_SEQ_CTL_MSK</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">sta_id</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_params</span><span class="p">.</span><span class="n">bcast_id</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">stop_time</span><span class="p">.</span><span class="n">life_time</span> <span class="o">=</span> <span class="n">TX_CMD_LIFE_TIME_INFINITE</span><span class="p">;</span>

	<span class="cm">/* flags + rate selection */</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_band</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_2GHZ</span>:
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">RXON_FLG_BAND_24G_MSK</span> <span class="o">|</span> <span class="n">RXON_FLG_AUTO_DETECT_MSK</span><span class="p">;</span>
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">RATE_1M_PLCP</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">IEEE80211_BAND_5GHZ</span>:
		<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">RATE_6M_PLCP</span><span class="p">;</span>
		<span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_5GHZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Invalid scan band</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * If active scaning is requested but a certain channel is marked</span>
<span class="cm">	 * passive, we can do active scanning if we detect transmissions. For</span>
<span class="cm">	 * passive only scanning disable switching to active on any channel.</span>
<span class="cm">	 */</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">good_CRC_th</span> <span class="o">=</span>
	    <span class="n">is_active</span> <span class="o">?</span> <span class="n">IL_GOOD_CRC_TH_DEFAULT</span> <span class="o">:</span> <span class="n">IL_GOOD_CRC_TH_NEVER</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span>
	    <span class="n">il_fill_probe_req</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_mgmt</span> <span class="o">*</span><span class="p">)</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			      <span class="n">vif</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ie</span><span class="p">,</span>
			      <span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="o">-&gt;</span><span class="n">ie_len</span><span class="p">,</span>
			      <span class="n">IL_MAX_SCAN_SIZE</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">scan</span><span class="p">));</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* select Rx antennas */</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">il3945_get_antenna_flags</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel_count</span> <span class="o">=</span>
	    <span class="n">il3945_get_channels_for_scan</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">band</span><span class="p">,</span> <span class="n">is_active</span><span class="p">,</span> <span class="n">n_probes</span><span class="p">,</span>
					 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">len</span><span class="p">],</span> <span class="n">vif</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_SCAN</span><span class="p">(</span><span class="s">&quot;channel count %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel_count</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cmd</span><span class="p">.</span><span class="n">len</span> <span class="o">+=</span>
	    <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">scan</span><span class="o">-&gt;</span><span class="n">tx_cmd</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="o">+</span>
	    <span class="n">scan</span><span class="o">-&gt;</span><span class="n">channel_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il3945_scan_channel</span><span class="p">);</span>
	<span class="n">cmd</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="n">scan</span><span class="p">;</span>
	<span class="n">scan</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">S_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">il_send_cmd_sync</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">S_SCAN_HW</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il3945_post_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Since setting the RXON may have been deferred while</span>
<span class="cm">	 * performing the scan, fire one off if needed</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">)))</span>
		<span class="n">il3945_commit_rxon</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_bg_restart</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_priv</span><span class="p">,</span> <span class="n">restart</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">S_FW_ERROR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">is_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">il3945_down</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="n">ieee80211_restart_hw</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">il3945_down</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">__il3945_up</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_bg_rx_replenish</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">il_priv</span><span class="p">,</span> <span class="n">rx_replenish</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">il3945_rx_replenish</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il3945_post_associate</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_conf</span> <span class="o">*</span><span class="n">conf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span> <span class="o">||</span> <span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">is_open</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">D_ASSOC</span><span class="p">(</span><span class="s">&quot;Associated as %d to: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">aid</span><span class="p">,</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">bssid_addr</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">il_scan_cancel_timeout</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span>

	<span class="n">conf</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">conf</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>
	<span class="n">il3945_commit_rxon</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">il_send_rxon_timing</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;C_RXON_TIMING failed - &quot;</span> <span class="s">&quot;Attempting to continue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">|=</span> <span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">assoc_id</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">aid</span><span class="p">);</span>

	<span class="n">D_ASSOC</span><span class="p">(</span><span class="s">&quot;assoc id %d beacon interval %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">aid</span><span class="p">,</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">beacon_int</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_preamble</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_SHORT_PREAMBLE_MSK</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FLG_SHORT_PREAMBLE_MSK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_FLG_BAND_24G_MSK</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_slot</span><span class="p">)</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_SHORT_SLOT_MSK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FLG_SHORT_SLOT_MSK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">il3945_commit_rxon</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">il3945_rate_scale_init</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">IL_AP_ID</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="n">il3945_send_beacon_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;%s Should not be called in %d mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		      <span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * mac80211 entry point functions</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#define UCODE_READY_TIMEOUT	(2 * HZ)</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_mac_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* we should be verifying the device is ready to be opened */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* fetch ucode file from disk, alloc and copy to bus-master buffers ...</span>
<span class="cm">	 * ucode filename and max sizes are card-specific. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">ucode_code</span><span class="p">.</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">il3945_read_ucode</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Could not read microcode: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out_release_irq</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">__il3945_up</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_release_irq</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Start UP work.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Wait for START_ALIVE from ucode. Otherwise callbacks from</span>
<span class="cm">	 * mac80211 will not be run successfully. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_timeout</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">,</span>
				 <span class="n">test_bit</span><span class="p">(</span><span class="n">S_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span>
				 <span class="n">UCODE_READY_TIMEOUT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_READY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Wait for START_ALIVE timeout after %dms.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="n">UCODE_READY_TIMEOUT</span><span class="p">));</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_release_irq</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* ucode is running and will send rfkill notifications,</span>
<span class="cm">	 * no need to poll the killswitch state anymore */</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">rfkill_poll</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">is_open</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_release_irq:</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">is_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave - failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_mac_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">is_open</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave - skip</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">is_open</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">il3945_down</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>

	<span class="cm">/* start polling the killswitch state again */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">rfkill_poll</span><span class="p">,</span>
			   <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">));</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_mac_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">D_TX</span><span class="p">(</span><span class="s">&quot;dev-&gt;xmit(%d bytes) at rate 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
	     <span class="n">ieee80211_get_tx_rate</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="n">IEEE80211_SKB_CB</span><span class="p">(</span><span class="n">skb</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">bitrate</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il3945_tx_skb</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">il3945_config_ap</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">vif</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* The following should be done only at AP bring up */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">il_is_associated</span><span class="p">(</span><span class="n">il</span><span class="p">)))</span> <span class="p">{</span>

		<span class="cm">/* RXON - unassoc (to set timing command) */</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>
		<span class="n">il3945_commit_rxon</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

		<span class="cm">/* RXON Timing */</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">il_send_rxon_timing</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span>
			<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;C_RXON_TIMING failed - &quot;</span>
				<span class="s">&quot;Attempting to continue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">assoc_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_preamble</span><span class="p">)</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_SHORT_PREAMBLE_MSK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FLG_SHORT_PREAMBLE_MSK</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RXON_FLG_BAND_24G_MSK</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">bss_conf</span><span class="p">.</span><span class="n">use_short_slot</span><span class="p">)</span>
				<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RXON_FLG_SHORT_SLOT_MSK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RXON_FLG_SHORT_SLOT_MSK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* restore RXON assoc */</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">|=</span> <span class="n">RXON_FILTER_ASSOC_MSK</span><span class="p">;</span>
		<span class="n">il3945_commit_rxon</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">il3945_send_beacon_cmd</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_mac_set_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">enum</span> <span class="n">set_key_cmd</span> <span class="n">cmd</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ieee80211_key_conf</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sta_id</span> <span class="o">=</span> <span class="n">IL_INVALID_STATION</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">static_key</span><span class="p">;</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il3945_mod_params</span><span class="p">.</span><span class="n">sw_crypto</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave - hwcrypto disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * To support IBSS RSN, don&#39;t program group keys in IBSS, the</span>
<span class="cm">	 * hardware will then not attempt to decrypt the frames.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_ADHOC</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">key</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IEEE80211_KEY_FLAG_PAIRWISE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave - IBSS RSN</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">static_key</span> <span class="o">=</span> <span class="o">!</span><span class="n">il_is_associated</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">static_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sta_id</span> <span class="o">=</span> <span class="n">il_sta_id_or_broadcast</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sta_id</span> <span class="o">==</span> <span class="n">IL_INVALID_STATION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave - station not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">il_scan_cancel_timeout</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SET_KEY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">static_key</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">il3945_set_static_key</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">il3945_set_dynamic_key</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>
		<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;enable hwcrypto key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">DISABLE_KEY</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">static_key</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">il3945_remove_static_key</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">il3945_clear_sta_key_info</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>
		<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;disable hwcrypto key</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;leave ret %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_mac_sta_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ieee80211_vif</span> <span class="o">*</span><span class="n">vif</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">ieee80211_sta</span> <span class="o">*</span><span class="n">sta</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il3945_sta_priv</span> <span class="o">*</span><span class="n">sta_priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">sta</span><span class="o">-&gt;</span><span class="n">drv_priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_ap</span> <span class="o">=</span> <span class="n">vif</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">sta_id</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;station %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">sta_id</span> <span class="o">=</span> <span class="n">IL_INVALID_STATION</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il_add_station_common</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">is_ap</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sta_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to add station %pM (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="cm">/* Should we return success if return code is EEXIST ? */</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sta_priv</span><span class="o">-&gt;</span><span class="n">common</span><span class="p">.</span><span class="n">sta_id</span> <span class="o">=</span> <span class="n">sta_id</span><span class="p">;</span>

	<span class="cm">/* Initialize rate scaling */</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Initializing rate scaling for station %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sta</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">il3945_rs_rate_init</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">sta</span><span class="p">,</span> <span class="n">sta_id</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_configure_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed_flags</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">total_flags</span><span class="p">,</span> <span class="n">u64</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">filter_or</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">filter_nand</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#define CHK(test, flag)	do { \</span>
<span class="cp">	if (*total_flags &amp; (test))		\</span>
<span class="cp">		filter_or |= (flag);		\</span>
<span class="cp">	else					\</span>
<span class="cp">		filter_nand |= (flag);		\</span>
<span class="cp">	} while (0)</span>

	<span class="n">D_MAC80211</span><span class="p">(</span><span class="s">&quot;Enter: changed: 0x%x, total: 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">changed_flags</span><span class="p">,</span>
		   <span class="o">*</span><span class="n">total_flags</span><span class="p">);</span>

	<span class="n">CHK</span><span class="p">(</span><span class="n">FIF_OTHER_BSS</span> <span class="o">|</span> <span class="n">FIF_PROMISC_IN_BSS</span><span class="p">,</span> <span class="n">RXON_FILTER_PROMISC_MSK</span><span class="p">);</span>
	<span class="n">CHK</span><span class="p">(</span><span class="n">FIF_CONTROL</span><span class="p">,</span> <span class="n">RXON_FILTER_CTL2HOST_MSK</span><span class="p">);</span>
	<span class="n">CHK</span><span class="p">(</span><span class="n">FIF_BCN_PRBRESP_PROMISC</span><span class="p">,</span> <span class="n">RXON_FILTER_BCON_AWARE_MSK</span><span class="p">);</span>

<span class="cp">#undef CHK</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">filter_nand</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">|=</span> <span class="n">filter_or</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Not committing directly because hardware can perform a scan,</span>
<span class="cm">	 * but even if hw is ready, committing here breaks for some reason,</span>
<span class="cm">	 * we&#39;ll eventually commit the filter flags change anyway.</span>
<span class="cm">	 */</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Receiving all multicast frames is always enabled by the</span>
<span class="cm">	 * default flags setup in il_connection_init_rx_config()</span>
<span class="cm">	 * since we currently do not support programming multicast</span>
<span class="cm">	 * filters into the device.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">total_flags</span> <span class="o">&amp;=</span>
	    <span class="n">FIF_OTHER_BSS</span> <span class="o">|</span> <span class="n">FIF_ALLMULTI</span> <span class="o">|</span> <span class="n">FIF_PROMISC_IN_BSS</span> <span class="o">|</span>
	    <span class="n">FIF_BCN_PRBRESP_PROMISC</span> <span class="o">|</span> <span class="n">FIF_CONTROL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * sysfs attributes</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>

<span class="cm">/*</span>
<span class="cm"> * The following adds a new attribute to the sysfs representation</span>
<span class="cm"> * of this device driver (i.e. a new file in /sys/bus/pci/drivers/iwl/)</span>
<span class="cm"> * used for controlling the debug level.</span>
<span class="cm"> *</span>
<span class="cm"> * See the level definitions in iwl for details.</span>
<span class="cm"> *</span>
<span class="cm"> * The debug_level being managed using sysfs below is a per device debug</span>
<span class="cm"> * level that is used instead of the global debug level if it (the per</span>
<span class="cm"> * device debug level) is set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_show_debug_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il_get_debug_level</span><span class="p">(</span><span class="n">il</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_store_debug_level</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">val</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">IL_INFO</span><span class="p">(</span><span class="s">&quot;%s is not in hex or decimal form.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">debug_level</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">debug_level</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">il3945_show_debug_level</span><span class="p">,</span>
		   <span class="n">il3945_store_debug_level</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* CONFIG_IWLEGACY_DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_show_temperature</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il_is_alive</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il3945_hw_get_temperature</span><span class="p">(</span><span class="n">il</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">temperature</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">il3945_show_temperature</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_show_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">tx_power_user_lmt</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_store_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">;</span>

	<span class="n">val</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span> <span class="o">==</span> <span class="n">buf</span><span class="p">)</span>
		<span class="n">IL_INFO</span><span class="p">(</span><span class="s">&quot;: %s is not in decimal form.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">il3945_hw_reg_set_txpower</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">tx_power</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">il3945_show_tx_power</span><span class="p">,</span>
		   <span class="n">il3945_store_tx_power</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_show_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_store_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">flags</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span><span class="p">)</span> <span class="o">!=</span> <span class="n">flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Cancel any currently running scans... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">il_scan_cancel_timeout</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
			<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Could not cancel scan.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Committing rxon.flags = 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="n">il3945_commit_rxon</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">flags</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">il3945_show_flags</span><span class="p">,</span>
		   <span class="n">il3945_store_flags</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_show_filter_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">filter_flags</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_store_filter_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">filter_flags</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span><span class="p">)</span> <span class="o">!=</span> <span class="n">filter_flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Cancel any currently running scans... */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">il_scan_cancel_timeout</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
			<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Could not cancel scan.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Committing rxon.filter_flags = &quot;</span> <span class="s">&quot;0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">filter_flags</span><span class="p">);</span>
			<span class="n">il</span><span class="o">-&gt;</span><span class="n">staging</span><span class="p">.</span><span class="n">filter_flags</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">filter_flags</span><span class="p">);</span>
			<span class="n">il3945_commit_rxon</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">filter_flags</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">il3945_show_filter_flags</span><span class="p">,</span>
		   <span class="n">il3945_store_filter_flags</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_show_measurement</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">il_spectrum_notification</span> <span class="n">measure_report</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">measure_report</span><span class="p">),</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ofs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">measure_report</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">measurement_status</span> <span class="o">&amp;</span> <span class="n">MEASUREMENT_READY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">measure_report</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">measure_report</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">measurement_status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;&amp;</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hex_dump_to_buffer</span><span class="p">(</span><span class="n">data</span> <span class="o">+</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span>
				   <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">len</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>

		<span class="n">ofs</span> <span class="o">+=</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">size</span> <span class="o">-=</span> <span class="n">min</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="mi">16U</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_store_measurement</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_measurement_params</span> <span class="n">params</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">active</span><span class="p">.</span><span class="n">channel</span><span class="p">),</span>
		<span class="p">.</span><span class="n">start_time</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">last_tsf</span><span class="p">),</span>
		<span class="p">.</span><span class="n">duration</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
	<span class="p">};</span>
	<span class="n">u8</span> <span class="n">type</span> <span class="o">=</span> <span class="n">IL_MEASURE_BASIC</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">),</span> <span class="n">count</span><span class="p">));</span>
		<span class="n">channel</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span>
			<span class="n">params</span><span class="p">.</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">p</span> <span class="o">!=</span> <span class="sc">&#39; &#39;</span><span class="p">)</span>
			<span class="n">p</span><span class="o">++</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Invoking measurement of type %d on &quot;</span> <span class="s">&quot;channel %d (for &#39;%s&#39;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">type</span><span class="p">,</span> <span class="n">params</span><span class="p">.</span><span class="n">channel</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">il3945_get_measurement</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">params</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">measurement</span><span class="p">,</span> <span class="n">S_IRUSR</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">il3945_show_measurement</span><span class="p">,</span>
		   <span class="n">il3945_store_measurement</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_store_retry_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">retry_rate</span> <span class="o">=</span> <span class="n">simple_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">retry_rate</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">retry_rate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_show_retry_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">retry_rate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">retry_rate</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">il3945_show_retry_rate</span><span class="p">,</span>
		   <span class="n">il3945_store_retry_rate</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_show_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* all this shit doesn&#39;t belong into sysfs anyway */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">channels</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">il3945_show_channels</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_show_antenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il_is_alive</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il3945_mod_params</span><span class="p">.</span><span class="n">antenna</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_store_antenna</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="n">__maybe_unused</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ant</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%1i&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ant</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;not in hex or decimal form.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ant</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ant</span> <span class="o">&lt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Setting antenna select to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ant</span><span class="p">);</span>
		<span class="n">il3945_mod_params</span><span class="p">.</span><span class="n">antenna</span> <span class="o">=</span> <span class="p">(</span><span class="k">enum</span> <span class="n">il3945_antenna</span><span class="p">)</span><span class="n">ant</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Bad antenna select value %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ant</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">antenna</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">il3945_show_antenna</span><span class="p">,</span>
		   <span class="n">il3945_store_antenna</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_show_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il_is_alive</span><span class="p">(</span><span class="n">il</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">il3945_show_status</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">il3945_dump_error_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
		      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;1&#39;</span><span class="p">)</span>
		<span class="n">il3945_dump_nic_error_log</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">strnlen</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">dump_errors</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">il3945_dump_error_log</span><span class="p">);</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * driver setup and tear down</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_setup_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="n">DRV_NAME</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">wait_command_queue</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">restart</span><span class="p">,</span> <span class="n">il3945_bg_restart</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rx_replenish</span><span class="p">,</span> <span class="n">il3945_bg_rx_replenish</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">init_alive_start</span><span class="p">,</span> <span class="n">il3945_bg_init_alive_start</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">alive_start</span><span class="p">,</span> <span class="n">il3945_bg_alive_start</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">rfkill_poll</span><span class="p">,</span> <span class="n">il3945_rfkill_poll</span><span class="p">);</span>

	<span class="n">il_setup_scan_deferred_work</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">il3945_hw_setup_deferred_work</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">il</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">il_bg_watchdog</span><span class="p">;</span>

	<span class="n">tasklet_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">irq_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">il3945_irq_tasklet</span><span class="p">,</span>
		     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">il3945_cancel_deferred_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">il3945_hw_cancel_deferred_work</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">init_alive_start</span><span class="p">);</span>
	<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">alive_start</span><span class="p">);</span>

	<span class="n">il_cancel_scan_deferred_work</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">il3945_sysfs_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_antenna</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_channels</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_dump_errors</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_flags</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_filter_flags</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_measurement</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_retry_rate</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_temperature</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_tx_power</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
	<span class="o">&amp;</span><span class="n">dev_attr_debug_level</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">il3945_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* put in device directory */</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">il3945_sysfs_entries</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ieee80211_ops</span> <span class="n">il3945_mac_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">tx</span> <span class="o">=</span> <span class="n">il3945_mac_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">il3945_mac_start</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span> <span class="n">il3945_mac_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_interface</span> <span class="o">=</span> <span class="n">il_mac_add_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_interface</span> <span class="o">=</span> <span class="n">il_mac_remove_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">change_interface</span> <span class="o">=</span> <span class="n">il_mac_change_interface</span><span class="p">,</span>
	<span class="p">.</span><span class="n">config</span> <span class="o">=</span> <span class="n">il_mac_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">configure_filter</span> <span class="o">=</span> <span class="n">il3945_configure_filter</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_key</span> <span class="o">=</span> <span class="n">il3945_mac_set_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">conf_tx</span> <span class="o">=</span> <span class="n">il_mac_conf_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_tsf</span> <span class="o">=</span> <span class="n">il_mac_reset_tsf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bss_info_changed</span> <span class="o">=</span> <span class="n">il_mac_bss_info_changed</span><span class="p">,</span>
	<span class="p">.</span><span class="n">hw_scan</span> <span class="o">=</span> <span class="n">il_mac_hw_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_add</span> <span class="o">=</span> <span class="n">il3945_mac_sta_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sta_remove</span> <span class="o">=</span> <span class="n">il_mac_sta_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_last_beacon</span> <span class="o">=</span> <span class="n">il_mac_tx_last_beacon</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_init_drv</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il3945_eeprom</span> <span class="o">*</span><span class="n">eeprom</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il3945_eeprom</span> <span class="o">*</span><span class="p">)</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">retry_rate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">sta_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hcmd_lock</span><span class="p">);</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">free_frames</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ieee_channels</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ieee_rates</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">band</span> <span class="o">=</span> <span class="n">IEEE80211_BAND_2GHZ</span><span class="p">;</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">iw_mode</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">missed_beacon_threshold</span> <span class="o">=</span> <span class="n">IL_MISSED_BEACON_THRESHOLD_DEF</span><span class="p">;</span>

	<span class="cm">/* initialize force reset */</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">force_reset</span><span class="p">.</span><span class="n">reset_duration</span> <span class="o">=</span> <span class="n">IL_DELAY_NEXT_FORCE_FW_RELOAD</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">EEPROM_3945_EEPROM_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;Unsupported EEPROM version: 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">il_init_channel_map</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;initializing regulatory failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set up txpower settings in driver for all channels */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il3945_txpower_set_from_eeprom</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_channel_map</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il_init_geos</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;initializing geos failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_free_channel_map</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">il3945_init_hw_rates</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">ieee_rates</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_channel_map:</span>
	<span class="n">il_free_channel_map</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define IL3945_MAX_PROBE_REQUEST	200</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_setup_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span> <span class="o">=</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">rate_control_algorithm</span> <span class="o">=</span> <span class="s">&quot;iwl-3945-rs&quot;</span><span class="p">;</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">sta_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il3945_sta_priv</span><span class="p">);</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">vif_data_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_vif_priv</span><span class="p">);</span>

	<span class="cm">/* Tell mac80211 our characteristics */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_HW_SIGNAL_DBM</span> <span class="o">|</span> <span class="n">IEEE80211_HW_SPECTRUM_MGMT</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span>
	    <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">);</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span>
	    <span class="n">WIPHY_FLAG_CUSTOM_REGULATORY</span> <span class="o">|</span> <span class="n">WIPHY_FLAG_DISABLE_BEACON_HINTS</span> <span class="o">|</span>
	    <span class="n">WIPHY_FLAG_IBSS_RSN</span><span class="p">;</span>

	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ssids</span> <span class="o">=</span> <span class="n">PROBE_OPTION_MAX_3945</span><span class="p">;</span>
	<span class="cm">/* we create the 802.11 header and a zero-length SSID element */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ie_len</span> <span class="o">=</span> <span class="n">IL3945_MAX_PROBE_REQUEST</span> <span class="o">-</span> <span class="mi">24</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* Default value; 4 EDCA QOS priorities */</span>
	<span class="n">hw</span><span class="o">-&gt;</span><span class="n">queues</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">n_channels</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span>
		    <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">].</span><span class="n">n_channels</span><span class="p">)</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="o">-&gt;</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">]</span> <span class="o">=</span>
		    <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_5GHZ</span><span class="p">];</span>

	<span class="n">il_leds_init</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ieee80211_register_hw</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Failed to register hw (error %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">il3945_pci_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_hw</span> <span class="o">*</span><span class="n">hw</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">il_cfg</span> <span class="o">*</span><span class="n">cfg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il_cfg</span> <span class="o">*</span><span class="p">)(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">il3945_eeprom</span> <span class="o">*</span><span class="n">eeprom</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/***********************</span>
<span class="cm">	 * 1. Allocating HW data</span>
<span class="cm">	 * ********************/</span>

	<span class="n">hw</span> <span class="o">=</span> <span class="n">ieee80211_alloc_hw</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">il_priv</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">il3945_mac_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hw</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">il</span> <span class="o">=</span> <span class="n">hw</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span> <span class="o">=</span> <span class="n">hw</span><span class="p">;</span>
	<span class="n">SET_IEEE80211_DEV</span><span class="p">(</span><span class="n">hw</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">il</span><span class="o">-&gt;</span><span class="n">cmd_queue</span> <span class="o">=</span> <span class="n">IL39_CMD_QUEUE_NUM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disabling hardware scan means that mac80211 will perform scans</span>
<span class="cm">	 * &quot;the hard way&quot;, rather than using device&#39;s scan.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il3945_mod_params</span><span class="p">.</span><span class="n">disable_hw_scan</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;Disabling hw_scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">il3945_mac_ops</span><span class="p">.</span><span class="n">hw_scan</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;*** LOAD DRIVER ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span> <span class="o">=</span> <span class="n">cfg</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il3945_ops</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUGFS</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">debugfs_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">il3945_debugfs_ops</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">inta_mask</span> <span class="o">=</span> <span class="n">CSR_INI_SET_MASK</span><span class="p">;</span>

	<span class="cm">/***************************</span>
<span class="cm">	 * 2. Initializing PCI bus</span>
<span class="cm">	 * *************************/</span>
	<span class="n">pci_disable_link_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
			       <span class="n">PCIE_LINK_STATE_L0S</span> <span class="o">|</span> <span class="n">PCIE_LINK_STATE_L1</span> <span class="o">|</span>
			       <span class="n">PCIE_LINK_STATE_CLKPM</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_ieee80211_free_hw</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">pci_set_consistent_dma_mask</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DMA_BIT_MASK</span><span class="p">(</span><span class="mi">32</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_WARN</span><span class="p">(</span><span class="s">&quot;No suitable DMA available.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_pci_disable_device</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">il</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_pci_disable_device</span><span class="p">;</span>

	<span class="cm">/***********************</span>
<span class="cm">	 * 3. Read REV Register</span>
<span class="cm">	 * ********************/</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_base</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_base</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_pci_release_regions</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;pci_resource_len = 0x%08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;pci_resource_base = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_base</span><span class="p">);</span>

	<span class="cm">/* We disable the RETRY_TIMEOUT register (0x41) to keep</span>
<span class="cm">	 * PCI Tx retries from interfering with C3 CPU state */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="cm">/* these spin locks will be used in apm_init and EEPROM access</span>
<span class="cm">	 * we should init now</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">reg_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * stop and reset the on-board processor just in case it is in a</span>
<span class="cm">	 * strange state ... like being left stranded by a primary kernel</span>
<span class="cm">	 * and this is now the kdump kernel trying to start up</span>
<span class="cm">	 */</span>
	<span class="n">_il_wr</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">CSR_RESET</span><span class="p">,</span> <span class="n">CSR_RESET_REG_FLAG_NEVO_RESET</span><span class="p">);</span>

	<span class="cm">/***********************</span>
<span class="cm">	 * 4. Read EEPROM</span>
<span class="cm">	 * ********************/</span>

	<span class="cm">/* Read the EEPROM */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">il_eeprom_init</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Unable to init EEPROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_iounmap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* MAC Address location in EEPROM same for 3945/4965 */</span>
	<span class="n">eeprom</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">il3945_eeprom</span> <span class="o">*</span><span class="p">)</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">eeprom</span><span class="p">;</span>
	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;MAC address: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">);</span>
	<span class="n">SET_IEEE80211_PERM_ADDR</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">eeprom</span><span class="o">-&gt;</span><span class="n">mac_address</span><span class="p">);</span>

	<span class="cm">/***********************</span>
<span class="cm">	 * 5. Setup HW Constants</span>
<span class="cm">	 * ********************/</span>
	<span class="cm">/* Device-specific setup */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il3945_hw_set_hw_params</span><span class="p">(</span><span class="n">il</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;failed to set hw settings</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_eeprom_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/***********************</span>
<span class="cm">	 * 6. Setup il</span>
<span class="cm">	 * ********************/</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">il3945_init_drv</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;initializing driver failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unset_hw_params</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">IL_INFO</span><span class="p">(</span><span class="s">&quot;Detected Intel Wireless WiFi Link %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">cfg</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/***********************</span>
<span class="cm">	 * 7. Setup Services</span>
<span class="cm">	 * ********************/</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il_disable_interrupts</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">pci_enable_msi</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">il_isr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;Error allocating IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_disable_msi</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il3945_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;failed to create sysfs device attributes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_release_irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">il_set_rxon_channel</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">].</span><span class="n">channels</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="n">il3945_setup_deferred_work</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il3945_setup_handlers</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il_power_initialize</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/*********************************</span>
<span class="cm">	 * 8. Setup and Register mac80211</span>
<span class="cm">	 * *******************************/</span>

	<span class="n">il_enable_interrupts</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">il3945_setup_mac</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_remove_sysfs</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">il_dbgfs_register</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="n">IL_ERR</span><span class="p">(</span><span class="s">&quot;failed to create debugfs files. Ignoring error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">err</span><span class="p">);</span>

	<span class="cm">/* Start monitoring the killswitch */</span>
	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">rfkill_poll</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_remove_sysfs:</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il3945_attribute_group</span><span class="p">);</span>
<span class="nl">out_release_irq:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">il</span><span class="p">);</span>
<span class="nl">out_disable_msi:</span>
	<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">pci_dev</span><span class="p">);</span>
	<span class="n">il_free_geos</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il_free_channel_map</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">out_unset_hw_params:</span>
	<span class="n">il3945_unset_hw_params</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">out_eeprom_free:</span>
	<span class="n">il_eeprom_free</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
<span class="nl">out_iounmap:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_base</span><span class="p">);</span>
<span class="nl">out_pci_release_regions:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">out_pci_disable_device:</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">out_ieee80211_free_hw:</span>
	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">il3945_pci_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">il_priv</span> <span class="o">*</span><span class="n">il</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">il</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">D_INFO</span><span class="p">(</span><span class="s">&quot;*** UNLOAD DRIVER ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">il_dbgfs_unregister</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">S_EXIT_PENDING</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

	<span class="n">il_leds_exit</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ieee80211_unregister_hw</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
		<span class="n">il</span><span class="o">-&gt;</span><span class="n">mac80211_registered</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">il3945_down</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Make sure device is reset to low power before unloading driver.</span>
<span class="cm">	 * This may be redundant with il_down(), but there are paths to</span>
<span class="cm">	 * run il_down() without calling apm_ops.stop(), and there are</span>
<span class="cm">	 * paths to avoid running il_down() at all before leaving driver.</span>
<span class="cm">	 * This (inexpensive) call *makes sure* device is reset.</span>
<span class="cm">	 */</span>
	<span class="n">il_apm_stop</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/* make sure we flush any pending irq or</span>
<span class="cm">	 * tasklet for the driver</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">il_disable_interrupts</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">il3945_synchronize_irq</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il3945_attribute_group</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">_3945</span><span class="p">.</span><span class="n">rfkill_poll</span><span class="p">);</span>

	<span class="n">il3945_dealloc_ucode_pci</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">.</span><span class="n">bd</span><span class="p">)</span>
		<span class="n">il3945_rx_queue_free</span><span class="p">(</span><span class="n">il</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">rxq</span><span class="p">);</span>
	<span class="n">il3945_hw_txq_ctx_free</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="n">il3945_unset_hw_params</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>

	<span class="cm">/*netif_stop_queue(dev); */</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>

	<span class="cm">/* ieee80211_unregister_hw calls il3945_mac_stop, which flushes</span>
<span class="cm">	 * il-&gt;workqueue... so we can&#39;t take down the workqueue</span>
<span class="cm">	 * until now... */</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
	<span class="n">il</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">il</span><span class="p">);</span>
	<span class="n">pci_disable_msi</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw_base</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">il_free_channel_map</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">il_free_geos</span><span class="p">(</span><span class="n">il</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">scan_cmd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="p">)</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">beacon_skb</span><span class="p">);</span>

	<span class="n">ieee80211_free_hw</span><span class="p">(</span><span class="n">il</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * driver and module entry point</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">il3945_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">il3945_hw_card_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">il3945_pci_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">il3945_pci_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">pm</span> <span class="o">=</span> <span class="n">IL_LEGACY_PM_OPS</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">il3945_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_DESCRIPTION</span> <span class="s">&quot;, &quot;</span> <span class="n">DRV_VERSION</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="n">DRV_COPYRIGHT</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">il3945_rate_control_register</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to register rate control algorithm: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il3945_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to initialize PCI module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_register</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">error_register:</span>
	<span class="n">il3945_rate_control_unregister</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">il3945_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">il3945_driver</span><span class="p">);</span>
	<span class="n">il3945_rate_control_unregister</span><span class="p">();</span>
<span class="p">}</span>

<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">IL3945_MODULE_FIRMWARE</span><span class="p">(</span><span class="n">IL3945_UCODE_API_MAX</span><span class="p">));</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">antenna</span><span class="p">,</span> <span class="n">il3945_mod_params</span><span class="p">.</span><span class="n">antenna</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">antenna</span><span class="p">,</span> <span class="s">&quot;select antenna (1=Main, 2=Aux, default 0 [both])&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">swcrypto</span><span class="p">,</span> <span class="n">il3945_mod_params</span><span class="p">.</span><span class="n">sw_crypto</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">swcrypto</span><span class="p">,</span> <span class="s">&quot;using software crypto (default 1 [software])&quot;</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">disable_hw_scan</span><span class="p">,</span> <span class="n">il3945_mod_params</span><span class="p">.</span><span class="n">disable_hw_scan</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span>
		   <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">disable_hw_scan</span><span class="p">,</span> <span class="s">&quot;disable hardware scanning (default 1)&quot;</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_IWLEGACY_DEBUG</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="n">il_debug_level</span><span class="p">,</span> <span class="n">uint</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;debug output mask&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">fw_restart</span><span class="p">,</span> <span class="n">il3945_mod_params</span><span class="p">.</span><span class="n">restart_fw</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">fw_restart</span><span class="p">,</span> <span class="s">&quot;restart firmware in case of error&quot;</span><span class="p">);</span>

<span class="n">module_exit</span><span class="p">(</span><span class="n">il3945_exit</span><span class="p">);</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">il3945_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
