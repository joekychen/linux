<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wireless › rndis_wlan.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>rndis_wlan.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Driver for RNDIS based wireless USB devices.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007 by Bjorge Dijkstra &lt;bjd@jooz.net&gt;</span>
<span class="cm"> * Copyright (C) 2008-2009 by Jussi Kivilinna &lt;jussi.kivilinna@mbnet.fi&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> *  Portions of this file are based on NDISwrapper project,</span>
<span class="cm"> *  Copyright (C) 2003-2005 Pontus Fuchs, Giridhar Pemmasani</span>
<span class="cm"> *  http://ndiswrapper.sourceforge.net/</span>
<span class="cm"> */</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define    DEBUG           // error path messages, extra info</h1>

<h1>define    VERBOSE         // more; success messages</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/usb.h&gt;</span>
<span class="cp">#include &lt;linux/usb/cdc.h&gt;</span>
<span class="cp">#include &lt;linux/ieee80211.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;net/cfg80211.h&gt;</span>
<span class="cp">#include &lt;linux/usb/usbnet.h&gt;</span>
<span class="cp">#include &lt;linux/usb/rndis_host.h&gt;</span>


<span class="cm">/* NOTE: All these are settings for Broadcom chipset */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">modparam_country</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;EU&quot;</span><span class="p">;</span>
<span class="n">module_param_string</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="n">modparam_country</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">country</span><span class="p">,</span> <span class="s">&quot;Country code (ISO 3166-1 alpha-2), default: EU&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_frameburst</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">frameburst</span><span class="p">,</span> <span class="n">modparam_frameburst</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">frameburst</span><span class="p">,</span> <span class="s">&quot;enable frame bursting (default: on)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_afterburner</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">afterburner</span><span class="p">,</span> <span class="n">modparam_afterburner</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">afterburner</span><span class="p">,</span>
	<span class="s">&quot;enable afterburner aka &#39;125 High Speed Mode&#39; (default: off)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_power_save</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">power_save</span><span class="p">,</span> <span class="n">modparam_power_save</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">power_save</span><span class="p">,</span>
	<span class="s">&quot;set power save mode: 0=off, 1=on, 2=fast (default: off)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_power_output</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">power_output</span><span class="p">,</span> <span class="n">modparam_power_output</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">power_output</span><span class="p">,</span>
	<span class="s">&quot;set power output: 0=25%, 1=50%, 2=75%, 3=100% (default: 100%)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_roamtrigger</span> <span class="o">=</span> <span class="o">-</span><span class="mi">70</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">roamtrigger</span><span class="p">,</span> <span class="n">modparam_roamtrigger</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">roamtrigger</span><span class="p">,</span>
	<span class="s">&quot;set roaming dBm trigger: -80=optimize for distance, &quot;</span>
				<span class="s">&quot;-60=bandwidth (default: -70)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_roamdelta</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">roamdelta</span><span class="p">,</span> <span class="n">modparam_roamdelta</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">roamdelta</span><span class="p">,</span>
	<span class="s">&quot;set roaming tendency: 0=aggressive, 1=moderate, &quot;</span>
				<span class="s">&quot;2=conservative (default: moderate)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">modparam_workaround_interval</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">workaround_interval</span><span class="p">,</span> <span class="n">modparam_workaround_interval</span><span class="p">,</span>
							<span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">workaround_interval</span><span class="p">,</span>
	<span class="s">&quot;set stall workaround interval in msecs (0=disabled) (default: 0)&quot;</span><span class="p">);</span>

<span class="cm">/* Typical noise/maximum signal level values taken from ndiswrapper iw_ndis.h */</span>
<span class="cp">#define	WL_NOISE	-96	</span><span class="cm">/* typical noise level in dBm */</span><span class="cp"></span>
<span class="cp">#define	WL_SIGMAX	-32	</span><span class="cm">/* typical maximum signal level in dBm */</span><span class="cp"></span>


<span class="cm">/* Assume that Broadcom 4320 (only chipset at time of writing known to be</span>
<span class="cm"> * based on wireless rndis) has default txpower of 13dBm.</span>
<span class="cm"> * This value is from Linksys WUSB54GSC User Guide, Appendix F: Specifications.</span>
<span class="cm"> *  100% : 20 mW ~ 13dBm</span>
<span class="cm"> *   75% : 15 mW ~ 12dBm</span>
<span class="cm"> *   50% : 10 mW ~ 10dBm</span>
<span class="cm"> *   25% :  5 mW ~  7dBm</span>
<span class="cm"> */</span>
<span class="cp">#define BCM4320_DEFAULT_TXPOWER_DBM_100 13</span>
<span class="cp">#define BCM4320_DEFAULT_TXPOWER_DBM_75  12</span>
<span class="cp">#define BCM4320_DEFAULT_TXPOWER_DBM_50  10</span>
<span class="cp">#define BCM4320_DEFAULT_TXPOWER_DBM_25  7</span>

<span class="cm">/* Known device types */</span>
<span class="cp">#define RNDIS_UNKNOWN	0</span>
<span class="cp">#define RNDIS_BCM4320A	1</span>
<span class="cp">#define RNDIS_BCM4320B	2</span>


<span class="cm">/* NDIS data structures. Taken from wpa_supplicant driver_ndis.c</span>
<span class="cm"> * slightly modified for datatype endianess, etc</span>
<span class="cm"> */</span>
<span class="cp">#define NDIS_802_11_LENGTH_SSID 32</span>
<span class="cp">#define NDIS_802_11_LENGTH_RATES 8</span>
<span class="cp">#define NDIS_802_11_LENGTH_RATES_EX 16</span>

<span class="k">enum</span> <span class="n">ndis_80211_net_type</span> <span class="p">{</span>
	<span class="n">NDIS_80211_TYPE_FREQ_HOP</span><span class="p">,</span>
	<span class="n">NDIS_80211_TYPE_DIRECT_SEQ</span><span class="p">,</span>
	<span class="n">NDIS_80211_TYPE_OFDM_A</span><span class="p">,</span>
	<span class="n">NDIS_80211_TYPE_OFDM_G</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ndis_80211_net_infra</span> <span class="p">{</span>
	<span class="n">NDIS_80211_INFRA_ADHOC</span><span class="p">,</span>
	<span class="n">NDIS_80211_INFRA_INFRA</span><span class="p">,</span>
	<span class="n">NDIS_80211_INFRA_AUTO_UNKNOWN</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ndis_80211_auth_mode</span> <span class="p">{</span>
	<span class="n">NDIS_80211_AUTH_OPEN</span><span class="p">,</span>
	<span class="n">NDIS_80211_AUTH_SHARED</span><span class="p">,</span>
	<span class="n">NDIS_80211_AUTH_AUTO_SWITCH</span><span class="p">,</span>
	<span class="n">NDIS_80211_AUTH_WPA</span><span class="p">,</span>
	<span class="n">NDIS_80211_AUTH_WPA_PSK</span><span class="p">,</span>
	<span class="n">NDIS_80211_AUTH_WPA_NONE</span><span class="p">,</span>
	<span class="n">NDIS_80211_AUTH_WPA2</span><span class="p">,</span>
	<span class="n">NDIS_80211_AUTH_WPA2_PSK</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ndis_80211_encr_status</span> <span class="p">{</span>
	<span class="n">NDIS_80211_ENCR_WEP_ENABLED</span><span class="p">,</span>
	<span class="n">NDIS_80211_ENCR_DISABLED</span><span class="p">,</span>
	<span class="n">NDIS_80211_ENCR_WEP_KEY_ABSENT</span><span class="p">,</span>
	<span class="n">NDIS_80211_ENCR_NOT_SUPPORTED</span><span class="p">,</span>
	<span class="n">NDIS_80211_ENCR_TKIP_ENABLED</span><span class="p">,</span>
	<span class="n">NDIS_80211_ENCR_TKIP_KEY_ABSENT</span><span class="p">,</span>
	<span class="n">NDIS_80211_ENCR_CCMP_ENABLED</span><span class="p">,</span>
	<span class="n">NDIS_80211_ENCR_CCMP_KEY_ABSENT</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ndis_80211_priv_filter</span> <span class="p">{</span>
	<span class="n">NDIS_80211_PRIV_ACCEPT_ALL</span><span class="p">,</span>
	<span class="n">NDIS_80211_PRIV_8021X_WEP</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ndis_80211_status_type</span> <span class="p">{</span>
	<span class="n">NDIS_80211_STATUSTYPE_AUTHENTICATION</span><span class="p">,</span>
	<span class="n">NDIS_80211_STATUSTYPE_MEDIASTREAMMODE</span><span class="p">,</span>
	<span class="n">NDIS_80211_STATUSTYPE_PMKID_CANDIDATELIST</span><span class="p">,</span>
	<span class="n">NDIS_80211_STATUSTYPE_RADIOSTATE</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ndis_80211_media_stream_mode</span> <span class="p">{</span>
	<span class="n">NDIS_80211_MEDIA_STREAM_OFF</span><span class="p">,</span>
	<span class="n">NDIS_80211_MEDIA_STREAM_ON</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ndis_80211_radio_status</span> <span class="p">{</span>
	<span class="n">NDIS_80211_RADIO_STATUS_ON</span><span class="p">,</span>
	<span class="n">NDIS_80211_RADIO_STATUS_HARDWARE_OFF</span><span class="p">,</span>
	<span class="n">NDIS_80211_RADIO_STATUS_SOFTWARE_OFF</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ndis_80211_addkey_bits</span> <span class="p">{</span>
	<span class="n">NDIS_80211_ADDKEY_8021X_AUTH</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">28</span><span class="p">),</span>
	<span class="n">NDIS_80211_ADDKEY_SET_INIT_RECV_SEQ</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">29</span><span class="p">),</span>
	<span class="n">NDIS_80211_ADDKEY_PAIRWISE_KEY</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">),</span>
	<span class="n">NDIS_80211_ADDKEY_TRANSMIT_KEY</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ndis_80211_addwep_bits</span> <span class="p">{</span>
	<span class="n">NDIS_80211_ADDWEP_PERCLIENT_KEY</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">30</span><span class="p">),</span>
	<span class="n">NDIS_80211_ADDWEP_TRANSMIT_KEY</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">31</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ndis_80211_power_mode</span> <span class="p">{</span>
	<span class="n">NDIS_80211_POWER_MODE_CAM</span><span class="p">,</span>
	<span class="n">NDIS_80211_POWER_MODE_MAX_PSP</span><span class="p">,</span>
	<span class="n">NDIS_80211_POWER_MODE_FAST_PSP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">enum</span> <span class="n">ndis_80211_pmkid_cand_list_flag_bits</span> <span class="p">{</span>
	<span class="n">NDIS_80211_PMKID_CAND_PREAUTH</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ndis_80211_auth_request</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">padding</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">__le32</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_pmkid_candidate</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">padding</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">__le32</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_pmkid_cand_list</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">version</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">num_candidates</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_pmkid_candidate</span> <span class="n">candidate_list</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_status_indication</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">status_type</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="n">__le32</span>					<span class="n">media_stream_mode</span><span class="p">;</span>
		<span class="n">__le32</span>					<span class="n">radio_status</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">ndis_80211_auth_request</span>		<span class="n">auth_request</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="k">struct</span> <span class="n">ndis_80211_pmkid_cand_list</span>	<span class="n">cand_list</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_ssid</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">essid</span><span class="p">[</span><span class="n">NDIS_802_11_LENGTH_SSID</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_conf_freq_hop</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">hop_pattern</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">hop_set</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">dwell_time</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_conf</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">beacon_period</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">atim_window</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">ds_config</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_conf_freq_hop</span> <span class="n">fh_config</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_bssid_ex</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mac</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">padding</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">ndis_80211_ssid</span> <span class="n">ssid</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">privacy</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">rssi</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">net_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_conf</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">net_infra</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rates</span><span class="p">[</span><span class="n">NDIS_802_11_LENGTH_RATES_EX</span><span class="p">];</span>
	<span class="n">__le32</span> <span class="n">ie_length</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ies</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_bssid_list_ex</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">num_items</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_bssid_ex</span> <span class="n">bssid</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_fixed_ies</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">timestamp</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">__le16</span> <span class="n">beacon_interval</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">capabilities</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_wep_key</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">material</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_key</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">padding</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">rsc</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">material</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_remove_key</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">size</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">padding</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_config_param</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">name_offs</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">name_length</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">type</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">value_offs</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">value_length</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_assoc_info</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">req_ies</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">req_ie</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="n">capa</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">listen_interval</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">cur_ap_address</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">req_ie</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">req_ie_length</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">offset_req_ies</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="n">resp_ies</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resp_ie</span> <span class="p">{</span>
		<span class="n">__le16</span> <span class="n">capa</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">status_code</span><span class="p">;</span>
		<span class="n">__le16</span> <span class="n">assoc_id</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">resp_ie</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">resp_ie_length</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">offset_resp_ies</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_auth_encr_pair</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">auth_mode</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">encr_mode</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_capability</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">version</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">num_pmkids</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">num_auth_encr_pair</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_auth_encr_pair</span> <span class="n">auth_encr_pair</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_bssid_info</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">pmkid</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ndis_80211_pmkid</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">bssid_info_count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_bssid_info</span> <span class="n">bssid_info</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> *  private data</span>
<span class="cm"> */</span>
<span class="cp">#define CAP_MODE_80211A		1</span>
<span class="cp">#define CAP_MODE_80211B		2</span>
<span class="cp">#define CAP_MODE_80211G		4</span>
<span class="cp">#define CAP_MODE_MASK		7</span>

<span class="cp">#define WORK_LINK_UP		(1&lt;&lt;0)</span>
<span class="cp">#define WORK_LINK_DOWN		(1&lt;&lt;1)</span>
<span class="cp">#define WORK_SET_MULTICAST_LIST	(1&lt;&lt;2)</span>

<span class="cp">#define RNDIS_WLAN_ALG_NONE	0</span>
<span class="cp">#define RNDIS_WLAN_ALG_WEP	(1&lt;&lt;0)</span>
<span class="cp">#define RNDIS_WLAN_ALG_TKIP	(1&lt;&lt;1)</span>
<span class="cp">#define RNDIS_WLAN_ALG_CCMP	(1&lt;&lt;2)</span>

<span class="cp">#define RNDIS_WLAN_NUM_KEYS		4</span>
<span class="cp">#define RNDIS_WLAN_KEY_MGMT_NONE	0</span>
<span class="cp">#define RNDIS_WLAN_KEY_MGMT_802_1X	(1&lt;&lt;0)</span>
<span class="cp">#define RNDIS_WLAN_KEY_MGMT_PSK		(1&lt;&lt;1)</span>

<span class="cp">#define COMMAND_BUFFER_SIZE	(CONTROL_BUFFER_SIZE + sizeof(struct rndis_set))</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">rndis_channels</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2412</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2417</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2422</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2427</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2432</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2437</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2442</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2447</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2452</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2457</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2462</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2467</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2472</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">center_freq</span> <span class="o">=</span> <span class="mi">2484</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">rndis_rates</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">10</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">55</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">110</span><span class="p">,</span> <span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IEEE80211_RATE_SHORT_PREAMBLE</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">60</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">90</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">120</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">180</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">240</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">360</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">480</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">bitrate</span> <span class="o">=</span> <span class="mi">540</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">rndis_cipher_suites</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">WLAN_CIPHER_SUITE_WEP40</span><span class="p">,</span>
	<span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">,</span>
	<span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">,</span>
	<span class="n">WLAN_CIPHER_SUITE_CCMP</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rndis_wlan_encr_key</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cipher</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">material</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">bool</span> <span class="n">pairwise</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">tx_key</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* RNDIS device private data */</span>
<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">wireless_dev</span> <span class="n">wdev</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">scan_request</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">workqueue_struct</span> <span class="o">*</span><span class="n">workqueue</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">dev_poller_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">scan_work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">work_struct</span> <span class="n">work</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span> <span class="n">command_lock</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">work_pending</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_qual</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">cqm_rssi_thold</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cqm_rssi_hyst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_cqm_event_rssi</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">ieee80211_supported_band</span> <span class="n">band</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="n">channels</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rndis_channels</span><span class="p">)];</span>
	<span class="k">struct</span> <span class="n">ieee80211_rate</span> <span class="n">rates</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rndis_rates</span><span class="p">)];</span>
	<span class="n">u32</span> <span class="n">cipher_suites</span><span class="p">[</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rndis_cipher_suites</span><span class="p">)];</span>

	<span class="kt">int</span> <span class="n">device_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">caps</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">multicast_size</span><span class="p">;</span>

	<span class="cm">/* module parameters */</span>
	<span class="kt">char</span> <span class="n">param_country</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span>  <span class="n">param_frameburst</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">param_afterburner</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">param_power_save</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">param_power_output</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">param_roamtrigger</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">param_roamdelta</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">param_workaround_interval</span><span class="p">;</span>

	<span class="cm">/* hardware state */</span>
	<span class="n">bool</span> <span class="n">radio_on</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">power_mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">infra_mode</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">connected</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">current_command_oid</span><span class="p">;</span>

	<span class="cm">/* encryption stuff */</span>
	<span class="n">u8</span> <span class="n">encr_tx_key_index</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_encr_key</span> <span class="n">encr_keys</span><span class="p">[</span><span class="n">RNDIS_WLAN_NUM_KEYS</span><span class="p">];</span>
	<span class="kt">int</span>  <span class="n">wpa_version</span><span class="p">;</span>

	<span class="n">u8</span> <span class="n">command_buffer</span><span class="p">[</span><span class="n">COMMAND_BUFFER_SIZE</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * cfg80211 ops</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_change_virtual_intf</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">vif_params</span> <span class="o">*</span><span class="n">params</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">request</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_set_wiphy_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_set_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">nl80211_tx_power_setting</span> <span class="n">type</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">mbm</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_get_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dbm</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cfg80211_connect_params</span> <span class="o">*</span><span class="n">sme</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">u16</span> <span class="n">reason_code</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_join_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">cfg80211_ibss_params</span> <span class="o">*</span><span class="n">params</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_leave_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_add_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">key_params</span> <span class="o">*</span><span class="n">params</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_del_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_set_default_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">unicast</span><span class="p">,</span> <span class="n">bool</span> <span class="n">multicast</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_get_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">station_info</span> <span class="o">*</span><span class="n">sinfo</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_dump_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">station_info</span> <span class="o">*</span><span class="n">sinfo</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_set_pmksa</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cfg80211_pmksa</span> <span class="o">*</span><span class="n">pmksa</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_del_pmksa</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cfg80211_pmksa</span> <span class="o">*</span><span class="n">pmksa</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_flush_pmksa</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_set_power_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">enabled</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_set_cqm_rssi_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">s32</span> <span class="n">rssi_thold</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rssi_hyst</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">cfg80211_ops</span> <span class="n">rndis_config_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">change_virtual_intf</span> <span class="o">=</span> <span class="n">rndis_change_virtual_intf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">scan</span> <span class="o">=</span> <span class="n">rndis_scan</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_wiphy_params</span> <span class="o">=</span> <span class="n">rndis_set_wiphy_params</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_tx_power</span> <span class="o">=</span> <span class="n">rndis_set_tx_power</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_tx_power</span> <span class="o">=</span> <span class="n">rndis_get_tx_power</span><span class="p">,</span>
	<span class="p">.</span><span class="n">connect</span> <span class="o">=</span> <span class="n">rndis_connect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span> <span class="n">rndis_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">join_ibss</span> <span class="o">=</span> <span class="n">rndis_join_ibss</span><span class="p">,</span>
	<span class="p">.</span><span class="n">leave_ibss</span> <span class="o">=</span> <span class="n">rndis_leave_ibss</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_key</span> <span class="o">=</span> <span class="n">rndis_add_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_key</span> <span class="o">=</span> <span class="n">rndis_del_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_default_key</span> <span class="o">=</span> <span class="n">rndis_set_default_key</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_station</span> <span class="o">=</span> <span class="n">rndis_get_station</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dump_station</span> <span class="o">=</span> <span class="n">rndis_dump_station</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_pmksa</span> <span class="o">=</span> <span class="n">rndis_set_pmksa</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_pmksa</span> <span class="o">=</span> <span class="n">rndis_del_pmksa</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flush_pmksa</span> <span class="o">=</span> <span class="n">rndis_flush_pmksa</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_power_mgmt</span> <span class="o">=</span> <span class="n">rndis_set_power_mgmt</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_cqm_rssi_config</span> <span class="o">=</span> <span class="n">rndis_set_cqm_rssi_config</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">rndis_wiphy_privid</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rndis_wiphy_privid</span><span class="p">;</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="nf">get_rndis_wlan_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver_priv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">get_bcm4320_power_dbm</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_power_output</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">return</span> <span class="n">BCM4320_DEFAULT_TXPOWER_DBM_100</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">return</span> <span class="n">BCM4320_DEFAULT_TXPOWER_DBM_75</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="k">return</span> <span class="n">BCM4320_DEFAULT_TXPOWER_DBM_50</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">return</span> <span class="n">BCM4320_DEFAULT_TXPOWER_DBM_25</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_wpa_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cipher</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">cipher</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span> <span class="o">||</span>
		<span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_cipher_to_alg</span><span class="p">(</span><span class="n">u32</span> <span class="n">cipher</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">RNDIS_WLAN_ALG_NONE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="k">return</span> <span class="n">RNDIS_WLAN_ALG_WEP</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
		<span class="k">return</span> <span class="n">RNDIS_WLAN_ALG_TKIP</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="k">return</span> <span class="n">RNDIS_WLAN_ALG_CCMP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_akm_suite_to_key_mgmt</span><span class="p">(</span><span class="n">u32</span> <span class="n">akm_suite</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">akm_suite</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">RNDIS_WLAN_KEY_MGMT_NONE</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_AKM_SUITE_8021X</span>:
		<span class="k">return</span> <span class="n">RNDIS_WLAN_KEY_MGMT_802_1X</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WLAN_AKM_SUITE_PSK</span>:
		<span class="k">return</span> <span class="n">RNDIS_WLAN_KEY_MGMT_PSK</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">oid_to_string</span><span class="p">(</span><span class="n">u32</span> <span class="n">oid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">oid</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#define OID_STR(oid) case oid: return(#oid)</span>
		<span class="cm">/* from rndis_host.h */</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_3_PERMANENT_ADDRESS</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_GEN_MAXIMUM_FRAME_SIZE</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_GEN_CURRENT_PACKET_FILTER</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_GEN_PHYSICAL_MEDIUM</span><span class="p">);</span>

		<span class="cm">/* from rndis_wlan.c */</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_GEN_LINK_SPEED</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_GEN_RNDIS_CONFIG_PARAMETER</span><span class="p">);</span>

		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_GEN_XMIT_OK</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_GEN_RCV_OK</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_GEN_XMIT_ERROR</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_GEN_RCV_ERROR</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_GEN_RCV_NO_BUFFER</span><span class="p">);</span>

		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_3_CURRENT_ADDRESS</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_3_MULTICAST_LIST</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_3_MAXIMUM_LIST_SIZE</span><span class="p">);</span>

		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_BSSID</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_SSID</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_INFRASTRUCTURE_MODE</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_ADD_WEP</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_REMOVE_WEP</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_DISASSOCIATE</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_AUTHENTICATION_MODE</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_PRIVACY_FILTER</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_BSSID_LIST_SCAN</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_ENCRYPTION_STATUS</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_ADD_KEY</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_REMOVE_KEY</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_ASSOCIATION_INFORMATION</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_CAPABILITY</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_PMKID</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_NETWORK_TYPES_SUPPORTED</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_NETWORK_TYPE_IN_USE</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_TX_POWER_LEVEL</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_RSSI</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_RSSI_TRIGGER</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_FRAGMENTATION_THRESHOLD</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_RTS_THRESHOLD</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_SUPPORTED_RATES</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_CONFIGURATION</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_POWER_MODE</span><span class="p">);</span>
		<span class="n">OID_STR</span><span class="p">(</span><span class="n">RNDIS_OID_802_11_BSSID_LIST</span><span class="p">);</span>
<span class="cp">#undef OID_STR</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="s">&quot;?&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="nf">oid_to_string</span><span class="p">(</span><span class="n">u32</span> <span class="n">oid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="s">&quot;?&quot;</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* translate error code */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_error_status</span><span class="p">(</span><span class="n">__le32</span> <span class="n">rndis_status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rndis_status</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RNDIS_STATUS_SUCCESS</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RNDIS_STATUS_FAILURE</span>:
	<span class="k">case</span> <span class="n">RNDIS_STATUS_INVALID_DATA</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RNDIS_STATUS_NOT_SUPPORTED</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RNDIS_STATUS_ADAPTER_NOT_READY</span>:
	<span class="k">case</span> <span class="n">RNDIS_STATUS_ADAPTER_NOT_OPEN</span>:
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_query_oid</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">oid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">void</span>			<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_msg_hdr</span>	<span class="o">*</span><span class="n">header</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_query</span>	<span class="o">*</span><span class="n">get</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_query_c</span>	<span class="o">*</span><span class="n">get_c</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">buflen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">resplen</span><span class="p">,</span> <span class="n">respoffs</span><span class="p">,</span> <span class="n">copylen</span><span class="p">;</span>

	<span class="n">buflen</span> <span class="o">=</span> <span class="o">*</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">)</span>
		<span class="n">buflen</span> <span class="o">=</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="n">COMMAND_BUFFER_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buflen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">u</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_buffer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_lock</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_MSG_QUERY</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">get</span><span class="o">-&gt;</span><span class="n">oid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">oid</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_command_oid</span> <span class="o">=</span> <span class="n">oid</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">header</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_command_oid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(%s): rndis_command() failed, %d (%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">oid_to_string</span><span class="p">(</span><span class="n">oid</span><span class="p">),</span> <span class="n">ret</span><span class="p">,</span>
			   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">get_c</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">resplen</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">get_c</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">respoffs</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">get_c</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">respoffs</span> <span class="o">&gt;</span> <span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Device returned data offset outside buffer, error. */</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(%s): received invalid &quot;</span>
				<span class="s">&quot;data offset: %d &gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">oid_to_string</span><span class="p">(</span><span class="n">oid</span><span class="p">),</span> <span class="n">respoffs</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>

			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_unlock</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">resplen</span> <span class="o">+</span> <span class="n">respoffs</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Device would have returned more data if buffer would</span>
<span class="cm">			 * have been big enough. Copy just the bits that we got.</span>
<span class="cm">			 */</span>
			<span class="n">copylen</span> <span class="o">=</span> <span class="n">buflen</span> <span class="o">-</span> <span class="n">respoffs</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">copylen</span> <span class="o">=</span> <span class="n">resplen</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copylen</span> <span class="o">&gt;</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
			<span class="n">copylen</span> <span class="o">=</span> <span class="o">*</span><span class="n">len</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="n">respoffs</span><span class="p">,</span> <span class="n">copylen</span><span class="p">);</span>

		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="n">resplen</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_error_status</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">get_c</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(%s): device returned error,  0x%08x (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">oid_to_string</span><span class="p">(</span><span class="n">oid</span><span class="p">),</span>
				   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">get_c</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">exit_unlock:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">buf</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_buffer</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_set_oid</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">oid</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="kt">void</span>			<span class="o">*</span><span class="n">buf</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_msg_hdr</span>	<span class="o">*</span><span class="n">header</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_set</span>	<span class="o">*</span><span class="n">set</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">rndis_set_c</span>	<span class="o">*</span><span class="n">set_c</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">buflen</span><span class="p">;</span>

	<span class="n">buflen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&lt;</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">)</span>
		<span class="n">buflen</span> <span class="o">=</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;</span> <span class="n">COMMAND_BUFFER_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">buflen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">u</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">u</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_buffer</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_lock</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_MSG_SET</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">)</span> <span class="o">+</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">oid</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">oid</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">)</span> <span class="o">-</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">buf</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">u</span><span class="p">.</span><span class="n">set</span><span class="p">),</span> <span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_command_oid</span> <span class="o">=</span> <span class="n">oid</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_command</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">u</span><span class="p">.</span><span class="n">header</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_command_oid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(%s): rndis_command() failed, %d (%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">oid_to_string</span><span class="p">(</span><span class="n">oid</span><span class="p">),</span> <span class="n">ret</span><span class="p">,</span>
			   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">set_c</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_error_status</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">set_c</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(%s): device returned error, 0x%08x (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">,</span> <span class="n">oid_to_string</span><span class="p">(</span><span class="n">oid</span><span class="p">),</span>
				   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">set_c</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">buf</span> <span class="o">!=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_buffer</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_reset</span> <span class="o">*</span><span class="n">reset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_lock</span><span class="p">);</span>

	<span class="n">reset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_buffer</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">reset</span><span class="p">));</span>
	<span class="n">reset</span><span class="o">-&gt;</span><span class="n">msg_type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_MSG_RESET</span><span class="p">);</span>
	<span class="n">reset</span><span class="o">-&gt;</span><span class="n">msg_len</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">reset</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_command_oid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_command</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">reset</span><span class="p">,</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Specs say that we can only set config parameters only soon after device</span>
<span class="cm"> * initialization.</span>
<span class="cm"> *   value_type: 0 = u32, 2 = unicode string</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_set_config_parameter</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">value_type</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ndis_config_param</span> <span class="o">*</span><span class="n">infobuf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">value_len</span><span class="p">,</span> <span class="n">info_len</span><span class="p">,</span> <span class="n">param_len</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">__le16</span> <span class="o">*</span><span class="n">unibuf</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">dst_value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value_type</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">value_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le32</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">value_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">value_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le16</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">param_len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">param</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le16</span><span class="p">);</span>
	<span class="n">info_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">infobuf</span><span class="p">)</span> <span class="o">+</span> <span class="n">param_len</span> <span class="o">+</span> <span class="n">value_len</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">info_len</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">infobuf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">info_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">infobuf</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">info_len</span> <span class="o">-=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="cm">/* extra 12 bytes are for padding (debug output) */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">infobuf</span><span class="p">,</span> <span class="mh">0xCC</span><span class="p">,</span> <span class="n">info_len</span> <span class="o">+</span> <span class="mi">12</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;setting config parameter: %s, value: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">param</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;setting config parameter: %s, value: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">param</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">value</span><span class="p">);</span>

	<span class="n">infobuf</span><span class="o">-&gt;</span><span class="n">name_offs</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">infobuf</span><span class="p">));</span>
	<span class="n">infobuf</span><span class="o">-&gt;</span><span class="n">name_length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">param_len</span><span class="p">);</span>
	<span class="n">infobuf</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">value_type</span><span class="p">);</span>
	<span class="n">infobuf</span><span class="o">-&gt;</span><span class="n">value_offs</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">infobuf</span><span class="p">)</span> <span class="o">+</span> <span class="n">param_len</span><span class="p">);</span>
	<span class="n">infobuf</span><span class="o">-&gt;</span><span class="n">value_length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">value_len</span><span class="p">);</span>

	<span class="cm">/* simple string to unicode string conversion */</span>
	<span class="n">unibuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">infobuf</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">infobuf</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">param_len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le16</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">unibuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">param</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">unibuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">infobuf</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">infobuf</span><span class="p">)</span> <span class="o">+</span> <span class="n">param_len</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">value_len</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__le16</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">unibuf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">value</span><span class="p">)[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dst_value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">infobuf</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">infobuf</span><span class="p">)</span> <span class="o">+</span> <span class="n">param_len</span><span class="p">;</span>
		<span class="o">*</span><span class="n">dst_value</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;info buffer (len: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info_len</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">info_len</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">12</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">infobuf</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%08X:%08X:%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
			   <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
			   <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]));</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RNDIS_OID_GEN_RNDIS_CONFIG_PARAMETER</span><span class="p">,</span>
							<span class="n">infobuf</span><span class="p">,</span> <span class="n">info_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;setting rndis config parameter failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ret</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">infobuf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_set_config_parameter_str</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="kt">char</span> <span class="o">*</span><span class="n">param</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rndis_set_config_parameter</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * data conversion functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">level_to_qual</span><span class="p">(</span><span class="kt">int</span> <span class="n">level</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">qual</span> <span class="o">=</span> <span class="mi">100</span> <span class="o">*</span> <span class="p">(</span><span class="n">level</span> <span class="o">-</span> <span class="n">WL_NOISE</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">WL_SIGMAX</span> <span class="o">-</span> <span class="n">WL_NOISE</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">qual</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span><span class="n">qual</span> <span class="o">&lt;=</span> <span class="mi">100</span> <span class="o">?</span> <span class="n">qual</span> <span class="o">:</span> <span class="mi">100</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * common functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">set_infra_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">restore_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rndis_check_bssid_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">match_bssid</span><span class="p">,</span>
					<span class="n">bool</span> <span class="o">*</span><span class="n">matched</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_start_bssid_list_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* Note: RNDIS_OID_802_11_BSSID_LIST_SCAN clears internal BSS list. */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_802_11_BSSID_LIST_SCAN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_essid</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ndis_80211_ssid</span> <span class="o">*</span><span class="n">ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_802_11_SSID</span><span class="p">,</span>
			    <span class="n">ssid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ssid</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;setting SSID failed (%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): radio_on = true</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_802_11_BSSID</span><span class="p">,</span>
			    <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;setting BSSID[%pM] failed (%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">bssid</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">clear_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">broadcast_mac</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span>
	<span class="p">};</span>

	<span class="k">return</span> <span class="n">set_bssid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">broadcast_mac</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_bssid</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">ETH_ALEN</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_802_11_BSSID</span><span class="p">,</span>
			      <span class="n">bssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_association_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">ndis_80211_assoc_info</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
			<span class="n">RNDIS_OID_802_11_ASSOCIATION_INFORMATION</span><span class="p">,</span>
			<span class="n">info</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">is_associated</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_bssid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">bssid</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">disassociate</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">reset_ssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ndis_80211_ssid</span> <span class="n">ssid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
				<span class="n">RNDIS_OID_802_11_DISASSOCIATE</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): radio_on = false</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">reset_ssid</span><span class="p">)</span>
				<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* disassociate causes radio to be turned off; if reset_ssid</span>
<span class="cm">	 * is given, set random ssid to enable radio */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reset_ssid</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Set device to infrastructure mode so we don&#39;t get ad-hoc</span>
<span class="cm">		 * &#39;media connect&#39; indications with the random ssid.</span>
<span class="cm">		 */</span>
		<span class="n">set_infra_mode</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">NDIS_80211_INFRA_INFRA</span><span class="p">);</span>

		<span class="n">ssid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">));</span>
		<span class="n">get_random_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">)</span><span class="o">-</span><span class="mi">2</span><span class="p">);</span>
		<span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x1</span> <span class="o">+</span> <span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="mh">0xfe</span> <span class="o">/</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_essid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_auth_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">wpa_version</span><span class="p">,</span>
				<span class="k">enum</span> <span class="n">nl80211_auth_type</span> <span class="n">auth_type</span><span class="p">,</span> <span class="kt">int</span> <span class="n">keymgmt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">auth_mode</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): wpa_version=0x%x authalg=0x%x keymgmt=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">wpa_version</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">,</span> <span class="n">keymgmt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wpa_version</span> <span class="o">&amp;</span> <span class="n">NL80211_WPA_VERSION_2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">keymgmt</span> <span class="o">&amp;</span> <span class="n">RNDIS_WLAN_KEY_MGMT_802_1X</span><span class="p">)</span>
			<span class="n">auth_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_AUTH_WPA2</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">auth_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_AUTH_WPA2_PSK</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">wpa_version</span> <span class="o">&amp;</span> <span class="n">NL80211_WPA_VERSION_1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">keymgmt</span> <span class="o">&amp;</span> <span class="n">RNDIS_WLAN_KEY_MGMT_802_1X</span><span class="p">)</span>
			<span class="n">auth_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_AUTH_WPA</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">keymgmt</span> <span class="o">&amp;</span> <span class="n">RNDIS_WLAN_KEY_MGMT_PSK</span><span class="p">)</span>
			<span class="n">auth_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_AUTH_WPA_PSK</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">auth_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_AUTH_WPA_NONE</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">auth_type</span> <span class="o">==</span> <span class="n">NL80211_AUTHTYPE_SHARED_KEY</span><span class="p">)</span>
		<span class="n">auth_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_AUTH_SHARED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">auth_type</span> <span class="o">==</span> <span class="n">NL80211_AUTHTYPE_OPEN_SYSTEM</span><span class="p">)</span>
		<span class="n">auth_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_AUTH_OPEN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">auth_type</span> <span class="o">==</span> <span class="n">NL80211_AUTHTYPE_AUTOMATIC</span><span class="p">)</span>
		<span class="n">auth_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_AUTH_AUTO_SWITCH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">auth_mode</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
			    <span class="n">RNDIS_OID_802_11_AUTHENTICATION_MODE</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;setting auth mode failed (%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_version</span> <span class="o">=</span> <span class="n">wpa_version</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_priv_filter</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): wpa_version=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_version</span> <span class="o">&amp;</span> <span class="n">NL80211_WPA_VERSION_2</span> <span class="o">||</span>
	    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wpa_version</span> <span class="o">&amp;</span> <span class="n">NL80211_WPA_VERSION_1</span><span class="p">)</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NDIS_80211_PRIV_8021X_WEP</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">NDIS_80211_PRIV_ACCEPT_ALL</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
			     <span class="n">RNDIS_OID_802_11_PRIVACY_FILTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span>
			     <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_encr_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">pairwise</span><span class="p">,</span> <span class="kt">int</span> <span class="n">groupwise</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">encr_mode</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): cipher_pair=0x%x cipher_group=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">pairwise</span><span class="p">,</span> <span class="n">groupwise</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pairwise</span> <span class="o">&amp;</span> <span class="n">RNDIS_WLAN_ALG_CCMP</span><span class="p">)</span>
		<span class="n">encr_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_ENCR_CCMP_ENABLED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pairwise</span> <span class="o">&amp;</span> <span class="n">RNDIS_WLAN_ALG_TKIP</span><span class="p">)</span>
		<span class="n">encr_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_ENCR_TKIP_ENABLED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pairwise</span> <span class="o">&amp;</span> <span class="n">RNDIS_WLAN_ALG_WEP</span><span class="p">)</span>
		<span class="n">encr_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_ENCR_WEP_ENABLED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">groupwise</span> <span class="o">&amp;</span> <span class="n">RNDIS_WLAN_ALG_CCMP</span><span class="p">)</span>
		<span class="n">encr_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_ENCR_CCMP_ENABLED</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">groupwise</span> <span class="o">&amp;</span> <span class="n">RNDIS_WLAN_ALG_TKIP</span><span class="p">)</span>
		<span class="n">encr_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_ENCR_TKIP_ENABLED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">encr_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_ENCR_DISABLED</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">encr_mode</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
			<span class="n">RNDIS_OID_802_11_ENCRYPTION_STATUS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;setting encr mode failed (%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_infra_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="n">__le32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): infra_mode=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">infra_mode</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
			    <span class="n">RNDIS_OID_802_11_INFRASTRUCTURE_MODE</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;setting infra mode failed (%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* NDIS drivers clear keys when infrastructure mode is</span>
<span class="cm">	 * changed. But Linux tools assume otherwise. So set the</span>
<span class="cm">	 * keys */</span>
	<span class="n">restore_keys</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">infra_mode</span> <span class="o">=</span> <span class="n">mode</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_rts_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rts_threshold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">rts_threshold</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rts_threshold</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rts_threshold</span> <span class="o">&gt;</span> <span class="mi">2347</span><span class="p">)</span>
		<span class="n">rts_threshold</span> <span class="o">=</span> <span class="mi">2347</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">rts_threshold</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
			     <span class="n">RNDIS_OID_802_11_RTS_THRESHOLD</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_frag_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">u32</span> <span class="n">frag_threshold</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">frag_threshold</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frag_threshold</span> <span class="o">&lt;</span> <span class="mi">256</span> <span class="o">||</span> <span class="n">frag_threshold</span> <span class="o">&gt;</span> <span class="mi">2346</span><span class="p">)</span>
		<span class="n">frag_threshold</span> <span class="o">=</span> <span class="mi">2346</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">frag_threshold</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
			<span class="n">RNDIS_OID_802_11_FRAGMENTATION_THRESHOLD</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_default_iw_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_infra_mode</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">NDIS_80211_INFRA_INFRA</span><span class="p">);</span>
	<span class="n">set_auth_mode</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">NL80211_AUTHTYPE_OPEN_SYSTEM</span><span class="p">,</span>
						<span class="n">RNDIS_WLAN_KEY_MGMT_NONE</span><span class="p">);</span>
	<span class="n">set_priv_filter</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="n">set_encr_mode</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_WLAN_ALG_NONE</span><span class="p">,</span> <span class="n">RNDIS_WLAN_ALG_NONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">deauthenticate</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">disassociate</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
	<span class="n">set_default_iw_params</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ndis_80211_conf</span> <span class="n">config</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dsconfig</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">channel</span><span class="p">);</span>

	<span class="cm">/* this OID is valid only when not associated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_associated</span><span class="p">(</span><span class="n">usbdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dsconfig</span> <span class="o">=</span> <span class="n">ieee80211_dsss_chan_to_freq</span><span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
			<span class="n">RNDIS_OID_802_11_CONFIGURATION</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): querying configuration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">config</span><span class="p">.</span><span class="n">ds_config</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dsconfig</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
			<span class="n">RNDIS_OID_802_11_CONFIGURATION</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="p">));</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): %d -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="nf">get_current_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span>
						     <span class="n">u32</span> <span class="o">*</span><span class="n">beacon_period</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_conf</span> <span class="n">config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Get channel and beacon interval */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
			<span class="n">RNDIS_OID_802_11_CONFIGURATION</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): RNDIS_OID_802_11_CONFIGURATION -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">channel</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span>
				<span class="n">KHZ_TO_MHZ</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">ds_config</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">beacon_period</span><span class="p">)</span>
		<span class="o">*</span><span class="n">beacon_period</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">beacon_period</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">channel</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* index must be 0 - N, as per NDIS  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_wep_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key_len</span><span class="p">,</span>
								<span class="n">u8</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ndis_80211_wep_key</span> <span class="n">ndis_key</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">cipher</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(idx: %d, len: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">RNDIS_WLAN_NUM_KEYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_len</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span>
		<span class="n">cipher</span> <span class="o">=</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">key_len</span> <span class="o">==</span> <span class="mi">13</span><span class="p">)</span>
		<span class="n">cipher</span> <span class="o">=</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndis_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">));</span>

	<span class="n">ndis_key</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">));</span>
	<span class="n">ndis_key</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">key_len</span><span class="p">);</span>
	<span class="n">ndis_key</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndis_key</span><span class="p">.</span><span class="n">material</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_tx_key_index</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ndis_key</span><span class="p">.</span><span class="n">index</span> <span class="o">|=</span> <span class="n">NDIS_80211_ADDWEP_TRANSMIT_KEY</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_encr_mode</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_WLAN_ALG_WEP</span><span class="p">,</span>
							<span class="n">RNDIS_WLAN_ALG_NONE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;encryption couldn&#39;t be enabled (%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
			<span class="n">RNDIS_OID_802_11_ADD_WEP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ndis_key</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;adding encryption key %d failed (%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">key_len</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">material</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">bssid</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_wpa_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">int</span> <span class="n">key_len</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">rx_seq</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">seq_len</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cipher</span><span class="p">,</span> <span class="n">__le32</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ndis_80211_key</span> <span class="n">ndis_key</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_addr_ok</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">RNDIS_WLAN_NUM_KEYS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): index out of range (%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">.</span><span class="n">material</span><span class="p">)</span> <span class="o">||</span> <span class="n">key_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): key length out of range (%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NDIS_80211_ADDKEY_SET_INIT_RECV_SEQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_seq</span> <span class="o">||</span> <span class="n">seq_len</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): recv seq flag without buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_seq</span> <span class="o">&amp;&amp;</span> <span class="n">seq_len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">.</span><span class="n">rsc</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): too big recv seq buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">is_addr_ok</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="o">!</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NDIS_80211_ADDKEY_PAIRWISE_KEY</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_addr_ok</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): pairwise but bssid invalid (%pM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(%i): flags:%i%i%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
		   <span class="o">!!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NDIS_80211_ADDKEY_TRANSMIT_KEY</span><span class="p">),</span>
		   <span class="o">!!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NDIS_80211_ADDKEY_PAIRWISE_KEY</span><span class="p">),</span>
		   <span class="o">!!</span><span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NDIS_80211_ADDKEY_SET_INIT_RECV_SEQ</span><span class="p">));</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ndis_key</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">));</span>

	<span class="n">ndis_key</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">)</span> <span class="o">-</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">.</span><span class="n">material</span><span class="p">)</span> <span class="o">+</span> <span class="n">key_len</span><span class="p">);</span>
	<span class="n">ndis_key</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">key_len</span><span class="p">);</span>
	<span class="n">ndis_key</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">|</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cipher</span> <span class="o">==</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span> <span class="o">&amp;&amp;</span> <span class="n">key_len</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* wpa_supplicant gives us the Michael MIC RX/TX keys in</span>
<span class="cm">		 * different order than NDIS spec, so swap the order here. */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">.</span><span class="n">material</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">.</span><span class="n">material</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">.</span><span class="n">material</span> <span class="o">+</span> <span class="mi">24</span><span class="p">,</span> <span class="n">key</span> <span class="o">+</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">.</span><span class="n">material</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NDIS_80211_ADDKEY_SET_INIT_RECV_SEQ</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">.</span><span class="n">rsc</span><span class="p">,</span> <span class="n">rx_seq</span><span class="p">,</span> <span class="n">seq_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NDIS_80211_ADDKEY_PAIRWISE_KEY</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* pairwise key */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* group key */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">infra_mode</span> <span class="o">==</span> <span class="n">NDIS_80211_INFRA_ADHOC</span><span class="p">)</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">get_bssid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">ndis_key</span><span class="p">.</span><span class="n">bssid</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
			<span class="n">RNDIS_OID_802_11_ADD_KEY</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ndis_key</span><span class="p">,</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ndis_key</span><span class="p">.</span><span class="n">size</span><span class="p">));</span>
	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): RNDIS_OID_802_11_ADD_KEY -&gt; %08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">index</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">index</span><span class="p">]));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">len</span> <span class="o">=</span> <span class="n">key_len</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">cipher</span> <span class="o">=</span> <span class="n">cipher</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">material</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">key_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NDIS_80211_ADDKEY_PAIRWISE_KEY</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ndis_key</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">bssid</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NDIS_80211_ADDKEY_TRANSMIT_KEY</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_tx_key_index</span> <span class="o">=</span> <span class="n">index</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">restore_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">key_idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_encr_key</span> <span class="n">key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_wpa_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">key_idx</span><span class="p">];</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): %i:%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">add_wep_key</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">material</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">key_idx</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">restore_keys</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">restore_key</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">clear_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="n">idx</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">idx</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">idx</span><span class="p">]));</span>
<span class="p">}</span>

<span class="cm">/* remove_key is for both wep and wpa */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">remove_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">index</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ndis_80211_remove_key</span> <span class="n">remove_key</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">keyindex</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_wpa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">RNDIS_WLAN_NUM_KEYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">is_wpa</span> <span class="o">=</span> <span class="n">is_wpa_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): %i:%s:%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">is_wpa</span> <span class="o">?</span> <span class="s">&quot;wpa&quot;</span> <span class="o">:</span> <span class="s">&quot;wep&quot;</span><span class="p">,</span>
		   <span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">len</span><span class="p">);</span>

	<span class="n">clear_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_wpa</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">remove_key</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">remove_key</span><span class="p">));</span>
		<span class="n">remove_key</span><span class="p">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bssid</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* pairwise key */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">bssid</span><span class="p">))</span>
				<span class="n">remove_key</span><span class="p">.</span><span class="n">index</span> <span class="o">|=</span>
					<span class="n">NDIS_80211_ADDKEY_PAIRWISE_KEY</span><span class="p">;</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">remove_key</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="n">remove_key</span><span class="p">.</span><span class="n">bssid</span><span class="p">));</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">memset</span><span class="p">(</span><span class="n">remove_key</span><span class="p">.</span><span class="n">bssid</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">remove_key</span><span class="p">.</span><span class="n">bssid</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
				<span class="n">RNDIS_OID_802_11_REMOVE_KEY</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">remove_key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">remove_key</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">keyindex</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
				<span class="n">RNDIS_OID_802_11_REMOVE_WEP</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">keyindex</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">keyindex</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
				    <span class="s">&quot;removing encryption key %d failed (%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">index</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* if it is transmit key, disable encryption */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_tx_key_index</span><span class="p">)</span>
		<span class="n">set_encr_mode</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_WLAN_ALG_NONE</span><span class="p">,</span> <span class="n">RNDIS_WLAN_ALG_NONE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">filter</span><span class="p">,</span> <span class="n">basefilter</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">mc_addrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mc_count</span><span class="p">;</span>

	<span class="n">basefilter</span> <span class="o">=</span> <span class="n">filter</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_PACKET_TYPE_DIRECTED</span> <span class="o">|</span>
					  <span class="n">RNDIS_PACKET_TYPE_BROADCAST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">filter</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_PACKET_TYPE_PROMISCUOUS</span> <span class="o">|</span>
				      <span class="n">RNDIS_PACKET_TYPE_ALL_LOCAL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">filter</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_PACKET_TYPE_ALL_MULTICAST</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">!=</span> <span class="n">basefilter</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">set_filter</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * mc_list should be accessed holding the lock, so copy addresses to</span>
<span class="cm">	 * local buffer first.</span>
<span class="cm">	 */</span>
	<span class="n">netif_addr_lock_bh</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="n">mc_count</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mc_count</span> <span class="o">&gt;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">multicast_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">filter</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_PACKET_TYPE_ALL_MULTICAST</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mc_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mc_addrs</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">mc_count</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">mc_addrs</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
				    <span class="s">&quot;couldn&#39;t alloc %d bytes of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">mc_count</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
			<span class="n">netif_addr_unlock_bh</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">mc_addrs</span> <span class="o">+</span> <span class="n">i</span><span class="o">++</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">,</span>
			       <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">netif_addr_unlock_bh</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">filter</span> <span class="o">!=</span> <span class="n">basefilter</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">set_filter</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mc_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
				<span class="n">RNDIS_OID_802_3_MULTICAST_LIST</span><span class="p">,</span>
				<span class="n">mc_addrs</span><span class="p">,</span> <span class="n">mc_count</span> <span class="o">*</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">mc_addrs</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">filter</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_PACKET_TYPE_MULTICAST</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">filter</span> <span class="o">|=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_PACKET_TYPE_ALL_MULTICAST</span><span class="p">);</span>

		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;RNDIS_OID_802_3_MULTICAST_LIST(%d, max: %d) -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">mc_count</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">multicast_size</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">set_filter:</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_GEN_CURRENT_PACKET_FILTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">filter</span><span class="p">,</span>
							<span class="k">sizeof</span><span class="p">(</span><span class="n">filter</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;couldn&#39;t set packet filter: %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">filter</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;RNDIS_OID_GEN_CURRENT_PACKET_FILTER(%08x) -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">filter</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">debug_print_pmkids</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ndis_80211_pmkid</span> <span class="o">*</span><span class="n">pmkids</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func_str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">max_pmkids</span><span class="p">,</span> <span class="n">entry_len</span><span class="p">;</span>

	<span class="n">max_pmkids</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_num_pmkids</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info_count</span><span class="p">);</span>

	<span class="n">entry_len</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmkids</span><span class="p">))</span> <span class="o">/</span> <span class="n">count</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): %d PMKIDs (data len: %d, entry len: &quot;</span>
				<span class="s">&quot;%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">func_str</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">entry_len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">max_pmkids</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">max_pmkids</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pmkid</span><span class="p">;</span>

		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s():  bssid: %pM, &quot;</span>
				<span class="s">&quot;pmkid: %08X:%08X:%08X:%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">func_str</span><span class="p">,</span> <span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bssid</span><span class="p">,</span>
				<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
				<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">debug_print_pmkids</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ndis_80211_pmkid</span> <span class="o">*</span><span class="n">pmkids</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func_str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ndis_80211_pmkid</span> <span class="o">*</span><span class="nf">get_device_pmkids</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ndis_80211_pmkid</span> <span class="o">*</span><span class="n">pmkids</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">max_pmkids</span><span class="p">;</span>

	<span class="n">max_pmkids</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_num_pmkids</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmkids</span><span class="p">)</span> <span class="o">+</span> <span class="n">max_pmkids</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">pmkids</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmkids</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">max_pmkids</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_802_11_PMKID</span><span class="p">,</span>
			<span class="n">pmkids</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): RNDIS_OID_802_11_PMKID(%d, %d)&quot;</span>
				<span class="s">&quot; -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">max_pmkids</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">pmkids</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">max_pmkids</span><span class="p">)</span>
		<span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">max_pmkids</span><span class="p">);</span>

	<span class="n">debug_print_pmkids</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">pmkids</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pmkids</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">set_device_pmkids</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ndis_80211_pmkid</span> <span class="o">*</span><span class="n">pmkids</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">num_pmkids</span><span class="p">;</span>

	<span class="n">num_pmkids</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info_count</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmkids</span><span class="p">)</span> <span class="o">+</span> <span class="n">num_pmkids</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>

	<span class="n">debug_print_pmkids</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">pmkids</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_802_11_PMKID</span><span class="p">,</span> <span class="n">pmkids</span><span class="p">,</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): RNDIS_OID_802_11_PMKID(%d, %d) -&gt; %d&quot;</span>
				<span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">num_pmkids</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">pmkids</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ndis_80211_pmkid</span> <span class="o">*</span><span class="nf">remove_pmkid</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ndis_80211_pmkid</span> <span class="o">*</span><span class="n">pmkids</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">cfg80211_pmksa</span> <span class="o">*</span><span class="n">pmksa</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">max_pmkids</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">newlen</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">max_pmkids</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">max_pmkids</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bssid</span><span class="p">,</span>
				     <span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* pmkid not found */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): bssid not found (%pM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>

	<span class="n">count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">newlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmkids</span><span class="p">)</span> <span class="o">+</span> <span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">newlen</span><span class="p">);</span>
	<span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">count</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pmkids</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pmkids</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ndis_80211_pmkid</span> <span class="o">*</span><span class="nf">update_pmkid</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">ndis_80211_pmkid</span> <span class="o">*</span><span class="n">pmkids</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">cfg80211_pmksa</span> <span class="o">*</span><span class="n">pmksa</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">max_pmkids</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span> <span class="n">newlen</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">count</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info_count</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">max_pmkids</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">max_pmkids</span><span class="p">;</span>

	<span class="cm">/* update with new pmkid */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bssid</span><span class="p">,</span>
				      <span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pmkid</span><span class="p">,</span> <span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">,</span>
								<span class="n">WLAN_PMKID_LEN</span><span class="p">);</span>

		<span class="k">return</span> <span class="n">pmkids</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* out of space, return error */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">max_pmkids</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): out of space</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* add new pmkid */</span>
	<span class="n">newlen</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">pmkids</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">pmkids</span> <span class="o">=</span> <span class="n">krealloc</span><span class="p">(</span><span class="n">pmkids</span><span class="p">,</span> <span class="n">newlen</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pmkids</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">newlen</span><span class="p">);</span>
	<span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">bssid</span><span class="p">,</span> <span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">pmkids</span><span class="o">-&gt;</span><span class="n">bssid_info</span><span class="p">[</span><span class="n">count</span><span class="p">].</span><span class="n">pmkid</span><span class="p">,</span> <span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">,</span> <span class="n">WLAN_PMKID_LEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">pmkids</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">pmkids</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">err</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * cfg80211 ops</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_change_virtual_intf</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">enum</span> <span class="n">nl80211_iftype</span> <span class="n">type</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">flags</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">vif_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_ADHOC</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">NDIS_80211_INFRA_ADHOC</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">NL80211_IFTYPE_STATION</span>:
		<span class="n">mode</span> <span class="o">=</span> <span class="n">NDIS_80211_INFRA_INFRA</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">iftype</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">set_infra_mode</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_set_wiphy_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">u32</span> <span class="n">changed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_FRAG_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">set_frag_threshold</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">frag_threshold</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">WIPHY_PARAM_RTS_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">set_rts_threshold</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">rts_threshold</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_set_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
			      <span class="k">enum</span> <span class="n">nl80211_tx_power_setting</span> <span class="n">type</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">mbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): type:0x%x mbm:%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">mbm</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mbm</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="p">(</span><span class="n">mbm</span> <span class="o">%</span> <span class="mi">100</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="cm">/* Device doesn&#39;t support changing txpower after initialization, only</span>
<span class="cm">	 * turn off/on radio. Support &#39;auto&#39; mode and setting same dBm that is</span>
<span class="cm">	 * currently used.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">NL80211_TX_POWER_AUTOMATIC</span> <span class="o">||</span>
	    <span class="n">MBM_TO_DBM</span><span class="p">(</span><span class="n">mbm</span><span class="p">)</span> <span class="o">==</span> <span class="n">get_bcm4320_power_dbm</span><span class="p">(</span><span class="n">priv</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span><span class="p">)</span>
			<span class="n">disassociate</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span> <span class="cm">/* turn on radio */</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_get_tx_power</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">dbm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>

	<span class="o">*</span><span class="n">dbm</span> <span class="o">=</span> <span class="n">get_bcm4320_power_dbm</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): dbm:%i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="o">*</span><span class="n">dbm</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define SCAN_DELAY_JIFFIES (6 * HZ)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_scan</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">cfg80211_scan_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">SCAN_DELAY_JIFFIES</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;cfg80211.scan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* Get current bssid list from device before new scan, as new scan</span>
<span class="cm">	 * clears internal bssid list.</span>
<span class="cm">	 */</span>
	<span class="n">rndis_check_bssid_list</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">!=</span> <span class="n">request</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_start_bssid_list_scan</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">RNDIS_BCM4320A</span><span class="p">)</span>
			<span class="n">delay</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>

		<span class="cm">/* Wait before retrieving scan results from device */</span>
		<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">,</span> <span class="n">delay</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">rndis_bss_info_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">ndis_80211_bssid_ex</span> <span class="o">*</span><span class="n">bssid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">signal</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">capability</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">beacon_interval</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_fixed_ies</span> <span class="o">*</span><span class="n">fixed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">bssid_len</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">ie</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot; found bssid: &#39;%.32s&#39; [%pM], len: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">bssid</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">,</span> <span class="n">bssid</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bssid</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">));</span>

	<span class="cm">/* parse bssid structure */</span>
	<span class="n">bssid_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bssid</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bssid_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_bssid_ex</span><span class="p">)</span> <span class="o">+</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_fixed_ies</span><span class="p">))</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">fixed</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_fixed_ies</span> <span class="o">*</span><span class="p">)</span><span class="n">bssid</span><span class="o">-&gt;</span><span class="n">ies</span><span class="p">;</span>

	<span class="n">ie</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">bssid</span><span class="o">-&gt;</span><span class="n">ies</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_fixed_ies</span><span class="p">));</span>
	<span class="n">ie_len</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">bssid_len</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">bssid</span><span class="p">),</span>
					<span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bssid</span><span class="o">-&gt;</span><span class="n">ie_length</span><span class="p">));</span>
	<span class="n">ie_len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_fixed_ies</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ie_len</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="cm">/* extract data for cfg80211_inform_bss */</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">ieee80211_get_channel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span>
			<span class="n">KHZ_TO_MHZ</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bssid</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">ds_config</span><span class="p">)));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">signal</span> <span class="o">=</span> <span class="n">level_to_qual</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bssid</span><span class="o">-&gt;</span><span class="n">rssi</span><span class="p">));</span>
	<span class="n">timestamp</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">__le64</span> <span class="o">*</span><span class="p">)</span><span class="n">fixed</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">);</span>
	<span class="n">capability</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fixed</span><span class="o">-&gt;</span><span class="n">capabilities</span><span class="p">);</span>
	<span class="n">beacon_interval</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">fixed</span><span class="o">-&gt;</span><span class="n">beacon_interval</span><span class="p">);</span>

	<span class="n">bss</span> <span class="o">=</span> <span class="n">cfg80211_inform_bss</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">bssid</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span>
		<span class="n">timestamp</span><span class="p">,</span> <span class="n">capability</span><span class="p">,</span> <span class="n">beacon_interval</span><span class="p">,</span> <span class="n">ie</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span>
		<span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">cfg80211_put_bss</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">bss</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ndis_80211_bssid_ex</span> <span class="o">*</span><span class="nf">next_bssid_list_item</span><span class="p">(</span>
					<span class="k">struct</span> <span class="n">ndis_80211_bssid_ex</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
					<span class="kt">int</span> <span class="o">*</span><span class="n">bssid_len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf_end</span><span class="p">,</span> <span class="o">*</span><span class="n">bssid_end</span><span class="p">;</span>

	<span class="n">buf_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">bssid_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">bssid</span> <span class="o">+</span> <span class="o">*</span><span class="n">bssid_len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="kt">int</span><span class="p">)(</span><span class="n">buf_end</span> <span class="o">-</span> <span class="n">bssid_end</span><span class="p">)</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bssid</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">bssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bssid</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">bssid</span> <span class="o">+</span> <span class="o">*</span><span class="n">bssid_len</span><span class="p">);</span>
		<span class="o">*</span><span class="n">bssid_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bssid</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">bssid</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">bool</span> <span class="nf">check_bssid_list_item</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_bssid_ex</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
				  <span class="kt">int</span> <span class="n">bssid_len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf_end</span><span class="p">,</span> <span class="o">*</span><span class="n">bssid_end</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bssid</span> <span class="o">||</span> <span class="n">bssid_len</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bssid_len</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">buf_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span> <span class="o">+</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">bssid_end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">bssid</span> <span class="o">+</span> <span class="n">bssid_len</span><span class="p">;</span>

	<span class="k">return</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">buf_end</span> <span class="o">-</span> <span class="n">bssid_end</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">bssid_end</span> <span class="o">-</span> <span class="n">buf</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_check_bssid_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">match_bssid</span><span class="p">,</span>
					<span class="n">bool</span> <span class="o">*</span><span class="n">matched</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_bssid_list_ex</span> <span class="o">*</span><span class="n">bssid_list</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_bssid_ex</span> <span class="o">*</span><span class="n">bssid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">bssid_len</span><span class="p">,</span> <span class="n">real_count</span><span class="p">,</span> <span class="n">new_len</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">;</span>
<span class="nl">resize_buf:</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* BSSID-list might have got bigger last time we checked, keep</span>
<span class="cm">	 * resizing until it won&#39;t get any bigger.</span>
<span class="cm">	 */</span>
	<span class="n">new_len</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_802_11_BSSID_LIST</span><span class="p">,</span>
			      <span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">new_len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_bssid_list_ex</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_len</span> <span class="o">&gt;</span> <span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">new_len</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">resize_buf</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">new_len</span><span class="p">;</span>

	<span class="n">bssid_list</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">bssid_list</span><span class="o">-&gt;</span><span class="n">num_items</span><span class="p">);</span>
	<span class="n">real_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): buflen: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="n">bssid_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bssid</span> <span class="o">=</span> <span class="n">next_bssid_list_item</span><span class="p">(</span><span class="n">bssid_list</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bssid_len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Device returns incorrect &#39;num_items&#39;. Workaround by ignoring the</span>
<span class="cm">	 * received &#39;num_items&#39; and walking through full bssid buffer instead.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">check_bssid_list_item</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid_len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rndis_bss_info_update</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">bssid</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">match_bssid</span> <span class="o">&amp;&amp;</span>
		    <span class="n">matched</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">bssid</span><span class="o">-&gt;</span><span class="n">mac</span><span class="p">,</span> <span class="n">match_bssid</span><span class="p">))</span>
				<span class="o">*</span><span class="n">matched</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">real_count</span><span class="o">++</span><span class="p">;</span>
		<span class="n">bssid</span> <span class="o">=</span> <span class="n">next_bssid_list_item</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bssid_len</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): num_items from device: %d, really found:&quot;</span>
				<span class="s">&quot; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">real_count</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_get_scan_results</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rndis_wlan_private</span><span class="p">,</span> <span class="n">scan_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;get_scan_results</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_check_bssid_list</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">cfg80211_scan_done</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">,</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">cfg80211_connect_params</span> <span class="o">*</span><span class="n">sme</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_ssid</span> <span class="n">ssid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pairwise</span> <span class="o">=</span> <span class="n">RNDIS_WLAN_ALG_NONE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">groupwise</span> <span class="o">=</span> <span class="n">RNDIS_WLAN_ALG_NONE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">keymgmt</span> <span class="o">=</span> <span class="n">RNDIS_WLAN_KEY_MGMT_NONE</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">chan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">ieee80211_frequency_to_channel</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>

	<span class="n">groupwise</span> <span class="o">=</span> <span class="n">rndis_cipher_to_alg</span><span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">cipher_group</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">n_ciphers_pairwise</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pairwise</span> <span class="o">|=</span>
			<span class="n">rndis_cipher_to_alg</span><span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">ciphers_pairwise</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">n_ciphers_pairwise</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			<span class="n">pairwise</span> <span class="o">==</span> <span class="n">RNDIS_WLAN_ALG_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;Unsupported pairwise cipher</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">n_akm_suites</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">keymgmt</span> <span class="o">|=</span>
			<span class="n">rndis_akm_suite_to_key_mgmt</span><span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">akm_suites</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">n_akm_suites</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
			<span class="n">keymgmt</span> <span class="o">==</span> <span class="n">RNDIS_WLAN_KEY_MGMT_NONE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;Invalid keymgmt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;cfg80211.connect(&#39;%.32s&#39;:[%pM]:%d:[%d,0x%x:0x%x]:[0x%x:0x%x]:0x%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span>
		   <span class="n">sme</span><span class="o">-&gt;</span><span class="n">privacy</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">wpa_versions</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">,</span>
		   <span class="n">groupwise</span><span class="p">,</span> <span class="n">pairwise</span><span class="p">,</span> <span class="n">keymgmt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_associated</span><span class="p">(</span><span class="n">usbdev</span><span class="p">))</span>
		<span class="n">disassociate</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_infra_mode</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">NDIS_80211_INFRA_INFRA</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;connect: set_infra_mode failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_turn_radio_on</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_auth_mode</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">crypto</span><span class="p">.</span><span class="n">wpa_versions</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">auth_type</span><span class="p">,</span>
								<span class="n">keymgmt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;connect: set_auth_mode failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_turn_radio_on</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_priv_filter</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_encr_mode</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">pairwise</span><span class="p">,</span> <span class="n">groupwise</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;connect: set_encr_mode failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_turn_radio_on</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_channel</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;connect: set_channel failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_turn_radio_on</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">groupwise</span> <span class="o">|</span> <span class="n">pairwise</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">RNDIS_WLAN_ALG_WEP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_tx_key_index</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">add_wep_key</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;connect: add_wep_key failed, %d (%d, %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ret</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">key_idx</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_turn_radio_on</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_bssid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;connect: set_bssid failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_turn_radio_on</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">clear_bssid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">NDIS_802_11_LENGTH_SSID</span><span class="p">)</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">NDIS_802_11_LENGTH_SSID</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid</span><span class="p">));</span>
	<span class="n">ssid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">,</span> <span class="n">sme</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="cm">/* Pause and purge rx queue, so we don&#39;t pass packets before</span>
<span class="cm">	 * &#39;media connect&#39;-indication.</span>
<span class="cm">	 */</span>
	<span class="n">usbnet_pause_rx</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="n">usbnet_purge_paused_rxq</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_essid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;connect: set_essid failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">err_turn_radio_on:</span>
	<span class="n">disassociate</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
								<span class="n">u16</span> <span class="n">reason_code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;cfg80211.disconnect(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reason_code</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">deauthenticate</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_join_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">cfg80211_ibss_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_ssid</span> <span class="n">ssid</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">nl80211_auth_type</span> <span class="n">auth_type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">alg</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">chan</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">ieee80211_frequency_to_channel</span><span class="p">(</span><span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span><span class="p">);</span>

	<span class="cm">/* TODO: How to handle ad-hoc encryption?</span>
<span class="cm">	 * connect() has *key, join_ibss() doesn&#39;t. RNDIS requires key to be</span>
<span class="cm">	 * pre-shared for encryption (open/shared/wpa), is key set before</span>
<span class="cm">	 * join_ibss? Which auth_type to use (not in params)? What about WPA?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">privacy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">auth_type</span> <span class="o">=</span> <span class="n">NL80211_AUTHTYPE_SHARED_KEY</span><span class="p">;</span>
		<span class="n">alg</span> <span class="o">=</span> <span class="n">RNDIS_WLAN_ALG_WEP</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">auth_type</span> <span class="o">=</span> <span class="n">NL80211_AUTHTYPE_OPEN_SYSTEM</span><span class="p">;</span>
		<span class="n">alg</span> <span class="o">=</span> <span class="n">RNDIS_WLAN_ALG_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;cfg80211.join_ibss(&#39;%.32s&#39;:[%pM]:%d:%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">chan</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">privacy</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_associated</span><span class="p">(</span><span class="n">usbdev</span><span class="p">))</span>
		<span class="n">disassociate</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_infra_mode</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">NDIS_80211_INFRA_ADHOC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;join_ibss: set_infra_mode failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_turn_radio_on</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_auth_mode</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">auth_type</span><span class="p">,</span> <span class="n">RNDIS_WLAN_KEY_MGMT_NONE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;join_ibss: set_auth_mode failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_turn_radio_on</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_priv_filter</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_encr_mode</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">alg</span><span class="p">,</span> <span class="n">RNDIS_WLAN_ALG_NONE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;join_ibss: set_encr_mode failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_turn_radio_on</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_channel</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;join_ibss: set_channel failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_turn_radio_on</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="o">!</span><span class="n">is_broadcast_ether_addr</span><span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">set_bssid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;join_ibss: set_bssid failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">ret</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_turn_radio_on</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">clear_bssid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="n">NDIS_802_11_LENGTH_SSID</span><span class="p">)</span>
		<span class="n">length</span> <span class="o">=</span> <span class="n">NDIS_802_11_LENGTH_SSID</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid</span><span class="p">));</span>
	<span class="n">ssid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">length</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">ssid</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="cm">/* Don&#39;t need to pause rx queue for ad-hoc. */</span>
	<span class="n">usbnet_purge_paused_rxq</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="n">usbnet_resume_rx</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">set_essid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ssid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;join_ibss: set_essid failed, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">err_turn_radio_on:</span>
	<span class="n">disassociate</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_leave_ibss</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;cfg80211.leave_ibss()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">deauthenticate</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_add_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">key_params</span> <span class="o">*</span><span class="n">params</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(%i, %pM, %08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP40</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_WEP104</span>:
		<span class="k">return</span> <span class="n">add_wep_key</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span>
								<span class="n">key_index</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_TKIP</span>:
	<span class="k">case</span> <span class="n">WLAN_CIPHER_SUITE_CCMP</span>:
		<span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">params</span><span class="o">-&gt;</span><span class="n">seq</span> <span class="o">&amp;&amp;</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq_len</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">NDIS_80211_ADDKEY_SET_INIT_RECV_SEQ</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mac_addr</span><span class="p">)</span>
			<span class="n">flags</span> <span class="o">|=</span> <span class="n">NDIS_80211_ADDKEY_PAIRWISE_KEY</span> <span class="o">|</span>
					<span class="n">NDIS_80211_ADDKEY_TRANSMIT_KEY</span><span class="p">;</span>

		<span class="k">return</span> <span class="n">add_wpa_key</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">key_len</span><span class="p">,</span>
				<span class="n">key_index</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">seq</span><span class="p">,</span>
				<span class="n">params</span><span class="o">-&gt;</span><span class="n">seq_len</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): unsupported cipher %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">__func__</span><span class="p">,</span> <span class="n">params</span><span class="o">-&gt;</span><span class="n">cipher</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_del_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
			 <span class="n">u8</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">pairwise</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac_addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(%i, %pM)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">remove_key</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">mac_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_set_default_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				 <span class="n">u8</span> <span class="n">key_index</span><span class="p">,</span> <span class="n">bool</span> <span class="n">unicast</span><span class="p">,</span> <span class="n">bool</span> <span class="n">multicast</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_encr_key</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">key_index</span> <span class="o">&gt;=</span> <span class="n">RNDIS_WLAN_NUM_KEYS</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_tx_key_index</span> <span class="o">=</span> <span class="n">key_index</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_wpa_key</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">key_index</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">encr_keys</span><span class="p">[</span><span class="n">key_index</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">add_wep_key</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">material</span><span class="p">,</span> <span class="n">key</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">key_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_fill_station_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">station_info</span> <span class="o">*</span><span class="n">sinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__le32</span> <span class="n">linkspeed</span><span class="p">,</span> <span class="n">rssi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">sinfo</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">sinfo</span><span class="p">));</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">linkspeed</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_GEN_LINK_SPEED</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">linkspeed</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">txrate</span><span class="p">.</span><span class="n">legacy</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">linkspeed</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_TX_BITRATE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rssi</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_802_11_RSSI</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">rssi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">signal</span> <span class="o">=</span> <span class="n">level_to_qual</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rssi</span><span class="p">));</span>
		<span class="n">sinfo</span><span class="o">-&gt;</span><span class="n">filled</span> <span class="o">|=</span> <span class="n">STATION_INFO_SIGNAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_get_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">station_info</span> <span class="o">*</span><span class="n">sinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ether_addr_equal</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">mac</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">rndis_fill_station_info</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">sinfo</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_dump_station</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			       <span class="kt">int</span> <span class="n">idx</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">mac</span><span class="p">,</span> <span class="k">struct</span> <span class="n">station_info</span> <span class="o">*</span><span class="n">sinfo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOENT</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">rndis_fill_station_info</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">sinfo</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_set_pmksa</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cfg80211_pmksa</span> <span class="o">*</span><span class="n">pmksa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_pmkid</span> <span class="o">*</span><span class="n">pmkids</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(%pM, %08X:%08X:%08X:%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>

	<span class="n">pmkids</span> <span class="o">=</span> <span class="n">get_device_pmkids</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pmkids</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* couldn&#39;t read PMKID cache from device */</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pmkids</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pmkids</span> <span class="o">=</span> <span class="n">update_pmkid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">pmkids</span><span class="p">,</span> <span class="n">pmksa</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_num_pmkids</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pmkids</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* not found, list full, etc */</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pmkids</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">set_device_pmkids</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">pmkids</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_del_pmksa</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cfg80211_pmksa</span> <span class="o">*</span><span class="n">pmksa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_pmkid</span> <span class="o">*</span><span class="n">pmkids</span><span class="p">;</span>
	<span class="n">u32</span> <span class="o">*</span><span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">pmkid</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(%pM, %08X:%08X:%08X:%08X)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			<span class="n">pmksa</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
			<span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">cpu_to_be32</span><span class="p">(</span><span class="n">tmp</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>

	<span class="n">pmkids</span> <span class="o">=</span> <span class="n">get_device_pmkids</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pmkids</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Couldn&#39;t read PMKID cache from device */</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pmkids</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pmkids</span> <span class="o">=</span> <span class="n">remove_pmkid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">pmkids</span><span class="p">,</span> <span class="n">pmksa</span><span class="p">,</span> <span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_num_pmkids</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">pmkids</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* not found, etc */</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">pmkids</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">set_device_pmkids</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">pmkids</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_flush_pmksa</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_pmkid</span> <span class="n">pmkid</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pmkid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pmkid</span><span class="p">));</span>

	<span class="n">pmkid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pmkid</span><span class="p">));</span>
	<span class="n">pmkid</span><span class="p">.</span><span class="n">bssid_info_count</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_802_11_PMKID</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">pmkid</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pmkid</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_set_power_mgmt</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="n">bool</span> <span class="n">enabled</span><span class="p">,</span> <span class="kt">int</span> <span class="n">timeout</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">power_mode</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">mode</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">!=</span> <span class="n">RNDIS_BCM4320B</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTSUPP</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): %s, %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">enabled</span> <span class="o">?</span> <span class="s">&quot;enabled&quot;</span> <span class="o">:</span> <span class="s">&quot;disabled&quot;</span><span class="p">,</span>
				<span class="n">timeout</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">enabled</span><span class="p">)</span>
		<span class="n">power_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_POWER_MODE_FAST_PSP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">power_mode</span> <span class="o">=</span> <span class="n">NDIS_80211_POWER_MODE_CAM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">power_mode</span> <span class="o">==</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="n">power_mode</span><span class="p">;</span>

	<span class="n">mode</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">power_mode</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_802_11_POWER_MODE</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">mode</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mode</span><span class="p">));</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): RNDIS_OID_802_11_POWER_MODE -&gt; %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_set_cqm_rssi_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">s32</span> <span class="n">rssi_thold</span><span class="p">,</span> <span class="n">u32</span> <span class="n">rssi_hyst</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cqm_rssi_thold</span> <span class="o">=</span> <span class="n">rssi_thold</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">cqm_rssi_hyst</span> <span class="o">=</span> <span class="n">rssi_hyst</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_cqm_event_rssi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_wlan_craft_connected_bss</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">bssid</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">ndis_80211_assoc_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ieee80211_channel</span> <span class="o">*</span><span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_ssid</span> <span class="n">ssid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cfg80211_bss</span> <span class="o">*</span><span class="n">bss</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">signal</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">timestamp</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">capability</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">beacon_period</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">rssi</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ie_buf</span><span class="p">[</span><span class="mi">34</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">;</span>

	<span class="cm">/* Get signal quality, in case of error use rssi=0 and ignore error. */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rssi</span><span class="p">);</span>
	<span class="n">rssi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_802_11_RSSI</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">rssi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">signal</span> <span class="o">=</span> <span class="n">level_to_qual</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rssi</span><span class="p">));</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): RNDIS_OID_802_11_RSSI -&gt; %d, &quot;</span>
		   <span class="s">&quot;rssi:%d, qual: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rssi</span><span class="p">),</span>
		   <span class="n">level_to_qual</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rssi</span><span class="p">)));</span>

	<span class="cm">/* Get AP capabilities */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">capability</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">resp_ie</span><span class="p">.</span><span class="n">capa</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Set atleast ESS/IBSS capability */</span>
		<span class="n">capability</span> <span class="o">=</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">infra_mode</span> <span class="o">==</span> <span class="n">NDIS_80211_INFRA_INFRA</span><span class="p">)</span> <span class="o">?</span>
				<span class="n">WLAN_CAPABILITY_ESS</span> <span class="o">:</span> <span class="n">WLAN_CAPABILITY_IBSS</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get channel and beacon interval */</span>
	<span class="n">channel</span> <span class="o">=</span> <span class="n">get_current_channel</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">beacon_period</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">channel</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): could not get channel.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get SSID, in case of error, use zero length SSID and ignore error. */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ssid</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_802_11_SSID</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">ssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): RNDIS_OID_802_11_SSID -&gt; %d, len: %d, ssid: &quot;</span>
				<span class="s">&quot;&#39;%.32s&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">length</span><span class="p">),</span> <span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">)</span>
		<span class="n">ssid</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">32</span><span class="p">);</span>

	<span class="n">ie_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">WLAN_EID_SSID</span><span class="p">;</span>
	<span class="n">ie_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">length</span><span class="p">);</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ie_buf</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">length</span><span class="p">));</span>

	<span class="n">ie_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ssid</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">;</span>

	<span class="cm">/* no tsf */</span>
	<span class="n">timestamp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s(): channel:%d(freq), bssid:[%pM], tsf:%d, &quot;</span>
		<span class="s">&quot;capa:%x, beacon int:%d, resp_ie(len:%d, essid:&#39;%.32s&#39;), &quot;</span>
		<span class="s">&quot;signal:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">channel</span> <span class="o">?</span> <span class="n">channel</span><span class="o">-&gt;</span><span class="n">center_freq</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span>
		<span class="n">bssid</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">timestamp</span><span class="p">,</span> <span class="n">capability</span><span class="p">,</span> <span class="n">beacon_period</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span>
		<span class="n">ssid</span><span class="p">.</span><span class="n">essid</span><span class="p">,</span> <span class="n">signal</span><span class="p">);</span>

	<span class="n">bss</span> <span class="o">=</span> <span class="n">cfg80211_inform_bss</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span>
		<span class="n">timestamp</span><span class="p">,</span> <span class="n">capability</span><span class="p">,</span> <span class="n">beacon_period</span><span class="p">,</span> <span class="n">ie_buf</span><span class="p">,</span> <span class="n">ie_len</span><span class="p">,</span>
		<span class="n">signal</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">cfg80211_put_bss</span><span class="p">(</span><span class="n">bss</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * workers, indication handlers, device poller</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_wlan_do_link_up_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">ndis_80211_assoc_info</span> <span class="o">*</span><span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bssid</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">resp_ie_len</span><span class="p">,</span> <span class="n">req_ie_len</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">req_ie</span><span class="p">,</span> <span class="o">*</span><span class="n">resp_ie</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">roamed</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">match_bss</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">infra_mode</span> <span class="o">==</span> <span class="n">NDIS_80211_INFRA_INFRA</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* received media connect indication while connected, either</span>
<span class="cm">		 * device reassociated with same AP or roamed to new. */</span>
		<span class="n">roamed</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">resp_ie_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">resp_ie</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">infra_mode</span> <span class="o">==</span> <span class="n">NDIS_80211_INFRA_INFRA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">CONTROL_BUFFER_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">info</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* No memory? Try resume work later */</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">WORK_LINK_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_pending</span><span class="p">);</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Get association info IEs from device. */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_association_info</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req_ie_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">req_ie_length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req_ie_len</span> <span class="o">&gt;</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">)</span>
				<span class="n">req_ie_len</span> <span class="o">=</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req_ie_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">offset_req_ies</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">)</span>
					<span class="n">offset</span> <span class="o">=</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">;</span>

				<span class="n">req_ie</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">req_ie_len</span> <span class="o">&gt;</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">)</span>
					<span class="n">req_ie_len</span> <span class="o">=</span>
						<span class="n">CONTROL_BUFFER_SIZE</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">resp_ie_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">resp_ie_length</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">resp_ie_len</span> <span class="o">&gt;</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">)</span>
				<span class="n">resp_ie_len</span> <span class="o">=</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">resp_ie_len</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">offset_resp_ies</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">)</span>
					<span class="n">offset</span> <span class="o">=</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">;</span>

				<span class="n">resp_ie</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">info</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">+</span> <span class="n">resp_ie_len</span> <span class="o">&gt;</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">)</span>
					<span class="n">resp_ie_len</span> <span class="o">=</span>
						<span class="n">CONTROL_BUFFER_SIZE</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Since rndis_wlan_craft_connected_bss() might use info</span>
<span class="cm">			 * later and expects info to contain valid data if</span>
<span class="cm">			 * non-null, free info and set NULL here.</span>
<span class="cm">			 */</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>
			<span class="n">info</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">WARN_ON</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">infra_mode</span> <span class="o">!=</span> <span class="n">NDIS_80211_INFRA_ADHOC</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">get_bssid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">bssid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bssid</span><span class="p">));</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;link up work: [%pM]%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">bssid</span><span class="p">,</span> <span class="n">roamed</span> <span class="o">?</span> <span class="s">&quot; roamed&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="cm">/* Internal bss list in device should contain at least the currently</span>
<span class="cm">	 * connected bss and we can get it to cfg80211 with</span>
<span class="cm">	 * rndis_check_bssid_list().</span>
<span class="cm">	 *</span>
<span class="cm">	 * NDIS spec says: &quot;If the device is associated, but the associated</span>
<span class="cm">	 *  BSSID is not in its BSSID scan list, then the driver must add an</span>
<span class="cm">	 *  entry for the BSSID at the end of the data that it returns in</span>
<span class="cm">	 *  response to query of RNDIS_OID_802_11_BSSID_LIST.&quot;</span>
<span class="cm">	 *</span>
<span class="cm">	 * NOTE: Seems to be true for BCM4320b variant, but not BCM4320a.</span>
<span class="cm">	 */</span>
	<span class="n">match_bss</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">rndis_check_bssid_list</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">match_bss</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_zero_ether_addr</span><span class="p">(</span><span class="n">bssid</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">match_bss</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Couldn&#39;t get bss from device, we need to manually craft bss</span>
<span class="cm">		 * for cfg80211.</span>
<span class="cm">		 */</span>
		<span class="n">rndis_wlan_craft_connected_bss</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">info</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">infra_mode</span> <span class="o">==</span> <span class="n">NDIS_80211_INFRA_INFRA</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">roamed</span><span class="p">)</span>
			<span class="n">cfg80211_connect_result</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">req_ie</span><span class="p">,</span>
						<span class="n">req_ie_len</span><span class="p">,</span> <span class="n">resp_ie</span><span class="p">,</span>
						<span class="n">resp_ie_len</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">cfg80211_roamed</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
					<span class="n">get_current_channel</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
					<span class="n">bssid</span><span class="p">,</span> <span class="n">req_ie</span><span class="p">,</span> <span class="n">req_ie_len</span><span class="p">,</span>
					<span class="n">resp_ie</span><span class="p">,</span> <span class="n">resp_ie_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">infra_mode</span> <span class="o">==</span> <span class="n">NDIS_80211_INFRA_ADHOC</span><span class="p">)</span>
		<span class="n">cfg80211_ibss_joined</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">info</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="n">bssid</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

	<span class="n">usbnet_resume_rx</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_wlan_do_link_down_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">connected</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>

		<span class="n">deauthenticate</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

		<span class="n">cfg80211_disconnected</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_wlan_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rndis_wlan_private</span><span class="p">,</span> <span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WORK_LINK_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_pending</span><span class="p">))</span>
		<span class="n">rndis_wlan_do_link_up_work</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WORK_LINK_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_pending</span><span class="p">))</span>
		<span class="n">rndis_wlan_do_link_down_work</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_clear_bit</span><span class="p">(</span><span class="n">WORK_SET_MULTICAST_LIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_pending</span><span class="p">))</span>
		<span class="n">set_multicast_list</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_wlan_set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">WORK_SET_MULTICAST_LIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_pending</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">WORK_SET_MULTICAST_LIST</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_pending</span><span class="p">);</span>
	<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_wlan_auth_indication</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ndis_80211_status_indication</span> <span class="o">*</span><span class="n">indication</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="n">buflen</span><span class="p">,</span> <span class="n">key_id</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">pairwise_error</span><span class="p">,</span> <span class="n">group_error</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_auth_request</span> <span class="o">*</span><span class="n">auth_req</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">nl80211_key_type</span> <span class="n">key_type</span><span class="p">;</span>

	<span class="cm">/* must have at least one array entry */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_status_indication</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_auth_request</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;authentication indication: too short message (%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">indication</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">auth_request</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">buflen</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_status_indication</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">buflen</span> <span class="o">&gt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">auth_req</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">auth_req</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>
		<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;unknown&quot;</span><span class="p">;</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">auth_req</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
		<span class="n">pairwise_error</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
		<span class="n">group_error</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;reauth request&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;key update request&quot;</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0x6</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pairwise_error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;pairwise_error&quot;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="mh">0xe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">group_error</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="s">&quot;group_error&quot;</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">netdev_info</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;authentication indication: %s (0x%08x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">type</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">auth_req</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pairwise_error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">key_type</span> <span class="o">=</span> <span class="n">NL80211_KEYTYPE_PAIRWISE</span><span class="p">;</span>
			<span class="n">key_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

			<span class="n">cfg80211_michael_mic_failure</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
							<span class="n">auth_req</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
							<span class="n">key_type</span><span class="p">,</span> <span class="n">key_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
							<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">group_error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">key_type</span> <span class="o">=</span> <span class="n">NL80211_KEYTYPE_GROUP</span><span class="p">;</span>
			<span class="n">key_id</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

			<span class="n">cfg80211_michael_mic_failure</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
							<span class="n">auth_req</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
							<span class="n">key_type</span><span class="p">,</span> <span class="n">key_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
							<span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">buflen</span> <span class="o">-=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">auth_req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">buf</span> <span class="o">+=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">auth_req</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_wlan_pmkid_cand_list_indication</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">ndis_80211_status_indication</span> <span class="o">*</span><span class="n">indication</span><span class="p">,</span>
				<span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ndis_80211_pmkid_cand_list</span> <span class="o">*</span><span class="n">cand_list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">list_len</span><span class="p">,</span> <span class="n">expected_len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_status_indication</span><span class="p">,</span> <span class="n">u</span><span class="p">)</span> <span class="o">+</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_pmkid_cand_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;pmkid candidate list indication: too short message (%i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">indication</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cand_list</span><span class="p">.</span><span class="n">num_candidates</span><span class="p">)</span> <span class="o">*</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_pmkid_candidate</span><span class="p">);</span>
	<span class="n">expected_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_pmkid_cand_list</span><span class="p">)</span> <span class="o">+</span> <span class="n">list_len</span> <span class="o">+</span>
			<span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_status_indication</span><span class="p">,</span> <span class="n">u</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">expected_len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;pmkid candidate list indication: list larger than buffer (%i &lt; %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">len</span><span class="p">,</span> <span class="n">expected_len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cand_list</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">indication</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">cand_list</span><span class="p">;</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;pmkid candidate list indication: version %i, candidates %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cand_list</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">),</span>
		    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cand_list</span><span class="o">-&gt;</span><span class="n">num_candidates</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cand_list</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cand_list</span><span class="o">-&gt;</span><span class="n">num_candidates</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ndis_80211_pmkid_candidate</span> <span class="o">*</span><span class="n">cand</span> <span class="o">=</span>
						<span class="o">&amp;</span><span class="n">cand_list</span><span class="o">-&gt;</span><span class="n">candidate_list</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">bool</span> <span class="n">preauth</span> <span class="o">=</span> <span class="o">!!</span><span class="p">(</span><span class="n">cand</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NDIS_80211_PMKID_CAND_PREAUTH</span><span class="p">);</span>

		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;cand[%i]: flags: 0x%08x, preauth: %d, bssid: %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">i</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">cand</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">),</span> <span class="n">preauth</span><span class="p">,</span> <span class="n">cand</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">);</span>

		<span class="n">cfg80211_pmksa_candidate_notify</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">cand</span><span class="o">-&gt;</span><span class="n">bssid</span><span class="p">,</span>
						<span class="n">preauth</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_wlan_media_specific_indication</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">rndis_indicate</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ndis_80211_status_indication</span> <span class="o">*</span><span class="n">indication</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>

	<span class="n">offset</span> <span class="o">=</span> <span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_indicate</span><span class="p">,</span> <span class="n">status</span><span class="p">)</span> <span class="o">+</span>
			<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;media specific indication, ignore too short message (%i &lt; 8)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">buflen</span> <span class="o">||</span> <span class="n">offset</span> <span class="o">&gt;</span> <span class="n">buflen</span> <span class="o">||</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">buflen</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;media specific indication, too large to fit to buffer (%i &gt; %i)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">indication</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">indication</span><span class="o">-&gt;</span><span class="n">status_type</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NDIS_80211_STATUSTYPE_RADIOSTATE</span>:
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;radio state indication: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">indication</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">radio_status</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NDIS_80211_STATUSTYPE_MEDIASTREAMMODE</span>:
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;media stream mode indication: %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">indication</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">media_stream_mode</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NDIS_80211_STATUSTYPE_AUTHENTICATION</span>:
		<span class="n">rndis_wlan_auth_indication</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">indication</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">NDIS_80211_STATUSTYPE_PMKID_CANDIDATELIST</span>:
		<span class="n">rndis_wlan_pmkid_cand_list_indication</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">indication</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;media specific indication: unknown status type 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">indication</span><span class="o">-&gt;</span><span class="n">status_type</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_wlan_indication</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">ind</span><span class="p">,</span> <span class="kt">int</span> <span class="n">buflen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rndis_indicate</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">ind</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RNDIS_STATUS_MEDIA_CONNECT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">current_command_oid</span> <span class="o">==</span> <span class="n">RNDIS_OID_802_11_ADD_KEY</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* RNDIS_OID_802_11_ADD_KEY causes sometimes extra</span>
<span class="cm">			 * &quot;media connect&quot; indications which confuses driver</span>
<span class="cm">			 * and userspace to think that device is</span>
<span class="cm">			 * roaming/reassociating when it isn&#39;t.</span>
<span class="cm">			 */</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;ignored RNDIS_OID_802_11_ADD_KEY triggered &#39;media connect&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">usbnet_pause_rx</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

		<span class="n">netdev_info</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;media connect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* queue work to avoid recursive calls into rndis_command */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WORK_LINK_UP</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_pending</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RNDIS_STATUS_MEDIA_DISCONNECT</span>:
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;media disconnect</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* queue work to avoid recursive calls into rndis_command */</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">WORK_LINK_DOWN</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_pending</span><span class="p">);</span>
		<span class="n">queue_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">RNDIS_STATUS_MEDIA_SPECIFIC_INDICATION</span>:
		<span class="n">rndis_wlan_media_specific_indication</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">buflen</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;indication: 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">));</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_wlan_get_caps</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">__le32</span>	<span class="n">num_items</span><span class="p">;</span>
		<span class="n">__le32</span>	<span class="n">items</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">networks_supported</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ndis_80211_capability</span> <span class="o">*</span><span class="n">caps</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">caps_buf</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">caps</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">auth_encr_pair</span><span class="p">)</span> <span class="o">*</span> <span class="mi">16</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">retval</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="cm">/* determine supported modes */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">networks_supported</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
				 <span class="n">RNDIS_OID_802_11_NETWORK_TYPES_SUPPORTED</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">networks_supported</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">networks_supported</span><span class="p">.</span><span class="n">num_items</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span>
			<span class="n">n</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">n</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">networks_supported</span><span class="p">.</span><span class="n">items</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">NDIS_80211_TYPE_FREQ_HOP</span>:
			<span class="k">case</span> <span class="n">NDIS_80211_TYPE_DIRECT_SEQ</span>:
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">CAP_MODE_80211B</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">NDIS_80211_TYPE_OFDM_A</span>:
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">CAP_MODE_80211A</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">NDIS_80211_TYPE_OFDM_G</span>:
				<span class="n">priv</span><span class="o">-&gt;</span><span class="n">caps</span> <span class="o">|=</span> <span class="n">CAP_MODE_80211G</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* get device 802.11 capabilities, number of PMKIDs */</span>
	<span class="n">caps</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">ndis_80211_capability</span> <span class="o">*</span><span class="p">)</span><span class="n">caps_buf</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">caps_buf</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
				 <span class="n">RNDIS_OID_802_11_CAPABILITY</span><span class="p">,</span>
				 <span class="n">caps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;RNDIS_OID_802_11_CAPABILITY -&gt; len %d, &quot;</span>
				<span class="s">&quot;ver %d, pmkids %d, auth-encr-pairs %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">),</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">),</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">num_pmkids</span><span class="p">),</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">num_auth_encr_pair</span><span class="p">));</span>
		<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_num_pmkids</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">caps</span><span class="o">-&gt;</span><span class="n">num_pmkids</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_num_pmkids</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_do_cqm</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">s32</span> <span class="n">rssi</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">nl80211_cqm_rssi_threshold_event</span> <span class="n">event</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">thold</span><span class="p">,</span> <span class="n">hyst</span><span class="p">,</span> <span class="n">last_event</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cqm_rssi_thold</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rssi</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">infra_mode</span> <span class="o">!=</span> <span class="n">NDIS_80211_INFRA_INFRA</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">last_event</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_cqm_event_rssi</span><span class="p">;</span>
	<span class="n">thold</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cqm_rssi_thold</span><span class="p">;</span>
	<span class="n">hyst</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cqm_rssi_hyst</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&lt;</span> <span class="n">thold</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">last_event</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rssi</span> <span class="o">&lt;</span> <span class="n">last_event</span> <span class="o">-</span> <span class="n">hyst</span><span class="p">))</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">NL80211_CQM_RSSI_THRESHOLD_EVENT_LOW</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">thold</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">last_event</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">rssi</span> <span class="o">&gt;</span> <span class="n">last_event</span> <span class="o">+</span> <span class="n">hyst</span><span class="p">))</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">NL80211_CQM_RSSI_THRESHOLD_EVENT_HIGH</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_cqm_event_rssi</span> <span class="o">=</span> <span class="n">rssi</span><span class="p">;</span>
	<span class="n">cfg80211_cqm_rssi_notify</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="n">event</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define DEVICE_POLLER_JIFFIES (HZ)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_device_poller</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">rndis_wlan_private</span><span class="p">,</span>
							<span class="n">dev_poller_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">rssi</span><span class="p">,</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">update_jiffies</span> <span class="o">=</span> <span class="n">DEVICE_POLLER_JIFFIES</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="cm">/* Only check/do workaround when connected. Calling is_associated()</span>
<span class="cm">	 * also polls device with rndis_command() and catches for media link</span>
<span class="cm">	 * indications.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_associated</span><span class="p">(</span><span class="n">usbdev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Workaround bad scanning in BCM4320a devices with active</span>
<span class="cm">		 * background scanning when not associated.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">==</span> <span class="n">RNDIS_BCM4320A</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Get previous scan results */</span>
			<span class="n">rndis_check_bssid_list</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

			<span class="cm">/* Initiate new scan */</span>
			<span class="n">rndis_start_bssid_list_scan</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rssi</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_802_11_RSSI</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">rssi</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_qual</span> <span class="o">=</span> <span class="n">level_to_qual</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rssi</span><span class="p">));</span>
		<span class="n">rndis_do_cqm</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rssi</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;dev-poller: RNDIS_OID_802_11_RSSI -&gt; %d, rssi:%d, qual: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">ret</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rssi</span><span class="p">),</span> <span class="n">level_to_qual</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rssi</span><span class="p">)));</span>

	<span class="cm">/* Workaround transfer stalls on poor quality links.</span>
<span class="cm">	 * TODO: find right way to fix these stalls (as stalls do not happen</span>
<span class="cm">	 * with ndiswrapper/windows driver). */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_workaround_interval</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">last_qual</span> <span class="o">&lt;=</span> <span class="mi">25</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Decrease stats worker interval to catch stalls.</span>
<span class="cm">		 * faster. Faster than 400-500ms causes packet loss,</span>
<span class="cm">		 * Slower doesn&#39;t catch stalls fast enough.</span>
<span class="cm">		 */</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_workaround_interval</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&gt;</span> <span class="n">DEVICE_POLLER_JIFFIES</span><span class="p">)</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">DEVICE_POLLER_JIFFIES</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">j</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">update_jiffies</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>

		<span class="cm">/* Send scan OID. Use of both OIDs is required to get device</span>
<span class="cm">		 * working.</span>
<span class="cm">		 */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
			      <span class="n">RNDIS_OID_802_11_BSSID_LIST_SCAN</span><span class="p">,</span>
			      <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>

		<span class="n">len</span> <span class="o">=</span> <span class="n">CONTROL_BUFFER_SIZE</span><span class="p">;</span>
		<span class="n">buf</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">end</span><span class="p">;</span>

		<span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
				<span class="n">RNDIS_OID_802_11_BSSID_LIST</span><span class="p">,</span>
				<span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">end:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">update_jiffies</span> <span class="o">&gt;=</span> <span class="n">HZ</span><span class="p">)</span>
		<span class="n">update_jiffies</span> <span class="o">=</span> <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">update_jiffies</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">update_jiffies</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">j</span> <span class="o">-</span> <span class="n">update_jiffies</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">update_jiffies</span> <span class="o">=</span> <span class="n">j</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev_poller_work</span><span class="p">,</span>
								<span class="n">update_jiffies</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * driver/device initialization</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_copy_module_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">device_type</span> <span class="o">=</span> <span class="n">device_type</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_country</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">modparam_country</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_country</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">modparam_country</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_country</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_frameburst</span>   <span class="o">=</span> <span class="n">modparam_frameburst</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_afterburner</span>  <span class="o">=</span> <span class="n">modparam_afterburner</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_power_save</span>   <span class="o">=</span> <span class="n">modparam_power_save</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_power_output</span> <span class="o">=</span> <span class="n">modparam_power_output</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_roamtrigger</span>  <span class="o">=</span> <span class="n">modparam_roamtrigger</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_roamdelta</span>    <span class="o">=</span> <span class="n">modparam_roamdelta</span><span class="p">;</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_country</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_country</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_country</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">toupper</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_country</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="cm">/* doesn&#39;t support EU as country code, use FI instead */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_country</span><span class="p">,</span> <span class="s">&quot;EU&quot;</span><span class="p">))</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_country</span><span class="p">,</span> <span class="s">&quot;FI&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_power_save</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_power_save</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_power_save</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_power_save</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_power_output</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_power_output</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_power_output</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_power_output</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_roamtrigger</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">80</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_roamtrigger</span> <span class="o">=</span> <span class="o">-</span><span class="mi">80</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_roamtrigger</span> <span class="o">&gt;</span> <span class="o">-</span><span class="mi">60</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_roamtrigger</span> <span class="o">=</span> <span class="o">-</span><span class="mi">60</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_roamdelta</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_roamdelta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_roamdelta</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_roamdelta</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">modparam_workaround_interval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_workaround_interval</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_workaround_interval</span> <span class="o">=</span> <span class="n">modparam_workaround_interval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">unknown_early_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* copy module parameters for unknown so that iwconfig reports txpower</span>
<span class="cm">	 * and workaround parameter is copied to private structure correctly.</span>
<span class="cm">	 */</span>
	<span class="n">rndis_copy_module_params</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_UNKNOWN</span><span class="p">);</span>

	<span class="cm">/* This is unknown device, so do not try set configuration parameters.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm4320a_early_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* copy module parameters for bcm4320a so that iwconfig reports txpower</span>
<span class="cm">	 * and workaround parameter is copied to private structure correctly.</span>
<span class="cm">	 */</span>
	<span class="n">rndis_copy_module_params</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_BCM4320A</span><span class="p">);</span>

	<span class="cm">/* bcm4320a doesn&#39;t handle configuration parameters well. Try</span>
<span class="cm">	 * set any and you get partially zeroed mac and broken device.</span>
<span class="cm">	 */</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bcm4320b_early_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">rndis_copy_module_params</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_BCM4320B</span><span class="p">);</span>

	<span class="cm">/* Early initialization settings, setting these won&#39;t have effect</span>
<span class="cm">	 * if called after generic_rndis_bind().</span>
<span class="cm">	 */</span>

	<span class="n">rndis_set_config_parameter_str</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="s">&quot;Country&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_country</span><span class="p">);</span>
	<span class="n">rndis_set_config_parameter_str</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="s">&quot;FrameBursting&quot;</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_frameburst</span> <span class="o">?</span> <span class="s">&quot;1&quot;</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span><span class="p">);</span>
	<span class="n">rndis_set_config_parameter_str</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="s">&quot;Afterburner&quot;</span><span class="p">,</span>
					<span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_afterburner</span> <span class="o">?</span> <span class="s">&quot;1&quot;</span> <span class="o">:</span> <span class="s">&quot;0&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_power_save</span><span class="p">);</span>
	<span class="n">rndis_set_config_parameter_str</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="s">&quot;PowerSaveMode&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_power_output</span><span class="p">);</span>
	<span class="n">rndis_set_config_parameter_str</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="s">&quot;PwrOut&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_roamtrigger</span><span class="p">);</span>
	<span class="n">rndis_set_config_parameter_str</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="s">&quot;RoamTrigger&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">param_roamdelta</span><span class="p">);</span>
	<span class="n">rndis_set_config_parameter_str</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="s">&quot;RoamDelta&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* same as rndis_netdev_ops but with local multicast handler */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">rndis_wlan_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">usbnet_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">usbnet_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">usbnet_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">usbnet_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">rndis_wlan_set_multicast_list</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_wlan_bind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wiphy</span> <span class="o">*</span><span class="n">wiphy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="cm">/* allocate wiphy and rndis private data</span>
<span class="cm">	 * NOTE: We only support a single virtual interface, so wiphy</span>
<span class="cm">	 * and wireless_dev are somewhat synonymous for this device.</span>
<span class="cm">	 */</span>
	<span class="n">wiphy</span> <span class="o">=</span> <span class="n">wiphy_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rndis_config_ops</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">rndis_wlan_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wiphy</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">wiphy_priv</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">ieee80211_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span> <span class="o">=</span> <span class="n">wiphy</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">iftype</span> <span class="o">=</span> <span class="n">NL80211_IFTYPE_STATION</span><span class="p">;</span>

	<span class="cm">/* These have to be initialized before calling generic_rndis_bind().</span>
<span class="cm">	 * Otherwise we&#39;ll be in big trouble in rndis_wlan_early_init().</span>
<span class="cm">	 */</span>
	<span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">driver_priv</span> <span class="o">=</span> <span class="n">priv</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">usbdev</span> <span class="o">=</span> <span class="n">usbdev</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">command_lock</span><span class="p">);</span>

	<span class="cm">/* because rndis_command() sleeps we need to use workqueue */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span> <span class="o">=</span> <span class="n">create_singlethread_workqueue</span><span class="p">(</span><span class="s">&quot;rndis_wlan&quot;</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">rndis_wlan_worker</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev_poller_work</span><span class="p">,</span> <span class="n">rndis_device_poller</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">,</span> <span class="n">rndis_get_scan_results</span><span class="p">);</span>

	<span class="cm">/* try bind rndis_host */</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">generic_rndis_bind</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">intf</span><span class="p">,</span> <span class="n">FLAG_RNDIS_PHYM_WIRELESS</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* generic_rndis_bind set packet filter to multicast_all+</span>
<span class="cm">	 * promisc mode which doesn&#39;t work well for our devices (device</span>
<span class="cm">	 * picks up rssi to closest station instead of to access point).</span>
<span class="cm">	 *</span>
<span class="cm">	 * rndis_host wants to avoid all OID as much as possible</span>
<span class="cm">	 * so do promisc/multicast handling in rndis_wlan.</span>
<span class="cm">	 */</span>
	<span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rndis_wlan_netdev_ops</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">RNDIS_PACKET_TYPE_DIRECTED</span> <span class="o">|</span> <span class="n">RNDIS_PACKET_TYPE_BROADCAST</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
			       <span class="n">RNDIS_OID_GEN_CURRENT_PACKET_FILTER</span><span class="p">,</span>
			       <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">));</span>

	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rndis_query_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span>
				 <span class="n">RNDIS_OID_802_3_MAXIMUM_LIST_SIZE</span><span class="p">,</span>
				 <span class="o">&amp;</span><span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">multicast_size</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">multicast_size</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">multicast_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">multicast_size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_MULTICAST</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">IFF_MULTICAST</span><span class="p">;</span>

	<span class="cm">/* fill-out wiphy structure and register w/ cfg80211 */</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">perm_addr</span><span class="p">,</span> <span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">ETH_ALEN</span><span class="p">);</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">privid</span> <span class="o">=</span> <span class="n">rndis_wiphy_privid</span><span class="p">;</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">interface_modes</span> <span class="o">=</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_STATION</span><span class="p">)</span>
					<span class="o">|</span> <span class="n">BIT</span><span class="p">(</span><span class="n">NL80211_IFTYPE_ADHOC</span><span class="p">);</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">max_scan_ssids</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* TODO: fill-out band/encr information based on priv-&gt;caps */</span>
	<span class="n">rndis_wlan_get_caps</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">wiphy</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="n">rndis_channels</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rndis_channels</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">,</span> <span class="n">rndis_rates</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rndis_rates</span><span class="p">));</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">.</span><span class="n">channels</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">.</span><span class="n">n_channels</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rndis_channels</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">.</span><span class="n">bitrates</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">rates</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">.</span><span class="n">n_bitrates</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rndis_rates</span><span class="p">);</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">bands</span><span class="p">[</span><span class="n">IEEE80211_BAND_2GHZ</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">band</span><span class="p">;</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">signal_type</span> <span class="o">=</span> <span class="n">CFG80211_SIGNAL_TYPE_UNSPEC</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cipher_suites</span><span class="p">,</span> <span class="n">rndis_cipher_suites</span><span class="p">,</span>
						<span class="k">sizeof</span><span class="p">(</span><span class="n">rndis_cipher_suites</span><span class="p">));</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">cipher_suites</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cipher_suites</span><span class="p">;</span>
	<span class="n">wiphy</span><span class="o">-&gt;</span><span class="n">n_cipher_suites</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rndis_cipher_suites</span><span class="p">);</span>

	<span class="n">set_wiphy_dev</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">udev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wiphy_register</span><span class="p">(</span><span class="n">wiphy</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_default_iw_params</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">power_mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* set default rts/frag */</span>
	<span class="n">rndis_set_wiphy_params</span><span class="p">(</span><span class="n">wiphy</span><span class="p">,</span>
			<span class="n">WIPHY_PARAM_FRAG_THRESHOLD</span> <span class="o">|</span> <span class="n">WIPHY_PARAM_RTS_THRESHOLD</span><span class="p">);</span>

	<span class="cm">/* turn radio off on init */</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">radio_on</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">disassociate</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail:</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev_poller_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>

	<span class="n">wiphy_free</span><span class="p">(</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rndis_wlan_unbind</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">usb_interface</span> <span class="o">*</span><span class="n">intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="cm">/* turn radio off */</span>
	<span class="n">disassociate</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev_poller_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>
	<span class="n">destroy_workqueue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>

	<span class="n">rndis_unbind</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">intf</span><span class="p">);</span>

	<span class="n">wiphy_unregister</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">);</span>
	<span class="n">wiphy_free</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wdev</span><span class="p">.</span><span class="n">wiphy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_wlan_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rndis_reset</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;rndis_reset failed: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>

	<span class="cm">/* rndis_reset cleared multicast list, so restore here.</span>
<span class="cm">	   (set_multicast_list() also turns on current packet filter) */</span>
	<span class="n">set_multicast_list</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>

	<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev_poller_work</span><span class="p">,</span>
		<span class="n">round_jiffies_relative</span><span class="p">(</span><span class="n">DEVICE_POLLER_JIFFIES</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">deauthenticate</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rndis_wlan_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">usbnet</span> <span class="o">*</span><span class="n">usbdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rndis_wlan_private</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">get_rndis_wlan_priv</span><span class="p">(</span><span class="n">usbdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">filter</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">usbdev</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="s">&quot;%s()</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">disassociate</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">work_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev_poller_work</span><span class="p">);</span>
	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_work</span><span class="p">);</span>
	<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
	<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">workqueue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg80211_scan_done</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">scan_request</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set current packet filter zero to block receiving data packets from</span>
<span class="cm">	   device. */</span>
	<span class="n">filter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rndis_set_oid</span><span class="p">(</span><span class="n">usbdev</span><span class="p">,</span> <span class="n">RNDIS_OID_GEN_CURRENT_PACKET_FILTER</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">filter</span><span class="p">,</span>
								<span class="k">sizeof</span><span class="p">(</span><span class="n">filter</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">driver_info</span>	<span class="n">bcm4320b_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span>	<span class="s">&quot;Wireless RNDIS device, BCM4320b based&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span>	<span class="n">FLAG_WLAN</span> <span class="o">|</span> <span class="n">FLAG_FRAMING_RN</span> <span class="o">|</span> <span class="n">FLAG_NO_SETINT</span> <span class="o">|</span>
				<span class="n">FLAG_AVOID_UNLINK_URBS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span> <span class="o">=</span>		<span class="n">rndis_wlan_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span> <span class="o">=</span>	<span class="n">rndis_wlan_unbind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status</span> <span class="o">=</span>	<span class="n">rndis_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_fixup</span> <span class="o">=</span>	<span class="n">rndis_rx_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_fixup</span> <span class="o">=</span>	<span class="n">rndis_tx_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span>	<span class="n">rndis_wlan_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span>		<span class="n">rndis_wlan_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">early_init</span> <span class="o">=</span>	<span class="n">bcm4320b_early_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">indication</span> <span class="o">=</span>	<span class="n">rndis_wlan_indication</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">driver_info</span>	<span class="n">bcm4320a_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span>	<span class="s">&quot;Wireless RNDIS device, BCM4320a based&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span>	<span class="n">FLAG_WLAN</span> <span class="o">|</span> <span class="n">FLAG_FRAMING_RN</span> <span class="o">|</span> <span class="n">FLAG_NO_SETINT</span> <span class="o">|</span>
				<span class="n">FLAG_AVOID_UNLINK_URBS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span> <span class="o">=</span>		<span class="n">rndis_wlan_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span> <span class="o">=</span>	<span class="n">rndis_wlan_unbind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status</span> <span class="o">=</span>	<span class="n">rndis_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_fixup</span> <span class="o">=</span>	<span class="n">rndis_rx_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_fixup</span> <span class="o">=</span>	<span class="n">rndis_tx_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span>	<span class="n">rndis_wlan_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span>		<span class="n">rndis_wlan_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">early_init</span> <span class="o">=</span>	<span class="n">bcm4320a_early_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">indication</span> <span class="o">=</span>	<span class="n">rndis_wlan_indication</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">driver_info</span> <span class="n">rndis_wlan_info</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">description</span> <span class="o">=</span>	<span class="s">&quot;Wireless RNDIS device&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">flags</span> <span class="o">=</span>	<span class="n">FLAG_WLAN</span> <span class="o">|</span> <span class="n">FLAG_FRAMING_RN</span> <span class="o">|</span> <span class="n">FLAG_NO_SETINT</span> <span class="o">|</span>
				<span class="n">FLAG_AVOID_UNLINK_URBS</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bind</span> <span class="o">=</span>		<span class="n">rndis_wlan_bind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unbind</span> <span class="o">=</span>	<span class="n">rndis_wlan_unbind</span><span class="p">,</span>
	<span class="p">.</span><span class="n">status</span> <span class="o">=</span>	<span class="n">rndis_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx_fixup</span> <span class="o">=</span>	<span class="n">rndis_rx_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tx_fixup</span> <span class="o">=</span>	<span class="n">rndis_tx_fixup</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span> <span class="o">=</span>	<span class="n">rndis_wlan_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">stop</span> <span class="o">=</span>		<span class="n">rndis_wlan_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">early_init</span> <span class="o">=</span>	<span class="n">unknown_early_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">indication</span> <span class="o">=</span>	<span class="n">rndis_wlan_indication</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*-------------------------------------------------------------------------*/</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">usb_device_id</span> <span class="n">products</span> <span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#define	RNDIS_MASTER_INTERFACE \</span>
<span class="cp">	.bInterfaceClass	= USB_CLASS_COMM, \</span>
<span class="cp">	.bInterfaceSubClass	= 2 </span><span class="cm">/* ACM */</span><span class="cp">, \</span>
<span class="cp">	.bInterfaceProtocol	= 0x0ff</span>

<span class="cm">/* INF driver for these devices have DriverVer &gt;= 4.xx.xx.xx and many custom</span>
<span class="cm"> * parameters available. Chipset marked as &#39;BCM4320SKFBG&#39; in NDISwrapper-wiki.</span>
<span class="cm"> */</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">match_flags</span>	<span class="o">=</span>   <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span>
			  <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x0411</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x00bc</span><span class="p">,</span>	<span class="cm">/* Buffalo WLI-U2-KG125S */</span>
	<span class="n">RNDIS_MASTER_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bcm4320b_info</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match_flags</span>	<span class="o">=</span>   <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span>
			  <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x0baf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x011b</span><span class="p">,</span>	<span class="cm">/* U.S. Robotics USR5421 */</span>
	<span class="n">RNDIS_MASTER_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bcm4320b_info</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match_flags</span>	<span class="o">=</span>   <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span>
			  <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x050d</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x011b</span><span class="p">,</span>	<span class="cm">/* Belkin F5D7051 */</span>
	<span class="n">RNDIS_MASTER_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bcm4320b_info</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match_flags</span>	<span class="o">=</span>   <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span>
			  <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x1799</span><span class="p">,</span>	<span class="cm">/* Belkin has two vendor ids */</span>
	<span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x011b</span><span class="p">,</span>	<span class="cm">/* Belkin F5D7051 */</span>
	<span class="n">RNDIS_MASTER_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bcm4320b_info</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match_flags</span>	<span class="o">=</span>   <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span>
			  <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x13b1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x0014</span><span class="p">,</span>	<span class="cm">/* Linksys WUSB54GSv2 */</span>
	<span class="n">RNDIS_MASTER_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bcm4320b_info</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match_flags</span>	<span class="o">=</span>   <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span>
			  <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x13b1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x0026</span><span class="p">,</span>	<span class="cm">/* Linksys WUSB54GSC */</span>
	<span class="n">RNDIS_MASTER_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bcm4320b_info</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match_flags</span>	<span class="o">=</span>   <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span>
			  <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x0b05</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x1717</span><span class="p">,</span>	<span class="cm">/* Asus WL169gE */</span>
	<span class="n">RNDIS_MASTER_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bcm4320b_info</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match_flags</span>	<span class="o">=</span>   <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span>
			  <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x0a5c</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0xd11b</span><span class="p">,</span>	<span class="cm">/* Eminent EM4045 */</span>
	<span class="n">RNDIS_MASTER_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bcm4320b_info</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match_flags</span>	<span class="o">=</span>   <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span>
			  <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x1690</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x0715</span><span class="p">,</span>	<span class="cm">/* BT Voyager 1055 */</span>
	<span class="n">RNDIS_MASTER_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bcm4320b_info</span><span class="p">,</span>
<span class="p">},</span>
<span class="cm">/* These devices have DriverVer &lt; 4.xx.xx.xx and do not have any custom</span>
<span class="cm"> * parameters available, hardware probably contain older firmware version with</span>
<span class="cm"> * no way of updating. Chipset marked as &#39;BCM4320????&#39; in NDISwrapper-wiki.</span>
<span class="cm"> */</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">match_flags</span>	<span class="o">=</span>   <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span>
			  <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x13b1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x000e</span><span class="p">,</span>	<span class="cm">/* Linksys WUSB54GSv1 */</span>
	<span class="n">RNDIS_MASTER_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bcm4320a_info</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match_flags</span>	<span class="o">=</span>   <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span>
			  <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x0baf</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x0111</span><span class="p">,</span>	<span class="cm">/* U.S. Robotics USR5420 */</span>
	<span class="n">RNDIS_MASTER_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bcm4320a_info</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">match_flags</span>	<span class="o">=</span>   <span class="n">USB_DEVICE_ID_MATCH_INT_INFO</span>
			  <span class="o">|</span> <span class="n">USB_DEVICE_ID_MATCH_DEVICE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idVendor</span>		<span class="o">=</span> <span class="mh">0x0411</span><span class="p">,</span>
	<span class="p">.</span><span class="n">idProduct</span>		<span class="o">=</span> <span class="mh">0x004b</span><span class="p">,</span>	<span class="cm">/* BUFFALO WLI-USB-G54 */</span>
	<span class="n">RNDIS_MASTER_INTERFACE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver_info</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">bcm4320a_info</span><span class="p">,</span>
<span class="p">},</span>
<span class="cm">/* Generic Wireless RNDIS devices that we don&#39;t have exact</span>
<span class="cm"> * idVendor/idProduct/chip yet.</span>
<span class="cm"> */</span>
<span class="p">{</span>
	<span class="cm">/* RNDIS is MSFT&#39;s un-official variant of CDC ACM */</span>
	<span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="n">USB_CLASS_COMM</span><span class="p">,</span> <span class="mi">2</span> <span class="cm">/* ACM */</span><span class="p">,</span> <span class="mh">0x0ff</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rndis_wlan_info</span><span class="p">,</span>
<span class="p">},</span> <span class="p">{</span>
	<span class="cm">/* &quot;ActiveSync&quot; is an undocumented variant of RNDIS, used in WM5 */</span>
	<span class="n">USB_INTERFACE_INFO</span><span class="p">(</span><span class="n">USB_CLASS_MISC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver_info</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rndis_wlan_info</span><span class="p">,</span>
<span class="p">},</span>
	<span class="p">{</span> <span class="p">},</span>		<span class="c1">// END</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">usb</span><span class="p">,</span> <span class="n">products</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">usb_driver</span> <span class="n">rndis_wlan_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span>		<span class="s">&quot;rndis_wlan&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span>	<span class="n">products</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span>	<span class="n">usbnet_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disconnect</span> <span class="o">=</span>	<span class="n">usbnet_disconnect</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span>	<span class="n">usbnet_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span>	<span class="n">usbnet_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disable_hub_initiated_lpm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_usb_driver</span><span class="p">(</span><span class="n">rndis_wlan_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Bjorge Dijkstra&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Jussi Kivilinna&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for RNDIS based USB Wireless adapters&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
