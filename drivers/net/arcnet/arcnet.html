<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › arcnet › arcnet.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>arcnet.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Linux ARCnet driver - device-independent routines</span>
<span class="cm"> * </span>
<span class="cm"> * Written 1997 by David Woodhouse.</span>
<span class="cm"> * Written 1994-1999 by Avery Pennarun.</span>
<span class="cm"> * Written 1999-2000 by Martin Mares &lt;mj@ucw.cz&gt;.</span>
<span class="cm"> * Derived from skeleton.c by Donald Becker.</span>
<span class="cm"> *</span>
<span class="cm"> * Special thanks to Contemporary Controls, Inc. (www.ccontrols.com)</span>
<span class="cm"> *  for sponsoring the further development of this driver.</span>
<span class="cm"> *</span>
<span class="cm"> * **********************</span>
<span class="cm"> *</span>
<span class="cm"> * The original copyright was as follows:</span>
<span class="cm"> *</span>
<span class="cm"> * skeleton.c Written 1993 by Donald Becker.</span>
<span class="cm"> * Copyright 1993 United States Government as represented by the</span>
<span class="cm"> * Director, National Security Agency.  This software may only be used</span>
<span class="cm"> * and distributed according to the terms of the GNU General Public License as</span>
<span class="cm"> * modified by SRC, incorporated herein by reference.</span>
<span class="cm"> *</span>
<span class="cm"> * **********************</span>
<span class="cm"> * </span>
<span class="cm"> * The change log is now in a file called ChangeLog in this directory.</span>
<span class="cm"> *</span>
<span class="cm"> * Sources:</span>
<span class="cm"> *  - Crynwr arcnet.com/arcether.com packet drivers.</span>
<span class="cm"> *  - arcnet.c v0.00 dated 1/1/94 and apparently by </span>
<span class="cm"> *     Donald Becker - it didn&#39;t work :)</span>
<span class="cm"> *  - skeleton.c v0.05 dated 11/16/93 by Donald Becker</span>
<span class="cm"> *     (from Linux Kernel 1.1.45)</span>
<span class="cm"> *  - RFC&#39;s 1201 and 1051 - re: TCP/IP over ARCnet</span>
<span class="cm"> *  - The official ARCnet COM9026 data sheets (!) thanks to</span>
<span class="cm"> *     Ken Cornetet &lt;kcornete@nyx10.cs.du.edu&gt;</span>
<span class="cm"> *  - The official ARCnet COM20020 data sheets.</span>
<span class="cm"> *  - Information on some more obscure ARCnet controller chips, thanks</span>
<span class="cm"> *     to the nice people at SMSC.</span>
<span class="cm"> *  - net/inet/eth.c (from kernel 1.1.50) for header-building info.</span>
<span class="cm"> *  - Alternate Linux ARCnet source by V.Shergin &lt;vsher@sao.stavropol.su&gt;</span>
<span class="cm"> *  - Textual information and more alternate source from Joachim Koenig</span>
<span class="cm"> *     &lt;jojo@repas.de&gt;</span>
<span class="cm"> */</span>

<span class="cp">#define VERSION &quot;arcnet: v3.94 BETA 2007/02/08 - by Avery Pennarun et al.\n&quot;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;net/arp.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/arcdevice.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>

<span class="cm">/* &quot;do nothing&quot; functions for protocol drivers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">null_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufnum</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">archdr</span> <span class="o">*</span><span class="n">pkthdr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">null_build_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">daddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">null_prepare_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">archdr</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufnum</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">arcnet_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufnum</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * one ArcProto per possible proto ID.  None of the elements of</span>
<span class="cm"> * arc_proto_map are allowed to be NULL; they will get set to</span>
<span class="cm"> * arc_proto_default instead.  It also must not be NULL; if you would like</span>
<span class="cm"> * to set it to NULL, set it to &amp;arc_proto_null instead.</span>
<span class="cm"> */</span>
 <span class="k">struct</span> <span class="n">ArcProto</span> <span class="o">*</span><span class="n">arc_proto_map</span><span class="p">[</span><span class="mi">256</span><span class="p">],</span> <span class="o">*</span><span class="n">arc_proto_default</span><span class="p">,</span>
   <span class="o">*</span><span class="n">arc_bcast_proto</span><span class="p">,</span> <span class="o">*</span><span class="n">arc_raw_proto</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">ArcProto</span> <span class="n">arc_proto_null</span> <span class="o">=</span>
<span class="p">{</span>
	<span class="p">.</span><span class="n">suffix</span>		<span class="o">=</span> <span class="sc">&#39;?&#39;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mtu</span>		<span class="o">=</span> <span class="n">XMTU</span><span class="p">,</span>
	<span class="p">.</span><span class="n">is_ip</span>          <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rx</span>		<span class="o">=</span> <span class="n">null_rx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">build_header</span>	<span class="o">=</span> <span class="n">null_build_header</span><span class="p">,</span>
	<span class="p">.</span><span class="n">prepare_tx</span>	<span class="o">=</span> <span class="n">null_prepare_tx</span><span class="p">,</span>
	<span class="p">.</span><span class="n">continue_tx</span>    <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ack_tx</span>         <span class="o">=</span> <span class="nb">NULL</span>
<span class="p">};</span>

<span class="cm">/* Exported function prototypes */</span>
<span class="kt">int</span> <span class="n">arcnet_debug</span> <span class="o">=</span> <span class="n">ARCNET_DEBUG</span><span class="p">;</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">arc_proto_map</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">arc_proto_default</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">arc_bcast_proto</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">arc_raw_proto</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">arcnet_unregister_proto</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">arcnet_debug</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">alloc_arcdev</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">arcnet_interrupt</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">arcnet_open</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">arcnet_close</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">arcnet_send_packet</span><span class="p">);</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">arcnet_timeout</span><span class="p">);</span>

<span class="cm">/* Internal function prototypes */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arcnet_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">daddr</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">saddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arcnet_rebuild_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">go_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="n">ARCNET_DEBUG</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">arcnet_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">arcnet_debug</span> <span class="o">=</span> <span class="n">debug</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;arcnet loaded.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef ALPHA_WARNING</span>
	<span class="n">BUGLVL</span><span class="p">(</span><span class="n">D_EXTRA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;arcnet: ***</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;arcnet: * Read arcnet.txt for important release notes!</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;arcnet: *</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;arcnet: * This is an ALPHA version! (Last stable release: v3.02)  E-mail</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;arcnet: * me if you have any questions, comments, or bug reports.</span><span class="se">\n</span><span class="s">&quot;</span>
		       <span class="s">&quot;arcnet: ***</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="cm">/* initialize the protocol map */</span>
	<span class="n">arc_raw_proto</span> <span class="o">=</span> <span class="n">arc_proto_default</span> <span class="o">=</span> <span class="n">arc_bcast_proto</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arc_proto_null</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span>
		<span class="n">arc_proto_map</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">arc_proto_default</span><span class="p">;</span>

	<span class="n">BUGLVL</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">)</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;arcnet: struct sizes: %Zd %Zd %Zd %Zd %Zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">arc_hardware</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">arc_rfc1201</span><span class="p">),</span>
		<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">arc_rfc1051</span><span class="p">),</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">arc_eth_encap</span><span class="p">),</span>
		   <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">archdr</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">arcnet_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">arcnet_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">arcnet_exit</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Dump the contents of an sk_buff</span>
<span class="cm"> */</span>
<span class="cp">#if ARCNET_DEBUG_MAX &amp; D_SKB</span>
<span class="kt">void</span> <span class="nf">arcnet_dump_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">hdr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="cm">/* dump the packet */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">),</span> <span class="s">&quot;%6s:%s skb-&gt;data:&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
		       <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">arcnet_dump_skb</span><span class="p">);</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * Dump the contents of an ARCnet buffer</span>
<span class="cm"> */</span>
<span class="cp">#if (ARCNET_DEBUG_MAX &amp; (D_RX | D_TX))</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcnet_dump_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufnum</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">desc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">take_arcnet_lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">uint8_t</span> <span class="n">buf</span><span class="p">[</span><span class="mi">512</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">hdr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="cm">/* hw.copy_from_card expects IRQ context so take the IRQ lock</span>
<span class="cm">	   to keep it single threaded */</span>
	<span class="k">if</span><span class="p">(</span><span class="n">take_arcnet_lock</span><span class="p">)</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">copy_from_card</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bufnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="mi">512</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">take_arcnet_lock</span><span class="p">)</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* if the offset[0] byte is nonzero, this is a 256-byte packet */</span>
	<span class="n">length</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">?</span> <span class="mi">256</span> <span class="o">:</span> <span class="mi">512</span><span class="p">);</span>

	<span class="cm">/* dump the packet */</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="n">hdr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hdr</span><span class="p">),</span> <span class="s">&quot;%6s:%s packet dump:&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">desc</span><span class="p">);</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_DEBUG</span><span class="p">,</span> <span class="n">hdr</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span>
		       <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="cp">#define arcnet_dump_packet(dev, bufnum, desc,take_arcnet_lock) do { } while (0)</span>

<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * Unregister a protocol driver from the arc_proto_map.  Protocol drivers</span>
<span class="cm"> * are responsible for registering themselves, but the unregister routine</span>
<span class="cm"> * is pretty generic so we&#39;ll do it here.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">arcnet_unregister_proto</span><span class="p">(</span><span class="k">struct</span> <span class="n">ArcProto</span> <span class="o">*</span><span class="n">proto</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arc_proto_default</span> <span class="o">==</span> <span class="n">proto</span><span class="p">)</span>
		<span class="n">arc_proto_default</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arc_proto_null</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arc_bcast_proto</span> <span class="o">==</span> <span class="n">proto</span><span class="p">)</span>
		<span class="n">arc_bcast_proto</span> <span class="o">=</span> <span class="n">arc_proto_default</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arc_raw_proto</span> <span class="o">==</span> <span class="n">proto</span><span class="p">)</span>
		<span class="n">arc_raw_proto</span> <span class="o">=</span> <span class="n">arc_proto_default</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arc_proto_map</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">==</span> <span class="n">proto</span><span class="p">)</span>
			<span class="n">arc_proto_map</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">arc_proto_default</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Add a buffer to the queue.  Only the interrupt handler is allowed to do</span>
<span class="cm"> * this, unless interrupts are disabled.</span>
<span class="cm"> * </span>
<span class="cm"> * Note: we don&#39;t check for a full queue, since there aren&#39;t enough buffers</span>
<span class="cm"> * to more than fill it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_arcbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">buf_queue</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">first_free_buf</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">bufnum</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">first_free_buf</span> <span class="o">%=</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">BUGLVL</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;release_arcbuf: freed #%d; buffer queue is now: &quot;</span><span class="p">,</span>
		       <span class="n">bufnum</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_buf</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">first_free_buf</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">BUGMSG2</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;#%d &quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">buf_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">BUGMSG2</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Get a buffer from the queue.  If this returns -1, there are no buffers</span>
<span class="cm"> * available.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_arcbuf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">buf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">buf_lock</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* already in this function */</span>
		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_NORMAL</span><span class="p">,</span> <span class="s">&quot;get_arcbuf: overlap (%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">buf_lock</span><span class="p">.</span><span class="n">counter</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>			<span class="cm">/* we can continue */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_buf</span> <span class="o">&gt;=</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_buf</span> <span class="o">-=</span> <span class="mi">5</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_buf</span> <span class="o">==</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">first_free_buf</span><span class="p">)</span>
			<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_NORMAL</span><span class="p">,</span> <span class="s">&quot;get_arcbuf: BUG: no buffers are available??</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">buf</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">buf_queue</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_buf</span><span class="o">++</span><span class="p">];</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_buf</span> <span class="o">%=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>


	<span class="n">BUGLVL</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;get_arcbuf: got #%d; buffer queue is now: &quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_buf</span><span class="p">;</span> <span class="n">i</span> <span class="o">!=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">first_free_buf</span><span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">5</span><span class="p">)</span>
			<span class="n">BUGMSG2</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;#%d &quot;</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">buf_queue</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">BUGMSG2</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">buf_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">choose_mtu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">mtu</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>

	<span class="cm">/* choose the smallest MTU of all available encaps */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arc_proto_map</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">arc_proto_null</span> <span class="o">&amp;&amp;</span>
		    <span class="n">arc_proto_map</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&lt;</span> <span class="n">mtu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mtu</span> <span class="o">=</span> <span class="n">arc_proto_map</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mtu</span> <span class="o">==</span> <span class="mi">65535</span> <span class="o">?</span> <span class="n">XMTU</span> <span class="o">:</span> <span class="n">mtu</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">header_ops</span> <span class="n">arcnet_header_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">arcnet_header</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rebuild</span> <span class="o">=</span> <span class="n">arcnet_rebuild_header</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">arcnet_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>	<span class="o">=</span> <span class="n">arcnet_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>	<span class="o">=</span> <span class="n">arcnet_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">arcnet_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> <span class="o">=</span> <span class="n">arcnet_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Setup a struct device for ARCnet. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcdev_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ARPHRD_ARCNET</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arcnet_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arcnet_header_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">archdr</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">choose_mtu</span><span class="p">();</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span> <span class="o">=</span> <span class="n">ARCNET_ALEN</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">broadcast</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x00</span><span class="p">;</span>	<span class="cm">/* for us, broadcasts are address 0 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>

	<span class="cm">/* New-style flags. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IFF_BROADCAST</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">alloc_arcdev</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">arcnet_local</span><span class="p">),</span>
			   <span class="n">name</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">name</span> <span class="o">?</span> <span class="n">name</span> <span class="o">:</span> <span class="s">&quot;arc%d&quot;</span><span class="p">,</span> <span class="n">arcdev_setup</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Open/initialize the board.  This is called sometime after booting when</span>
<span class="cm"> * the &#39;ifconfig&#39; program is run.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine should set everything up anew at each open, even registers</span>
<span class="cm"> * that &quot;should&quot; only need to be set once at boot, so that there is</span>
<span class="cm"> * non-reboot way to recover if something goes wrong.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">arcnet_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="n">newmtu</span><span class="p">,</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_INIT</span><span class="p">,</span><span class="s">&quot;opened.&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">owner</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">BUGLVL</span><span class="p">(</span><span class="n">D_PROTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_PROTO</span><span class="p">,</span> <span class="s">&quot;protocol map (default is &#39;%c&#39;): &quot;</span><span class="p">,</span>
		       <span class="n">arc_proto_default</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span>
			<span class="n">BUGMSG2</span><span class="p">(</span><span class="n">D_PROTO</span><span class="p">,</span> <span class="s">&quot;%c&quot;</span><span class="p">,</span> <span class="n">arc_proto_map</span><span class="p">[</span><span class="n">count</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">);</span>
		<span class="n">BUGMSG2</span><span class="p">(</span><span class="n">D_PROTO</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_INIT</span><span class="p">,</span> <span class="s">&quot;arcnet_open: resetting card.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* try to put the card in a defined state - if it fails the first</span>
<span class="cm">	 * time, actually reset it.</span>
<span class="cm">	 */</span>
	<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ARCRESET</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ARCRESET</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_module_put</span><span class="p">;</span>

	<span class="n">newmtu</span> <span class="o">=</span> <span class="n">choose_mtu</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">newmtu</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">newmtu</span><span class="p">;</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_INIT</span><span class="p">,</span> <span class="s">&quot;arcnet_open: mtu: %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">);</span>

	<span class="cm">/* autodetect the encapsulation for each host. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">default_proto</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">default_proto</span><span class="p">));</span>

	<span class="cm">/* the broadcast address is special - use the &#39;bcast&#39; protocol */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">count</span> <span class="o">&lt;</span> <span class="mi">256</span><span class="p">;</span> <span class="n">count</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arc_proto_map</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">==</span> <span class="n">arc_bcast_proto</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">default_proto</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* initialize buffers */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">buf_lock</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_buf</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">first_free_buf</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">release_arcbuf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">release_arcbuf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">release_arcbuf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">release_arcbuf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rfc1201</span><span class="p">.</span><span class="n">sequence</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* bring up the hardware driver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">open</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_NORMAL</span><span class="p">,</span> <span class="s">&quot;WARNING!  Station address 00 is reserved &quot;</span>
		       <span class="s">&quot;for broadcasts!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_NORMAL</span><span class="p">,</span> <span class="s">&quot;WARNING!  Station address FF may confuse &quot;</span>
		       <span class="s">&quot;DOS networking programs!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DEBUG</span><span class="p">,</span> <span class="s">&quot;%s: %d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ASTATUS</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">RESETflag</span><span class="p">)</span> <span class="p">{</span>
	  	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DEBUG</span><span class="p">,</span> <span class="s">&quot;%s: %d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
		<span class="n">ACOMMAND</span><span class="p">(</span><span class="n">CFLAGScmd</span> <span class="o">|</span> <span class="n">RESETclear</span><span class="p">);</span>
	<span class="p">}</span>


	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DEBUG</span><span class="p">,</span> <span class="s">&quot;%s: %d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* make sure we&#39;re ready to receive IRQ&#39;s. */</span>
	<span class="n">AINTMASK</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>		<span class="cm">/* give it time to set the mask before</span>
<span class="cm">				 * we reset it again. (may not even be</span>
<span class="cm">				 * necessary)</span>
<span class="cm">				 */</span>
	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DEBUG</span><span class="p">,</span> <span class="s">&quot;%s: %d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span> <span class="o">=</span> <span class="n">NORXflag</span> <span class="o">|</span> <span class="n">RECONflag</span><span class="p">;</span>
	<span class="n">AINTMASK</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span><span class="p">);</span>
	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DEBUG</span><span class="p">,</span> <span class="s">&quot;%s: %d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_module_put:</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">owner</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* The inverse routine to arcnet_open - shuts down the card. */</span>
<span class="kt">int</span> <span class="nf">arcnet_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* flush TX and disable RX */</span>
	<span class="n">AINTMASK</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">ACOMMAND</span><span class="p">(</span><span class="n">NOTXcmd</span><span class="p">);</span>	<span class="cm">/* stop transmit */</span>
	<span class="n">ACOMMAND</span><span class="p">(</span><span class="n">NORXcmd</span><span class="p">);</span>	<span class="cm">/* disable receive */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* shut down the card */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">owner</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcnet_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">daddr</span><span class="p">,</span>
			 <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">saddr</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">uint8_t</span> <span class="n">_daddr</span><span class="p">,</span> <span class="n">proto_num</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ArcProto</span> <span class="o">*</span><span class="n">proto</span><span class="p">;</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span>
	    <span class="s">&quot;create header from %d to %d; protocol %d (%Xh); size %u.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">saddr</span> <span class="o">?</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">saddr</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	       <span class="n">daddr</span> <span class="o">?</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">daddr</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
	       <span class="n">type</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="o">!=</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">len</span> <span class="o">!=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">)</span>
		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_NORMAL</span><span class="p">,</span> <span class="s">&quot;arcnet_header: Yikes!  skb-&gt;len(%d) != len(%d)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>


  	<span class="cm">/* Type is host order - ? */</span>
  	<span class="k">if</span><span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ETH_P_ARCNET</span><span class="p">)</span> <span class="p">{</span>
  		<span class="n">proto</span> <span class="o">=</span> <span class="n">arc_raw_proto</span><span class="p">;</span>
  		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DEBUG</span><span class="p">,</span> <span class="s">&quot;arc_raw_proto used. proto=&#39;%c&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">proto</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">);</span>
  		<span class="n">_daddr</span> <span class="o">=</span> <span class="n">daddr</span> <span class="o">?</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">daddr</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
  	<span class="p">}</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">daddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * if the dest addr isn&#39;t provided, we can&#39;t choose an encapsulation!</span>
<span class="cm">		 * Store the packet type (eg. ETH_P_IP) for now, and we&#39;ll push on a</span>
<span class="cm">		 * real header when we do rebuild_header.</span>
<span class="cm">		 */</span>
		<span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
		<span class="cm">/*</span>
<span class="cm">		 * XXX: Why not use skb-&gt;mac_len?</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">mac_header</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
			<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_NORMAL</span><span class="p">,</span> <span class="s">&quot;arcnet_header: Yikes!  diff (%d) is not 2!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">mac_header</span><span class="p">));</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="p">;</span>	<span class="cm">/* return error -- can&#39;t transmit yet! */</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* otherwise, we can just add the header as usual. */</span>
		<span class="n">_daddr</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">daddr</span><span class="p">;</span>
		<span class="n">proto_num</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">default_proto</span><span class="p">[</span><span class="n">_daddr</span><span class="p">];</span>
		<span class="n">proto</span> <span class="o">=</span> <span class="n">arc_proto_map</span><span class="p">[</span><span class="n">proto_num</span><span class="p">];</span>
		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;building header for %02Xh using protocol &#39;%c&#39;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">proto_num</span><span class="p">,</span> <span class="n">proto</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">arc_proto_null</span> <span class="o">&amp;&amp;</span> <span class="n">arc_bcast_proto</span> <span class="o">!=</span> <span class="n">proto</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;actually, let&#39;s use &#39;%c&#39; instead.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">arc_bcast_proto</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">);</span>
			<span class="n">proto</span> <span class="o">=</span> <span class="n">arc_bcast_proto</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">proto</span><span class="o">-&gt;</span><span class="n">build_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">_daddr</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* </span>
<span class="cm"> * Rebuild the ARCnet hard header. This is called after an ARP (or in the</span>
<span class="cm"> * future other address resolution) has completed on this sk_buff. We now</span>
<span class="cm"> * let ARP fill in the destination field.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">arcnet_rebuild_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* default is failure */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">;</span>
	<span class="kt">uint8_t</span> <span class="n">daddr</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ArcProto</span> <span class="o">*</span><span class="n">proto</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * XXX: Why not use skb-&gt;mac_len?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">mac_header</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_NORMAL</span><span class="p">,</span>
		       <span class="s">&quot;rebuild_header: shouldn&#39;t be here! (hdrsize=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">network_header</span> <span class="o">-</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">mac_header</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">type</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;rebuild header for protocol %Xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">type</span> <span class="o">==</span> <span class="n">ETH_P_IP</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_INET</span>
		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;rebuild header for ethernet protocol %Xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">arp_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">daddr</span><span class="p">,</span> <span class="n">skb</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot; rebuilt: dest is %d; protocol %Xh</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">daddr</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_NORMAL</span><span class="p">,</span>
		       <span class="s">&quot;I don&#39;t understand ethernet protocol %Xh addresses!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">type</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if we couldn&#39;t resolve the address... give up. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">status</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* add the _real_ header this time! */</span>
	<span class="n">proto</span> <span class="o">=</span> <span class="n">arc_proto_map</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">default_proto</span><span class="p">[</span><span class="n">daddr</span><span class="p">]];</span>
	<span class="n">proto</span><span class="o">-&gt;</span><span class="n">build_header</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">daddr</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* success */</span>
<span class="p">}</span>



<span class="cm">/* Called by the kernel in order to transmit a packet. */</span>
<span class="n">netdev_tx_t</span> <span class="nf">arcnet_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">archdr</span> <span class="o">*</span><span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">arc_rfc1201</span> <span class="o">*</span><span class="n">soft</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ArcProto</span> <span class="o">*</span><span class="n">proto</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txbuf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">freeskb</span><span class="p">,</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span>
	       <span class="s">&quot;transmit requested (status=%Xh, txbufs=%d/%d, len=%d, protocol %x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ASTATUS</span><span class="p">(),</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_tx</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>

	<span class="n">pkt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">archdr</span> <span class="o">*</span><span class="p">)</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">soft</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="o">-&gt;</span><span class="n">soft</span><span class="p">.</span><span class="n">rfc1201</span><span class="p">;</span>
	<span class="n">proto</span> <span class="o">=</span> <span class="n">arc_proto_map</span><span class="p">[</span><span class="n">soft</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">];</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_SKB_SIZE</span><span class="p">,</span> <span class="s">&quot;skb: transmitting %d bytes to %02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">pkt</span><span class="o">-&gt;</span><span class="n">hard</span><span class="p">.</span><span class="n">dest</span><span class="p">);</span>
	<span class="n">BUGLVL</span><span class="p">(</span><span class="n">D_SKB</span><span class="p">)</span> <span class="n">arcnet_dump_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="s">&quot;tx&quot;</span><span class="p">);</span>

	<span class="cm">/* fits in one packet? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">ARC_HDR_SIZE</span> <span class="o">&gt;</span> <span class="n">XMTU</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">proto</span><span class="o">-&gt;</span><span class="n">continue_tx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_NORMAL</span><span class="p">,</span> <span class="s">&quot;fixme: packet too large: compensating badly!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>	<span class="cm">/* don&#39;t try again */</span>
	<span class="p">}</span>

	<span class="cm">/* We&#39;re busy transmitting a packet... */</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">AINTMASK</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_tx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">txbuf</span> <span class="o">=</span> <span class="n">get_arcbuf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">txbuf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txbuf</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">proto</span><span class="o">-&gt;</span><span class="n">prepare_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pkt</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">txbuf</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">proto</span><span class="o">-&gt;</span><span class="n">ack_tx</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* done right away and we don&#39;t want to acknowledge</span>
<span class="cm">			   the package later - forget about it now */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
			<span class="n">freeskb</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* do it the &#39;split&#39; way */</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="n">proto</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">.</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">.</span><span class="n">pkt</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">;</span>

			<span class="n">freeskb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">proto</span><span class="o">-&gt;</span><span class="n">continue_tx</span> <span class="o">&amp;&amp;</span>
			    <span class="n">proto</span><span class="o">-&gt;</span><span class="n">continue_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">txbuf</span><span class="p">))</span> <span class="p">{</span>
			  <span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_NORMAL</span><span class="p">,</span>
				 <span class="s">&quot;bug! continue_tx finished the first time! &quot;</span>
				 <span class="s">&quot;(proto=&#39;%c&#39;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">proto</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_tx</span> <span class="o">=</span> <span class="n">txbuf</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="n">freeskb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DEBUG</span><span class="p">,</span> <span class="s">&quot;%s: %d: %s, status: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">ASTATUS</span><span class="p">());</span>
	<span class="cm">/* make sure we didn&#39;t ignore a TX IRQ while we were in here */</span>
	<span class="n">AINTMASK</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DEBUG</span><span class="p">,</span> <span class="s">&quot;%s: %d: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">__func__</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span> <span class="o">|=</span> <span class="n">TXFREEflag</span><span class="o">|</span><span class="n">EXCNAKflag</span><span class="p">;</span>
	<span class="n">AINTMASK</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span><span class="p">);</span>
	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DEBUG</span><span class="p">,</span> <span class="s">&quot;%s: %d: %s, status: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">ASTATUS</span><span class="p">());</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">freeskb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>		<span class="cm">/* no need to try again */</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Actually start transmitting a packet that was loaded into a buffer</span>
<span class="cm"> * by prepare_tx.  This should _only_ be called by the interrupt handler.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">go_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;go_tx: status=%Xh, intmask=%Xh, next_tx=%d, cur_tx=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ASTATUS</span><span class="p">(),</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_tx</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_tx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">BUGLVL</span><span class="p">(</span><span class="n">D_TX</span><span class="p">)</span> <span class="n">arcnet_dump_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_tx</span><span class="p">,</span> <span class="s">&quot;go_tx&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_tx</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* start sending */</span>
	<span class="n">ACOMMAND</span><span class="p">(</span><span class="n">TXcmd</span> <span class="o">|</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lasttrans_dest</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lastload_dest</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">lastload_dest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">excnak_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span> <span class="o">|=</span> <span class="n">TXFREEflag</span><span class="o">|</span><span class="n">EXCNAKflag</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Called by the kernel when transmit times out */</span>
<span class="kt">void</span> <span class="nf">arcnet_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">ASTATUS</span><span class="p">();</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TXFREEflag</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* transmit _DID_ finish */</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot; - missed IRQ?&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timed_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ACOMMAND</span><span class="p">(</span><span class="n">NOTXcmd</span> <span class="o">|</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* make sure we didn&#39;t miss a TX or a EXC NAK IRQ */</span>
	<span class="n">AINTMASK</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span> <span class="o">|=</span> <span class="n">TXFREEflag</span><span class="o">|</span><span class="n">EXCNAKflag</span><span class="p">;</span>
	<span class="n">AINTMASK</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span><span class="p">);</span>
	
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_timeout</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_EXTRA</span><span class="p">,</span> <span class="s">&quot;tx timed out%s (status=%Xh, intmask=%Xh, dest=%02Xh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">msg</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lasttrans_dest</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_timeout</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * The typical workload of the driver: Handle the network interface</span>
<span class="cm"> * interrupts. Establish which device needs attention, and call the correct</span>
<span class="cm"> * chipset interrupt handler.</span>
<span class="cm"> */</span>
<span class="n">irqreturn_t</span> <span class="nf">arcnet_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">recbuf</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">diagstatus</span><span class="p">,</span> <span class="n">didsomething</span><span class="p">,</span> <span class="n">boguscount</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;in arcnet_interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="p">);</span>
		
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * RESET flag was enabled - if device is not running, we must clear it right</span>
<span class="cm">	 * away (but nothing else).</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ASTATUS</span><span class="p">()</span> <span class="o">&amp;</span> <span class="n">RESETflag</span><span class="p">)</span>
			<span class="n">ACOMMAND</span><span class="p">(</span><span class="n">CFLAGScmd</span> <span class="o">|</span> <span class="n">RESETclear</span><span class="p">);</span>
		<span class="n">AINTMASK</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;in arcnet_inthandler (status=%Xh, intmask=%Xh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ASTATUS</span><span class="p">(),</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span><span class="p">);</span>

	<span class="n">boguscount</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ASTATUS</span><span class="p">();</span>
                <span class="n">diagstatus</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

		<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DEBUG</span><span class="p">,</span> <span class="s">&quot;%s: %d: %s: status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__FILE__</span><span class="p">,</span><span class="n">__LINE__</span><span class="p">,</span><span class="n">__func__</span><span class="p">,</span><span class="n">status</span><span class="p">);</span>
		<span class="n">didsomething</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * RESET flag was enabled - card is resetting and if RX is</span>
<span class="cm">		 * disabled, it&#39;s NOT because we just got a packet.</span>
<span class="cm">		 * </span>
<span class="cm">		 * The card is in an undefined state.  Clear it out and start over.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">RESETflag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_NORMAL</span><span class="p">,</span> <span class="s">&quot;spurious reset (status=%Xh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="n">arcnet_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">arcnet_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="cm">/* get out of the interrupt handler! */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* </span>
<span class="cm">		 * RX is inhibited - we must have received something. Prepare to</span>
<span class="cm">		 * receive into the next buffer.</span>
<span class="cm">		 * </span>
<span class="cm">		 * We don&#39;t actually copy the received packet from the card until</span>
<span class="cm">		 * after the transmit handler runs (and possibly launches the next</span>
<span class="cm">		 * tx); this should improve latency slightly if we get both types</span>
<span class="cm">		 * of interrupts at once. </span>
<span class="cm">		 */</span>
		<span class="n">recbuf</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">NORXflag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">recbuf</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">;</span>
			<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;Buffer #%d: receive irq (status=%Xh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">recbuf</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">=</span> <span class="n">get_arcbuf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;enabling receive to buffer #%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_rx</span><span class="p">);</span>
				<span class="n">ACOMMAND</span><span class="p">(</span><span class="n">RXcmd</span> <span class="o">|</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_rx</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span> <span class="n">RXbcasts</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">didsomething</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">((</span><span class="n">diagstatus</span> <span class="o">&amp;</span> <span class="n">EXCNAKflag</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;EXCNAK IRQ (diagstat=%Xh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">diagstatus</span><span class="p">);</span>

                        <span class="n">ACOMMAND</span><span class="p">(</span><span class="n">NOTXcmd</span><span class="p">);</span>      <span class="cm">/* disable transmit */</span>
                        <span class="n">lp</span><span class="o">-&gt;</span><span class="n">excnak_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

                        <span class="n">ACOMMAND</span><span class="p">(</span><span class="n">EXCNAKclear</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">EXCNAKflag</span><span class="p">);</span>
                        <span class="n">didsomething</span><span class="o">++</span><span class="p">;</span>
                <span class="p">}</span>


		<span class="cm">/* a transmit finished, and we&#39;re interested in it. */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">TXFREEflag</span><span class="p">)</span> <span class="o">||</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">timed_out</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TXFREEflag</span><span class="o">|</span><span class="n">EXCNAKflag</span><span class="p">);</span>

			<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;TX IRQ (stat=%Xh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">timed_out</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TXACKflag</span><span class="p">))</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lasttrans_dest</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_EXTRA</span><span class="p">,</span>
						       <span class="s">&quot;transmit was not acknowledged! &quot;</span>
						       <span class="s">&quot;(status=%Xh, dest=%02Xh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">status</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lasttrans_dest</span><span class="p">);</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
						<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span>
						       <span class="s">&quot;broadcast was not acknowledged; that&#39;s normal &quot;</span>
						       <span class="s">&quot;(status=%Xh, dest=%02Xh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						       <span class="n">status</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">lasttrans_dest</span><span class="p">);</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">.</span><span class="n">proto</span> <span class="o">&amp;&amp;</span>
				    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">.</span><span class="n">proto</span><span class="o">-&gt;</span><span class="n">ack_tx</span><span class="p">)</span> <span class="p">{</span>
				  <span class="kt">int</span> <span class="n">ackstatus</span><span class="p">;</span>
				  <span class="k">if</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TXACKflag</span><span class="p">)</span>
                                    <span class="n">ackstatus</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
                                  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">excnak_pending</span><span class="p">)</span>
                                    <span class="n">ackstatus</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
                                  <span class="k">else</span>
                                    <span class="n">ackstatus</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>

                                  <span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">.</span><span class="n">proto</span>
                                    <span class="o">-&gt;</span><span class="n">ack_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ackstatus</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">release_arcbuf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span><span class="p">);</span>

			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">timed_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">didsomething</span><span class="o">++</span><span class="p">;</span>

			<span class="cm">/* send another packet if there is one */</span>
			<span class="n">go_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="cm">/* continue a split packet, if any */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">.</span><span class="n">proto</span> <span class="o">&amp;&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">.</span><span class="n">proto</span><span class="o">-&gt;</span><span class="n">continue_tx</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">txbuf</span> <span class="o">=</span> <span class="n">get_arcbuf</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">txbuf</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">.</span><span class="n">proto</span><span class="o">-&gt;</span><span class="n">continue_tx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">txbuf</span><span class="p">))</span> <span class="p">{</span>
						<span class="cm">/* that was the last segment */</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">.</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
						<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">.</span><span class="n">proto</span><span class="o">-&gt;</span><span class="n">ack_tx</span><span class="p">)</span>
						  <span class="p">{</span>
						    <span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">.</span><span class="n">skb</span><span class="p">);</span>
						    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">outgoing</span><span class="p">.</span><span class="n">proto</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
						  <span class="p">}</span>
					<span class="p">}</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">next_tx</span> <span class="o">=</span> <span class="n">txbuf</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="cm">/* inform upper layers of idleness, if necessary */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">cur_tx</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/* now process the received packet, if any */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">recbuf</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">BUGLVL</span><span class="p">(</span><span class="n">D_RX</span><span class="p">)</span> <span class="n">arcnet_dump_packet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">recbuf</span><span class="p">,</span> <span class="s">&quot;rx irq&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

			<span class="n">arcnet_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">recbuf</span><span class="p">);</span>
			<span class="n">release_arcbuf</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">recbuf</span><span class="p">);</span>

			<span class="n">didsomething</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span> <span class="o">&amp;</span> <span class="n">RECONflag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ACOMMAND</span><span class="p">(</span><span class="n">CFLAGScmd</span> <span class="o">|</span> <span class="n">CONFIGclear</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>

			<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_RECON</span><span class="p">,</span> <span class="s">&quot;Network reconfiguration detected (status=%Xh)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">status</span><span class="p">);</span>
			<span class="cm">/* MYRECON bit is at bit 7 of diagstatus */</span>
			<span class="k">if</span><span class="p">(</span><span class="n">diagstatus</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_RECON</span><span class="p">,</span><span class="s">&quot;Put out that recon myself</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="cm">/* is the RECON info empty or old? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">first_recon</span> <span class="o">||</span> <span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_recon</span> <span class="o">||</span>
			    <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_recon</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">network_down</span><span class="p">)</span>
					<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_NORMAL</span><span class="p">,</span> <span class="s">&quot;reconfiguration detected: cabling restored?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">first_recon</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_recon</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_recons</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">network_down</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;recon: clearing counters.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* add to current RECON counter */</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_recon</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
				<span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_recons</span><span class="o">++</span><span class="p">;</span>

				<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;recon: counter=%d, time=%lds, net=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_recons</span><span class="p">,</span>
				 <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_recon</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">first_recon</span><span class="p">)</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">,</span>
				       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">network_down</span><span class="p">);</span>

				<span class="cm">/* if network is marked up;</span>
<span class="cm">				 * and first_recon and last_recon are 60+ apart;</span>
<span class="cm">				 * and the average no. of recons counted is</span>
<span class="cm">				 *    &gt; RECON_THRESHOLD/min;</span>
<span class="cm">				 * then print a warning message.</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">network_down</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_recon</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">first_recon</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">60</span> <span class="o">&amp;&amp;</span>
				    <span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_recons</span> <span class="o">&gt;=</span> <span class="n">RECON_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">network_down</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_NORMAL</span><span class="p">,</span> <span class="s">&quot;many reconfigurations detected: cabling problem?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">network_down</span> <span class="o">&amp;&amp;</span>
					   <span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_recon</span> <span class="o">-</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">first_recon</span> <span class="o">&gt;</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">60</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* reset counters if we&#39;ve gone for over a minute. */</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">first_recon</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_recon</span><span class="p">;</span>
					<span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_recons</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">network_down</span> <span class="o">&amp;&amp;</span>
				<span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_recon</span> <span class="o">+</span> <span class="n">HZ</span> <span class="o">*</span> <span class="mi">10</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">network_down</span><span class="p">)</span>
				<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_NORMAL</span><span class="p">,</span> <span class="s">&quot;cabling restored?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">first_recon</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">last_recon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">num_recons</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">network_down</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;not recon: clearing counters anyway.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span><span class="n">didsomething</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">|=</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">boguscount</span> <span class="o">&amp;&amp;</span> <span class="n">didsomething</span><span class="p">);</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;arcnet_interrupt complete (status=%Xh, count=%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">ASTATUS</span><span class="p">(),</span> <span class="n">boguscount</span><span class="p">);</span>
	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>


	<span class="n">AINTMASK</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">AINTMASK</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">intmask</span><span class="p">);</span>
	
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * This is a generic packet receiver that calls arcnet??_rx depending on the</span>
<span class="cm"> * protocol ID found.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">arcnet_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">archdr</span> <span class="n">pkt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">arc_rfc1201</span> <span class="o">*</span><span class="n">soft</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="n">ofs</span><span class="p">;</span>

	<span class="n">soft</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">.</span><span class="n">soft</span><span class="p">.</span><span class="n">rfc1201</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">copy_from_card</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bufnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ARC_HDR_SIZE</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">ofs</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">length</span> <span class="o">=</span> <span class="mi">256</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ofs</span> <span class="o">=</span> <span class="n">pkt</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">length</span> <span class="o">=</span> <span class="mi">512</span> <span class="o">-</span> <span class="n">ofs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get the full header, if possible */</span>
	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">soft</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">length</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">copy_from_card</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bufnum</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">soft</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">soft</span><span class="p">));</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pkt</span><span class="p">.</span><span class="n">soft</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pkt</span><span class="p">.</span><span class="n">soft</span><span class="p">));</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">copy_from_card</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bufnum</span><span class="p">,</span> <span class="n">ofs</span><span class="p">,</span> <span class="n">soft</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_DURING</span><span class="p">,</span> <span class="s">&quot;Buffer #%d: received packet from %02Xh to %02Xh &quot;</span>
	       <span class="s">&quot;(%d+4 bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">bufnum</span><span class="p">,</span> <span class="n">pkt</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">source</span><span class="p">,</span> <span class="n">pkt</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">dest</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">length</span> <span class="o">+</span> <span class="n">ARC_HDR_SIZE</span><span class="p">;</span>

	<span class="cm">/* call the right receiver for the protocol */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arc_proto_map</span><span class="p">[</span><span class="n">soft</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">is_ip</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">BUGLVL</span><span class="p">(</span><span class="n">D_PROTO</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">ArcProto</span>
			<span class="o">*</span><span class="n">oldp</span> <span class="o">=</span> <span class="n">arc_proto_map</span><span class="p">[</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">default_proto</span><span class="p">[</span><span class="n">pkt</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">source</span><span class="p">]],</span>
			<span class="o">*</span><span class="n">newp</span> <span class="o">=</span> <span class="n">arc_proto_map</span><span class="p">[</span><span class="n">soft</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">oldp</span> <span class="o">!=</span> <span class="n">newp</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_PROTO</span><span class="p">,</span>
				       <span class="s">&quot;got protocol %02Xh; encap for host %02Xh is now &#39;%c&#39;&quot;</span>
				       <span class="s">&quot; (was &#39;%c&#39;)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">soft</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">,</span> <span class="n">pkt</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">source</span><span class="p">,</span>
				       <span class="n">newp</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">,</span> <span class="n">oldp</span><span class="o">-&gt;</span><span class="n">suffix</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* broadcasts will always be done with the last-used encap. */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">default_proto</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">soft</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">;</span>

		<span class="cm">/* in striking contrast, the following isn&#39;t a hack. */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">default_proto</span><span class="p">[</span><span class="n">pkt</span><span class="p">.</span><span class="n">hard</span><span class="p">.</span><span class="n">source</span><span class="p">]</span> <span class="o">=</span> <span class="n">soft</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* call the protocol-specific receiver. */</span>
	<span class="n">arc_proto_map</span><span class="p">[</span><span class="n">soft</span><span class="o">-&gt;</span><span class="n">proto</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bufnum</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pkt</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">null_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufnum</span><span class="p">,</span>
		    <span class="k">struct</span> <span class="n">archdr</span> <span class="o">*</span><span class="n">pkthdr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_PROTO</span><span class="p">,</span>
	<span class="s">&quot;rx: don&#39;t know how to deal with proto %02Xh from host %02Xh.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pkthdr</span><span class="o">-&gt;</span><span class="n">soft</span><span class="p">.</span><span class="n">rfc1201</span><span class="p">.</span><span class="n">proto</span><span class="p">,</span> <span class="n">pkthdr</span><span class="o">-&gt;</span><span class="n">hard</span><span class="p">.</span><span class="n">source</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">null_build_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">type</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">daddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_PROTO</span><span class="p">,</span>
	       <span class="s">&quot;tx: can&#39;t build header for encap %02Xh; load a protocol driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">lp</span><span class="o">-&gt;</span><span class="n">default_proto</span><span class="p">[</span><span class="n">daddr</span><span class="p">]);</span>

	<span class="cm">/* always fails */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* the &quot;do nothing&quot; prepare_tx function warns that there&#39;s nothing to do. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">null_prepare_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">archdr</span> <span class="o">*</span><span class="n">pkt</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">length</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bufnum</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">arcnet_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">arc_hardware</span> <span class="n">newpkt</span><span class="p">;</span>

	<span class="n">BUGMSG</span><span class="p">(</span><span class="n">D_PROTO</span><span class="p">,</span> <span class="s">&quot;tx: no encap for this host; load a protocol driver.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* send a packet to myself -- will never get received, of course */</span>
	<span class="n">newpkt</span><span class="p">.</span><span class="n">source</span> <span class="o">=</span> <span class="n">newpkt</span><span class="p">.</span><span class="n">dest</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

	<span class="cm">/* only one byte of actual data (and it&#39;s random) */</span>
	<span class="n">newpkt</span><span class="p">.</span><span class="n">offset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xFF</span><span class="p">;</span>

	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">copy_to_card</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bufnum</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newpkt</span><span class="p">,</span> <span class="n">ARC_HDR_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>		<span class="cm">/* done */</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
