<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › sb1000.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>sb1000.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* sb1000.c: A General Instruments SB1000 driver for linux. */</span>
<span class="cm">/*</span>
<span class="cm">	Written 1998 by Franco Venturi.</span>

<span class="cm">	Copyright 1998 by Franco Venturi.</span>
<span class="cm">	Copyright 1994,1995 by Donald Becker.</span>
<span class="cm">	Copyright 1993 United States Government as represented by the</span>
<span class="cm">	Director, National Security Agency.</span>

<span class="cm">	This driver is for the General Instruments SB1000 (internal SURFboard)</span>

<span class="cm">	The author may be reached as fventuri@mediaone.net</span>

<span class="cm">	This program is free software; you can redistribute it</span>
<span class="cm">	and/or  modify it under  the terms of  the GNU General</span>
<span class="cm">	Public  License as  published  by  the  Free  Software</span>
<span class="cm">	Foundation;  either  version 2 of the License, or  (at</span>
<span class="cm">	your option) any later version.</span>

<span class="cm">	Changes:</span>

<span class="cm">	981115 Steven Hirsch &lt;shirsch@adelphia.net&gt;</span>

<span class="cm">	Linus changed the timer interface.  Should work on all recent</span>
<span class="cm">	development kernels.</span>

<span class="cm">	980608 Steven Hirsch &lt;shirsch@adelphia.net&gt;</span>

<span class="cm">	Small changes to make it work with 2.1.x kernels. Hopefully,</span>
<span class="cm">	nothing major will change before official release of Linux 2.2.</span>

<span class="cm">	Merged with 2.2 - Alan Cox</span>
<span class="cm">*/</span>

<span class="k">static</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;sb1000.c:v1.1.2 6/01/98 (fventuri@mediaone.net)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/if_cablemodem.h&gt; </span><span class="cm">/* for SIOGCM/SIOSCM stuff */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;	</span><span class="cm">/* for udelay() */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/pnp.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/gfp.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/processor.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#ifdef SB1000_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_debug</span> <span class="o">=</span> <span class="n">SB1000_DEBUG</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">sb1000_debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">SB1000_IO_EXTENT</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
<span class="cm">/* SB1000 Maximum Receive Unit */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">SB1000_MRU</span> <span class="o">=</span> <span class="mi">1500</span><span class="p">;</span> <span class="cm">/* octects */</span>

<span class="cp">#define NPIDS 4</span>
<span class="k">struct</span> <span class="n">sb1000_private</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">NPIDS</span><span class="p">];</span>
	<span class="kt">short</span> <span class="n">rx_dlen</span><span class="p">[</span><span class="n">NPIDS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rx_frames</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">rx_error_count</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">rx_error_dpc_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rx_session_id</span><span class="p">[</span><span class="n">NPIDS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rx_frame_id</span><span class="p">[</span><span class="n">NPIDS</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rx_pkt_type</span><span class="p">[</span><span class="n">NPIDS</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* prototypes for Linux interface */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">sb1000_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_dev_ioctl</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">sb1000_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">sb1000_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>


<span class="cm">/* SB1000 hardware routines to be used during open/configuration phases */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">card_wait_for_busy_clear</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">card_wait_for_ready</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[]);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">card_send_command</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[]);</span>

<span class="cm">/* SB1000 hardware routines to be used during frame rx interrupt */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_wait_for_ready</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_wait_for_ready_clear</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sb1000_send_command</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[]);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sb1000_read_status</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[]);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sb1000_issue_read_command</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">);</span>

<span class="cm">/* SB1000 commands for open/configuration */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_reset</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_check_CRC</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">sb1000_start_get_set_command</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_end_get_set_command</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_activate</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_get_firmware_version</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span>
	<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">do_end</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_get_frequency</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span>
	<span class="kt">int</span><span class="o">*</span> <span class="n">frequency</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_set_frequency</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span>
	<span class="kt">int</span> <span class="n">frequency</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_get_PIDs</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span>
	<span class="kt">short</span> <span class="n">PID</span><span class="p">[]);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_set_PIDs</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">short</span> <span class="n">PID</span><span class="p">[]);</span>

<span class="cm">/* SB1000 commands for frame rx interrupt */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sb1000_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">sb1000_error_dpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="n">sb1000_pnp_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;GIC1000&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pnp</span><span class="p">,</span> <span class="n">sb1000_pnp_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">sb1000_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">sb1000_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">sb1000_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">sb1000_dev_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">sb1000_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb1000_probe_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pnp_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">irq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">serial_number</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_device_attach</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pnp_activate_dev</span><span class="p">(</span><span class="n">pdev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_detach</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_port_valid</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">pnp_port_valid</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_irq_valid</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>

	<span class="n">serial_number</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">serial</span><span class="p">;</span>

	<span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">irq</span> <span class="o">=</span> <span class="n">pnp_irq</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;sb1000&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_disable</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">,</span> <span class="s">&quot;sb1000&quot;</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out_release_region0</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sb1000_private</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_release_regions</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="cm">/* mem_start holds the second I/O address */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: sb1000 at (%#3.3lx,%#3.3lx), &quot;</span>
			<span class="s">&quot;S/N %#8.8x, IRQ %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">,</span> <span class="n">serial_number</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The SB1000 is an rx-only cable modem device.  The uplink is a modem</span>
<span class="cm">	 * and we do not want to arp on it.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IFF_POINTOPOINT</span><span class="o">|</span><span class="n">IFF_NOARP</span><span class="p">;</span>

	<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sb1000_netdev_ops</span><span class="p">;</span>

	<span class="cm">/* hardware address is 0:0:serial_number */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>	<span class="o">=</span> <span class="n">serial_number</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>	<span class="o">=</span> <span class="n">serial_number</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>	<span class="o">=</span> <span class="n">serial_number</span> <span class="o">&gt;&gt;</span>  <span class="mi">8</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>	<span class="o">=</span> <span class="n">serial_number</span> <span class="o">&gt;&gt;</span>  <span class="mi">0</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>

	<span class="n">pnp_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_free_netdev</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">out_free_netdev:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
 <span class="nl">out_release_regions:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">16</span><span class="p">);</span>
 <span class="nl">out_release_region0:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">16</span><span class="p">);</span>
 <span class="nl">out_disable:</span>
	<span class="n">pnp_disable_dev</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
 <span class="nl">out_detach:</span>
	<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sb1000_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pnp_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">,</span> <span class="mi">16</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_driver</span> <span class="n">sb1000_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="s">&quot;sb1000&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">sb1000_pnp_ids</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">sb1000_probe_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">sb1000_remove_one</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * SB1000 hardware routines to be used during open/configuration phases</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">TimeOutJiffies</span> <span class="o">=</span> <span class="p">(</span><span class="mi">875</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">)</span> <span class="o">/</span> <span class="mi">100</span><span class="p">;</span>

<span class="cm">/* Card Wait For Busy Clear (cannot be used during an interrupt) */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">card_wait_for_busy_clear</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">a</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">TimeOutJiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x80</span> <span class="o">||</span> <span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* a little sleep */</span>
		<span class="n">yield</span><span class="p">();</span>

		<span class="n">a</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: card_wait_for_busy_clear timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Card Wait For Ready (cannot be used during an interrupt) */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">card_wait_for_ready</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">a</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">a</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">TimeOutJiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x80</span> <span class="o">||</span> <span class="o">!</span><span class="p">(</span><span class="n">a</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* a little sleep */</span>
		<span class="n">yield</span><span class="p">();</span>

		<span class="n">a</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: card_wait_for_ready timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">in</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">in</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">in</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">in</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">in</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Card Send Command (cannot be used during an interrupt) */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">card_send_command</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">x</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_wait_for_busy_clear</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x20</span> <span class="o">&amp;&amp;</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_wait_for_ready</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">in</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: card_send_command &quot;</span>
				<span class="s">&quot;out: %02x%02x%02x%02x%02x%02x  &quot;</span>
				<span class="s">&quot;in: %02x%02x%02x%02x%02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				<span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
				<span class="n">in</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">in</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">in</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">in</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">in</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">in</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">in</span><span class="p">[</span><span class="mi">6</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: card_send_command &quot;</span>
				<span class="s">&quot;out: %02x%02x%02x%02x%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span>
				<span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x1b</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mh">0x80</span> <span class="o">&amp;&amp;</span> <span class="n">in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * SB1000 hardware routines to be used during frame rx interrupt</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">Sb1000TimeOutJiffies</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>

<span class="cm">/* Card Wait For Ready (to be used during frame rx) */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb1000_wait_for_ready</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">Sb1000TimeOutJiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: sb1000_wait_for_ready timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">Sb1000TimeOutJiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: sb1000_wait_for_ready timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Card Wait For Ready Clear (to be used during frame rx) */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb1000_wait_for_ready_clear</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">Sb1000TimeOutJiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: sb1000_wait_for_ready_clear timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">Sb1000TimeOutJiffies</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: sb1000_wait_for_ready_clear timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIME</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Card Send Command (to be used during frame rx) */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sb1000_send_command</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">out</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: sb1000_send_command out: %02x%02x%02x%02x&quot;</span>
			<span class="s">&quot;%02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">out</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">out</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/* Card Read Status (to be used during frame rx) */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sb1000_read_status</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">in</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="n">in</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">in</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">in</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
	<span class="n">in</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
	<span class="n">in</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Issue Read Command (to be used during frame rx) */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sb1000_issue_read_command</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

	<span class="n">sb1000_wait_for_ready_clear</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0xa0</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">sb1000_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * SB1000 commands for open/configuration</span>
<span class="cm"> */</span>
<span class="cm">/* reset SB1000 card */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb1000_reset</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x4</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x4</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
	<span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command0</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xf0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* check SB1000 firmware CRC */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb1000_check_CRC</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x1f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">crc</span><span class="p">,</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* check CRC */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command0</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">st</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">||</span> <span class="n">st</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">st</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">st</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span>
<span class="nf">sb1000_start_get_set_command</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command0</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb1000_end_get_set_command</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command1</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command0</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command1</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb1000_activate</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command1</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command0</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command1</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xf1</span><span class="p">)</span> <span class="p">{</span>
    	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_start_get_set_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">sb1000_start_get_set_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* get SB1000 firmware version */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb1000_get_firmware_version</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">do_end</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_start_get_set_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command0</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mh">0xa3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_end</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sb1000_end_get_set_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* get SB1000 frequency */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb1000_get_frequency</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span><span class="o">*</span> <span class="n">frequency</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x44</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_start_get_set_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command0</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="o">*</span><span class="n">frequency</span> <span class="o">=</span> <span class="p">((</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">st</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">st</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">st</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="k">return</span> <span class="n">sb1000_end_get_set_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* set SB1000 frequency */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb1000_set_frequency</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">int</span> <span class="n">frequency</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x29</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

	<span class="k">const</span> <span class="kt">int</span> <span class="n">FrequencyLowerLimit</span> <span class="o">=</span> <span class="mi">57000</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">FrequencyUpperLimit</span> <span class="o">=</span> <span class="mi">804000</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">frequency</span> <span class="o">&lt;</span> <span class="n">FrequencyLowerLimit</span> <span class="o">||</span> <span class="n">frequency</span> <span class="o">&gt;</span> <span class="n">FrequencyUpperLimit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: frequency chosen (%d kHz) is not in the range &quot;</span>
			<span class="s">&quot;[%d,%d] kHz</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">frequency</span><span class="p">,</span> <span class="n">FrequencyLowerLimit</span><span class="p">,</span>
			<span class="n">FrequencyUpperLimit</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_start_get_set_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">Command0</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">frequency</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">Command0</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">frequency</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">Command0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">frequency</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">Command0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">frequency</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command0</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* get SB1000 PIDs */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb1000_get_PIDs</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">short</span> <span class="n">PID</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command1</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x41</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command2</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command3</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x43</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_start_get_set_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command0</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">PID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">st</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command1</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">PID</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">st</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command2</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">PID</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">st</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command3</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">PID</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">st</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">sb1000_end_get_set_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* set SB1000 PIDs */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb1000_set_PIDs</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[],</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="k">const</span> <span class="kt">short</span> <span class="n">PID</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command4</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">short</span> <span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x31</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command1</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x32</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command2</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x33</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command3</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x34</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_start_get_set_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">PID</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">Command0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">Command0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command0</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">PID</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">Command1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">Command1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command1</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">PID</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="n">Command2</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">Command2</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command2</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">PID</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">Command3</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">&gt;&gt;=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">Command3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command3</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">card_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command4</span><span class="p">,</span> <span class="n">st</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">sb1000_end_get_set_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sb1000_print_status_buffer</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st</span><span class="p">[],</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[],</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: status: %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">24</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x08</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">25</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x00</span> <span class="o">&amp;&amp;</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">26</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x45</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: length: %d protocol: %d from: %d.%d.%d.%d:%d &quot;</span>
			<span class="s">&quot;to %d.%d.%d.%d:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">28</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">29</span><span class="p">],</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">35</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">38</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">39</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">40</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">41</span><span class="p">],</span>
            <span class="n">buffer</span><span class="p">[</span><span class="mi">46</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">47</span><span class="p">],</span>
			<span class="n">buffer</span><span class="p">[</span><span class="mi">42</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">43</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">44</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">45</span><span class="p">],</span>
            <span class="n">buffer</span><span class="p">[</span><span class="mi">48</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">49</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">size</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">i</span> <span class="o">?</span> <span class="s">&quot;       &quot;</span> <span class="o">:</span> <span class="s">&quot;buffer:&quot;</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">,</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %02x&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="n">k</span><span class="p">]);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * SB1000 commands for frame rx interrupt</span>
<span class="cm"> */</span>
<span class="cm">/* receive a single frame and assemble datagram</span>
<span class="cm"> * (this is the heart of the interrupt routine)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb1000_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>

<span class="cp">#define FRAMESIZE 184</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="n">FRAMESIZE</span><span class="p">],</span> <span class="n">session_id</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">dlen</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">ns</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">skbsize</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sb1000_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>

	<span class="cm">/* SB1000 frame constants */</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">FrameSize</span> <span class="o">=</span> <span class="n">FRAMESIZE</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">NewDatagramHeaderSkip</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">NewDatagramHeaderSize</span> <span class="o">=</span> <span class="n">NewDatagramHeaderSkip</span> <span class="o">+</span> <span class="mi">18</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">NewDatagramDataSize</span> <span class="o">=</span> <span class="n">FrameSize</span> <span class="o">-</span> <span class="n">NewDatagramHeaderSize</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">ContDatagramHeaderSkip</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">ContDatagramHeaderSize</span> <span class="o">=</span> <span class="n">ContDatagramHeaderSkip</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">ContDatagramDataSize</span> <span class="o">=</span> <span class="n">FrameSize</span> <span class="o">-</span> <span class="n">ContDatagramHeaderSize</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">TrailerSize</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">insw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">*</span><span class="p">)</span> <span class="n">st</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="cp">#ifdef XXXDEBUG</span>
<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cm0: received: %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="cp">#endif </span><span class="cm">/* XXXDEBUG */</span><span class="cp"></span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_frames</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* decide if it is a good or bad frame */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">ns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ns</span> <span class="o">&lt;</span> <span class="n">NPIDS</span><span class="p">;</span> <span class="n">ns</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">session_id</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_session_id</span><span class="p">[</span><span class="n">ns</span><span class="p">];</span>
		<span class="n">frame_id</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_frame_id</span><span class="p">[</span><span class="n">ns</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">session_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">frame_id</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">frame_id</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x30</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">good_frame</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x30</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">skipped_frame</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">bad_frame</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">session_id</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">skipped_frame</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">goto</span> <span class="n">bad_frame</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">bad_frame</span><span class="p">;</span>

<span class="nl">skipped_frame:</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">ns</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: missing frame(s): got %02x %02x &quot;</span>
			<span class="s">&quot;expecting %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">skb</span> <span class="o">?</span> <span class="n">session_id</span> <span class="o">:</span> <span class="n">session_id</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">,</span> <span class="n">frame_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">good_frame:</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_frame_id</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x30</span> <span class="o">|</span> <span class="p">((</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
	<span class="cm">/* new datagram */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get data length */</span>
		<span class="n">insw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">NewDatagramHeaderSize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#ifdef XXXDEBUG</span>
<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cm0: IP identification: %02x%02x  fragment offset: %02x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">30</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">31</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">33</span><span class="p">]);</span>
<span class="cp">#endif </span><span class="cm">/* XXXDEBUG */</span><span class="cp"></span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">NewDatagramHeaderSkip</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: new datagram header skip error: &quot;</span>
					<span class="s">&quot;got %02x expecting %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">NewDatagramHeaderSkip</span><span class="p">);</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">insw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">NewDatagramDataSize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad_frame_next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dlen</span> <span class="o">=</span> <span class="p">((</span><span class="n">buffer</span><span class="p">[</span><span class="n">NewDatagramHeaderSkip</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span> <span class="o">|</span>
			<span class="n">buffer</span><span class="p">[</span><span class="n">NewDatagramHeaderSkip</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])</span> <span class="o">-</span> <span class="mi">17</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dlen</span> <span class="o">&gt;</span> <span class="n">SB1000_MRU</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: datagram length (%d) greater &quot;</span>
					<span class="s">&quot;than MRU (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dlen</span><span class="p">,</span> <span class="n">SB1000_MRU</span><span class="p">);</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">insw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">NewDatagramDataSize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad_frame_next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dlen</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">=</span> <span class="n">dlen</span><span class="p">;</span>
		<span class="cm">/* compute size to allocate for datagram */</span>
		<span class="n">skbsize</span> <span class="o">=</span> <span class="n">dlen</span> <span class="o">+</span> <span class="n">FrameSize</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_skb</span><span class="p">(</span><span class="n">skbsize</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: can&#39;t allocate %d bytes long &quot;</span>
					<span class="s">&quot;skbuff</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">skbsize</span><span class="p">);</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="n">insw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">NewDatagramDataSize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">dropped_frame</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">)</span> <span class="n">buffer</span><span class="p">[</span><span class="n">NewDatagramHeaderSkip</span> <span class="o">+</span> <span class="mi">16</span><span class="p">];</span>
		<span class="n">insw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">NewDatagramDataSize</span><span class="p">),</span>
			<span class="n">NewDatagramDataSize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* continuation of previous datagram */</span>
		<span class="n">insw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">ContDatagramHeaderSize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">ContDatagramHeaderSkip</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: cont datagram header skip error: &quot;</span>
					<span class="s">&quot;got %02x expecting %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
					<span class="n">ContDatagramHeaderSkip</span><span class="p">);</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">insw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">ContDatagramDataSize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">bad_frame_next</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">ns</span><span class="p">];</span>
		<span class="n">insw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ContDatagramDataSize</span><span class="p">),</span>
			<span class="n">ContDatagramDataSize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">dlen</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dlen</span><span class="p">[</span><span class="n">ns</span><span class="p">];</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">dlen</span> <span class="o">+</span> <span class="n">TrailerSize</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_session_id</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x40</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* datagram completed: send to upper level */</span>
	<span class="n">skb_trim</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dlen</span><span class="p">);</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span><span class="o">+=</span><span class="n">dlen</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_session_id</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">bad_frame:</span>
	<span class="n">insw</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">FrameSize</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: frame error: got %02x %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">st</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
<span class="nl">bad_frame_next:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">sb1000_print_status_buffer</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">st</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">FrameSize</span><span class="p">);</span>
<span class="nl">dropped_frame:</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ns</span> <span class="o">&lt;</span> <span class="n">NPIDS</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">ns</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_session_id</span><span class="p">[</span><span class="n">ns</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x40</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sb1000_error_dpc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sb1000_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">ErrorDpcCounterInitialize</span> <span class="o">=</span> <span class="mi">200</span><span class="p">;</span>

	<span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="cm">/* mem_start holds the second I/O address */</span>
	<span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="n">sb1000_wait_for_ready_clear</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">sb1000_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command0</span><span class="p">);</span>
	<span class="n">sb1000_wait_for_ready</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">sb1000_read_status</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">st</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_error_dpc_count</span> <span class="o">=</span> <span class="n">ErrorDpcCounterInitialize</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Linux interface functions</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sb1000_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sb1000_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">FirmwareVersion</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">};</span>

	<span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="cm">/* mem_start holds the second I/O address */</span>
	<span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="cm">/* initialize sb1000 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_reset</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">ssleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_check_CRC</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="cm">/* initialize private data before board can catch interrupts */</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dlen</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dlen</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dlen</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_dlen</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_frames</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_error_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_error_dpc_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_session_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_session_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_session_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_session_id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x42</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_frame_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_frame_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_frame_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_frame_id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sb1000_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;sb1000&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Opening, IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* Activate board and check firmware version */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_activate</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_get_firmware_version</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: found firmware version %x.%02x &quot;</span>
			<span class="s">&quot;(should be %x.%02x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">version</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			<span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">FirmwareVersion</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>


	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>					<span class="cm">/* Always succeed */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sb1000_dev_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="kt">short</span> <span class="n">PID</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">status</span><span class="p">,</span> <span class="n">frequency</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stats</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sb1000_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="cm">/* mem_start holds the second I/O address */</span>
	<span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SIOCGCMSTATS</span>:		<span class="cm">/* get statistics */</span>
		<span class="n">stats</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span><span class="p">;</span>
		<span class="n">stats</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_frames</span><span class="p">;</span>
		<span class="n">stats</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">;</span>
		<span class="n">stats</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="p">;</span>
		<span class="n">stats</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">stats</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">stats</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGCMFIRMWARE</span>:		<span class="cm">/* get firmware version */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_get_firmware_version</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">version</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGCMFREQUENCY</span>:		<span class="cm">/* get frequency */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_get_frequency</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frequency</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">put_user</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSCMFREQUENCY</span>:		<span class="cm">/* set frequency */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">frequency</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_set_frequency</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCGCMPIDS</span>:			<span class="cm">/* get PIDs */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_get_PIDs</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">PID</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">PID</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PID</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">SIOCSCMPIDS</span>:			<span class="cm">/* set PIDs */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">PID</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">PID</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">=</span> <span class="n">sb1000_set_PIDs</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">PID</span><span class="p">)))</span>
			<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
		<span class="cm">/* set session_id, frame_id and pkt_type too */</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_session_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x50</span> <span class="o">|</span> <span class="p">(</span><span class="n">PID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_session_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x48</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_session_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x44</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_session_id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x42</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_frame_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_frame_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_frame_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_frame_id</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* transmit function: do nothing since SB1000 can&#39;t send anything out */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">sb1000_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: trying to transmit!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="cm">/* sb1000 can&#39;t xmit datagrams */</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* SB1000 interrupt handler. */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sb1000_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command0</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x2c</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">Command1</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x80</span><span class="p">,</span> <span class="mh">0x2e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">};</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">st</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sb1000_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">const</span> <span class="kt">int</span> <span class="n">MaxRxErrorCount</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>

	<span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="cm">/* mem_start holds the second I/O address */</span>
	<span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="n">name</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>

	<span class="cm">/* is it a good interrupt? */</span>
	<span class="n">st</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">6</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">st</span> <span class="o">&amp;</span> <span class="mh">0x08</span> <span class="o">&amp;&amp;</span> <span class="n">st</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: entering interrupt</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">st</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_error_count</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#ifdef SB1000_DELAY</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">SB1000_DELAY</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* SB1000_DELAY */</span><span class="cp"></span>
	<span class="n">sb1000_issue_read_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">st</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sb1000_error_dpc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">sb1000_issue_read_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_error_dpc_count</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="o">--</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_error_dpc_count</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">sb1000_wait_for_ready_clear</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">sb1000_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command0</span><span class="p">);</span>
		<span class="n">sb1000_wait_for_ready</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">sb1000_issue_read_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_error_count</span> <span class="o">&gt;=</span> <span class="n">MaxRxErrorCount</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sb1000_wait_for_ready_clear</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">sb1000_send_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">Command1</span><span class="p">);</span>
		<span class="n">sb1000_wait_for_ready</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">sb1000_issue_read_command</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_error_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sb1000_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioaddr</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">sb1000_private</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sb1000_debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Shutting down sb1000.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="cm">/* mem_start holds the second I/O address */</span>
	<span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="cm">/* If we don&#39;t do this, we can&#39;t re-insmod it later. */</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">SB1000_IO_EXTENT</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">SB1000_IO_EXTENT</span><span class="p">);</span>

	<span class="cm">/* free rx_skb&#39;s if needed */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Franco Venturi &lt;fventuri@mediaone.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;General Instruments SB1000 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">sb1000_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pnp_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb1000_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">sb1000_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pnp_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sb1000_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sb1000_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sb1000_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
