<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › cris › eth_v10.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>eth_v10.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * e100net.c: A network driver for the ETRAX 100LX network controller.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 1998-2002 Axis Communications AB.</span>
<span class="cm"> *</span>
<span class="cm"> * The outline of this driver comes from skeleton.c.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>


<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/mii.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ethtool.h&gt;</span>

<span class="cp">#include &lt;arch/svinto.h&gt;</span><span class="cm">/* DMA and register descriptions */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/io.h&gt;         </span><span class="cm">/* CRIS_LED_* I/O functions */</span><span class="cp"></span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/ethernet.h&gt;</span>
<span class="cp">#include &lt;asm/cache.h&gt;</span>
<span class="cp">#include &lt;arch/io_interface_mux.h&gt;</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><h1>define ETHDEBUG</h1></td><td class="code"><div class="highlight"><pre><span class="cp">#define D(x)</span>

<span class="cm">/*</span>
<span class="cm"> * The name of the card. Is used for messages and in the requests for</span>
<span class="cm"> * io regions, irqs and dma channels</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">cardname</span> <span class="o">=</span> <span class="s">&quot;ETRAX 100LX built-in ethernet controller&quot;</span><span class="p">;</span>

<span class="cm">/* A default ethernet address. Highlevel SW will set the real one later */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">default_mac</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span>
	<span class="p">{</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">,</span> <span class="mh">0x8C</span><span class="p">,</span> <span class="mh">0xCD</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">}</span>
<span class="p">};</span>

<span class="cm">/* Information that need to be kept for each board. */</span>
<span class="k">struct</span> <span class="n">net_local</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">mii_if_info</span> <span class="n">mii_if</span><span class="p">;</span>

	<span class="cm">/* Tx control lock.  This protects the transmit buffer ring</span>
<span class="cm">	 * state along with the &quot;tx full&quot; state of the driver.  This</span>
<span class="cm">	 * means all netif_queue flow control actions are protected</span>
<span class="cm">	 * by this lock as well.</span>
<span class="cm">	 */</span>
	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">led_lock</span><span class="p">;</span> <span class="cm">/* Protect LED state */</span>
	<span class="n">spinlock_t</span> <span class="n">transceiver_lock</span><span class="p">;</span> <span class="cm">/* Protect transceiver state. */</span>
<span class="p">};</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">etrax_eth_descr</span>
<span class="p">{</span>
	<span class="n">etrax_dma_descr</span> <span class="n">descr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span><span class="o">*</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span> <span class="n">etrax_eth_descr</span><span class="p">;</span>

<span class="cm">/* Some transceivers requires special handling */</span>
<span class="k">struct</span> <span class="n">transceiver_ops</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oui</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">check_speed</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">check_duplex</span><span class="p">)(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="p">};</span>

<span class="cm">/* Duplex settings */</span>
<span class="k">enum</span> <span class="n">duplex</span>
<span class="p">{</span>
	<span class="n">half</span><span class="p">,</span>
	<span class="n">full</span><span class="p">,</span>
	<span class="n">autoneg</span>
<span class="p">};</span>

<span class="cm">/* Dma descriptors etc. */</span>

<span class="cp">#define MAX_MEDIA_DATA_SIZE 1522</span>

<span class="cp">#define MIN_PACKET_LEN      46</span>
<span class="cp">#define ETHER_HEAD_LEN      14</span>

<span class="cm">/*</span>
<span class="cm">** MDIO constants.</span>
<span class="cm">*/</span>
<span class="cp">#define MDIO_START                          0x1</span>
<span class="cp">#define MDIO_READ                           0x2</span>
<span class="cp">#define MDIO_WRITE                          0x1</span>
<span class="cp">#define MDIO_PREAMBLE              0xfffffffful</span>

<span class="cm">/* Broadcom specific */</span>
<span class="cp">#define MDIO_AUX_CTRL_STATUS_REG           0x18</span>
<span class="cp">#define MDIO_BC_FULL_DUPLEX_IND             0x1</span>
<span class="cp">#define MDIO_BC_SPEED                       0x2</span>

<span class="cm">/* TDK specific */</span>
<span class="cp">#define MDIO_TDK_DIAGNOSTIC_REG              18</span>
<span class="cp">#define MDIO_TDK_DIAGNOSTIC_RATE          0x400</span>
<span class="cp">#define MDIO_TDK_DIAGNOSTIC_DPLX          0x800</span>

<span class="cm">/*Intel LXT972A specific*/</span>
<span class="cp">#define MDIO_INT_STATUS_REG_2			0x0011</span>
<span class="cp">#define MDIO_INT_FULL_DUPLEX_IND       (1 &lt;&lt; 9)</span>
<span class="cp">#define MDIO_INT_SPEED                (1 &lt;&lt; 14)</span>

<span class="cm">/* Network flash constants */</span>
<span class="cp">#define NET_FLASH_TIME                  (HZ/50) </span><span class="cm">/* 20 ms */</span><span class="cp"></span>
<span class="cp">#define NET_FLASH_PAUSE                (HZ/100) </span><span class="cm">/* 10 ms */</span><span class="cp"></span>
<span class="cp">#define NET_LINK_UP_CHECK_INTERVAL       (2*HZ) </span><span class="cm">/* 2 s   */</span><span class="cp"></span>
<span class="cp">#define NET_DUPLEX_CHECK_INTERVAL        (2*HZ) </span><span class="cm">/* 2 s   */</span><span class="cp"></span>

<span class="cp">#define NO_NETWORK_ACTIVITY 0</span>
<span class="cp">#define NETWORK_ACTIVITY    1</span>

<span class="cp">#define NBR_OF_RX_DESC     32</span>
<span class="cp">#define NBR_OF_TX_DESC     16</span>

<span class="cm">/* Large packets are sent directly to upper layers while small packets are */</span>
<span class="cm">/* copied (to reduce memory waste). The following constant decides the breakpoint */</span>
<span class="cp">#define RX_COPYBREAK 256</span>

<span class="cm">/* Due to a chip bug we need to flush the cache when descriptors are returned */</span>
<span class="cm">/* to the DMA. To decrease performance impact we return descriptors in chunks. */</span>
<span class="cm">/* The following constant determines the number of descriptors to return. */</span>
<span class="cp">#define RX_QUEUE_THRESHOLD  NBR_OF_RX_DESC/2</span>

<span class="cp">#define GET_BIT(bit,val)   (((val) &gt;&gt; (bit)) &amp; 0x01)</span>

<span class="cm">/* Define some macros to access ETRAX 100 registers */</span>
<span class="cp">#define SETF(var, reg, field, val) var = (var &amp; ~IO_MASK_(reg##_, field##_)) | \</span>
<span class="cp">					  IO_FIELD_(reg##_, field##_, val)</span>
<span class="cp">#define SETS(var, reg, field, val) var = (var &amp; ~IO_MASK_(reg##_, field##_)) | \</span>
<span class="cp">					  IO_STATE_(reg##_, field##_, _##val)</span>

<span class="k">static</span> <span class="n">etrax_eth_descr</span> <span class="o">*</span><span class="n">myNextRxDesc</span><span class="p">;</span>  <span class="cm">/* Points to the next descriptor to</span>
<span class="cm">                                          to be processed */</span>
<span class="k">static</span> <span class="n">etrax_eth_descr</span> <span class="o">*</span><span class="n">myLastRxDesc</span><span class="p">;</span>  <span class="cm">/* The last processed descriptor */</span>

<span class="k">static</span> <span class="n">etrax_eth_descr</span> <span class="n">RxDescList</span><span class="p">[</span><span class="n">NBR_OF_RX_DESC</span><span class="p">]</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">32</span><span class="p">)));</span>

<span class="k">static</span> <span class="n">etrax_eth_descr</span><span class="o">*</span> <span class="n">myFirstTxDesc</span><span class="p">;</span> <span class="cm">/* First packet not yet sent */</span>
<span class="k">static</span> <span class="n">etrax_eth_descr</span><span class="o">*</span> <span class="n">myLastTxDesc</span><span class="p">;</span>  <span class="cm">/* End of send queue */</span>
<span class="k">static</span> <span class="n">etrax_eth_descr</span><span class="o">*</span> <span class="n">myNextTxDesc</span><span class="p">;</span>  <span class="cm">/* Next descriptor to use */</span>
<span class="k">static</span> <span class="n">etrax_eth_descr</span> <span class="n">TxDescList</span><span class="p">[</span><span class="n">NBR_OF_TX_DESC</span><span class="p">]</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">32</span><span class="p">)));</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">network_rec_config_shadow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">network_tr_ctrl_shadow</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* Network speed indication. */</span>
<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">speed_timer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">clear_led_timer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">current_speed</span><span class="p">;</span> <span class="cm">/* Speed read from transceiver */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">current_speed_selection</span><span class="p">;</span> <span class="cm">/* Speed selected by user */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">led_next_time</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">led_active</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rx_queue_len</span><span class="p">;</span>

<span class="cm">/* Duplex */</span>
<span class="k">static</span> <span class="n">DEFINE_TIMER</span><span class="p">(</span><span class="n">duplex_timer</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">full_duplex</span><span class="p">;</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">duplex</span> <span class="n">current_duplex</span><span class="p">;</span>

<span class="cm">/* Index to functions, as function prototypes. */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">etrax_ethernet_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">e100_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">e100_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">e100_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">e100rxtx_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">e100nw_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">e100_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">e100_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">e100_set_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifmap</span><span class="o">*</span> <span class="n">map</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">e100_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_hardware_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span><span class="o">*</span> <span class="n">np</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">update_rx_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">update_tx_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">e100_probe_transceiver</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_check_speed</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_set_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">speed</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_check_duplex</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">priv</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_set_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">duplex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_negotiate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_set_mdio_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_send_mdio_cmd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write_cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_send_mdio_bit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bit</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">e100_receive_mdio_bit</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_reset_transceiver</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">net</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_clear_network_leds</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_set_network_leds</span><span class="p">(</span><span class="kt">int</span> <span class="n">active</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">e100_ethtool_ops</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_ETRAX_NO_PHY)</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dummy_check_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dummy_check_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">broadcom_check_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">broadcom_check_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tdk_check_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">tdk_check_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">intel_check_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">intel_check_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">generic_check_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">generic_check_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">e100_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">autoneg_normal</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">transceiver_ops</span> <span class="n">transceivers</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_ETRAX_NO_PHY)</span>
	<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">dummy_check_speed</span><span class="p">,</span> <span class="n">dummy_check_duplex</span><span class="p">}</span>        <span class="cm">/* Dummy */</span>
<span class="cp">#else</span>
	<span class="p">{</span><span class="mh">0x1018</span><span class="p">,</span> <span class="n">broadcom_check_speed</span><span class="p">,</span> <span class="n">broadcom_check_duplex</span><span class="p">},</span>  <span class="cm">/* Broadcom */</span>
	<span class="p">{</span><span class="mh">0xC039</span><span class="p">,</span> <span class="n">tdk_check_speed</span><span class="p">,</span> <span class="n">tdk_check_duplex</span><span class="p">},</span>            <span class="cm">/* TDK 2120 */</span>
	<span class="p">{</span><span class="mh">0x039C</span><span class="p">,</span> <span class="n">tdk_check_speed</span><span class="p">,</span> <span class="n">tdk_check_duplex</span><span class="p">},</span>            <span class="cm">/* TDK 2120C */</span>
        <span class="p">{</span><span class="mh">0x04de</span><span class="p">,</span> <span class="n">intel_check_speed</span><span class="p">,</span> <span class="n">intel_check_duplex</span><span class="p">},</span>     	<span class="cm">/* Intel LXT972A*/</span>
	<span class="p">{</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">generic_check_speed</span><span class="p">,</span> <span class="n">generic_check_duplex</span><span class="p">}</span>     <span class="cm">/* Generic, must be last */</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">transceiver_ops</span><span class="o">*</span> <span class="n">transceiver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">transceivers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">e100_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">e100_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">e100_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">e100_send_packet</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span>		<span class="o">=</span> <span class="n">e100_tx_timeout</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>		<span class="o">=</span> <span class="n">e100_get_stats</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">e100_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span>	<span class="o">=</span> <span class="n">e100_set_mac_address</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_config</span>		<span class="o">=</span> <span class="n">e100_set_config</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
	<span class="p">.</span><span class="n">ndo_poll_controller</span>	<span class="o">=</span> <span class="n">e100_netpoll</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="cp">#define tx_done(dev) (*R_DMA_CH0_CMD == 0)</span>

<span class="cm">/*</span>
<span class="cm"> * Check for a network adaptor of this type, and return &#39;0&#39; if one exists.</span>
<span class="cm"> * If dev-&gt;base_addr == 0, probe all likely locations.</span>
<span class="cm"> * If dev-&gt;base_addr == 1, always return failure.</span>
<span class="cm"> * If dev-&gt;base_addr == 2, allocate space for the device and return success</span>
<span class="cm"> * (detachable devices only).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">etrax_ethernet_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">net_local</span><span class="o">*</span> <span class="n">np</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span>
	       <span class="s">&quot;ETRAX 100LX 10/100MBit ethernet v2.0 (c) 1998-2007 Axis Communications AB</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cris_request_io_interface</span><span class="p">(</span><span class="n">if_eth</span><span class="p">,</span> <span class="n">cardname</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;etrax_ethernet_init failed to get IO interface</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_etherdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* we do our own locking */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">features</span> <span class="o">|=</span> <span class="n">NETIF_F_LLTX</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">R_NETWORK_SA_0</span><span class="p">;</span> <span class="cm">/* just to have something to show */</span>

	<span class="cm">/* now setup our etrax specific stuff */</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">NETWORK_DMA_RX_IRQ_NBR</span><span class="p">;</span> <span class="cm">/* we really use DMATX as well... */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span> <span class="o">=</span> <span class="n">NETWORK_RX_DMA_NBR</span><span class="p">;</span>

	<span class="cm">/* fill in our handlers so the network layer can talk to us in the future */</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">ethtool_ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">e100_ethtool_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">e100_netdev_ops</span><span class="p">;</span>

	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">led_lock</span><span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">transceiver_lock</span><span class="p">);</span>

	<span class="cm">/* Initialise the list of Etrax DMA-descriptors */</span>

	<span class="cm">/* Initialise receive descriptors */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NBR_OF_RX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allocate two extra cachelines to make sure that buffer used</span>
<span class="cm">		 * by DMA does not share cacheline with any other data (to</span>
<span class="cm">		 * avoid cache bug)</span>
<span class="cm">		 */</span>
		<span class="n">RxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">MAX_MEDIA_DATA_SIZE</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L1_CACHE_BYTES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">RxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">RxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">ctrl</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">RxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">sw_len</span> <span class="o">=</span> <span class="n">MAX_MEDIA_DATA_SIZE</span><span class="p">;</span>
		<span class="n">RxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">next</span>   <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RxDescList</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]);</span>
		<span class="n">RxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">buf</span>    <span class="o">=</span> <span class="n">L1_CACHE_ALIGN</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">RxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
		<span class="n">RxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">RxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">hw_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">prepare_rx_descriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">RxDescList</span><span class="p">[</span><span class="n">NBR_OF_RX_DESC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">ctrl</span>   <span class="o">=</span> <span class="n">d_eol</span><span class="p">;</span>
	<span class="n">RxDescList</span><span class="p">[</span><span class="n">NBR_OF_RX_DESC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">next</span>   <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">RxDescList</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">rx_queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Initialize transmit descriptors */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NBR_OF_TX_DESC</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">TxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">ctrl</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">TxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">sw_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">TxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">next</span>   <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TxDescList</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">].</span><span class="n">descr</span><span class="p">);</span>
		<span class="n">TxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">buf</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">TxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">TxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">hw_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">TxDescList</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">skb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">TxDescList</span><span class="p">[</span><span class="n">NBR_OF_TX_DESC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">ctrl</span>   <span class="o">=</span> <span class="n">d_eol</span><span class="p">;</span>
	<span class="n">TxDescList</span><span class="p">[</span><span class="n">NBR_OF_TX_DESC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">descr</span><span class="p">.</span><span class="n">next</span>   <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="o">&amp;</span><span class="n">TxDescList</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">descr</span><span class="p">);</span>

	<span class="cm">/* Initialise initial pointers */</span>

	<span class="n">myNextRxDesc</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">RxDescList</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">myLastRxDesc</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">RxDescList</span><span class="p">[</span><span class="n">NBR_OF_RX_DESC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">myFirstTxDesc</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">TxDescList</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">myNextTxDesc</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">TxDescList</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">myLastTxDesc</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">TxDescList</span><span class="p">[</span><span class="n">NBR_OF_TX_DESC</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* Register device */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set the default MAC address */</span>

	<span class="n">e100_set_mac_address</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">default_mac</span><span class="p">);</span>

	<span class="cm">/* Initialize speed indicator stuff. */</span>

	<span class="n">current_speed</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">current_speed_selection</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Auto */</span>
	<span class="n">speed_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">NET_LINK_UP_CHECK_INTERVAL</span><span class="p">;</span>
	<span class="n">speed_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">speed_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">e100_check_speed</span><span class="p">;</span>

	<span class="n">clear_led_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">e100_clear_network_leds</span><span class="p">;</span>
	<span class="n">clear_led_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">current_duplex</span> <span class="o">=</span> <span class="n">autoneg</span><span class="p">;</span>
	<span class="n">duplex_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">NET_DUPLEX_CHECK_INTERVAL</span><span class="p">;</span>
        <span class="n">duplex_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">duplex_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">e100_check_duplex</span><span class="p">;</span>

        <span class="cm">/* Initialize mii interface */</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">reg_num_mask</span> <span class="o">=</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_read</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">;</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">mdio_write</span> <span class="o">=</span> <span class="n">e100_set_mdio_reg</span><span class="p">;</span>

	<span class="cm">/* Initialize group address registers to make sure that no */</span>
	<span class="cm">/* unwanted addresses are matched */</span>
	<span class="o">*</span><span class="n">R_NETWORK_GA_0</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="o">*</span><span class="n">R_NETWORK_GA_1</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>

	<span class="cm">/* Initialize next time the led can flash */</span>
	<span class="n">led_next_time</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* set MAC address of the interface. called from the core after a</span>
<span class="cm"> * SIOCSIFADDR ioctl, and from the bootup above.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">e100_set_mac_address</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span> <span class="cm">/* preemption protection */</span>

	<span class="cm">/* remember it */</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="n">addr</span><span class="o">-&gt;</span><span class="n">sa_data</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span><span class="p">);</span>

	<span class="cm">/* Write it to the hardware.</span>
<span class="cm">	 * Note the way the address is wrapped:</span>
<span class="cm">	 * *R_NETWORK_SA_0 = a0_0 | (a0_1 &lt;&lt; 8) | (a0_2 &lt;&lt; 16) | (a0_3 &lt;&lt; 24);</span>
<span class="cm">	 * *R_NETWORK_SA_1 = a0_4 | (a0_5 &lt;&lt; 8);</span>
<span class="cm">	 */</span>

	<span class="o">*</span><span class="n">R_NETWORK_SA_0</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="o">*</span><span class="n">R_NETWORK_SA_1</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="o">*</span><span class="n">R_NETWORK_SA_2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* show it in the log as well */</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: changed MAC to %pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Open/initialize the board. This is called (in the current kernel)</span>
<span class="cm"> * sometime after booting when the &#39;ifconfig&#39; program is run.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine should set everything up anew at each open, even</span>
<span class="cm"> * registers that &quot;should&quot; only need to be set once at boot, so that</span>
<span class="cm"> * there is non-reboot way to recover if something goes wrong.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">e100_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* enable the MDIO output pin */</span>

	<span class="o">*</span><span class="n">R_NETWORK_MGM_CTRL</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_NETWORK_MGM_CTRL</span><span class="p">,</span> <span class="n">mdoe</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>

	<span class="o">*</span><span class="n">R_IRQ_MASK0_CLR</span> <span class="o">=</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK0_CLR</span><span class="p">,</span> <span class="n">overrun</span><span class="p">,</span> <span class="n">clr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK0_CLR</span><span class="p">,</span> <span class="n">underrun</span><span class="p">,</span> <span class="n">clr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK0_CLR</span><span class="p">,</span> <span class="n">excessive_col</span><span class="p">,</span> <span class="n">clr</span><span class="p">);</span>

	<span class="cm">/* clear dma0 and 1 eop and descr irq masks */</span>
	<span class="o">*</span><span class="n">R_IRQ_MASK2_CLR</span> <span class="o">=</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK2_CLR</span><span class="p">,</span> <span class="n">dma0_descr</span><span class="p">,</span> <span class="n">clr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK2_CLR</span><span class="p">,</span> <span class="n">dma0_eop</span><span class="p">,</span> <span class="n">clr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK2_CLR</span><span class="p">,</span> <span class="n">dma1_descr</span><span class="p">,</span> <span class="n">clr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK2_CLR</span><span class="p">,</span> <span class="n">dma1_eop</span><span class="p">,</span> <span class="n">clr</span><span class="p">);</span>

	<span class="cm">/* Reset and wait for the DMA channels */</span>

	<span class="n">RESET_DMA</span><span class="p">(</span><span class="n">NETWORK_TX_DMA_NBR</span><span class="p">);</span>
	<span class="n">RESET_DMA</span><span class="p">(</span><span class="n">NETWORK_RX_DMA_NBR</span><span class="p">);</span>
	<span class="n">WAIT_DMA</span><span class="p">(</span><span class="n">NETWORK_TX_DMA_NBR</span><span class="p">);</span>
	<span class="n">WAIT_DMA</span><span class="p">(</span><span class="n">NETWORK_RX_DMA_NBR</span><span class="p">);</span>

	<span class="cm">/* Initialise the etrax network controller */</span>

	<span class="cm">/* allocate the irq corresponding to the receiving DMA */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">NETWORK_DMA_RX_IRQ_NBR</span><span class="p">,</span> <span class="n">e100rxtx_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">cardname</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">grace_exit0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate the irq corresponding to the transmitting DMA */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">NETWORK_DMA_TX_IRQ_NBR</span><span class="p">,</span> <span class="n">e100rxtx_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">cardname</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">grace_exit1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate the irq corresponding to the network errors etc */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">NETWORK_STATUS_IRQ_NBR</span><span class="p">,</span> <span class="n">e100nw_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">cardname</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">grace_exit2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Always allocate the DMA channels after the IRQ,</span>
<span class="cm">	 * and clean up on failure.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cris_request_dma</span><span class="p">(</span><span class="n">NETWORK_TX_DMA_NBR</span><span class="p">,</span>
	                     <span class="n">cardname</span><span class="p">,</span>
	                     <span class="n">DMA_VERBOSE_ON_ERROR</span><span class="p">,</span>
	                     <span class="n">dma_eth</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">grace_exit3</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cris_request_dma</span><span class="p">(</span><span class="n">NETWORK_RX_DMA_NBR</span><span class="p">,</span>
	                     <span class="n">cardname</span><span class="p">,</span>
	                     <span class="n">DMA_VERBOSE_ON_ERROR</span><span class="p">,</span>
	                     <span class="n">dma_eth</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">goto</span> <span class="n">grace_exit4</span><span class="p">;</span>
        <span class="p">}</span>

	<span class="cm">/* give the HW an idea of what MAC address we want */</span>

	<span class="o">*</span><span class="n">R_NETWORK_SA_0</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
	<span class="o">*</span><span class="n">R_NETWORK_SA_1</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">|</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="o">*</span><span class="n">R_NETWORK_SA_2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	/* use promiscuous mode for testing */</span>
<span class="c">	*R_NETWORK_GA_0 = 0xffffffff;</span>
<span class="c">	*R_NETWORK_GA_1 = 0xffffffff;</span>

<span class="c">	*R_NETWORK_REC_CONFIG = 0xd; /* broadcast rec, individ. rec, ma0 enabled */</span>
<span class="cp">#else</span>
	<span class="n">SETS</span><span class="p">(</span><span class="n">network_rec_config_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_REC_CONFIG</span><span class="p">,</span> <span class="n">max_size</span><span class="p">,</span> <span class="n">size1522</span><span class="p">);</span>
	<span class="n">SETS</span><span class="p">(</span><span class="n">network_rec_config_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_REC_CONFIG</span><span class="p">,</span> <span class="n">broadcast</span><span class="p">,</span> <span class="n">receive</span><span class="p">);</span>
	<span class="n">SETS</span><span class="p">(</span><span class="n">network_rec_config_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_REC_CONFIG</span><span class="p">,</span> <span class="n">ma0</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="n">SETF</span><span class="p">(</span><span class="n">network_rec_config_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_REC_CONFIG</span><span class="p">,</span> <span class="n">duplex</span><span class="p">,</span> <span class="n">full_duplex</span><span class="p">);</span>
	<span class="o">*</span><span class="n">R_NETWORK_REC_CONFIG</span> <span class="o">=</span> <span class="n">network_rec_config_shadow</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="o">*</span><span class="n">R_NETWORK_GEN_CONFIG</span> <span class="o">=</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_NETWORK_GEN_CONFIG</span><span class="p">,</span> <span class="n">phy</span><span class="p">,</span>    <span class="n">mii_clk</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_NETWORK_GEN_CONFIG</span><span class="p">,</span> <span class="n">enable</span><span class="p">,</span> <span class="n">on</span><span class="p">);</span>

	<span class="n">SETS</span><span class="p">(</span><span class="n">network_tr_ctrl_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_TR_CTRL</span><span class="p">,</span> <span class="n">clr_error</span><span class="p">,</span> <span class="n">clr</span><span class="p">);</span>
	<span class="n">SETS</span><span class="p">(</span><span class="n">network_tr_ctrl_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_TR_CTRL</span><span class="p">,</span> <span class="n">delay</span><span class="p">,</span> <span class="n">none</span><span class="p">);</span>
	<span class="n">SETS</span><span class="p">(</span><span class="n">network_tr_ctrl_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_TR_CTRL</span><span class="p">,</span> <span class="n">cancel</span><span class="p">,</span> <span class="n">dont</span><span class="p">);</span>
	<span class="n">SETS</span><span class="p">(</span><span class="n">network_tr_ctrl_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_TR_CTRL</span><span class="p">,</span> <span class="n">cd</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="n">SETS</span><span class="p">(</span><span class="n">network_tr_ctrl_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_TR_CTRL</span><span class="p">,</span> <span class="n">retry</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="n">SETS</span><span class="p">(</span><span class="n">network_tr_ctrl_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_TR_CTRL</span><span class="p">,</span> <span class="n">pad</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="n">SETS</span><span class="p">(</span><span class="n">network_tr_ctrl_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_TR_CTRL</span><span class="p">,</span> <span class="n">crc</span><span class="p">,</span> <span class="n">enable</span><span class="p">);</span>
	<span class="o">*</span><span class="n">R_NETWORK_TR_CTRL</span> <span class="o">=</span> <span class="n">network_tr_ctrl_shadow</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* enable the irq&#39;s for ethernet DMA */</span>

	<span class="o">*</span><span class="n">R_IRQ_MASK2_SET</span> <span class="o">=</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK2_SET</span><span class="p">,</span> <span class="n">dma0_eop</span><span class="p">,</span> <span class="n">set</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK2_SET</span><span class="p">,</span> <span class="n">dma1_eop</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>

	<span class="o">*</span><span class="n">R_IRQ_MASK0_SET</span> <span class="o">=</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK0_SET</span><span class="p">,</span> <span class="n">overrun</span><span class="p">,</span>       <span class="n">set</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK0_SET</span><span class="p">,</span> <span class="n">underrun</span><span class="p">,</span>      <span class="n">set</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK0_SET</span><span class="p">,</span> <span class="n">excessive_col</span><span class="p">,</span> <span class="n">set</span><span class="p">);</span>

	<span class="cm">/* make sure the irqs are cleared */</span>

	<span class="o">*</span><span class="n">R_DMA_CH0_CLR_INTR</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH0_CLR_INTR</span><span class="p">,</span> <span class="n">clr_eop</span><span class="p">,</span> <span class="k">do</span><span class="p">);</span>
	<span class="o">*</span><span class="n">R_DMA_CH1_CLR_INTR</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH1_CLR_INTR</span><span class="p">,</span> <span class="n">clr_eop</span><span class="p">,</span> <span class="k">do</span><span class="p">);</span>

	<span class="cm">/* make sure the rec and transmit error counters are cleared */</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">*</span><span class="n">R_REC_COUNTERS</span><span class="p">;</span>  <span class="cm">/* dummy read */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="o">*</span><span class="n">R_TR_COUNTERS</span><span class="p">;</span>   <span class="cm">/* dummy read */</span>

	<span class="cm">/* start the receiving DMA channel so we can receive packets from now on */</span>

	<span class="o">*</span><span class="n">R_DMA_CH1_FIRST</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">myNextRxDesc</span><span class="p">);</span>
	<span class="o">*</span><span class="n">R_DMA_CH1_CMD</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH1_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">start</span><span class="p">);</span>

	<span class="cm">/* Set up transmit DMA channel so it can be restarted later */</span>

	<span class="o">*</span><span class="n">R_DMA_CH0_FIRST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">R_DMA_CH0_DESCR</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">myLastTxDesc</span><span class="p">);</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Probe for transceiver */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e100_probe_transceiver</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">grace_exit5</span><span class="p">;</span>

	<span class="cm">/* Start duplex/speed timers */</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speed_timer</span><span class="p">);</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">duplex_timer</span><span class="p">);</span>

	<span class="cm">/* We are now ready to accept transmit requeusts from</span>
<span class="cm">	 * the queueing layer of the networking.</span>
<span class="cm">	 */</span>
	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">grace_exit5:</span>
	<span class="n">cris_free_dma</span><span class="p">(</span><span class="n">NETWORK_RX_DMA_NBR</span><span class="p">,</span> <span class="n">cardname</span><span class="p">);</span>
<span class="nl">grace_exit4:</span>
	<span class="n">cris_free_dma</span><span class="p">(</span><span class="n">NETWORK_TX_DMA_NBR</span><span class="p">,</span> <span class="n">cardname</span><span class="p">);</span>
<span class="nl">grace_exit3:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">NETWORK_STATUS_IRQ_NBR</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">grace_exit2:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">NETWORK_DMA_TX_IRQ_NBR</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">grace_exit1:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">NETWORK_DMA_RX_IRQ_NBR</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">grace_exit0:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if defined(CONFIG_ETRAX_NO_PHY)</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dummy_check_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">current_speed</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">generic_check_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_100FULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_100HALF</span><span class="p">))</span>
		<span class="n">current_speed</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">current_speed</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tdk_check_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
				 <span class="n">MDIO_TDK_DIAGNOSTIC_REG</span><span class="p">);</span>
	<span class="n">current_speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">MDIO_TDK_DIAGNOSTIC_RATE</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">broadcom_check_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
				 <span class="n">MDIO_AUX_CTRL_STATUS_REG</span><span class="p">);</span>
	<span class="n">current_speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">MDIO_BC_SPEED</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_check_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
				 <span class="n">MDIO_INT_STATUS_REG_2</span><span class="p">);</span>
	<span class="n">current_speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">MDIO_INT_SPEED</span> <span class="o">?</span> <span class="mi">100</span> <span class="o">:</span> <span class="mi">10</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">e100_check_speed</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">led_initiated</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_speed</span> <span class="o">=</span> <span class="n">current_speed</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">transceiver_lock</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">BMSR_LSTATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">current_speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">transceiver</span><span class="o">-&gt;</span><span class="n">check_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">led_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">old_speed</span> <span class="o">!=</span> <span class="n">current_speed</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">led_initiated</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">led_initiated</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">e100_set_network_leds</span><span class="p">(</span><span class="n">NO_NETWORK_ACTIVITY</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_speed</span><span class="p">)</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">led_lock</span><span class="p">);</span>

	<span class="cm">/* Reinitialize the timer. */</span>
	<span class="n">speed_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">NET_LINK_UP_CHECK_INTERVAL</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speed_timer</span><span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">transceiver_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">e100_negotiate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
						<span class="n">MII_ADVERTISE</span><span class="p">);</span>

	<span class="cm">/* Discard old speed and duplex settings */</span>
	<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">ADVERTISE_100HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_100FULL</span> <span class="o">|</span>
	          <span class="n">ADVERTISE_10HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_10FULL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">current_speed_selection</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">10</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">current_duplex</span> <span class="o">==</span> <span class="n">full</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="n">ADVERTISE_10FULL</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">current_duplex</span> <span class="o">==</span> <span class="n">half</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="n">ADVERTISE_10HALF</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="n">ADVERTISE_10HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_10FULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">100</span>:
			 <span class="k">if</span> <span class="p">(</span><span class="n">current_duplex</span> <span class="o">==</span> <span class="n">full</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="n">ADVERTISE_100FULL</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">current_duplex</span> <span class="o">==</span> <span class="n">half</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="n">ADVERTISE_100HALF</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="n">ADVERTISE_100HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_100FULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">0</span>: <span class="cm">/* Auto */</span>
			 <span class="k">if</span> <span class="p">(</span><span class="n">current_duplex</span> <span class="o">==</span> <span class="n">full</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="n">ADVERTISE_100FULL</span> <span class="o">|</span> <span class="n">ADVERTISE_10FULL</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">current_duplex</span> <span class="o">==</span> <span class="n">half</span><span class="p">)</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="n">ADVERTISE_100HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_10HALF</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">data</span> <span class="o">|=</span> <span class="n">ADVERTISE_10HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_10FULL</span> <span class="o">|</span>
				  <span class="n">ADVERTISE_100HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_100FULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span> <span class="cm">/* assume autoneg speed and duplex */</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">ADVERTISE_10HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_10FULL</span> <span class="o">|</span>
				  <span class="n">ADVERTISE_100HALF</span> <span class="o">|</span> <span class="n">ADVERTISE_100FULL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e100_set_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autoneg_normal</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Renegotiate with link partner */</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Don&#39;t negotiate speed or duplex */</span>
		<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">BMCR_ANENABLE</span> <span class="o">|</span> <span class="n">BMCR_ANRESTART</span><span class="p">);</span>

		<span class="cm">/* Set speed and duplex static */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_speed_selection</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMCR_SPEED100</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">BMCR_SPEED100</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">current_duplex</span> <span class="o">!=</span> <span class="n">full</span><span class="p">)</span>
			<span class="n">data</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">data</span> <span class="o">|=</span> <span class="n">BMCR_FULLDPLX</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e100_set_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">e100_set_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">transceiver_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">!=</span> <span class="n">current_speed_selection</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">current_speed_selection</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
		<span class="n">e100_negotiate</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">transceiver_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">e100_check_duplex</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">old_duplex</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">transceiver_lock</span><span class="p">);</span>
	<span class="n">old_duplex</span> <span class="o">=</span> <span class="n">full_duplex</span><span class="p">;</span>
	<span class="n">transceiver</span><span class="o">-&gt;</span><span class="n">check_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">old_duplex</span> <span class="o">!=</span> <span class="n">full_duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Duplex changed */</span>
		<span class="n">SETF</span><span class="p">(</span><span class="n">network_rec_config_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_REC_CONFIG</span><span class="p">,</span> <span class="n">duplex</span><span class="p">,</span> <span class="n">full_duplex</span><span class="p">);</span>
		<span class="o">*</span><span class="n">R_NETWORK_REC_CONFIG</span> <span class="o">=</span> <span class="n">network_rec_config_shadow</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Reinitialize the timer. */</span>
	<span class="n">duplex_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">NET_DUPLEX_CHECK_INTERVAL</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">duplex_timer</span><span class="p">);</span>
	<span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">full_duplex</span> <span class="o">=</span> <span class="n">full_duplex</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">transceiver_lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#if defined(CONFIG_ETRAX_NO_PHY)</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">dummy_check_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">generic_check_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_ADVERTISE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_10FULL</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">ADVERTISE_100FULL</span><span class="p">))</span>
		<span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">full_duplex</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">tdk_check_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
				 <span class="n">MDIO_TDK_DIAGNOSTIC_REG</span><span class="p">);</span>
	<span class="n">full_duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">MDIO_TDK_DIAGNOSTIC_DPLX</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">broadcom_check_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
				 <span class="n">MDIO_AUX_CTRL_STATUS_REG</span><span class="p">);</span>
	<span class="n">full_duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">MDIO_BC_FULL_DUPLEX_IND</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">intel_check_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span>
				 <span class="n">MDIO_INT_STATUS_REG_2</span><span class="p">);</span>
	<span class="n">full_duplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span> <span class="o">&amp;</span> <span class="n">MDIO_INT_FULL_DUPLEX_IND</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">e100_set_duplex</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">duplex</span> <span class="n">new_duplex</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">transceiver_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_duplex</span> <span class="o">!=</span> <span class="n">current_duplex</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">current_duplex</span> <span class="o">=</span> <span class="n">new_duplex</span><span class="p">;</span>
		<span class="n">e100_negotiate</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">transceiver_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">e100_probe_transceiver</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if !defined(CONFIG_ETRAX_NO_PHY)</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phyid_high</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phyid_low</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">oui</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">transceiver_ops</span><span class="o">*</span> <span class="n">ops</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">transceiver_lock</span><span class="p">);</span>

	<span class="cm">/* Probe MDIO physical address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">&lt;=</span> <span class="mi">31</span><span class="p">;</span>
	     <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
				      <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMSR</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xffff</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">==</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get manufacturer */</span>
	<span class="n">phyid_high</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_PHYSID1</span><span class="p">);</span>
	<span class="n">phyid_low</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_PHYSID2</span><span class="p">);</span>
	<span class="n">oui</span> <span class="o">=</span> <span class="p">(</span><span class="n">phyid_high</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phyid_low</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">transceivers</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">oui</span><span class="p">;</span> <span class="n">ops</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">oui</span> <span class="o">==</span> <span class="n">oui</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">transceiver</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">transceiver_lock</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">e100_get_mdio_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmd</span><span class="p">;</span>    <span class="cm">/* Data to be sent on MDIO port */</span>
	<span class="kt">int</span> <span class="n">data</span><span class="p">;</span>   <span class="cm">/* Data read from MDIO */</span>
	<span class="kt">int</span> <span class="n">bitCounter</span><span class="p">;</span>

	<span class="cm">/* Start of frame, OP Code, Physical Address, Register Address */</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">MDIO_START</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">MDIO_READ</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(</span><span class="n">location</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">e100_send_mdio_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Data... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bitCounter</span><span class="o">=</span><span class="mi">15</span><span class="p">;</span> <span class="n">bitCounter</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">bitCounter</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span> <span class="o">|=</span> <span class="p">(</span><span class="n">e100_receive_mdio_bit</span><span class="p">()</span> <span class="o">&lt;&lt;</span> <span class="n">bitCounter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">e100_set_mdio_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phy_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">location</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bitCounter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmd</span><span class="p">;</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">MDIO_START</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">MDIO_WRITE</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">phy_id</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span>
	      <span class="p">(</span><span class="n">location</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">e100_send_mdio_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="cm">/* Data... */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bitCounter</span><span class="o">=</span><span class="mi">15</span><span class="p">;</span> <span class="n">bitCounter</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="p">;</span> <span class="n">bitCounter</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e100_send_mdio_bit</span><span class="p">(</span><span class="n">GET_BIT</span><span class="p">(</span><span class="n">bitCounter</span><span class="p">,</span> <span class="n">value</span><span class="p">));</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">e100_send_mdio_cmd</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">write_cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">bitCounter</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">data</span> <span class="o">=</span> <span class="mh">0x2</span><span class="p">;</span>

	<span class="cm">/* Preamble */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bitCounter</span> <span class="o">=</span> <span class="mi">31</span><span class="p">;</span> <span class="n">bitCounter</span><span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bitCounter</span><span class="o">--</span><span class="p">)</span>
		<span class="n">e100_send_mdio_bit</span><span class="p">(</span><span class="n">GET_BIT</span><span class="p">(</span><span class="n">bitCounter</span><span class="p">,</span> <span class="n">MDIO_PREAMBLE</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bitCounter</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">bitCounter</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">;</span> <span class="n">bitCounter</span><span class="o">--</span><span class="p">)</span>
		<span class="n">e100_send_mdio_bit</span><span class="p">(</span><span class="n">GET_BIT</span><span class="p">(</span><span class="n">bitCounter</span><span class="p">,</span> <span class="n">cmd</span><span class="p">));</span>

	<span class="cm">/* Turnaround */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">bitCounter</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">bitCounter</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">bitCounter</span><span class="o">--</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">write_cmd</span><span class="p">)</span>
			<span class="n">e100_send_mdio_bit</span><span class="p">(</span><span class="n">GET_BIT</span><span class="p">(</span><span class="n">bitCounter</span><span class="p">,</span> <span class="n">data</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">e100_receive_mdio_bit</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">e100_send_mdio_bit</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="o">*</span><span class="n">R_NETWORK_MGM_CTRL</span> <span class="o">=</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_NETWORK_MGM_CTRL</span><span class="p">,</span> <span class="n">mdoe</span><span class="p">,</span> <span class="n">enable</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_FIELD</span><span class="p">(</span><span class="n">R_NETWORK_MGM_CTRL</span><span class="p">,</span> <span class="n">mdio</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">R_NETWORK_MGM_CTRL</span> <span class="o">=</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_NETWORK_MGM_CTRL</span><span class="p">,</span> <span class="n">mdoe</span><span class="p">,</span> <span class="n">enable</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_NETWORK_MGM_CTRL</span><span class="p">,</span> <span class="n">mdck</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_FIELD</span><span class="p">(</span><span class="n">R_NETWORK_MGM_CTRL</span><span class="p">,</span> <span class="n">mdio</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>
<span class="nf">e100_receive_mdio_bit</span><span class="p">()</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bit</span><span class="p">;</span>
	<span class="o">*</span><span class="n">R_NETWORK_MGM_CTRL</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bit</span> <span class="o">=</span> <span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_NETWORK_STAT</span><span class="p">,</span> <span class="n">mdio</span><span class="p">,</span> <span class="o">*</span><span class="n">R_NETWORK_STAT</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">R_NETWORK_MGM_CTRL</span> <span class="o">=</span> <span class="n">IO_MASK</span><span class="p">(</span><span class="n">R_NETWORK_MGM_CTRL</span><span class="p">,</span> <span class="n">mdck</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bit</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">e100_reset_transceiver</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bitCounter</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">e100_get_mdio_reg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span><span class="p">,</span> <span class="n">MII_BMCR</span><span class="p">);</span>

	<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="n">MDIO_START</span> <span class="o">&lt;&lt;</span> <span class="mi">14</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">MDIO_WRITE</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">.</span><span class="n">phy_id</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">MII_BMCR</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">e100_send_mdio_cmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">data</span> <span class="o">|=</span> <span class="mh">0x8000</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">bitCounter</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">bitCounter</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">bitCounter</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e100_send_mdio_bit</span><span class="p">(</span><span class="n">GET_BIT</span><span class="p">(</span><span class="n">bitCounter</span><span class="p">,</span> <span class="n">data</span><span class="p">));</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* Called by upper layers if they decide it took too long to complete</span>
<span class="cm"> * sending a packet - we need to reset and stuff.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">e100_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;%s: transmit timed out, %s?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
	       <span class="n">tx_done</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;IRQ problem&quot;</span> <span class="o">:</span> <span class="s">&quot;network cable problem&quot;</span><span class="p">);</span>

	<span class="cm">/* remember we got an error */</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* reset the TX DMA in case it has hung on something */</span>

	<span class="n">RESET_DMA</span><span class="p">(</span><span class="n">NETWORK_TX_DMA_NBR</span><span class="p">);</span>
	<span class="n">WAIT_DMA</span><span class="p">(</span><span class="n">NETWORK_TX_DMA_NBR</span><span class="p">);</span>

	<span class="cm">/* Reset the transceiver. */</span>

	<span class="n">e100_reset_transceiver</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* and get rid of the packets that never got an interrupt */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">myFirstTxDesc</span> <span class="o">!=</span> <span class="n">myNextTxDesc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">myFirstTxDesc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">myFirstTxDesc</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">myFirstTxDesc</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">myFirstTxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set up transmit DMA channel so it can be restarted later */</span>
	<span class="o">*</span><span class="n">R_DMA_CH0_FIRST</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">R_DMA_CH0_DESCR</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">myLastTxDesc</span><span class="p">);</span>

	<span class="cm">/* tell the upper layers we&#39;re ok again */</span>

	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* This will only be invoked if the driver is _not_ in XOFF state.</span>
<span class="cm"> * What this means is that we need not check it, and that this</span>
<span class="cm"> * invariant will hold if we make sure that the netif_*_queue()</span>
<span class="cm"> * calls are done at the proper times.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">e100_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

<span class="cp">#ifdef ETHDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;send packet len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>  <span class="cm">/* protect from tx_interrupt and ourself */</span>

	<span class="n">myNextTxDesc</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* NETIF_F_LLTX driver :( */</span>

	<span class="n">e100_hardware_send_packet</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="n">myNextTxDesc</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">myNextTxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>

	<span class="cm">/* Stop queue if full */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">myNextTxDesc</span> <span class="o">==</span> <span class="n">myFirstTxDesc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The typical workload of the driver:</span>
<span class="cm"> *   Handle the network interface interrupts.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">e100rxtx_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqbits</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Note that both rx and tx interrupts are blocked at this point,</span>
<span class="cm">	 * regardless of which got us here.</span>
<span class="cm">	 */</span>

	<span class="n">irqbits</span> <span class="o">=</span> <span class="o">*</span><span class="n">R_IRQ_MASK2_RD</span><span class="p">;</span>

	<span class="cm">/* Handle received packets */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqbits</span> <span class="o">&amp;</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK2_RD</span><span class="p">,</span> <span class="n">dma1_eop</span><span class="p">,</span> <span class="n">active</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* acknowledge the eop interrupt */</span>

		<span class="o">*</span><span class="n">R_DMA_CH1_CLR_INTR</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH1_CLR_INTR</span><span class="p">,</span> <span class="n">clr_eop</span><span class="p">,</span> <span class="k">do</span><span class="p">);</span>

		<span class="cm">/* check if one or more complete packets were indeed received */</span>

		<span class="k">while</span> <span class="p">((</span><span class="o">*</span><span class="n">R_DMA_CH1_FIRST</span> <span class="o">!=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">myNextRxDesc</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		       <span class="p">(</span><span class="n">myNextRxDesc</span> <span class="o">!=</span> <span class="n">myLastRxDesc</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Take out the buffer and give it to the OS, then</span>
<span class="cm">			 * allocate a new buffer to put a packet in.</span>
<span class="cm">			 */</span>
			<span class="n">e100_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
			<span class="cm">/* restart/continue on the channel, for safety */</span>
			<span class="o">*</span><span class="n">R_DMA_CH1_CMD</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH1_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">restart</span><span class="p">);</span>
			<span class="cm">/* clear dma channel 1 eop/descr irq bits */</span>
			<span class="o">*</span><span class="n">R_DMA_CH1_CLR_INTR</span> <span class="o">=</span>
				<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH1_CLR_INTR</span><span class="p">,</span> <span class="n">clr_eop</span><span class="p">,</span> <span class="k">do</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH1_CLR_INTR</span><span class="p">,</span> <span class="n">clr_descr</span><span class="p">,</span> <span class="k">do</span><span class="p">);</span>

			<span class="cm">/* now, we might have gotten another packet</span>
<span class="cm">			   so we have to loop back and check if so */</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Report any packets that have been sent */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">myFirstTxDesc</span><span class="p">)</span> <span class="o">!=</span> <span class="o">*</span><span class="n">R_DMA_CH0_FIRST</span> <span class="o">&amp;&amp;</span>
	       <span class="p">(</span><span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">||</span> <span class="n">myFirstTxDesc</span> <span class="o">!=</span> <span class="n">myNextTxDesc</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">myFirstTxDesc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* dma is ready with the transmission of the data in tx_skb, so now</span>
<span class="cm">		   we can release the skb memory */</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">myFirstTxDesc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">myFirstTxDesc</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">myFirstTxDesc</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">myFirstTxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
                <span class="cm">/* Wake up queue. */</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irqbits</span> <span class="o">&amp;</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK2_RD</span><span class="p">,</span> <span class="n">dma0_eop</span><span class="p">,</span> <span class="n">active</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* acknowledge the eop interrupt. */</span>
		<span class="o">*</span><span class="n">R_DMA_CH0_CLR_INTR</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH0_CLR_INTR</span><span class="p">,</span> <span class="n">clr_eop</span><span class="p">,</span> <span class="k">do</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">e100nw_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irqbits</span> <span class="o">=</span> <span class="o">*</span><span class="n">R_IRQ_MASK0_RD</span><span class="p">;</span>

	<span class="cm">/* check for underrun irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqbits</span> <span class="o">&amp;</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK0_RD</span><span class="p">,</span> <span class="n">underrun</span><span class="p">,</span> <span class="n">active</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SETS</span><span class="p">(</span><span class="n">network_tr_ctrl_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_TR_CTRL</span><span class="p">,</span> <span class="n">clr_error</span><span class="p">,</span> <span class="n">clr</span><span class="p">);</span>
		<span class="o">*</span><span class="n">R_NETWORK_TR_CTRL</span> <span class="o">=</span> <span class="n">network_tr_ctrl_shadow</span><span class="p">;</span>
		<span class="n">SETS</span><span class="p">(</span><span class="n">network_tr_ctrl_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_TR_CTRL</span><span class="p">,</span> <span class="n">clr_error</span><span class="p">,</span> <span class="n">nop</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">D</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ethernet receiver underrun!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* check for overrun irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqbits</span> <span class="o">&amp;</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK0_RD</span><span class="p">,</span> <span class="n">overrun</span><span class="p">,</span> <span class="n">active</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">update_rx_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span> <span class="cm">/* this will ack the irq */</span>
		<span class="n">D</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ethernet receiver overrun!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="cm">/* check for excessive collision irq */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irqbits</span> <span class="o">&amp;</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK0_RD</span><span class="p">,</span> <span class="n">excessive_col</span><span class="p">,</span> <span class="n">active</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">SETS</span><span class="p">(</span><span class="n">network_tr_ctrl_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_TR_CTRL</span><span class="p">,</span> <span class="n">clr_error</span><span class="p">,</span> <span class="n">clr</span><span class="p">);</span>
		<span class="o">*</span><span class="n">R_NETWORK_TR_CTRL</span> <span class="o">=</span> <span class="n">network_tr_ctrl_shadow</span><span class="p">;</span>
		<span class="n">SETS</span><span class="p">(</span><span class="n">network_tr_ctrl_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_TR_CTRL</span><span class="p">,</span> <span class="n">clr_error</span><span class="p">,</span> <span class="n">nop</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">D</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;ethernet excessive collisions!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* We have a good packet(s), get it/them out of the buffers. */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">e100_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">skb_data_ptr</span><span class="p">;</span>
<span class="cp">#ifdef ETHDEBUG</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">etrax_eth_descr</span> <span class="o">*</span><span class="n">prevRxDesc</span><span class="p">;</span>  <span class="cm">/* The descriptor right before myNextRxDesc */</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">led_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">led_active</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">led_next_time</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* light the network leds depending on the current speed. */</span>
		<span class="n">e100_set_network_leds</span><span class="p">(</span><span class="n">NETWORK_ACTIVITY</span><span class="p">);</span>

		<span class="cm">/* Set the earliest time we may clear the LED */</span>
		<span class="n">led_next_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">NET_FLASH_TIME</span><span class="p">;</span>
		<span class="n">led_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clear_led_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">led_lock</span><span class="p">);</span>

	<span class="n">length</span> <span class="o">=</span> <span class="n">myNextRxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">hw_len</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">length</span><span class="p">;</span>

<span class="cp">#ifdef ETHDEBUG</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Got a packet of length %d:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="cm">/* dump the first bytes in the packet */</span>
	<span class="n">skb_data_ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">phys_to_virt</span><span class="p">(</span><span class="n">myNextRxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%d: %.2x %.2x %.2x %.2x %.2x %.2x %.2x %.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span> <span class="o">*</span> <span class="mi">8</span><span class="p">,</span>
		       <span class="n">skb_data_ptr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">skb_data_ptr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="n">skb_data_ptr</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="n">skb_data_ptr</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		       <span class="n">skb_data_ptr</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="n">skb_data_ptr</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="n">skb_data_ptr</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="n">skb_data_ptr</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>
		<span class="n">skb_data_ptr</span> <span class="o">+=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">RX_COPYBREAK</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Small packet, copy data */</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">length</span> <span class="o">-</span> <span class="n">ETHER_HEAD_LEN</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: Memory squeeze, dropping packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">update_nextrxdesc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span> <span class="o">-</span> <span class="n">ETHER_HEAD_LEN</span><span class="p">);</span>        <span class="cm">/* allocate room for the packet body */</span>
		<span class="n">skb_data_ptr</span> <span class="o">=</span> <span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">ETHER_HEAD_LEN</span><span class="p">);</span> <span class="cm">/* allocate room for the header */</span>

<span class="cp">#ifdef ETHDEBUG</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;head = 0x%x, data = 0x%x, tail = 0x%x, end = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">head</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb_tail_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">),</span>
		       <span class="n">skb_end_pointer</span><span class="p">(</span><span class="n">skb</span><span class="p">));</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;copying packet to 0x%x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb_data_ptr</span><span class="p">);</span>
<span class="cp">#endif</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_data_ptr</span><span class="p">,</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">myNextRxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">buf</span><span class="p">),</span> <span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Large packet, send directly to upper layers and allocate new</span>
<span class="cm">		 * memory (aligned to cache line boundary to avoid bug).</span>
<span class="cm">		 * Before sending the skb to upper layers we must make sure</span>
<span class="cm">		 * that skb-&gt;data points to the aligned start of the packet.</span>
<span class="cm">		 */</span>
		<span class="kt">int</span> <span class="n">align</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">new_skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">MAX_MEDIA_DATA_SIZE</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">L1_CACHE_BYTES</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;%s: Memory squeeze, dropping packet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">update_nextrxdesc</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">myNextRxDesc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="p">;</span>
		<span class="n">align</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">phys_to_virt</span><span class="p">(</span><span class="n">myNextRxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">length</span> <span class="o">+</span> <span class="n">align</span><span class="p">);</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">align</span><span class="p">);</span> <span class="cm">/* Remove alignment bytes */</span>
		<span class="n">myNextRxDesc</span><span class="o">-&gt;</span><span class="n">skb</span> <span class="o">=</span> <span class="n">new_skb</span><span class="p">;</span>
		<span class="n">myNextRxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">L1_CACHE_ALIGN</span><span class="p">(</span><span class="n">virt_to_phys</span><span class="p">(</span><span class="n">myNextRxDesc</span><span class="o">-&gt;</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Send the packet to the upper layers */</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

  <span class="nl">update_nextrxdesc:</span>
	<span class="cm">/* Prepare for next packet */</span>
	<span class="n">myNextRxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">prevRxDesc</span> <span class="o">=</span> <span class="n">myNextRxDesc</span><span class="p">;</span>
	<span class="n">myNextRxDesc</span> <span class="o">=</span> <span class="n">phys_to_virt</span><span class="p">(</span><span class="n">myNextRxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>

	<span class="n">rx_queue_len</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* Check if descriptors should be returned */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_queue_len</span> <span class="o">==</span> <span class="n">RX_QUEUE_THRESHOLD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">flush_etrax_cache</span><span class="p">();</span>
		<span class="n">prevRxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">|=</span> <span class="n">d_eol</span><span class="p">;</span>
		<span class="n">myLastRxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">d_eol</span><span class="p">;</span>
		<span class="n">myLastRxDesc</span> <span class="o">=</span> <span class="n">prevRxDesc</span><span class="p">;</span>
		<span class="n">rx_queue_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* The inverse routine to net_open(). */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">e100_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Closing %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="o">*</span><span class="n">R_IRQ_MASK0_CLR</span> <span class="o">=</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK0_CLR</span><span class="p">,</span> <span class="n">overrun</span><span class="p">,</span> <span class="n">clr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK0_CLR</span><span class="p">,</span> <span class="n">underrun</span><span class="p">,</span> <span class="n">clr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK0_CLR</span><span class="p">,</span> <span class="n">excessive_col</span><span class="p">,</span> <span class="n">clr</span><span class="p">);</span>

	<span class="o">*</span><span class="n">R_IRQ_MASK2_CLR</span> <span class="o">=</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK2_CLR</span><span class="p">,</span> <span class="n">dma0_descr</span><span class="p">,</span> <span class="n">clr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK2_CLR</span><span class="p">,</span> <span class="n">dma0_eop</span><span class="p">,</span> <span class="n">clr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK2_CLR</span><span class="p">,</span> <span class="n">dma1_descr</span><span class="p">,</span> <span class="n">clr</span><span class="p">)</span> <span class="o">|</span>
		<span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_IRQ_MASK2_CLR</span><span class="p">,</span> <span class="n">dma1_eop</span><span class="p">,</span> <span class="n">clr</span><span class="p">);</span>

	<span class="cm">/* Stop the receiver and the transmitter */</span>

	<span class="n">RESET_DMA</span><span class="p">(</span><span class="n">NETWORK_TX_DMA_NBR</span><span class="p">);</span>
	<span class="n">RESET_DMA</span><span class="p">(</span><span class="n">NETWORK_RX_DMA_NBR</span><span class="p">);</span>

	<span class="cm">/* Flush the Tx and disable Rx here. */</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">NETWORK_DMA_RX_IRQ_NBR</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">NETWORK_DMA_TX_IRQ_NBR</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">NETWORK_STATUS_IRQ_NBR</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">cris_free_dma</span><span class="p">(</span><span class="n">NETWORK_TX_DMA_NBR</span><span class="p">,</span> <span class="n">cardname</span><span class="p">);</span>
	<span class="n">cris_free_dma</span><span class="p">(</span><span class="n">NETWORK_RX_DMA_NBR</span><span class="p">,</span> <span class="n">cardname</span><span class="p">);</span>

	<span class="cm">/* Update the statistics here. */</span>

	<span class="n">update_rx_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
	<span class="n">update_tx_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>

	<span class="cm">/* Stop speed/duplex timers */</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">speed_timer</span><span class="p">);</span>
	<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">duplex_timer</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">e100_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">mii_ioctl_data</span> <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">ifr</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">old_autoneg</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span> <span class="cm">/* Preempt protection */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* The ioctls below should be considered obsolete but are */</span>
		<span class="cm">/* still present for compatibility with old scripts/apps  */</span>
		<span class="k">case</span> <span class="n">SET_ETH_SPEED_10</span>:                  <span class="cm">/* 10 Mbps */</span>
			<span class="n">e100_set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SET_ETH_SPEED_100</span>:                <span class="cm">/* 100 Mbps */</span>
			<span class="n">e100_set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SET_ETH_SPEED_AUTO</span>:        <span class="cm">/* Auto-negotiate speed */</span>
			<span class="n">e100_set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SET_ETH_DUPLEX_HALF</span>:       <span class="cm">/* Half duplex */</span>
			<span class="n">e100_set_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">half</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SET_ETH_DUPLEX_FULL</span>:       <span class="cm">/* Full duplex */</span>
			<span class="n">e100_set_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">full</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SET_ETH_DUPLEX_AUTO</span>:       <span class="cm">/* Auto-negotiate duplex */</span>
			<span class="n">e100_set_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">autoneg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	        <span class="k">case</span> <span class="n">SET_ETH_AUTONEG</span>:
			<span class="n">old_autoneg</span> <span class="o">=</span> <span class="n">autoneg_normal</span><span class="p">;</span>
		        <span class="n">autoneg_normal</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span><span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">autoneg_normal</span> <span class="o">!=</span> <span class="n">old_autoneg</span><span class="p">)</span>
				<span class="n">e100_negotiate</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">rc</span> <span class="o">=</span> <span class="n">generic_mii_ioctl</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">if_mii</span><span class="p">(</span><span class="n">ifr</span><span class="p">),</span>
						<span class="n">cmd</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_get_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">mii_ethtool_gset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">mii_if</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* The PHY may support 1000baseT, but the Etrax100 does not.  */</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">supported</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">SUPPORTED_1000baseT_Half</span>
			    <span class="o">|</span> <span class="n">SUPPORTED_1000baseT_Full</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_set_settings</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ethtool_cmd</span> <span class="o">*</span><span class="n">ecmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">autoneg</span> <span class="o">==</span> <span class="n">AUTONEG_ENABLE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e100_set_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">autoneg</span><span class="p">);</span>
		<span class="n">e100_set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">e100_set_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">duplex</span> <span class="o">==</span> <span class="n">DUPLEX_HALF</span> <span class="o">?</span> <span class="n">half</span> <span class="o">:</span> <span class="n">full</span><span class="p">);</span>
		<span class="n">e100_set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ecmd</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">==</span> <span class="n">SPEED_10</span> <span class="o">?</span> <span class="mi">10</span><span class="o">:</span> <span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">e100_get_drvinfo</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">ethtool_drvinfo</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">,</span> <span class="s">&quot;ETRAX 100LX&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">,</span> <span class="s">&quot;$Revision: 1.31 $&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">,</span> <span class="s">&quot;N/A&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">fw_version</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">,</span> <span class="s">&quot;N/A&quot;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">bus_info</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">e100_nway_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">current_duplex</span> <span class="o">==</span> <span class="n">autoneg</span> <span class="o">&amp;&amp;</span> <span class="n">current_speed_selection</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">e100_negotiate</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">ethtool_ops</span> <span class="n">e100_ethtool_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_settings</span>	<span class="o">=</span> <span class="n">e100_get_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_settings</span>	<span class="o">=</span> <span class="n">e100_set_settings</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_drvinfo</span>	<span class="o">=</span> <span class="n">e100_get_drvinfo</span><span class="p">,</span>
	<span class="p">.</span><span class="n">nway_reset</span>	<span class="o">=</span> <span class="n">e100_nway_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_link</span>	<span class="o">=</span> <span class="n">ethtool_op_get_link</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">e100_set_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifmap</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span> <span class="cm">/* Preempt protection */</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IF_PORT_UNKNOWN</span>:
			<span class="cm">/* Use autoneg */</span>
			<span class="n">e100_set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">e100_set_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">autoneg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IF_PORT_10BASET</span>:
			<span class="n">e100_set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
			<span class="n">e100_set_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">autoneg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IF_PORT_100BASET</span>:
		<span class="k">case</span> <span class="n">IF_PORT_100BASETX</span>:
			<span class="n">e100_set_speed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">100</span><span class="p">);</span>
			<span class="n">e100_set_duplex</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">autoneg</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">IF_PORT_100BASEFX</span>:
		<span class="k">case</span> <span class="n">IF_PORT_10BASE2</span>:
		<span class="k">case</span> <span class="n">IF_PORT_AUI</span>:
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: Invalid media selected&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">update_rx_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">R_REC_COUNTERS</span><span class="p">;</span>
	<span class="cm">/* update stats relevant to reception errors */</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">rx_fifo_errors</span> <span class="o">+=</span> <span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_REC_COUNTERS</span><span class="p">,</span> <span class="n">congestion</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span> <span class="o">+=</span> <span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_REC_COUNTERS</span><span class="p">,</span> <span class="n">crc_error</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">rx_frame_errors</span> <span class="o">+=</span> <span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_REC_COUNTERS</span><span class="p">,</span> <span class="n">alignment_error</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">rx_length_errors</span> <span class="o">+=</span> <span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_REC_COUNTERS</span><span class="p">,</span> <span class="n">oversize</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">update_tx_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">es</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">r</span> <span class="o">=</span> <span class="o">*</span><span class="n">R_TR_COUNTERS</span><span class="p">;</span>
	<span class="cm">/* update stats relevant to transmission errors */</span>
	<span class="n">es</span><span class="o">-&gt;</span><span class="n">collisions</span> <span class="o">+=</span>
		<span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_TR_COUNTERS</span><span class="p">,</span> <span class="n">single_col</span><span class="p">,</span> <span class="n">r</span><span class="p">)</span> <span class="o">+</span>
		<span class="n">IO_EXTRACT</span><span class="p">(</span><span class="n">R_TR_COUNTERS</span><span class="p">,</span> <span class="n">multiple_col</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the current statistics.</span>
<span class="cm"> * This may be called with the card open or closed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span>
<span class="nf">e100_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">update_rx_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>
	<span class="n">update_tx_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set or clear the multicast filter for this adaptor.</span>
<span class="cm"> * num_addrs == -1	Promiscuous mode, receive all packets</span>
<span class="cm"> * num_addrs == 0	Normal mode, clear multicast list</span>
<span class="cm"> * num_addrs &gt; 0	Multicast mode, receive normal and MC packets,</span>
<span class="cm"> *			and do best-effort filtering.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_multicast_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">lp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">num_addr</span> <span class="o">=</span> <span class="n">netdev_mc_count</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">lo_bits</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">int</span> <span class="n">hi_bits</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_PROMISC</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* promiscuous mode */</span>
		<span class="n">lo_bits</span> <span class="o">=</span> <span class="mh">0xfffffffful</span><span class="p">;</span>
		<span class="n">hi_bits</span> <span class="o">=</span> <span class="mh">0xfffffffful</span><span class="p">;</span>

		<span class="cm">/* Enable individual receive */</span>
		<span class="n">SETS</span><span class="p">(</span><span class="n">network_rec_config_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_REC_CONFIG</span><span class="p">,</span> <span class="n">individual</span><span class="p">,</span> <span class="n">receive</span><span class="p">);</span>
		<span class="o">*</span><span class="n">R_NETWORK_REC_CONFIG</span> <span class="o">=</span> <span class="n">network_rec_config_shadow</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_ALLMULTI</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* enable all multicasts */</span>
		<span class="n">lo_bits</span> <span class="o">=</span> <span class="mh">0xfffffffful</span><span class="p">;</span>
		<span class="n">hi_bits</span> <span class="o">=</span> <span class="mh">0xfffffffful</span><span class="p">;</span>

		<span class="cm">/* Disable individual receive */</span>
		<span class="n">SETS</span><span class="p">(</span><span class="n">network_rec_config_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_REC_CONFIG</span><span class="p">,</span> <span class="n">individual</span><span class="p">,</span> <span class="n">discard</span><span class="p">);</span>
		<span class="o">*</span><span class="n">R_NETWORK_REC_CONFIG</span> <span class="o">=</span>  <span class="n">network_rec_config_shadow</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">num_addr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Normal, clear the mc list */</span>
		<span class="n">lo_bits</span> <span class="o">=</span> <span class="mh">0x00000000ul</span><span class="p">;</span>
		<span class="n">hi_bits</span> <span class="o">=</span> <span class="mh">0x00000000ul</span><span class="p">;</span>

		<span class="cm">/* Disable individual receive */</span>
		<span class="n">SETS</span><span class="p">(</span><span class="n">network_rec_config_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_REC_CONFIG</span><span class="p">,</span> <span class="n">individual</span><span class="p">,</span> <span class="n">discard</span><span class="p">);</span>
		<span class="o">*</span><span class="n">R_NETWORK_REC_CONFIG</span> <span class="o">=</span>  <span class="n">network_rec_config_shadow</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* MC mode, receive normal and MC packets */</span>
		<span class="kt">char</span> <span class="n">hash_ix</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">netdev_hw_addr</span> <span class="o">*</span><span class="n">ha</span><span class="p">;</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">baddr</span><span class="p">;</span>

		<span class="n">lo_bits</span> <span class="o">=</span> <span class="mh">0x00000000ul</span><span class="p">;</span>
		<span class="n">hi_bits</span> <span class="o">=</span> <span class="mh">0x00000000ul</span><span class="p">;</span>
		<span class="n">netdev_for_each_mc_addr</span><span class="p">(</span><span class="n">ha</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Calculate the hash index for the GA registers */</span>

			<span class="n">hash_ix</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">baddr</span> <span class="o">=</span> <span class="n">ha</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">;</span>
			<span class="n">hash_ix</span> <span class="o">^=</span> <span class="p">(</span><span class="o">*</span><span class="n">baddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">hash_ix</span> <span class="o">^=</span> <span class="p">((</span><span class="o">*</span><span class="n">baddr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="o">++</span><span class="n">baddr</span><span class="p">;</span>
			<span class="n">hash_ix</span> <span class="o">^=</span> <span class="p">((</span><span class="o">*</span><span class="n">baddr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03c</span><span class="p">;</span>
			<span class="n">hash_ix</span> <span class="o">^=</span> <span class="p">((</span><span class="o">*</span><span class="n">baddr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="o">++</span><span class="n">baddr</span><span class="p">;</span>
			<span class="n">hash_ix</span> <span class="o">^=</span> <span class="p">((</span><span class="o">*</span><span class="n">baddr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">;</span>
			<span class="n">hash_ix</span> <span class="o">^=</span> <span class="p">((</span><span class="o">*</span><span class="n">baddr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="o">++</span><span class="n">baddr</span><span class="p">;</span>
			<span class="n">hash_ix</span> <span class="o">^=</span> <span class="p">(</span><span class="o">*</span><span class="n">baddr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>
			<span class="n">hash_ix</span> <span class="o">^=</span> <span class="p">((</span><span class="o">*</span><span class="n">baddr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">;</span>
			<span class="o">++</span><span class="n">baddr</span><span class="p">;</span>
			<span class="n">hash_ix</span> <span class="o">^=</span> <span class="p">((</span><span class="o">*</span><span class="n">baddr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x03c</span><span class="p">;</span>
			<span class="n">hash_ix</span> <span class="o">^=</span> <span class="p">((</span><span class="o">*</span><span class="n">baddr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="o">++</span><span class="n">baddr</span><span class="p">;</span>
			<span class="n">hash_ix</span> <span class="o">^=</span> <span class="p">((</span><span class="o">*</span><span class="n">baddr</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x30</span><span class="p">;</span>
			<span class="n">hash_ix</span> <span class="o">^=</span> <span class="p">((</span><span class="o">*</span><span class="n">baddr</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">;</span>

			<span class="n">hash_ix</span> <span class="o">&amp;=</span> <span class="mh">0x3f</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">hash_ix</span> <span class="o">&gt;=</span> <span class="mi">32</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">hi_bits</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">hash_ix</span><span class="o">-</span><span class="mi">32</span><span class="p">));</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">lo_bits</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hash_ix</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="cm">/* Disable individual receive */</span>
		<span class="n">SETS</span><span class="p">(</span><span class="n">network_rec_config_shadow</span><span class="p">,</span> <span class="n">R_NETWORK_REC_CONFIG</span><span class="p">,</span> <span class="n">individual</span><span class="p">,</span> <span class="n">discard</span><span class="p">);</span>
		<span class="o">*</span><span class="n">R_NETWORK_REC_CONFIG</span> <span class="o">=</span> <span class="n">network_rec_config_shadow</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="o">*</span><span class="n">R_NETWORK_GA_0</span> <span class="o">=</span> <span class="n">lo_bits</span><span class="p">;</span>
	<span class="o">*</span><span class="n">R_NETWORK_GA_1</span> <span class="o">=</span> <span class="n">hi_bits</span><span class="p">;</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lp</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">e100_hardware_send_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">D</span><span class="p">(</span><span class="n">printk</span><span class="p">(</span><span class="s">&quot;e100 send pack, buf 0x%x len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">length</span><span class="p">));</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">led_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">led_active</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">led_next_time</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* light the network leds depending on the current speed. */</span>
		<span class="n">e100_set_network_leds</span><span class="p">(</span><span class="n">NETWORK_ACTIVITY</span><span class="p">);</span>

		<span class="cm">/* Set the earliest time we may clear the LED */</span>
		<span class="n">led_next_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">NET_FLASH_TIME</span><span class="p">;</span>
		<span class="n">led_active</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">clear_led_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="o">/</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">led_lock</span><span class="p">);</span>

	<span class="cm">/* configure the tx dma descriptor */</span>
	<span class="n">myNextTxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">sw_len</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="n">myNextTxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">=</span> <span class="n">d_eop</span> <span class="o">|</span> <span class="n">d_eol</span> <span class="o">|</span> <span class="n">d_wait</span><span class="p">;</span>
	<span class="n">myNextTxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">buf</span> <span class="o">=</span> <span class="n">virt_to_phys</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

        <span class="cm">/* Move end of list */</span>
        <span class="n">myLastTxDesc</span><span class="o">-&gt;</span><span class="n">descr</span><span class="p">.</span><span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">d_eol</span><span class="p">;</span>
        <span class="n">myLastTxDesc</span> <span class="o">=</span> <span class="n">myNextTxDesc</span><span class="p">;</span>

	<span class="cm">/* Restart DMA channel */</span>
	<span class="o">*</span><span class="n">R_DMA_CH0_CMD</span> <span class="o">=</span> <span class="n">IO_STATE</span><span class="p">(</span><span class="n">R_DMA_CH0_CMD</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">restart</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">e100_clear_network_leds</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dummy</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">led_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">led_active</span> <span class="o">&amp;&amp;</span> <span class="n">time_after</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">led_next_time</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">e100_set_network_leds</span><span class="p">(</span><span class="n">NO_NETWORK_ACTIVITY</span><span class="p">);</span>

		<span class="cm">/* Set the earliest time we may set the LED */</span>
		<span class="n">led_next_time</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">NET_FLASH_PAUSE</span><span class="p">;</span>
		<span class="n">led_active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">np</span><span class="o">-&gt;</span><span class="n">led_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">e100_set_network_leds</span><span class="p">(</span><span class="kt">int</span> <span class="n">active</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined(CONFIG_ETRAX_NETWORK_LED_ON_WHEN_LINK)</span>
	<span class="kt">int</span> <span class="n">light_leds</span> <span class="o">=</span> <span class="p">(</span><span class="n">active</span> <span class="o">==</span> <span class="n">NO_NETWORK_ACTIVITY</span><span class="p">);</span>
<span class="cp">#elif defined(CONFIG_ETRAX_NETWORK_LED_ON_WHEN_ACTIVITY)</span>
	<span class="kt">int</span> <span class="n">light_leds</span> <span class="o">=</span> <span class="p">(</span><span class="n">active</span> <span class="o">==</span> <span class="n">NETWORK_ACTIVITY</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;Define either CONFIG_ETRAX_NETWORK_LED_ON_WHEN_LINK or CONFIG_ETRAX_NETWORK_LED_ON_WHEN_ACTIVITY&quot;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">current_speed</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Make LED red, link is down */</span>
		<span class="n">CRIS_LED_NETWORK_SET</span><span class="p">(</span><span class="n">CRIS_LED_OFF</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">light_leds</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">current_speed</span> <span class="o">==</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">CRIS_LED_NETWORK_SET</span><span class="p">(</span><span class="n">CRIS_LED_ORANGE</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">CRIS_LED_NETWORK_SET</span><span class="p">(</span><span class="n">CRIS_LED_GREEN</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">CRIS_LED_NETWORK_SET</span><span class="p">(</span><span class="n">CRIS_LED_OFF</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_NET_POLL_CONTROLLER</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">e100_netpoll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span><span class="o">*</span> <span class="n">netdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">e100rxtx_interrupt</span><span class="p">(</span><span class="n">NETWORK_DMA_TX_IRQ_NBR</span><span class="p">,</span> <span class="n">netdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">etrax_init_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">etrax_ethernet_init</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">e100_boot_setup</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sockaddr</span> <span class="n">sa</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Parse the colon separated Ethernet station address */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span>  <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">str</span> <span class="o">+</span> <span class="mi">3</span><span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="s">&quot;%2x&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Malformed station address&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">sa</span><span class="p">.</span><span class="n">sa_data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">default_mac</span> <span class="o">=</span> <span class="n">sa</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;etrax100_eth=&quot;</span><span class="p">,</span> <span class="n">e100_boot_setup</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">etrax_init_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
