<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › bonding › bond_sysfs.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>bond_sysfs.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright(c) 2004-2005 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License as published by the</span>
<span class="cm"> * Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY</span>
<span class="cm"> * or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License along</span>
<span class="cm"> * with this program; if not, write to the Free Software Foundation, Inc.,</span>
<span class="cm"> * 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> *</span>
<span class="cm"> * The full GNU General Public License is included in this distribution in the</span>
<span class="cm"> * file called LICENSE.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/inetdevice.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/inet.h&gt;</span>
<span class="cp">#include &lt;linux/rtnetlink.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/netns/generic.h&gt;</span>
<span class="cp">#include &lt;linux/nsproxy.h&gt;</span>

<span class="cp">#include &quot;bonding.h&quot;</span>

<span class="cp">#define to_dev(obj)	container_of(obj, struct device, kobj)</span>
<span class="cp">#define to_bond(cd)	((struct bonding *)(netdev_priv(to_net_dev(cd))))</span>

<span class="cm">/*</span>
<span class="cm"> * &quot;show&quot; function for the bond_masters attribute.</span>
<span class="cm"> * The class parameter is ignored.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_bonds</span><span class="p">(</span><span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">cls</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">class_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bond_net</span> <span class="o">*</span><span class="n">bn</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bond_net</span><span class="p">,</span> <span class="n">class_attr_bonding_masters</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span><span class="p">;</span>

	<span class="n">rtnl_lock</span><span class="p">();</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bn</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="n">bond_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">IFNAMSIZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* not enough space for another interface name */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">res</span><span class="p">,</span> <span class="s">&quot;++more++ &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">res</span><span class="p">,</span> <span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">res</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span> <span class="cm">/* eat the leftover space */</span>

	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">bond_get_by_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">bond_net</span> <span class="o">*</span><span class="n">bn</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bn</span><span class="o">-&gt;</span><span class="n">dev_list</span><span class="p">,</span> <span class="n">bond_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * &quot;store&quot; function for the bond_masters attribute.  This is what</span>
<span class="cm"> * creates and deletes entire bonds.</span>
<span class="cm"> *</span>
<span class="cm"> * The class parameter is ignored.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_bonds</span><span class="p">(</span><span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">cls</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">class_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bond_net</span> <span class="o">*</span><span class="n">bn</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bond_net</span><span class="p">,</span> <span class="n">class_attr_bonding_masters</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">command</span><span class="p">[</span><span class="n">IFNAMSIZ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rv</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">sscanf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%16s&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span> <span class="cm">/* IFNAMSIZ*/</span>
	<span class="n">ifname</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">dev_valid_name</span><span class="p">(</span><span class="n">ifname</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_no_cmd</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s is being created...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
		<span class="n">rv</span> <span class="o">=</span> <span class="n">bond_create</span><span class="p">(</span><span class="n">bn</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rv</span> <span class="o">==</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">)</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s already exists.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s creation failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="n">rv</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">bond_dev</span><span class="p">;</span>

		<span class="n">rtnl_lock</span><span class="p">();</span>
		<span class="n">bond_dev</span> <span class="o">=</span> <span class="n">bond_get_by_name</span><span class="p">(</span><span class="n">bn</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bond_dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s is being deleted...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
			<span class="n">unregister_netdevice</span><span class="p">(</span><span class="n">bond_dev</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to delete non-existent %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
			<span class="n">res</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="k">goto</span> <span class="n">err_no_cmd</span><span class="p">;</span>

	<span class="cm">/* Always return either count or an error.  If you return 0, you&#39;ll</span>
<span class="cm">	 * get called forever, which is bad.</span>
<span class="cm">	 */</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>

<span class="nl">err_no_cmd:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no command found in bonding_masters. Use +ifname or -ifname.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">bonding_namespace</span><span class="p">(</span><span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">cls</span><span class="p">,</span>
				     <span class="k">const</span> <span class="k">struct</span> <span class="n">class_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">bond_net</span> <span class="o">*</span><span class="n">bn</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">attr</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bond_net</span><span class="p">,</span> <span class="n">class_attr_bonding_masters</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bn</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* class attribute for bond_masters file.  This ends up in /sys/class/net */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">class_attribute</span> <span class="n">class_attr_bonding_masters</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bonding_masters&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">show</span> <span class="o">=</span> <span class="n">bonding_show_bonds</span><span class="p">,</span>
	<span class="p">.</span><span class="n">store</span> <span class="o">=</span> <span class="n">bonding_store_bonds</span><span class="p">,</span>
	<span class="p">.</span><span class="n">namespace</span> <span class="o">=</span> <span class="n">bonding_namespace</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">bond_create_slave_symlinks</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">slave</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">linkname</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="o">+</span><span class="mi">7</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* first, create a link from the slave back to the master */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">),</span>
				<span class="s">&quot;master&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="cm">/* next, create a link from the master to the slave */</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">linkname</span><span class="p">,</span> <span class="s">&quot;slave_%s&quot;</span><span class="p">,</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_link</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">),</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">),</span>
				<span class="n">linkname</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="kt">void</span> <span class="nf">bond_destroy_slave_symlinks</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">slave</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">linkname</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="o">+</span><span class="mi">7</span><span class="p">];</span>

	<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">),</span> <span class="s">&quot;master&quot;</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">linkname</span><span class="p">,</span> <span class="s">&quot;slave_%s&quot;</span><span class="p">,</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">sysfs_remove_link</span><span class="p">(</span><span class="o">&amp;</span><span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">),</span> <span class="n">linkname</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Show the slaves in the current bond.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_slaves</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slave</span> <span class="o">*</span><span class="n">slave</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">bond_for_each_slave</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="n">slave</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">IFNAMSIZ</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* not enough space for another interface name */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">res</span><span class="p">,</span> <span class="s">&quot;++more++ &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">res</span><span class="p">,</span> <span class="s">&quot;%s &quot;</span><span class="p">,</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">res</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span> <span class="cm">/* eat the leftover space */</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the slaves in the current bond.  The bond interface must be</span>
<span class="cm"> * up for this to succeed.</span>
<span class="cm"> * This is supposed to be only thin wrapper for bond_enslave and bond_release.</span>
<span class="cm"> * All hard work should be done there.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_slaves</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">command</span><span class="p">[</span><span class="n">IFNAMSIZ</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">};</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ifname</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">res</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtnl_trylock</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">restart_syscall</span><span class="p">();</span>

	<span class="n">sscanf</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="s">&quot;%16s&quot;</span><span class="p">,</span> <span class="n">command</span><span class="p">);</span> <span class="cm">/* IFNAMSIZ*/</span>
	<span class="n">ifname</span> <span class="o">=</span> <span class="n">command</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">strlen</span><span class="p">(</span><span class="n">command</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">dev_valid_name</span><span class="p">(</span><span class="n">ifname</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_no_cmd</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">__dev_get_by_name</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">ifname</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Interface %s does not exist!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">command</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
	<span class="k">case</span> <span class="sc">&#39;+&#39;</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Adding slave %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">bond_enslave</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="sc">&#39;-&#39;</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Removing slave %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">bond_release</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">goto</span> <span class="n">err_no_cmd</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">res</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

<span class="nl">err_no_cmd:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no command found in slaves file for bond %s. Use +ifname or -ifname.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">slaves</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">bonding_show_slaves</span><span class="p">,</span>
		   <span class="n">bonding_store_slaves</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show and set the bonding mode.  The bond interface must be down to</span>
<span class="cm"> * change the mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond_mode_tbl</span><span class="p">[</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span><span class="p">].</span><span class="n">modename</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to update mode of %s because interface is up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">slave_cnt</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to update mode of %s because it has slaves.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new_value</span> <span class="o">=</span> <span class="n">bond_parse_parm</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bond_mode_tbl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Ignoring invalid mode value %.*s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_value</span> <span class="o">==</span> <span class="n">BOND_MODE_ALB</span> <span class="o">||</span>
	     <span class="n">new_value</span> <span class="o">==</span> <span class="n">BOND_MODE_TLB</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">arp_interval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: %s mode is incompatible with arp monitoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bond_mode_tbl</span><span class="p">[</span><span class="n">new_value</span><span class="p">].</span><span class="n">modename</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
	<span class="n">bond_set_mode_ops</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: setting mode to %s (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bond_mode_tbl</span><span class="p">[</span><span class="n">new_value</span><span class="p">].</span><span class="n">modename</span><span class="p">,</span>
		<span class="n">new_value</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">mode</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_mode</span><span class="p">,</span> <span class="n">bonding_store_mode</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show and set the bonding transmit hash method.</span>
<span class="cm"> * The bond interface must be down to change the xmit hash policy.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_xmit_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">xmit_hashtype_tbl</span><span class="p">[</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">xmit_policy</span><span class="p">].</span><span class="n">modename</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">xmit_policy</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_xmit_hash</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Interface is up. Unable to update xmit policy.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new_value</span> <span class="o">=</span> <span class="n">bond_parse_parm</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">xmit_hashtype_tbl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Ignoring invalid xmit hash policy value %.*s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">xmit_policy</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
		<span class="n">bond_set_mode_ops</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: setting xmit hash policy to %s (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">xmit_hashtype_tbl</span><span class="p">[</span><span class="n">new_value</span><span class="p">].</span><span class="n">modename</span><span class="p">,</span> <span class="n">new_value</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">xmit_hash_policy</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_xmit_hash</span><span class="p">,</span> <span class="n">bonding_store_xmit_hash</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show and set arp_validate.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_arp_validate</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">arp_validate_tbl</span><span class="p">[</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">arp_validate</span><span class="p">].</span><span class="n">modename</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">arp_validate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_arp_validate</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">new_value</span> <span class="o">=</span> <span class="n">bond_parse_parm</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">arp_validate_tbl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Ignoring invalid arp_validate value %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">BOND_MODE_ACTIVEBACKUP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: arp_validate only supported in active-backup mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: setting arp_validate to %s (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">arp_validate_tbl</span><span class="p">[</span><span class="n">new_value</span><span class="p">].</span><span class="n">modename</span><span class="p">,</span>
		<span class="n">new_value</span><span class="p">);</span>

	<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">arp_validate</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">arp_validate</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">bonding_show_arp_validate</span><span class="p">,</span>
		   <span class="n">bonding_store_arp_validate</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show and store fail_over_mac.  User only allowed to change the</span>
<span class="cm"> * value when there are no slaves.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_fail_over_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">fail_over_mac_tbl</span><span class="p">[</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fail_over_mac</span><span class="p">].</span><span class="n">modename</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fail_over_mac</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_fail_over_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">slave_cnt</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Can&#39;t alter fail_over_mac with slaves in bond.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new_value</span> <span class="o">=</span> <span class="n">bond_parse_parm</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">fail_over_mac_tbl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Ignoring invalid fail_over_mac value %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">fail_over_mac</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Setting fail_over_mac to %s (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">fail_over_mac_tbl</span><span class="p">[</span><span class="n">new_value</span><span class="p">].</span><span class="n">modename</span><span class="p">,</span>
		<span class="n">new_value</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">fail_over_mac</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_fail_over_mac</span><span class="p">,</span> <span class="n">bonding_store_fail_over_mac</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show and set the arp timer interval.  There are two tricky bits</span>
<span class="cm"> * here.  First, if ARP monitoring is activated, then we must disable</span>
<span class="cm"> * MII monitoring.  Second, if the ARP timer isn&#39;t running, we must</span>
<span class="cm"> * start it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_arp_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">arp_interval</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_arp_interval</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: no arp_interval value specified.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Invalid arp_interval value %d not in range 1-%d; rejected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BOND_MODE_ALB</span> <span class="o">||</span>
	    <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BOND_MODE_TLB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: ARP monitoring cannot be used with ALB/TLB. Only MII monitoring is supported on %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Setting ARP monitoring interval to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">);</span>
	<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">arp_interval</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: ARP monitoring cannot be used with MII monitoring. %s Disabling MII monitoring.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">mii_work</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">mii_work</span><span class="p">);</span>
			<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">arp_targets</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: ARP monitoring has been set up, but no ARP targets have been specified.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If the interface is up, we may need to fire off</span>
<span class="cm">		 * the ARP timer.  If the interface is down, the</span>
<span class="cm">		 * timer will get fired off when the open function</span>
<span class="cm">		 * is called.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">arp_work</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BOND_MODE_ACTIVEBACKUP</span><span class="p">)</span>
				<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">arp_work</span><span class="p">,</span>
						  <span class="n">bond_activebackup_arp_mon</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">arp_work</span><span class="p">,</span>
						  <span class="n">bond_loadbalance_arp_mon</span><span class="p">);</span>

			<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">arp_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">arp_interval</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_arp_interval</span><span class="p">,</span> <span class="n">bonding_store_arp_interval</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show and set the arp targets.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_arp_targets</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">BOND_MAX_ARP_TARGETS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">arp_targets</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">res</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">res</span><span class="p">,</span> <span class="s">&quot;%pI4 &quot;</span><span class="p">,</span>
				       <span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">arp_targets</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">res</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span> <span class="cm">/* eat the leftover space */</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_arp_targets</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__be32</span> <span class="n">newtarget</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">__be32</span> <span class="o">*</span><span class="n">targets</span><span class="p">;</span>

	<span class="n">targets</span> <span class="o">=</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">arp_targets</span><span class="p">;</span>
	<span class="n">newtarget</span> <span class="o">=</span> <span class="n">in_aton</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/* look for adds */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;+&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">newtarget</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">newtarget</span> <span class="o">==</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_BROADCAST</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: invalid ARP target %pI4 specified for addition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newtarget</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* look for an empty slot to put the target in, and check for dupes */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">BOND_MAX_ARP_TARGETS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">done</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">newtarget</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* duplicate */</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: ARP target %pI4 is already present</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newtarget</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: adding ARP target %pI4.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newtarget</span><span class="p">);</span>
				<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">newtarget</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: ARP target table is full!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span>	<span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">newtarget</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">newtarget</span> <span class="o">==</span> <span class="n">htonl</span><span class="p">(</span><span class="n">INADDR_BROADCAST</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: invalid ARP target %pI4 specified for removal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newtarget</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">BOND_MAX_ARP_TARGETS</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">done</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">newtarget</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: removing ARP target %pI4.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newtarget</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="p">(</span><span class="n">j</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">BOND_MAX_ARP_TARGETS</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="n">targets</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span>
					<span class="n">targets</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">targets</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>

				<span class="n">targets</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: unable to remove nonexistent ARP target %pI4.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">newtarget</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no command found in arp_ip_targets file for bond %s. Use +&lt;addr&gt; or -&lt;addr&gt;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">arp_ip_target</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span> <span class="p">,</span> <span class="n">bonding_show_arp_targets</span><span class="p">,</span> <span class="n">bonding_store_arp_targets</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show and set the up and down delays.  These must be multiples of the</span>
<span class="cm"> * MII monitoring value, and are stored internally as the multiplier.</span>
<span class="cm"> * Thus, we must translate to MS for the real world.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_downdelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">downdelay</span> <span class="o">*</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_downdelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Unable to set down delay as MII monitoring is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: no down delay value specified.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Invalid down delay value %d not in range %d-%d; rejected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_value</span> <span class="o">%</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Warning: down delay (%d) is not a multiple of miimon (%d), delay rounded to %d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span>
				   <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">new_value</span> <span class="o">/</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">)</span> <span class="o">*</span>
				   <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">downdelay</span> <span class="o">=</span> <span class="n">new_value</span> <span class="o">/</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Setting down delay to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">downdelay</span> <span class="o">*</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">);</span>

	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">downdelay</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_downdelay</span><span class="p">,</span> <span class="n">bonding_store_downdelay</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_updelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">updelay</span> <span class="o">*</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_updelay</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Unable to set up delay as MII monitoring is disabled</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: no up delay value specified.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Invalid down delay value %d not in range %d-%d; rejected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">new_value</span> <span class="o">%</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_warning</span><span class="p">(</span><span class="s">&quot;%s: Warning: up delay (%d) is not a multiple of miimon (%d), updelay rounded to %d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span>
				   <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">,</span>
				   <span class="p">(</span><span class="n">new_value</span> <span class="o">/</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">)</span> <span class="o">*</span>
				   <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">updelay</span> <span class="o">=</span> <span class="n">new_value</span> <span class="o">/</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Setting up delay to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">updelay</span> <span class="o">*</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">updelay</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_updelay</span><span class="p">,</span> <span class="n">bonding_store_updelay</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show and set the LACP interval.  Interface must be down, and the mode</span>
<span class="cm"> * must be set to 802.3ad mode.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_lacp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bond_lacp_tbl</span><span class="p">[</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">lacp_fast</span><span class="p">].</span><span class="n">modename</span><span class="p">,</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">lacp_fast</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_lacp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Unable to update LACP rate because interface is up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">BOND_MODE_8023AD</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Unable to update LACP rate because bond is not in 802.3ad mode.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new_value</span> <span class="o">=</span> <span class="n">bond_parse_parm</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">bond_lacp_tbl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">new_value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">lacp_fast</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
		<span class="n">bond_3ad_update_lacp_rate</span><span class="p">(</span><span class="n">bond</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Setting LACP rate to %s (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bond_lacp_tbl</span><span class="p">[</span><span class="n">new_value</span><span class="p">].</span><span class="n">modename</span><span class="p">,</span>
			<span class="n">new_value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Ignoring invalid LACP rate value %.*s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">lacp_rate</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_lacp</span><span class="p">,</span> <span class="n">bonding_store_lacp</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_min_links</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">min_links</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_min_links</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_value</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">kstrtouint</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_value</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Ignoring invalid min links value %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Setting min links value to %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">);</span>
	<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">min_links</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">min_links</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_min_links</span><span class="p">,</span> <span class="n">bonding_store_min_links</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_ad_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">ad_select_tbl</span><span class="p">[</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ad_select</span><span class="p">].</span><span class="n">modename</span><span class="p">,</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ad_select</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_ad_select</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Unable to update ad_select because interface is up.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">new_value</span> <span class="o">=</span> <span class="n">bond_parse_parm</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">ad_select_tbl</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">ad_select</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Setting ad_select to %s (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ad_select_tbl</span><span class="p">[</span><span class="n">new_value</span><span class="p">].</span><span class="n">modename</span><span class="p">,</span>
			<span class="n">new_value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Ignoring invalid ad_select value %.*s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ad_select</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_ad_select</span><span class="p">,</span> <span class="n">bonding_store_ad_select</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show and set the number of peer notifications to send after a failover event.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_num_peer_notif</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_peer_notif</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_num_peer_notif</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">kstrtou8</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">num_peer_notif</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span> <span class="o">?</span> <span class="n">err</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">num_grat_arp</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_num_peer_notif</span><span class="p">,</span> <span class="n">bonding_store_num_peer_notif</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">num_unsol_na</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_num_peer_notif</span><span class="p">,</span> <span class="n">bonding_store_num_peer_notif</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show and set the MII monitor interval.  There are two tricky bits</span>
<span class="cm"> * here.  First, if MII monitoring is activated, then we must disable</span>
<span class="cm"> * ARP monitoring.  Second, if the timer isn&#39;t running, we must</span>
<span class="cm"> * start it.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_miimon</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_miimon</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: no miimon value specified.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Invalid miimon value %d not in range %d-%d; rejected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">INT_MAX</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Setting MII monitoring interval to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">);</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">updelay</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Note: Updating updelay (to %d) since it is a multiple of the miimon value.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">updelay</span> <span class="o">*</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">downdelay</span><span class="p">)</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Note: Updating downdelay (to %d) since it is a multiple of the miimon value.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
				<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">downdelay</span> <span class="o">*</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">miimon</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">arp_interval</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: MII monitoring cannot be used with ARP monitoring. Disabling ARP monitoring...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">arp_interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">arp_validate</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">arp_validate</span> <span class="o">=</span>
					<span class="n">BOND_ARP_VALIDATE_NONE</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">arp_work</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">arp_work</span><span class="p">);</span>
				<span class="n">flush_workqueue</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* If the interface is up, we may need to fire off</span>
<span class="cm">			 * the MII timer. If the interface is down, the</span>
<span class="cm">			 * timer will get fired off when the open function</span>
<span class="cm">			 * is called.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delayed_work_pending</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">mii_work</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">mii_work</span><span class="p">,</span>
						  <span class="n">bond_mii_monitor</span><span class="p">);</span>
				<span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">wq</span><span class="p">,</span>
						   <span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">mii_work</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">miimon</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_miimon</span><span class="p">,</span> <span class="n">bonding_store_miimon</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show and set the primary slave.  The store function is much</span>
<span class="cm"> * simpler than bonding_store_slaves function because it only needs to</span>
<span class="cm"> * handle one interface name.</span>
<span class="cm"> * The bond must be a mode that supports a primary for this be</span>
<span class="cm"> * set.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_primary</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">primary_slave</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">primary_slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_primary</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slave</span> <span class="o">*</span><span class="n">slave</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">ifname</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtnl_trylock</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">restart_syscall</span><span class="p">();</span>
	<span class="n">block_netpoll_tx</span><span class="p">();</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">curr_slave_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USES_PRIMARY</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Unable to set primary slave; %s is in mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%16s&quot;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span> <span class="cm">/* IFNAMSIZ */</span>

	<span class="cm">/* check to see if we are clearing primary */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">ifname</span><span class="p">)</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Setting primary slave to None.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">primary_slave</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bond_select_active_slave</span><span class="p">(</span><span class="n">bond</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bond_for_each_slave</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="n">slave</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Setting %s as primary slave.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">primary_slave</span> <span class="o">=</span> <span class="n">slave</span><span class="p">;</span>
			<span class="n">strcpy</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">primary</span><span class="p">,</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">bond_select_active_slave</span><span class="p">(</span><span class="n">bond</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">primary</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">);</span>
	<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">primary</span><span class="p">[</span><span class="n">IFNAMSIZ</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Recording %s as primary, &quot;</span>
		<span class="s">&quot;but it has not been enslaved to %s yet.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">curr_slave_lock</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">unblock_netpoll_tx</span><span class="p">();</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">primary</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_primary</span><span class="p">,</span> <span class="n">bonding_store_primary</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show and set the primary_reselect flag.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_primary_reselect</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">pri_reselect_tbl</span><span class="p">[</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">primary_reselect</span><span class="p">].</span><span class="n">modename</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">primary_reselect</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_primary_reselect</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtnl_trylock</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">restart_syscall</span><span class="p">();</span>

	<span class="n">new_value</span> <span class="o">=</span> <span class="n">bond_parse_parm</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">pri_reselect_tbl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>  <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Ignoring invalid primary_reselect value %.*s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">primary_reselect</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: setting primary_reselect to %s (%d).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">pri_reselect_tbl</span><span class="p">[</span><span class="n">new_value</span><span class="p">].</span><span class="n">modename</span><span class="p">,</span>
		<span class="n">new_value</span><span class="p">);</span>

	<span class="n">block_netpoll_tx</span><span class="p">();</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">curr_slave_lock</span><span class="p">);</span>
	<span class="n">bond_select_active_slave</span><span class="p">(</span><span class="n">bond</span><span class="p">);</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">curr_slave_lock</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">unblock_netpoll_tx</span><span class="p">();</span>
<span class="nl">out:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">primary_reselect</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_primary_reselect</span><span class="p">,</span>
		   <span class="n">bonding_store_primary_reselect</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show and set the use_carrier flag.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">use_carrier</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_carrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: no use_carrier value specified.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">new_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">use_carrier</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Setting use_carrier to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Ignoring invalid use_carrier value %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">use_carrier</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_carrier</span><span class="p">,</span> <span class="n">bonding_store_carrier</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Show and set currently active_slave.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_active_slave</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slave</span> <span class="o">*</span><span class="n">curr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">curr_slave_lock</span><span class="p">);</span>
	<span class="n">curr</span> <span class="o">=</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">curr_active_slave</span><span class="p">;</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">curr_slave_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">USES_PRIMARY</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">curr</span><span class="p">)</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">curr</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_active_slave</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slave</span> <span class="o">*</span><span class="n">slave</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slave</span> <span class="o">*</span><span class="n">old_active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">slave</span> <span class="o">*</span><span class="n">new_active</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="kt">char</span> <span class="n">ifname</span><span class="p">[</span><span class="n">IFNAMSIZ</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtnl_trylock</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">restart_syscall</span><span class="p">();</span>

	<span class="n">block_netpoll_tx</span><span class="p">();</span>
	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">write_lock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">curr_slave_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">USES_PRIMARY</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Unable to change active slave; %s is in mode %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%16s&quot;</span><span class="p">,</span> <span class="n">ifname</span><span class="p">);</span> <span class="cm">/* IFNAMSIZ */</span>

	<span class="cm">/* check to see if we are clearing active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">ifname</span><span class="p">)</span> <span class="o">||</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Clearing current active slave.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">curr_active_slave</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">bond_select_active_slave</span><span class="p">(</span><span class="n">bond</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bond_for_each_slave</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="n">slave</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ifname</span><span class="p">,</span> <span class="n">IFNAMSIZ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">old_active</span> <span class="o">=</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">curr_active_slave</span><span class="p">;</span>
			<span class="n">new_active</span> <span class="o">=</span> <span class="n">slave</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_active</span> <span class="o">==</span> <span class="n">old_active</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* do nothing */</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: %s is already the current&quot;</span>
					<span class="s">&quot; active slave.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					<span class="n">slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">new_active</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">old_active</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="p">(</span><span class="n">new_active</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">==</span> <span class="n">BOND_LINK_UP</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				    <span class="n">IS_UP</span><span class="p">(</span><span class="n">new_active</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Setting %s as active&quot;</span>
						<span class="s">&quot; slave.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						<span class="n">slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
					<span class="n">bond_change_active_slave</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span>
								 <span class="n">new_active</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Could not set %s as&quot;</span>
						<span class="s">&quot; active slave; either %s is&quot;</span>
						<span class="s">&quot; down or the link is down.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						<span class="n">slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						<span class="n">slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Unable to set %.*s as active slave.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">write_unlock_bh</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">curr_slave_lock</span><span class="p">);</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">unblock_netpoll_tx</span><span class="p">();</span>

	<span class="n">rtnl_unlock</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">active_slave</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_active_slave</span><span class="p">,</span> <span class="n">bonding_store_active_slave</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Show link status of the bond interface.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_mii_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slave</span> <span class="o">*</span><span class="n">curr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">curr_slave_lock</span><span class="p">);</span>
	<span class="n">curr</span> <span class="o">=</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">curr_active_slave</span><span class="p">;</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">curr_slave_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">curr</span> <span class="o">?</span> <span class="s">&quot;up&quot;</span> <span class="o">:</span> <span class="s">&quot;down&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">mii_status</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bonding_show_mii_status</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Show current 802.3ad aggregator ID.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_ad_aggregator</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BOND_MODE_8023AD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ad_info</span> <span class="n">ad_info</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">bond_3ad_get_active_agg_info</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ad_info</span><span class="p">))</span>
				<span class="o">?</span>  <span class="mi">0</span> <span class="o">:</span> <span class="n">ad_info</span><span class="p">.</span><span class="n">aggregator_id</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ad_aggregator</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bonding_show_ad_aggregator</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Show number of active 802.3ad ports.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_ad_num_ports</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BOND_MODE_8023AD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ad_info</span> <span class="n">ad_info</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">bond_3ad_get_active_agg_info</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ad_info</span><span class="p">))</span>
				<span class="o">?</span>  <span class="mi">0</span> <span class="o">:</span> <span class="n">ad_info</span><span class="p">.</span><span class="n">ports</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ad_num_ports</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bonding_show_ad_num_ports</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Show current 802.3ad actor key.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_ad_actor_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BOND_MODE_8023AD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ad_info</span> <span class="n">ad_info</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">bond_3ad_get_active_agg_info</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ad_info</span><span class="p">))</span>
				<span class="o">?</span>  <span class="mi">0</span> <span class="o">:</span> <span class="n">ad_info</span><span class="p">.</span><span class="n">actor_key</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ad_actor_key</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bonding_show_ad_actor_key</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Show current 802.3ad partner key.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_ad_partner_key</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BOND_MODE_8023AD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ad_info</span> <span class="n">ad_info</span><span class="p">;</span>
		<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="n">bond_3ad_get_active_agg_info</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ad_info</span><span class="p">))</span>
				<span class="o">?</span>  <span class="mi">0</span> <span class="o">:</span> <span class="n">ad_info</span><span class="p">.</span><span class="n">partner_key</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ad_partner_key</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bonding_show_ad_partner_key</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Show current 802.3ad partner mac.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_ad_partner_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					   <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">mode</span> <span class="o">==</span> <span class="n">BOND_MODE_8023AD</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">ad_info</span> <span class="n">ad_info</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bond_3ad_get_active_agg_info</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ad_info</span><span class="p">))</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ad_info</span><span class="p">.</span><span class="n">partner_system</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">ad_partner_mac</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bonding_show_ad_partner_mac</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show the queue_ids of the slaves in the current bond.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_queue_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slave</span> <span class="o">*</span><span class="n">slave</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtnl_trylock</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">restart_syscall</span><span class="p">();</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">bond_for_each_slave</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="n">slave</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">IFNAMSIZ</span> <span class="o">-</span> <span class="mi">6</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* not enough space for another interface_name:queue_id pair */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">res</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">)</span>
				<span class="n">res</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="mi">10</span><span class="p">;</span>
			<span class="n">res</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">res</span><span class="p">,</span> <span class="s">&quot;++more++ &quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">res</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">res</span><span class="p">,</span> <span class="s">&quot;%s:%d &quot;</span><span class="p">,</span>
			       <span class="n">slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">queue_id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span>
		<span class="n">buf</span><span class="p">[</span><span class="n">res</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span> <span class="cm">/* eat the leftover space */</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Set the queue_ids of the  slaves in the current bond.  The bond</span>
<span class="cm"> * interface must be enslaved for this to work.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_queue_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">slave</span> <span class="o">*</span><span class="n">slave</span><span class="p">,</span> <span class="o">*</span><span class="n">update_slave</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="n">u16</span> <span class="n">qid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">delim</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">sdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rtnl_trylock</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">restart_syscall</span><span class="p">();</span>

	<span class="cm">/* delim will point to queue id if successful */</span>
	<span class="n">delim</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">buffer</span><span class="p">,</span> <span class="sc">&#39;:&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delim</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_no_cmd</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Terminate string that points to device name and bump it</span>
<span class="cm">	 * up one, so we can read the queue id there.</span>
<span class="cm">	 */</span>
	<span class="o">*</span><span class="n">delim</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="o">++</span><span class="n">delim</span><span class="p">,</span> <span class="s">&quot;%hd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">qid</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_no_cmd</span><span class="p">;</span>

	<span class="cm">/* Check buffer length, valid ifname and queue id */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">IFNAMSIZ</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">dev_valid_name</span><span class="p">(</span><span class="n">buffer</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">qid</span> <span class="o">&gt;</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">tx_queues</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_no_cmd</span><span class="p">;</span>

	<span class="cm">/* Get the pointer to that interface if it exists */</span>
	<span class="n">sdev</span> <span class="o">=</span> <span class="n">__dev_get_by_name</span><span class="p">(</span><span class="n">dev_net</span><span class="p">(</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_no_cmd</span><span class="p">;</span>

	<span class="n">read_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Search for thes slave and check for duplicate qids */</span>
	<span class="n">update_slave</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">bond_for_each_slave</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="n">slave</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sdev</span> <span class="o">==</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span>
			<span class="cm">/*</span>
<span class="cm">			 * We don&#39;t need to check the matching</span>
<span class="cm">			 * slave for dups, since we&#39;re overwriting it</span>
<span class="cm">			 */</span>
			<span class="n">update_slave</span> <span class="o">=</span> <span class="n">slave</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">qid</span> <span class="o">&amp;&amp;</span> <span class="n">qid</span> <span class="o">==</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">queue_id</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">err_no_cmd_unlock</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">update_slave</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_no_cmd_unlock</span><span class="p">;</span>

	<span class="cm">/* Actually set the qids for the slave */</span>
	<span class="n">update_slave</span><span class="o">-&gt;</span><span class="n">queue_id</span> <span class="o">=</span> <span class="n">qid</span><span class="p">;</span>

	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="n">rtnl_unlock</span><span class="p">();</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">err_no_cmd_unlock:</span>
	<span class="n">read_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bond</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="nl">err_no_cmd:</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;invalid input for queue_id set for %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">queue_id</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">bonding_show_queue_id</span><span class="p">,</span>
		   <span class="n">bonding_store_queue_id</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Show and set the all_slaves_active flag.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_slaves_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">all_slaves_active</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_slaves_active</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">slave</span> <span class="o">*</span><span class="n">slave</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: no all_slaves_active value specified.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">==</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">all_slaves_active</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">new_value</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">all_slaves_active</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Ignoring invalid all_slaves_active value %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">bond_for_each_slave</span><span class="p">(</span><span class="n">bond</span><span class="p">,</span> <span class="n">slave</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bond_is_active_slave</span><span class="p">(</span><span class="n">slave</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
				<span class="n">slave</span><span class="o">-&gt;</span><span class="n">inactive</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">slave</span><span class="o">-&gt;</span><span class="n">inactive</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">all_slaves_active</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_slaves_active</span><span class="p">,</span> <span class="n">bonding_store_slaves_active</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Show and set the number of IGMP membership reports to send on link failure</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_show_resend_igmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">resend_igmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bonding_store_resend_igmp</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">new_value</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span> <span class="o">=</span> <span class="n">to_bond</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">new_value</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: no resend_igmp value specified.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_value</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">new_value</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: Invalid resend_igmp value %d not in range 0-255; rejected.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: Setting resend_igmp to %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">new_value</span><span class="p">);</span>
	<span class="n">bond</span><span class="o">-&gt;</span><span class="n">params</span><span class="p">.</span><span class="n">resend_igmp</span> <span class="o">=</span> <span class="n">new_value</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">resend_igmp</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
		   <span class="n">bonding_show_resend_igmp</span><span class="p">,</span> <span class="n">bonding_store_resend_igmp</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">per_bond_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_slaves</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_mode</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_fail_over_mac</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_arp_validate</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_arp_interval</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_arp_ip_target</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_downdelay</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_updelay</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_lacp_rate</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ad_select</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_xmit_hash_policy</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_num_grat_arp</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_num_unsol_na</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_miimon</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_primary</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_primary_reselect</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_use_carrier</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_active_slave</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_mii_status</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ad_aggregator</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ad_num_ports</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ad_actor_key</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ad_partner_key</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_ad_partner_mac</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_queue_id</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_all_slaves_active</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_resend_igmp</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_min_links</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">bonding_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bonding&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">per_bond_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize sysfs.  This sets up the bonding_masters file in</span>
<span class="cm"> * /sys/class/net.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">bond_create_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bond_net</span> <span class="o">*</span><span class="n">bn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">bn</span><span class="o">-&gt;</span><span class="n">class_attr_bonding_masters</span> <span class="o">=</span> <span class="n">class_attr_bonding_masters</span><span class="p">;</span>
	<span class="n">sysfs_attr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bn</span><span class="o">-&gt;</span><span class="n">class_attr_bonding_masters</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">netdev_class_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bn</span><span class="o">-&gt;</span><span class="n">class_attr_bonding_masters</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Permit multiple loads of the module by ignoring failures to</span>
<span class="cm">	 * create the bonding_masters sysfs file.  Bonding devices</span>
<span class="cm">	 * created by second or subsequent loads of the module will</span>
<span class="cm">	 * not be listed in, or controllable by, bonding_masters, but</span>
<span class="cm">	 * will have the usual &quot;bonding&quot; sysfs directory.</span>
<span class="cm">	 *</span>
<span class="cm">	 * This is done to preserve backwards compatibility for</span>
<span class="cm">	 * initscripts/sysconfig, which load bonding multiple times to</span>
<span class="cm">	 * configure multiple bonding devices.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Is someone being kinky and naming a device bonding_master? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__dev_get_by_name</span><span class="p">(</span><span class="n">bn</span><span class="o">-&gt;</span><span class="n">net</span><span class="p">,</span>
				      <span class="n">class_attr_bonding_masters</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">))</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;network device named %s already exists in sysfs&quot;</span><span class="p">,</span>
			       <span class="n">class_attr_bonding_masters</span><span class="p">.</span><span class="n">attr</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Remove /sys/class/net/bonding_masters.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bond_destroy_sysfs</span><span class="p">(</span><span class="k">struct</span> <span class="n">bond_net</span> <span class="o">*</span><span class="n">bn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netdev_class_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bn</span><span class="o">-&gt;</span><span class="n">class_attr_bonding_masters</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialize sysfs for each bond.  This sets up and registers</span>
<span class="cm"> * the &#39;bondctl&#39; directory for each individual bond under /sys/class/net.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">bond_prepare_sysfs_group</span><span class="p">(</span><span class="k">struct</span> <span class="n">bonding</span> <span class="o">*</span><span class="n">bond</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bond</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">sysfs_groups</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">bonding_group</span><span class="p">;</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
