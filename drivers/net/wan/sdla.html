<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wan › sdla.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sdla.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * SDLA		An implementation of a driver for the Sangoma S502/S508 series</span>
<span class="cm"> *		multi-protocol PC interface card.  Initial offering is with </span>
<span class="cm"> *		the DLCI driver, providing Frame Relay support for linux.</span>
<span class="cm"> *</span>
<span class="cm"> *		Global definitions for the Frame relay interface.</span>
<span class="cm"> *</span>
<span class="cm"> * Version:	@(#)sdla.c   0.30	12 Sep 1996</span>
<span class="cm"> *</span>
<span class="cm"> * Credits:	Sangoma Technologies, for the use of 2 cards for an extended</span>
<span class="cm"> *			period of time.</span>
<span class="cm"> *		David Mandelstam &lt;dm@sangoma.com&gt; for getting me started on </span>
<span class="cm"> *			this project, and incentive to complete it.</span>
<span class="cm"> *		Gene Kozen &lt;74604.152@compuserve.com&gt; for providing me with</span>
<span class="cm"> *			important information about the cards.</span>
<span class="cm"> *</span>
<span class="cm"> * Author:	Mike McLagan &lt;mike.mclagan@linux.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Changes:</span>
<span class="cm"> *		0.15	Mike McLagan	Improved error handling, packet dropping</span>
<span class="cm"> *		0.20	Mike McLagan	New transmit/receive flags for config</span>
<span class="cm"> *					If in FR mode, don&#39;t accept packets from</span>
<span class="cm"> *					non DLCI devices.</span>
<span class="cm"> *		0.25	Mike McLagan	Fixed problem with rejecting packets</span>
<span class="cm"> *					from non DLCI devices.</span>
<span class="cm"> *		0.30	Mike McLagan	Fixed kernel panic when used with modified</span>
<span class="cm"> *					ifconfig</span>
<span class="cm"> *</span>
<span class="cm"> *		This program is free software; you can redistribute it and/or</span>
<span class="cm"> *		modify it under the terms of the GNU General Public License</span>
<span class="cm"> *		as published by the Free Software Foundation; either version</span>
<span class="cm"> *		2 of the License, or (at your option) any later version.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/in.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/if_frad.h&gt;</span>
<span class="cp">#include &lt;linux/sdla.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/dma.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">version</span> <span class="o">=</span> <span class="s">&quot;SDLA driver v0.30, 12 Sep 1996, mike.mclagan@linux.org&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">valid_port</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x250</span><span class="p">,</span> <span class="mh">0x270</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x300</span><span class="p">,</span> <span class="mh">0x350</span><span class="p">,</span> <span class="mh">0x360</span><span class="p">,</span> <span class="mh">0x380</span><span class="p">,</span> <span class="mh">0x390</span><span class="p">};</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">valid_mem</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
				    <span class="mh">0xA0000</span><span class="p">,</span> <span class="mh">0xA2000</span><span class="p">,</span> <span class="mh">0xA4000</span><span class="p">,</span> <span class="mh">0xA6000</span><span class="p">,</span> <span class="mh">0xA8000</span><span class="p">,</span> <span class="mh">0xAA000</span><span class="p">,</span> <span class="mh">0xAC000</span><span class="p">,</span> <span class="mh">0xAE000</span><span class="p">,</span> 
                                    <span class="mh">0xB0000</span><span class="p">,</span> <span class="mh">0xB2000</span><span class="p">,</span> <span class="mh">0xB4000</span><span class="p">,</span> <span class="mh">0xB6000</span><span class="p">,</span> <span class="mh">0xB8000</span><span class="p">,</span> <span class="mh">0xBA000</span><span class="p">,</span> <span class="mh">0xBC000</span><span class="p">,</span> <span class="mh">0xBE000</span><span class="p">,</span>
                                    <span class="mh">0xC0000</span><span class="p">,</span> <span class="mh">0xC2000</span><span class="p">,</span> <span class="mh">0xC4000</span><span class="p">,</span> <span class="mh">0xC6000</span><span class="p">,</span> <span class="mh">0xC8000</span><span class="p">,</span> <span class="mh">0xCA000</span><span class="p">,</span> <span class="mh">0xCC000</span><span class="p">,</span> <span class="mh">0xCE000</span><span class="p">,</span>
                                    <span class="mh">0xD0000</span><span class="p">,</span> <span class="mh">0xD2000</span><span class="p">,</span> <span class="mh">0xD4000</span><span class="p">,</span> <span class="mh">0xD6000</span><span class="p">,</span> <span class="mh">0xD8000</span><span class="p">,</span> <span class="mh">0xDA000</span><span class="p">,</span> <span class="mh">0xDC000</span><span class="p">,</span> <span class="mh">0xDE000</span><span class="p">,</span>
                                    <span class="mh">0xE0000</span><span class="p">,</span> <span class="mh">0xE2000</span><span class="p">,</span> <span class="mh">0xE4000</span><span class="p">,</span> <span class="mh">0xE6000</span><span class="p">,</span> <span class="mh">0xE8000</span><span class="p">,</span> <span class="mh">0xEA000</span><span class="p">,</span> <span class="mh">0xEC000</span><span class="p">,</span> <span class="mh">0xEE000</span><span class="p">};</span> 

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">sdla_lock</span><span class="p">);</span>

<span class="cm">/*********************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * these are the core routines that access the card itself </span>
<span class="cm"> *</span>
<span class="cm"> *********************************************************/</span>

<span class="cp">#define SDLA_WINDOW(dev,addr) outb((((addr) &gt;&gt; 13) &amp; 0x1F), (dev)-&gt;base_addr + SDLA_REG_Z80_WINDOW)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__sdla_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">short</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span>          <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">void</span>    <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span>           <span class="n">offset</span><span class="p">,</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="p">)</span>
	<span class="p">{</span>	
		<span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="n">SDLA_ADDR_MASK</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">SDLA_WINDOW_SIZE</span> <span class="o">?</span> <span class="n">SDLA_WINDOW_SIZE</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">:</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

		<span class="n">SDLA_WINDOW</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

		<span class="n">addr</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="n">len</span>  <span class="o">-=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="p">}</span>  
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdla_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">short</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__sdla_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__sdla_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> 
			 <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">short</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">char</span>    <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="kt">void</span> 	      <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span>           <span class="n">offset</span><span class="p">,</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="n">SDLA_ADDR_MASK</span><span class="p">;</span>
		<span class="n">bytes</span> <span class="o">=</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">SDLA_WINDOW_SIZE</span> <span class="o">?</span> <span class="n">SDLA_WINDOW_SIZE</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">:</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>

		<span class="n">SDLA_WINDOW</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

		<span class="n">addr</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="n">temp</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="n">len</span>  <span class="o">-=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdla_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">,</span> 
		       <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">short</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">__sdla_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdla_clear</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span>          <span class="o">*</span><span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span>           <span class="n">len</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">bytes</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="mi">65536</span><span class="p">;</span>	
	<span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">bytes</span> <span class="o">=</span> <span class="n">SDLA_WINDOW_SIZE</span><span class="p">;</span>
	<span class="n">base</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">while</span><span class="p">(</span><span class="n">len</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">SDLA_WINDOW</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="n">memset</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">bytes</span><span class="p">);</span>

		<span class="n">addr</span> <span class="o">+=</span> <span class="n">bytes</span><span class="p">;</span>
		<span class="n">len</span>  <span class="o">-=</span> <span class="n">bytes</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">char</span> <span class="nf">sdla_byte</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span>          <span class="n">byte</span><span class="p">,</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">SDLA_ADDR_MASK</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">SDLA_WINDOW</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
	<span class="n">byte</span> <span class="o">=</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">byte</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdla_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SDLA_S502A</span>:
			<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_S502A_HALT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SDLA_HALT</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SDLA_S502E</span>:
			<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_HALT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_Z80_CONTROL</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_S502E_ENABLE</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SDLA_S502E_ENABLE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SDLA_S507</span>:
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDLA_CPUEN</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SDLA_S508</span>:
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDLA_CPUEN</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdla_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SDLA_S502A</span>:
			<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_S502A_NMI</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_S502A_START</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SDLA_S502A_START</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SDLA_S502E</span>:
			<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_S502E_CPUEN</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_Z80_CONTROL</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x00</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SDLA_S507</span>:
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SDLA_CPUEN</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SDLA_S508</span>:
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SDLA_CPUEN</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/****************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * this is used for the S502A/E cards to determine</span>
<span class="cm"> * the speed of the onboard CPU.  Calibration is</span>
<span class="cm"> * necessary for the Frame Relay code uploaded </span>
<span class="cm"> * later.  Incorrect results cause timing problems</span>
<span class="cm"> * with link checks &amp; status messages</span>
<span class="cm"> *</span>
<span class="cm"> ***************************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_z80_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">z80_addr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">jiffs</span><span class="p">,</span> <span class="kt">char</span> <span class="n">resp1</span><span class="p">,</span> <span class="kt">char</span> <span class="n">resp2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">start</span><span class="p">,</span> <span class="n">done</span><span class="p">,</span> <span class="n">now</span><span class="p">;</span>
	<span class="kt">char</span>          <span class="n">resp</span><span class="p">,</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>

	<span class="n">start</span> <span class="o">=</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">done</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">jiffs</span><span class="p">;</span>

	<span class="n">temp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="n">temp</span> <span class="o">+=</span> <span class="n">z80_addr</span> <span class="o">&amp;</span> <span class="n">SDLA_ADDR_MASK</span><span class="p">;</span>
	
	<span class="n">resp</span> <span class="o">=</span> <span class="o">~</span><span class="n">resp1</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">resp</span> <span class="o">!=</span> <span class="n">resp1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">!</span><span class="n">resp2</span> <span class="o">||</span> <span class="p">(</span><span class="n">resp</span> <span class="o">!=</span> <span class="n">resp2</span><span class="p">)))</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">!=</span> <span class="n">now</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">SDLA_WINDOW</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">z80_addr</span><span class="p">);</span>
			<span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">resp</span> <span class="o">=</span> <span class="o">*</span><span class="n">temp</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">done</span><span class="p">)</span> <span class="o">?</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">start</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* constants for Z80 CPU speed */</span>
<span class="cp">#define Z80_READY 		&#39;1&#39;	</span><span class="cm">/* Z80 is ready to begin */</span><span class="cp"></span>
<span class="cp">#define LOADER_READY 		&#39;2&#39;	</span><span class="cm">/* driver is ready to begin */</span><span class="cp"></span>
<span class="cp">#define Z80_SCC_OK 		&#39;3&#39;	</span><span class="cm">/* SCC is on board */</span><span class="cp"></span>
<span class="cp">#define Z80_SCC_BAD	 	&#39;4&#39;	</span><span class="cm">/* SCC was not found */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_cpuspeed</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">jiffs</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">sdla_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sdla_z80_poll</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="n">Z80_READY</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">LOADER_READY</span><span class="p">;</span>
	<span class="n">sdla_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">jiffs</span> <span class="o">=</span> <span class="n">sdla_z80_poll</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">8</span><span class="o">*</span><span class="n">HZ</span><span class="p">,</span> <span class="n">Z80_SCC_OK</span><span class="p">,</span> <span class="n">Z80_SCC_BAD</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">sdla_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">sdla_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">==</span> <span class="n">Z80_SCC_BAD</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s: SCC bad</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">!=</span> <span class="n">Z80_SCC_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">jiffs</span> <span class="o">&lt;</span> <span class="mi">165</span><span class="p">)</span>
		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_mtu</span> <span class="o">=</span> <span class="n">SDLA_CPU_16M</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">jiffs</span> <span class="o">&lt;</span> <span class="mi">220</span><span class="p">)</span>
		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_mtu</span> <span class="o">=</span> <span class="n">SDLA_CPU_10M</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">jiffs</span> <span class="o">&lt;</span> <span class="mi">258</span><span class="p">)</span>
		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_mtu</span> <span class="o">=</span> <span class="n">SDLA_CPU_8M</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">jiffs</span> <span class="o">&lt;</span> <span class="mi">357</span><span class="p">)</span>
		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_mtu</span> <span class="o">=</span> <span class="n">SDLA_CPU_7M</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">jiffs</span> <span class="o">&lt;</span> <span class="mi">467</span><span class="p">)</span>
		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_mtu</span> <span class="o">=</span> <span class="n">SDLA_CPU_5M</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_mtu</span> <span class="o">=</span> <span class="n">SDLA_CPU_3M</span><span class="p">;</span>
 
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/************************************************</span>
<span class="cm"> *</span>
<span class="cm"> *  Direct interaction with the Frame Relay code </span>
<span class="cm"> *  starts here.</span>
<span class="cm"> *</span>
<span class="cm"> ************************************************/</span>

<span class="k">struct</span> <span class="n">_dlci_stat</span> 
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">dlci</span><span class="p">;</span>
	<span class="kt">char</span>  <span class="n">flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">_frad_stat</span> 
<span class="p">{</span>
	<span class="kt">char</span>    <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">_dlci_stat</span> <span class="n">dlcis</span><span class="p">[</span><span class="n">SDLA_MAX_DLCI</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdla_errors</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">int</span> <span class="n">dlci</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span> 
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">_dlci_stat</span> <span class="o">*</span><span class="n">pstatus</span><span class="p">;</span>
	<span class="kt">short</span>             <span class="o">*</span><span class="n">pdlci</span><span class="p">;</span>
	<span class="kt">int</span>               <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span>              <span class="o">*</span><span class="n">state</span><span class="p">,</span> <span class="n">line</span><span class="p">[</span><span class="mi">30</span><span class="p">];</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SDLA_RET_MODEM</span>:
			<span class="n">state</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SDLA_MODEM_DCD_LOW</span><span class="p">)</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Modem DCD unexpectedly low!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SDLA_MODEM_CTS_LOW</span><span class="p">)</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Modem CTS unexpectedly low!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* I should probably do something about this! */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_RET_CHANNEL_OFF</span>:
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Channel became inoperative!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* same here */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_RET_CHANNEL_ON</span>:
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Channel became operative!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* same here */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_RET_DLCI_STATUS</span>:
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Status change reported by Access Node</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">_dlci_stat</span><span class="p">);</span>
			<span class="k">for</span><span class="p">(</span><span class="n">pstatus</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="n">pstatus</span><span class="o">++</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pstatus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDLA_DLCI_NEW</span><span class="p">)</span>
					<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;new&quot;</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pstatus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDLA_DLCI_DELETED</span><span class="p">)</span>
					<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;deleted&quot;</span><span class="p">;</span>
				<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">pstatus</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SDLA_DLCI_ACTIVE</span><span class="p">)</span>
					<span class="n">state</span> <span class="o">=</span> <span class="s">&quot;active&quot;</span><span class="p">;</span>
				<span class="k">else</span>
				<span class="p">{</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;unknown status: %02X&quot;</span><span class="p">,</span> <span class="n">pstatus</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
					<span class="n">state</span> <span class="o">=</span> <span class="n">line</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DLCI %i: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">pstatus</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
				<span class="cm">/* same here */</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_RET_DLCI_UNKNOWN</span>:
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Received unknown DLCIs:&quot;</span><span class="p">);</span>
			<span class="n">len</span> <span class="o">/=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">);</span>
			<span class="k">for</span><span class="p">(</span><span class="n">pdlci</span> <span class="o">=</span> <span class="n">data</span><span class="p">,</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="n">pdlci</span><span class="o">++</span><span class="p">)</span>
				<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot; %i&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">pdlci</span><span class="p">);</span>
			<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_RET_TIMEOUT</span>:
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Command timed out!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_RET_BUF_OVERSIZE</span>:
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Bc/CIR overflow, acceptable size is %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_RET_BUF_TOO_BIG</span>:
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Buffer size over specified max of %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">len</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_RET_CHANNEL_INACTIVE</span>:
		<span class="k">case</span> <span class="n">SDLA_RET_DLCI_INACTIVE</span>:
		<span class="k">case</span> <span class="n">SDLA_RET_CIR_OVERFLOW</span>:
		<span class="k">case</span> <span class="n">SDLA_RET_NO_BUFS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">SDLA_INFORMATION_WRITE</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span> 
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cmd 0x%02X generated return code 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">cmd</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="cm">/* Further processing could be done here */</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">short</span> <span class="n">dlci</span><span class="p">,</span> <span class="kt">short</span> <span class="n">flags</span><span class="p">,</span> 
                        <span class="kt">void</span> <span class="o">*</span><span class="n">inbuf</span><span class="p">,</span> <span class="kt">short</span> <span class="n">inlen</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">outbuf</span><span class="p">,</span> <span class="kt">short</span> <span class="o">*</span><span class="n">outlen</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">struct</span> <span class="n">_frad_stat</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">frad_local</span>        <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sdla_cmd</span>          <span class="o">*</span><span class="n">cmd_buf</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>            <span class="n">pflags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		 <span class="n">jiffs</span><span class="p">;</span>
	<span class="kt">int</span>                      <span class="n">ret</span><span class="p">,</span> <span class="n">waiting</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>
	<span class="kt">long</span>                     <span class="n">window</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">window</span> <span class="o">=</span> <span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SDLA_S508</span> <span class="o">?</span> <span class="n">SDLA_508_CMD_BUF</span> <span class="o">:</span> <span class="n">SDLA_502_CMD_BUF</span><span class="p">;</span>
	<span class="n">cmd_buf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">sdla_cmd</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">window</span> <span class="o">&amp;</span> <span class="n">SDLA_ADDR_MASK</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">jiffs</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">;</span>  <span class="cm">/* 1 second is plenty */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">pflags</span><span class="p">);</span>
	<span class="n">SDLA_WINDOW</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">window</span><span class="p">);</span>
	<span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">dlci</span> <span class="o">=</span> <span class="n">dlci</span><span class="p">;</span>
	<span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">inbuf</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">inbuf</span><span class="p">,</span> <span class="n">inlen</span><span class="p">);</span>

	<span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">inlen</span><span class="p">;</span>

	<span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">opp_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">pflags</span><span class="p">);</span>

	<span class="n">waiting</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">waiting</span> <span class="o">&amp;&amp;</span> <span class="n">time_before_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">jiffs</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">waiting</span><span class="o">++</span> <span class="o">%</span> <span class="mi">3</span><span class="p">)</span> 
		<span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">pflags</span><span class="p">);</span>
			<span class="n">SDLA_WINDOW</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">window</span><span class="p">);</span>
			<span class="n">waiting</span> <span class="o">=</span> <span class="p">((</span><span class="k">volatile</span> <span class="kt">int</span><span class="p">)(</span><span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">opp_flag</span><span class="p">));</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">pflags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">waiting</span><span class="p">)</span>
	<span class="p">{</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">pflags</span><span class="p">);</span>
		<span class="n">SDLA_WINDOW</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">window</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">retval</span><span class="p">;</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">outbuf</span> <span class="o">&amp;&amp;</span> <span class="n">outlen</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="o">*</span><span class="n">outlen</span> <span class="o">=</span> <span class="o">*</span><span class="n">outlen</span> <span class="o">&gt;=</span> <span class="n">len</span> <span class="o">?</span> <span class="n">len</span> <span class="o">:</span> <span class="o">*</span><span class="n">outlen</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">outlen</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="n">outbuf</span><span class="p">,</span> <span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="o">*</span><span class="n">outlen</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/* This is a local copy that&#39;s used for error handling */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status</span><span class="p">,</span> <span class="n">cmd_buf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="o">:</span> <span class="n">len</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">pflags</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">SDLA_RET_TIMEOUT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SDLA_RET_OK</span><span class="p">)</span>
	   	<span class="n">sdla_errors</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">dlci</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/***********************************************</span>
<span class="cm"> *</span>
<span class="cm"> * these functions are called by the DLCI driver </span>
<span class="cm"> *</span>
<span class="cm"> ***********************************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">sdla_reconfig</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_activate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">slave</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">slave</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">master</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">CONFIG_DLCI_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">slave</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">station</span> <span class="o">==</span> <span class="n">FRAD_STATION_NODE</span><span class="p">))</span>
		<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="n">SDLA_ACTIVATE_DLCI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_deactivate</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">slave</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="kt">int</span>               <span class="n">i</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">slave</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">master</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">CONFIG_DLCI_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">abs</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">slave</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">station</span> <span class="o">==</span> <span class="n">FRAD_STATION_NODE</span><span class="p">))</span>
		<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="n">SDLA_DEACTIVATE_DLCI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_assoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">slave</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="kt">int</span>               <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ARPHRD_DLCI</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">slave</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">==</span> <span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EADDRINUSE</span><span class="p">;</span>
	<span class="p">}</span> 

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">CONFIG_DLCI_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EMLINK</span><span class="p">;</span>  <span class="cm">/* #### Alan: Comments on this ?? */</span>


	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">master</span><span class="p">;</span>
	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">);</span>
	<span class="n">master</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">slave</span><span class="o">-&gt;</span><span class="n">mtu</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">slave</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">station</span> <span class="o">==</span> <span class="n">FRAD_STATION_CPE</span><span class="p">)</span>
			<span class="n">sdla_reconfig</span><span class="p">(</span><span class="n">slave</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="n">SDLA_ADD_DLCI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_deassoc</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">slave</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="kt">int</span>               <span class="n">i</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">slave</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">master</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">CONFIG_DLCI_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">slave</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">station</span> <span class="o">==</span> <span class="n">FRAD_STATION_CPE</span><span class="p">)</span>
			<span class="n">sdla_reconfig</span><span class="p">(</span><span class="n">slave</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="n">SDLA_DELETE_DLCI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">master</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_dlci_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">slave</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">master</span><span class="p">,</span> <span class="kt">int</span> <span class="n">get</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dlci_local</span> <span class="o">*</span><span class="n">dlp</span><span class="p">;</span>
	<span class="kt">int</span>               <span class="n">i</span><span class="p">;</span>
	<span class="kt">short</span>             <span class="n">len</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">slave</span><span class="p">);</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">master</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">CONFIG_DLCI_MAX</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">dlp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">SDLA_RET_OK</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlci_conf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">slave</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sdla_cmd</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="n">SDLA_READ_DLCI_CONFIGURATION</span><span class="p">,</span> <span class="n">abs</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span>  
			            <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dlp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">sdla_cmd</span><span class="p">(</span><span class="n">slave</span><span class="p">,</span> <span class="n">SDLA_SET_DLCI_CONFIGURATION</span><span class="p">,</span> <span class="n">abs</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span>  
			            <span class="o">&amp;</span><span class="n">dlp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlci_conf</span><span class="p">)</span> <span class="o">-</span> <span class="mi">4</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">==</span> <span class="n">SDLA_RET_OK</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**************************</span>
<span class="cm"> *</span>
<span class="cm"> * now for the Linux driver </span>
<span class="cm"> *</span>
<span class="cm"> **************************/</span>

<span class="cm">/* NOTE: the DLCI driver deals with freeing the SKB!! */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">sdla_transmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="kt">int</span>               <span class="n">ret</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">accept</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">short</span>             <span class="n">size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>     <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buf_entry</span>  <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">accept</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * stupid GateD insists on setting up the multicast router thru us</span>
<span class="cm">	 * and we&#39;re ill equipped to handle a non Frame Relay packet at this</span>
<span class="cm">	 * time!</span>
<span class="cm">	 */</span>

	<span class="n">accept</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">ARPHRD_FRAD</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ARPHRD_DLCI</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Non DLCI device, type %i, tried to send on FRAD module</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
				<span class="n">accept</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unknown firmware type 0x%04X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
			<span class="n">accept</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">accept</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* this is frame specific, but till there&#39;s a PPP module, it&#39;s the default */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">case</span> <span class="n">SDLA_S502A</span>:
			<span class="k">case</span> <span class="n">SDLA_S502E</span>:
				<span class="n">ret</span> <span class="o">=</span> <span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_INFORMATION_WRITE</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="n">SDLA_S508</span>:
				<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">addr</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_INFORMATION_WRITE</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="kt">short</span> <span class="o">*</span><span class="p">)(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">SDLA_RET_OK</span><span class="p">)</span>
				<span class="p">{</span>

					<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
					<span class="n">SDLA_WINDOW</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
					<span class="n">pbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(((</span><span class="kt">int</span><span class="p">)</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="n">SDLA_ADDR_MASK</span><span class="p">));</span>
					<span class="n">__sdla_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">buf_addr</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
					<span class="n">SDLA_WINDOW</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
					<span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">opp_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="k">case</span> <span class="n">SDLA_RET_OK</span>:
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="n">SDLA_RET_CIR_OVERFLOW</span>:
			<span class="k">case</span> <span class="n">SDLA_RET_BUF_OVERSIZE</span>:
			<span class="k">case</span> <span class="n">SDLA_RET_NO_BUFS</span>:
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">)</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>		

	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdla_receive</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>	  <span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dlci_local</span> <span class="o">*</span><span class="n">dlp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>	 <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sdla_cmd</span>	<span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buf_info</span>	<span class="o">*</span><span class="n">pbufi</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">buf_entry</span>  <span class="o">*</span><span class="n">pbuf</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">long</span>	  <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>               <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">received</span><span class="p">,</span> <span class="n">success</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">buf_base</span><span class="p">,</span> <span class="n">buf_top</span><span class="p">;</span>
	<span class="kt">short</span>             <span class="n">dlci</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">len2</span><span class="p">,</span> <span class="n">split</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">success</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">received</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">buf_top</span> <span class="o">=</span> <span class="n">buf_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">dlci</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">master</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pbufi</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">pbuf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SDLA_S502A</span>:
		<span class="k">case</span> <span class="n">SDLA_S502E</span>:
			<span class="n">cmd</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">SDLA_502_RCV_BUF</span> <span class="o">&amp;</span> <span class="n">SDLA_ADDR_MASK</span><span class="p">));</span>
			<span class="n">SDLA_WINDOW</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_502_RCV_BUF</span><span class="p">);</span>
			<span class="n">success</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opp_flag</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">dlci</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_S508</span>:
			<span class="n">pbufi</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="p">(</span><span class="n">SDLA_508_RXBUF_INFO</span> <span class="o">&amp;</span> <span class="n">SDLA_ADDR_MASK</span><span class="p">));</span>
			<span class="n">SDLA_WINDOW</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_508_RXBUF_INFO</span><span class="p">);</span>
			<span class="n">pbuf</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="p">((</span><span class="n">pbufi</span><span class="o">-&gt;</span><span class="n">rse_base</span> <span class="o">+</span> <span class="n">flp</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">buf_entry</span><span class="p">))</span> <span class="o">&amp;</span> <span class="n">SDLA_ADDR_MASK</span><span class="p">));</span>
			<span class="n">success</span> <span class="o">=</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">opp_flag</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">success</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">buf_top</span> <span class="o">=</span> <span class="n">pbufi</span><span class="o">-&gt;</span><span class="n">buf_top</span><span class="p">;</span>
			<span class="n">buf_base</span> <span class="o">=</span> <span class="n">pbufi</span><span class="o">-&gt;</span><span class="n">buf_base</span><span class="p">;</span>
			<span class="n">dlci</span> <span class="o">=</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">;</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
			<span class="n">addr</span> <span class="o">=</span> <span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">buf_addr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* common code, find the DLCI and get the SKB */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">dlci</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">CONFIG_DLCI_MAX</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Received packet from invalid DLCI %i, ignoring</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				      <span class="n">dlci</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">master</span> <span class="o">=</span> <span class="n">flp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frhdr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> 
		<span class="p">{</span>
			<span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Memory squeeze, dropping packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
			<span class="n">success</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="n">skb_reserve</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frhdr</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="cm">/* pick up the data */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SDLA_S502A</span>:
		<span class="k">case</span> <span class="n">SDLA_S502E</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
				<span class="n">__sdla_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_502_RCV_BUF</span> <span class="o">+</span> <span class="n">SDLA_502_DATA_OFS</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span><span class="n">len</span><span class="p">),</span> <span class="n">len</span><span class="p">);</span>

			<span class="n">SDLA_WINDOW</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_502_RCV_BUF</span><span class="p">);</span>
			<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">opp_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_S508</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="cm">/* is this buffer split off the end of the internal ring buffer */</span>
				<span class="n">split</span> <span class="o">=</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">buf_top</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">?</span> <span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="n">buf_top</span> <span class="o">-</span> <span class="n">addr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">len2</span> <span class="o">=</span> <span class="n">len</span> <span class="o">-</span> <span class="n">split</span><span class="p">;</span>

				<span class="n">__sdla_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len2</span><span class="p">),</span> <span class="n">len2</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">split</span><span class="p">)</span>
					<span class="n">__sdla_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf_base</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">split</span><span class="p">),</span> <span class="n">split</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="cm">/* increment the buffer we&#39;re looking at */</span>
			<span class="n">SDLA_WINDOW</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_508_RXBUF_INFO</span><span class="p">);</span>
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">pbufi</span><span class="o">-&gt;</span><span class="n">rse_num</span><span class="p">;</span>
			<span class="n">pbuf</span><span class="o">-&gt;</span><span class="n">opp_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">success</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dlp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">master</span><span class="p">);</span>
		<span class="p">(</span><span class="o">*</span><span class="n">dlp</span><span class="o">-&gt;</span><span class="n">receive</span><span class="p">)(</span><span class="n">skb</span><span class="p">,</span> <span class="n">master</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sdla_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">sdla_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">dummy</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>     <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="kt">char</span>              <span class="n">byte</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;irq %d for uninitialized device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">byte</span> <span class="o">=</span> <span class="n">sdla_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SDLA_S508</span> <span class="o">?</span> <span class="n">SDLA_508_IRQ_INTERFACE</span> <span class="o">:</span> <span class="n">SDLA_502_IRQ_INTERFACE</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">byte</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SDLA_INTR_RX</span>:
			<span class="n">sdla_receive</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* the command will get an error return, which is processed above */</span>
		<span class="k">case</span> <span class="n">SDLA_INTR_MODEM</span>:
		<span class="k">case</span> <span class="n">SDLA_INTR_STATUS</span>:
			<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_READ_DLC_STATUS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_INTR_TX</span>:
		<span class="k">case</span> <span class="n">SDLA_INTR_COMPLETE</span>:
		<span class="k">case</span> <span class="n">SDLA_INTR_TIMER</span>:
			<span class="n">netdev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid irq flag 0x%02X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* the S502E requires a manual acknowledgement of the interrupt */</span> 
	<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SDLA_S502E</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDLA_S502E_INTACK</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
		<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SDLA_S502E_INTACK</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* this clears the byte, informing the Z80 we&#39;re done */</span>
	<span class="n">byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sdla_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SDLA_S508</span> <span class="o">?</span> <span class="n">SDLA_508_IRQ_INTERFACE</span> <span class="o">:</span> <span class="n">SDLA_502_IRQ_INTERFACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">byte</span><span class="p">));</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sdla_poll</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>	  <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sdla_byte</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_502_RCV_BUF</span><span class="p">))</span>
		<span class="n">sdla_receive</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intr_info</span>  <span class="n">intr</span><span class="p">;</span>
	<span class="kt">int</span>               <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">short</span>             <span class="n">dlcis</span><span class="p">[</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">];</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">dlcis</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">station</span> <span class="o">==</span> <span class="n">FRAD_STATION_NODE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> 
				<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_DEACTIVATE_DLCI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dlcis</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_DELETE_DLCI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">intr</span><span class="p">));</span>
	<span class="cm">/* let&#39;s start up the reception */</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SDLA_S502A</span>:
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span> 
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_S502E</span>:
			<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_SET_IRQ_TRIGGER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDLA_S502E_INTACK</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_S507</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_S508</span>:
			<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_SET_IRQ_TRIGGER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intr_info</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SDLA_S508_INTEN</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_DISABLE_COMMUNICATIONS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">conf_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_conf</span> <span class="n">config</span><span class="p">;</span>
	<span class="kt">short</span>            <span class="n">dlci</span><span class="p">[</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dlci_local</span> <span class="o">*</span><span class="n">dlp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">conf_data</span>  <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">intr_info</span>  <span class="n">intr</span><span class="p">;</span>
	<span class="kt">int</span>               <span class="n">len</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span>              <span class="n">byte</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">configured</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="cm">/* time to send in the configuration */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">data</span><span class="p">.</span><span class="n">dlci</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">abs</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frad_conf</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frad_conf</span><span class="p">);</span>

	<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_DISABLE_COMMUNICATIONS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_SET_DLCI_CONFIGURATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SDLA_S508</span><span class="p">)</span>
		<span class="n">flp</span><span class="o">-&gt;</span><span class="n">buffer</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_ENABLE_COMMUNICATIONS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* let&#39;s start up the reception */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">intr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">intr</span><span class="p">));</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SDLA_S502A</span>:
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_S502E</span>:
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SDLA_S502E_ENABLE</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SDLA_S502E_INTACK</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="n">byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sdla_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_502_IRQ_INTERFACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">byte</span><span class="p">));</span>
			<span class="n">intr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SDLA_INTR_RX</span> <span class="o">|</span> <span class="n">SDLA_INTR_STATUS</span> <span class="o">|</span> <span class="n">SDLA_INTR_MODEM</span><span class="p">;</span>
			<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_SET_IRQ_TRIGGER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">short</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_S507</span>:
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_S508</span>:
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SDLA_S508_INTEN</span><span class="p">;</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="n">byte</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">sdla_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_508_IRQ_INTERFACE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">byte</span><span class="p">));</span>
			<span class="n">intr</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="n">SDLA_INTR_RX</span> <span class="o">|</span> <span class="n">SDLA_INTR_STATUS</span> <span class="o">|</span> <span class="n">SDLA_INTR_MODEM</span><span class="p">;</span>
			<span class="n">intr</span><span class="p">.</span><span class="n">irq</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
			<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_SET_IRQ_TRIGGER</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">intr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">intr_info</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">station</span> <span class="o">==</span> <span class="n">FRAD_STATION_CPE</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">byte</span> <span class="o">=</span> <span class="n">SDLA_ICS_STATUS_ENQ</span><span class="p">;</span>
		<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_ISSUE_IN_CHANNEL_SIGNAL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">byte</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_ADD_DLCI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">data</span><span class="p">.</span><span class="n">dlci</span><span class="p">,</span> <span class="n">len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frad_conf</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_ACTIVATE_DLCI</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">2</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* configure any specific DLCI settings */</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
		<span class="p">{</span>
			<span class="n">dlp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dlp</span><span class="o">-&gt;</span><span class="n">configured</span><span class="p">)</span>
				<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_SET_DLCI_CONFIGURATION</span><span class="p">,</span> <span class="n">abs</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dlp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">dlci_conf</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">frad_conf</span> <span class="n">__user</span> <span class="o">*</span><span class="n">conf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">get</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">conf_data</span>  <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span>               <span class="n">i</span><span class="p">;</span>
	<span class="kt">short</span>             <span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="mh">0xFFFF</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EUNATCH</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">get</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">,</span> <span class="n">conf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frad_conf</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">station</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FRAD_STATION_NODE</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">FRAD_VALID_FLAGS</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">kbaud</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> 
			 <span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">kbaud</span> <span class="o">&gt;</span> <span class="mi">128</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SDLA_S508</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">clocking</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">FRAD_CLOCK_INT</span> <span class="o">|</span> <span class="n">SDLA_S508_PORT_RS232</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">mtu</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="n">SDLA_MAX_MTU</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">T391</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">T391</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">T392</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">T392</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">N391</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">N391</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">N392</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">N392</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">N393</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">N393</span> <span class="o">&gt;</span> <span class="mi">10</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frad_conf</span><span class="p">));</span>
		<span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDLA_DIRECT_RECV</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SDLA_S508</span><span class="p">)</span>
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">SDLA_TX70_RX30</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">!=</span> <span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mtu</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/* this is required to change the MTU */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mtu</span><span class="p">;</span>
			<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="n">flp</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">=</span> <span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mtu</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">.</span><span class="n">mtu</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frhdr</span><span class="p">);</span>

		<span class="cm">/* off to the races! */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">configured</span><span class="p">)</span>
			<span class="n">sdla_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">flp</span><span class="o">-&gt;</span><span class="n">configured</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="cm">/* no sense reading if the CPU isn&#39;t started */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_READ_DLCI_CONFIGURATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SDLA_RET_OK</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">configured</span><span class="p">)</span>
				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frad_conf</span><span class="p">));</span>
			<span class="k">else</span>
				<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frad_conf</span><span class="p">));</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frad_conf</span><span class="p">));</span>
		<span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="n">FRAD_VALID_FLAGS</span><span class="p">;</span>
		<span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">mtu</span> <span class="o">-=</span> <span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">mtu</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frhdr</span><span class="p">)</span> <span class="o">?</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frhdr</span><span class="p">)</span> <span class="o">:</span> <span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">mtu</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">conf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frad_conf</span><span class="p">))</span><span class="o">?-</span><span class="n">EFAULT</span><span class="o">:</span><span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_xfer</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sdla_mem</span> <span class="n">__user</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="kt">int</span> <span class="n">read</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sdla_mem</span> <span class="n">mem</span><span class="p">;</span>
	<span class="kt">char</span>	<span class="o">*</span><span class="n">temp</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">mem</span><span class="p">,</span> <span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">mem</span><span class="p">)))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="n">read</span><span class="p">)</span>
	<span class="p">{</span>	
		<span class="n">temp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">mem</span><span class="p">.</span><span class="n">len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">temp</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="n">sdla_read</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">mem</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">mem</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">mem</span><span class="p">.</span><span class="n">len</span><span class="p">))</span>
		<span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">temp</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">mem</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="n">mem</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">temp</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
		<span class="n">sdla_write</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mem</span><span class="p">.</span><span class="n">addr</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">mem</span><span class="p">.</span><span class="n">len</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">temp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_reconfig</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">conf_data</span>  <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span>               <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">CONFIG_DLCI_MAX</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">data</span><span class="p">.</span><span class="n">dlci</span><span class="p">[</span><span class="n">len</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="n">len</span> <span class="o">*=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frad_conf</span><span class="p">));</span>
	<span class="n">len</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frad_conf</span><span class="p">);</span>

	<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_DISABLE_COMMUNICATIONS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_SET_DLCI_CONFIGURATION</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">sdla_cmd</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">SDLA_ENABLE_COMMUNICATIONS</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		
	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">FRAD_GET_CONF</span>:
		<span class="k">case</span> <span class="n">FRAD_SET_CONF</span>:
			<span class="k">return</span> <span class="n">sdla_config</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">FRAD_GET_CONF</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">SDLA_IDENTIFY</span>:
			<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_flags</span> <span class="o">=</span> <span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_CPUSPEED</span>:
			<span class="k">return</span> <span class="n">sdla_cpuspeed</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">);</span>

<span class="cm">/* ==========================================================</span>
<span class="cm">NOTE:  This is rather a useless action right now, as the</span>
<span class="cm">       current driver does not support protocols other than</span>
<span class="cm">       FR.  However, Sangoma has modules for a number of</span>
<span class="cm">       other protocols in the works.</span>
<span class="cm">============================================================*/</span>
		<span class="k">case</span> <span class="n">SDLA_PROTOCOL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">configured</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EALREADY</span><span class="p">;</span>

			<span class="k">switch</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_flags</span><span class="p">)</span>
			<span class="p">{</span>
				<span class="k">case</span> <span class="n">ARPHRD_FRAD</span>:
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_flags</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="nl">default:</span>
					<span class="k">return</span> <span class="o">-</span><span class="n">ENOPROTOOPT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_CLEARMEM</span>:
			<span class="n">sdla_clear</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_WRITEMEM</span>:
		<span class="k">case</span> <span class="n">SDLA_READMEM</span>:
			<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_SYS_RAWIO</span><span class="p">))</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
			<span class="k">return</span> <span class="n">sdla_xfer</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">SDLA_READMEM</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">SDLA_START</span>:
			<span class="n">sdla_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">SDLA_STOP</span>:
			<span class="n">sdla_stop</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_change_mtu</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_mtu</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* for now, you can&#39;t change the MTU! */</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">sdla_set_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifmap</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span><span class="p">;</span>
	<span class="kt">int</span>               <span class="n">i</span><span class="p">;</span>
	<span class="kt">char</span>              <span class="n">byte</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">base</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">valid_port</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">valid_port</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>   

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">valid_port</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">SDLA_IO_EXTENTS</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)){</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;io-port 0x%04lx in use</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">base</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="cm">/* test for card types, S502A, S502E, S507, S508                 */</span>
	<span class="cm">/* these tests shut down the card completely, so clear the state */</span>
	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SDLA_UNKNOWN</span><span class="p">;</span>
	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
   
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">SDLA_IO_EXTENTS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xFF</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">SDLA_IO_EXTENTS</span><span class="p">)</span> <span class="p">{</span>   
		<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_HALT</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_Z80_CONTROL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_S502_STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_S502E_INTACK</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_S502_STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0C</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_HALT</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
				<span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SDLA_S502E</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">got_type</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">byte</span><span class="o">=</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span><span class="p">),</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">SDLA_IO_EXTENTS</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="n">byte</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">SDLA_IO_EXTENTS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_HALT</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_S502_STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7E</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x30</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_S507_ENABLE</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_S502_STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7E</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x32</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_HALT</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
				<span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SDLA_S507</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">got_type</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_HALT</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_S508_STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_S508_INTEN</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_S508_STS</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3F</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x10</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_HALT</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SDLA_S508</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">got_type</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_S502A_HALT</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_S502_STS</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_S502A_START</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_S502_STS</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_S502A_INTEN</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_S502_STS</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x44</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">outb</span><span class="p">(</span><span class="n">SDLA_S502A_START</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>
				<span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">SDLA_S502A</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">got_type</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown card type</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

<span class="nl">got_type:</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x270</span>:
		<span class="k">case</span> <span class="mh">0x280</span>:
		<span class="k">case</span> <span class="mh">0x380</span>: 
		<span class="k">case</span> <span class="mh">0x390</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SDLA_S508</span> <span class="o">&amp;&amp;</span> <span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SDLA_S507</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SDLA_S502E</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mi">10</span>:
		<span class="k">case</span> <span class="mi">11</span>:
		<span class="k">case</span> <span class="mi">12</span>:
		<span class="k">case</span> <span class="mi">15</span>:
		<span class="k">case</span> <span class="mi">4</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SDLA_S508</span> <span class="o">&amp;&amp;</span> <span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SDLA_S507</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">case</span> <span class="mi">5</span>:
		<span class="k">case</span> <span class="mi">7</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SDLA_S502A</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sdla_isr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> 
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SDLA_S507</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mi">3</span>:
				<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SDLA_S507_IRQ3</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">4</span>:
				<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SDLA_S507_IRQ4</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">5</span>:
				<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SDLA_S507_IRQ5</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">7</span>:
				<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SDLA_S507_IRQ7</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">10</span>:
				<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SDLA_S507_IRQ10</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">11</span>:
				<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SDLA_S507_IRQ11</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">12</span>:
				<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SDLA_S507_IRQ12</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="mi">15</span>:
				<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SDLA_S507_IRQ15</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">valid_mem</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">valid_mem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>   

	<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">valid_mem</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SDLA_S502A</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span> <span class="o">==</span> <span class="mh">0x0E</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SDLA_S507</span> <span class="o">&amp;&amp;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">==</span> <span class="mh">0x0B</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SDLA_S507</span> <span class="o">&amp;&amp;</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span> <span class="o">==</span> <span class="mh">0x0D</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>

	<span class="n">byte</span> <span class="o">=</span> <span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">SDLA_S508</span> <span class="o">?</span> <span class="n">SDLA_8K_WINDOW</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">byte</span> <span class="o">|=</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&amp;</span> <span class="mh">0xF000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">12</span> <span class="o">+</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">SDLA_S508</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">SDLA_S502A</span>:
		<span class="k">case</span> <span class="n">SDLA_S502E</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mh">0x0A</span>:
					<span class="n">byte</span> <span class="o">|=</span> <span class="n">SDLA_S502_SEG_A</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x0C</span>:
					<span class="n">byte</span> <span class="o">|=</span> <span class="n">SDLA_S502_SEG_C</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x0D</span>:
					<span class="n">byte</span> <span class="o">|=</span> <span class="n">SDLA_S502_SEG_D</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x0E</span>:
					<span class="n">byte</span> <span class="o">|=</span> <span class="n">SDLA_S502_SEG_E</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SDLA_S507</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mh">0x0A</span>:
					<span class="n">byte</span> <span class="o">|=</span> <span class="n">SDLA_S507_SEG_A</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x0B</span>:
					<span class="n">byte</span> <span class="o">|=</span> <span class="n">SDLA_S507_SEG_B</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x0C</span>:
					<span class="n">byte</span> <span class="o">|=</span> <span class="n">SDLA_S507_SEG_C</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x0E</span>:
					<span class="n">byte</span> <span class="o">|=</span> <span class="n">SDLA_S507_SEG_E</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SDLA_S508</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">case</span> <span class="mh">0x0A</span>:
					<span class="n">byte</span> <span class="o">|=</span> <span class="n">SDLA_S508_SEG_A</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x0C</span>:
					<span class="n">byte</span> <span class="o">|=</span> <span class="n">SDLA_S508_SEG_C</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x0D</span>:
					<span class="n">byte</span> <span class="o">|=</span> <span class="n">SDLA_S508_SEG_D</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">case</span> <span class="mh">0x0E</span>:
					<span class="n">byte</span> <span class="o">|=</span> <span class="n">SDLA_S508_SEG_E</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set the memory bits, and enable access */</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">byte</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_PC_WINDOW</span><span class="p">);</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">case</span> <span class="n">SDLA_S502E</span>:
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SDLA_S502E_ENABLE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SDLA_S507</span>:
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">SDLA_MEMEN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">SDLA_S508</span>:
			<span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">SDLA_MEMEN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">,</span> <span class="n">base</span> <span class="o">+</span> <span class="n">SDLA_REG_CONTROL</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">base</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">mem_start</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span> <span class="o">+</span> <span class="mh">0x2000</span><span class="p">;</span>
	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">initialized</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">fail2:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
<span class="nl">fail:</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">SDLA_IO_EXTENTS</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
 
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">sdla_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>	<span class="o">=</span> <span class="n">sdla_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>	<span class="o">=</span> <span class="n">sdla_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>	<span class="o">=</span> <span class="n">sdla_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_config</span>	<span class="o">=</span> <span class="n">sdla_set_config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>	<span class="o">=</span> <span class="n">sdla_transmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>	<span class="o">=</span> <span class="n">sdla_change_mtu</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">setup_sdla</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">sdla_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span>		<span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span>		<span class="o">=</span> <span class="n">SDLA_MAX_MTU</span><span class="p">;</span>

	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">activate</span>		<span class="o">=</span> <span class="n">sdla_activate</span><span class="p">;</span>
	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">deactivate</span>		<span class="o">=</span> <span class="n">sdla_deactivate</span><span class="p">;</span>
	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">assoc</span>		<span class="o">=</span> <span class="n">sdla_assoc</span><span class="p">;</span>
	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">deassoc</span>		<span class="o">=</span> <span class="n">sdla_deassoc</span><span class="p">;</span>
	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">dlci_conf</span>		<span class="o">=</span> <span class="n">sdla_dlci_conf</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span>	<span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">flp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span>	<span class="o">=</span> <span class="n">sdla_poll</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">sdla</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_sdla</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">sdla</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">frad_local</span><span class="p">),</span> <span class="s">&quot;sdla0&quot;</span><span class="p">,</span> <span class="n">setup_sdla</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sdla</span><span class="p">)</span> 
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">sdla</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> 
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">sdla</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_sdla</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">frad_local</span> <span class="o">*</span><span class="n">flp</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">sdla</span><span class="p">);</span>

	<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">sdla</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">initialized</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">sdla</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sdla</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span><span class="n">sdla</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">SDLA_IO_EXTENTS</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">flp</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">sdla</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_sdla</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_sdla</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
