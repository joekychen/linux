<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wan › dscc4.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>dscc4.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/net/wan/dscc4/dscc4.c: a DSCC4 HDLC driver for Linux</span>
<span class="cm"> *</span>
<span class="cm"> * This software may be used and distributed according to the terms of the</span>
<span class="cm"> * GNU General Public License.</span>
<span class="cm"> *</span>
<span class="cm"> * The author may be reached as romieu@cogenit.fr.</span>
<span class="cm"> * Specific bug reports/asian food will be welcome.</span>
<span class="cm"> *</span>
<span class="cm"> * Special thanks to the nice people at CS-Telecom for the hardware and the</span>
<span class="cm"> * access to the test/measure tools.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *                             Theory of Operation</span>
<span class="cm"> *</span>
<span class="cm"> * I. Board Compatibility</span>
<span class="cm"> *</span>
<span class="cm"> * This device driver is designed for the Siemens PEB20534 4 ports serial</span>
<span class="cm"> * controller as found on Etinc PCISYNC cards. The documentation for the</span>
<span class="cm"> * chipset is available at http://www.infineon.com:</span>
<span class="cm"> * - Data Sheet &quot;DSCC4, DMA Supported Serial Communication Controller with</span>
<span class="cm"> * 4 Channels, PEB 20534 Version 2.1, PEF 20534 Version 2.1&quot;;</span>
<span class="cm"> * - Application Hint &quot;Management of DSCC4 on-chip FIFO resources&quot;.</span>
<span class="cm"> * - Errata sheet DS5 (courtesy of Michael Skerritt).</span>
<span class="cm"> * Jens David has built an adapter based on the same chipset. Take a look</span>
<span class="cm"> * at http://www.afthd.tu-darmstadt.de/~dg1kjd/pciscc4 for a specific</span>
<span class="cm"> * driver.</span>
<span class="cm"> * Sample code (2 revisions) is available at Infineon.</span>
<span class="cm"> *</span>
<span class="cm"> * II. Board-specific settings</span>
<span class="cm"> *</span>
<span class="cm"> * Pcisync can transmit some clock signal to the outside world on the</span>
<span class="cm"> * *first two* ports provided you put a quartz and a line driver on it and</span>
<span class="cm"> * remove the jumpers. The operation is described on Etinc web site. If you</span>
<span class="cm"> * go DCE on these ports, don&#39;t forget to use an adequate cable.</span>
<span class="cm"> *</span>
<span class="cm"> * Sharing of the PCI interrupt line for this board is possible.</span>
<span class="cm"> *</span>
<span class="cm"> * III. Driver operation</span>
<span class="cm"> *</span>
<span class="cm"> * The rx/tx operations are based on a linked list of descriptors. The driver</span>
<span class="cm"> * doesn&#39;t use HOLD mode any more. HOLD mode is definitely buggy and the more</span>
<span class="cm"> * I tried to fix it, the more it started to look like (convoluted) software</span>
<span class="cm"> * mutation of LxDA method. Errata sheet DS5 suggests to use LxDA: consider</span>
<span class="cm"> * this a rfc2119 MUST.</span>
<span class="cm"> *</span>
<span class="cm"> * Tx direction</span>
<span class="cm"> * When the tx ring is full, the xmit routine issues a call to netdev_stop.</span>
<span class="cm"> * The device is supposed to be enabled again during an ALLS irq (we could</span>
<span class="cm"> * use HI but as it&#39;s easy to lose events, it&#39;s fscked).</span>
<span class="cm"> *</span>
<span class="cm"> * Rx direction</span>
<span class="cm"> * The received frames aren&#39;t supposed to span over multiple receiving areas.</span>
<span class="cm"> * I may implement it some day but it isn&#39;t the highest ranked item.</span>
<span class="cm"> *</span>
<span class="cm"> * IV. Notes</span>
<span class="cm"> * The current error (XDU, RFO) recovery code is untested.</span>
<span class="cm"> * So far, RDO takes his RX channel down and the right sequence to enable it</span>
<span class="cm"> * again is still a mystery. If RDO happens, plan a reboot. More details</span>
<span class="cm"> * in the code (NB: as this happens, TX still works).</span>
<span class="cm"> * Don&#39;t mess the cables during operation, especially on DTE ports. I don&#39;t</span>
<span class="cm"> * suggest it for DCE either but at least one can get some messages instead</span>
<span class="cm"> * of a complete instant freeze.</span>
<span class="cm"> * Tests are done on Rev. 20 of the silicium. The RDO handling changes with</span>
<span class="cm"> * the documentation/chipset releases.</span>
<span class="cm"> *</span>
<span class="cm"> * TODO:</span>
<span class="cm"> * - test X25.</span>
<span class="cm"> * - use polling at high irq/s,</span>
<span class="cm"> * - performance analysis,</span>
<span class="cm"> * - endianness.</span>
<span class="cm"> *</span>
<span class="cm"> * 2001/12/10	Daniela Squassoni  &lt;daniela@cyclades.com&gt;</span>
<span class="cm"> * - Contribution to support the new generic HDLC layer.</span>
<span class="cm"> *</span>
<span class="cm"> * 2002/01	Ueimor</span>
<span class="cm"> * - old style interface removal</span>
<span class="cm"> * - dscc4_release_ring fix (related to DMA mapping)</span>
<span class="cm"> * - hard_start_xmit fix (hint: TxSizeMax)</span>
<span class="cm"> * - misc crapectomy.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/cache.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>

<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>

<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/hdlc.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cm">/* Version */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">version</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;$Id: dscc4.c,v 1.173 2003/09/20 23:55:34 romieu Exp $ for Linux</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">quartz</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_DSCC4_PCI_RST</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">dscc4_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span> <span class="n">dscc4_pci_config_store</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="cp">#endif</span>

<span class="cp">#define	DRV_NAME	&quot;dscc4&quot;</span>

<span class="cp">#undef DSCC4_POLLING</span>

<span class="cm">/* Module parameters */</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Maintainer: Francois Romieu &lt;romieu@cogenit.fr&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Siemens PEB20534 PCI Controller&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span><span class="s">&quot;Enable/disable extra messages&quot;</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">quartz</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">quartz</span><span class="p">,</span><span class="s">&quot;If present, on-board quartz frequency (Hz)&quot;</span><span class="p">);</span>

<span class="cm">/* Structures */</span>

<span class="k">struct</span> <span class="n">thingie</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">define</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bits</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">TxFD</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">next</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">complete</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">jiffies</span><span class="p">;</span> <span class="cm">/* Allows sizeof(TxFD) == sizeof(RxFD) + extra hack */</span>
		     <span class="cm">/* FWIW, datasheet calls that &quot;dummy&quot; and says that card</span>
<span class="cm">		      * never looks at it; neither does the driver */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">RxFD</span> <span class="p">{</span>
	<span class="n">__le32</span> <span class="n">state1</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">next</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">state2</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">end</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define DUMMY_SKB_SIZE		64</span>
<span class="cp">#define TX_LOW			8</span>
<span class="cp">#define TX_RING_SIZE		32</span>
<span class="cp">#define RX_RING_SIZE		32</span>
<span class="cp">#define TX_TOTAL_SIZE		TX_RING_SIZE*sizeof(struct TxFD)</span>
<span class="cp">#define RX_TOTAL_SIZE		RX_RING_SIZE*sizeof(struct RxFD)</span>
<span class="cp">#define IRQ_RING_SIZE		64		</span><span class="cm">/* Keep it a multiple of 32 */</span><span class="cp"></span>
<span class="cp">#define TX_TIMEOUT		(HZ/10)</span>
<span class="cp">#define DSCC4_HZ_MAX		33000000</span>
<span class="cp">#define BRR_DIVIDER_MAX		64*0x00004000	</span><span class="cm">/* Cf errata DS5 p.10 */</span><span class="cp"></span>
<span class="cp">#define dev_per_card		4</span>
<span class="cp">#define SCC_REGISTERS_MAX	23		</span><span class="cm">/* Cf errata DS5 p.4 */</span><span class="cp"></span>

<span class="cp">#define SOURCE_ID(flags)	(((flags) &gt;&gt; 28) &amp; 0x03)</span>
<span class="cp">#define TO_SIZE(state)		(((state) &gt;&gt; 16) &amp; 0x1fff)</span>

<span class="cm">/*</span>
<span class="cm"> * Given the operating range of Linux HDLC, the 2 defines below could be</span>
<span class="cm"> * made simpler. However they are a fine reminder for the limitations of</span>
<span class="cm"> * the driver: it&#39;s better to stay &lt; TxSizeMax and &lt; RxSizeMax.</span>
<span class="cm"> */</span>
<span class="cp">#define TO_STATE_TX(len)	cpu_to_le32(((len) &amp; TxSizeMax) &lt;&lt; 16)</span>
<span class="cp">#define TO_STATE_RX(len)	cpu_to_le32((RX_MAX(len) % RxSizeMax) &lt;&lt; 16)</span>
<span class="cp">#define RX_MAX(len)		((((len) &gt;&gt; 5) + 1) &lt;&lt; 5)	</span><span class="cm">/* Cf RLCR */</span><span class="cp"></span>
<span class="cp">#define SCC_REG_START(dpriv)	(SCC_START+(dpriv-&gt;dev_id)*SCC_OFFSET)</span>

<span class="k">struct</span> <span class="n">dscc4_pci_priv</span> <span class="p">{</span>
        <span class="n">__le32</span> <span class="o">*</span><span class="n">iqcfg</span><span class="p">;</span>
        <span class="kt">int</span> <span class="n">cfg_cur</span><span class="p">;</span>
        <span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>

        <span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
        <span class="n">dma_addr_t</span> <span class="n">iqcfg_dma</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">xtal_hz</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
        <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">TX_RING_SIZE</span><span class="p">];</span>

        <span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="n">rx_fd</span><span class="p">;</span>
        <span class="k">struct</span> <span class="n">TxFD</span> <span class="o">*</span><span class="n">tx_fd</span><span class="p">;</span>
        <span class="n">__le32</span> <span class="o">*</span><span class="n">iqrx</span><span class="p">;</span>
        <span class="n">__le32</span> <span class="o">*</span><span class="n">iqtx</span><span class="p">;</span>

	<span class="cm">/* FIXME: check all the volatile are required */</span>
        <span class="k">volatile</span> <span class="n">u32</span> <span class="n">tx_current</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">rx_current</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">iqtx_current</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">iqrx_current</span><span class="p">;</span>

        <span class="k">volatile</span> <span class="n">u32</span> <span class="n">tx_dirty</span><span class="p">;</span>
        <span class="k">volatile</span> <span class="n">u32</span> <span class="n">ltda</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">rx_dirty</span><span class="p">;</span>
        <span class="n">u32</span> <span class="n">lrda</span><span class="p">;</span>

        <span class="n">dma_addr_t</span> <span class="n">tx_fd_dma</span><span class="p">;</span>
        <span class="n">dma_addr_t</span> <span class="n">rx_fd_dma</span><span class="p">;</span>
        <span class="n">dma_addr_t</span> <span class="n">iqtx_dma</span><span class="p">;</span>
        <span class="n">dma_addr_t</span> <span class="n">iqrx_dma</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">scc_regs</span><span class="p">[</span><span class="n">SCC_REGISTERS_MAX</span><span class="p">];</span> <span class="cm">/* Cf errata DS5 p.4 */</span>

	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>

        <span class="k">struct</span> <span class="n">dscc4_pci_priv</span> <span class="o">*</span><span class="n">pci_priv</span><span class="p">;</span>
        <span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>

        <span class="kt">int</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">volatile</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">timer_help</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">encoding</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">parity</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">sync_serial_settings</span> <span class="n">settings</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">__pad</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">aligned</span> <span class="p">(</span><span class="mi">4</span><span class="p">)));</span>
<span class="p">};</span>

<span class="cm">/* GLOBAL registers definitions */</span>
<span class="cp">#define GCMDR   0x00</span>
<span class="cp">#define GSTAR   0x04</span>
<span class="cp">#define GMODE   0x08</span>
<span class="cp">#define IQLENR0 0x0C</span>
<span class="cp">#define IQLENR1 0x10</span>
<span class="cp">#define IQRX0   0x14</span>
<span class="cp">#define IQTX0   0x24</span>
<span class="cp">#define IQCFG   0x3c</span>
<span class="cp">#define FIFOCR1 0x44</span>
<span class="cp">#define FIFOCR2 0x48</span>
<span class="cp">#define FIFOCR3 0x4c</span>
<span class="cp">#define FIFOCR4 0x34</span>
<span class="cp">#define CH0CFG  0x50</span>
<span class="cp">#define CH0BRDA 0x54</span>
<span class="cp">#define CH0BTDA 0x58</span>
<span class="cp">#define CH0FRDA 0x98</span>
<span class="cp">#define CH0FTDA 0xb0</span>
<span class="cp">#define CH0LRDA 0xc8</span>
<span class="cp">#define CH0LTDA 0xe0</span>

<span class="cm">/* SCC registers definitions */</span>
<span class="cp">#define SCC_START	0x0100</span>
<span class="cp">#define SCC_OFFSET      0x80</span>
<span class="cp">#define CMDR    0x00</span>
<span class="cp">#define STAR    0x04</span>
<span class="cp">#define CCR0    0x08</span>
<span class="cp">#define CCR1    0x0c</span>
<span class="cp">#define CCR2    0x10</span>
<span class="cp">#define BRR     0x2C</span>
<span class="cp">#define RLCR    0x40</span>
<span class="cp">#define IMR     0x54</span>
<span class="cp">#define ISR     0x58</span>

<span class="cp">#define GPDIR	0x0400</span>
<span class="cp">#define GPDATA	0x0404</span>
<span class="cp">#define GPIM	0x0408</span>

<span class="cm">/* Bit masks */</span>
<span class="cp">#define EncodingMask	0x00700000</span>
<span class="cp">#define CrcMask		0x00000003</span>

<span class="cp">#define IntRxScc0	0x10000000</span>
<span class="cp">#define IntTxScc0	0x01000000</span>

<span class="cp">#define TxPollCmd	0x00000400</span>
<span class="cp">#define RxActivate	0x08000000</span>
<span class="cp">#define MTFi		0x04000000</span>
<span class="cp">#define Rdr		0x00400000</span>
<span class="cp">#define Rdt		0x00200000</span>
<span class="cp">#define Idr		0x00100000</span>
<span class="cp">#define Idt		0x00080000</span>
<span class="cp">#define TxSccRes	0x01000000</span>
<span class="cp">#define RxSccRes	0x00010000</span>
<span class="cp">#define TxSizeMax	0x1fff		</span><span class="cm">/* Datasheet DS1 - 11.1.1.1 */</span><span class="cp"></span>
<span class="cp">#define RxSizeMax	0x1ffc		</span><span class="cm">/* Datasheet DS1 - 11.1.2.1 */</span><span class="cp"></span>

<span class="cp">#define Ccr0ClockMask	0x0000003f</span>
<span class="cp">#define Ccr1LoopMask	0x00000200</span>
<span class="cp">#define IsrMask		0x000fffff</span>
<span class="cp">#define BrrExpMask	0x00000f00</span>
<span class="cp">#define BrrMultMask	0x0000003f</span>
<span class="cp">#define EncodingMask	0x00700000</span>
<span class="cp">#define Hold		cpu_to_le32(0x40000000)</span>
<span class="cp">#define SccBusy		0x10000000</span>
<span class="cp">#define PowerUp		0x80000000</span>
<span class="cp">#define Vis		0x00001000</span>
<span class="cp">#define FrameOk		(FrameVfr | FrameCrc)</span>
<span class="cp">#define FrameVfr	0x80</span>
<span class="cp">#define FrameRdo	0x40</span>
<span class="cp">#define FrameCrc	0x20</span>
<span class="cp">#define FrameRab	0x10</span>
<span class="cp">#define FrameAborted	cpu_to_le32(0x00000200)</span>
<span class="cp">#define FrameEnd	cpu_to_le32(0x80000000)</span>
<span class="cp">#define DataComplete	cpu_to_le32(0x40000000)</span>
<span class="cp">#define LengthCheck	0x00008000</span>
<span class="cp">#define SccEvt		0x02000000</span>
<span class="cp">#define NoAck		0x00000200</span>
<span class="cp">#define Action		0x00000001</span>
<span class="cp">#define HiDesc		cpu_to_le32(0x20000000)</span>

<span class="cm">/* SCC events */</span>
<span class="cp">#define RxEvt		0xf0000000</span>
<span class="cp">#define TxEvt		0x0f000000</span>
<span class="cp">#define Alls		0x00040000</span>
<span class="cp">#define Xdu		0x00010000</span>
<span class="cp">#define Cts		0x00004000</span>
<span class="cp">#define Xmr		0x00002000</span>
<span class="cp">#define Xpr		0x00001000</span>
<span class="cp">#define Rdo		0x00000080</span>
<span class="cp">#define Rfs		0x00000040</span>
<span class="cp">#define Cd		0x00000004</span>
<span class="cp">#define Rfo		0x00000002</span>
<span class="cp">#define Flex		0x00000001</span>

<span class="cm">/* DMA core events */</span>
<span class="cp">#define Cfg		0x00200000</span>
<span class="cp">#define Hi		0x00040000</span>
<span class="cp">#define Fi		0x00020000</span>
<span class="cp">#define Err		0x00010000</span>
<span class="cp">#define Arf		0x00000002</span>
<span class="cp">#define ArAck		0x00000001</span>

<span class="cm">/* State flags */</span>
<span class="cp">#define Ready		0x00000000</span>
<span class="cp">#define NeedIDR		0x00000001</span>
<span class="cp">#define NeedIDT		0x00000002</span>
<span class="cp">#define RdoSet		0x00000004</span>
<span class="cp">#define FakeReset	0x00000008</span>

<span class="cm">/* Don&#39;t mask RDO. Ever. */</span>
<span class="cp">#ifdef DSCC4_POLLING</span>
<span class="cp">#define EventsMask	0xfffeef7f</span>
<span class="cp">#else</span>
<span class="cp">#define EventsMask	0xfffa8f7a</span>
<span class="cp">#endif</span>

<span class="cm">/* Functions prototypes */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dscc4_rx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_pci_priv</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dscc4_tx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_pci_priv</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dscc4_found1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dscc4_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dscc4_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">dscc4_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dscc4_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dscc4_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">rq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dscc4_init_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dscc4_release_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dscc4_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">dscc4_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">dscc4_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dscc4_hdlc_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dscc4_set_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#ifdef DSCC4_POLLING</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dscc4_tx_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="nf">dscc4_priv</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dev_to_hdlc</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">dscc4_to_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scc_patchl</span><span class="p">(</span><span class="n">u32</span> <span class="n">mask</span><span class="p">,</span> <span class="n">u32</span> <span class="n">value</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>

	<span class="cm">/* Cf scc_writel for concern regarding thread-safety */</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">scc_regs</span><span class="p">[</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">];</span>
	<span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
	<span class="n">state</span> <span class="o">|=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">scc_regs</span><span class="p">[</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SCC_REG_START</span><span class="p">(</span><span class="n">dpriv</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">scc_writel</span><span class="p">(</span><span class="n">u32</span> <span class="n">bits</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Thread-UNsafe.</span>
<span class="cm">	 * As of 2002/02/16, there are no thread racing for access.</span>
<span class="cm">	 */</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">scc_regs</span><span class="p">[</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">bits</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SCC_REG_START</span><span class="p">(</span><span class="n">dpriv</span><span class="p">)</span> <span class="o">+</span> <span class="n">offset</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u32</span> <span class="nf">scc_readl</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">scc_regs</span><span class="p">[</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">scc_readl_star</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Cf errata DS5 p.4 */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SCC_REG_START</span><span class="p">(</span><span class="n">dpriv</span><span class="p">)</span> <span class="o">+</span> <span class="n">STAR</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">SCC_REG_START</span><span class="p">(</span><span class="n">dpriv</span><span class="p">)</span> <span class="o">+</span> <span class="n">STAR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dscc4_do_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">ltda</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_fd_dma</span> <span class="o">+</span>
                      <span class="p">((</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_current</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">TX_RING_SIZE</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">TxFD</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">ltda</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CH0LTDA</span> <span class="o">+</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="cm">/* Flush posted writes *NOW* */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CH0LTDA</span> <span class="o">+</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dscc4_rx_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">lrda</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_fd_dma</span> <span class="o">+</span>
		      <span class="p">((</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_dirty</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">%</span><span class="n">RX_RING_SIZE</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxFD</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">lrda</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CH0LRDA</span> <span class="o">+</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dscc4_tx_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_current</span> <span class="o">==</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_dirty</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">dscc4_tx_quiescent</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">readl</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CH0FTDA</span> <span class="o">+</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="o">*</span><span class="mi">4</span><span class="p">)</span> <span class="o">==</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">ltda</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">state_check</span><span class="p">(</span><span class="n">u32</span> <span class="n">state</span><span class="p">,</span> <span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">SOURCE_ID</span><span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">!=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s (%s): Source Id=%d, state=%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">SOURCE_ID</span><span class="p">(</span><span class="n">state</span><span class="p">),</span> <span class="n">state</span> <span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0x0df80c00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s (%s): state=%08x (UFO alert)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dscc4_tx_print</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
			   <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: tx_current=%02d tx_dirty=%02d (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_current</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_dirty</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dscc4_release_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">pci_priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TxFD</span> <span class="o">*</span><span class="n">tx_fd</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_fd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="n">rx_fd</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_fd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">**</span><span class="n">skbuff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">tx_fd</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_fd_dma</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">rx_fd</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_fd_dma</span><span class="p">);</span>

	<span class="n">skbuff</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">skbuff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
				<span class="p">(</span><span class="o">*</span><span class="n">skbuff</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="o">*</span><span class="n">skbuff</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">skbuff</span><span class="o">++</span><span class="p">;</span>
		<span class="n">tx_fd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skbuff</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">skbuff</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
				<span class="n">RX_MAX</span><span class="p">(</span><span class="n">HDLC_MAX_MRU</span><span class="p">),</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
			<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="o">*</span><span class="n">skbuff</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">skbuff</span><span class="o">++</span><span class="p">;</span>
		<span class="n">rx_fd</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">try_get_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dirty</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_dirty</span><span class="o">%</span><span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="n">rx_fd</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_fd</span> <span class="o">+</span> <span class="n">dirty</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">RX_MAX</span><span class="p">(</span><span class="n">HDLC_MAX_MRU</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">);</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">dirty</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">hdlc_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">pci_priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					  <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * IRQ/thread/whatever safe</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_wait_ack_cec</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scc_readl_star</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SccBusy</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s ack (%d try)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">msg</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="n">rmb</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">i</span> <span class="o">:</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_do_action</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dscc4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">writel</span><span class="p">(</span><span class="n">Action</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GCMDR</span><span class="p">);</span>
	<span class="n">ioaddr</span> <span class="o">+=</span> <span class="n">GSTAR</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">u32</span> <span class="n">state</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">ArAck</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s ack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">ArAck</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Arf</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">Arf</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
			<span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>
		<span class="n">rmb</span><span class="p">();</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dscc4_xpr_ack</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">cur</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqtx_current</span><span class="o">%</span><span class="n">IRQ_RING_SIZE</span><span class="p">;</span>
	<span class="n">s8</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">NeedIDR</span> <span class="o">|</span> <span class="n">NeedIDT</span><span class="p">))</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqtx</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">Xpr</span><span class="p">)))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">smp_rmb</span><span class="p">();</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span> <span class="o">?</span> <span class="n">i</span> <span class="o">:</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#if 0</span><span class="c"> /* dscc4_{rx/tx}_reset are both unreliable - more tweak needed */</span>
<span class="c">static void dscc4_rx_reset(struct dscc4_dev_priv *dpriv, struct net_device *dev)</span>
<span class="c">{</span>
<span class="c">	unsigned long flags;</span>

<span class="c">	spin_lock_irqsave(&amp;dpriv-&gt;pci_priv-&gt;lock, flags);</span>
<span class="c">	/* Cf errata DS5 p.6 */</span>
<span class="c">	writel(0x00000000, dpriv-&gt;base_addr + CH0LRDA + dpriv-&gt;dev_id*4);</span>
<span class="c">	scc_patchl(PowerUp, 0, dpriv, dev, CCR0);</span>
<span class="c">	readl(dpriv-&gt;base_addr + CH0LRDA + dpriv-&gt;dev_id*4);</span>
<span class="c">	writel(MTFi|Rdr, dpriv-&gt;base_addr + dpriv-&gt;dev_id*0x0c + CH0CFG);</span>
<span class="c">	writel(Action, dpriv-&gt;base_addr + GCMDR);</span>
<span class="c">	spin_unlock_irqrestore(&amp;dpriv-&gt;pci_priv-&gt;lock, flags);</span>
<span class="c">}</span>

<span class="cp">#endif</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void dscc4_tx_reset(struct dscc4_dev_priv *dpriv, struct net_device *dev)</span>
<span class="c">{</span>
<span class="c">	u16 i = 0;</span>

<span class="c">	/* Cf errata DS5 p.7 */</span>
<span class="c">	scc_patchl(PowerUp, 0, dpriv, dev, CCR0);</span>
<span class="c">	scc_writel(0x00050000, dpriv, dev, CCR2);</span>
<span class="c">	/*</span>
<span class="c">	 * Must be longer than the time required to fill the fifo.</span>
<span class="c">	 */</span>
<span class="c">	while (!dscc4_tx_quiescent(dpriv, dev) &amp;&amp; ++i) {</span>
<span class="c">		udelay(1);</span>
<span class="c">		wmb();</span>
<span class="c">	}</span>

<span class="c">	writel(MTFi|Rdt, dpriv-&gt;base_addr + dpriv-&gt;dev_id*0x0c + CH0CFG);</span>
<span class="c">	if (dscc4_do_action(dev, &quot;Rdt&quot;) &lt; 0)</span>
<span class="c">		netdev_err(dev, &quot;Tx reset failed\n&quot;);</span>
<span class="c">}</span>
<span class="cp">#endif</span>

<span class="cm">/* TODO: (ab)use this function to refill a completely depleted RX ring. */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">dscc4_rx_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="n">rx_fd</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_fd</span> <span class="o">+</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_current</span><span class="o">%</span><span class="n">RX_RING_SIZE</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">pci_priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pkt_len</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">[</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_current</span><span class="o">++%</span><span class="n">RX_RING_SIZE</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: skb=0 (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">refill</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pkt_len</span> <span class="o">=</span> <span class="n">TO_SIZE</span><span class="p">(</span><span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">state2</span><span class="p">));</span>
	<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
			 <span class="n">RX_MAX</span><span class="p">(</span><span class="n">HDLC_MAX_MRU</span><span class="p">),</span> <span class="n">PCI_DMA_FROMDEVICE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="o">--</span><span class="n">pkt_len</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FrameOk</span><span class="p">)</span> <span class="o">==</span> <span class="n">FrameOk</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pkt_len</span><span class="p">;</span>
		<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pkt_len</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">hdlc_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">pkt_len</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FrameRdo</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">pkt_len</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">FrameCrc</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">pkt_len</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">FrameVfr</span> <span class="o">|</span> <span class="n">FrameRab</span><span class="p">))</span> <span class="o">!=</span>
			 <span class="p">(</span><span class="n">FrameVfr</span> <span class="o">|</span> <span class="n">FrameRab</span><span class="p">))</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">refill:</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_dirty</span> <span class="o">-</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_current</span><span class="p">)</span> <span class="o">%</span> <span class="n">RX_RING_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">try_get_rx_skb</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_dirty</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dscc4_rx_update</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">state2</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xbabeface</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dscc4_free1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dscc4_pci_priv</span> <span class="o">*</span><span class="n">ppriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ppriv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">root</span> <span class="o">=</span> <span class="n">ppriv</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_per_card</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">unregister_hdlc_device</span><span class="p">(</span><span class="n">dscc4_to_dev</span><span class="p">(</span><span class="n">root</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_per_card</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ppriv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">dscc4_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dscc4_pci_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_request_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;registers&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t reserve MMIO region (regs)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	        <span class="k">goto</span> <span class="n">err_disable_0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pci_request_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;LBI interface&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t reserve MMIO region (lbi)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	        <span class="k">goto</span> <span class="n">err_free_mmio_region_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">pci_ioremap_bar</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ioaddr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;cannot remap MMIO region %llx @ %llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_len</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
		       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">));</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_free_mmio_regions_2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;Siemens DSCC4, MMIO at %#llx (regs), %#llx (lbi), IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	        <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
	        <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="cm">/* Cf errata DS5 p.2 */</span>
	<span class="n">pci_write_config_byte</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_LATENCY_TIMER</span><span class="p">,</span> <span class="mh">0xf8</span><span class="p">);</span>
	<span class="n">pci_set_master</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">dscc4_found1</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	        <span class="k">goto</span> <span class="n">err_iounmap_3</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dscc4_irq</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;IRQ %d busy</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_release_4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* power up/little endian/dma core controlled via lrda/ltda */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000001</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GMODE</span><span class="p">);</span>
	<span class="cm">/* Shared interrupt queue */</span>
	<span class="p">{</span>
		<span class="n">u32</span> <span class="n">bits</span><span class="p">;</span>

		<span class="n">bits</span> <span class="o">=</span> <span class="p">(</span><span class="n">IRQ_RING_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">bits</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">bits</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">|=</span> <span class="n">bits</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">bits</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IQLENR0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Global interrupt queue */</span>
	<span class="n">writel</span><span class="p">((</span><span class="n">u32</span><span class="p">)(((</span><span class="n">IRQ_RING_SIZE</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">20</span><span class="p">),</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IQLENR1</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">iqcfg</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
		<span class="n">IRQ_RING_SIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">__le32</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iqcfg_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iqcfg</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_irq_5</span><span class="p">;</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iqcfg_dma</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IQCFG</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * SCC 0-3 private rx/tx irq structures</span>
<span class="cm">	 * IQRX/TXi needs to be set soon. Learned it the hard way...</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_per_card</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpriv</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqtx</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">IRQ_RING_SIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqtx_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqtx</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_iqtx_6</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqtx_dma</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IQTX0</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_per_card</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpriv</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqrx</span> <span class="o">=</span> <span class="p">(</span><span class="n">__le32</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span>
			<span class="n">IRQ_RING_SIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqrx_dma</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqrx</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_iqrx_7</span><span class="p">;</span>
		<span class="n">writel</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqrx_dma</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">IQRX0</span> <span class="o">+</span> <span class="n">i</span><span class="o">*</span><span class="mi">4</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Cf application hint. Beware of hard-lock condition on threshold. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x42104000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">FIFOCR1</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><p>writel(0x9ce69800, ioaddr + FIFOCR2);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">writel</span><span class="p">(</span><span class="mh">0xdef6d800</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">FIFOCR2</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-3"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-3">&#182;</a></div><p>writel(0x11111111, ioaddr + FIFOCR4);</p></td><td class="code"><div class="highlight"><pre>	<span class="n">writel</span><span class="p">(</span><span class="mh">0x18181818</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">FIFOCR4</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-4"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-4">&#182;</a></div><p>FIXME: should depend on the chipset revision</p></td><td class="code"><div class="highlight"><pre>	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0000000e</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">FIFOCR3</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0xff200001</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GCMDR</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>

<span class="nl">err_free_iqrx_7:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpriv</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IRQ_RING_SIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
				    <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqrx</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqrx_dma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">dev_per_card</span><span class="p">;</span>
<span class="nl">err_free_iqtx_6:</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpriv</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IRQ_RING_SIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
				    <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqtx</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqtx_dma</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IRQ_RING_SIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">iqcfg</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">iqcfg_dma</span><span class="p">);</span>
<span class="nl">err_free_irq_5:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">);</span>
<span class="nl">err_release_4:</span>
	<span class="n">dscc4_free1</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_iounmap_3:</span>
	<span class="n">iounmap</span> <span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>
<span class="nl">err_free_mmio_regions_2:</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="nl">err_free_mmio_region_1:</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="nl">err_disable_0:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Let&#39;s hope the default values are decent enough to protect my</span>
<span class="cm"> * feet from the user&#39;s gun - Ueimor</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dscc4_init_registers</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* No interrupts, SCC core disabled. Let&#39;s relax */</span>
	<span class="n">scc_writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR0</span><span class="p">);</span>

	<span class="n">scc_writel</span><span class="p">(</span><span class="n">LengthCheck</span> <span class="o">|</span> <span class="p">(</span><span class="n">HDLC_MAX_MRU</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">),</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">RLCR</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * No address recognition/crc-CCITT/cts enabled</span>
<span class="cm">	 * Shared flags transmission disabled - cf errata DS5 p.11</span>
<span class="cm">	 * Carrier detect disabled - cf errata p.14</span>
<span class="cm">	 * FIXME: carrier detection/polarity may be handled more gracefully.</span>
<span class="cm">	 */</span>
	<span class="n">scc_writel</span><span class="p">(</span><span class="mh">0x02408000</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR1</span><span class="p">);</span>

	<span class="cm">/* crc not forwarded - Cf errata DS5 p.11 */</span>
	<span class="n">scc_writel</span><span class="p">(</span><span class="mh">0x00050008</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">RxActivate</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR2</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-5"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-5">&#182;</a></div><p>crc forwarded
scc_writel(0x00250008 &amp; ~RxActivate, dpriv, dev, CCR2);</p></td><td class="code"><div class="highlight"><pre><span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dscc4_set_quartz</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">hz</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">hz</span> <span class="o">&gt;</span> <span class="n">DSCC4_HZ_MAX</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">pci_priv</span><span class="o">-&gt;</span><span class="n">xtal_hz</span> <span class="o">=</span> <span class="n">hz</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">dscc4_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>       <span class="o">=</span> <span class="n">dscc4_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>       <span class="o">=</span> <span class="n">dscc4_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span> <span class="o">=</span> <span class="n">hdlc_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">hdlc_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>   <span class="o">=</span> <span class="n">dscc4_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> <span class="o">=</span> <span class="n">dscc4_tx_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_found1</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dscc4_pci_priv</span> <span class="o">*</span><span class="n">ppriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">root</span> <span class="o">=</span> <span class="n">kcalloc</span><span class="p">(</span><span class="n">dev_per_card</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">root</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">root</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_per_card</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">root</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_hdlcdev</span><span class="p">(</span><span class="n">root</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">root</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ppriv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ppriv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ppriv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_dev</span><span class="p">;</span>

	<span class="n">ppriv</span><span class="o">-&gt;</span><span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ppriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_per_card</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span> <span class="o">=</span> <span class="n">root</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="n">dscc4_to_dev</span><span class="p">(</span><span class="n">dpriv</span><span class="p">);</span>
		<span class="n">hdlc_device</span> <span class="o">*</span><span class="n">hdlc</span> <span class="o">=</span> <span class="n">dev_to_hdlc</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>

	        <span class="n">d</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ioaddr</span><span class="p">;</span>
	        <span class="n">d</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dscc4_ops</span><span class="p">;</span>
		<span class="n">d</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>
		<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">pci_priv</span> <span class="o">=</span> <span class="n">ppriv</span><span class="p">;</span>
		<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">xmit</span> <span class="o">=</span> <span class="n">dscc4_start_xmit</span><span class="p">;</span>
		<span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">attach</span> <span class="o">=</span> <span class="n">dscc4_hdlc_attach</span><span class="p">;</span>

		<span class="n">dscc4_init_registers</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
		<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="n">PARITY_CRC16_PR0_CCITT</span><span class="p">;</span>
		<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">ENCODING_NRZ</span><span class="p">;</span>
	
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dscc4_init_ring</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_unregister</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">register_hdlc_device</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unable to register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dscc4_release_ring</span><span class="p">(</span><span class="n">dpriv</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_unregister</span><span class="p">;</span>
	        <span class="p">}</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">dscc4_set_quartz</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">quartz</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_unregister</span><span class="p">;</span>

	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ppriv</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">err_unregister:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dscc4_release_ring</span><span class="p">(</span><span class="n">root</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">unregister_hdlc_device</span><span class="p">(</span><span class="n">dscc4_to_dev</span><span class="p">(</span><span class="n">root</span> <span class="o">+</span> <span class="n">i</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ppriv</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">dev_per_card</span><span class="p">;</span>
<span class="nl">err_free_dev:</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">root</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* FIXME: get rid of the unneeded code */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dscc4_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span> <span class="o">=</span> <span class="n">dscc4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-6"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-6">&#182;</a></div><p>struct dscc4<em>pci</em>priv *ppriv;</p></td><td class="code"><div class="highlight"><pre>	<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
<span class="nl">done:</span>
        <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">TX_TIMEOUT</span><span class="p">;</span>
        <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dscc4_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: something is missing there */</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_loopback_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sync_serial_settings</span> <span class="o">*</span><span class="n">settings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">loopback</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">clock_type</span> <span class="o">!=</span> <span class="n">CLOCK_INT</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dscc4_to_dev</span><span class="p">(</span><span class="n">dpriv</span><span class="p">);</span>

		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;loopback requires clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_DSCC4_PCI_RST</span>
<span class="cm">/*</span>
<span class="cm"> * Some DSCC4-based cards wires the GPIO port and the PCI #RST pin together</span>
<span class="cm"> * so as to provide a safe way to reset the asic while not the whole machine</span>
<span class="cm"> * rebooting.</span>
<span class="cm"> *</span>
<span class="cm"> * This code doesn&#39;t need to be efficient. Keep It Simple</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">dscc4_pci_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dscc4_mutex</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pci_read_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dscc4_pci_config_store</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Maximal LBI clock divider (who cares ?) and whole GPIO range. */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x001c0000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GMODE</span><span class="p">);</span>
	<span class="cm">/* Configure GPIO port as output */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0000ffff</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GPDIR</span><span class="p">);</span>
	<span class="cm">/* Disable interruption */</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0000ffff</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GPIM</span><span class="p">);</span>

	<span class="n">writel</span><span class="p">(</span><span class="mh">0x0000ffff</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GPDATA</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GPDATA</span><span class="p">);</span>

	<span class="cm">/* Flush posted writes */</span>
	<span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GSTAR</span><span class="p">);</span>

	<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pci_write_config_dword</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">,</span> <span class="n">dscc4_pci_config_store</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dscc4_mutex</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define dscc4_pci_reset(pdev,ioaddr)	do {} while (0)</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_DSCC4_PCI_RST */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span> <span class="o">=</span> <span class="n">dscc4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dscc4_pci_priv</span> <span class="o">*</span><span class="n">ppriv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">dscc4_loopback_check</span><span class="p">(</span><span class="n">dpriv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">hdlc_open</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span>
		<span class="k">goto</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">ppriv</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">pci_priv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Due to various bugs, there is no way to reliably reset a</span>
<span class="cm">	 * specific port (manufacturer&#39;s dependent special PCI #RST wiring</span>
<span class="cm">	 * apart: it affects all ports). Thus the device goes in the best</span>
<span class="cm">	 * silent mode possible at dscc4_close() time and simply claims to</span>
<span class="cm">	 * be up if it&#39;s opened again. It still isn&#39;t possible to change</span>
<span class="cm">	 * the HDLC configuration without rebooting but at least the ports</span>
<span class="cm">	 * can be up/down ifconfig&#39;ed without killing the host.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FakeReset</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FakeReset</span><span class="p">;</span>
		<span class="n">scc_patchl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PowerUp</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR0</span><span class="p">);</span>
		<span class="n">scc_patchl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mh">0x00050000</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR2</span><span class="p">);</span>
		<span class="n">scc_writel</span><span class="p">(</span><span class="n">EventsMask</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">IMR</span><span class="p">);</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;up again</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* IDT+IDR during XPR */</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">NeedIDR</span> <span class="o">|</span> <span class="n">NeedIDT</span><span class="p">;</span>

	<span class="n">scc_patchl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">PowerUp</span> <span class="o">|</span> <span class="n">Vis</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The following is a bit paranoid...</span>
<span class="cm">	 *</span>
<span class="cm">	 * NB: the datasheet &quot;...CEC will stay active if the SCC is in</span>
<span class="cm">	 * power-down mode or...&quot; and CCR2.RAC = 1 are two different</span>
<span class="cm">	 * situations.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">scc_readl_star</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SccBusy</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;busy - try later</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;available - good</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">scc_writel</span><span class="p">(</span><span class="n">EventsMask</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">IMR</span><span class="p">);</span>

	<span class="cm">/* Posted write is flushed in the wait_ack loop */</span>
	<span class="n">scc_writel</span><span class="p">(</span><span class="n">TxSccRes</span> <span class="o">|</span> <span class="n">RxSccRes</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">dscc4_wait_ack_cec</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cec&quot;</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_disable_scc_events</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * I would expect XPR near CE completion (before ? after ?).</span>
<span class="cm">	 * At worst, this code won&#39;t see a late XPR and people</span>
<span class="cm">	 * will have to re-issue an ifconfig (this is harmless).</span>
<span class="cm">	 * WARNING, a really missing XPR usually means a hardware</span>
<span class="cm">	 * reset is needed. Suggestions anyone ?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">dscc4_xpr_ack</span><span class="p">(</span><span class="n">dpriv</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;XPR timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_disable_scc_events</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dscc4_tx_print</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="s">&quot;Open&quot;</span><span class="p">);</span>

<span class="nl">done:</span>
	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

        <span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
        <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">10</span><span class="o">*</span><span class="n">HZ</span><span class="p">;</span>
        <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">dscc4_timer</span><span class="p">;</span>
        <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_disable_scc_events:</span>
	<span class="n">scc_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">IMR</span><span class="p">);</span>
	<span class="n">scc_patchl</span><span class="p">(</span><span class="n">PowerUp</span> <span class="o">|</span> <span class="n">Vis</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR0</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="n">hdlc_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="nl">err:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef DSCC4_POLLING</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_tx_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* FIXME: it&#39;s gonna be easy (TM), for sure */</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* DSCC4_POLLING */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">dscc4_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
					  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span> <span class="o">=</span> <span class="n">dscc4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">dscc4_pci_priv</span> <span class="o">*</span><span class="n">ppriv</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">pci_priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TxFD</span> <span class="o">*</span><span class="n">tx_fd</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">next</span><span class="p">;</span>

	<span class="n">next</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_current</span><span class="o">%</span><span class="n">TX_RING_SIZE</span><span class="p">;</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">next</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">tx_fd</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_fd</span> <span class="o">+</span> <span class="n">next</span><span class="p">;</span>
	<span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FrameEnd</span> <span class="o">|</span> <span class="n">TO_STATE_TX</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
	<span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">ppriv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
				     <span class="n">PCI_DMA_TODEVICE</span><span class="p">));</span>
	<span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	<span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">jiffies</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">mb</span><span class="p">();</span>

<span class="cp">#ifdef DSCC4_POLLING</span>
	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">dscc4_tx_poll</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">));</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">dscc4_tx_print</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="s">&quot;Xmit&quot;</span><span class="p">);</span>
	<span class="cm">/* To be cleaned(unsigned int)/optimized. Later, ok ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="o">++</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_current</span> <span class="o">-</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_dirty</span><span class="p">)</span><span class="o">%</span><span class="n">TX_RING_SIZE</span><span class="p">))</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dscc4_tx_quiescent</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span>
		<span class="n">dscc4_do_tx</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span> <span class="o">=</span> <span class="n">dscc4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">scc_patchl</span><span class="p">(</span><span class="n">PowerUp</span> <span class="o">|</span> <span class="n">Vis</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR0</span><span class="p">);</span>
	<span class="n">scc_patchl</span><span class="p">(</span><span class="mh">0x00050000</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR2</span><span class="p">);</span>
	<span class="n">scc_writel</span><span class="p">(</span><span class="mh">0xffffffff</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">IMR</span><span class="p">);</span>

	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FakeReset</span><span class="p">;</span>

	<span class="n">hdlc_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">dscc4_check_clock_ability</span><span class="p">(</span><span class="kt">int</span> <span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_DSCC4_PCISYNC</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * DS1 p.137: &quot;There are a total of 13 different clocking modes...&quot;</span>
<span class="cm"> *                                  ^^</span>
<span class="cm"> * Design choices:</span>
<span class="cm"> * - by default, assume a clock is provided on pin RxClk/TxClk (clock mode 0a).</span>
<span class="cm"> *   Clock mode 3b _should_ work but the testing seems to make this point</span>
<span class="cm"> *   dubious (DIY testing requires setting CCR0 at 0x00000033).</span>
<span class="cm"> *   This is supposed to provide least surprise &quot;DTE like&quot; behavior.</span>
<span class="cm"> * - if line rate is specified, clocks are assumed to be locally generated.</span>
<span class="cm"> *   A quartz must be available (on pin XTAL1). Modes 6b/7b are used. Choosing</span>
<span class="cm"> *   between these it automagically done according on the required frequency</span>
<span class="cm"> *   scaling. Of course some rounding may take place.</span>
<span class="cm"> * - no high speed mode (40Mb/s). May be trivial to do but I don&#39;t have an</span>
<span class="cm"> *   appropriate external clocking device for testing.</span>
<span class="cm"> * - no time-slot/clock mode 5: shameless laziness.</span>
<span class="cm"> *</span>
<span class="cm"> * The clock signals wiring can be (is ?) manufacturer dependent. Good luck.</span>
<span class="cm"> *</span>
<span class="cm"> * BIG FAT WARNING: if the device isn&#39;t provided enough clocking signal, it</span>
<span class="cm"> * won&#39;t pass the init sequence. For example, straight back-to-back DTE without</span>
<span class="cm"> * external clock will fail when dscc4_open() (&lt;- &#39;ifconfig hdlcx xxx&#39;) is</span>
<span class="cm"> * called.</span>
<span class="cm"> *</span>
<span class="cm"> * Typos lurk in datasheet (missing divier in clock mode 7a figure 51 p.153</span>
<span class="cm"> * DS0 for example)</span>
<span class="cm"> *</span>
<span class="cm"> * Clock mode related bits of CCR0:</span>
<span class="cm"> *     +------------ TOE: output TxClk (0b/2b/3a/3b/6b/7a/7b only)</span>
<span class="cm"> *     | +---------- SSEL: sub-mode select 0 -&gt; a, 1 -&gt; b</span>
<span class="cm"> *     | | +-------- High Speed: say 0</span>
<span class="cm"> *     | | | +-+-+-- Clock Mode: 0..7</span>
<span class="cm"> *     | | | | | |</span>
<span class="cm"> * -+-+-+-+-+-+-+-+</span>
<span class="cm"> * x|x|5|4|3|2|1|0| lower bits</span>
<span class="cm"> *</span>
<span class="cm"> * Division factor of BRR: k = (N+1)x2^M (total divider = 16xk in mode 6b)</span>
<span class="cm"> *            +-+-+-+------------------ M (0..15)</span>
<span class="cm"> *            | | | |     +-+-+-+-+-+-- N (0..63)</span>
<span class="cm"> *    0 0 0 0 | | | | 0 0 | | | | | |</span>
<span class="cm"> * ...-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+-+</span>
<span class="cm"> *    f|e|d|c|b|a|9|8|7|6|5|4|3|2|1|0| lower bits</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_set_clock</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">bps</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span> <span class="o">=</span> <span class="n">dscc4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">brr</span><span class="p">;</span>

	<span class="o">*</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Ccr0ClockMask</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">bps</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Clock generated - required for DCE */</span>
		<span class="n">u32</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">divider</span><span class="p">;</span>
		<span class="kt">int</span> <span class="n">xtal</span><span class="p">;</span>

		<span class="n">xtal</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">pci_priv</span><span class="o">-&gt;</span><span class="n">xtal_hz</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xtal</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dscc4_check_clock_ability</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="n">xtal</span> <span class="o">/</span> <span class="o">*</span><span class="n">bps</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&gt;</span> <span class="n">BRR_DIVIDER_MAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">divider</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>
			<span class="o">*</span><span class="n">state</span> <span class="o">|=</span> <span class="mh">0x00000036</span><span class="p">;</span> <span class="cm">/* Clock mode 6b (BRG/16) */</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="o">*</span><span class="n">state</span> <span class="o">|=</span> <span class="mh">0x00000037</span><span class="p">;</span> <span class="cm">/* Clock mode 7b (BRG) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">divider</span> <span class="o">&gt;&gt;</span> <span class="mi">22</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">n</span> <span class="o">=</span> <span class="mi">63</span><span class="p">;</span>
			<span class="n">m</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">divider</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Extraction of the 6 highest weighted bits */</span>
			<span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="mh">0xffffffc0</span> <span class="o">&amp;</span> <span class="n">divider</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">m</span><span class="o">++</span><span class="p">;</span>
				<span class="n">divider</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">n</span> <span class="o">=</span> <span class="n">divider</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">brr</span> <span class="o">=</span> <span class="p">(</span><span class="n">m</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">n</span><span class="p">;</span>
		<span class="n">divider</span> <span class="o">=</span> <span class="n">n</span> <span class="o">&lt;&lt;</span> <span class="n">m</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="o">*</span><span class="n">state</span> <span class="o">&amp;</span> <span class="mh">0x00000001</span><span class="p">))</span> <span class="cm">/* ?b mode mask =&gt; clock mode 6b */</span>
			<span class="n">divider</span> <span class="o">&lt;&lt;=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="o">*</span><span class="n">bps</span> <span class="o">=</span> <span class="n">xtal</span> <span class="o">/</span> <span class="n">divider</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * External clock - DTE</span>
<span class="cm">		 * &quot;state&quot; already reflects Clock mode 0a (CCR0 = 0xzzzzzz00).</span>
<span class="cm">		 * Nothing more to be done</span>
<span class="cm">		 */</span>
		<span class="n">brr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scc_writel</span><span class="p">(</span><span class="n">brr</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">BRR</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sync_serial_settings</span> <span class="n">__user</span> <span class="o">*</span><span class="n">line</span> <span class="o">=</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">ifs_ifsu</span><span class="p">.</span><span class="n">sync</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span> <span class="o">=</span> <span class="n">dscc4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">SIOCWANDEV</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IF_GET_IFACE</span>:
		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">IF_IFACE_SYNC_SERIAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">size</span><span class="p">;</span> <span class="cm">/* data size wanted */</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOBUFS</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IF_IFACE_SYNC_SERIAL</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FakeReset</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;please reset the device before this command</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dscc4_set_iface</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">hdlc_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_match</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">thingie</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">define</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">define</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">define</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_clock_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sync_serial_settings</span> <span class="o">*</span><span class="n">settings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bps</span><span class="p">,</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">bps</span> <span class="o">=</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">clock_rate</span><span class="p">;</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">scc_readl</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">CCR0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dscc4_set_clock</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bps</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bps</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* DCE */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: generated RxClk (DCE)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">clock_rate</span> <span class="o">!=</span> <span class="n">bps</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: clock adjusted (%08d -&gt; %08d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">settings</span><span class="o">-&gt;</span><span class="n">clock_rate</span><span class="p">,</span> <span class="n">bps</span><span class="p">);</span>
			<span class="n">settings</span><span class="o">-&gt;</span><span class="n">clock_rate</span> <span class="o">=</span> <span class="n">bps</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* DTE */</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="n">PowerUp</span> <span class="o">|</span> <span class="n">Vis</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: external RxClk (DTE)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">scc_writel</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR0</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">done:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_encoding_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">thingie</span> <span class="n">encoding</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">ENCODING_NRZ</span><span class="p">,</span>		<span class="mh">0x00000000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ENCODING_NRZI</span><span class="p">,</span>	<span class="mh">0x00200000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ENCODING_FM_MARK</span><span class="p">,</span>	<span class="mh">0x00400000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ENCODING_FM_SPACE</span><span class="p">,</span>	<span class="mh">0x00500000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">ENCODING_MANCHESTER</span><span class="p">,</span>	<span class="mh">0x00600000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>			<span class="mi">0</span><span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">dscc4_match</span><span class="p">(</span><span class="n">encoding</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">encoding</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">scc_patchl</span><span class="p">(</span><span class="n">EncodingMask</span><span class="p">,</span> <span class="n">encoding</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bits</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_loopback_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sync_serial_settings</span> <span class="o">*</span><span class="n">settings</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">settings</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">scc_readl</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">CCR1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">settings</span><span class="o">-&gt;</span><span class="n">loopback</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: loopback</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">state</span> <span class="o">|=</span> <span class="mh">0x00000100</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: normal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x00000100</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">scc_writel</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_crc_setting</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">thingie</span> <span class="n">crc</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">PARITY_CRC16_PR0_CCITT</span><span class="p">,</span>	<span class="mh">0x00000010</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PARITY_CRC16_PR1_CCITT</span><span class="p">,</span>	<span class="mh">0x00000000</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PARITY_CRC32_PR0_CCITT</span><span class="p">,</span>	<span class="mh">0x00000011</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">PARITY_CRC32_PR1_CCITT</span><span class="p">,</span>	<span class="mh">0x00000001</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">dscc4_match</span><span class="p">(</span><span class="n">crc</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">parity</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">scc_patchl</span><span class="p">(</span><span class="n">CrcMask</span><span class="p">,</span> <span class="n">crc</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bits</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_set_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">action</span><span class="p">)(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">);</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">do_setting</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">{</span> <span class="n">dscc4_encoding_setting</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">dscc4_clock_setting</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">dscc4_loopback_setting</span> <span class="p">},</span>
		<span class="p">{</span> <span class="n">dscc4_crc_setting</span> <span class="p">},</span>
		<span class="p">{</span> <span class="nb">NULL</span> <span class="p">}</span>
	<span class="p">};</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">p</span> <span class="o">=</span> <span class="n">do_setting</span><span class="p">;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">;</span> <span class="n">p</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">dscc4_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">token</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">root</span> <span class="o">=</span> <span class="n">token</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dscc4_pci_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">pci_priv</span><span class="p">;</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">dscc4_to_dev</span><span class="p">(</span><span class="n">root</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">state</span> <span class="o">=</span> <span class="n">readl</span><span class="p">(</span><span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GSTAR</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: GSTAR = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="n">writel</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">GSTAR</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Arf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failure (Arf). Harass the maintainer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ArAck</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Cfg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: CfgIV</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">iqcfg</span><span class="p">[</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">cfg_cur</span><span class="o">++%</span><span class="n">IRQ_RING_SIZE</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">Arf</span><span class="p">))</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CFG failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Cfg</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">RxEvt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">dev_per_card</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">dscc4_rx_irq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">root</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">RxEvt</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">TxEvt</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">dev_per_card</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">dscc4_tx_irq</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">root</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TxEvt</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dscc4_tx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_pci_priv</span> <span class="o">*</span><span class="n">ppriv</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dscc4_to_dev</span><span class="p">(</span><span class="n">dpriv</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur</span><span class="p">,</span> <span class="n">loop</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">try:</span>
	<span class="n">cur</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqtx_current</span><span class="o">%</span><span class="n">IRQ_RING_SIZE</span><span class="p">;</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqtx</span><span class="p">[</span><span class="n">cur</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Tx ISR = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">state</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">loop</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Tx irq loop=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">loop</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">loop</span> <span class="o">&amp;&amp;</span> <span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_current</span> <span class="o">-</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_dirty</span><span class="p">)</span><span class="o">%</span><span class="n">TX_RING_SIZE</span><span class="p">)</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">dscc4_tx_quiescent</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="o">!</span><span class="n">dscc4_tx_done</span><span class="p">(</span><span class="n">dpriv</span><span class="p">))</span>
				<span class="n">dscc4_do_tx</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">loop</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqtx</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqtx_current</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state_check</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tx&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SccEvt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Alls</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
			<span class="k">struct</span> <span class="n">TxFD</span> <span class="o">*</span><span class="n">tx_fd</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
				<span class="n">dscc4_tx_print</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="s">&quot;Alls&quot;</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * DataComplete can&#39;t be trusted for Tx completion.</span>
<span class="cm">			 * Cf errata DS5 p.8</span>
<span class="cm">			 */</span>
			<span class="n">cur</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_dirty</span><span class="o">%</span><span class="n">TX_RING_SIZE</span><span class="p">;</span>
			<span class="n">tx_fd</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_fd</span> <span class="o">+</span> <span class="n">cur</span><span class="p">;</span>
			<span class="n">skb</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">cur</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pci_unmap_single</span><span class="p">(</span><span class="n">ppriv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span>
						 <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span> <span class="n">PCI_DMA_TODEVICE</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FrameEnd</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
				<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="o">++</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_dirty</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
					<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tx: NULL skb %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						   <span class="n">cur</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * If the driver ends sending crap on the wire, it</span>
<span class="cm">			 * will be way easier to diagnose than the (not so)</span>
<span class="cm">			 * random freeze induced by null sized tx frames.</span>
<span class="cm">			 */</span>
			<span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FrameEnd</span> <span class="o">|</span> <span class="n">TO_STATE_TX</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">DUMMY_SKB_SIZE</span><span class="p">);</span>
			<span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
			<span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">jiffies</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Alls</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Transmit Data Underrun</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Xdu</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tx Data Underrun. Ask maintainer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="n">NeedIDT</span><span class="p">;</span>
			<span class="cm">/* Tx reset */</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">MTFi</span> <span class="o">|</span> <span class="n">Rdt</span><span class="p">,</span>
			       <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="o">*</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">dev_id</span> <span class="o">+</span> <span class="n">CH0CFG</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">Action</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">GCMDR</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Cts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CTS transition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Cts</span><span class="p">))</span> <span class="cm">/* DEBUG */</span>
				<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Xmr</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Frame needs to be sent again - FIXME */</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tx ReTx. Ask maintainer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Xmr</span><span class="p">))</span> <span class="cm">/* DEBUG */</span>
				<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Xpr</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scc_addr</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ring</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * - the busy condition happens (sometimes);</span>
<span class="cm">			 * - it doesn&#39;t seem to make the handler unreliable.</span>
<span class="cm">			 */</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">scc_readl_star</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">SccBusy</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i</span><span class="p">)</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;busy in irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">scc_addr</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="o">*</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">;</span>
			<span class="cm">/* Keep this order: IDT before IDR */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NeedIDT</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span>
					<span class="n">dscc4_tx_print</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="s">&quot;Xpr&quot;</span><span class="p">);</span>
				<span class="n">ring</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_fd_dma</span> <span class="o">+</span>
				       <span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_dirty</span><span class="o">%</span><span class="n">TX_RING_SIZE</span><span class="p">)</span><span class="o">*</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">TxFD</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">scc_addr</span> <span class="o">+</span> <span class="n">CH0BTDA</span><span class="p">);</span>
				<span class="n">dscc4_do_tx</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">MTFi</span> <span class="o">|</span> <span class="n">Idt</span><span class="p">,</span> <span class="n">scc_addr</span> <span class="o">+</span> <span class="n">CH0CFG</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dscc4_do_action</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IDT&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err_xpr</span><span class="p">;</span>
				<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NeedIDT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">NeedIDR</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ring</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_fd_dma</span> <span class="o">+</span>
				       <span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_current</span><span class="o">%</span><span class="n">RX_RING_SIZE</span><span class="p">)</span><span class="o">*</span>
				       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxFD</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">ring</span><span class="p">,</span> <span class="n">scc_addr</span> <span class="o">+</span> <span class="n">CH0BRDA</span><span class="p">);</span>
				<span class="n">dscc4_rx_update</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
				<span class="n">writel</span><span class="p">(</span><span class="n">MTFi</span> <span class="o">|</span> <span class="n">Idr</span><span class="p">,</span> <span class="n">scc_addr</span> <span class="o">+</span> <span class="n">CH0CFG</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dscc4_do_action</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IDR&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">err_xpr</span><span class="p">;</span>
				<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">NeedIDR</span><span class="p">;</span>
				<span class="n">smp_wmb</span><span class="p">();</span>
				<span class="cm">/* Activate receiver and misc */</span>
				<span class="n">scc_writel</span><span class="p">(</span><span class="mh">0x08050008</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR2</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="nl">err_xpr:</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Xpr</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Cd</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CD transition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Cd</span><span class="p">))</span> <span class="cm">/* DEBUG */</span>
				<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* ! SccEvt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Hi</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DSCC4_POLLING</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">dscc4_tx_poll</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">));</span>
<span class="cp">#endif</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tx Hi</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Hi</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Tx ERR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dscc4_rx_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_pci_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dscc4_to_dev</span><span class="p">(</span><span class="n">dpriv</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cur</span><span class="p">;</span>

<span class="nl">try:</span>
	<span class="n">cur</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqrx_current</span><span class="o">%</span><span class="n">IRQ_RING_SIZE</span><span class="p">;</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqrx</span><span class="p">[</span><span class="n">cur</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqrx</span><span class="p">[</span><span class="n">cur</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqrx_current</span><span class="o">++</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state_check</span><span class="p">(</span><span class="n">state</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Rx&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SccEvt</span><span class="p">)){</span>
		<span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="n">rx_fd</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Rx ISR = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			       <span class="n">state</span><span class="p">);</span>
		<span class="n">state</span> <span class="o">&amp;=</span> <span class="mh">0x00ffffff</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Err</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Hold or reset */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Rx ERR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">cur</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_current</span><span class="o">%</span><span class="n">RX_RING_SIZE</span><span class="p">;</span>
			<span class="n">rx_fd</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_fd</span> <span class="o">+</span> <span class="n">cur</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Presume we&#39;re not facing a DMAC receiver reset.</span>
<span class="cm">			 * As We use the rx size-filtering feature of the</span>
<span class="cm">			 * DSCC4, the beginning of a new frame is waiting in</span>
<span class="cm">			 * the rx fifo. I bet a Receive Data Overflow will</span>
<span class="cm">			 * happen most of time but let&#39;s try and avoid it.</span>
<span class="cm">			 * Btw (as for RDO) if one experiences ERR whereas</span>
<span class="cm">			 * the system looks rather idle, there may be a</span>
<span class="cm">			 * problem with latency. In this case, increasing</span>
<span class="cm">			 * RX_RING_SIZE may help.</span>
<span class="cm">			 */</span></pre></div></td></tr>


<tr id="section-7"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-7">&#182;</a></div><p>while (dpriv->rx<em>needs</em>refill) {</p></td><td class="code"><div class="highlight"><pre>				<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">state1</span> <span class="o">&amp;</span> <span class="n">Hold</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">rx_fd</span><span class="o">++</span><span class="p">;</span>
					<span class="n">cur</span><span class="o">++</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cur</span> <span class="o">=</span> <span class="n">cur</span><span class="o">%</span><span class="n">RX_RING_SIZE</span><span class="p">))</span>
						<span class="n">rx_fd</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_fd</span><span class="p">;</span>
				<span class="p">}</span></pre></div></td></tr>


<tr id="section-8"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-8">&#182;</a></div><p>dpriv->rx<em>needs</em>refill--;</p></td><td class="code"><div class="highlight"><pre>				<span class="n">try_get_rx_skb</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
				<span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">state1</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Hold</span><span class="p">;</span>
				<span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">state2</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
				<span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xbabeface</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-9"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-9">&#182;</a></div><p>}</p></td><td class="code"><div class="highlight"><pre>			<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Fi</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dscc4_rx_skb</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Hi</span> <span class="p">)</span> <span class="p">{</span> <span class="cm">/* HI bit */</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Rx Hi</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Hi</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* SccEvt */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span></pre></div></td></tr>


<tr id="section-10"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-10">&#182;</a></div><p>FIXME: verifier la presence de tous les evenements</p></td><td class="code"><div class="highlight"><pre>		<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
			<span class="n">u32</span> <span class="n">mask</span><span class="p">;</span>
			<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">irq_name</span><span class="p">;</span>
		<span class="p">}</span> <span class="n">evts</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
			<span class="p">{</span> <span class="mh">0x00008000</span><span class="p">,</span> <span class="s">&quot;TIN&quot;</span><span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x00000020</span><span class="p">,</span> <span class="s">&quot;RSC&quot;</span><span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x00000010</span><span class="p">,</span> <span class="s">&quot;PCE&quot;</span><span class="p">},</span>
			<span class="p">{</span> <span class="mh">0x00000008</span><span class="p">,</span> <span class="s">&quot;PLLA&quot;</span><span class="p">},</span>
			<span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">}</span>
		<span class="p">},</span> <span class="o">*</span><span class="n">evt</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">evt</span> <span class="o">=</span> <span class="n">evts</span><span class="p">;</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">;</span> <span class="n">evt</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">evt</span><span class="o">-&gt;</span><span class="n">irq_name</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">evt</span><span class="o">-&gt;</span><span class="n">mask</span><span class="p">))</span>
					<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0000c03c</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Cts</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CTS transition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Cts</span><span class="p">))</span> <span class="cm">/* DEBUG */</span>
				<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Receive Data Overflow (FIXME: fscked)</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Rdo</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="n">rx_fd</span><span class="p">;</span>
			<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">scc_addr</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">cur</span><span class="p">;</span></pre></div></td></tr>


<tr id="section-11"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-11">&#182;</a></div><p>if (debug)
dscc4<em>rx</em>dump(dpriv);</p></td><td class="code"><div class="highlight"><pre>			<span class="n">scc_addr</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mh">0x0c</span><span class="o">*</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">dev_id</span><span class="p">;</span>

			<span class="n">scc_patchl</span><span class="p">(</span><span class="n">RxActivate</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR2</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * This has no effect. Why ?</span>
<span class="cm">			 * ORed with TxSccRes, one sees the CFG ack (for</span>
<span class="cm">			 * the TX part only).</span>
<span class="cm">			 */</span>
			<span class="n">scc_writel</span><span class="p">(</span><span class="n">RxSccRes</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CMDR</span><span class="p">);</span>
			<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">RdoSet</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Let&#39;s try and save something in the received data.</span>
<span class="cm">			 * rx_current must be incremented at least once to</span>
<span class="cm">			 * avoid HOLD in the BRDA-to-be-pointed desc.</span>
<span class="cm">			 */</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">cur</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_current</span><span class="o">++%</span><span class="n">RX_RING_SIZE</span><span class="p">;</span>
				<span class="n">rx_fd</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_fd</span> <span class="o">+</span> <span class="n">cur</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">state2</span> <span class="o">&amp;</span> <span class="n">DataComplete</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">state2</span> <span class="o">&amp;</span> <span class="n">FrameAborted</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
					<span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">state1</span> <span class="o">|=</span> <span class="n">Hold</span><span class="p">;</span>
					<span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">state2</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
					<span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xbabeface</span><span class="p">);</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">dscc4_rx_skb</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">RdoSet</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span>
					       <span class="s">&quot;%s: no RDO in Rx data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#ifdef DSCC4_RDO_EXPERIMENTAL_RECOVERY</span>
			<span class="cm">/*</span>
<span class="cm">			 * FIXME: must the reset be this violent ?</span>
<span class="cm">			 */</span>
<span class="cp">#warning &quot;FIXME: CH0BRDA&quot;</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_fd_dma</span> <span class="o">+</span>
			       <span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_current</span><span class="o">%</span><span class="n">RX_RING_SIZE</span><span class="p">)</span><span class="o">*</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">RxFD</span><span class="p">),</span> <span class="n">scc_addr</span> <span class="o">+</span> <span class="n">CH0BRDA</span><span class="p">);</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">MTFi</span><span class="o">|</span><span class="n">Rdr</span><span class="o">|</span><span class="n">Idr</span><span class="p">,</span> <span class="n">scc_addr</span> <span class="o">+</span> <span class="n">CH0CFG</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dscc4_do_action</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RDR&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RDO recovery failed(RDR)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">rdo_end</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">writel</span><span class="p">(</span><span class="n">MTFi</span><span class="o">|</span><span class="n">Idr</span><span class="p">,</span> <span class="n">scc_addr</span> <span class="o">+</span> <span class="n">CH0CFG</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dscc4_do_action</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IDR&quot;</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;RDO recovery failed(IDR)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">rdo_end</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="nl">rdo_end:</span>
<span class="cp">#endif</span>
			<span class="n">scc_patchl</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">RxActivate</span><span class="p">,</span> <span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">CCR2</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Cd</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CD transition</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Cd</span><span class="p">))</span> <span class="cm">/* DEBUG */</span>
				<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">Flex</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;%s: Flex. Ttttt...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">Flex</span><span class="p">))</span>
				<span class="k">goto</span> <span class="n">try</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * I had expected the following to work for the first descriptor</span>
<span class="cm"> * (tx_fd-&gt;state = 0xc0000000)</span>
<span class="cm"> * - Hold=1 (don&#39;t try and branch to the next descripto);</span>
<span class="cm"> * - No=0 (I want an empty data section, i.e. size=0);</span>
<span class="cm"> * - Fe=1 (required by No=0 or we got an Err irq and must reset).</span>
<span class="cm"> * It failed and locked solid. Thus the introduction of a dummy skb.</span>
<span class="cm"> * Problem is acknowledged in errata sheet DS5. Joy :o/</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">dscc4_init_dummy_skb</span><span class="p">(</span><span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">DUMMY_SKB_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">last</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_dirty</span><span class="o">%</span><span class="n">TX_RING_SIZE</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">TxFD</span> <span class="o">*</span><span class="n">tx_fd</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_fd</span> <span class="o">+</span> <span class="n">last</span><span class="p">;</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">=</span> <span class="n">DUMMY_SKB_SIZE</span><span class="p">;</span>
		<span class="n">skb_copy_to_linear_data</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">version</span><span class="p">,</span>
					<span class="n">strlen</span><span class="p">(</span><span class="n">version</span><span class="p">)</span> <span class="o">%</span> <span class="n">DUMMY_SKB_SIZE</span><span class="p">);</span>
		<span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FrameEnd</span> <span class="o">|</span> <span class="n">TO_STATE_TX</span><span class="p">(</span><span class="n">DUMMY_SKB_SIZE</span><span class="p">);</span>
		<span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">pci_map_single</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">pci_priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span>
					     <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">DUMMY_SKB_SIZE</span><span class="p">,</span>
					     <span class="n">PCI_DMA_TODEVICE</span><span class="p">));</span>
		<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">[</span><span class="n">last</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_init_ring</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span> <span class="o">=</span> <span class="n">dscc4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">pci_priv</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">TxFD</span> <span class="o">*</span><span class="n">tx_fd</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="n">rx_fd</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">ring</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_TOTAL_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_fd_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_fd</span> <span class="o">=</span> <span class="n">rx_fd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">RxFD</span> <span class="o">*</span><span class="p">)</span> <span class="n">ring</span><span class="p">;</span>

	<span class="n">ring</span> <span class="o">=</span> <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_TOTAL_SIZE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_fd_dma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ring</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free_dma_rx</span><span class="p">;</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_fd</span> <span class="o">=</span> <span class="n">tx_fd</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">TxFD</span> <span class="o">*</span><span class="p">)</span> <span class="n">ring</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_skbuff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">TX_RING_SIZE</span><span class="p">);</span>
	<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_dirty</span> <span class="o">=</span> <span class="mh">0xffffffff</span><span class="p">;</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FrameEnd</span> <span class="o">|</span> <span class="n">TO_STATE_TX</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">DUMMY_SKB_SIZE</span><span class="p">);</span>
		<span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	        <span class="cm">/* FIXME: NULL should be ok - to be tried */</span>
	        <span class="n">tx_fd</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_fd_dma</span><span class="p">);</span>
		<span class="p">(</span><span class="n">tx_fd</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_fd_dma</span> <span class="o">+</span>
					<span class="p">(</span><span class="o">++</span><span class="n">i</span><span class="o">%</span><span class="n">TX_RING_SIZE</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tx_fd</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">TX_RING_SIZE</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dscc4_init_dummy_skb</span><span class="p">(</span><span class="n">dpriv</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_free_dma_tx</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_skbuff</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="n">RX_RING_SIZE</span><span class="p">);</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_dirty</span> <span class="o">=</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_current</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* size set by the host. Multiple of 4 bytes please */</span>
	        <span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">state1</span> <span class="o">=</span> <span class="n">HiDesc</span><span class="p">;</span>
	        <span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">state2</span> <span class="o">=</span> <span class="mh">0x00000000</span><span class="p">;</span>
	        <span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="mh">0xbabeface</span><span class="p">);</span>
	        <span class="n">rx_fd</span><span class="o">-&gt;</span><span class="n">state1</span> <span class="o">|=</span> <span class="n">TO_STATE_RX</span><span class="p">(</span><span class="n">HDLC_MAX_MRU</span><span class="p">);</span></pre></div></td></tr>


<tr id="section-12"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-12">&#182;</a></div><p>FIXME: return value verifiee mais traitement suspect</p></td><td class="code"><div class="highlight"><pre>		<span class="k">if</span> <span class="p">(</span><span class="n">try_get_rx_skb</span><span class="p">(</span><span class="n">dpriv</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_dirty</span><span class="o">++</span><span class="p">;</span>
		<span class="p">(</span><span class="n">rx_fd</span><span class="o">++</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_fd_dma</span> <span class="o">+</span>
					<span class="p">(</span><span class="o">++</span><span class="n">i</span><span class="o">%</span><span class="n">RX_RING_SIZE</span><span class="p">)</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rx_fd</span><span class="p">));</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">RX_RING_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err_free_dma_tx:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">TX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">ring</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">tx_fd_dma</span><span class="p">);</span>
<span class="nl">err_free_dma_rx:</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">RX_TOTAL_SIZE</span><span class="p">,</span> <span class="n">rx_fd</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">rx_fd_dma</span><span class="p">);</span>
<span class="nl">err_out:</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">dscc4_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dscc4_pci_priv</span> <span class="o">*</span><span class="n">ppriv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">root</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ppriv</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">root</span> <span class="o">=</span> <span class="n">ppriv</span><span class="o">-&gt;</span><span class="n">root</span><span class="p">;</span>

	<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">root</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">dscc4_pci_reset</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">root</span><span class="p">);</span>
	<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IRQ_RING_SIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span> <span class="n">ppriv</span><span class="o">-&gt;</span><span class="n">iqcfg</span><span class="p">,</span>
			    <span class="n">ppriv</span><span class="o">-&gt;</span><span class="n">iqcfg_dma</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dev_per_card</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span> <span class="o">=</span> <span class="n">root</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>

		<span class="n">dscc4_release_ring</span><span class="p">(</span><span class="n">dpriv</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IRQ_RING_SIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
				    <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqrx</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqrx_dma</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IRQ_RING_SIZE</span><span class="o">*</span><span class="k">sizeof</span><span class="p">(</span><span class="n">u32</span><span class="p">),</span>
				    <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqtx</span><span class="p">,</span> <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">iqtx_dma</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">dscc4_free1</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">ioaddr</span><span class="p">);</span>

	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">pci_release_region</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dscc4_hdlc_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">encoding</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">parity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">dscc4_dev_priv</span> <span class="o">*</span><span class="n">dpriv</span> <span class="o">=</span> <span class="n">dscc4_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">encoding</span> <span class="o">!=</span> <span class="n">ENCODING_NRZ</span> <span class="o">&amp;&amp;</span>
	    <span class="n">encoding</span> <span class="o">!=</span> <span class="n">ENCODING_NRZI</span> <span class="o">&amp;&amp;</span>
	    <span class="n">encoding</span> <span class="o">!=</span> <span class="n">ENCODING_FM_MARK</span> <span class="o">&amp;&amp;</span>
	    <span class="n">encoding</span> <span class="o">!=</span> <span class="n">ENCODING_FM_SPACE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">encoding</span> <span class="o">!=</span> <span class="n">ENCODING_MANCHESTER</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parity</span> <span class="o">!=</span> <span class="n">PARITY_NONE</span> <span class="o">&amp;&amp;</span>
	    <span class="n">parity</span> <span class="o">!=</span> <span class="n">PARITY_CRC16_PR0_CCITT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">parity</span> <span class="o">!=</span> <span class="n">PARITY_CRC16_PR1_CCITT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">parity</span> <span class="o">!=</span> <span class="n">PARITY_CRC32_PR0_CCITT</span> <span class="o">&amp;&amp;</span>
	    <span class="n">parity</span> <span class="o">!=</span> <span class="n">PARITY_CRC32_PR1_CCITT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

        <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span><span class="p">;</span>
        <span class="n">dpriv</span><span class="o">-&gt;</span><span class="n">parity</span> <span class="o">=</span> <span class="n">parity</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">dscc4_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="o">*</span><span class="n">args</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">debug</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">quartz</span><span class="p">,</span> <span class="nb">NULL</span> <span class="p">},</span> <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="n">args</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">get_option</span><span class="p">(</span><span class="o">&amp;</span><span class="n">str</span><span class="p">,</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">p</span><span class="o">++</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;dscc4.setup=&quot;</span><span class="p">,</span> <span class="n">dscc4_setup</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">dscc4_pci_tbl</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VENDOR_ID_SIEMENS</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_SIEMENS_DSCC4</span><span class="p">,</span>
	        <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">0</span><span class="p">,}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">dscc4_pci_tbl</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">dscc4_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">dscc4_pci_tbl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">dscc4_init_one</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">dscc4_remove_one</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_pci_driver</span><span class="p">(</span><span class="n">dscc4_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
