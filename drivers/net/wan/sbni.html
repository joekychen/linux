<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wan › sbni.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>sbni.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/* sbni.c:  Granch SBNI12 leased line adapters driver for linux</span>
<span class="cm"> *</span>
<span class="cm"> *	Written 2001 by Denis I.Timofeev (timofeev@granch.ru)</span>
<span class="cm"> *</span>
<span class="cm"> *	Previous versions were written by Yaroslav Polyakov,</span>
<span class="cm"> *	Alexey Zverev and Max Khon.</span>
<span class="cm"> *</span>
<span class="cm"> *	Driver supports SBNI12-02,-04,-05,-10,-11 cards, single and</span>
<span class="cm"> *	double-channel, PCI and ISA modifications.</span>
<span class="cm"> *	More info and useful utilities to work with SBNI12 cards you can find</span>
<span class="cm"> *	at http://www.granch.com (English) or http://www.granch.ru (Russian)</span>
<span class="cm"> *</span>
<span class="cm"> *	This software may be used and distributed according to the terms</span>
<span class="cm"> *	of the GNU General Public License.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *  5.0.1	Jun 22 2001</span>
<span class="cm"> *	  - Fixed bug in probe</span>
<span class="cm"> *  5.0.0	Jun 06 2001</span>
<span class="cm"> *	  - Driver was completely redesigned by Denis I.Timofeev,</span>
<span class="cm"> *	  - now PCI/Dual, ISA/Dual (with single interrupt line) models are</span>
<span class="cm"> *	  - supported</span>
<span class="cm"> *  3.3.0	Thu Feb 24 21:30:28 NOVT 2000 </span>
<span class="cm"> *        - PCI cards support</span>
<span class="cm"> *  3.2.0	Mon Dec 13 22:26:53 NOVT 1999</span>
<span class="cm"> * 	  - Completely rebuilt all the packet storage system</span>
<span class="cm"> * 	  -    to work in Ethernet-like style.</span>
<span class="cm"> *  3.1.1	just fixed some bugs (5 aug 1999)</span>
<span class="cm"> *  3.1.0	added balancing feature	(26 apr 1999)</span>
<span class="cm"> *  3.0.1	just fixed some bugs (14 apr 1999).</span>
<span class="cm"> *  3.0.0	Initial Revision, Yaroslav Polyakov (24 Feb 1999)</span>
<span class="cm"> *        - added pre-calculation for CRC, fixed bug with &quot;len-2&quot; frames, </span>
<span class="cm"> *        - removed outbound fragmentation (MTU=1000), written CRC-calculation </span>
<span class="cm"> *        - on asm, added work with hard_headers and now we have our own cache </span>
<span class="cm"> *        - for them, optionally supported word-interchange on some chipsets,</span>
<span class="cm"> * </span>
<span class="cm"> *	Known problem: this driver wasn&#39;t tested on multiprocessor machine.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/etherdevice.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;net/net_namespace.h&gt;</span>
<span class="cp">#include &lt;net/arp.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/types.h&gt;</span>
<span class="cp">#include &lt;asm/byteorder.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;sbni.h&quot;</span>

<span class="cm">/* device private data */</span>

<span class="k">struct</span> <span class="n">net_local</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">watchdog</span><span class="p">;</span>

	<span class="n">spinlock_t</span>	<span class="n">lock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>  <span class="o">*</span><span class="n">rx_buf_p</span><span class="p">;</span>		<span class="cm">/* receive buffer ptr */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>  <span class="o">*</span><span class="n">tx_buf_p</span><span class="p">;</span>		<span class="cm">/* transmit buffer ptr */</span>
	
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">framelen</span><span class="p">;</span>		<span class="cm">/* current frame length */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">maxframe</span><span class="p">;</span>		<span class="cm">/* maximum valid frame length */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">inppos</span><span class="p">,</span> <span class="n">outpos</span><span class="p">;</span>		<span class="cm">/* positions in rx/tx buffers */</span>

	<span class="cm">/* transmitting frame number - from frames qty to 1 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tx_frameno</span><span class="p">;</span>

	<span class="cm">/* expected number of next receiving frame */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">wait_frameno</span><span class="p">;</span>

	<span class="cm">/* count of failed attempts to frame send - 32 attempts do before</span>
<span class="cm">	   error - while receiver tunes on opposite side of wire */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">trans_errors</span><span class="p">;</span>

	<span class="cm">/* idle time; send pong when limit exceeded */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">timer_ticks</span><span class="p">;</span>

	<span class="cm">/* fields used for receive level autoselection */</span>
	<span class="kt">int</span>	<span class="n">delta_rxl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">cur_rxl_index</span><span class="p">,</span> <span class="n">timeout_rxl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">cur_rxl_rcvd</span><span class="p">,</span> <span class="n">prev_rxl_rcvd</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">sbni_csr1</span>	<span class="n">csr1</span><span class="p">;</span>		<span class="cm">/* current value of CSR1 */</span>
	<span class="k">struct</span> <span class="n">sbni_in_stats</span>	<span class="n">in_stats</span><span class="p">;</span> 	<span class="cm">/* internal statistics */</span> 

	<span class="k">struct</span> <span class="n">net_device</span>		<span class="o">*</span><span class="n">second</span><span class="p">;</span>	<span class="cm">/* for ISA/dual cards */</span>

<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
	<span class="k">struct</span> <span class="n">net_device</span>		<span class="o">*</span><span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span>		<span class="o">*</span><span class="n">link</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span>  <span class="n">sbni_card_probe</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">sbni_pci_probe</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">sbni_probe1</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">sbni_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">sbni_close</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">sbni_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">sbni_ioctl</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">set_multicast_list</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">sbni_interrupt</span><span class="p">(</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">handle_channel</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>   <span class="n">recv_frame</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">send_frame</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>   <span class="n">upload_data</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span>
			  <span class="kt">unsigned</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">,</span> <span class="n">u32</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">download_data</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">sbni_watchdog</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">interpret_ack</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>   <span class="n">append_frame_to_pkt</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span><span class="p">,</span> <span class="n">u32</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">indicate_pkt</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">card_start</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">prepare_to_send</span><span class="p">(</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">drop_xmit_queue</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">send_frame_header</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>   <span class="n">skip_tail</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">u32</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>   <span class="n">check_fhdr</span><span class="p">(</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">change_level</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span>  <span class="n">timeout_change_level</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="n">u32</span>   <span class="n">calc_crc32</span><span class="p">(</span> <span class="n">u32</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="p">,</span> <span class="n">u32</span> <span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>  <span class="n">get_rx_buf</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">sbni_init</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>

<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">enslave</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">emancipate</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="p">);</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef __i386__</span>
<span class="cp">#define ASM_CRC 1</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span>  <span class="n">version</span><span class="p">[]</span> <span class="o">=</span>
	<span class="s">&quot;Granch SBNI12 driver ver 5.0.1  Jun 22 2001  Denis I.Timofeev.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">skip_pci_probe</span>	<span class="n">__initdata</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">scandone</span>	<span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span>  <span class="n">num</span>		<span class="n">__initdata</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">rxl_tab</span><span class="p">[];</span>
<span class="k">static</span> <span class="n">u32</span>  <span class="n">crc32tab</span><span class="p">[];</span>

<span class="cm">/* A list of all installed devices, for removing the driver module. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">sbni_cards</span><span class="p">[</span> <span class="n">SBNI_MAX_NUM_CARDS</span> <span class="p">];</span>

<span class="cm">/* Lists of device&#39;s parameters */</span>
<span class="k">static</span> <span class="n">u32</span>	<span class="n">io</span><span class="p">[</span>   <span class="n">SBNI_MAX_NUM_CARDS</span> <span class="p">]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">SBNI_MAX_NUM_CARDS</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="n">u32</span>	<span class="n">irq</span><span class="p">[</span>  <span class="n">SBNI_MAX_NUM_CARDS</span> <span class="p">]</span> <span class="n">__initdata</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span>	<span class="n">baud</span><span class="p">[</span> <span class="n">SBNI_MAX_NUM_CARDS</span> <span class="p">]</span> <span class="n">__initdata</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u32</span>	<span class="n">rxl</span><span class="p">[</span>  <span class="n">SBNI_MAX_NUM_CARDS</span> <span class="p">]</span> <span class="n">__initdata</span> <span class="o">=</span>
	<span class="p">{</span> <span class="p">[</span><span class="mi">0</span> <span class="p">...</span> <span class="n">SBNI_MAX_NUM_CARDS</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">};</span>
<span class="k">static</span> <span class="n">u32</span>	<span class="n">mac</span><span class="p">[</span>  <span class="n">SBNI_MAX_NUM_CARDS</span> <span class="p">]</span> <span class="n">__initdata</span><span class="p">;</span>

<span class="cp">#ifndef MODULE</span>
<span class="k">typedef</span> <span class="n">u32</span>  <span class="n">iarr</span><span class="p">[];</span>
<span class="k">static</span> <span class="n">iarr</span> <span class="n">__initdata</span> <span class="o">*</span><span class="n">dest</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="o">&amp;</span><span class="n">io</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">baud</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rxl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mac</span> <span class="p">};</span>
<span class="cp">#endif</span>

<span class="cm">/* A zero-terminated list of I/O addresses to be probed on ISA bus */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">netcard_portlist</span><span class="p">[</span> <span class="p">]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span> 
	<span class="mh">0x210</span><span class="p">,</span> <span class="mh">0x214</span><span class="p">,</span> <span class="mh">0x220</span><span class="p">,</span> <span class="mh">0x224</span><span class="p">,</span> <span class="mh">0x230</span><span class="p">,</span> <span class="mh">0x234</span><span class="p">,</span> <span class="mh">0x240</span><span class="p">,</span> <span class="mh">0x244</span><span class="p">,</span> <span class="mh">0x250</span><span class="p">,</span> <span class="mh">0x254</span><span class="p">,</span>
	<span class="mh">0x260</span><span class="p">,</span> <span class="mh">0x264</span><span class="p">,</span> <span class="mh">0x270</span><span class="p">,</span> <span class="mh">0x274</span><span class="p">,</span> <span class="mh">0x280</span><span class="p">,</span> <span class="mh">0x284</span><span class="p">,</span> <span class="mh">0x290</span><span class="p">,</span> <span class="mh">0x294</span><span class="p">,</span> <span class="mh">0x2a0</span><span class="p">,</span> <span class="mh">0x2a4</span><span class="p">,</span>
	<span class="mh">0x2b0</span><span class="p">,</span> <span class="mh">0x2b4</span><span class="p">,</span> <span class="mh">0x2c0</span><span class="p">,</span> <span class="mh">0x2c4</span><span class="p">,</span> <span class="mh">0x2d0</span><span class="p">,</span> <span class="mh">0x2d4</span><span class="p">,</span> <span class="mh">0x2e0</span><span class="p">,</span> <span class="mh">0x2e4</span><span class="p">,</span> <span class="mh">0x2f0</span><span class="p">,</span> <span class="mh">0x2f4</span><span class="p">,</span>
	<span class="mi">0</span> <span class="p">};</span>

<span class="cp">#define NET_LOCAL_LOCK(dev) (((struct net_local *)netdev_priv(dev))-&gt;lock)</span>

<span class="cm">/*</span>
<span class="cm"> * Look for SBNI card which addr stored in dev-&gt;base_addr, if nonzero.</span>
<span class="cm"> * Otherwise, look through PCI bus. If none PCI-card was found, scan ISA.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">sbni_isa_probe</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">&gt;</span> <span class="mh">0x1ff</span> <span class="o">&amp;&amp;</span>
	    <span class="n">request_region</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">SBNI_IO_EXTENT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">sbni_probe1</span><span class="p">(</span> <span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="p">)</span> <span class="p">)</span>

		<span class="k">return</span>  <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;base address 0x%lx is busy, or adapter is malfunctional!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">);</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">sbni_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>		<span class="o">=</span> <span class="n">sbni_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>		<span class="o">=</span> <span class="n">sbni_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>		<span class="o">=</span> <span class="n">sbni_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_rx_mode</span>	<span class="o">=</span> <span class="n">set_multicast_list</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>		<span class="o">=</span> <span class="n">sbni_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span>		<span class="o">=</span> <span class="n">eth_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_set_mac_address</span> 	<span class="o">=</span> <span class="n">eth_mac_addr</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_validate_addr</span>	<span class="o">=</span> <span class="n">eth_validate_addr</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">sbni_devsetup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ether_setup</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbni_netdev_ops</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">__init</span> <span class="nf">sbni_probe</span><span class="p">(</span><span class="kt">int</span> <span class="n">unit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span><span class="p">),</span> <span class="s">&quot;sbni&quot;</span><span class="p">,</span> <span class="n">sbni_devsetup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sbni_netdev_ops</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;sbni%d&quot;</span><span class="p">,</span> <span class="n">unit</span><span class="p">);</span>
	<span class="n">netdev_boot_setup_check</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sbni_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">register_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">SBNI_IO_EXTENT</span> <span class="p">);</span>
		<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pr_info_once</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sbni_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="p">)</span>
		<span class="k">return</span>  <span class="n">sbni_isa_probe</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
	<span class="cm">/* otherwise we have to perform search our adapter */</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">io</span><span class="p">[</span> <span class="n">num</span> <span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span>	<span class="o">=</span> <span class="n">io</span><span class="p">[</span> <span class="n">num</span> <span class="p">],</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span>	<span class="o">=</span> <span class="n">irq</span><span class="p">[</span> <span class="n">num</span> <span class="p">];</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">scandone</span>  <span class="o">||</span>  <span class="n">io</span><span class="p">[</span> <span class="mi">0</span> <span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* if io[ num ] contains non-zero address, then that is on ISA bus */</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="p">)</span>
		<span class="k">return</span>  <span class="n">sbni_isa_probe</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>

	<span class="cm">/* ...otherwise - scan PCI first */</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">skip_pci_probe</span>  <span class="o">&amp;&amp;</span>  <span class="o">!</span><span class="n">sbni_pci_probe</span><span class="p">(</span> <span class="n">dev</span> <span class="p">)</span> <span class="p">)</span>
		<span class="k">return</span>  <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">io</span><span class="p">[</span> <span class="n">num</span> <span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Auto-scan will be stopped when first ISA card were found */</span>
		<span class="n">scandone</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">num</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">)</span>
			<span class="k">return</span>  <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span><span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">netcard_portlist</span><span class="p">[</span> <span class="n">i</span> <span class="p">];</span>  <span class="o">++</span><span class="n">i</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>  <span class="n">ioaddr</span> <span class="o">=</span> <span class="n">netcard_portlist</span><span class="p">[</span> <span class="n">i</span> <span class="p">];</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">request_region</span><span class="p">(</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">SBNI_IO_EXTENT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">sbni_probe1</span><span class="p">(</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="mi">0</span> <span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span>  <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">sbni_pci_probe</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span>  <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span> <span class="p">(</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pci_get_class</span><span class="p">(</span> <span class="n">PCI_CLASS_NETWORK_OTHER</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">,</span> <span class="n">pdev</span> <span class="p">))</span>
	       <span class="o">!=</span> <span class="nb">NULL</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span>  <span class="n">pci_irq_line</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">pci_ioaddr</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">!=</span> <span class="n">SBNI_PCI_VENDOR</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">SBNI_PCI_DEVICE</span> <span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">pci_ioaddr</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span> <span class="n">pdev</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
		<span class="n">pci_irq_line</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

		<span class="cm">/* Avoid already found cards from previous calls */</span>
		<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">request_region</span><span class="p">(</span> <span class="n">pci_ioaddr</span><span class="p">,</span> <span class="n">SBNI_IO_EXTENT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">subsystem_device</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* Dual adapter is present */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">pci_ioaddr</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">,</span> <span class="n">SBNI_IO_EXTENT</span><span class="p">,</span>
							<span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="p">)</span> <span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_irq_line</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">pci_irq_line</span> <span class="o">&gt;=</span> <span class="n">nr_irqs</span><span class="p">)</span>
			<span class="n">pr_warn</span><span class="p">(</span>
<span class="s">&quot;WARNING: The PCI BIOS assigned this PCI card to IRQ %d, which is unlikely to work!.</span><span class="se">\n</span><span class="s">&quot;</span>
<span class="s">&quot;You should use the PCI BIOS setup to assign a valid IRQ line.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">pci_irq_line</span> <span class="p">);</span>

		<span class="cm">/* avoiding re-enable dual adapters */</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">pci_ioaddr</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>  <span class="o">&amp;&amp;</span>  <span class="n">pci_enable_device</span><span class="p">(</span> <span class="n">pdev</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span> <span class="n">pci_ioaddr</span><span class="p">,</span> <span class="n">SBNI_IO_EXTENT</span> <span class="p">);</span>
			<span class="n">pci_dev_put</span><span class="p">(</span> <span class="n">pdev</span> <span class="p">);</span>
			<span class="k">return</span>  <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">sbni_probe1</span><span class="p">(</span> <span class="n">dev</span><span class="p">,</span> <span class="n">pci_ioaddr</span><span class="p">,</span> <span class="n">pci_irq_line</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">SET_NETDEV_DEV</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
			<span class="cm">/* not the best thing to do, but this is all messed up </span>
<span class="cm">			   for hotplug systems anyway... */</span>
			<span class="n">pci_dev_put</span><span class="p">(</span> <span class="n">pdev</span> <span class="p">);</span>
			<span class="k">return</span>  <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span>  <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span> <span class="n">__init</span>
<span class="nf">sbni_probe1</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">,</span>  <span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">ioaddr</span><span class="p">,</span>  <span class="kt">int</span>  <span class="n">irq</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">sbni_card_probe</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">release_region</span><span class="p">(</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">SBNI_IO_EXTENT</span> <span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_mask</span><span class="p">;</span>

		<span class="n">irq_mask</span> <span class="o">=</span> <span class="n">probe_irq_on</span><span class="p">();</span>
		<span class="n">outb</span><span class="p">(</span> <span class="n">EN_INT</span> <span class="o">|</span> <span class="n">TR_REQ</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span> <span class="n">PR_RES</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR1</span> <span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="n">probe_irq_off</span><span class="p">(</span><span class="n">irq_mask</span><span class="p">);</span>
		<span class="n">outb</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>

		<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">irq</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: can&#39;t detect device irq!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">release_region</span><span class="p">(</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">SBNI_IO_EXTENT</span> <span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">irq</span> <span class="o">==</span> <span class="mi">2</span> <span class="p">)</span>
		<span class="n">irq</span> <span class="o">=</span> <span class="mi">9</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">=</span> <span class="n">ioaddr</span><span class="p">;</span>

	<span class="cm">/* Fill in sbni-specific dev fields. */</span>
	<span class="n">nl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">nl</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: unable to get memory!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">release_region</span><span class="p">(</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">SBNI_IO_EXTENT</span> <span class="p">);</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memset</span><span class="p">(</span> <span class="n">nl</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">spin_lock_init</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>

	<span class="cm">/* store MAC address (generate if that isn&#39;t known) */</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be16</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span> <span class="mh">0x00ff</span> <span class="p">);</span>
	<span class="o">*</span><span class="p">(</span><span class="n">__be32</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="o">=</span> <span class="n">htonl</span><span class="p">(</span> <span class="mh">0x01000000</span> <span class="o">|</span>
		<span class="p">((</span><span class="n">mac</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">?</span>
		<span class="n">mac</span><span class="p">[</span><span class="n">num</span><span class="p">]</span> <span class="o">:</span>
		<span class="p">(</span><span class="n">u32</span><span class="p">)((</span><span class="kt">long</span><span class="p">)</span><span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">)))</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">));</span>

	<span class="cm">/* store link settings (speed, receive level ) */</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">maxframe</span>  <span class="o">=</span> <span class="n">DEFAULT_FRAME_LEN</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">csr1</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">baud</span><span class="p">[</span> <span class="n">num</span> <span class="p">];</span>

	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_index</span> <span class="o">=</span> <span class="n">rxl</span><span class="p">[</span> <span class="n">num</span> <span class="p">])</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span> <span class="p">)</span>
		<span class="cm">/* autotune rxl */</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_index</span> <span class="o">=</span> <span class="n">DEF_RXL</span><span class="p">,</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">delta_rxl</span> <span class="o">=</span> <span class="n">DEF_RXL_DELTA</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">delta_rxl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">csr1</span><span class="p">.</span><span class="n">rxl</span>  <span class="o">=</span> <span class="n">rxl_tab</span><span class="p">[</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_index</span> <span class="p">];</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span> <span class="p">)</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">FL_SLOW_MODE</span><span class="p">;</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s: ioaddr %#lx, irq %d, MAC: 00:ff:01:%02x:%02x:%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span>
		  <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="mi">3</span><span class="p">],</span>
		  <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="mi">4</span><span class="p">],</span>
		  <span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span><span class="p">)[</span><span class="mi">5</span><span class="p">]);</span>

	<span class="n">pr_notice</span><span class="p">(</span><span class="s">&quot;%s: speed %d&quot;</span><span class="p">,</span>
		  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		  <span class="p">((</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_SLOW_MODE</span><span class="p">)</span> <span class="o">?</span> <span class="mi">500000</span> <span class="o">:</span> <span class="mi">2000000</span><span class="p">)</span>
		  <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">csr1</span><span class="p">.</span><span class="n">rate</span><span class="p">));</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">delta_rxl</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;, receive level 0x%x (fixed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_index</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_cont</span><span class="p">(</span><span class="s">&quot;, receive level (auto)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">link</span>   <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="cp">#endif</span>
   
	<span class="n">sbni_cards</span><span class="p">[</span> <span class="n">num</span><span class="o">++</span> <span class="p">]</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="k">return</span>  <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">sbni_start_xmit</span><span class="p">(</span> <span class="k">struct</span> <span class="n">sk_buff</span>  <span class="o">*</span><span class="n">skb</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>

	<span class="cm">/* Looking for idle device in the list */</span>
	<span class="k">for</span><span class="p">(</span> <span class="n">p</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>  <span class="n">p</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="n">spin_lock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_buf_p</span>  <span class="o">||</span>  <span class="p">(</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_LINE_DOWN</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">p</span> <span class="o">=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Idle dev is found */</span>
			<span class="n">prepare_to_send</span><span class="p">(</span> <span class="n">skb</span><span class="p">,</span> <span class="n">p</span> <span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
			<span class="n">netif_start_queue</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else	</span><span class="cm">/* CONFIG_SBNI_MULTILINE */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">sbni_start_xmit</span><span class="p">(</span> <span class="k">struct</span> <span class="n">sk_buff</span>  <span class="o">*</span><span class="n">skb</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span>  <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>

	<span class="n">prepare_to_send</span><span class="p">(</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dev</span> <span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif	</span><span class="cm">/* CONFIG_SBNI_MULTILINE */</span><span class="cp"></span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="cm">/* interrupt handler */</span>

<span class="cm">/*</span>
<span class="cm"> * 	SBNI12D-10, -11/ISA boards within &quot;common interrupt&quot; mode could not</span>
<span class="cm"> * be looked as two independent single-channel devices. Every channel seems</span>
<span class="cm"> * as Ethernet interface but interrupt handler must be common. Really, first</span>
<span class="cm"> * channel (&quot;master&quot;) driver only registers the handler. In its struct net_local</span>
<span class="cm"> * it has got pointer to &quot;slave&quot; channel&#39;s struct net_local and handles that&#39;s</span>
<span class="cm"> * interrupts too.</span>
<span class="cm"> *	dev of successfully attached ISA SBNI boards is linked to list.</span>
<span class="cm"> * While next board driver is initialized, it scans this list. If one</span>
<span class="cm"> * has found dev with same irq and ioaddr different by 4 then it assumes</span>
<span class="cm"> * this board to be &quot;master&quot;.</span>
<span class="cm"> */</span> 

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">sbni_interrupt</span><span class="p">(</span> <span class="kt">int</span>  <span class="n">irq</span><span class="p">,</span>  <span class="kt">void</span>  <span class="o">*</span><span class="n">dev_id</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>	  <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span>  <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span>	<span class="n">repeat</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">second</span> <span class="p">)</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NET_LOCAL_LOCK</span><span class="p">(</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">));</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">repeat</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">inb</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RC_RDY</span> <span class="o">|</span> <span class="n">TR_RDY</span><span class="p">)</span> <span class="p">)</span>
			<span class="n">handle_channel</span><span class="p">(</span> <span class="n">dev</span> <span class="p">),</span>
			<span class="n">repeat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">second</span>  <span class="o">&amp;&amp;</span> 	<span class="cm">/* second channel present */</span>
		    <span class="p">(</span><span class="n">inb</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="o">+</span><span class="n">CSR0</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RC_RDY</span> <span class="o">|</span> <span class="n">TR_RDY</span><span class="p">))</span> <span class="p">)</span>
			<span class="n">handle_channel</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">second</span> <span class="p">),</span>
			<span class="n">repeat</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span><span class="p">(</span> <span class="n">repeat</span> <span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">second</span> <span class="p">)</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NET_LOCAL_LOCK</span><span class="p">(</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">));</span>
	<span class="n">spin_unlock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">handle_channel</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>	<span class="o">*</span><span class="n">nl</span>    <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">ioaddr</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="kt">int</span>  <span class="n">req_ans</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">csr0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
	<span class="cm">/* Lock the master device because we going to change its local data */</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_SLAVE</span> <span class="p">)</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NET_LOCAL_LOCK</span><span class="p">(</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">));</span>
<span class="cp">#endif</span>

	<span class="n">outb</span><span class="p">(</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">EN_INT</span><span class="p">)</span> <span class="o">|</span> <span class="n">TR_REQ</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="n">CHANGE_LEVEL_START_TICKS</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">csr0</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="p">(</span> <span class="n">csr0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RC_RDY</span> <span class="o">|</span> <span class="n">TR_RDY</span><span class="p">)</span> <span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">req_ans</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_PREV_OK</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span> <span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">RC_RDY</span> <span class="p">)</span>
			<span class="n">req_ans</span> <span class="o">=</span> <span class="n">recv_frame</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * TR_RDY always equals 1 here because we have owned the marker,</span>
<span class="cm">		 * and we set TR_REQ when disabled interrupts</span>
<span class="cm">		 */</span>
		<span class="n">csr0</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">TR_RDY</span><span class="p">)</span>  <span class="o">||</span>  <span class="p">(</span><span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">RC_RDY</span><span class="p">)</span> <span class="p">)</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;internal error!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="cm">/* if state &amp; FL_NEED_RESEND != 0 then tx_frameno != 0 */</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">req_ans</span>  <span class="o">||</span>  <span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_frameno</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
			<span class="n">send_frame</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
		<span class="k">else</span>
			<span class="cm">/* send marker without any data */</span>
			<span class="n">outb</span><span class="p">(</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TR_REQ</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">)</span> <span class="o">|</span> <span class="n">EN_INT</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>

<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_SLAVE</span> <span class="p">)</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">NET_LOCAL_LOCK</span><span class="p">(</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">));</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Routine returns 1 if it need to acknoweledge received frame.</span>
<span class="cm"> * Empty frame received without errors won&#39;t be acknoweledged.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">recv_frame</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span>   <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">ioaddr</span>	<span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">;</span>

	<span class="n">u32</span>  <span class="n">crc</span> <span class="o">=</span> <span class="n">CRC32_INITIAL</span><span class="p">;</span>

	<span class="kt">unsigned</span>  <span class="n">framelen</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">frameno</span><span class="p">,</span> <span class="n">ack</span><span class="p">;</span>
	<span class="kt">unsigned</span>  <span class="n">is_first</span><span class="p">,</span> <span class="n">frame_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">check_fhdr</span><span class="p">(</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">framelen</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">frameno</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">is_first</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crc</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">frame_ok</span> <span class="o">=</span> <span class="n">framelen</span> <span class="o">&gt;</span> <span class="mi">4</span>
			<span class="o">?</span>  <span class="n">upload_data</span><span class="p">(</span> <span class="n">dev</span><span class="p">,</span> <span class="n">framelen</span><span class="p">,</span> <span class="n">frameno</span><span class="p">,</span> <span class="n">is_first</span><span class="p">,</span> <span class="n">crc</span> <span class="p">)</span>
			<span class="o">:</span>  <span class="n">skip_tail</span><span class="p">(</span> <span class="n">ioaddr</span><span class="p">,</span> <span class="n">framelen</span><span class="p">,</span> <span class="n">crc</span> <span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">frame_ok</span> <span class="p">)</span>
			<span class="n">interpret_ack</span><span class="p">(</span> <span class="n">dev</span><span class="p">,</span> <span class="n">ack</span> <span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outb</span><span class="p">(</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">)</span> <span class="o">^</span> <span class="n">CT_ZER</span><span class="p">,</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">frame_ok</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">FL_PREV_OK</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">framelen</span> <span class="o">&gt;</span> <span class="mi">4</span> <span class="p">)</span>
			<span class="n">nl</span><span class="o">-&gt;</span><span class="n">in_stats</span><span class="p">.</span><span class="n">all_rx_number</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FL_PREV_OK</span><span class="p">,</span>
		<span class="n">change_level</span><span class="p">(</span> <span class="n">dev</span> <span class="p">),</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">in_stats</span><span class="p">.</span><span class="n">all_rx_number</span><span class="o">++</span><span class="p">,</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">in_stats</span><span class="p">.</span><span class="n">bad_rx_number</span><span class="o">++</span><span class="p">;</span>

	<span class="k">return</span>  <span class="o">!</span><span class="n">frame_ok</span>  <span class="o">||</span>  <span class="n">framelen</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">send_frame</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span>    <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">u32</span>  <span class="n">crc</span> <span class="o">=</span> <span class="n">CRC32_INITIAL</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_NEED_RESEND</span> <span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* if frame was sended but not ACK&#39;ed - resend it */</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">trans_errors</span> <span class="p">)</span> <span class="p">{</span>
			<span class="o">--</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">trans_errors</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">framelen</span> <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
				<span class="n">nl</span><span class="o">-&gt;</span><span class="n">in_stats</span><span class="p">.</span><span class="n">resend_tx_number</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* cannot xmit with many attempts */</span>
<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
			<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_SLAVE</span><span class="p">)</span>  <span class="o">||</span>  <span class="n">nl</span><span class="o">-&gt;</span><span class="n">link</span> <span class="p">)</span>
<span class="cp">#endif</span>
			<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">FL_LINE_DOWN</span><span class="p">;</span>
			<span class="n">drop_xmit_queue</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
			<span class="k">goto</span>  <span class="n">do_send</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">trans_errors</span> <span class="o">=</span> <span class="n">TR_ERROR_COUNT</span><span class="p">;</span>

	<span class="n">send_frame_header</span><span class="p">(</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crc</span> <span class="p">);</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">FL_NEED_RESEND</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * FL_NEED_RESEND will be cleared after ACK, but if empty</span>
<span class="cm">	 * frame sended then in prepare_to_send next frame</span>
<span class="cm">	 */</span>


	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">framelen</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">download_data</span><span class="p">(</span> <span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">crc</span> <span class="p">);</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">in_stats</span><span class="p">.</span><span class="n">all_tx_number</span><span class="o">++</span><span class="p">;</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">FL_WAIT_ACK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">outsb</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DAT</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">crc</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">crc</span> <span class="p">);</span>

<span class="nl">do_send:</span>
	<span class="n">outb</span><span class="p">(</span> <span class="n">inb</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TR_REQ</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_frameno</span> <span class="p">)</span>
		<span class="cm">/* next frame exists - we request card to send it */</span>
		<span class="n">outb</span><span class="p">(</span> <span class="n">inb</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">)</span> <span class="o">|</span> <span class="n">TR_REQ</span><span class="p">,</span>
		      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Write the frame data into adapter&#39;s buffer memory, and calculate CRC.</span>
<span class="cm"> * Do padding if necessary.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">download_data</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">,</span>  <span class="n">u32</span>  <span class="o">*</span><span class="n">crc_p</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span>    <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>    <span class="o">*</span><span class="n">skb</span>	 <span class="o">=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_buf_p</span><span class="p">;</span>

	<span class="kt">unsigned</span>  <span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">outpos</span><span class="p">,</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">framelen</span><span class="p">);</span>

	<span class="n">outsb</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DAT</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">outpos</span><span class="p">,</span> <span class="n">len</span> <span class="p">);</span>
	<span class="o">*</span><span class="n">crc_p</span> <span class="o">=</span> <span class="n">calc_crc32</span><span class="p">(</span> <span class="o">*</span><span class="n">crc_p</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">outpos</span><span class="p">,</span> <span class="n">len</span> <span class="p">);</span>

	<span class="cm">/* if packet too short we should write some more bytes to pad */</span>
	<span class="k">for</span><span class="p">(</span> <span class="n">len</span> <span class="o">=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">framelen</span> <span class="o">-</span> <span class="n">len</span><span class="p">;</span>  <span class="n">len</span><span class="o">--</span><span class="p">;</span> <span class="p">)</span>
		<span class="n">outb</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DAT</span> <span class="p">),</span>
		<span class="o">*</span><span class="n">crc_p</span> <span class="o">=</span> <span class="n">CRC32</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="o">*</span><span class="n">crc_p</span> <span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">upload_data</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">,</span>  <span class="kt">unsigned</span>  <span class="n">framelen</span><span class="p">,</span>  <span class="kt">unsigned</span>  <span class="n">frameno</span><span class="p">,</span>
	     <span class="kt">unsigned</span>  <span class="n">is_first</span><span class="p">,</span>  <span class="n">u32</span>  <span class="n">crc</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">int</span>  <span class="n">frame_ok</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">is_first</span> <span class="p">)</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">wait_frameno</span> <span class="o">=</span> <span class="n">frameno</span><span class="p">,</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">inppos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">wait_frameno</span> <span class="o">==</span> <span class="n">frameno</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">inppos</span> <span class="o">+</span> <span class="n">framelen</span>  <span class="o">&lt;=</span>  <span class="n">ETHER_MAX_LEN</span> <span class="p">)</span>
			<span class="n">frame_ok</span> <span class="o">=</span> <span class="n">append_frame_to_pkt</span><span class="p">(</span> <span class="n">dev</span><span class="p">,</span> <span class="n">framelen</span><span class="p">,</span> <span class="n">crc</span> <span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * if CRC is right but framelen incorrect then transmitter</span>
<span class="cm">		 * error was occurred... drop entire packet</span>
<span class="cm">		 */</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="n">frame_ok</span> <span class="o">=</span> <span class="n">skip_tail</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">framelen</span><span class="p">,</span> <span class="n">crc</span> <span class="p">))</span>
			 <span class="o">!=</span> <span class="mi">0</span> <span class="p">)</span>
			<span class="n">nl</span><span class="o">-&gt;</span><span class="n">wait_frameno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">nl</span><span class="o">-&gt;</span><span class="n">inppos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
			<span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">,</span>
			<span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#else</span>
		        <span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="cm">/* now skip all frames until is_first != 0 */</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">frame_ok</span> <span class="o">=</span> <span class="n">skip_tail</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">framelen</span><span class="p">,</span> <span class="n">crc</span> <span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">is_first</span>  <span class="o">&amp;&amp;</span>  <span class="o">!</span><span class="n">frame_ok</span> <span class="p">)</span>
		<span class="cm">/*</span>
<span class="cm">		 * Frame has been broken, but we had already stored</span>
<span class="cm">		 * is_first... Drop entire packet.</span>
<span class="cm">		 */</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">wait_frameno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">,</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">return</span>  <span class="n">frame_ok</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">send_complete</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_buf_p</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_buf_p</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">dev_kfree_skb_irq</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_buf_p</span> <span class="p">);</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_buf_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">outpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FL_WAIT_ACK</span> <span class="o">|</span> <span class="n">FL_NEED_RESEND</span><span class="p">);</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">framelen</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">interpret_ack</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">,</span>  <span class="kt">unsigned</span>  <span class="n">ack</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">ack</span> <span class="o">==</span> <span class="n">FRAME_SENT_OK</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FL_NEED_RESEND</span><span class="p">;</span>

		<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_WAIT_ACK</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">nl</span><span class="o">-&gt;</span><span class="n">outpos</span> <span class="o">+=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">framelen</span><span class="p">;</span>

			<span class="k">if</span><span class="p">(</span> <span class="o">--</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_frameno</span> <span class="p">)</span>
				<span class="n">nl</span><span class="o">-&gt;</span><span class="n">framelen</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span>
						   <span class="n">nl</span><span class="o">-&gt;</span><span class="n">maxframe</span><span class="p">,</span>
						   <span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_buf_p</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">outpos</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">send_complete</span><span class="p">(</span> <span class="n">dev</span> <span class="p">),</span>
<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span> <span class="p">);</span>
<span class="cp">#else</span>
				<span class="n">netif_wake_queue</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
<span class="cp">#endif</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FL_WAIT_ACK</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Glue received frame with previous fragments of packet.</span>
<span class="cm"> * Indicate packet when last frame would be accepted.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">append_frame_to_pkt</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">,</span>  <span class="kt">unsigned</span>  <span class="n">framelen</span><span class="p">,</span>  <span class="n">u32</span>  <span class="n">crc</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">u8</span>  <span class="o">*</span><span class="n">p</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">inppos</span> <span class="o">+</span> <span class="n">framelen</span>  <span class="o">&gt;</span>  <span class="n">ETHER_MAX_LEN</span> <span class="p">)</span>
		<span class="k">return</span>  <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">rx_buf_p</span>  <span class="o">&amp;&amp;</span>  <span class="o">!</span><span class="p">(</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">rx_buf_p</span> <span class="o">=</span> <span class="n">get_rx_buf</span><span class="p">(</span> <span class="n">dev</span> <span class="p">))</span> <span class="p">)</span>
		<span class="k">return</span>  <span class="mi">0</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">rx_buf_p</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">+</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">inppos</span><span class="p">;</span>
	<span class="n">insb</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DAT</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">framelen</span> <span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">calc_crc32</span><span class="p">(</span> <span class="n">crc</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">framelen</span> <span class="p">)</span> <span class="o">!=</span> <span class="n">CRC32_REMAINDER</span> <span class="p">)</span>
		<span class="k">return</span>  <span class="mi">0</span><span class="p">;</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">inppos</span> <span class="o">+=</span> <span class="n">framelen</span> <span class="o">-</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">--</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">wait_frameno</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>		<span class="cm">/* last frame received */</span>
		<span class="n">indicate_pkt</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>

	<span class="k">return</span>  <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Prepare to start output on adapter.</span>
<span class="cm"> * Transmitter will be actually activated when marker is accepted.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">prepare_to_send</span><span class="p">(</span> <span class="k">struct</span> <span class="n">sk_buff</span>  <span class="o">*</span><span class="n">skb</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* nl-&gt;tx_buf_p == NULL here! */</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_buf_p</span> <span class="p">)</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;memory leak!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">outpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FL_WAIT_ACK</span> <span class="o">|</span> <span class="n">FL_NEED_RESEND</span><span class="p">);</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">SBNI_MIN_LEN</span> <span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">SBNI_MIN_LEN</span><span class="p">;</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_buf_p</span>	<span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_frameno</span>	<span class="o">=</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">maxframe</span><span class="p">);</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">framelen</span>	<span class="o">=</span> <span class="n">len</span> <span class="o">&lt;</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">maxframe</span>  <span class="o">?</span>  <span class="n">len</span>  <span class="o">:</span>  <span class="n">nl</span><span class="o">-&gt;</span><span class="n">maxframe</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span> <span class="n">inb</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">)</span> <span class="o">|</span> <span class="n">TR_REQ</span><span class="p">,</span>  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>
<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">drop_xmit_queue</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_buf_p</span> <span class="p">)</span>
		<span class="n">dev_kfree_skb_any</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_buf_p</span> <span class="p">),</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_buf_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">,</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">,</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_frameno</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">framelen</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">outpos</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FL_WAIT_ACK</span> <span class="o">|</span> <span class="n">FL_NEED_RESEND</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
	<span class="n">netif_start_queue</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span> <span class="p">);</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">netif_start_queue</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">send_frame_header</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">,</span>  <span class="n">u32</span>  <span class="o">*</span><span class="n">crc_p</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span>  <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">u32</span>  <span class="n">crc</span> <span class="o">=</span> <span class="o">*</span><span class="n">crc_p</span><span class="p">;</span>
	<span class="n">u32</span>  <span class="n">len_field</span> <span class="o">=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">framelen</span> <span class="o">+</span> <span class="mi">6</span><span class="p">;</span>	<span class="cm">/* CRC + frameno + reserved */</span>
	<span class="n">u8</span>   <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_NEED_RESEND</span> <span class="p">)</span>
		<span class="n">len_field</span> <span class="o">|=</span> <span class="n">FRAME_RETRY</span><span class="p">;</span>	<span class="cm">/* non-first attempt... */</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">outpos</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="n">len_field</span> <span class="o">|=</span> <span class="n">FRAME_FIRST</span><span class="p">;</span>

	<span class="n">len_field</span> <span class="o">|=</span> <span class="p">(</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_PREV_OK</span><span class="p">)</span> <span class="o">?</span> <span class="n">FRAME_SENT_OK</span> <span class="o">:</span> <span class="n">FRAME_SENT_BAD</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span> <span class="n">SBNI_SIG</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DAT</span> <span class="p">);</span>

	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="n">len_field</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DAT</span> <span class="p">);</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">CRC32</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="n">crc</span> <span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">len_field</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DAT</span> <span class="p">);</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">CRC32</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="n">crc</span> <span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_frameno</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DAT</span> <span class="p">);</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">CRC32</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_frameno</span><span class="p">,</span> <span class="n">crc</span> <span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">DAT</span> <span class="p">);</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">CRC32</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">crc</span> <span class="p">);</span>
	<span class="o">*</span><span class="n">crc_p</span> <span class="o">=</span> <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * if frame tail not needed (incorrect number or received twice),</span>
<span class="cm"> * it won&#39;t store, but CRC will be calculated</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">skip_tail</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">ioaddr</span><span class="p">,</span>  <span class="kt">unsigned</span> <span class="kt">int</span>  <span class="n">tail_len</span><span class="p">,</span>  <span class="n">u32</span> <span class="n">crc</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span><span class="p">(</span> <span class="n">tail_len</span><span class="o">--</span> <span class="p">)</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">CRC32</span><span class="p">(</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DAT</span> <span class="p">),</span> <span class="n">crc</span> <span class="p">);</span>

	<span class="k">return</span>  <span class="n">crc</span> <span class="o">==</span> <span class="n">CRC32_REMAINDER</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Preliminary checks if frame header is correct, calculates its CRC</span>
<span class="cm"> * and split it to simple fields</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">check_fhdr</span><span class="p">(</span> <span class="n">u32</span>  <span class="n">ioaddr</span><span class="p">,</span>  <span class="n">u32</span>  <span class="o">*</span><span class="n">framelen</span><span class="p">,</span>  <span class="n">u32</span>  <span class="o">*</span><span class="n">frameno</span><span class="p">,</span>  <span class="n">u32</span>  <span class="o">*</span><span class="n">ack</span><span class="p">,</span>
	    <span class="n">u32</span>  <span class="o">*</span><span class="n">is_first</span><span class="p">,</span>  <span class="n">u32</span>  <span class="o">*</span><span class="n">crc_p</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span>  <span class="n">crc</span> <span class="o">=</span> <span class="o">*</span><span class="n">crc_p</span><span class="p">;</span>
	<span class="n">u8</span>   <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DAT</span> <span class="p">)</span> <span class="o">!=</span> <span class="n">SBNI_SIG</span> <span class="p">)</span>
		<span class="k">return</span>  <span class="mi">0</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DAT</span> <span class="p">);</span>
	<span class="o">*</span><span class="n">framelen</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">value</span><span class="p">;</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">CRC32</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="n">crc</span> <span class="p">);</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DAT</span> <span class="p">);</span>
	<span class="o">*</span><span class="n">framelen</span> <span class="o">|=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">value</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">CRC32</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="n">crc</span> <span class="p">);</span>

	<span class="o">*</span><span class="n">ack</span> <span class="o">=</span> <span class="o">*</span><span class="n">framelen</span> <span class="o">&amp;</span> <span class="n">FRAME_ACK_MASK</span><span class="p">;</span>
	<span class="o">*</span><span class="n">is_first</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">framelen</span> <span class="o">&amp;</span> <span class="n">FRAME_FIRST</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="n">framelen</span> <span class="o">&amp;=</span> <span class="n">FRAME_LEN_MASK</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">6</span> <span class="o">||</span>
	    <span class="o">*</span><span class="n">framelen</span> <span class="o">&gt;</span> <span class="n">SBNI_MAX_FRAME</span> <span class="o">-</span> <span class="mi">3</span> <span class="p">)</span>
		<span class="k">return</span>  <span class="mi">0</span><span class="p">;</span>

	<span class="n">value</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DAT</span> <span class="p">);</span>
	<span class="o">*</span><span class="n">frameno</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">value</span><span class="p">;</span>
	<span class="n">crc</span> <span class="o">=</span> <span class="n">CRC32</span><span class="p">(</span> <span class="n">value</span><span class="p">,</span> <span class="n">crc</span> <span class="p">);</span>

	<span class="n">crc</span> <span class="o">=</span> <span class="n">CRC32</span><span class="p">(</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">DAT</span> <span class="p">),</span> <span class="n">crc</span> <span class="p">);</span>	<span class="cm">/* reserved byte */</span>
	<span class="o">*</span><span class="n">framelen</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="o">*</span><span class="n">crc_p</span> <span class="o">=</span> <span class="n">crc</span><span class="p">;</span>
	<span class="k">return</span>  <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span>
<span class="nf">get_rx_buf</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* +2 is to compensate for the alignment fixup below */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>  <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span> <span class="n">ETHER_MAX_LEN</span> <span class="o">+</span> <span class="mi">2</span> <span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">skb</span> <span class="p">)</span>
		<span class="k">return</span>  <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">skb_reserve</span><span class="p">(</span> <span class="n">skb</span><span class="p">,</span> <span class="mi">2</span> <span class="p">);</span>		<span class="cm">/* Align IP on longword boundaries */</span>
	<span class="k">return</span>  <span class="n">skb</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">indicate_pkt</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span>  <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span>    <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">rx_buf_p</span><span class="p">;</span>

	<span class="n">skb_put</span><span class="p">(</span> <span class="n">skb</span><span class="p">,</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">inppos</span> <span class="p">);</span>

<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span> <span class="n">skb</span><span class="p">,</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span> <span class="p">);</span>
	<span class="n">netif_rx</span><span class="p">(</span> <span class="n">skb</span> <span class="p">);</span>
	<span class="o">++</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">inppos</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">eth_type_trans</span><span class="p">(</span> <span class="n">skb</span><span class="p">,</span> <span class="n">dev</span> <span class="p">);</span>
	<span class="n">netif_rx</span><span class="p">(</span> <span class="n">skb</span> <span class="p">);</span>
	<span class="o">++</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">inppos</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">rx_buf_p</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>	<span class="cm">/* protocol driver will clear this sk_buff */</span>
<span class="p">}</span>


<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> * Routine checks periodically wire activity and regenerates marker if</span>
<span class="cm"> * connect was inactive for a long time.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">sbni_watchdog</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">arg</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span> <span class="n">arg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span>   <span class="o">*</span><span class="n">nl</span>  <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">timer_list</span>  <span class="o">*</span><span class="n">w</span>   <span class="o">=</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">;</span> 
	<span class="kt">unsigned</span> <span class="kt">long</span>	   <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>	   <span class="n">csr0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span> <span class="p">);</span>

	<span class="n">csr0</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">RC_CHK</span> <span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span><span class="p">(</span> <span class="n">csr0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RC_RDY</span> <span class="o">|</span> <span class="n">BU_EMP</span><span class="p">)</span> <span class="p">)</span>
				<span class="cm">/* receiving not active */</span>
				<span class="n">nl</span><span class="o">-&gt;</span><span class="n">timer_ticks</span><span class="o">--</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">nl</span><span class="o">-&gt;</span><span class="n">in_stats</span><span class="p">.</span><span class="n">timeout_number</span><span class="o">++</span><span class="p">;</span>
			<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">delta_rxl</span> <span class="p">)</span>
				<span class="n">timeout_change_level</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>

			<span class="n">outb</span><span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">csr1</span> <span class="o">|</span> <span class="n">PR_RES</span><span class="p">,</span>
			      <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR1</span> <span class="p">);</span>
			<span class="n">csr0</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FL_LINE_DOWN</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span> <span class="n">csr0</span> <span class="o">|</span> <span class="n">RC_CHK</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span> 

	<span class="n">init_timer</span><span class="p">(</span> <span class="n">w</span> <span class="p">);</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">expires</span>	<span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SBNI_TIMEOUT</span><span class="p">;</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">data</span>		<span class="o">=</span> <span class="n">arg</span><span class="p">;</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">function</span>	<span class="o">=</span> <span class="n">sbni_watchdog</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span> <span class="n">w</span> <span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span> <span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">rxl_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">,</span> <span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x04</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x06</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span>
	<span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x16</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x1c</span><span class="p">,</span> <span class="mh">0x1f</span>
<span class="p">};</span>

<span class="cp">#define SIZE_OF_TIMEOUT_RXL_TAB 4</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">timeout_rxl_tab</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x03</span><span class="p">,</span> <span class="mh">0x05</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x0b</span>
<span class="p">};</span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">card_start</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">timer_ticks</span> <span class="o">=</span> <span class="n">CHANGE_LEVEL_START_TICKS</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">FL_WAIT_ACK</span> <span class="o">|</span> <span class="n">FL_NEED_RESEND</span><span class="p">);</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">FL_PREV_OK</span><span class="p">;</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">inppos</span> <span class="o">=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">outpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">wait_frameno</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">tx_frameno</span>	 <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">framelen</span>	 <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">outb</span><span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">u_char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">csr1</span> <span class="o">|</span> <span class="n">PR_RES</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR1</span> <span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span> <span class="n">EN_INT</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="cm">/* Receive level auto-selection */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">change_level</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">delta_rxl</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>	<span class="cm">/* do not auto-negotiate RxL */</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_index</span> <span class="o">==</span> <span class="mi">0</span> <span class="p">)</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">delta_rxl</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_index</span> <span class="o">==</span> <span class="mi">15</span> <span class="p">)</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">delta_rxl</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_rcvd</span> <span class="o">&lt;</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">prev_rxl_rcvd</span> <span class="p">)</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">delta_rxl</span> <span class="o">=</span> <span class="o">-</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">delta_rxl</span><span class="p">;</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">csr1</span><span class="p">.</span><span class="n">rxl</span> <span class="o">=</span> <span class="n">rxl_tab</span><span class="p">[</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_index</span> <span class="o">+=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">delta_rxl</span> <span class="p">];</span>
	<span class="n">inb</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>	<span class="cm">/* needs for PCI cards */</span>
	<span class="n">outb</span><span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">csr1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR1</span> <span class="p">);</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">prev_rxl_rcvd</span> <span class="o">=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_rcvd</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_rcvd</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span>
<span class="nf">timeout_change_level</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_index</span> <span class="o">=</span> <span class="n">timeout_rxl_tab</span><span class="p">[</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">timeout_rxl</span> <span class="p">];</span>
	<span class="k">if</span><span class="p">(</span> <span class="o">++</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">timeout_rxl</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="p">)</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">timeout_rxl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">csr1</span><span class="p">.</span><span class="n">rxl</span> <span class="o">=</span> <span class="n">rxl_tab</span><span class="p">[</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_index</span> <span class="p">];</span>
	<span class="n">inb</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">csr1</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR1</span> <span class="p">);</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">prev_rxl_rcvd</span> <span class="o">=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_rcvd</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_rcvd</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="cm">/*</span>
<span class="cm"> *	Open/initialize the board. </span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sbni_open</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>	<span class="o">*</span><span class="n">nl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="o">*</span><span class="n">w</span>  <span class="o">=</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">watchdog</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For double ISA adapters within &quot;common irq&quot; mode, we have to</span>
<span class="cm">	 * determine whether primary or secondary channel is initialized,</span>
<span class="cm">	 * and set the irq handler only in first case.</span>
<span class="cm">	 */</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">&lt;</span> <span class="mh">0x400</span> <span class="p">)</span> <span class="p">{</span>		<span class="cm">/* ISA only */</span>
		<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">**</span><span class="n">p</span> <span class="o">=</span> <span class="n">sbni_cards</span><span class="p">;</span>
		<span class="k">for</span><span class="p">(</span> <span class="p">;</span>  <span class="o">*</span><span class="n">p</span>  <span class="o">&amp;&amp;</span>  <span class="n">p</span> <span class="o">&lt;</span> <span class="n">sbni_cards</span> <span class="o">+</span> <span class="n">SBNI_MAX_NUM_CARDS</span><span class="p">;</span>  <span class="o">++</span><span class="n">p</span> <span class="p">)</span>
			<span class="k">if</span><span class="p">(</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&amp;&amp;</span>
			    <span class="p">((</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">||</span>
			     <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">==</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">-</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span> <span class="p">)</span> <span class="p">{</span>

				<span class="p">((</span><span class="k">struct</span> <span class="n">net_local</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">netdev_priv</span><span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)))</span>
					<span class="o">-&gt;</span><span class="n">second</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
				<span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;using shared irq with %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					      <span class="p">(</span><span class="o">*</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">FL_SECONDARY</span><span class="p">;</span>
				<span class="k">goto</span>  <span class="n">handler_attached</span><span class="p">;</span>
			<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">sbni_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unable to get IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">handler_attached:</span>

	<span class="n">spin_lock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device_stats</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">in_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbni_in_stats</span><span class="p">)</span> <span class="p">);</span>

	<span class="n">card_start</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>

	<span class="cm">/* set timer watchdog */</span>
	<span class="n">init_timer</span><span class="p">(</span> <span class="n">w</span> <span class="p">);</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">expires</span>	<span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SBNI_TIMEOUT</span><span class="p">;</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">data</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">w</span><span class="o">-&gt;</span><span class="n">function</span>	<span class="o">=</span> <span class="n">sbni_watchdog</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span> <span class="n">w</span> <span class="p">);</span>
   
	<span class="n">spin_unlock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sbni_close</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">second</span>  <span class="o">&amp;&amp;</span>  <span class="n">nl</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Secondary channel (%s) is active!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			      <span class="n">nl</span><span class="o">-&gt;</span><span class="n">second</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_SLAVE</span> <span class="p">)</span>
		<span class="n">emancipate</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
	<span class="k">else</span>
		<span class="k">while</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">link</span> <span class="p">)</span>	<span class="cm">/* it&#39;s master device! */</span>
			<span class="n">emancipate</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">link</span> <span class="p">);</span>
<span class="cp">#endif</span>

	<span class="n">spin_lock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>

	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">second</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">drop_xmit_queue</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>	
	<span class="n">netif_stop_queue</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
   
	<span class="n">del_timer</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">watchdog</span> <span class="p">);</span>

	<span class="n">outb</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_SECONDARY</span><span class="p">)</span> <span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span> <span class="p">);</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="n">FL_SECONDARY</span><span class="p">;</span>

	<span class="n">spin_unlock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm">	Valid combinations in CSR0 (for probing):</span>

<span class="cm">	VALID_DECODER	0000,0011,1011,1010</span>

<span class="cm">				    	; 0   ; -</span>
<span class="cm">				TR_REQ	; 1   ; +</span>
<span class="cm">			TR_RDY	    	; 2   ; -</span>
<span class="cm">			TR_RDY	TR_REQ	; 3   ; +</span>
<span class="cm">		BU_EMP		    	; 4   ; +</span>
<span class="cm">		BU_EMP	     	TR_REQ	; 5   ; +</span>
<span class="cm">		BU_EMP	TR_RDY	    	; 6   ; -</span>
<span class="cm">		BU_EMP	TR_RDY	TR_REQ	; 7   ; +</span>
<span class="cm">	RC_RDY 		     		; 8   ; +</span>
<span class="cm">	RC_RDY			TR_REQ	; 9   ; +</span>
<span class="cm">	RC_RDY		TR_RDY		; 10  ; -</span>
<span class="cm">	RC_RDY		TR_RDY	TR_REQ	; 11  ; -</span>
<span class="cm">	RC_RDY	BU_EMP			; 12  ; -</span>
<span class="cm">	RC_RDY	BU_EMP		TR_REQ	; 13  ; -</span>
<span class="cm">	RC_RDY	BU_EMP	TR_RDY		; 14  ; -</span>
<span class="cm">	RC_RDY	BU_EMP	TR_RDY	TR_REQ	; 15  ; -</span>
<span class="cm">*/</span>

<span class="cp">#define VALID_DECODER (2 + 8 + 0x10 + 0x20 + 0x80 + 0x100 + 0x200)</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sbni_card_probe</span><span class="p">(</span> <span class="kt">unsigned</span> <span class="kt">long</span>  <span class="n">ioaddr</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span>  <span class="n">csr0</span><span class="p">;</span>

	<span class="n">csr0</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span> <span class="n">ioaddr</span> <span class="o">+</span> <span class="n">CSR0</span> <span class="p">);</span>
	<span class="k">if</span><span class="p">(</span> <span class="n">csr0</span> <span class="o">!=</span> <span class="mh">0xff</span>  <span class="o">&amp;&amp;</span>  <span class="n">csr0</span> <span class="o">!=</span> <span class="mh">0x00</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">csr0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">EN_INT</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">csr0</span> <span class="o">&amp;</span> <span class="n">BU_EMP</span> <span class="p">)</span>
			<span class="n">csr0</span> <span class="o">|=</span> <span class="n">EN_INT</span><span class="p">;</span>
      
		<span class="k">if</span><span class="p">(</span> <span class="n">VALID_DECODER</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">csr0</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">))</span> <span class="p">)</span>
			<span class="k">return</span>  <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
   
	<span class="k">return</span>  <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">sbni_ioctl</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">ifreq</span>  <span class="o">*</span><span class="n">ifr</span><span class="p">,</span>  <span class="kt">int</span>  <span class="n">cmd</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sbni_flags</span>  <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span>  <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>
	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">slave_dev</span><span class="p">;</span>
	<span class="kt">char</span>  <span class="n">slave_name</span><span class="p">[</span> <span class="mi">8</span> <span class="p">];</span>
<span class="cp">#endif</span>
  
	<span class="k">switch</span><span class="p">(</span> <span class="n">cmd</span> <span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span>  <span class="n">SIOCDEVGETINSTATS</span> :
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">in_stats</span><span class="p">,</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbni_in_stats</span><span class="p">)</span> <span class="p">))</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span>  <span class="n">SIOCDEVRESINSTATS</span> :
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span>  <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="n">memset</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">in_stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbni_in_stats</span><span class="p">)</span> <span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span>  <span class="n">SIOCDEVGHWSTATE</span> :
		<span class="n">flags</span><span class="p">.</span><span class="n">mac_addr</span>	<span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">flags</span><span class="p">.</span><span class="n">rate</span>	<span class="o">=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">csr1</span><span class="p">.</span><span class="n">rate</span><span class="p">;</span>
		<span class="n">flags</span><span class="p">.</span><span class="n">slow_mode</span>	<span class="o">=</span> <span class="p">(</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_SLOW_MODE</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">flags</span><span class="p">.</span><span class="n">rxl</span>	<span class="o">=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_index</span><span class="p">;</span>
		<span class="n">flags</span><span class="p">.</span><span class="n">fixed_rxl</span>	<span class="o">=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">delta_rxl</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">flags</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">flags</span> <span class="p">))</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span>  <span class="n">SIOCDEVSHWSTATE</span> :
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span>  <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="n">spin_lock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
		<span class="n">flags</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="k">struct</span> <span class="n">sbni_flags</span><span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_ifru</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">flags</span><span class="p">.</span><span class="n">fixed_rxl</span> <span class="p">)</span>
			<span class="n">nl</span><span class="o">-&gt;</span><span class="n">delta_rxl</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
			<span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_index</span> <span class="o">=</span> <span class="n">flags</span><span class="p">.</span><span class="n">rxl</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">nl</span><span class="o">-&gt;</span><span class="n">delta_rxl</span> <span class="o">=</span> <span class="n">DEF_RXL_DELTA</span><span class="p">,</span>
			<span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_index</span> <span class="o">=</span> <span class="n">DEF_RXL</span><span class="p">;</span>

		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">csr1</span><span class="p">.</span><span class="n">rxl</span> <span class="o">=</span> <span class="n">rxl_tab</span><span class="p">[</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">cur_rxl_index</span> <span class="p">];</span>
		<span class="n">nl</span><span class="o">-&gt;</span><span class="n">csr1</span><span class="p">.</span><span class="n">rate</span> <span class="o">=</span> <span class="n">flags</span><span class="p">.</span><span class="n">rate</span><span class="p">;</span>
		<span class="n">outb</span><span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">csr1</span> <span class="o">|</span> <span class="n">PR_RES</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span> <span class="o">+</span> <span class="n">CSR1</span> <span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>

	<span class="k">case</span>  <span class="n">SIOCDEVENSLAVE</span> :
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span>  <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span> <span class="n">slave_name</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="k">sizeof</span> <span class="n">slave_name</span> <span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">slave_dev</span> <span class="o">=</span> <span class="n">dev_get_by_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">init_net</span><span class="p">,</span> <span class="n">slave_name</span> <span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">slave_dev</span>  <span class="o">||</span>  <span class="o">!</span><span class="p">(</span><span class="n">slave_dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IFF_UP</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;trying to enslave non-active device %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">slave_name</span><span class="p">);</span>
			<span class="k">return</span>  <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span>  <span class="n">enslave</span><span class="p">(</span> <span class="n">dev</span><span class="p">,</span> <span class="n">slave_dev</span> <span class="p">);</span>

	<span class="k">case</span>  <span class="n">SIOCDEVEMANSIPATE</span> :
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
			<span class="k">return</span>  <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

		<span class="k">return</span>  <span class="n">emancipate</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>

<span class="cp">#endif	</span><span class="cm">/* CONFIG_SBNI_MULTILINE */</span><span class="cp"></span>

	<span class="k">default</span> <span class="o">:</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span>  <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_SBNI_MULTILINE</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">enslave</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">,</span>  <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">slave_dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">nl</span>  <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">snl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">slave_dev</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_SLAVE</span> <span class="p">)</span>	<span class="cm">/* This isn&#39;t master or free device */</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="n">snl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_SLAVE</span> <span class="p">)</span>	<span class="cm">/* That was already enslaved */</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">snl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>

	<span class="cm">/* append to list */</span>
	<span class="n">snl</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">nl</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="n">nl</span><span class="o">-&gt;</span><span class="n">link</span>  <span class="o">=</span> <span class="n">slave_dev</span><span class="p">;</span>
	<span class="n">snl</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">snl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">|=</span> <span class="n">FL_SLAVE</span><span class="p">;</span>

	<span class="cm">/* Summary statistics of MultiLine operation will be stored</span>
<span class="cm">	   in master&#39;s counters */</span>
	<span class="n">memset</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">slave_dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device_stats</span><span class="p">)</span> <span class="p">);</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span> <span class="n">slave_dev</span> <span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>	<span class="cm">/* Now we are able to transmit */</span>

	<span class="n">spin_unlock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">snl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
	<span class="n">netdev_notice</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;slave device (%s) attached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">slave_dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">return</span>  <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">emancipate</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_local</span>   <span class="o">*</span><span class="n">snl</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">p</span>   <span class="o">=</span> <span class="n">snl</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_local</span>   <span class="o">*</span><span class="n">nl</span>  <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="p">(</span><span class="n">snl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">FL_SLAVE</span><span class="p">)</span> <span class="p">)</span>
		<span class="k">return</span>  <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
	<span class="n">spin_lock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">snl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
	<span class="n">drop_xmit_queue</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>

	<span class="cm">/* exclude from list */</span>
	<span class="k">for</span><span class="p">(;;)</span> <span class="p">{</span>	<span class="cm">/* must be in list */</span>
		<span class="k">struct</span> <span class="n">net_local</span>  <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">==</span> <span class="n">dev</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">t</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">snl</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">snl</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">snl</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">snl</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FL_SLAVE</span><span class="p">;</span>

	<span class="n">netif_start_queue</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>

	<span class="n">spin_unlock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">snl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span> <span class="o">&amp;</span><span class="n">nl</span><span class="o">-&gt;</span><span class="n">lock</span> <span class="p">);</span>

	<span class="n">dev_put</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
	<span class="k">return</span>  <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">set_multicast_list</span><span class="p">(</span> <span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span><span class="p">;</span>		<span class="cm">/* sbni always operate in promiscuos mode */</span>
<span class="p">}</span>


<span class="cp">#ifdef MODULE</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">io</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">baud</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">rxl</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">mac</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">skip_pci_probe</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>


<span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_module</span><span class="p">(</span> <span class="kt">void</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span>  <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">while</span><span class="p">(</span> <span class="n">num</span> <span class="o">&lt;</span> <span class="n">SBNI_MAX_NUM_CARDS</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_local</span><span class="p">),</span> 
				   <span class="s">&quot;sbni%d&quot;</span><span class="p">,</span> <span class="n">sbni_devsetup</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">dev</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">sprintf</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;sbni%d&quot;</span><span class="p">,</span> <span class="n">num</span> <span class="p">);</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">sbni_init</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span><span class="p">(</span> <span class="n">register_netdev</span><span class="p">(</span> <span class="n">dev</span> <span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
			<span class="n">release_region</span><span class="p">(</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">SBNI_IO_EXTENT</span> <span class="p">);</span>
			<span class="n">free_netdev</span><span class="p">(</span> <span class="n">dev</span> <span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span>  <span class="o">*</span><span class="n">sbni_cards</span>  <span class="o">?</span>  <span class="mi">0</span>  <span class="o">:</span>  <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="n">i</span> <span class="o">&lt;</span> <span class="n">SBNI_MAX_NUM_CARDS</span><span class="p">;</span>  <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">sbni_cards</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">unregister_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">release_region</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span><span class="p">,</span> <span class="n">SBNI_IO_EXTENT</span><span class="p">);</span>
			<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#else	</span><span class="cm">/* MODULE */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">sbni_setup</span><span class="p">(</span> <span class="kt">char</span>  <span class="o">*</span><span class="n">p</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>  <span class="n">n</span><span class="p">,</span> <span class="n">parm</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;(&#39;</span> <span class="p">)</span>
		<span class="k">goto</span>  <span class="n">bad_param</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">parm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="o">*</span><span class="n">p</span>  <span class="o">&amp;&amp;</span>  <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">dest</span><span class="p">[</span> <span class="n">parm</span> <span class="p">])[</span> <span class="n">n</span> <span class="p">]</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span> <span class="n">p</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="mi">0</span> <span class="p">);</span>
		<span class="k">if</span><span class="p">(</span> <span class="o">!*</span><span class="n">p</span>  <span class="o">||</span>  <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;)&#39;</span> <span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;;&#39;</span> <span class="p">)</span>
			<span class="o">++</span><span class="n">p</span><span class="p">,</span> <span class="o">++</span><span class="n">n</span><span class="p">,</span> <span class="n">parm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span><span class="p">(</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span> <span class="o">!=</span> <span class="sc">&#39;,&#39;</span> <span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">if</span><span class="p">(</span> <span class="o">++</span><span class="n">parm</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">bad_param:</span>
	<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Error in sbni kernel parameter!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span> <span class="s">&quot;sbni=&quot;</span><span class="p">,</span> <span class="n">sbni_setup</span> <span class="p">);</span>

<span class="cp">#endif	</span><span class="cm">/* MODULE */</span><span class="cp"></span>

<span class="cm">/* -------------------------------------------------------------------------- */</span>

<span class="cp">#ifdef ASM_CRC</span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">calc_crc32</span><span class="p">(</span> <span class="n">u32</span>  <span class="n">crc</span><span class="p">,</span>  <span class="n">u8</span>  <span class="o">*</span><span class="n">p</span><span class="p">,</span>  <span class="n">u32</span>  <span class="n">len</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="n">u32</span>  <span class="n">_crc</span><span class="p">;</span>
	<span class="n">_crc</span> <span class="o">=</span> <span class="n">crc</span><span class="p">;</span>
	
	<span class="n">__asm__</span> <span class="n">__volatile__</span> <span class="p">(</span>
		<span class="s">&quot;xorl	%%ebx, %%ebx</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;movl	%2, %%esi</span><span class="se">\n</span><span class="s">&quot;</span> 
		<span class="s">&quot;movl	%3, %%ecx</span><span class="se">\n</span><span class="s">&quot;</span> 
		<span class="s">&quot;movl	$crc32tab, %%edi</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;shrl	$2, %%ecx</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;jz	1f</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="s">&quot;.align 4</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;0:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;movb	%%al, %%bl</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;movl	(%%esi), %%edx</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;shrl	$8, %%eax</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;xorb	%%dl, %%bl</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;shrl	$8, %%edx</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;xorl	(%%edi,%%ebx,4), %%eax</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="s">&quot;movb	%%al, %%bl</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;shrl	$8, %%eax</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;xorb	%%dl, %%bl</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;shrl	$8, %%edx</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;xorl	(%%edi,%%ebx,4), %%eax</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="s">&quot;movb	%%al, %%bl</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;shrl	$8, %%eax</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;xorb	%%dl, %%bl</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;movb	%%dh, %%dl</span><span class="se">\n</span><span class="s">&quot;</span> 
		<span class="s">&quot;xorl	(%%edi,%%ebx,4), %%eax</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="s">&quot;movb	%%al, %%bl</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;shrl	$8, %%eax</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;xorb	%%dl, %%bl</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;addl	$4, %%esi</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;xorl	(%%edi,%%ebx,4), %%eax</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="s">&quot;decl	%%ecx</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;jnz	0b</span><span class="se">\n</span><span class="s">&quot;</span>

	<span class="s">&quot;1:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;movl	%3, %%ecx</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;andl	$3, %%ecx</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;jz	2f</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="s">&quot;movb	%%al, %%bl</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;shrl	$8, %%eax</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;xorb	(%%esi), %%bl</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;xorl	(%%edi,%%ebx,4), %%eax</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="s">&quot;decl	%%ecx</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;jz	2f</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="s">&quot;movb	%%al, %%bl</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;shrl	$8, %%eax</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;xorb	1(%%esi), %%bl</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;xorl	(%%edi,%%ebx,4), %%eax</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="s">&quot;decl	%%ecx</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;jz	2f</span><span class="se">\n</span><span class="s">&quot;</span>

		<span class="s">&quot;movb	%%al, %%bl</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;shrl	$8, %%eax</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;xorb	2(%%esi), %%bl</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="s">&quot;xorl	(%%edi,%%ebx,4), %%eax</span><span class="se">\n</span><span class="s">&quot;</span>
	<span class="s">&quot;2:</span><span class="se">\n</span><span class="s">&quot;</span>
		<span class="o">:</span> <span class="s">&quot;=a&quot;</span> <span class="p">(</span><span class="n">_crc</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;0&quot;</span> <span class="p">(</span><span class="n">_crc</span><span class="p">),</span> <span class="s">&quot;g&quot;</span> <span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="s">&quot;g&quot;</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span>
		<span class="o">:</span> <span class="s">&quot;bx&quot;</span><span class="p">,</span> <span class="s">&quot;cx&quot;</span><span class="p">,</span> <span class="s">&quot;dx&quot;</span><span class="p">,</span> <span class="s">&quot;si&quot;</span><span class="p">,</span> <span class="s">&quot;di&quot;</span>
	<span class="p">);</span>

	<span class="k">return</span>  <span class="n">_crc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else	</span><span class="cm">/* ASM_CRC */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">u32</span>
<span class="nf">calc_crc32</span><span class="p">(</span> <span class="n">u32</span>  <span class="n">crc</span><span class="p">,</span>  <span class="n">u8</span>  <span class="o">*</span><span class="n">p</span><span class="p">,</span>  <span class="n">u32</span>  <span class="n">len</span> <span class="p">)</span>
<span class="p">{</span>
	<span class="k">while</span><span class="p">(</span> <span class="n">len</span><span class="o">--</span> <span class="p">)</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">CRC32</span><span class="p">(</span> <span class="o">*</span><span class="n">p</span><span class="o">++</span><span class="p">,</span> <span class="n">crc</span> <span class="p">);</span>

	<span class="k">return</span>  <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif	</span><span class="cm">/* ASM_CRC */</span><span class="cp"></span>


<span class="k">static</span> <span class="n">u32</span>  <span class="n">crc32tab</span><span class="p">[]</span> <span class="n">__attribute__</span> <span class="p">((</span><span class="n">aligned</span><span class="p">(</span><span class="mi">8</span><span class="p">)))</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0xD202EF8D</span><span class="p">,</span>  <span class="mh">0xA505DF1B</span><span class="p">,</span>  <span class="mh">0x3C0C8EA1</span><span class="p">,</span>  <span class="mh">0x4B0BBE37</span><span class="p">,</span>
	<span class="mh">0xD56F2B94</span><span class="p">,</span>  <span class="mh">0xA2681B02</span><span class="p">,</span>  <span class="mh">0x3B614AB8</span><span class="p">,</span>  <span class="mh">0x4C667A2E</span><span class="p">,</span>
	<span class="mh">0xDCD967BF</span><span class="p">,</span>  <span class="mh">0xABDE5729</span><span class="p">,</span>  <span class="mh">0x32D70693</span><span class="p">,</span>  <span class="mh">0x45D03605</span><span class="p">,</span>
	<span class="mh">0xDBB4A3A6</span><span class="p">,</span>  <span class="mh">0xACB39330</span><span class="p">,</span>  <span class="mh">0x35BAC28A</span><span class="p">,</span>  <span class="mh">0x42BDF21C</span><span class="p">,</span>
	<span class="mh">0xCFB5FFE9</span><span class="p">,</span>  <span class="mh">0xB8B2CF7F</span><span class="p">,</span>  <span class="mh">0x21BB9EC5</span><span class="p">,</span>  <span class="mh">0x56BCAE53</span><span class="p">,</span>
	<span class="mh">0xC8D83BF0</span><span class="p">,</span>  <span class="mh">0xBFDF0B66</span><span class="p">,</span>  <span class="mh">0x26D65ADC</span><span class="p">,</span>  <span class="mh">0x51D16A4A</span><span class="p">,</span>
	<span class="mh">0xC16E77DB</span><span class="p">,</span>  <span class="mh">0xB669474D</span><span class="p">,</span>  <span class="mh">0x2F6016F7</span><span class="p">,</span>  <span class="mh">0x58672661</span><span class="p">,</span>
	<span class="mh">0xC603B3C2</span><span class="p">,</span>  <span class="mh">0xB1048354</span><span class="p">,</span>  <span class="mh">0x280DD2EE</span><span class="p">,</span>  <span class="mh">0x5F0AE278</span><span class="p">,</span>
	<span class="mh">0xE96CCF45</span><span class="p">,</span>  <span class="mh">0x9E6BFFD3</span><span class="p">,</span>  <span class="mh">0x0762AE69</span><span class="p">,</span>  <span class="mh">0x70659EFF</span><span class="p">,</span>
	<span class="mh">0xEE010B5C</span><span class="p">,</span>  <span class="mh">0x99063BCA</span><span class="p">,</span>  <span class="mh">0x000F6A70</span><span class="p">,</span>  <span class="mh">0x77085AE6</span><span class="p">,</span>
	<span class="mh">0xE7B74777</span><span class="p">,</span>  <span class="mh">0x90B077E1</span><span class="p">,</span>  <span class="mh">0x09B9265B</span><span class="p">,</span>  <span class="mh">0x7EBE16CD</span><span class="p">,</span>
	<span class="mh">0xE0DA836E</span><span class="p">,</span>  <span class="mh">0x97DDB3F8</span><span class="p">,</span>  <span class="mh">0x0ED4E242</span><span class="p">,</span>  <span class="mh">0x79D3D2D4</span><span class="p">,</span>
	<span class="mh">0xF4DBDF21</span><span class="p">,</span>  <span class="mh">0x83DCEFB7</span><span class="p">,</span>  <span class="mh">0x1AD5BE0D</span><span class="p">,</span>  <span class="mh">0x6DD28E9B</span><span class="p">,</span>
	<span class="mh">0xF3B61B38</span><span class="p">,</span>  <span class="mh">0x84B12BAE</span><span class="p">,</span>  <span class="mh">0x1DB87A14</span><span class="p">,</span>  <span class="mh">0x6ABF4A82</span><span class="p">,</span>
	<span class="mh">0xFA005713</span><span class="p">,</span>  <span class="mh">0x8D076785</span><span class="p">,</span>  <span class="mh">0x140E363F</span><span class="p">,</span>  <span class="mh">0x630906A9</span><span class="p">,</span>
	<span class="mh">0xFD6D930A</span><span class="p">,</span>  <span class="mh">0x8A6AA39C</span><span class="p">,</span>  <span class="mh">0x1363F226</span><span class="p">,</span>  <span class="mh">0x6464C2B0</span><span class="p">,</span>
	<span class="mh">0xA4DEAE1D</span><span class="p">,</span>  <span class="mh">0xD3D99E8B</span><span class="p">,</span>  <span class="mh">0x4AD0CF31</span><span class="p">,</span>  <span class="mh">0x3DD7FFA7</span><span class="p">,</span>
	<span class="mh">0xA3B36A04</span><span class="p">,</span>  <span class="mh">0xD4B45A92</span><span class="p">,</span>  <span class="mh">0x4DBD0B28</span><span class="p">,</span>  <span class="mh">0x3ABA3BBE</span><span class="p">,</span>
	<span class="mh">0xAA05262F</span><span class="p">,</span>  <span class="mh">0xDD0216B9</span><span class="p">,</span>  <span class="mh">0x440B4703</span><span class="p">,</span>  <span class="mh">0x330C7795</span><span class="p">,</span>
	<span class="mh">0xAD68E236</span><span class="p">,</span>  <span class="mh">0xDA6FD2A0</span><span class="p">,</span>  <span class="mh">0x4366831A</span><span class="p">,</span>  <span class="mh">0x3461B38C</span><span class="p">,</span>
	<span class="mh">0xB969BE79</span><span class="p">,</span>  <span class="mh">0xCE6E8EEF</span><span class="p">,</span>  <span class="mh">0x5767DF55</span><span class="p">,</span>  <span class="mh">0x2060EFC3</span><span class="p">,</span>
	<span class="mh">0xBE047A60</span><span class="p">,</span>  <span class="mh">0xC9034AF6</span><span class="p">,</span>  <span class="mh">0x500A1B4C</span><span class="p">,</span>  <span class="mh">0x270D2BDA</span><span class="p">,</span>
	<span class="mh">0xB7B2364B</span><span class="p">,</span>  <span class="mh">0xC0B506DD</span><span class="p">,</span>  <span class="mh">0x59BC5767</span><span class="p">,</span>  <span class="mh">0x2EBB67F1</span><span class="p">,</span>
	<span class="mh">0xB0DFF252</span><span class="p">,</span>  <span class="mh">0xC7D8C2C4</span><span class="p">,</span>  <span class="mh">0x5ED1937E</span><span class="p">,</span>  <span class="mh">0x29D6A3E8</span><span class="p">,</span>
	<span class="mh">0x9FB08ED5</span><span class="p">,</span>  <span class="mh">0xE8B7BE43</span><span class="p">,</span>  <span class="mh">0x71BEEFF9</span><span class="p">,</span>  <span class="mh">0x06B9DF6F</span><span class="p">,</span>
	<span class="mh">0x98DD4ACC</span><span class="p">,</span>  <span class="mh">0xEFDA7A5A</span><span class="p">,</span>  <span class="mh">0x76D32BE0</span><span class="p">,</span>  <span class="mh">0x01D41B76</span><span class="p">,</span>
	<span class="mh">0x916B06E7</span><span class="p">,</span>  <span class="mh">0xE66C3671</span><span class="p">,</span>  <span class="mh">0x7F6567CB</span><span class="p">,</span>  <span class="mh">0x0862575D</span><span class="p">,</span>
	<span class="mh">0x9606C2FE</span><span class="p">,</span>  <span class="mh">0xE101F268</span><span class="p">,</span>  <span class="mh">0x7808A3D2</span><span class="p">,</span>  <span class="mh">0x0F0F9344</span><span class="p">,</span>
	<span class="mh">0x82079EB1</span><span class="p">,</span>  <span class="mh">0xF500AE27</span><span class="p">,</span>  <span class="mh">0x6C09FF9D</span><span class="p">,</span>  <span class="mh">0x1B0ECF0B</span><span class="p">,</span>
	<span class="mh">0x856A5AA8</span><span class="p">,</span>  <span class="mh">0xF26D6A3E</span><span class="p">,</span>  <span class="mh">0x6B643B84</span><span class="p">,</span>  <span class="mh">0x1C630B12</span><span class="p">,</span>
	<span class="mh">0x8CDC1683</span><span class="p">,</span>  <span class="mh">0xFBDB2615</span><span class="p">,</span>  <span class="mh">0x62D277AF</span><span class="p">,</span>  <span class="mh">0x15D54739</span><span class="p">,</span>
	<span class="mh">0x8BB1D29A</span><span class="p">,</span>  <span class="mh">0xFCB6E20C</span><span class="p">,</span>  <span class="mh">0x65BFB3B6</span><span class="p">,</span>  <span class="mh">0x12B88320</span><span class="p">,</span>
	<span class="mh">0x3FBA6CAD</span><span class="p">,</span>  <span class="mh">0x48BD5C3B</span><span class="p">,</span>  <span class="mh">0xD1B40D81</span><span class="p">,</span>  <span class="mh">0xA6B33D17</span><span class="p">,</span>
	<span class="mh">0x38D7A8B4</span><span class="p">,</span>  <span class="mh">0x4FD09822</span><span class="p">,</span>  <span class="mh">0xD6D9C998</span><span class="p">,</span>  <span class="mh">0xA1DEF90E</span><span class="p">,</span>
	<span class="mh">0x3161E49F</span><span class="p">,</span>  <span class="mh">0x4666D409</span><span class="p">,</span>  <span class="mh">0xDF6F85B3</span><span class="p">,</span>  <span class="mh">0xA868B525</span><span class="p">,</span>
	<span class="mh">0x360C2086</span><span class="p">,</span>  <span class="mh">0x410B1010</span><span class="p">,</span>  <span class="mh">0xD80241AA</span><span class="p">,</span>  <span class="mh">0xAF05713C</span><span class="p">,</span>
	<span class="mh">0x220D7CC9</span><span class="p">,</span>  <span class="mh">0x550A4C5F</span><span class="p">,</span>  <span class="mh">0xCC031DE5</span><span class="p">,</span>  <span class="mh">0xBB042D73</span><span class="p">,</span>
	<span class="mh">0x2560B8D0</span><span class="p">,</span>  <span class="mh">0x52678846</span><span class="p">,</span>  <span class="mh">0xCB6ED9FC</span><span class="p">,</span>  <span class="mh">0xBC69E96A</span><span class="p">,</span>
	<span class="mh">0x2CD6F4FB</span><span class="p">,</span>  <span class="mh">0x5BD1C46D</span><span class="p">,</span>  <span class="mh">0xC2D895D7</span><span class="p">,</span>  <span class="mh">0xB5DFA541</span><span class="p">,</span>
	<span class="mh">0x2BBB30E2</span><span class="p">,</span>  <span class="mh">0x5CBC0074</span><span class="p">,</span>  <span class="mh">0xC5B551CE</span><span class="p">,</span>  <span class="mh">0xB2B26158</span><span class="p">,</span>
	<span class="mh">0x04D44C65</span><span class="p">,</span>  <span class="mh">0x73D37CF3</span><span class="p">,</span>  <span class="mh">0xEADA2D49</span><span class="p">,</span>  <span class="mh">0x9DDD1DDF</span><span class="p">,</span>
	<span class="mh">0x03B9887C</span><span class="p">,</span>  <span class="mh">0x74BEB8EA</span><span class="p">,</span>  <span class="mh">0xEDB7E950</span><span class="p">,</span>  <span class="mh">0x9AB0D9C6</span><span class="p">,</span>
	<span class="mh">0x0A0FC457</span><span class="p">,</span>  <span class="mh">0x7D08F4C1</span><span class="p">,</span>  <span class="mh">0xE401A57B</span><span class="p">,</span>  <span class="mh">0x930695ED</span><span class="p">,</span>
	<span class="mh">0x0D62004E</span><span class="p">,</span>  <span class="mh">0x7A6530D8</span><span class="p">,</span>  <span class="mh">0xE36C6162</span><span class="p">,</span>  <span class="mh">0x946B51F4</span><span class="p">,</span>
	<span class="mh">0x19635C01</span><span class="p">,</span>  <span class="mh">0x6E646C97</span><span class="p">,</span>  <span class="mh">0xF76D3D2D</span><span class="p">,</span>  <span class="mh">0x806A0DBB</span><span class="p">,</span>
	<span class="mh">0x1E0E9818</span><span class="p">,</span>  <span class="mh">0x6909A88E</span><span class="p">,</span>  <span class="mh">0xF000F934</span><span class="p">,</span>  <span class="mh">0x8707C9A2</span><span class="p">,</span>
	<span class="mh">0x17B8D433</span><span class="p">,</span>  <span class="mh">0x60BFE4A5</span><span class="p">,</span>  <span class="mh">0xF9B6B51F</span><span class="p">,</span>  <span class="mh">0x8EB18589</span><span class="p">,</span>
	<span class="mh">0x10D5102A</span><span class="p">,</span>  <span class="mh">0x67D220BC</span><span class="p">,</span>  <span class="mh">0xFEDB7106</span><span class="p">,</span>  <span class="mh">0x89DC4190</span><span class="p">,</span>
	<span class="mh">0x49662D3D</span><span class="p">,</span>  <span class="mh">0x3E611DAB</span><span class="p">,</span>  <span class="mh">0xA7684C11</span><span class="p">,</span>  <span class="mh">0xD06F7C87</span><span class="p">,</span>
	<span class="mh">0x4E0BE924</span><span class="p">,</span>  <span class="mh">0x390CD9B2</span><span class="p">,</span>  <span class="mh">0xA0058808</span><span class="p">,</span>  <span class="mh">0xD702B89E</span><span class="p">,</span>
	<span class="mh">0x47BDA50F</span><span class="p">,</span>  <span class="mh">0x30BA9599</span><span class="p">,</span>  <span class="mh">0xA9B3C423</span><span class="p">,</span>  <span class="mh">0xDEB4F4B5</span><span class="p">,</span>
	<span class="mh">0x40D06116</span><span class="p">,</span>  <span class="mh">0x37D75180</span><span class="p">,</span>  <span class="mh">0xAEDE003A</span><span class="p">,</span>  <span class="mh">0xD9D930AC</span><span class="p">,</span>
	<span class="mh">0x54D13D59</span><span class="p">,</span>  <span class="mh">0x23D60DCF</span><span class="p">,</span>  <span class="mh">0xBADF5C75</span><span class="p">,</span>  <span class="mh">0xCDD86CE3</span><span class="p">,</span>
	<span class="mh">0x53BCF940</span><span class="p">,</span>  <span class="mh">0x24BBC9D6</span><span class="p">,</span>  <span class="mh">0xBDB2986C</span><span class="p">,</span>  <span class="mh">0xCAB5A8FA</span><span class="p">,</span>
	<span class="mh">0x5A0AB56B</span><span class="p">,</span>  <span class="mh">0x2D0D85FD</span><span class="p">,</span>  <span class="mh">0xB404D447</span><span class="p">,</span>  <span class="mh">0xC303E4D1</span><span class="p">,</span>
	<span class="mh">0x5D677172</span><span class="p">,</span>  <span class="mh">0x2A6041E4</span><span class="p">,</span>  <span class="mh">0xB369105E</span><span class="p">,</span>  <span class="mh">0xC46E20C8</span><span class="p">,</span>
	<span class="mh">0x72080DF5</span><span class="p">,</span>  <span class="mh">0x050F3D63</span><span class="p">,</span>  <span class="mh">0x9C066CD9</span><span class="p">,</span>  <span class="mh">0xEB015C4F</span><span class="p">,</span>
	<span class="mh">0x7565C9EC</span><span class="p">,</span>  <span class="mh">0x0262F97A</span><span class="p">,</span>  <span class="mh">0x9B6BA8C0</span><span class="p">,</span>  <span class="mh">0xEC6C9856</span><span class="p">,</span>
	<span class="mh">0x7CD385C7</span><span class="p">,</span>  <span class="mh">0x0BD4B551</span><span class="p">,</span>  <span class="mh">0x92DDE4EB</span><span class="p">,</span>  <span class="mh">0xE5DAD47D</span><span class="p">,</span>
	<span class="mh">0x7BBE41DE</span><span class="p">,</span>  <span class="mh">0x0CB97148</span><span class="p">,</span>  <span class="mh">0x95B020F2</span><span class="p">,</span>  <span class="mh">0xE2B71064</span><span class="p">,</span>
	<span class="mh">0x6FBF1D91</span><span class="p">,</span>  <span class="mh">0x18B82D07</span><span class="p">,</span>  <span class="mh">0x81B17CBD</span><span class="p">,</span>  <span class="mh">0xF6B64C2B</span><span class="p">,</span>
	<span class="mh">0x68D2D988</span><span class="p">,</span>  <span class="mh">0x1FD5E91E</span><span class="p">,</span>  <span class="mh">0x86DCB8A4</span><span class="p">,</span>  <span class="mh">0xF1DB8832</span><span class="p">,</span>
	<span class="mh">0x616495A3</span><span class="p">,</span>  <span class="mh">0x1663A535</span><span class="p">,</span>  <span class="mh">0x8F6AF48F</span><span class="p">,</span>  <span class="mh">0xF86DC419</span><span class="p">,</span>
	<span class="mh">0x660951BA</span><span class="p">,</span>  <span class="mh">0x110E612C</span><span class="p">,</span>  <span class="mh">0x88073096</span><span class="p">,</span>  <span class="mh">0xFF000000</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
