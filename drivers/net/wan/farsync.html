<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wan › farsync.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>farsync.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *      FarSync WAN driver for Linux (2.6.x kernel version)</span>
<span class="cm"> *</span>
<span class="cm"> *      Actually sync driver for X.21, V.35 and V.24 on FarSync T-series cards</span>
<span class="cm"> *</span>
<span class="cm"> *      Copyright (C) 2001-2004 FarSite Communications Ltd.</span>
<span class="cm"> *      www.farsite.co.uk</span>
<span class="cm"> *</span>
<span class="cm"> *      This program is free software; you can redistribute it and/or</span>
<span class="cm"> *      modify it under the terms of the GNU General Public License</span>
<span class="cm"> *      as published by the Free Software Foundation; either version</span>
<span class="cm"> *      2 of the License, or (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *      Author:      R.J.Dunlop    &lt;bob.dunlop@farsite.co.uk&gt;</span>
<span class="cm"> *      Maintainer:  Kevin Curtis  &lt;kevin.curtis@farsite.co.uk&gt;</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/version.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/if.h&gt;</span>
<span class="cp">#include &lt;linux/hdlc.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/uaccess.h&gt;</span>

<span class="cp">#include &quot;farsync.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> *      Module info</span>
<span class="cm"> */</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;R.J.Dunlop &lt;bob.dunlop@farsite.co.uk&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;FarSync T-Series WAN driver. FarSite Communications Ltd.&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cm">/*      Driver configuration and global parameters</span>
<span class="cm"> *      ==========================================</span>
<span class="cm"> */</span>

<span class="cm">/*      Number of ports (per card) and cards supported</span>
<span class="cm"> */</span>
<span class="cp">#define FST_MAX_PORTS           4</span>
<span class="cp">#define FST_MAX_CARDS           32</span>

<span class="cm">/*      Default parameters for the link</span>
<span class="cm"> */</span>
<span class="cp">#define FST_TX_QUEUE_LEN        100	</span><span class="cm">/* At 8Mbps a longer queue length is</span>
<span class="cm">					 * useful */</span><span class="cp"></span>
<span class="cp">#define FST_TXQ_DEPTH           16	</span><span class="cm">/* This one is for the buffering</span>
<span class="cm">					 * of frames on the way down to the card</span>
<span class="cm">					 * so that we can keep the card busy</span>
<span class="cm">					 * and maximise throughput</span>
<span class="cm">					 */</span><span class="cp"></span>
<span class="cp">#define FST_HIGH_WATER_MARK     12	</span><span class="cm">/* Point at which we flow control</span>
<span class="cm">					 * network layer */</span><span class="cp"></span>
<span class="cp">#define FST_LOW_WATER_MARK      8	</span><span class="cm">/* Point at which we remove flow</span>
<span class="cm">					 * control from network layer */</span><span class="cp"></span>
<span class="cp">#define FST_MAX_MTU             8000	</span><span class="cm">/* Huge but possible */</span><span class="cp"></span>
<span class="cp">#define FST_DEF_MTU             1500	</span><span class="cm">/* Common sane value */</span><span class="cp"></span>

<span class="cp">#define FST_TX_TIMEOUT          (2*HZ)</span>

<span class="cp">#ifdef ARPHRD_RAWHDLC</span>
<span class="cp">#define ARPHRD_MYTYPE   ARPHRD_RAWHDLC	</span><span class="cm">/* Raw frames */</span><span class="cp"></span>
<span class="cp">#else</span>
<span class="cp">#define ARPHRD_MYTYPE   ARPHRD_HDLC	</span><span class="cm">/* Cisco-HDLC (keepalives etc) */</span><span class="cp"></span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Modules parameters and associated variables</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fst_txq_low</span> <span class="o">=</span> <span class="n">FST_LOW_WATER_MARK</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fst_txq_high</span> <span class="o">=</span> <span class="n">FST_HIGH_WATER_MARK</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fst_max_reads</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fst_excluded_cards</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">fst_excluded_list</span><span class="p">[</span><span class="n">FST_MAX_CARDS</span><span class="p">];</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">fst_txq_low</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fst_txq_high</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fst_max_reads</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fst_excluded_cards</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">fst_excluded_list</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="cm">/*      Card shared memory layout</span>
<span class="cm"> *      =========================</span>
<span class="cm"> */</span>
<span class="cp">#pragma pack(1)</span>

<span class="cm">/*      This information is derived in part from the FarSite FarSync Smc.h</span>
<span class="cm"> *      file. Unfortunately various name clashes and the non-portability of the</span>
<span class="cm"> *      bit field declarations in that file have meant that I have chosen to</span>
<span class="cm"> *      recreate the information here.</span>
<span class="cm"> *</span>
<span class="cm"> *      The SMC (Shared Memory Configuration) has a version number that is</span>
<span class="cm"> *      incremented every time there is a significant change. This number can</span>
<span class="cm"> *      be used to check that we have not got out of step with the firmware</span>
<span class="cm"> *      contained in the .CDE files.</span>
<span class="cm"> */</span>
<span class="cp">#define SMC_VERSION 24</span>

<span class="cp">#define FST_MEMSIZE 0x100000	</span><span class="cm">/* Size of card memory (1Mb) */</span><span class="cp"></span>

<span class="cp">#define SMC_BASE 0x00002000L	</span><span class="cm">/* Base offset of the shared memory window main</span>
<span class="cm">				 * configuration structure */</span><span class="cp"></span>
<span class="cp">#define BFM_BASE 0x00010000L	</span><span class="cm">/* Base offset of the shared memory window DMA</span>
<span class="cm">				 * buffers */</span><span class="cp"></span>

<span class="cp">#define LEN_TX_BUFFER 8192	</span><span class="cm">/* Size of packet buffers */</span><span class="cp"></span>
<span class="cp">#define LEN_RX_BUFFER 8192</span>

<span class="cp">#define LEN_SMALL_TX_BUFFER 256	</span><span class="cm">/* Size of obsolete buffs used for DOS diags */</span><span class="cp"></span>
<span class="cp">#define LEN_SMALL_RX_BUFFER 256</span>

<span class="cp">#define NUM_TX_BUFFER 2		</span><span class="cm">/* Must be power of 2. Fixed by firmware */</span><span class="cp"></span>
<span class="cp">#define NUM_RX_BUFFER 8</span>

<span class="cm">/* Interrupt retry time in milliseconds */</span>
<span class="cp">#define INT_RETRY_TIME 2</span>

<span class="cm">/*      The Am186CH/CC processors support a SmartDMA mode using circular pools</span>
<span class="cm"> *      of buffer descriptors. The structure is almost identical to that used</span>
<span class="cm"> *      in the LANCE Ethernet controllers. Details available as PDF from the</span>
<span class="cm"> *      AMD web site: http://www.amd.com/products/epd/processors/\</span>
<span class="cm"> *                    2.16bitcont/3.am186cxfa/a21914/21914.pdf</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">txdesc</span> <span class="p">{</span>			<span class="cm">/* Transmit descriptor */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">ladr</span><span class="p">;</span>	<span class="cm">/* Low order address of packet. This is a</span>
<span class="cm">				 * linear address in the Am186 memory space</span>
<span class="cm">				 */</span>
	<span class="k">volatile</span> <span class="n">u8</span> <span class="n">hadr</span><span class="p">;</span>	<span class="cm">/* High order address. Low 4 bits only, high 4</span>
<span class="cm">				 * bits must be zero</span>
<span class="cm">				 */</span>
	<span class="k">volatile</span> <span class="n">u8</span> <span class="n">bits</span><span class="p">;</span>	<span class="cm">/* Status and config */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">bcnt</span><span class="p">;</span>	<span class="cm">/* 2s complement of packet size in low 15 bits.</span>
<span class="cm">				 * Transmit terminal count interrupt enable in</span>
<span class="cm">				 * top bit.</span>
<span class="cm">				 */</span>
	<span class="n">u16</span> <span class="n">unused</span><span class="p">;</span>		<span class="cm">/* Not used in Tx */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">rxdesc</span> <span class="p">{</span>			<span class="cm">/* Receive descriptor */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">ladr</span><span class="p">;</span>	<span class="cm">/* Low order address of packet */</span>
	<span class="k">volatile</span> <span class="n">u8</span> <span class="n">hadr</span><span class="p">;</span>	<span class="cm">/* High order address */</span>
	<span class="k">volatile</span> <span class="n">u8</span> <span class="n">bits</span><span class="p">;</span>	<span class="cm">/* Status and config */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">bcnt</span><span class="p">;</span>	<span class="cm">/* 2s complement of buffer size in low 15 bits.</span>
<span class="cm">				 * Receive terminal count interrupt enable in</span>
<span class="cm">				 * top bit.</span>
<span class="cm">				 */</span>
	<span class="k">volatile</span> <span class="n">u16</span> <span class="n">mcnt</span><span class="p">;</span>	<span class="cm">/* Message byte count (15 bits) */</span>
<span class="p">};</span>

<span class="cm">/* Convert a length into the 15 bit 2&#39;s complement */</span>
<span class="cm">/* #define cnv_bcnt(len)   (( ~(len) + 1 ) &amp; 0x7FFF ) */</span>
<span class="cm">/* Since we need to set the high bit to enable the completion interrupt this</span>
<span class="cm"> * can be made a lot simpler</span>
<span class="cm"> */</span>
<span class="cp">#define cnv_bcnt(len)   (-(len))</span>

<span class="cm">/* Status and config bits for the above */</span>
<span class="cp">#define DMA_OWN         0x80	</span><span class="cm">/* SmartDMA owns the descriptor */</span><span class="cp"></span>
<span class="cp">#define TX_STP          0x02	</span><span class="cm">/* Tx: start of packet */</span><span class="cp"></span>
<span class="cp">#define TX_ENP          0x01	</span><span class="cm">/* Tx: end of packet */</span><span class="cp"></span>
<span class="cp">#define RX_ERR          0x40	</span><span class="cm">/* Rx: error (OR of next 4 bits) */</span><span class="cp"></span>
<span class="cp">#define RX_FRAM         0x20	</span><span class="cm">/* Rx: framing error */</span><span class="cp"></span>
<span class="cp">#define RX_OFLO         0x10	</span><span class="cm">/* Rx: overflow error */</span><span class="cp"></span>
<span class="cp">#define RX_CRC          0x08	</span><span class="cm">/* Rx: CRC error */</span><span class="cp"></span>
<span class="cp">#define RX_HBUF         0x04	</span><span class="cm">/* Rx: buffer error */</span><span class="cp"></span>
<span class="cp">#define RX_STP          0x02	</span><span class="cm">/* Rx: start of packet */</span><span class="cp"></span>
<span class="cp">#define RX_ENP          0x01	</span><span class="cm">/* Rx: end of packet */</span><span class="cp"></span>

<span class="cm">/* Interrupts from the card are caused by various events which are presented</span>
<span class="cm"> * in a circular buffer as several events may be processed on one physical int</span>
<span class="cm"> */</span>
<span class="cp">#define MAX_CIRBUFF     32</span>

<span class="k">struct</span> <span class="n">cirbuff</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">rdindex</span><span class="p">;</span>		<span class="cm">/* read, then increment and wrap */</span>
	<span class="n">u8</span> <span class="n">wrindex</span><span class="p">;</span>		<span class="cm">/* write, then increment and wrap */</span>
	<span class="n">u8</span> <span class="n">evntbuff</span><span class="p">[</span><span class="n">MAX_CIRBUFF</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Interrupt event codes.</span>
<span class="cm"> * Where appropriate the two low order bits indicate the port number</span>
<span class="cm"> */</span>
<span class="cp">#define CTLA_CHG        0x18	</span><span class="cm">/* Control signal changed */</span><span class="cp"></span>
<span class="cp">#define CTLB_CHG        0x19</span>
<span class="cp">#define CTLC_CHG        0x1A</span>
<span class="cp">#define CTLD_CHG        0x1B</span>

<span class="cp">#define INIT_CPLT       0x20	</span><span class="cm">/* Initialisation complete */</span><span class="cp"></span>
<span class="cp">#define INIT_FAIL       0x21	</span><span class="cm">/* Initialisation failed */</span><span class="cp"></span>

<span class="cp">#define ABTA_SENT       0x24	</span><span class="cm">/* Abort sent */</span><span class="cp"></span>
<span class="cp">#define ABTB_SENT       0x25</span>
<span class="cp">#define ABTC_SENT       0x26</span>
<span class="cp">#define ABTD_SENT       0x27</span>

<span class="cp">#define TXA_UNDF        0x28	</span><span class="cm">/* Transmission underflow */</span><span class="cp"></span>
<span class="cp">#define TXB_UNDF        0x29</span>
<span class="cp">#define TXC_UNDF        0x2A</span>
<span class="cp">#define TXD_UNDF        0x2B</span>

<span class="cp">#define F56_INT         0x2C</span>
<span class="cp">#define M32_INT         0x2D</span>

<span class="cp">#define TE1_ALMA        0x30</span>

<span class="cm">/* Port physical configuration. See farsync.h for field values */</span>
<span class="k">struct</span> <span class="n">port_cfg</span> <span class="p">{</span>
	<span class="n">u16</span> <span class="n">lineInterface</span><span class="p">;</span>	<span class="cm">/* Physical interface type */</span>
	<span class="n">u8</span> <span class="n">x25op</span><span class="p">;</span>		<span class="cm">/* Unused at present */</span>
	<span class="n">u8</span> <span class="n">internalClock</span><span class="p">;</span>	<span class="cm">/* 1 =&gt; internal clock, 0 =&gt; external */</span>
	<span class="n">u8</span> <span class="n">transparentMode</span><span class="p">;</span>	<span class="cm">/* 1 =&gt; on, 0 =&gt; off */</span>
	<span class="n">u8</span> <span class="n">invertClock</span><span class="p">;</span>		<span class="cm">/* 0 =&gt; normal, 1 =&gt; inverted */</span>
	<span class="n">u8</span> <span class="n">padBytes</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>		<span class="cm">/* Padding */</span>
	<span class="n">u32</span> <span class="n">lineSpeed</span><span class="p">;</span>		<span class="cm">/* Speed in bps */</span>
<span class="p">};</span>

<span class="cm">/* TE1 port physical configuration */</span>
<span class="k">struct</span> <span class="n">su_config</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">dataRate</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">clocking</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">framing</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">structure</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">interface</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">coding</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lineBuildOut</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">equalizer</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">transparentMode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">loopMode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">range</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">txBufferMode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rxBufferMode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">startingSlot</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">losThreshold</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">enableIdleCode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">idleCode</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">spare</span><span class="p">[</span><span class="mi">44</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* TE1 Status */</span>
<span class="k">struct</span> <span class="n">su_status</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">receiveBufferDelay</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">framingErrorCount</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">codeViolationCount</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crcErrorCount</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">lineAttenuation</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">portStarted</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lossOfSignal</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">receiveRemoteAlarm</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">alarmIndicationSignal</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">spare</span><span class="p">[</span><span class="mi">40</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Finally sling all the above together into the shared memory structure.</span>
<span class="cm"> * Sorry it&#39;s a hodge podge of arrays, structures and unused bits, it&#39;s been</span>
<span class="cm"> * evolving under NT for some time so I guess we&#39;re stuck with it.</span>
<span class="cm"> * The structure starts at offset SMC_BASE.</span>
<span class="cm"> * See farsync.h for some field values.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fst_shared</span> <span class="p">{</span>
	<span class="cm">/* DMA descriptor rings */</span>
	<span class="k">struct</span> <span class="n">rxdesc</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">][</span><span class="n">NUM_RX_BUFFER</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">txdesc</span> <span class="n">txDescrRing</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">][</span><span class="n">NUM_TX_BUFFER</span><span class="p">];</span>

	<span class="cm">/* Obsolete small buffers */</span>
	<span class="n">u8</span> <span class="n">smallRxBuffer</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">][</span><span class="n">NUM_RX_BUFFER</span><span class="p">][</span><span class="n">LEN_SMALL_RX_BUFFER</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">smallTxBuffer</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">][</span><span class="n">NUM_TX_BUFFER</span><span class="p">][</span><span class="n">LEN_SMALL_TX_BUFFER</span><span class="p">];</span>

	<span class="n">u8</span> <span class="n">taskStatus</span><span class="p">;</span>		<span class="cm">/* 0x00 =&gt; initialising, 0x01 =&gt; running,</span>
<span class="cm">				 * 0xFF =&gt; halted</span>
<span class="cm">				 */</span>

	<span class="n">u8</span> <span class="n">interruptHandshake</span><span class="p">;</span>	<span class="cm">/* Set to 0x01 by adapter to signal interrupt,</span>
<span class="cm">				 * set to 0xEE by host to acknowledge interrupt</span>
<span class="cm">				 */</span>

	<span class="n">u16</span> <span class="n">smcVersion</span><span class="p">;</span>		<span class="cm">/* Must match SMC_VERSION */</span>

	<span class="n">u32</span> <span class="n">smcFirmwareVersion</span><span class="p">;</span>	<span class="cm">/* 0xIIVVRRBB where II = product ID, VV = major</span>
<span class="cm">				 * version, RR = revision and BB = build</span>
<span class="cm">				 */</span>

	<span class="n">u16</span> <span class="n">txa_done</span><span class="p">;</span>		<span class="cm">/* Obsolete completion flags */</span>
	<span class="n">u16</span> <span class="n">rxa_done</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txb_done</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rxb_done</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txc_done</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rxc_done</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">txd_done</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">rxd_done</span><span class="p">;</span>

	<span class="n">u16</span> <span class="n">mailbox</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>		<span class="cm">/* Diagnostics mailbox. Not used */</span>

	<span class="k">struct</span> <span class="n">cirbuff</span> <span class="n">interruptEvent</span><span class="p">;</span>	<span class="cm">/* interrupt causes */</span>

	<span class="n">u32</span> <span class="n">v24IpSts</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">];</span>	<span class="cm">/* V.24 control input status */</span>
	<span class="n">u32</span> <span class="n">v24OpSts</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">];</span>	<span class="cm">/* V.24 control output status */</span>

	<span class="k">struct</span> <span class="n">port_cfg</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">];</span>

	<span class="n">u16</span> <span class="n">clockStatus</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">];</span>	<span class="cm">/* lsb: 0=&gt; present, 1=&gt; absent */</span>

	<span class="n">u16</span> <span class="n">cableStatus</span><span class="p">;</span>	<span class="cm">/* lsb: 0=&gt; present, 1=&gt; absent */</span>

	<span class="n">u16</span> <span class="n">txDescrIndex</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">];</span>	<span class="cm">/* transmit descriptor ring index */</span>
	<span class="n">u16</span> <span class="n">rxDescrIndex</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">];</span>	<span class="cm">/* receive descriptor ring index */</span>

	<span class="n">u16</span> <span class="n">portMailbox</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>	<span class="cm">/* command, modifier */</span>
	<span class="n">u16</span> <span class="n">cardMailbox</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>	<span class="cm">/* Not used */</span>

	<span class="cm">/* Number of times the card thinks the host has</span>
<span class="cm">	 * missed an interrupt by not acknowledging</span>
<span class="cm">	 * within 2mS (I guess NT has problems)</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">interruptRetryCount</span><span class="p">;</span>

	<span class="cm">/* Driver private data used as an ID. We&#39;ll not</span>
<span class="cm">	 * use this as I&#39;d rather keep such things</span>
<span class="cm">	 * in main memory rather than on the PCI bus</span>
<span class="cm">	 */</span>
	<span class="n">u32</span> <span class="n">portHandle</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">];</span>

	<span class="cm">/* Count of Tx underflows for stats */</span>
	<span class="n">u32</span> <span class="n">transmitBufferUnderflow</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">];</span>

	<span class="cm">/* Debounced V.24 control input status */</span>
	<span class="n">u32</span> <span class="n">v24DebouncedSts</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">];</span>

	<span class="cm">/* Adapter debounce timers. Don&#39;t touch */</span>
	<span class="n">u32</span> <span class="n">ctsTimer</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">ctsTimerRun</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">dcdTimer</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">dcdTimerRun</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">];</span>

	<span class="n">u32</span> <span class="n">numberOfPorts</span><span class="p">;</span>	<span class="cm">/* Number of ports detected at startup */</span>

	<span class="n">u16</span> <span class="n">_reserved</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>

	<span class="n">u16</span> <span class="n">cardMode</span><span class="p">;</span>		<span class="cm">/* Bit-mask to enable features:</span>
<span class="cm">				 * Bit 0: 1 enables LED identify mode</span>
<span class="cm">				 */</span>

	<span class="n">u16</span> <span class="n">portScheduleOffset</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">su_config</span> <span class="n">suConfig</span><span class="p">;</span>	<span class="cm">/* TE1 Bits */</span>
	<span class="k">struct</span> <span class="n">su_status</span> <span class="n">suStatus</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">endOfSmcSignature</span><span class="p">;</span>	<span class="cm">/* endOfSmcSignature MUST be the last member of</span>
<span class="cm">				 * the structure and marks the end of shared</span>
<span class="cm">				 * memory. Adapter code initializes it as</span>
<span class="cm">				 * END_SIG.</span>
<span class="cm">				 */</span>
<span class="p">};</span>

<span class="cm">/* endOfSmcSignature value */</span>
<span class="cp">#define END_SIG                 0x12345678</span>

<span class="cm">/* Mailbox values. (portMailbox) */</span>
<span class="cp">#define NOP             0	</span><span class="cm">/* No operation */</span><span class="cp"></span>
<span class="cp">#define ACK             1	</span><span class="cm">/* Positive acknowledgement to PC driver */</span><span class="cp"></span>
<span class="cp">#define NAK             2	</span><span class="cm">/* Negative acknowledgement to PC driver */</span><span class="cp"></span>
<span class="cp">#define STARTPORT       3	</span><span class="cm">/* Start an HDLC port */</span><span class="cp"></span>
<span class="cp">#define STOPPORT        4	</span><span class="cm">/* Stop an HDLC port */</span><span class="cp"></span>
<span class="cp">#define ABORTTX         5	</span><span class="cm">/* Abort the transmitter for a port */</span><span class="cp"></span>
<span class="cp">#define SETV24O         6	</span><span class="cm">/* Set V24 outputs */</span><span class="cp"></span>

<span class="cm">/* PLX Chip Register Offsets */</span>
<span class="cp">#define CNTRL_9052      0x50	</span><span class="cm">/* Control Register */</span><span class="cp"></span>
<span class="cp">#define CNTRL_9054      0x6c	</span><span class="cm">/* Control Register */</span><span class="cp"></span>

<span class="cp">#define INTCSR_9052     0x4c	</span><span class="cm">/* Interrupt control/status register */</span><span class="cp"></span>
<span class="cp">#define INTCSR_9054     0x68	</span><span class="cm">/* Interrupt control/status register */</span><span class="cp"></span>

<span class="cm">/* 9054 DMA Registers */</span>
<span class="cm">/*</span>
<span class="cm"> * Note that we will be using DMA Channel 0 for copying rx data</span>
<span class="cm"> * and Channel 1 for copying tx data</span>
<span class="cm"> */</span>
<span class="cp">#define DMAMODE0        0x80</span>
<span class="cp">#define DMAPADR0        0x84</span>
<span class="cp">#define DMALADR0        0x88</span>
<span class="cp">#define DMASIZ0         0x8c</span>
<span class="cp">#define DMADPR0         0x90</span>
<span class="cp">#define DMAMODE1        0x94</span>
<span class="cp">#define DMAPADR1        0x98</span>
<span class="cp">#define DMALADR1        0x9c</span>
<span class="cp">#define DMASIZ1         0xa0</span>
<span class="cp">#define DMADPR1         0xa4</span>
<span class="cp">#define DMACSR0         0xa8</span>
<span class="cp">#define DMACSR1         0xa9</span>
<span class="cp">#define DMAARB          0xac</span>
<span class="cp">#define DMATHR          0xb0</span>
<span class="cp">#define DMADAC0         0xb4</span>
<span class="cp">#define DMADAC1         0xb8</span>
<span class="cp">#define DMAMARBR        0xac</span>

<span class="cp">#define FST_MIN_DMA_LEN 64</span>
<span class="cp">#define FST_RX_DMA_INT  0x01</span>
<span class="cp">#define FST_TX_DMA_INT  0x02</span>
<span class="cp">#define FST_CARD_INT    0x04</span>

<span class="cm">/* Larger buffers are positioned in memory at offset BFM_BASE */</span>
<span class="k">struct</span> <span class="n">buf_window</span> <span class="p">{</span>
	<span class="n">u8</span> <span class="n">txBuffer</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">][</span><span class="n">NUM_TX_BUFFER</span><span class="p">][</span><span class="n">LEN_TX_BUFFER</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">rxBuffer</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">][</span><span class="n">NUM_RX_BUFFER</span><span class="p">][</span><span class="n">LEN_RX_BUFFER</span><span class="p">];</span>
<span class="p">};</span>

<span class="cm">/* Calculate offset of a buffer object within the shared memory window */</span>
<span class="cp">#define BUF_OFFSET(X)   (BFM_BASE + offsetof(struct buf_window, X))</span>

<span class="cp">#pragma pack()</span>

<span class="cm">/*      Device driver private information</span>
<span class="cm"> *      =================================</span>
<span class="cm"> */</span>
<span class="cm">/*      Per port (line or channel) information</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fst_port_info</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span> <span class="cm">/* Device struct - must be first */</span>
	<span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>	<span class="cm">/* Card we&#39;re associated with */</span>
	<span class="kt">int</span> <span class="n">index</span><span class="p">;</span>		<span class="cm">/* Port index on the card */</span>
	<span class="kt">int</span> <span class="n">hwif</span><span class="p">;</span>		<span class="cm">/* Line hardware (lineInterface copy) */</span>
	<span class="kt">int</span> <span class="n">run</span><span class="p">;</span>		<span class="cm">/* Port is running */</span>
	<span class="kt">int</span> <span class="n">mode</span><span class="p">;</span>		<span class="cm">/* Normal or FarSync raw */</span>
	<span class="kt">int</span> <span class="n">rxpos</span><span class="p">;</span>		<span class="cm">/* Next Rx buffer to use */</span>
	<span class="kt">int</span> <span class="n">txpos</span><span class="p">;</span>		<span class="cm">/* Next Tx buffer to use */</span>
	<span class="kt">int</span> <span class="n">txipos</span><span class="p">;</span>		<span class="cm">/* Next Tx buffer to check for free */</span>
	<span class="kt">int</span> <span class="n">start</span><span class="p">;</span>		<span class="cm">/* Indication of start/stop to network */</span>
	<span class="cm">/*</span>
<span class="cm">	 * A sixteen entry transmit queue</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="n">txqs</span><span class="p">;</span>		<span class="cm">/* index to get next buffer to tx */</span>
	<span class="kt">int</span> <span class="n">txqe</span><span class="p">;</span>		<span class="cm">/* index to queue next packet */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">txq</span><span class="p">[</span><span class="n">FST_TXQ_DEPTH</span><span class="p">];</span>	<span class="cm">/* The queue */</span>
	<span class="kt">int</span> <span class="n">rxqdepth</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*      Per card information</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">fst_card_info</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>	<span class="cm">/* Card memory mapped to kernel space */</span>
	<span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">ctlmem</span><span class="p">;</span>	<span class="cm">/* Control memory for PCI cards */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phys_mem</span><span class="p">;</span>	<span class="cm">/* Physical memory window address */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">phys_ctlmem</span><span class="p">;</span>	<span class="cm">/* Physical control memory address */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">;</span>	<span class="cm">/* Interrupt request line number */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">nports</span><span class="p">;</span>	<span class="cm">/* Number of serial ports */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">;</span>	<span class="cm">/* Type index of card */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>	<span class="cm">/* State of card */</span>
	<span class="n">spinlock_t</span> <span class="n">card_lock</span><span class="p">;</span>	<span class="cm">/* Lock for SMP access */</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">pci_conf</span><span class="p">;</span>	<span class="cm">/* PCI card config in I/O space */</span>
	<span class="cm">/* Per port info */</span>
	<span class="k">struct</span> <span class="n">fst_port_info</span> <span class="n">ports</span><span class="p">[</span><span class="n">FST_MAX_PORTS</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>	<span class="cm">/* Information about the pci device */</span>
	<span class="kt">int</span> <span class="n">card_no</span><span class="p">;</span>		<span class="cm">/* Inst of the card on the system */</span>
	<span class="kt">int</span> <span class="n">family</span><span class="p">;</span>		<span class="cm">/* TxP or TxU */</span>
	<span class="kt">int</span> <span class="n">dmarx_in_progress</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dmatx_in_progress</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">int_count</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">int_time_ave</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">rx_dma_handle_host</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">rx_dma_handle_card</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">tx_dma_handle_host</span><span class="p">;</span>
	<span class="n">dma_addr_t</span> <span class="n">tx_dma_handle_card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">dma_skb_rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">dma_port_rx</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">dma_port_tx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_len_rx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_len_tx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_txpos</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dma_rxpos</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Convert an HDLC device pointer into a port info pointer and similar */</span>
<span class="cp">#define dev_to_port(D)  (dev_to_hdlc(D)-&gt;priv)</span>
<span class="cp">#define port_to_dev(P)  ((P)-&gt;dev)</span>


<span class="cm">/*</span>
<span class="cm"> *      Shared memory window access macros</span>
<span class="cm"> *</span>
<span class="cm"> *      We have a nice memory based structure above, which could be directly</span>
<span class="cm"> *      mapped on i386 but might not work on other architectures unless we use</span>
<span class="cm"> *      the readb,w,l and writeb,w,l macros. Unfortunately these macros take</span>
<span class="cm"> *      physical offsets so we have to convert. The only saving grace is that</span>
<span class="cm"> *      this should all collapse back to a simple indirection eventually.</span>
<span class="cm"> */</span>
<span class="cp">#define WIN_OFFSET(X)   ((long)&amp;(((struct fst_shared *)SMC_BASE)-&gt;X))</span>

<span class="cp">#define FST_RDB(C,E)    readb ((C)-&gt;mem + WIN_OFFSET(E))</span>
<span class="cp">#define FST_RDW(C,E)    readw ((C)-&gt;mem + WIN_OFFSET(E))</span>
<span class="cp">#define FST_RDL(C,E)    readl ((C)-&gt;mem + WIN_OFFSET(E))</span>

<span class="cp">#define FST_WRB(C,E,B)  writeb ((B), (C)-&gt;mem + WIN_OFFSET(E))</span>
<span class="cp">#define FST_WRW(C,E,W)  writew ((W), (C)-&gt;mem + WIN_OFFSET(E))</span>
<span class="cp">#define FST_WRL(C,E,L)  writel ((L), (C)-&gt;mem + WIN_OFFSET(E))</span>

<span class="cm">/*</span>
<span class="cm"> *      Debug support</span>
<span class="cm"> */</span>
<span class="cp">#if FST_DEBUG</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">fst_debug_mask</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FST_DEBUG</span> <span class="p">};</span>

<span class="cm">/* Most common debug activity is to print something if the corresponding bit</span>
<span class="cm"> * is set in the debug mask. Note: this uses a non-ANSI extension in GCC to</span>
<span class="cm"> * support variable numbers of macro parameters. The inverted if prevents us</span>
<span class="cm"> * eating someone else&#39;s else clause.</span>
<span class="cm"> */</span>
<span class="cp">#define dbg(F, fmt, args...)					\</span>
<span class="cp">do {								\</span>
<span class="cp">	if (fst_debug_mask &amp; (F))				\</span>
<span class="cp">		printk(KERN_DEBUG pr_fmt(fmt), ##args);		\</span>
<span class="cp">} while (0)</span>
<span class="cp">#else</span>
<span class="cp">#define dbg(F, fmt, args...)					\</span>
<span class="cp">do {								\</span>
<span class="cp">	if (0)							\</span>
<span class="cp">		printk(KERN_DEBUG pr_fmt(fmt), ##args);		\</span>
<span class="cp">} while (0)</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> *      PCI ID lookup table</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_PCI_DEVICE_TABLE</span><span class="p">(</span><span class="n">fst_pci_dev_id</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="n">PCI_VENDOR_ID_FARSITE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FARSITE_T2P</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> 
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FST_TYPE_T2P</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_FARSITE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FARSITE_T4P</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> 
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FST_TYPE_T4P</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_FARSITE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FARSITE_T1U</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> 
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FST_TYPE_T1U</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_FARSITE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FARSITE_T2U</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> 
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FST_TYPE_T2U</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_FARSITE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FARSITE_T4U</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> 
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FST_TYPE_T4U</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_FARSITE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FARSITE_TE1</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> 
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FST_TYPE_TE1</span><span class="p">},</span>

	<span class="p">{</span><span class="n">PCI_VENDOR_ID_FARSITE</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_FARSITE_TE1C</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span> 
	 <span class="n">PCI_ANY_ID</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">FST_TYPE_TE1</span><span class="p">},</span>
	<span class="p">{</span><span class="mi">0</span><span class="p">,}</span>			<span class="cm">/* End */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">fst_pci_dev_id</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> *      Device Driver Work Queues</span>
<span class="cm"> *</span>
<span class="cm"> *      So that we don&#39;t spend too much time processing events in the </span>
<span class="cm"> *      Interrupt Service routine, we will declare a work queue per Card </span>
<span class="cm"> *      and make the ISR schedule a task in the queue for later execution.</span>
<span class="cm"> *      In the 2.4 Kernel we used to use the immediate queue for BH&#39;s</span>
<span class="cm"> *      Now that they are gone, tasklets seem to be much better than work </span>
<span class="cm"> *      queues.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">do_bottom_half_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">do_bottom_half_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fst_process_tx_work_q</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">work_q</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">fst_process_int_work_q</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">work_q</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DECLARE_TASKLET</span><span class="p">(</span><span class="n">fst_tx_task</span><span class="p">,</span> <span class="n">fst_process_tx_work_q</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DECLARE_TASKLET</span><span class="p">(</span><span class="n">fst_int_task</span><span class="p">,</span> <span class="n">fst_process_int_work_q</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">fst_card_array</span><span class="p">[</span><span class="n">FST_MAX_CARDS</span><span class="p">];</span>
<span class="k">static</span> <span class="n">spinlock_t</span> <span class="n">fst_work_q_lock</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">fst_work_txq</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">fst_work_intq</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_q_work_item</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span> <span class="n">queue</span><span class="p">,</span> <span class="kt">int</span> <span class="n">card_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">mask</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Grab the queue exclusively</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_work_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Making an entry in the queue is simply a matter of setting</span>
<span class="cm">	 * a bit for the card indicating that there is work to do in the</span>
<span class="cm">	 * bottom half for the card.  Note the limitation of 64 cards.</span>
<span class="cm">	 * That ought to be enough</span>
<span class="cm">	 */</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">card_index</span><span class="p">;</span>
	<span class="o">*</span><span class="n">queue</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_work_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_process_tx_work_q</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="cm">/*void **/</span><span class="n">work_q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">work_txq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Grab the queue exclusively</span>
<span class="cm">	 */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;fst_process_tx_work_q</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_work_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">work_txq</span> <span class="o">=</span> <span class="n">fst_work_txq</span><span class="p">;</span>
	<span class="n">fst_work_txq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_work_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Call the bottom half for each card with work waiting</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FST_MAX_CARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">work_txq</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fst_card_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;Calling tx bh for card %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">do_bottom_half_tx</span><span class="p">(</span><span class="n">fst_card_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">work_txq</span> <span class="o">=</span> <span class="n">work_txq</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_process_int_work_q</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="cm">/*void **/</span><span class="n">work_q</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">work_intq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Grab the queue exclusively</span>
<span class="cm">	 */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;fst_process_int_work_q</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_work_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">work_intq</span> <span class="o">=</span> <span class="n">fst_work_intq</span><span class="p">;</span>
	<span class="n">fst_work_intq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_work_q_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Call the bottom half for each card with work waiting</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FST_MAX_CARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">work_intq</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">fst_card_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span>
				    <span class="s">&quot;Calling rx &amp; tx bh for card %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="n">do_bottom_half_rx</span><span class="p">(</span><span class="n">fst_card_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">do_bottom_half_tx</span><span class="p">(</span><span class="n">fst_card_array</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">work_intq</span> <span class="o">=</span> <span class="n">work_intq</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*      Card control functions</span>
<span class="cm"> *      ======================</span>
<span class="cm"> */</span>
<span class="cm">/*      Place the processor in reset state</span>
<span class="cm"> *</span>
<span class="cm"> * Used to be a simple write to card control space but a glitch in the latest</span>
<span class="cm"> * AMD Am186CH processor means that we now have to do it by asserting and de-</span>
<span class="cm"> * asserting the PLX chip PCI Adapter Software Reset. Bit 30 in CNTRL register</span>
<span class="cm"> * at offset 9052_CNTRL.  Note the updates for the TXU.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fst_cpureset</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">interrupt_line_register</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">j</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">regval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">FST_FAMILY_TXU</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pci_read_config_byte</span>
		    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">interrupt_line_register</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span>
			    <span class="s">&quot;Error in reading interrupt line register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * Assert PLX software reset and Am186 hardware reset</span>
<span class="cm">		 * and then deassert the PLX software reset but 186 still in reset</span>
<span class="cm">		 */</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x440f</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">CNTRL_9054</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x040f</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">CNTRL_9054</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * We are delaying here to allow the 9054 to reset itself</span>
<span class="cm">		 */</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">)</span>
			<span class="cm">/* Do nothing */</span> <span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x240f</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">CNTRL_9054</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * We are delaying here to allow the 9054 to reload its eeprom</span>
<span class="cm">		 */</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">jiffies</span> <span class="o">&lt;</span> <span class="n">j</span><span class="p">)</span>
			<span class="cm">/* Do nothing */</span> <span class="p">;</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x040f</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">CNTRL_9054</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pci_write_config_byte</span>
		    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">PCI_INTERRUPT_LINE</span><span class="p">,</span> <span class="n">interrupt_line_register</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span>
			    <span class="s">&quot;Error in writing interrupt line register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">regval</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">CNTRL_9052</span><span class="p">);</span>

		<span class="n">outl</span><span class="p">(</span><span class="n">regval</span> <span class="o">|</span> <span class="mh">0x40000000</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">CNTRL_9052</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="n">regval</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x40000000</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">CNTRL_9052</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*      Release the processor from reset</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fst_cpurelease</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">FST_FAMILY_TXU</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Force posted writes to complete</span>
<span class="cm">		 */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Release LRESET DO = 1</span>
<span class="cm">		 * Then release Local Hold, DO = 1</span>
<span class="cm">		 */</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x040e</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">CNTRL_9054</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x040f</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">CNTRL_9054</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ctlmem</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*      Clear the cards interrupt flag</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fst_clear_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">FST_FAMILY_TXU</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="n">readb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ctlmem</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Poke the appropriate PLX chip register (same as enabling interrupts)</span>
<span class="cm">		 */</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x0543</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">INTCSR_9052</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*      Enable card interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fst_enable_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">FST_FAMILY_TXU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="mh">0x0f0c0900</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">INTCSR_9054</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x0543</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">INTCSR_9052</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*      Disable card interrupts</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fst_disable_intr</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">FST_FAMILY_TXU</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">outl</span><span class="p">(</span><span class="mh">0x00000000</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">INTCSR_9054</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">outw</span><span class="p">(</span><span class="mh">0x0000</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">INTCSR_9052</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*      Process the result of trying to pass a received frame up the stack</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_process_rx_status</span><span class="p">(</span><span class="kt">int</span> <span class="n">rx_status</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">rx_status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">NET_RX_SUCCESS</span>:
		<span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Nothing to do here</span>
<span class="cm">			 */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">case</span> <span class="n">NET_RX_DROP</span>:
		<span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;%s: Received packet dropped</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*      Initilaise DMA for PLX 9054</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fst_init_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is only required for the PLX 9054</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">FST_FAMILY_TXU</span><span class="p">)</span> <span class="p">{</span>
	        <span class="n">pci_set_master</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="mh">0x00020441</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMAMODE0</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="mh">0x00020441</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMAMODE1</span><span class="p">);</span>
		<span class="n">outl</span><span class="p">(</span><span class="mh">0x0</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMATHR</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*      Tx dma complete interrupt</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_tx_dma_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">int</span> <span class="n">txpos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Everything is now set, just tell the card to go</span>
<span class="cm">	 */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;fst_tx_dma_complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">txDescrRing</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="n">txpos</span><span class="p">].</span><span class="n">bits</span><span class="p">,</span>
		<span class="n">DMA_OWN</span> <span class="o">|</span> <span class="n">TX_STP</span> <span class="o">|</span> <span class="n">TX_ENP</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Mark it for our own raw sockets interface</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">__be16</span> <span class="nf">farsync_type_trans</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">pkt_type</span> <span class="o">=</span> <span class="n">PACKET_HOST</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">htons</span><span class="p">(</span><span class="n">ETH_P_CUST</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*      Rx dma complete interrupt</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_rx_dma_complete</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
		    <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rxp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">pi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_status</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;fst_rx_dma_complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pi</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_dma_handle_host</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Reset buffer descriptor */</span>
	<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">rxp</span><span class="p">].</span><span class="n">bits</span><span class="p">,</span> <span class="n">DMA_OWN</span><span class="p">);</span>

	<span class="cm">/* Update stats */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="cm">/* Push upstream */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_RX</span><span class="p">,</span> <span class="s">&quot;Pushing the frame up the stack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FST_RAW</span><span class="p">)</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">farsync_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">hdlc_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">rx_status</span> <span class="o">=</span> <span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">fst_process_rx_status</span><span class="p">(</span><span class="n">rx_status</span><span class="p">,</span> <span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">==</span> <span class="n">NET_RX_DROP</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *      Receive a frame through the DMA</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fst_rx_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">dma_addr_t</span> <span class="n">skb</span><span class="p">,</span>
	   <span class="n">dma_addr_t</span> <span class="n">mem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This routine will setup the DMA and start it</span>
<span class="cm">	 */</span>

	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_RX</span><span class="p">,</span> <span class="s">&quot;In fst_rx_dma %lx %lx %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mem</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dmarx_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;In fst_rx_dma while dma in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outl</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMAPADR0</span><span class="p">);</span>	<span class="cm">/* Copy to here */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">mem</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMALADR0</span><span class="p">);</span>	<span class="cm">/* from here */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMASIZ0</span><span class="p">);</span>	<span class="cm">/* for this length */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x00000000c</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMADPR0</span><span class="p">);</span>	<span class="cm">/* In this direction */</span>

	<span class="cm">/*</span>
<span class="cm">	 * We use the dmarx_in_progress flag to flag the channel as busy</span>
<span class="cm">	 */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dmarx_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMACSR0</span><span class="p">);</span>	<span class="cm">/* Start the transfer */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *      Send a frame through the DMA</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fst_tx_dma</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
	   <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">mem</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * This routine will setup the DMA and start it.</span>
<span class="cm">	 */</span>

	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;In fst_tx_dma %p %p %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dmatx_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;In fst_tx_dma while dma in progress</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">outl</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">skb</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMAPADR1</span><span class="p">);</span>	<span class="cm">/* Copy from here */</span>
	<span class="n">outl</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="n">mem</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMALADR1</span><span class="p">);</span>	<span class="cm">/* to here */</span>
	<span class="n">outl</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMASIZ1</span><span class="p">);</span>	<span class="cm">/* for this length */</span>
	<span class="n">outl</span><span class="p">(</span><span class="mh">0x000000004</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMADPR1</span><span class="p">);</span>	<span class="cm">/* In this direction */</span>

	<span class="cm">/*</span>
<span class="cm">	 * We use the dmatx_in_progress to flag the channel as busy</span>
<span class="cm">	 */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">dmatx_in_progress</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">outb</span><span class="p">(</span><span class="mh">0x03</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMACSR1</span><span class="p">);</span>	<span class="cm">/* Start the transfer */</span>
<span class="p">}</span>

<span class="cm">/*      Issue a Mailbox command for a port.</span>
<span class="cm"> *      Note we issue them on a fire and forget basis, not expecting to see an</span>
<span class="cm"> *      error and not waiting for completion.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_issue_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mbval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">safety</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">mbval</span> <span class="o">=</span> <span class="n">FST_RDW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portMailbox</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>

	<span class="n">safety</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="cm">/* Wait for any previous command to complete */</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">mbval</span> <span class="o">&gt;</span> <span class="n">NAK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">schedule_timeout_uninterruptible</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">safety</span> <span class="o">&gt;</span> <span class="mi">2000</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Mailbox safety timeout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">mbval</span> <span class="o">=</span> <span class="n">FST_RDW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portMailbox</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">safety</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_CMD</span><span class="p">,</span> <span class="s">&quot;Mailbox clear after %d jiffies</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">safety</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mbval</span> <span class="o">==</span> <span class="n">NAK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_CMD</span><span class="p">,</span> <span class="s">&quot;issue_cmd: previous command was NAK&#39;d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">FST_WRW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portMailbox</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">cmd</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="n">ABORTTX</span> <span class="o">||</span> <span class="n">cmd</span> <span class="o">==</span> <span class="n">STARTPORT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">txpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">txipos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*      Port output signals control</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fst_op_raise</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">outputs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outputs</span> <span class="o">|=</span> <span class="n">FST_RDL</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">v24OpSts</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>
	<span class="n">FST_WRL</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">v24OpSts</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span> <span class="n">outputs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">)</span>
		<span class="n">fst_issue_cmd</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">SETV24O</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">fst_op_lower</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">outputs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">outputs</span> <span class="o">=</span> <span class="o">~</span><span class="n">outputs</span> <span class="o">&amp;</span> <span class="n">FST_RDL</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">v24OpSts</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>
	<span class="n">FST_WRL</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">v24OpSts</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">],</span> <span class="n">outputs</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">)</span>
		<span class="n">fst_issue_cmd</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">SETV24O</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *      Setup port Rx buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_rx_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">pi</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_RX_BUFFER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">BUF_OFFSET</span><span class="p">(</span><span class="n">rxBuffer</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">FST_WRW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">ladr</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">hadr</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">FST_WRW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">bcnt</span><span class="p">,</span> <span class="n">cnv_bcnt</span><span class="p">(</span><span class="n">LEN_RX_BUFFER</span><span class="p">));</span>
		<span class="n">FST_WRW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">mcnt</span><span class="p">,</span> <span class="n">LEN_RX_BUFFER</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">bits</span><span class="p">,</span> <span class="n">DMA_OWN</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">rxpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *      Setup port Tx buffers</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_tx_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pi</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">pi</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">NUM_TX_BUFFER</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="n">BUF_OFFSET</span><span class="p">(</span><span class="n">txBuffer</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>

		<span class="n">FST_WRW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">txDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">ladr</span><span class="p">,</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span> <span class="n">offset</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">txDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">hadr</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
		<span class="n">FST_WRW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">txDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">bcnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">txDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">bits</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">txpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">txipos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*      TE1 Alarm change interrupt event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_intr_te1_alarm</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">los</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">rra</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ais</span><span class="p">;</span>

	<span class="n">los</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suStatus</span><span class="p">.</span><span class="n">lossOfSignal</span><span class="p">);</span>
	<span class="n">rra</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suStatus</span><span class="p">.</span><span class="n">receiveRemoteAlarm</span><span class="p">);</span>
	<span class="n">ais</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suStatus</span><span class="p">.</span><span class="n">alarmIndicationSignal</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">los</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Lost the link</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;Net carrier off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Link available</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;Net carrier on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">los</span><span class="p">)</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;Assert LOS Alarm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;De-assert LOS Alarm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rra</span><span class="p">)</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;Assert RRA Alarm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;De-assert RRA Alarm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ais</span><span class="p">)</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;Assert AIS Alarm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;De-assert AIS Alarm</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*      Control signal change interrupt event</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_intr_ctlchg</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">signals</span><span class="p">;</span>

	<span class="n">signals</span> <span class="o">=</span> <span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">v24DebouncedSts</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="p">(((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hwif</span> <span class="o">==</span> <span class="n">X21</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hwif</span> <span class="o">==</span> <span class="n">X21D</span><span class="p">))</span>
		       <span class="o">?</span> <span class="n">IPSTS_INDICATE</span> <span class="o">:</span> <span class="n">IPSTS_DCD</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;DCD active</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;DCD lost</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*      Log Rx Errors</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_log_rx_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
		 <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dmabits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rxp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Increment the appropriate error counter</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmabits</span> <span class="o">&amp;</span> <span class="n">RX_OFLO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;Rx fifo error on card %d port %d buffer %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">,</span> <span class="n">rxp</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmabits</span> <span class="o">&amp;</span> <span class="n">RX_CRC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;Rx crc error on card %d port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmabits</span> <span class="o">&amp;</span> <span class="n">RX_FRAM</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;Rx frame error on card %d port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmabits</span> <span class="o">==</span> <span class="p">(</span><span class="n">RX_STP</span> <span class="o">|</span> <span class="n">RX_ENP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;Rx length error (%d) on card %d port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">len</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*      Rx Error Recovery</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_recover_rx_error</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
		     <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dmabits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rxp</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pi</span><span class="p">;</span>

	<span class="n">pi</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="cm">/* </span>
<span class="cm">	 * Discard buffer descriptors until we see the start of the</span>
<span class="cm">	 * next frame.  Note that for long frames this could be in</span>
<span class="cm">	 * a subsequent interrupt. </span>
<span class="cm">	 */</span>
	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">dmabits</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">DMA_OWN</span> <span class="o">|</span> <span class="n">RX_STP</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">rxp</span><span class="p">].</span><span class="n">bits</span><span class="p">,</span> <span class="n">DMA_OWN</span><span class="p">);</span>
		<span class="n">rxp</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_RX_BUFFER</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">NUM_RX_BUFFER</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;intr_rx: Discarding more bufs&quot;</span>
			    <span class="s">&quot; than we have</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dmabits</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">rxp</span><span class="p">].</span><span class="n">bits</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;DMA Bits of next buffer was %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dmabits</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;There were %d subsequent buffers in error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* Discard the terminal buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dmabits</span> <span class="o">&amp;</span> <span class="n">DMA_OWN</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">rxp</span><span class="p">].</span><span class="n">bits</span><span class="p">,</span> <span class="n">DMA_OWN</span><span class="p">);</span>
		<span class="n">rxp</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_RX_BUFFER</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">rxpos</span> <span class="o">=</span> <span class="n">rxp</span><span class="p">;</span>
	<span class="k">return</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/*      Rx complete interrupt</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_intr_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">dmabits</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rxp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_status</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">len</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

	<span class="cm">/* Check we have a buffer to process */</span>
	<span class="n">pi</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">rxp</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rxpos</span><span class="p">;</span>
	<span class="n">dmabits</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">rxp</span><span class="p">].</span><span class="n">bits</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmabits</span> <span class="o">&amp;</span> <span class="n">DMA_OWN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_RX</span> <span class="o">|</span> <span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;intr_rx: No buffer port %d pos %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">pi</span><span class="p">,</span> <span class="n">rxp</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dmarx_in_progress</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get buffer length */</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">FST_RDW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">rxp</span><span class="p">].</span><span class="n">mcnt</span><span class="p">);</span>
	<span class="cm">/* Discard the CRC */</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This seems to happen on the TE1 interface sometimes</span>
<span class="cm">		 * so throw the frame away and log the event.</span>
<span class="cm">		 */</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Frame received with 0 length. Card %d Port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="cm">/* Return descriptor to card */</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">rxp</span><span class="p">].</span><span class="n">bits</span><span class="p">,</span> <span class="n">DMA_OWN</span><span class="p">);</span>

		<span class="n">rxp</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_RX_BUFFER</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">rxpos</span> <span class="o">=</span> <span class="n">rxp</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check buffer length and for other errors. We insist on one packet</span>
<span class="cm">	 * in one buffer. This simplifies things greatly and since we&#39;ve</span>
<span class="cm">	 * allocated 8K it shouldn&#39;t be a real world limitation</span>
<span class="cm">	 */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_RX</span><span class="p">,</span> <span class="s">&quot;intr_rx: %d,%d: flags %x len %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">rxp</span><span class="p">,</span> <span class="n">dmabits</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dmabits</span> <span class="o">!=</span> <span class="p">(</span><span class="n">RX_STP</span> <span class="o">|</span> <span class="n">RX_ENP</span><span class="p">)</span> <span class="o">||</span> <span class="n">len</span> <span class="o">&gt;</span> <span class="n">LEN_RX_BUFFER</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fst_log_rx_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">dmabits</span><span class="p">,</span> <span class="n">rxp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="n">fst_recover_rx_error</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">dmabits</span><span class="p">,</span> <span class="n">rxp</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate SKB */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="n">len</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_RX</span><span class="p">,</span> <span class="s">&quot;intr_rx: can&#39;t allocate buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>

		<span class="cm">/* Return descriptor to card */</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">rxp</span><span class="p">].</span><span class="n">bits</span><span class="p">,</span> <span class="n">DMA_OWN</span><span class="p">);</span>

		<span class="n">rxp</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_RX_BUFFER</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">rxpos</span> <span class="o">=</span> <span class="n">rxp</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We know the length we need to receive, len.</span>
<span class="cm">	 * It&#39;s not worth using the DMA for reads of less than</span>
<span class="cm">	 * FST_MIN_DMA_LEN</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">FST_MIN_DMA_LEN</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">FST_FAMILY_TXP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">memcpy_fromio</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span>
			      <span class="n">card</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">BUF_OFFSET</span><span class="p">(</span><span class="n">rxBuffer</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">rxp</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
			      <span class="n">len</span><span class="p">);</span>

		<span class="cm">/* Reset buffer descriptor */</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">rxp</span><span class="p">].</span><span class="n">bits</span><span class="p">,</span> <span class="n">DMA_OWN</span><span class="p">);</span>

		<span class="cm">/* Update stats */</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

		<span class="cm">/* Push upstream */</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_RX</span><span class="p">,</span> <span class="s">&quot;Pushing frame up the stack</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FST_RAW</span><span class="p">)</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">farsync_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">hdlc_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">rx_status</span> <span class="o">=</span> <span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">fst_process_rx_status</span><span class="p">(</span><span class="n">rx_status</span><span class="p">,</span> <span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rx_status</span> <span class="o">==</span> <span class="n">NET_RX_DROP</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dma_skb_rx</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dma_port_rx</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dma_len_rx</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">dma_rxpos</span> <span class="o">=</span> <span class="n">rxp</span><span class="p">;</span>
		<span class="n">fst_rx_dma</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_dma_handle_card</span><span class="p">,</span>
			   <span class="n">BUF_OFFSET</span><span class="p">(</span><span class="n">rxBuffer</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">rxp</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rxp</span> <span class="o">!=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rxpos</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;About to increment rxpos by more than 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;rxp = %d rxpos = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rxp</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">rxpos</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">rxp</span> <span class="o">=</span> <span class="p">(</span><span class="n">rxp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="n">NUM_RX_BUFFER</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">rxpos</span> <span class="o">=</span> <span class="n">rxp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *      The bottom halfs to the ISR</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">do_bottom_half_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txq_length</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 *  Find a free buffer for the transmit</span>
<span class="cm">	 *  Step through each port on this card</span>
<span class="cm">	 */</span>

	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;do_bottom_half_tx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">pi</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">pi</span><span class="o">++</span><span class="p">,</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">dev</span> <span class="o">=</span> <span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">txDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">txpos</span><span class="p">].</span><span class="n">bits</span><span class="p">)</span> <span class="o">&amp;</span>
			 <span class="n">DMA_OWN</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dmatx_in_progress</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * There doesn&#39;t seem to be a txdone event per-se</span>
<span class="cm">			 * We seem to have to deduce it, by checking the DMA_OWN</span>
<span class="cm">			 * bit on the next buffer we think we can use</span>
<span class="cm">			 */</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">txq_length</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">txqe</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * This is the case where one has wrapped and the</span>
<span class="cm">				 * maths gives us a negative number</span>
<span class="cm">				 */</span>
				<span class="n">txq_length</span> <span class="o">=</span> <span class="n">txq_length</span> <span class="o">+</span> <span class="n">FST_TXQ_DEPTH</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">txq_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * There is something to send</span>
<span class="cm">				 */</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">skb</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">];</span>
				<span class="n">port</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="o">++</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">txqs</span> <span class="o">==</span> <span class="n">FST_TXQ_DEPTH</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">txqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="cm">/*</span>
<span class="cm">				 * copy the data and set the required indicators on the</span>
<span class="cm">				 * card.</span>
<span class="cm">				 */</span>
				<span class="n">FST_WRW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">txDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">txpos</span><span class="p">].</span><span class="n">bcnt</span><span class="p">,</span>
					<span class="n">cnv_bcnt</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">FST_MIN_DMA_LEN</span><span class="p">)</span> <span class="o">||</span>
				    <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">FST_FAMILY_TXP</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/* Enqueue the packet with normal io */</span>
					<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span>
						    <span class="n">BUF_OFFSET</span><span class="p">(</span><span class="n">txBuffer</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span>
							       <span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span>
								<span class="n">txpos</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
						    <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
					<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
						<span class="n">txDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">txpos</span><span class="p">].</span>
						<span class="n">bits</span><span class="p">,</span>
						<span class="n">DMA_OWN</span> <span class="o">|</span> <span class="n">TX_STP</span> <span class="o">|</span> <span class="n">TX_ENP</span><span class="p">);</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
					<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Or do it through dma */</span>
					<span class="n">memcpy</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_dma_handle_host</span><span class="p">,</span>
					       <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">dma_port_tx</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">dma_len_tx</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>
					<span class="n">card</span><span class="o">-&gt;</span><span class="n">dma_txpos</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">txpos</span><span class="p">;</span>
					<span class="n">fst_tx_dma</span><span class="p">(</span><span class="n">card</span><span class="p">,</span>
						   <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">card</span><span class="o">-&gt;</span>
						   <span class="n">tx_dma_handle_card</span><span class="p">,</span>
						   <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span>
						   <span class="n">BUF_OFFSET</span><span class="p">(</span><span class="n">txBuffer</span><span class="p">[</span><span class="n">pi</span><span class="p">]</span>
							      <span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">txpos</span><span class="p">][</span><span class="mi">0</span><span class="p">]),</span>
						   <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">txpos</span> <span class="o">&gt;=</span> <span class="n">NUM_TX_BUFFER</span><span class="p">)</span>
					<span class="n">port</span><span class="o">-&gt;</span><span class="n">txpos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/*</span>
<span class="cm">				 * If we have flow control on, can we now release it?</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">txq_length</span> <span class="o">&lt;</span> <span class="n">fst_txq_low</span><span class="p">)</span> <span class="p">{</span>
						<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">port_to_dev</span>
								 <span class="p">(</span><span class="n">port</span><span class="p">));</span>
						<span class="n">port</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="p">}</span>
				<span class="p">}</span>
				<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Nothing to send so break out of the while loop</span>
<span class="cm">				 */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">do_bottom_half_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pi</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Check for rx completions on all ports on this card */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_RX</span><span class="p">,</span> <span class="s">&quot;do_bottom_half_rx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">pi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">;</span> <span class="n">pi</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">pi</span><span class="o">++</span><span class="p">,</span> <span class="n">port</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">rxDescrRing</span><span class="p">[</span><span class="n">pi</span><span class="p">][</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">rxpos</span><span class="p">].</span><span class="n">bits</span><span class="p">)</span>
			 <span class="o">&amp;</span> <span class="n">DMA_OWN</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">dmarx_in_progress</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">rx_count</span> <span class="o">&gt;</span> <span class="n">fst_max_reads</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * Don&#39;t spend forever in receive processing</span>
<span class="cm">				 * Schedule another event</span>
<span class="cm">				 */</span>
				<span class="n">fst_q_work_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_work_intq</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">);</span>
				<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_int_task</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>	<span class="cm">/* Leave the loop */</span>
			<span class="p">}</span>
			<span class="n">fst_intr_rx</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="n">rx_count</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *      The interrupt service routine</span>
<span class="cm"> *      Dev_id is our fst_card_info pointer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">fst_intr</span><span class="p">(</span><span class="kt">int</span> <span class="n">dummy</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rdidx</span><span class="p">;</span>		<span class="cm">/* Event buffer indices */</span>
	<span class="kt">int</span> <span class="n">wridx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">event</span><span class="p">;</span>		<span class="cm">/* Actual event for processing */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">dma_intcsr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">do_card_interrupt</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">int_retry_count</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check to see if the interrupt was for this card</span>
<span class="cm">	 * return if not</span>
<span class="cm">	 * Note that the call to clear the interrupt is important</span>
<span class="cm">	 */</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;intr: %d %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FST_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Interrupt received for card %d in a non running state (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

		<span class="cm">/* </span>
<span class="cm">		 * It is possible to really be running, i.e. we have re-loaded</span>
<span class="cm">		 * a running card</span>
<span class="cm">		 * Clear and reprime the interrupt source </span>
<span class="cm">		 */</span>
		<span class="n">fst_clear_intr</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear and reprime the interrupt source */</span>
	<span class="n">fst_clear_intr</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Is the interrupt for this card (handshake == 1)</span>
<span class="cm">	 */</span>
	<span class="n">do_card_interrupt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">interruptHandshake</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_card_interrupt</span> <span class="o">+=</span> <span class="n">FST_CARD_INT</span><span class="p">;</span>
		<span class="cm">/* Set the software acknowledge */</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">interruptHandshake</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">FST_FAMILY_TXU</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Is it a DMA Interrupt</span>
<span class="cm">		 */</span>
		<span class="n">dma_intcsr</span> <span class="o">=</span> <span class="n">inl</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">INTCSR_9054</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_intcsr</span> <span class="o">&amp;</span> <span class="mh">0x00200000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * DMA Channel 0 (Rx transfer complete)</span>
<span class="cm">			 */</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_RX</span><span class="p">,</span> <span class="s">&quot;DMA Rx xfer complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x8</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMACSR0</span><span class="p">);</span>
			<span class="n">fst_rx_dma_complete</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dma_port_rx</span><span class="p">,</span>
					    <span class="n">card</span><span class="o">-&gt;</span><span class="n">dma_len_rx</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dma_skb_rx</span><span class="p">,</span>
					    <span class="n">card</span><span class="o">-&gt;</span><span class="n">dma_rxpos</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">dmarx_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">do_card_interrupt</span> <span class="o">+=</span> <span class="n">FST_RX_DMA_INT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dma_intcsr</span> <span class="o">&amp;</span> <span class="mh">0x00400000</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * DMA Channel 1 (Tx transfer complete)</span>
<span class="cm">			 */</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;DMA Tx xfer complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">outb</span><span class="p">(</span><span class="mh">0x8</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMACSR1</span><span class="p">);</span>
			<span class="n">fst_tx_dma_complete</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dma_port_tx</span><span class="p">,</span>
					    <span class="n">card</span><span class="o">-&gt;</span><span class="n">dma_len_tx</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dma_txpos</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">dmatx_in_progress</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">do_card_interrupt</span> <span class="o">+=</span> <span class="n">FST_TX_DMA_INT</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Have we been missing Interrupts</span>
<span class="cm">	 */</span>
	<span class="n">int_retry_count</span> <span class="o">=</span> <span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">interruptRetryCount</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">int_retry_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;Card %d int_retry_count is  %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">,</span> <span class="n">int_retry_count</span><span class="p">);</span>
		<span class="n">FST_WRL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">interruptRetryCount</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">do_card_interrupt</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Scehdule the bottom half of the ISR */</span>
	<span class="n">fst_q_work_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_work_intq</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_int_task</span><span class="p">);</span>

	<span class="cm">/* Drain the event queue */</span>
	<span class="n">rdidx</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">interruptEvent</span><span class="p">.</span><span class="n">rdindex</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="n">wridx</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">interruptEvent</span><span class="p">.</span><span class="n">wrindex</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">rdidx</span> <span class="o">!=</span> <span class="n">wridx</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">event</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">interruptEvent</span><span class="p">.</span><span class="n">evntbuff</span><span class="p">[</span><span class="n">rdidx</span><span class="p">]);</span>
		<span class="n">port</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">event</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">];</span>

		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;Processing Interrupt event: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">TE1_ALMA</span>:
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INTR</span><span class="p">,</span> <span class="s">&quot;TE1 Alarm intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">)</span>
				<span class="n">fst_intr_te1_alarm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">CTLA_CHG</span>:
		<span class="k">case</span> <span class="n">CTLB_CHG</span>:
		<span class="k">case</span> <span class="n">CTLC_CHG</span>:
		<span class="k">case</span> <span class="n">CTLD_CHG</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">)</span>
				<span class="n">fst_intr_ctlchg</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">ABTA_SENT</span>:
		<span class="k">case</span> <span class="n">ABTB_SENT</span>:
		<span class="k">case</span> <span class="n">ABTC_SENT</span>:
		<span class="k">case</span> <span class="n">ABTD_SENT</span>:
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;Abort complete port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">TXA_UNDF</span>:
		<span class="k">case</span> <span class="n">TXB_UNDF</span>:
		<span class="k">case</span> <span class="n">TXC_UNDF</span>:
		<span class="k">case</span> <span class="n">TXD_UNDF</span>:
			<span class="cm">/* Difficult to see how we&#39;d get this given that we</span>
<span class="cm">			 * always load up the entire packet for DMA.</span>
<span class="cm">			 */</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;Tx underflow port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_fifo_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;Tx underflow on card %d port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">INIT_CPLT</span>:
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Card init OK intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">INIT_FAIL</span>:
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_INIT</span><span class="p">,</span> <span class="s">&quot;Card init FAILED intr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FST_IFAILED</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;intr: unknown card event %d. ignored</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">event</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Bump and wrap the index */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">++</span><span class="n">rdidx</span> <span class="o">&gt;=</span> <span class="n">MAX_CIRBUFF</span><span class="p">)</span>
			<span class="n">rdidx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">interruptEvent</span><span class="p">.</span><span class="n">rdindex</span><span class="p">,</span> <span class="n">rdidx</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*      Check that the shared memory configuration is one that we can handle</span>
<span class="cm"> *      and that some basic parameters are correct</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">check_started_ok</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Check structure version and end marker */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FST_RDW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">smcVersion</span><span class="p">)</span> <span class="o">!=</span> <span class="n">SMC_VERSION</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Bad shared memory version %d expected %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">FST_RDW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">smcVersion</span><span class="p">),</span> <span class="n">SMC_VERSION</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FST_BADVERSION</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">endOfSmcSignature</span><span class="p">)</span> <span class="o">!=</span> <span class="n">END_SIG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Missing shared memory signature</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FST_BADVERSION</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Firmware status flag, 0x00 = initialising, 0x01 = OK, 0xFF = fail */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">taskStatus</span><span class="p">))</span> <span class="o">==</span> <span class="mh">0x01</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FST_RUNNING</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Firmware initialisation failed. Card halted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FST_HALTED</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unknown firmware status 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FST_HALTED</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Finally check the number of ports reported by firmware against the</span>
<span class="cm">	 * number we assumed at card detection. Should never happen with</span>
<span class="cm">	 * existing firmware etc so we just report it for the moment.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">numberOfPorts</span><span class="p">)</span> <span class="o">!=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;Port count mismatch on card %d.  Firmware thinks %d we say %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">,</span>
			<span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">numberOfPorts</span><span class="p">),</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">set_conf_from_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
		   <span class="k">struct</span> <span class="n">fstioc_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">my_framing</span><span class="p">;</span>

	<span class="cm">/* Set things according to the user set valid flags </span>
<span class="cm">	 * Several of the old options have been invalidated/replaced by the </span>
<span class="cm">	 * generic hdlc package.</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">FSTVAL_PROTO</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">==</span> <span class="n">FST_RAW</span><span class="p">)</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">FST_RAW</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">FST_GEN_HDLC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">FSTVAL_CABLE</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">FSTVAL_SPEED</span><span class="p">)</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">FSTVAL_PHASE</span><span class="p">)</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">].</span><span class="n">invertClock</span><span class="p">,</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">invertClock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">FSTVAL_MODE</span><span class="p">)</span>
		<span class="n">FST_WRW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">cardMode</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cardMode</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">FSTVAL_TE1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">FST_WRL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">dataRate</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">lineSpeed</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">clocking</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">clockSource</span><span class="p">);</span>
		<span class="n">my_framing</span> <span class="o">=</span> <span class="n">FRAMING_E1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">framing</span> <span class="o">==</span> <span class="n">E1</span><span class="p">)</span>
			<span class="n">my_framing</span> <span class="o">=</span> <span class="n">FRAMING_E1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">framing</span> <span class="o">==</span> <span class="n">T1</span><span class="p">)</span>
			<span class="n">my_framing</span> <span class="o">=</span> <span class="n">FRAMING_T1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">framing</span> <span class="o">==</span> <span class="n">J1</span><span class="p">)</span>
			<span class="n">my_framing</span> <span class="o">=</span> <span class="n">FRAMING_J1</span><span class="p">;</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">framing</span><span class="p">,</span> <span class="n">my_framing</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">structure</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">structure</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">interface</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">coding</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">coding</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">lineBuildOut</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">lineBuildOut</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">equalizer</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">equalizer</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">transparentMode</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">transparentMode</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">loopMode</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">loopMode</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">range</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">txBufferMode</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">txBufferMode</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">rxBufferMode</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rxBufferMode</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">startingSlot</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">startingSlot</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">losThreshold</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">losThreshold</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">idleCode</span><span class="p">)</span>
			<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">enableIdleCode</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">enableIdleCode</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">idleCode</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">idleCode</span><span class="p">);</span>
<span class="cp">#if FST_DEBUG</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">FSTVAL_TE1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Setting TE1 data</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Line Speed = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">lineSpeed</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Start slot = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">startingSlot</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Clock source = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">clockSource</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Framing = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">my_framing</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Structure = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">structure</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;interface = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Coding = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">coding</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Line build out = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">lineBuildOut</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Equaliser = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">equalizer</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Transparent mode = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">info</span><span class="o">-&gt;</span><span class="n">transparentMode</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Loop mode = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">loopMode</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Range = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">range</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Tx Buffer mode = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">txBufferMode</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Rx Buffer mode = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">rxBufferMode</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;LOS Threshold = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">losThreshold</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Idle Code = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">idleCode</span><span class="p">);</span>
		<span class="p">}</span>
<span class="cp">#endif</span>
	<span class="p">}</span>
<span class="cp">#if FST_DEBUG</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">&amp;</span> <span class="n">FSTVAL_DEBUG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fst_debug_mask</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">debug</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">gather_conf_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
		 <span class="k">struct</span> <span class="n">fstioc_info</span> <span class="o">*</span><span class="n">info</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">info</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fstioc_info</span><span class="p">));</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">kernelVersion</span> <span class="o">=</span> <span class="n">LINUX_VERSION_CODE</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">proto</span> <span class="o">=</span> <span class="n">FST_GEN_HDLC</span><span class="p">;</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#if FST_DEBUG</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">debug</span> <span class="o">=</span> <span class="n">fst_debug_mask</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* Only mark information as valid if card is running.</span>
<span class="cm">	 * Copy the data anyway in case it is useful for diagnostics</span>
<span class="cm">	 */</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">valid</span> <span class="o">=</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FST_RUNNING</span><span class="p">)</span> <span class="o">?</span> <span class="n">FSTVAL_ALL</span> <span class="o">:</span> <span class="n">FSTVAL_CARD</span><span class="p">)</span>
<span class="cp">#if FST_DEBUG</span>
	    <span class="o">|</span> <span class="n">FSTVAL_DEBUG</span>
<span class="cp">#endif</span>
	    <span class="p">;</span>

	<span class="n">info</span><span class="o">-&gt;</span><span class="n">lineInterface</span> <span class="o">=</span> <span class="n">FST_RDW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lineInterface</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">internalClock</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">internalClock</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">lineSpeed</span> <span class="o">=</span> <span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lineSpeed</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">invertClock</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">invertClock</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">v24IpSts</span> <span class="o">=</span> <span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">v24IpSts</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">v24OpSts</span> <span class="o">=</span> <span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">v24OpSts</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">clockStatus</span> <span class="o">=</span> <span class="n">FST_RDW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">clockStatus</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cableStatus</span> <span class="o">=</span> <span class="n">FST_RDW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">cableStatus</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">cardMode</span> <span class="o">=</span> <span class="n">FST_RDW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">cardMode</span><span class="p">);</span>
	<span class="n">info</span><span class="o">-&gt;</span><span class="n">smcFirmwareVersion</span> <span class="o">=</span> <span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">smcFirmwareVersion</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * The T2U can report cable presence for both A or B</span>
<span class="cm">	 * in bits 0 and 1 of cableStatus.  See which port we are and </span>
<span class="cm">	 * do the mapping.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">FST_FAMILY_TXU</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Port A</span>
<span class="cm">			 */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cableStatus</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cableStatus</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Port B</span>
<span class="cm">			 */</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cableStatus</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cableStatus</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">cableStatus</span> <span class="o">=</span> <span class="n">info</span><span class="o">-&gt;</span><span class="n">cableStatus</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/*</span>
<span class="cm">	 * Some additional bits if we are TE1</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FST_TYPE_TE1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">lineSpeed</span> <span class="o">=</span> <span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">dataRate</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">clockSource</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">clocking</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">framing</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">framing</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">structure</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">structure</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">interface</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">coding</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">coding</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">lineBuildOut</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">lineBuildOut</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">equalizer</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">equalizer</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">loopMode</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">loopMode</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">range</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">range</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">txBufferMode</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">txBufferMode</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">rxBufferMode</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">rxBufferMode</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">startingSlot</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">startingSlot</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">losThreshold</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">losThreshold</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">enableIdleCode</span><span class="p">))</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">idleCode</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suConfig</span><span class="p">.</span><span class="n">idleCode</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">info</span><span class="o">-&gt;</span><span class="n">idleCode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">receiveBufferDelay</span> <span class="o">=</span>
		    <span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suStatus</span><span class="p">.</span><span class="n">receiveBufferDelay</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">framingErrorCount</span> <span class="o">=</span>
		    <span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suStatus</span><span class="p">.</span><span class="n">framingErrorCount</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">codeViolationCount</span> <span class="o">=</span>
		    <span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suStatus</span><span class="p">.</span><span class="n">codeViolationCount</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">crcErrorCount</span> <span class="o">=</span> <span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suStatus</span><span class="p">.</span><span class="n">crcErrorCount</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">lineAttenuation</span> <span class="o">=</span> <span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suStatus</span><span class="p">.</span><span class="n">lineAttenuation</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">lossOfSignal</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suStatus</span><span class="p">.</span><span class="n">lossOfSignal</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">receiveRemoteAlarm</span> <span class="o">=</span>
		    <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suStatus</span><span class="p">.</span><span class="n">receiveRemoteAlarm</span><span class="p">);</span>
		<span class="n">info</span><span class="o">-&gt;</span><span class="n">alarmIndicationSignal</span> <span class="o">=</span>
		    <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">suStatus</span><span class="p">.</span><span class="n">alarmIndicationSignal</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fst_set_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sync_serial_settings</span> <span class="n">sync</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">!=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">sync</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span>
	    <span class="p">(</span><span class="o">&amp;</span><span class="n">sync</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">ifs_ifsu</span><span class="p">.</span><span class="n">sync</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">sync</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sync</span><span class="p">.</span><span class="n">loopback</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">IF_IFACE_V35</span>:
		<span class="n">FST_WRW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lineInterface</span><span class="p">,</span> <span class="n">V35</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">V35</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IF_IFACE_V24</span>:
		<span class="n">FST_WRW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lineInterface</span><span class="p">,</span> <span class="n">V24</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">V24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IF_IFACE_X21</span>:
		<span class="n">FST_WRW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lineInterface</span><span class="p">,</span> <span class="n">X21</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">X21</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IF_IFACE_X21D</span>:
		<span class="n">FST_WRW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lineInterface</span><span class="p">,</span> <span class="n">X21D</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">X21D</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IF_IFACE_T1</span>:
		<span class="n">FST_WRW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lineInterface</span><span class="p">,</span> <span class="n">T1</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">T1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IF_IFACE_E1</span>:
		<span class="n">FST_WRW</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lineInterface</span><span class="p">,</span> <span class="n">E1</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">hwif</span> <span class="o">=</span> <span class="n">E1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">IF_IFACE_SYNC_SERIAL</span>:
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">sync</span><span class="p">.</span><span class="n">clock_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLOCK_EXT</span>:
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">internalClock</span><span class="p">,</span> <span class="n">EXTCLK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">CLOCK_INT</span>:
		<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">internalClock</span><span class="p">,</span> <span class="n">INTCLK</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">FST_WRL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lineSpeed</span><span class="p">,</span> <span class="n">sync</span><span class="p">.</span><span class="n">clock_rate</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fst_get_iface</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">,</span>
	      <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sync_serial_settings</span> <span class="n">sync</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* First check what line type is set, we&#39;ll default to reporting X.21</span>
<span class="cm">	 * if nothing is set as IF_IFACE_SYNC_SERIAL implies it can&#39;t be</span>
<span class="cm">	 * changed</span>
<span class="cm">	 */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hwif</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">E1</span>:
		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">IF_IFACE_E1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">T1</span>:
		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">IF_IFACE_T1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V35</span>:
		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">IF_IFACE_V35</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">V24</span>:
		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">IF_IFACE_V24</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X21D</span>:
		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">IF_IFACE_X21D</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X21</span>:
	<span class="nl">default:</span>
		<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">IF_IFACE_X21</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* only type requested */</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">&lt;</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">sync</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">i</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
	<span class="n">sync</span><span class="p">.</span><span class="n">clock_rate</span> <span class="o">=</span> <span class="n">FST_RDL</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">lineSpeed</span><span class="p">);</span>
	<span class="cm">/* Lucky card and linux use same encoding here */</span>
	<span class="n">sync</span><span class="p">.</span><span class="n">clock_type</span> <span class="o">=</span> <span class="n">FST_RDB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">portConfig</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">internalClock</span><span class="p">)</span> <span class="o">==</span>
	    <span class="n">INTCLK</span> <span class="o">?</span> <span class="n">CLOCK_INT</span> <span class="o">:</span> <span class="n">CLOCK_EXT</span><span class="p">;</span>
	<span class="n">sync</span><span class="p">.</span><span class="n">loopback</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">ifs_ifsu</span><span class="p">.</span><span class="n">sync</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sync</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">sync</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">sync</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fst_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">ifreq</span> <span class="o">*</span><span class="n">ifr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fstioc_write</span> <span class="n">wrthdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fstioc_info</span> <span class="n">info</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_IOCTL</span><span class="p">,</span> <span class="s">&quot;ioctl: %x, %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">);</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">capable</span><span class="p">(</span><span class="n">CAP_NET_ADMIN</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FSTCPURESET</span>:
		<span class="n">fst_cpureset</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FST_RESET</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FSTCPURELEASE</span>:
		<span class="n">fst_cpurelease</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FST_STARTING</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FSTWRITE</span>:		<span class="cm">/* Code write (download) */</span>

		<span class="cm">/* First copy in the header with the length and offset of data</span>
<span class="cm">		 * to write</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wrthdr</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span>
				   <span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fstioc_write</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Sanity check the parameters. We don&#39;t support partial writes</span>
<span class="cm">		 * when going over the top</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wrthdr</span><span class="p">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="n">FST_MEMSIZE</span> <span class="o">||</span> <span class="n">wrthdr</span><span class="p">.</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">FST_MEMSIZE</span> <span class="o">||</span>
		    <span class="n">wrthdr</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="n">wrthdr</span><span class="p">.</span><span class="n">offset</span> <span class="o">&gt;</span> <span class="n">FST_MEMSIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Now copy the data to the card. */</span>

		<span class="n">buf</span> <span class="o">=</span> <span class="n">memdup_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">fstioc_write</span><span class="p">),</span>
				  <span class="n">wrthdr</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">buf</span><span class="p">))</span>
			<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

		<span class="n">memcpy_toio</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">+</span> <span class="n">wrthdr</span><span class="p">.</span><span class="n">offset</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">wrthdr</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>

		<span class="cm">/* Writes to the memory of a card in the reset state constitute</span>
<span class="cm">		 * a download</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FST_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FST_DOWNLOAD</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FSTGETCONF</span>:

		<span class="cm">/* If card has just been started check the shared memory config</span>
<span class="cm">		 * version and marker</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FST_STARTING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">check_started_ok</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

			<span class="cm">/* If everything checked out enable card interrupts */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FST_RUNNING</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
				<span class="n">fst_enable_intr</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
				<span class="n">FST_WRB</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">interruptHandshake</span><span class="p">,</span> <span class="mh">0xEE</span><span class="p">);</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">gather_conf_info</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">info</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FSTSETCONF</span>:

		<span class="cm">/*</span>
<span class="cm">		 * Most of the settings have been moved to the generic ioctls</span>
<span class="cm">		 * this just covers debug and board ident now</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">FST_RUNNING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Attempt to configure card %d in non-running state (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">info</span><span class="p">,</span> <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_data</span><span class="p">,</span> <span class="k">sizeof</span> <span class="p">(</span><span class="n">info</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="n">set_conf_from_info</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">info</span><span class="p">);</span>

	<span class="k">case</span> <span class="n">SIOCWANDEV</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">IF_GET_IFACE</span>:
			<span class="k">return</span> <span class="n">fst_get_iface</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">ifr</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">IF_IFACE_SYNC_SERIAL</span>:
		<span class="k">case</span> <span class="n">IF_IFACE_V35</span>:
		<span class="k">case</span> <span class="n">IF_IFACE_V24</span>:
		<span class="k">case</span> <span class="n">IF_IFACE_X21</span>:
		<span class="k">case</span> <span class="n">IF_IFACE_X21D</span>:
		<span class="k">case</span> <span class="n">IF_IFACE_T1</span>:
		<span class="k">case</span> <span class="n">IF_IFACE_E1</span>:
			<span class="k">return</span> <span class="n">fst_set_iface</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">ifr</span><span class="p">);</span>

		<span class="k">case</span> <span class="n">IF_PROTO_RAW</span>:
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">FST_RAW</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">IF_GET_PROTO</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">==</span> <span class="n">FST_RAW</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">IF_PROTO_RAW</span><span class="p">;</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">return</span> <span class="n">hdlc_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>

		<span class="nl">default:</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">=</span> <span class="n">FST_GEN_HDLC</span><span class="p">;</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_IOCTL</span><span class="p">,</span> <span class="s">&quot;Passing this type to hdlc %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">ifr</span><span class="o">-&gt;</span><span class="n">ifr_settings</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">hdlc_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="nl">default:</span>
		<span class="cm">/* Not one of ours. Pass through to HDLC package */</span>
		<span class="k">return</span> <span class="n">hdlc_ioctl</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">ifr</span><span class="p">,</span> <span class="n">cmd</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_openport</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">signals</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txq_length</span><span class="p">;</span>

	<span class="cm">/* Only init things if card is actually running. This allows open to</span>
<span class="cm">	 * succeed for downloads etc.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FST_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_OPEN</span><span class="p">,</span> <span class="s">&quot;open: found port already running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">fst_issue_cmd</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">STOPPORT</span><span class="p">);</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">fst_rx_config</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">fst_tx_config</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
		<span class="n">fst_op_raise</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">OPSTS_RTS</span> <span class="o">|</span> <span class="n">OPSTS_DTR</span><span class="p">);</span>

		<span class="n">fst_issue_cmd</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">STARTPORT</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">run</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">signals</span> <span class="o">=</span> <span class="n">FST_RDL</span><span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">v24DebouncedSts</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signals</span> <span class="o">&amp;</span> <span class="p">(((</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hwif</span> <span class="o">==</span> <span class="n">X21</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">hwif</span> <span class="o">==</span> <span class="n">X21D</span><span class="p">))</span>
			       <span class="o">?</span> <span class="n">IPSTS_INDICATE</span> <span class="o">:</span> <span class="n">IPSTS_DCD</span><span class="p">))</span>
			<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>
		<span class="k">else</span>
			<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">port_to_dev</span><span class="p">(</span><span class="n">port</span><span class="p">));</span>

		<span class="n">txq_length</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">txqe</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">txqe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">txqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_closeport</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">FST_RUNNING</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">run</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">port</span><span class="o">-&gt;</span><span class="n">run</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fst_op_lower</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">OPSTS_RTS</span> <span class="o">|</span> <span class="n">OPSTS_DTR</span><span class="p">);</span>

			<span class="n">fst_issue_cmd</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">STOPPORT</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_OPEN</span><span class="p">,</span> <span class="s">&quot;close: port not running</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fst_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">))</span>
          <span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">FST_RAW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">hdlc_open</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">fst_openport</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fst_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">tx_dma_done</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rx_dma_done</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="n">tx_dma_done</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMACSR1</span><span class="p">);</span>
	<span class="n">rx_dma_done</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">+</span> <span class="n">DMACSR0</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_OPEN</span><span class="p">,</span>
	    <span class="s">&quot;Port Close: tx_dma_in_progress = %d (%x) rx_dma_in_progress = %d (%x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">dmatx_in_progress</span><span class="p">,</span> <span class="n">tx_dma_done</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">dmarx_in_progress</span><span class="p">,</span>
	    <span class="n">rx_dma_done</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">fst_closeport</span><span class="p">(</span><span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">mode</span> <span class="o">!=</span> <span class="n">FST_RAW</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hdlc_close</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">fst_attach</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">encoding</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">parity</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Setting currently fixed in FarSync card so we check and forget</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">encoding</span> <span class="o">!=</span> <span class="n">ENCODING_NRZ</span> <span class="o">||</span> <span class="n">parity</span> <span class="o">!=</span> <span class="n">PARITY_CRC16_PR1_CCITT</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">fst_tx_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span><span class="o">++</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;Tx timeout card %d port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
	<span class="n">fst_issue_cmd</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">ABORTTX</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span>
<span class="nf">fst_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fst_port_info</span> <span class="o">*</span><span class="n">port</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">txq_length</span><span class="p">;</span>

	<span class="n">port</span> <span class="o">=</span> <span class="n">dev_to_port</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_TX</span><span class="p">,</span> <span class="s">&quot;fst_start_xmit: length = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">);</span>

	<span class="cm">/* Drop packet with error if we don&#39;t have carrier */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">netif_carrier_ok</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_carrier_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span>
		    <span class="s">&quot;Tried to transmit but no carrier on card %d port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Drop it if it&#39;s too big! MTU failure ? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">LEN_TX_BUFFER</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;Packet too large %d vs %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">,</span>
		    <span class="n">LEN_TX_BUFFER</span><span class="p">);</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * We are always going to queue the packet</span>
<span class="cm">	 * so that the bottom half is the only place we tx from</span>
<span class="cm">	 * Check there is room in the port txq</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">txq_length</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">txqe</span> <span class="o">-</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">txqs</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This is the case where the next free has wrapped but the</span>
<span class="cm">		 * last used hasn&#39;t</span>
<span class="cm">		 */</span>
		<span class="n">txq_length</span> <span class="o">=</span> <span class="n">txq_length</span> <span class="o">+</span> <span class="n">FST_TXQ_DEPTH</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">txq_length</span> <span class="o">&gt;</span> <span class="n">fst_txq_high</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We have got enough buffers in the pipeline.  Ask the network</span>
<span class="cm">		 * layer to stop sending frames down</span>
<span class="cm">		 */</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* I&#39;m using this to signal stop sent up */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">txq_length</span> <span class="o">==</span> <span class="n">FST_TXQ_DEPTH</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This shouldn&#39;t have happened but such is life</span>
<span class="cm">		 */</span>
		<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;Tx queue overflow card %d port %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">,</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * queue the buffer</span>
<span class="cm">	 */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">txq</span><span class="p">[</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">txqe</span><span class="p">]</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="n">port</span><span class="o">-&gt;</span><span class="n">txqe</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">txqe</span> <span class="o">==</span> <span class="n">FST_TXQ_DEPTH</span><span class="p">)</span>
		<span class="n">port</span><span class="o">-&gt;</span><span class="n">txqe</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* Scehdule the bottom half which now does transmit processing */</span>
	<span class="n">fst_q_work_item</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_work_txq</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">);</span>
	<span class="n">tasklet_schedule</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_tx_task</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *      Card setup having checked hardware resources.</span>
<span class="cm"> *      Should be pretty bizarre if we get an error here (kernel memory</span>
<span class="cm"> *      exhaustion is one possibility). If we do see a problem we report it</span>
<span class="cm"> *      via a printk and leave the corresponding interface and all that follow</span>
<span class="cm"> *      disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">type_strings</span><span class="p">[]</span> <span class="n">__devinitdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;no hardware&quot;</span><span class="p">,</span>		<span class="cm">/* Should never be seen */</span>
	<span class="s">&quot;FarSync T2P&quot;</span><span class="p">,</span>
	<span class="s">&quot;FarSync T4P&quot;</span><span class="p">,</span>
	<span class="s">&quot;FarSync T1U&quot;</span><span class="p">,</span>
	<span class="s">&quot;FarSync T2U&quot;</span><span class="p">,</span>
	<span class="s">&quot;FarSync T4U&quot;</span><span class="p">,</span>
	<span class="s">&quot;FarSync TE1&quot;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devinit</span>
<span class="nf">fst_init_card</span><span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* We&#39;re working on a number of ports based on the card ID. If the</span>
<span class="cm">	 * firmware detects something different later (should never happen)</span>
<span class="cm">	 * we&#39;ll have to revise it in some way then.</span>
<span class="cm">	 */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">err</span> <span class="o">=</span> <span class="n">register_hdlc_device</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">j</span><span class="p">;</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot register HDLC device for port %d (errno %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">i</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">free_netdev</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dev</span><span class="p">);</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="p">}</span>
                        <span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s-%s: %s IRQ%d, %d ports</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">port_to_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">port_to_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">-</span> <span class="mi">1</span><span class="p">])</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">type_strings</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">],</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">fst_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span>       <span class="o">=</span> <span class="n">fst_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>       <span class="o">=</span> <span class="n">fst_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_change_mtu</span> <span class="o">=</span> <span class="n">hdlc_change_mtu</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">hdlc_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_do_ioctl</span>   <span class="o">=</span> <span class="n">fst_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_tx_timeout</span> <span class="o">=</span> <span class="n">fst_tx_timeout</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> *      Initialise card when detected.</span>
<span class="cm"> *      Returns 0 to indicate success, or errno otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span>
<span class="nf">fst_add_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">ent</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">no_of_cards_added</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">printk_once</span><span class="p">(</span><span class="n">KERN_INFO</span>
		    <span class="n">pr_fmt</span><span class="p">(</span><span class="s">&quot;FarSync WAN driver &quot;</span> <span class="n">FST_USER_VERSION</span>
			   <span class="s">&quot; (c) 2001-2004 FarSite Communications Ltd.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">));</span>
<span class="cp">#if FST_DEBUG</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_ASS</span><span class="p">,</span> <span class="s">&quot;The value of debug mask is %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fst_debug_mask</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/*</span>
<span class="cm">	 * We are going to be clever and allow certain cards not to be</span>
<span class="cm">	 * configured.  An exclude list can be provided in /etc/modules.conf</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fst_excluded_cards</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * There are cards to exclude</span>
<span class="cm">		 *</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">fst_excluded_cards</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span> <span class="o">==</span> <span class="n">fst_excluded_list</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FarSync PCI device %d not assigned</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Allocate driver private data */</span>
	<span class="n">card</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fst_card_info</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;FarSync card found but insufficient memory for driver storage</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Try to enable the device */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to enable card. Err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="s">&quot;FarSync&quot;</span><span class="p">))</span> <span class="o">!=</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Failed to allocate regions. Err %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">err</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	        <span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get virtual addresses of memory regions */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">phys_mem</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">phys_ctlmem</span> <span class="o">=</span> <span class="n">pci_resource_start</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mem</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">phys_mem</span><span class="p">,</span> <span class="n">FST_MEMSIZE</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Physical memory remap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ctlmem</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">phys_ctlmem</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Control memory remap failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_PCI</span><span class="p">,</span> <span class="s">&quot;kernel mem %p, ctlmem %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">ctlmem</span><span class="p">);</span>

	<span class="cm">/* Register the interrupt handler */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">fst_intr</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">FST_DEV_NAME</span><span class="p">,</span> <span class="n">card</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to register interrupt %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ctlmem</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Record info we need */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="n">FST_TYPE_T2P</span><span class="p">)</span> <span class="o">||</span>
			<span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="n">FST_TYPE_T4P</span><span class="p">))</span>
	    <span class="o">?</span> <span class="n">FST_FAMILY_TXP</span> <span class="o">:</span> <span class="n">FST_FAMILY_TXU</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="n">FST_TYPE_T1U</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="n">FST_TYPE_TE1</span><span class="p">))</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="o">=</span> <span class="p">((</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="n">FST_TYPE_T2P</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="n">ent</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="n">FST_TYPE_T2U</span><span class="p">))</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FST_UNINIT</span><span class="p">;</span>
        <span class="n">spin_lock_init</span> <span class="p">(</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_lock</span> <span class="p">);</span>

        <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span> <span class="p">;</span> <span class="n">i</span><span class="o">++</span> <span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_hdlcdev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">hdlc_device</span> <span class="o">*</span><span class="n">hdlc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">i</span><span class="o">--</span><span class="p">)</span>
				<span class="n">free_netdev</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;FarSync: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
                        <span class="n">free_irq</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>
                        <span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
                        <span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
                        <span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ctlmem</span><span class="p">);</span>
                        <span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">);</span>
                        <span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
                        <span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">dev</span>    <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
                <span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">card</span>   <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
                <span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">index</span>  <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
                <span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">run</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">hdlc</span> <span class="o">=</span> <span class="n">dev_to_hdlc</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

                <span class="cm">/* Fill in the net device info */</span>
		<span class="cm">/* Since this is a PCI setup this is purely</span>
<span class="cm">		 * informational. Give them the buffer addresses</span>
<span class="cm">		 * and basic card I/O.</span>
<span class="cm">		 */</span>
                <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span>   <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">phys_mem</span>
                                 <span class="o">+</span> <span class="n">BUF_OFFSET</span> <span class="p">(</span> <span class="n">txBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
                <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span>     <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">phys_mem</span>
                                 <span class="o">+</span> <span class="n">BUF_OFFSET</span> <span class="p">(</span> <span class="n">txBuffer</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">NUM_TX_BUFFER</span><span class="p">][</span><span class="mi">0</span><span class="p">]);</span>
                <span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span>   <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span><span class="p">;</span>
                <span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span>         <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">fst_ops</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span> <span class="o">=</span> <span class="n">FST_TX_QUEUE_LEN</span><span class="p">;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">watchdog_timeo</span> <span class="o">=</span> <span class="n">FST_TX_TIMEOUT</span><span class="p">;</span>
                <span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">attach</span> <span class="o">=</span> <span class="n">fst_attach</span><span class="p">;</span>
                <span class="n">hdlc</span><span class="o">-&gt;</span><span class="n">xmit</span>   <span class="o">=</span> <span class="n">fst_start_xmit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>

	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_PCI</span><span class="p">,</span> <span class="s">&quot;type %d nports %d irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">dbg</span><span class="p">(</span><span class="n">DBG_PCI</span><span class="p">,</span> <span class="s">&quot;conf %04x mem %08x ctlmem %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">card</span><span class="o">-&gt;</span><span class="n">pci_conf</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">phys_mem</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">phys_ctlmem</span><span class="p">);</span>

	<span class="cm">/* Reset the card&#39;s processor */</span>
	<span class="n">fst_cpureset</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">FST_RESET</span><span class="p">;</span>

	<span class="cm">/* Initialise DMA (if required) */</span>
	<span class="n">fst_init_dma</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* Record driver data for later use */</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>

	<span class="cm">/* Remainder of card setup */</span>
	<span class="n">fst_card_array</span><span class="p">[</span><span class="n">no_of_cards_added</span><span class="p">]</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span> <span class="o">=</span> <span class="n">no_of_cards_added</span><span class="o">++</span><span class="p">;</span>	<span class="cm">/* Record instance and bump it */</span>
	<span class="n">fst_init_card</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">FST_FAMILY_TXU</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Allocate a dma buffer for transmit and receives</span>
<span class="cm">		 */</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_dma_handle_host</span> <span class="o">=</span>
		    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">FST_MAX_MTU</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_dma_handle_card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_dma_handle_host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not allocate rx dma buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fst_disable_intr</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ctlmem</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_dma_handle_host</span> <span class="o">=</span>
		    <span class="n">pci_alloc_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">FST_MAX_MTU</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_dma_handle_card</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_dma_handle_host</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Could not allocate tx dma buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">fst_disable_intr</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ctlmem</span><span class="p">);</span>
			<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* Success */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *      Cleanup and close down a card</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span>
<span class="nf">fst_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fst_card_info</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">card</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">nports</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">port_to_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ports</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">unregister_hdlc_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">fst_disable_intr</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">card</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">ctlmem</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">==</span> <span class="n">FST_FAMILY_TXU</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Free dma buffers</span>
<span class="cm">		 */</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">FST_MAX_MTU</span><span class="p">,</span>
				    <span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_dma_handle_host</span><span class="p">,</span>
				    <span class="n">card</span><span class="o">-&gt;</span><span class="n">rx_dma_handle_card</span><span class="p">);</span>
		<span class="n">pci_free_consistent</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">,</span> <span class="n">FST_MAX_MTU</span><span class="p">,</span>
				    <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_dma_handle_host</span><span class="p">,</span>
				    <span class="n">card</span><span class="o">-&gt;</span><span class="n">tx_dma_handle_card</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">fst_card_array</span><span class="p">[</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">card_no</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">fst_driver</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">FST_NAME</span><span class="p">,</span>
        <span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">fst_pci_dev_id</span><span class="p">,</span>
        <span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">fst_add_one</span><span class="p">,</span>
        <span class="p">.</span><span class="n">remove</span>	<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">fst_remove_one</span><span class="p">),</span>
        <span class="p">.</span><span class="n">suspend</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
        <span class="p">.</span><span class="n">resume</span>	<span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">fst_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">FST_MAX_CARDS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">fst_card_array</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_work_q_lock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span>
<span class="nf">fst_cleanup_module</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;FarSync WAN driver unloading</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fst_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">fst_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">fst_cleanup_module</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
