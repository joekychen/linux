<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wan › cycx_x25.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>cycx_x25.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm">* cycx_x25.c	Cyclom 2X WAN Link Driver.  X.25 module.</span>
<span class="cm">*</span>
<span class="cm">* Author:	Arnaldo Carvalho de Melo &lt;acme@conectiva.com.br&gt;</span>
<span class="cm">*</span>
<span class="cm">* Copyright:	(c) 1998-2003 Arnaldo Carvalho de Melo</span>
<span class="cm">*</span>
<span class="cm">* Based on sdla_x25.c by Gene Kozin &lt;genek@compuserve.com&gt;</span>
<span class="cm">*</span>
<span class="cm">*		This program is free software; you can redistribute it and/or</span>
<span class="cm">*		modify it under the terms of the GNU General Public License</span>
<span class="cm">*		as published by the Free Software Foundation; either version</span>
<span class="cm">*		2 of the License, or (at your option) any later version.</span>
<span class="cm">* ============================================================================</span>
<span class="cm">* 2001/01/12	acme		use dev_kfree_skb_irq on interrupt context</span>
<span class="cm">* 2000/04/02	acme		dprintk, cycx_debug</span>
<span class="cm">* 				fixed the bug introduced in get_dev_by_lcn and</span>
<span class="cm">* 				get_dev_by_dte_addr by the anonymous hacker</span>
<span class="cm">* 				that converted this driver to softnet</span>
<span class="cm">* 2000/01/08	acme		cleanup</span>
<span class="cm">* 1999/10/27	acme		use ARPHRD_HWX25 so that the X.25 stack know</span>
<span class="cm">*				that we have a X.25 stack implemented in</span>
<span class="cm">*				firmware onboard</span>
<span class="cm">* 1999/10/18	acme		support for X.25 sockets in if_send,</span>
<span class="cm">*				beware: socket(AF_X25...) IS WORK IN PROGRESS,</span>
<span class="cm">*				TCP/IP over X.25 via wanrouter not affected,</span>
<span class="cm">*				working.</span>
<span class="cm">* 1999/10/09	acme		chan_disc renamed to chan_disconnect,</span>
<span class="cm">* 				began adding support for X.25 sockets:</span>
<span class="cm">* 				conf-&gt;protocol in new_if</span>
<span class="cm">* 1999/10/05	acme		fixed return E... to return -E...</span>
<span class="cm">* 1999/08/10	acme		serialized access to the card thru a spinlock</span>
<span class="cm">*				in x25_exec</span>
<span class="cm">* 1999/08/09	acme		removed per channel spinlocks</span>
<span class="cm">*				removed references to enable_tx_int</span>
<span class="cm">* 1999/05/28	acme		fixed nibble_to_byte, ackvc now properly treated</span>
<span class="cm">*				if_send simplified</span>
<span class="cm">* 1999/05/25	acme		fixed t1, t2, t21 &amp; t23 configuration</span>
<span class="cm">*				use spinlocks instead of cli/sti in some points</span>
<span class="cm">* 1999/05/24	acme		finished the x25_get_stat function</span>
<span class="cm">* 1999/05/23	acme		dev-&gt;type = ARPHRD_X25 (tcpdump only works,</span>
<span class="cm">*				AFAIT, with ARPHRD_ETHER). This seems to be</span>
<span class="cm">*				needed to use socket(AF_X25)...</span>
<span class="cm">*				Now the config file must specify a peer media</span>
<span class="cm">*				address for svc channels over a crossover cable.</span>
<span class="cm">*				Removed hold_timeout from x25_channel_t,</span>
<span class="cm">*				not used.</span>
<span class="cm">*				A little enhancement in the DEBUG processing</span>
<span class="cm">* 1999/05/22	acme		go to DISCONNECTED in disconnect_confirm_intr,</span>
<span class="cm">*				instead of chan_disc.</span>
<span class="cm">* 1999/05/16	marcelo		fixed timer initialization in SVCs</span>
<span class="cm">* 1999/01/05	acme		x25_configure now get (most of) all</span>
<span class="cm">*				parameters...</span>
<span class="cm">* 1999/01/05	acme		pktlen now (correctly) uses log2 (value</span>
<span class="cm">*				configured)</span>
<span class="cm">* 1999/01/03	acme		judicious use of data types (u8, u16, u32, etc)</span>
<span class="cm">* 1999/01/03	acme		cyx_isr: reset dpmbase to acknowledge</span>
<span class="cm">*				indication (interrupt from cyclom 2x)</span>
<span class="cm">* 1999/01/02	acme		cyx_isr: first hackings...</span>
<span class="cm">* 1999/01/0203  acme 		when initializing an array don&#39;t give less</span>
<span class="cm">*				elements than declared...</span>
<span class="cm">* 				example: char send_cmd[6] = &quot;?\xFF\x10&quot;;</span>
<span class="cm">*          			you&#39;ll gonna lose a couple hours, &#39;cause your</span>
<span class="cm">*				brain won&#39;t admit that there&#39;s an error in the</span>
<span class="cm">*				above declaration...  the side effect is that</span>
<span class="cm">*				memset is put into the unresolved symbols</span>
<span class="cm">*				instead of using the inline memset functions...</span>
<span class="cm">* 1999/01/02    acme 		began chan_connect, chan_send, x25_send</span>
<span class="cm">* 1998/12/31	acme		x25_configure</span>
<span class="cm">*				this code can be compiled as non module</span>
<span class="cm">* 1998/12/27	acme		code cleanup</span>
<span class="cm">*				IPX code wiped out! let&#39;s decrease code</span>
<span class="cm">*				complexity for now, remember: I&#39;m learning! :)</span>
<span class="cm">*                               bps_to_speed_code OK</span>
<span class="cm">* 1998/12/26	acme		Minimal debug code cleanup</span>
<span class="cm">* 1998/08/08	acme		Initial version.</span>
<span class="cm">*/</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#define CYCLOMX_X25_DEBUG 1</span>

<span class="cp">#include &lt;linux/ctype.h&gt;	</span><span class="cm">/* isdigit() */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/errno.h&gt;	</span><span class="cm">/* return codes */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/if_arp.h&gt;       </span><span class="cm">/* ARPHRD_HWX25 */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/kernel.h&gt;	</span><span class="cm">/* printk(), and other useful stuff */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;	</span><span class="cm">/* inline memset(), etc. */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;		</span><span class="cm">/* kmalloc(), kfree() */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/stddef.h&gt;	</span><span class="cm">/* offsetof(), etc. */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/wanrouter.h&gt;	</span><span class="cm">/* WAN router definitions */</span><span class="cp"></span>

<span class="cp">#include &lt;asm/byteorder.h&gt;	</span><span class="cm">/* htons(), etc. */</span><span class="cp"></span>

<span class="cp">#include &lt;linux/cyclomx.h&gt;	</span><span class="cm">/* Cyclom 2X common user API definitions */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/cycx_x25.h&gt;	</span><span class="cm">/* X.25 firmware API definitions */</span><span class="cp"></span>

<span class="cp">#include &lt;net/x25device.h&gt;</span>

<span class="cm">/* Defines &amp; Macros */</span>
<span class="cp">#define CYCX_X25_MAX_CMD_RETRY 5</span>
<span class="cp">#define CYCX_X25_CHAN_MTU 2048	</span><span class="cm">/* unfragmented logical channel MTU */</span><span class="cp"></span>

<span class="cm">/* Data Structures */</span>
<span class="cm">/* This is an extension of the &#39;struct net_device&#39; we create for each network</span>
<span class="cm">   interface to keep the rest of X.25 channel-specific data. */</span>
<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="p">{</span>
	<span class="cm">/* This member must be first. */</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">slave</span><span class="p">;</span>	<span class="cm">/* WAN slave */</span>

	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="n">WAN_IFNAME_SZ</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>	<span class="cm">/* interface name, ASCIIZ */</span>
	<span class="kt">char</span> <span class="n">addr</span><span class="p">[</span><span class="n">WAN_ADDRESS_SZ</span><span class="o">+</span><span class="mi">1</span><span class="p">];</span>	<span class="cm">/* media address, ASCIIZ */</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">local_addr</span><span class="p">;</span>		<span class="cm">/* local media address, ASCIIZ -</span>
<span class="cm">					   svc thru crossover cable */</span>
	<span class="n">s16</span> <span class="n">lcn</span><span class="p">;</span>			<span class="cm">/* logical channel number/conn.req.key*/</span>
	<span class="n">u8</span> <span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="n">timer</span><span class="p">;</span>	<span class="cm">/* timer used for svc channel disc. */</span>
	<span class="n">u16</span> <span class="n">protocol</span><span class="p">;</span>			<span class="cm">/* ethertype, 0 - multiplexed */</span>
	<span class="n">u8</span> <span class="n">svc</span><span class="p">;</span>				<span class="cm">/* 0 - permanent, 1 - switched */</span>
	<span class="n">u8</span> <span class="n">state</span><span class="p">;</span>			<span class="cm">/* channel state */</span>
	<span class="n">u8</span> <span class="n">drop_sequence</span><span class="p">;</span>		<span class="cm">/* mark sequence for dropping */</span>
	<span class="n">u32</span> <span class="n">idle_tmout</span><span class="p">;</span>			<span class="cm">/* sec, before disconnecting */</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">rx_skb</span><span class="p">;</span>		<span class="cm">/* receive socket buffer */</span>
	<span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>	<span class="cm">/* -&gt; owner */</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="n">ifstats</span><span class="p">;</span><span class="cm">/* interface statistics */</span>
<span class="p">};</span>

<span class="cm">/* Function Prototypes */</span>
<span class="cm">/* WAN link driver entry points. These are called by the WAN router module. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cycx_wan_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">),</span>
	   <span class="n">cycx_wan_new_if</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="n">wanif_conf_t</span> <span class="o">*</span><span class="n">conf</span><span class="p">),</span>
	   <span class="n">cycx_wan_del_if</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* Network device interface */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cycx_netdevice_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cycx_netdevice_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cycx_netdevice_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cycx_netdevice_hard_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">daddr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">saddr</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cycx_netdevice_rebuild_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="n">cycx_netdevice_hard_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span>
			<span class="n">cycx_netdevice_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/* Interrupt handlers */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cycx_x25_irq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">),</span>
	    <span class="n">cycx_x25_irq_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">),</span>
	    <span class="n">cycx_x25_irq_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">),</span>
	    <span class="n">cycx_x25_irq_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			     <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">),</span>
	    <span class="n">cycx_x25_irq_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">),</span>
	    <span class="n">cycx_x25_irq_connect_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">),</span>
	    <span class="n">cycx_x25_irq_disconnect_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">),</span>
	    <span class="n">cycx_x25_irq_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">),</span>
	    <span class="n">cycx_x25_irq_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">),</span>
	    <span class="n">cycx_x25_irq_spurious</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">);</span>

<span class="cm">/* X.25 firmware interface functions */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cycx_x25_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">cycx_x25_config</span> <span class="o">*</span><span class="n">conf</span><span class="p">),</span>
	   <span class="n">cycx_x25_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">),</span>
	   <span class="n">cycx_x25_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lcn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bitm</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">),</span>
	   <span class="n">cycx_x25_connect_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">),</span>
	   <span class="n">cycx_x25_disconnect_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link</span><span class="p">,</span>
			   		<span class="n">u8</span> <span class="n">lcn</span><span class="p">);</span>

<span class="cm">/* channel functions */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cycx_x25_chan_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">),</span>
	   <span class="n">cycx_x25_chan_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cycx_x25_chan_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">),</span>
	    <span class="n">cycx_x25_chan_send_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">event</span><span class="p">);</span>

<span class="cm">/* Miscellaneous functions */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cycx_x25_set_chan_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">),</span>
	    <span class="n">cycx_x25_chan_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">d</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">nibble_to_byte</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">nibble</span><span class="p">),</span>
	    <span class="n">reset_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">bps_to_speed_code</span><span class="p">(</span><span class="n">u32</span> <span class="n">bps</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">cycx_log2</span><span class="p">(</span><span class="n">u32</span> <span class="n">n</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="n">dec_to_uint</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">cycx_x25_get_dev_by_lcn</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">,</span>
						  <span class="n">s16</span> <span class="n">lcn</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span>
	<span class="n">cycx_x25_get_dev_by_dte_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dte</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">cycx_x25_chan_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#ifdef CYCLOMX_X25_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">hex_dump</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cycx_x25_dump_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_x25_config</span> <span class="o">*</span><span class="n">conf</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cycx_x25_dump_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_x25_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cycx_x25_dump_devs</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="cp">#define hex_dump(msg, p, len)</span>
<span class="cp">#define cycx_x25_dump_config(conf)</span>
<span class="cp">#define cycx_x25_dump_stats(stats)</span>
<span class="cp">#define cycx_x25_dump_devs(wandev)</span>
<span class="cp">#endif</span>
<span class="cm">/* Public Functions */</span>

<span class="cm">/* X.25 Protocol Initialization routine.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is called by the main Cyclom 2X module during setup.  At this</span>
<span class="cm"> * point adapter is completely initialized and X.25 firmware is running.</span>
<span class="cm"> *  o configure adapter</span>
<span class="cm"> *  o initialize protocol-specific fields of the adapter data space.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:	0	o.k.</span>
<span class="cm"> *		&lt; 0	failure.  */</span>
<span class="kt">int</span> <span class="nf">cycx_x25_wan_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">wandev_conf_t</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cycx_x25_config</span> <span class="n">cfg</span><span class="p">;</span>

	<span class="cm">/* Verify configuration ID */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">config_id</span> <span class="o">!=</span> <span class="n">WANCONFIG_X25</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: invalid configuration ID %u!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">config_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Initialize protocol-specific fields */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">mbox</span>  <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">.</span><span class="n">dpmbase</span> <span class="o">+</span> <span class="n">X25_MBOX_OFFS</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">connection_keys</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="cm">/* Configure adapter. Here we set reasonable defaults, then parse</span>
<span class="cm">	 * device configuration structure and set configuration options.</span>
<span class="cm">	 * Most configuration options are verified and corrected (if</span>
<span class="cm">	 * necessary) since we can&#39;t rely on the adapter to do so and don&#39;t</span>
<span class="cm">	 * want it to fail either. */</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cfg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cfg</span><span class="p">));</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">link</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">clock</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">clocking</span> <span class="o">==</span> <span class="n">WANOPT_EXTERNAL</span> <span class="o">?</span> <span class="mi">8</span> <span class="o">:</span> <span class="mi">55</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">speed</span> <span class="o">=</span> <span class="n">bps_to_speed_code</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">bps</span><span class="p">);</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">n3win</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">n2win</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">n2</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">nvc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">npvc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">;</span> <span class="cm">/* default = V35 */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">t1</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>   <span class="cm">/* line carrier timeout */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">t2</span> <span class="o">=</span> <span class="mi">29</span><span class="p">;</span>   <span class="cm">/* tx timeout */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">t21</span> <span class="o">=</span> <span class="mi">180</span><span class="p">;</span> <span class="cm">/* CALL timeout */</span>
	<span class="n">cfg</span><span class="p">.</span><span class="n">t23</span> <span class="o">=</span> <span class="mi">180</span><span class="p">;</span> <span class="cm">/* CLEAR timeout */</span>

	<span class="cm">/* adjust MTU */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">||</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;=</span> <span class="mi">512</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">mtu</span> <span class="o">=</span> <span class="mi">512</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;=</span> <span class="mi">256</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">mtu</span> <span class="o">=</span> <span class="mi">256</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">&gt;=</span> <span class="mi">128</span><span class="p">)</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">mtu</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">mtu</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">pktlen</span> <span class="o">=</span> <span class="n">cycx_log2</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">mtu</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">station</span> <span class="o">==</span> <span class="n">WANOPT_DTE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">locaddr</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* DTE */</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">remaddr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* DCE */</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">locaddr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* DCE */</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">remaddr</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="cm">/* DTE */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">interface</span> <span class="o">==</span> <span class="n">WANOPT_RS232</span><span class="p">)</span>
	        <span class="n">cfg</span><span class="p">.</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>      <span class="cm">/* FIXME just reset the 2nd bit */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">hi_pvc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">hi_pvc</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">hi_pvc</span><span class="p">,</span> <span class="mi">4095</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">lo_pvc</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">lo_pvc</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">hi_pvc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">hi_svc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">hi_svc</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">hi_svc</span><span class="p">,</span> <span class="mi">4095</span><span class="p">);</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">lo_svc</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">lo_svc</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">hi_svc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">lo_pvc</span> <span class="o">==</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">npvc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">npvc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">hi_pvc</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">lo_pvc</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">cfg</span><span class="p">.</span><span class="n">nvc</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">hi_svc</span> <span class="o">-</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">lo_svc</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">cfg</span><span class="p">.</span><span class="n">npvc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">hdlc_window</span><span class="p">)</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">n2win</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">hdlc_window</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">pkt_window</span><span class="p">)</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">n3win</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">pkt_window</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">t1</span><span class="p">)</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">t1</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">t1</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">t2</span><span class="p">)</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">t2</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">t2</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">t11_t21</span><span class="p">)</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">t21</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">t11_t21</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">t13_t23</span><span class="p">)</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">t23</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">t13_t23</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">n2</span><span class="p">)</span>
		<span class="n">cfg</span><span class="p">.</span><span class="n">n2</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x25</span><span class="p">.</span><span class="n">n2</span><span class="p">,</span> <span class="mi">30</span><span class="p">);</span>

	<span class="cm">/* initialize adapter */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cycx_x25_configure</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cfg</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* Initialize protocol-specific fields of adapter data space */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">bps</span>	<span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">bps</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">interface</span>	<span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">interface</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">clocking</span>	<span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">clocking</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">station</span>	<span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">station</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">isr</span>		<span class="o">=</span> <span class="n">cycx_x25_irq_handler</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">exec</span>		<span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">update</span>	<span class="o">=</span> <span class="n">cycx_wan_update</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">new_if</span>	<span class="o">=</span> <span class="n">cycx_wan_new_if</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">del_if</span>	<span class="o">=</span> <span class="n">cycx_wan_del_if</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">state</span>	<span class="o">=</span> <span class="n">WAN_DISCONNECTED</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* WAN Device Driver Entry Points */</span>
<span class="cm">/* Update device status &amp; statistics. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_wan_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* sanity checks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wandev</span> <span class="o">||</span> <span class="o">!</span><span class="n">wandev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wandev</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WAN_UNCONFIGURED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">cycx_x25_get_stats</span><span class="p">(</span><span class="n">wandev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Create new logical channel.</span>
<span class="cm"> * This routine is called by the router when ROUTER_IFNEW IOCTL is being</span>
<span class="cm"> * handled.</span>
<span class="cm"> * o parse media- and hardware-specific configuration</span>
<span class="cm"> * o make sure that a new channel can be created</span>
<span class="cm"> * o allocate resources, if necessary</span>
<span class="cm"> * o prepare network device structure for registration.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:	0	o.k.</span>
<span class="cm"> *		&lt; 0	failure (channel will not be created) */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_wan_new_if</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			   <span class="n">wanif_conf_t</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">||</span> <span class="n">strlen</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">WAN_IFNAME_SZ</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: invalid interface name!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_netdev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_x25_channel</span><span class="p">),</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
			     <span class="n">cycx_x25_chan_setup</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">link</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">port</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">?</span> <span class="n">ETH_P_X25</span> <span class="o">:</span> <span class="n">ETH_P_IP</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="cm">/* only used in svc connected thru crossover cable */</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_addr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;@&#39;</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* SVC */</span>
		<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">WAN_ADDRESS_SZ</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: %s local addr too long!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_addr</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">strncpy</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">,</span>
				<span class="n">WAN_ADDRESS_SZ</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">svc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">strncpy</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">WAN_ADDRESS_SZ</span><span class="p">);</span>
		<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">function</span>	<span class="o">=</span> <span class="n">cycx_x25_chan_timer</span><span class="p">;</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">.</span><span class="n">data</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">;</span>

		<span class="cm">/* Set channel timeouts (default if not specified) */</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">idle_tmout</span> <span class="o">=</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">idle_timeout</span> <span class="o">?</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">idle_timeout</span> <span class="o">:</span> <span class="mi">90</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">isdigit</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="p">{</span>	<span class="cm">/* PVC */</span>
		<span class="n">s16</span> <span class="n">lcn</span> <span class="o">=</span> <span class="n">dec_to_uint</span><span class="p">(</span><span class="n">conf</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lcn</span> <span class="o">&gt;=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">lo_pvc</span> <span class="o">&amp;&amp;</span> <span class="n">lcn</span> <span class="o">&lt;=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">hi_pvc</span><span class="p">)</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">lcn</span> <span class="o">=</span> <span class="n">lcn</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: PVC %u is out of range on interface %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">lcn</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: invalid media address on interface %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">free_netdev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Delete logical channel. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_wan_del_if</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">svc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WAN_CONNECTED</span><span class="p">)</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Network Device Interface */</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">header_ops</span> <span class="n">cycx_header_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">create</span> <span class="o">=</span> <span class="n">cycx_netdevice_hard_header</span><span class="p">,</span>
	<span class="p">.</span><span class="n">rebuild</span> <span class="o">=</span> <span class="n">cycx_netdevice_rebuild_header</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">cycx_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_init</span>	<span class="o">=</span> <span class="n">cycx_netdevice_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_open</span>	<span class="o">=</span> <span class="n">cycx_netdevice_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span>	<span class="o">=</span> <span class="n">cycx_netdevice_stop</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span>	<span class="o">=</span> <span class="n">cycx_netdevice_hard_start_xmit</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_get_stats</span>	<span class="o">=</span> <span class="n">cycx_netdevice_get_stats</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_chan_setup</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Initialize device driver entry points */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">cycx_netdev_ops</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">header_ops</span>		<span class="o">=</span> <span class="o">&amp;</span><span class="n">cycx_header_ops</span><span class="p">;</span>

	<span class="cm">/* Initialize media-specific parameters */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span>		<span class="o">=</span> <span class="n">CYCX_X25_CHAN_MTU</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span>		<span class="o">=</span> <span class="n">ARPHRD_HWX25</span><span class="p">;</span>	<span class="cm">/* ARP h/w type */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span>	<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* media header length */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">addr_len</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* hardware address length */</span>
<span class="p">}</span>

<span class="cm">/* Initialize Linux network interface.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine is called only once for each interface, during Linux network</span>
<span class="cm"> * interface registration.  Returning anything but zero will fail interface</span>
<span class="cm"> * registration. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_netdevice_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">svc</span><span class="p">)</span>
		<span class="o">*</span><span class="p">(</span><span class="n">__be16</span><span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lcn</span><span class="p">);</span>

	<span class="cm">/* Initialize hardware parameters (just for reference) */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span>		<span class="o">=</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">dma</span>		<span class="o">=</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">dma</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">base_addr</span>		<span class="o">=</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">ioport</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_start</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">wandev</span><span class="o">-&gt;</span><span class="n">maddr</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">mem_end</span>		<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)(</span><span class="n">wandev</span><span class="o">-&gt;</span><span class="n">maddr</span> <span class="o">+</span>
						  <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">msize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span>		<span class="o">|=</span> <span class="n">IFF_NOARP</span><span class="p">;</span>

	<span class="cm">/* Set transmit buffer queue length */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">tx_queue_len</span>	<span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="cm">/* Initialize socket buffers */</span>
	<span class="n">cycx_x25_set_chan_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WAN_DISCONNECTED</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Open network interface.</span>
<span class="cm"> * o prevent module from unloading by incrementing use count</span>
<span class="cm"> * o if link is disconnected then initiate connection</span>
<span class="cm"> *</span>
<span class="cm"> * Return 0 if O.k. or errno.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_netdevice_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">netif_running</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span> <span class="cm">/* only one open is allowed */</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Close network interface.</span>
<span class="cm"> * o reset flags.</span>
<span class="cm"> * o if there&#39;s no more open channels then disconnect physical link. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_netdevice_stop</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WAN_CONNECTED</span> <span class="o">||</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WAN_CONNECTING</span><span class="p">)</span>
		<span class="n">cycx_x25_chan_disconnect</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Build media header.</span>
<span class="cm"> * o encapsulate packet according to encapsulation type.</span>
<span class="cm"> *</span>
<span class="cm"> * The trick here is to put packet type (Ethertype) into &#39;protocol&#39; field of</span>
<span class="cm"> * the socket buffer, so that we don&#39;t forget it.  If encapsulation fails,</span>
<span class="cm"> * set skb-&gt;protocol to 0 and discard packet later.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:	media header length. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_netdevice_hard_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u16</span> <span class="n">type</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">daddr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">saddr</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">type</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* * Re-build media header.</span>
<span class="cm"> * Return:	1	physical address resolved.</span>
<span class="cm"> *		0	physical address not resolved */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_netdevice_rebuild_header</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send a packet on a network interface.</span>
<span class="cm"> * o set busy flag (marks start of the transmission).</span>
<span class="cm"> * o check link state. If link is not up, then drop the packet.</span>
<span class="cm"> * o check channel status. If it&#39;s down then initiate a call.</span>
<span class="cm"> * o pass a packet to corresponding WAN device.</span>
<span class="cm"> * o free socket buffer</span>
<span class="cm"> *</span>
<span class="cm"> * Return:	0	complete (socket buffer must be freed)</span>
<span class="cm"> *		non-0	packet may be re-transmitted (tbusy must be set)</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> * 1. This routine is called either by the protocol stack or by the &quot;net</span>
<span class="cm"> *    bottom half&quot; (with interrupts enabled).</span>
<span class="cm"> * 2. Setting tbusy flag will inhibit further transmit requests from the</span>
<span class="cm"> *    protocol stack and can be used for flow control with protocol layer. */</span>
<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">cycx_netdevice_hard_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span>
							<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">svc</span><span class="p">)</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">WAN_CONNECTED</span><span class="p">)</span>
		<span class="o">++</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ifstats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">svc</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">&amp;&amp;</span>
		 <span class="n">chan</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">!=</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: unsupported Ethertype 0x%04X on interface %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">ntohs</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">),</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="o">++</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ifstats</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_IP</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WAN_DISCONNECTED</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">cycx_x25_chan_connect</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* fall thru */</span>
		<span class="k">case</span> <span class="n">WAN_CONNECTED</span>:
			<span class="n">reset_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
			<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">cycx_x25_chan_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
				<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="o">++</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ifstats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="p">;</span>
			<span class="o">++</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* chan-&gt;protocol == ETH_P_X25 */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">X25_IFACE_DATA</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">X25_IFACE_CONNECT</span>:
			<span class="n">cycx_x25_chan_connect</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">X25_IFACE_DISCONNECT</span>:
			<span class="n">cycx_x25_chan_disconnect</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>
	        <span class="nl">default:</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: unknown %d x25-iface request on %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="o">++</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ifstats</span><span class="p">.</span><span class="n">tx_errors</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">free_packet</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span> <span class="cm">/* Remove control byte */</span>
		<span class="n">reset_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">trans_start</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
		<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cycx_x25_chan_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* prepare for future retransmissions */</span>
			<span class="n">skb_push</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">free_packet:</span>
	<span class="n">dev_kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get Ethernet-style interface statistics.</span>
<span class="cm"> * Return a pointer to struct net_device_stats */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="nf">cycx_netdevice_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">chan</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ifstats</span> <span class="o">:</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Interrupt Handlers */</span>
<span class="cm">/* X.25 Interrupt Service Routine. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_irq_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="n">cmd</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">z</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">in_isr</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">buff_int_mode_unbusy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">X25_RXMBOX_OFFS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">cmd</span><span class="p">.</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">X25_DATA_INDICATION</span>:
		<span class="n">cycx_x25_irq_rx</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X25_ACK_FROM_VC</span>:
		<span class="n">cycx_x25_irq_tx</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X25_LOG</span>:
		<span class="n">cycx_x25_irq_log</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X25_STATISTIC</span>:
		<span class="n">cycx_x25_irq_stat</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X25_CONNECT_CONFIRM</span>:
		<span class="n">cycx_x25_irq_connect_confirm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X25_CONNECT_INDICATION</span>:
		<span class="n">cycx_x25_irq_connect</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X25_DISCONNECT_INDICATION</span>:
		<span class="n">cycx_x25_irq_disconnect</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X25_DISCONNECT_CONFIRM</span>:
		<span class="n">cycx_x25_irq_disconnect_confirm</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X25_LINE_ON</span>:
		<span class="n">cycx_set_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">WAN_CONNECTED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">X25_LINE_OFF</span>:
		<span class="n">cycx_set_state</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">WAN_DISCONNECTED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">cycx_x25_irq_spurious</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cmd</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cycx_poke</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">z</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">z</span><span class="p">));</span>
	<span class="n">cycx_poke</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">X25_RXMBOX_OFFS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">z</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">z</span><span class="p">));</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">in_isr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Transmit interrupt handler.</span>
<span class="cm"> *	o Release socket buffer</span>
<span class="cm"> *	o Clear &#39;tbusy&#39; flag */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_irq_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lcn</span><span class="p">;</span>

	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lcn</span><span class="p">));</span>

	<span class="cm">/* unbusy device and then dev_tint(); */</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">cycx_x25_get_dev_by_lcn</span><span class="p">(</span><span class="n">wandev</span><span class="p">,</span> <span class="n">lcn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">buff_int_mode_unbusy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s:ackvc for inexistent lcn %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">lcn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Receive interrupt handler.</span>
<span class="cm"> * This routine handles fragmented IP packets using M-bit according to the</span>
<span class="cm"> * RFC1356.</span>
<span class="cm"> * o map logical channel number to network interface.</span>
<span class="cm"> * o allocate socket buffer or append received packet to the existing one.</span>
<span class="cm"> * o if M-bit is reset (i.e. it&#39;s the last packet in a sequence) then</span>
<span class="cm"> *   decapsulate packet and pass socket buffer to the protocol stack.</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> * 1. When allocating a socket buffer, if M-bit is set then more data is</span>
<span class="cm"> *    coming and we have to allocate buffer for the maximum IP packet size</span>
<span class="cm"> *    expected on this channel.</span>
<span class="cm"> * 2. If something goes wrong and X.25 packet has to be dropped (e.g. no</span>
<span class="cm"> *    socket buffers available) the whole packet sequence must be discarded. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_irq_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">bitm</span><span class="p">,</span> <span class="n">lcn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pktlen</span> <span class="o">=</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">5</span><span class="p">;</span>

	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lcn</span><span class="p">));</span>
	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bitm</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bitm</span><span class="p">));</span>
	<span class="n">bitm</span> <span class="o">&amp;=</span> <span class="mh">0x10</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">cycx_x25_get_dev_by_lcn</span><span class="p">(</span><span class="n">wandev</span><span class="p">,</span> <span class="n">lcn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Invalid channel, discard packet */</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: receiving on orphaned LCN %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">lcn</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">reset_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">drop_sequence</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bitm</span><span class="p">)</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">drop_sequence</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Allocate new socket buffer */</span>
		<span class="kt">int</span> <span class="n">bufsize</span> <span class="o">=</span> <span class="n">bitm</span> <span class="o">?</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">mtu</span> <span class="o">:</span> <span class="n">pktlen</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">((</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_X25</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span>
					 <span class="n">bufsize</span> <span class="o">+</span>
					 <span class="n">dev</span><span class="o">-&gt;</span><span class="n">hard_header_len</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: no socket buffers available!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">drop_sequence</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">++</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ifstats</span><span class="p">.</span><span class="n">rx_dropped</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_X25</span><span class="p">)</span> <span class="cm">/* X.25 socket layer control */</span>
			<span class="cm">/* 0 = data packet (dev_alloc_skb zeroed skb-&gt;data) */</span>
			<span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
		<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">protocol</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="n">skb</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb_tailroom</span><span class="p">(</span><span class="n">skb</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">pktlen</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* No room for the packet. Call off the whole thing! */</span>
		<span class="n">dev_kfree_skb_irq</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bitm</span><span class="p">)</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">drop_sequence</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: unexpectedly long packet sequence on interface %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="o">++</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ifstats</span><span class="p">.</span><span class="n">rx_length_errors</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Append packet to the socket buffer  */</span>
	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">pktlen</span><span class="p">),</span> <span class="n">pktlen</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitm</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* more data is coming */</span>

	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>		<span class="cm">/* dequeue packet */</span>

	<span class="o">++</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ifstats</span><span class="p">.</span><span class="n">rx_packets</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ifstats</span><span class="p">.</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">pktlen</span><span class="p">;</span>

	<span class="n">skb_reset_mac_header</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Connect interrupt handler. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_irq_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">d</span><span class="p">[</span><span class="mi">32</span><span class="p">],</span>
	   <span class="n">loc</span><span class="p">[</span><span class="mi">24</span><span class="p">],</span>
	   <span class="n">rem</span><span class="p">[</span><span class="mi">24</span><span class="p">];</span>
	<span class="n">u8</span> <span class="n">lcn</span><span class="p">,</span> <span class="n">sizeloc</span><span class="p">,</span> <span class="n">sizerem</span><span class="p">;</span>

	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lcn</span><span class="p">));</span>
	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sizeloc</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sizeloc</span><span class="p">));</span>
	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">-</span> <span class="mi">6</span><span class="p">);</span>

	<span class="n">sizerem</span> <span class="o">=</span> <span class="n">sizeloc</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">sizeloc</span> <span class="o">&amp;=</span> <span class="mh">0x0F</span><span class="p">;</span>

	<span class="n">loc</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rem</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sizeloc</span><span class="p">)</span>
		<span class="n">nibble_to_byte</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">sizeloc</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sizerem</span><span class="p">)</span>
		<span class="n">nibble_to_byte</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="p">(</span><span class="n">sizeloc</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">),</span> <span class="n">rem</span><span class="p">,</span> <span class="n">sizerem</span><span class="p">,</span> <span class="n">sizeloc</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s:lcn=%d, local=%s, remote=%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">__func__</span><span class="p">,</span> <span class="n">lcn</span><span class="p">,</span> <span class="n">loc</span><span class="p">,</span> <span class="n">rem</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">cycx_x25_get_dev_by_dte_addr</span><span class="p">(</span><span class="n">wandev</span><span class="p">,</span> <span class="n">rem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Invalid channel, discard packet */</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: connect not expected: remote %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">rem</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">lcn</span> <span class="o">=</span> <span class="n">lcn</span><span class="p">;</span>
	<span class="n">cycx_x25_connect_response</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">chan</span><span class="p">);</span>
	<span class="n">cycx_x25_set_chan_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WAN_CONNECTED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Connect confirm interrupt handler. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_irq_connect_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lcn</span><span class="p">,</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lcn</span><span class="p">));</span>
	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">key</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s:lcn=%d, key=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">lcn</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">cycx_x25_get_dev_by_lcn</span><span class="p">(</span><span class="n">wandev</span><span class="p">,</span> <span class="o">-</span><span class="n">key</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Invalid channel, discard packet */</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="o">--</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">connection_keys</span><span class="p">);</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: connect confirm not expected: lcn %d, key=%d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">lcn</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">clear_bit</span><span class="p">(</span><span class="o">--</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">connection_keys</span><span class="p">);</span>
	<span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">lcn</span> <span class="o">=</span> <span class="n">lcn</span><span class="p">;</span>
	<span class="n">cycx_x25_set_chan_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WAN_CONNECTED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Disconnect confirm interrupt handler. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_irq_disconnect_confirm</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
					    <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lcn</span><span class="p">;</span>

	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lcn</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s:lcn=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">lcn</span><span class="p">);</span>
	<span class="n">dev</span> <span class="o">=</span> <span class="n">cycx_x25_get_dev_by_lcn</span><span class="p">(</span><span class="n">wandev</span><span class="p">,</span> <span class="n">lcn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Invalid channel, discard packet */</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s:disconnect confirm not expected!:lcn %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">lcn</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">cycx_x25_set_chan_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WAN_DISCONNECTED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* disconnect interrupt handler. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_irq_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lcn</span><span class="p">;</span>

	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lcn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">lcn</span><span class="p">));</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s:lcn=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">lcn</span><span class="p">);</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">cycx_x25_get_dev_by_lcn</span><span class="p">(</span><span class="n">wandev</span><span class="p">,</span> <span class="n">lcn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">cycx_x25_disconnect_response</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">lcn</span><span class="p">);</span>
		<span class="n">cycx_x25_set_chan_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WAN_DISCONNECTED</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cycx_x25_disconnect_response</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">lcn</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* LOG interrupt handler. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_irq_log</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if CYCLOMX_X25_DEBUG</span>
	<span class="kt">char</span> <span class="n">bf</span><span class="p">[</span><span class="mi">20</span><span class="p">];</span>
	<span class="n">u16</span> <span class="n">size</span><span class="p">,</span> <span class="n">toread</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">msg_code</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">code</span><span class="p">,</span> <span class="n">routine</span><span class="p">;</span>

	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_code</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg_code</span><span class="p">));</span>
	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">link</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">link</span><span class="p">));</span>
	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">size</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">size</span><span class="p">));</span>
	<span class="cm">/* at most 20 bytes are available... thanks to Daniela :) */</span>
	<span class="n">toread</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&lt;</span> <span class="mi">20</span> <span class="o">?</span> <span class="n">size</span> <span class="o">:</span> <span class="mi">20</span><span class="p">;</span>
	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">10</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bf</span><span class="p">,</span> <span class="n">toread</span><span class="p">);</span>
	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">toread</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">code</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span> <span class="o">+</span> <span class="mi">10</span> <span class="o">+</span> <span class="n">toread</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">routine</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cycx_x25_irq_handler: X25_LOG (0x4500) indic.:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;cmd-&gt;buf=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Log message code=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_code</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Link=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;log code=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">code</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;log routine=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">routine</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;Message size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="n">hex_dump</span><span class="p">(</span><span class="s">&quot;Message&quot;</span><span class="p">,</span> <span class="n">bf</span><span class="p">,</span> <span class="n">toread</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="cm">/* STATISTIC interrupt handler. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_irq_stat</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cycx_peek</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">stats</span><span class="p">,</span>
		  <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">stats</span><span class="p">));</span>
	<span class="n">hex_dump</span><span class="p">(</span><span class="s">&quot;cycx_x25_irq_stat&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">stats</span><span class="p">,</span>
		 <span class="k">sizeof</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">stats</span><span class="p">));</span>
	<span class="n">cycx_x25_dump_stats</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">stats</span><span class="p">);</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_stats</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Spurious interrupt handler.</span>
<span class="cm"> * o print a warning</span>
<span class="cm"> * If number of spurious interrupts exceeded some limit, then ??? */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_irq_spurious</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="o">*</span><span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: spurious interrupt (0x%X)!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">cmd</span><span class="o">-&gt;</span><span class="n">command</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#ifdef CYCLOMX_X25_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">hex_dump</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">print_hex_dump</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">DUMP_PREFIX_OFFSET</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		       <span class="n">p</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="cm">/* Cyclom 2X Firmware-Specific Functions */</span>
<span class="cm">/* Exec X.25 command. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_exec</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">command</span><span class="p">,</span> <span class="kt">int</span> <span class="n">link</span><span class="p">,</span>
		    <span class="kt">void</span> <span class="o">*</span><span class="n">d1</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len1</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">d2</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len2</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cycx_x25_cmd</span> <span class="n">c</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">addr</span> <span class="o">=</span> <span class="mh">0x1200</span> <span class="o">+</span> <span class="mh">0x2E0</span> <span class="o">*</span> <span class="n">link</span> <span class="o">+</span> <span class="mh">0x1E2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">retry</span> <span class="o">=</span> <span class="n">CYCX_X25_MAX_CMD_RETRY</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">c</span><span class="p">.</span><span class="n">command</span> <span class="o">=</span> <span class="n">command</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">link</span> <span class="o">=</span> <span class="n">link</span><span class="p">;</span>
	<span class="n">c</span><span class="p">.</span><span class="n">len</span> <span class="o">=</span> <span class="n">len1</span> <span class="o">+</span> <span class="n">len2</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* write command */</span>
	<span class="n">cycx_poke</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">X25_MBOX_OFFS</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">c</span><span class="p">.</span><span class="n">buf</span><span class="p">));</span>

	<span class="cm">/* write X.25 data */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">d1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cycx_poke</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">len1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">d2</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">len2</span> <span class="o">&gt;</span> <span class="mi">254</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">addr1</span> <span class="o">=</span> <span class="mh">0xA00</span> <span class="o">+</span> <span class="mh">0x400</span> <span class="o">*</span> <span class="n">link</span><span class="p">;</span>

				<span class="n">cycx_poke</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">len1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="mi">249</span><span class="p">);</span>
				<span class="n">cycx_poke</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">addr1</span><span class="p">,</span> <span class="p">((</span><span class="n">u8</span><span class="o">*</span><span class="p">)</span><span class="n">d2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">249</span><span class="p">,</span>
					  <span class="n">len2</span> <span class="o">-</span> <span class="mi">249</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">cycx_poke</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">,</span> <span class="n">addr</span> <span class="o">+</span> <span class="n">len1</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">len2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* generate interruption, executing command */</span>
	<span class="n">cycx_intr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">hw</span><span class="p">);</span>

	<span class="cm">/* wait till card-&gt;mbox == 0 */</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">cycx_exec</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">mbox</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">retry</span><span class="o">--</span> <span class="o">&amp;&amp;</span> <span class="n">err</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Configure adapter. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_x25_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">cycx_x25_config</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="n">u16</span> <span class="n">nlinks</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">cycx_x25_config</span> <span class="n">conf</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">x25_cmd_conf</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_cmd_conf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x25_cmd_conf</span><span class="p">));</span>
	<span class="n">x25_cmd_conf</span><span class="p">.</span><span class="n">nlinks</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="n">x25_cmd_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
	<span class="cm">/* FIXME: we need to find a way in the wanrouter framework</span>
<span class="cm">		  to configure the second link, for now lets use it</span>
<span class="cm">		  with the same config from the first link, fixing</span>
<span class="cm">		  the interface type to RS232, the speed in 38400 and</span>
<span class="cm">		  the clock to external */</span>
	<span class="n">x25_cmd_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">conf</span><span class="p">;</span>
	<span class="n">x25_cmd_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">link</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">x25_cmd_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">speed</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span> <span class="cm">/* 38400 */</span>
	<span class="n">x25_cmd_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">clock</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">x25_cmd_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* default = RS232 */</span>

	<span class="n">cycx_x25_dump_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_cmd_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
	<span class="n">cycx_x25_dump_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">x25_cmd_conf</span><span class="p">.</span><span class="n">conf</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">x25_exec</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">X25_CONFIG</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">x25_cmd_conf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">x25_cmd_conf</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Get protocol statistics. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_x25_get_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* the firmware expects 20 in the size field!!!</span>
<span class="cm">	   thanks to Daniela */</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="n">x25_exec</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">X25_STATISTIC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">interruptible_sleep_on</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wait_stats</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINTR</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_packets</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">n2_rx_frames</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_over_errors</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_crc_errors</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_length_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not available from fw */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_frame_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not available from fw */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_missed_errors</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_aborts</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_dropped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not available from fw */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">rx_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not available from fw */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_packets</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">n2_tx_frames</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborted_errors</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_aborts</span><span class="p">;</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_dropped</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not available from fw */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">collisions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not available from fw */</span>
	<span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">stats</span><span class="p">.</span><span class="n">tx_errors</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* not available from fw */</span>

	<span class="n">cycx_x25_dump_devs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* return the number of nibbles */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">byte_to_nibble</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nibble</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">nibble</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="o">*</span><span class="n">nibble</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
			<span class="n">d</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="o">*</span><span class="p">(</span><span class="n">s</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="sc">&#39;0&#39;</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">nibble</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="o">++</span><span class="n">i</span><span class="p">;</span>
		<span class="n">s</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">nibble_to_byte</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span> <span class="n">u8</span> <span class="n">len</span><span class="p">,</span> <span class="n">u8</span> <span class="n">nibble</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nibble</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span><span class="o">++</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
		<span class="o">--</span><span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">d</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;0&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">s</span> <span class="o">&amp;</span> <span class="mh">0x0F</span><span class="p">);</span>
			<span class="o">--</span><span class="n">len</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">break</span><span class="p">;</span>

		<span class="o">++</span><span class="n">s</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">*</span><span class="n">d</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Place X.25 call. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_place_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
			  <span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="n">len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">d</span><span class="p">[</span><span class="mi">64</span><span class="p">],</span>
	     <span class="n">nibble</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	     <span class="n">mylen</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_addr</span> <span class="o">?</span> <span class="n">strlen</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">)</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
	     <span class="n">remotelen</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">key</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">connection_keys</span> <span class="o">==</span> <span class="o">~</span><span class="mi">0U</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: too many simultaneous connection requests!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">ffz</span><span class="p">(</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">connection_keys</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">connection_keys</span><span class="p">);</span>
	<span class="o">++</span><span class="n">key</span><span class="p">;</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s:x25_place_call:key=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">d</span><span class="p">));</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span> <span class="cm">/* user key */</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0B</span><span class="p">;</span>

	<span class="n">len</span> <span class="o">=</span> <span class="n">byte_to_nibble</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">6</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nibble</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">+=</span> <span class="n">byte_to_nibble</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">local_addr</span><span class="p">,</span> <span class="n">d</span> <span class="o">+</span> <span class="mi">6</span> <span class="o">+</span> <span class="n">len</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">nibble</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nibble</span><span class="p">)</span>
		<span class="o">++</span><span class="n">len</span><span class="p">;</span>

	<span class="n">d</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">mylen</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span> <span class="o">|</span> <span class="n">remotelen</span><span class="p">;</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">6</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xCC</span><span class="p">;</span> <span class="cm">/* TCP/IP over X.25, thanks to Daniela :) */</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">x25_exec</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">X25_CONNECT_REQUEST</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">len</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="o">--</span><span class="n">key</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">u</span><span class="p">.</span><span class="n">x</span><span class="p">.</span><span class="n">connection_keys</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">lcn</span> <span class="o">=</span> <span class="o">-</span><span class="n">key</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Place X.25 CONNECT RESPONSE. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_x25_connect_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">d</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">d</span><span class="p">));</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">lcn</span><span class="p">;</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x0F</span><span class="p">;</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0xCC</span><span class="p">;</span> <span class="cm">/* TCP/IP over X.25, thanks Daniela */</span>

	<span class="k">return</span> <span class="n">x25_exec</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">X25_CONNECT_RESPONSE</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Place X.25 DISCONNECT RESPONSE.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_x25_disconnect_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">lcn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">d</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">d</span><span class="p">));</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">lcn</span><span class="p">;</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x17</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">x25_exec</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">X25_DISCONNECT_RESPONSE</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Clear X.25 call.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">x25_clear_call</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lcn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cause</span><span class="p">,</span>
			  <span class="n">u8</span> <span class="n">diagn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">d</span><span class="p">[</span><span class="mi">7</span><span class="p">];</span>

	<span class="n">memset</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">d</span><span class="p">));</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">lcn</span><span class="p">;</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mh">0x13</span><span class="p">;</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">cause</span><span class="p">;</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">diagn</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">x25_exec</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">X25_DISCONNECT_REQUEST</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Send X.25 data packet. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_x25_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="n">u8</span> <span class="n">link</span><span class="p">,</span> <span class="n">u8</span> <span class="n">lcn</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bitm</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">d</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;?</span><span class="se">\xFF\x10</span><span class="s">??&quot;</span><span class="p">;</span>

	<span class="n">d</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">lcn</span><span class="p">;</span>
	<span class="n">d</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">bitm</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">x25_exec</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">X25_DATA_REQUEST</span><span class="p">,</span> <span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">d</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Miscellaneous */</span>
<span class="cm">/* Find network device by its channel number.  */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">cycx_x25_get_dev_by_lcn</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">,</span>
						  <span class="n">s16</span> <span class="n">lcn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lcn</span> <span class="o">==</span> <span class="n">lcn</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Find network device by its remote dte address. */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span>
	<span class="nf">cycx_x25_get_dev_by_dte_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">dte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">dte</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Initiate connection on the logical channel.</span>
<span class="cm"> * o for PVC we just get channel configuration</span>
<span class="cm"> * o for SVCs place an X.25 call</span>
<span class="cm"> *</span>
<span class="cm"> * Return:	0	connected</span>
<span class="cm"> *		&gt;0	connection in progress</span>
<span class="cm"> *		&lt;0	failure */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_x25_chan_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">svc</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span> <span class="cm">/* no destination address */</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERN_INFO</span> <span class="s">&quot;%s: placing X.25 call to %s...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				  <span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">x25_place_call</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">chan</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="n">cycx_x25_set_chan_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WAN_CONNECTING</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cycx_x25_set_chan_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WAN_CONNECTED</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Disconnect logical channel.</span>
<span class="cm"> * o if SVC then clear X.25 call */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_chan_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">svc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">x25_clear_call</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">lcn</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cycx_x25_set_chan_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WAN_DISCONNECTING</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">cycx_x25_set_chan_state</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">WAN_DISCONNECTED</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Called by kernel timer */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_chan_timer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">d</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">d</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WAN_CONNECTED</span><span class="p">)</span>
		<span class="n">cycx_x25_chan_disconnect</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: %s for svc (%s) not connected!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Set logical channel state. */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_set_chan_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">string_state</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">svc</span> <span class="o">&amp;&amp;</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">==</span> <span class="n">WAN_CONNECTED</span><span class="p">)</span>
			<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">WAN_CONNECTED</span>:
			<span class="n">string_state</span> <span class="o">=</span> <span class="s">&quot;connected!&quot;</span><span class="p">;</span>
			<span class="o">*</span><span class="p">(</span><span class="n">__be16</span><span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">=</span> <span class="n">htons</span><span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">lcn</span><span class="p">);</span>
			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">reset_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_X25</span><span class="p">)</span>
				<span class="n">cycx_x25_chan_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">X25_IFACE_CONNECT</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WAN_CONNECTING</span>:
			<span class="n">string_state</span> <span class="o">=</span> <span class="s">&quot;connecting...&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WAN_DISCONNECTING</span>:
			<span class="n">string_state</span> <span class="o">=</span> <span class="s">&quot;disconnecting...&quot;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">WAN_DISCONNECTED</span>:
			<span class="n">string_state</span> <span class="o">=</span> <span class="s">&quot;disconnected!&quot;</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">svc</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">*</span><span class="p">)</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev_addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="n">chan</span><span class="o">-&gt;</span><span class="n">lcn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_X25</span><span class="p">)</span>
				<span class="n">cycx_x25_chan_send_event</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					<span class="n">X25_IFACE_DISCONNECT</span><span class="p">);</span>

			<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s: interface %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">card</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">string_state</span><span class="p">);</span>
		<span class="n">chan</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Send packet on a logical channel.</span>
<span class="cm"> *	When this function is called, tx_skb field of the channel data space</span>
<span class="cm"> *	points to the transmit socket buffer.  When transmission is complete,</span>
<span class="cm"> *	release socket buffer and reset &#39;tbusy&#39; flag.</span>
<span class="cm"> *</span>
<span class="cm"> * Return:	0	- transmission complete</span>
<span class="cm"> *		1	- busy</span>
<span class="cm"> *</span>
<span class="cm"> * Notes:</span>
<span class="cm"> * 1. If packet length is greater than MTU for this channel, we&#39;ll fragment</span>
<span class="cm"> *    the packet into &#39;complete sequence&#39; using M-bit.</span>
<span class="cm"> * 2. When transmission is complete, an event notification should be issued</span>
<span class="cm"> *    to the router.  */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">cycx_x25_chan_send</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">cycx_device</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bitm</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* final packet */</span>
	<span class="kt">unsigned</span> <span class="n">len</span> <span class="o">=</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">mtu</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">wandev</span><span class="p">.</span><span class="n">mtu</span><span class="p">;</span>
		<span class="n">bitm</span> <span class="o">=</span> <span class="mh">0x10</span><span class="p">;</span>		<span class="cm">/* set M-bit (more data) */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cycx_x25_send</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">lcn</span><span class="p">,</span> <span class="n">bitm</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bitm</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">skb_pull</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="o">++</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">ifstats</span><span class="p">.</span><span class="n">tx_packets</span><span class="p">;</span>
	<span class="n">chan</span><span class="o">-&gt;</span><span class="n">ifstats</span><span class="p">.</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send event (connection, disconnection, etc) to X.25 socket layer */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_chan_send_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">event</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">skb</span> <span class="o">=</span> <span class="n">dev_alloc_skb</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;%s: out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ptr</span>  <span class="o">=</span> <span class="n">skb_put</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="n">event</span><span class="p">;</span>

	<span class="n">skb</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">=</span> <span class="n">x25_type_trans</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Convert line speed in bps to a number used by cyclom 2x code. */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">bps_to_speed_code</span><span class="p">(</span><span class="n">u32</span> <span class="n">bps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* defaults to the lowest (1200) speed ;&gt; */</span>

	     <span class="k">if</span> <span class="p">(</span><span class="n">bps</span> <span class="o">&gt;=</span> <span class="mi">512000</span><span class="p">)</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bps</span> <span class="o">&gt;=</span> <span class="mi">256000</span><span class="p">)</span> <span class="n">number</span> <span class="o">=</span> <span class="mi">7</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bps</span> <span class="o">&gt;=</span> <span class="mi">64000</span><span class="p">)</span>  <span class="n">number</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bps</span> <span class="o">&gt;=</span> <span class="mi">38400</span><span class="p">)</span>  <span class="n">number</span> <span class="o">=</span> <span class="mi">5</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bps</span> <span class="o">&gt;=</span> <span class="mi">19200</span><span class="p">)</span>  <span class="n">number</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bps</span> <span class="o">&gt;=</span> <span class="mi">9600</span><span class="p">)</span>   <span class="n">number</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bps</span> <span class="o">&gt;=</span> <span class="mi">4800</span><span class="p">)</span>   <span class="n">number</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bps</span> <span class="o">&gt;=</span> <span class="mi">2400</span><span class="p">)</span>   <span class="n">number</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">number</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* log base 2 */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">cycx_log2</span><span class="p">(</span><span class="n">u32</span> <span class="n">n</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">log</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">n</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="o">++</span><span class="n">log</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">log</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Convert decimal string to unsigned integer.</span>
<span class="cm"> * If len != 0 then only &#39;len&#39; characters of the string are converted. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="nf">dec_to_uint</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">str</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span>
		<span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">str</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;</span> <span class="n">len</span> <span class="o">&amp;&amp;</span> <span class="n">isdigit</span><span class="p">(</span><span class="o">*</span><span class="n">str</span><span class="p">);</span> <span class="o">++</span><span class="n">str</span><span class="p">,</span> <span class="o">--</span><span class="n">len</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">*</span> <span class="mi">10</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="o">*</span><span class="n">str</span> <span class="o">-</span> <span class="p">(</span><span class="kt">unsigned</span><span class="p">)</span> <span class="sc">&#39;0&#39;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">reset_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">svc</span><span class="p">)</span>
		<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">,</span> <span class="n">jiffies</span><span class="o">+</span><span class="n">chan</span><span class="o">-&gt;</span><span class="n">idle_tmout</span><span class="o">*</span><span class="n">HZ</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#ifdef CYCLOMX_X25_DEBUG</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_dump_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_x25_config</span> <span class="o">*</span><span class="n">conf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;X.25 configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;-----------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;link number=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;line speed=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;clock=%sternal</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">clock</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">?</span> <span class="s">&quot;Ex&quot;</span> <span class="o">:</span> <span class="s">&quot;In&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;# level 2 retransm.=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">n2</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;level 2 window=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">n2win</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;level 3 window=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">n3win</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;# logical channels=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">nvc</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;level 3 pkt len=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">pktlen</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;my address=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">locaddr</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;remote address=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">remaddr</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;t1=%d seconds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">t1</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;t2=%d seconds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">t2</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;t21=%d seconds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">t21</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;# PVCs=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">npvc</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;t23=%d seconds</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">t23</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;flags=0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">conf</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_dump_stats</span><span class="p">(</span><span class="k">struct</span> <span class="n">cycx_x25_stats</span> <span class="o">*</span><span class="n">stats</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;X.25 statistics</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;--------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;rx_crc_errors=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_crc_errors</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;rx_over_errors=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_over_errors</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;n2_tx_frames=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">n2_tx_frames</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;n2_rx_frames=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">n2_rx_frames</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;tx_timeouts=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_timeouts</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;rx_timeouts=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_timeouts</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;n3_tx_packets=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">n3_tx_packets</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;n3_rx_packets=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">n3_rx_packets</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;tx_aborts=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_aborts</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;rx_aborts=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_aborts</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cycx_x25_dump_devs</span><span class="p">(</span><span class="k">struct</span> <span class="n">wan_device</span> <span class="o">*</span><span class="n">wandev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">wandev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;X.25 dev states</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;name: addr:           txoff:  protocol:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;---------------------------------------</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">while</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">cycx_x25_channel</span> <span class="o">*</span><span class="n">chan</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%-5.5s %-15.15s   %d     ETH_P_%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">addr</span><span class="p">,</span> <span class="n">netif_queue_stopped</span><span class="p">(</span><span class="n">dev</span><span class="p">),</span>
			<span class="n">chan</span><span class="o">-&gt;</span><span class="n">protocol</span> <span class="o">==</span> <span class="n">ETH_P_IP</span> <span class="o">?</span> <span class="s">&quot;IP&quot;</span> <span class="o">:</span> <span class="s">&quot;X25&quot;</span><span class="p">);</span>
		<span class="n">dev</span> <span class="o">=</span> <span class="n">chan</span><span class="o">-&gt;</span><span class="n">slave</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#endif </span><span class="cm">/* CYCLOMX_X25_DEBUG */</span><span class="cp"></span>
<span class="cm">/* End */</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
