<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › can › cc770 › cc770.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>cc770.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Core driver for the CC770 and AN82527 CAN controllers</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009, 2011 Wolfgang Grandegger &lt;wg@grandegger.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the version 2 of the GNU General Public License</span>
<span class="cm"> * as published by the Free Software Foundation</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE. See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/ptrace.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/netdevice.h&gt;</span>
<span class="cp">#include &lt;linux/if_arp.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>

<span class="cp">#include &lt;linux/can.h&gt;</span>
<span class="cp">#include &lt;linux/can/dev.h&gt;</span>
<span class="cp">#include &lt;linux/can/error.h&gt;</span>
<span class="cp">#include &lt;linux/can/platform/cc770.h&gt;</span>

<span class="cp">#include &quot;cc770.h&quot;</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Wolfgang Grandegger &lt;wg@grandegger.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">KBUILD_MODNAME</span> <span class="s">&quot;CAN netdevice driver&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * The CC770 is a CAN controller from Bosch, which is 100% compatible</span>
<span class="cm"> * with the AN82527 from Intel, but with &quot;bugs&quot; being fixed and some</span>
<span class="cm"> * additional functionality, mainly:</span>
<span class="cm"> *</span>
<span class="cm"> * 1. RX and TX error counters are readable.</span>
<span class="cm"> * 2. Support of silent (listen-only) mode.</span>
<span class="cm"> * 3. Message object 15 can receive all types of frames, also RTR and EFF.</span>
<span class="cm"> *</span>
<span class="cm"> * Details are available from Bosch&#39;s &quot;CC770_Product_Info_2007-01.pdf&quot;,</span>
<span class="cm"> * which explains in detail the compatibility between the CC770 and the</span>
<span class="cm"> * 82527. This driver use the additional functionality 3. on real CC770</span>
<span class="cm"> * devices. Unfortunately, the CC770 does still not store the message</span>
<span class="cm"> * identifier of received remote transmission request frames and</span>
<span class="cm"> * therefore it&#39;s set to 0.</span>
<span class="cm"> *</span>
<span class="cm"> * The message objects 1..14 can be used for TX and RX while the message</span>
<span class="cm"> * objects 15 is optimized for RX. It has a shadow register for reliable</span>
<span class="cm"> * data receiption under heavy bus load. Therefore it makes sense to use</span>
<span class="cm"> * this message object for the needed use case. The frame type (EFF/SFF)</span>
<span class="cm"> * for the message object 15 can be defined via kernel module parameter</span>
<span class="cm"> * &quot;msgobj15_eff&quot;. If not equal 0, it will receive 29-bit EFF frames,</span>
<span class="cm"> * otherwise 11 bit SFF messages.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">msgobj15_eff</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">msgobj15_eff</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">msgobj15_eff</span><span class="p">,</span> <span class="s">&quot;Extended 29-bit frames for message object 15 &quot;</span>
		 <span class="s">&quot;(default: 11-bit standard frames)&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">i82527_compat</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">i82527_compat</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">i82527_compat</span><span class="p">,</span> <span class="s">&quot;Strict Intel 82527 comptibility mode &quot;</span>
		 <span class="s">&quot;without using additional functions&quot;</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * This driver uses the last 5 message objects 11..15. The definitions</span>
<span class="cm"> * and structure below allows to configure and assign them to the real</span>
<span class="cm"> * message object.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cc770_obj_flags</span><span class="p">[</span><span class="n">CC770_OBJ_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">CC770_OBJ_RX0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CC770_OBJ_FLAG_RX</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CC770_OBJ_RX1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CC770_OBJ_FLAG_RX</span> <span class="o">|</span> <span class="n">CC770_OBJ_FLAG_EFF</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CC770_OBJ_RX_RTR0</span><span class="p">]</span> <span class="o">=</span> <span class="n">CC770_OBJ_FLAG_RX</span> <span class="o">|</span> <span class="n">CC770_OBJ_FLAG_RTR</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CC770_OBJ_RX_RTR1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CC770_OBJ_FLAG_RX</span> <span class="o">|</span> <span class="n">CC770_OBJ_FLAG_RTR</span> <span class="o">|</span>
			      <span class="n">CC770_OBJ_FLAG_EFF</span><span class="p">,</span>
	<span class="p">[</span><span class="n">CC770_OBJ_TX</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">can_bittiming_const</span> <span class="n">cc770_bittiming_const</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">KBUILD_MODNAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tseg1_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tseg1_max</span> <span class="o">=</span> <span class="mi">16</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tseg2_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">tseg2_max</span> <span class="o">=</span> <span class="mi">8</span><span class="p">,</span>
	<span class="p">.</span><span class="n">sjw_max</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>
	<span class="p">.</span><span class="n">brp_min</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">brp_max</span> <span class="o">=</span> <span class="mi">64</span><span class="p">,</span>
	<span class="p">.</span><span class="n">brp_inc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">intid2obj</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">intid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intid</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">MSGOBJ_LAST</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">intid</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">enable_all_objs</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">msgcfg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">obj_flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">o</span><span class="p">,</span> <span class="n">mo</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">o</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">obj_flags</span><span class="p">);</span> <span class="n">o</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">obj_flags</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">obj_flags</span><span class="p">[</span><span class="n">o</span><span class="p">];</span>
		<span class="n">mo</span> <span class="o">=</span> <span class="n">obj2msgobj</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">obj_flags</span> <span class="o">&amp;</span> <span class="n">CC770_OBJ_FLAG_RX</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * We don&#39;t need extra objects for RTR and EFF if</span>
<span class="cm">			 * the additional CC770 functions are enabled.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_normal_mode</span> <span class="o">&amp;</span> <span class="n">CTRL_EAF</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">continue</span><span class="p">;</span>
				<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Message object %d for &quot;</span>
					   <span class="s">&quot;RX data, RTR, SFF and EFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mo</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;Message object %d for RX %s %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">mo</span><span class="p">,</span> <span class="n">obj_flags</span> <span class="o">&amp;</span> <span class="n">CC770_OBJ_FLAG_RTR</span> <span class="o">?</span>
					   <span class="s">&quot;RTR&quot;</span> <span class="o">:</span> <span class="s">&quot;data&quot;</span><span class="p">,</span>
					   <span class="n">obj_flags</span> <span class="o">&amp;</span> <span class="n">CC770_OBJ_FLAG_EFF</span> <span class="o">?</span>
					   <span class="s">&quot;EFF&quot;</span> <span class="o">:</span> <span class="s">&quot;SFF&quot;</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">obj_flags</span> <span class="o">&amp;</span> <span class="n">CC770_OBJ_FLAG_EFF</span><span class="p">)</span>
				<span class="n">msgcfg</span> <span class="o">=</span> <span class="n">MSGCFG_XTD</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">msgcfg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">obj_flags</span> <span class="o">&amp;</span> <span class="n">CC770_OBJ_FLAG_RTR</span><span class="p">)</span>
				<span class="n">msgcfg</span> <span class="o">|=</span> <span class="n">MSGCFG_DIR</span><span class="p">;</span>

			<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">config</span><span class="p">,</span> <span class="n">msgcfg</span><span class="p">);</span>
			<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl0</span><span class="p">,</span>
					<span class="n">MSGVAL_SET</span> <span class="o">|</span> <span class="n">TXIE_RES</span> <span class="o">|</span>
					<span class="n">RXIE_SET</span> <span class="o">|</span> <span class="n">INTPND_RES</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">obj_flags</span> <span class="o">&amp;</span> <span class="n">CC770_OBJ_FLAG_RTR</span><span class="p">)</span>
				<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl1</span><span class="p">,</span>
						<span class="n">NEWDAT_RES</span> <span class="o">|</span> <span class="n">CPUUPD_SET</span> <span class="o">|</span>
						<span class="n">TXRQST_RES</span> <span class="o">|</span> <span class="n">RMTPND_RES</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl1</span><span class="p">,</span>
						<span class="n">NEWDAT_RES</span> <span class="o">|</span> <span class="n">MSGLST_RES</span> <span class="o">|</span>
						<span class="n">TXRQST_RES</span> <span class="o">|</span> <span class="n">RMTPND_RES</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Message object %d for &quot;</span>
				   <span class="s">&quot;TX data, RTR, SFF and EFF</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mo</span><span class="p">);</span>

			<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl1</span><span class="p">,</span>
					<span class="n">RMTPND_RES</span> <span class="o">|</span> <span class="n">TXRQST_RES</span> <span class="o">|</span>
					<span class="n">CPUUPD_RES</span> <span class="o">|</span> <span class="n">NEWDAT_RES</span><span class="p">);</span>
			<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl0</span><span class="p">,</span>
					<span class="n">MSGVAL_RES</span> <span class="o">|</span> <span class="n">TXIE_RES</span> <span class="o">|</span>
					<span class="n">RXIE_RES</span> <span class="o">|</span> <span class="n">INTPND_RES</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">disable_all_objs</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">o</span><span class="p">,</span> <span class="n">mo</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">o</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">o</span> <span class="o">&lt;</span>  <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">obj_flags</span><span class="p">);</span> <span class="n">o</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mo</span> <span class="o">=</span> <span class="n">obj2msgobj</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">obj_flags</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CC770_OBJ_FLAG_RX</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_normal_mode</span> <span class="o">&amp;</span> <span class="n">CTRL_EAF</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl1</span><span class="p">,</span>
					<span class="n">NEWDAT_RES</span> <span class="o">|</span> <span class="n">MSGLST_RES</span> <span class="o">|</span>
					<span class="n">TXRQST_RES</span> <span class="o">|</span> <span class="n">RMTPND_RES</span><span class="p">);</span>
			<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl0</span><span class="p">,</span>
					<span class="n">MSGVAL_RES</span> <span class="o">|</span> <span class="n">TXIE_RES</span> <span class="o">|</span>
					<span class="n">RXIE_RES</span> <span class="o">|</span> <span class="n">INTPND_RES</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Clear message object for send */</span>
			<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl1</span><span class="p">,</span>
					<span class="n">RMTPND_RES</span> <span class="o">|</span> <span class="n">TXRQST_RES</span> <span class="o">|</span>
					<span class="n">CPUUPD_RES</span> <span class="o">|</span> <span class="n">NEWDAT_RES</span><span class="p">);</span>
			<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl0</span><span class="p">,</span>
					<span class="n">MSGVAL_RES</span> <span class="o">|</span> <span class="n">TXIE_RES</span> <span class="o">|</span>
					<span class="n">RXIE_RES</span> <span class="o">|</span> <span class="n">INTPND_RES</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_reset_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Enable configuration and puts chip in bus-off, disable interrupts */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">CTRL_CCE</span> <span class="o">|</span> <span class="n">CTRL_INI</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CAN_STATE_STOPPED</span><span class="p">;</span>

	<span class="cm">/* Clear interrupts */</span>
	<span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">);</span>

	<span class="cm">/* Clear status register */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Disable all used message objects */</span>
	<span class="n">disable_all_objs</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_normal_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Clear interrupts */</span>
	<span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">);</span>

	<span class="cm">/* Clear status register and pre-set last error code */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">STAT_LEC_MASK</span><span class="p">);</span>

	<span class="cm">/* Enable all used message objects*/</span>
	<span class="n">enable_all_objs</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear bus-off, interrupts only for errors,</span>
<span class="cm">	 * not for status change</span>
<span class="cm">	 */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_normal_mode</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CAN_STATE_ERROR_ACTIVE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">chipset_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mo</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Enable configuration and put chip in bus-off, disable interrupts */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="p">(</span><span class="n">CTRL_CCE</span> <span class="o">|</span> <span class="n">CTRL_INI</span><span class="p">));</span>

	<span class="cm">/* Set CLKOUT divider and slew rates */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">clkout</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">clkout</span><span class="p">);</span>

	<span class="cm">/* Configure CPU interface / CLKOUT enable */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cpu_interface</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cpu_interface</span><span class="p">);</span>

	<span class="cm">/* Set bus configuration  */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bus_config</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_config</span><span class="p">);</span>

	<span class="cm">/* Clear interrupts */</span>
	<span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">);</span>

	<span class="cm">/* Clear status register */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Clear and invalidate message objects */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">mo</span> <span class="o">=</span> <span class="n">MSGOBJ_FIRST</span><span class="p">;</span> <span class="n">mo</span> <span class="o">&lt;=</span> <span class="n">MSGOBJ_LAST</span><span class="p">;</span> <span class="n">mo</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl0</span><span class="p">,</span>
				<span class="n">INTPND_UNC</span> <span class="o">|</span> <span class="n">RXIE_RES</span> <span class="o">|</span>
				<span class="n">TXIE_RES</span> <span class="o">|</span> <span class="n">MSGVAL_RES</span><span class="p">);</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl0</span><span class="p">,</span>
				<span class="n">INTPND_RES</span> <span class="o">|</span> <span class="n">RXIE_RES</span> <span class="o">|</span>
				<span class="n">TXIE_RES</span> <span class="o">|</span> <span class="n">MSGVAL_RES</span><span class="p">);</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl1</span><span class="p">,</span>
				<span class="n">NEWDAT_RES</span> <span class="o">|</span> <span class="n">MSGLST_RES</span> <span class="o">|</span>
				<span class="n">TXRQST_RES</span> <span class="o">|</span> <span class="n">RMTPND_RES</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">data</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">data</span><span class="o">++</span><span class="p">)</span>
			<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="n">data</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">id</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">id</span><span class="o">++</span><span class="p">)</span>
			<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">id</span><span class="p">[</span><span class="n">id</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">config</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Set all global ID masks to &quot;don&#39;t care&quot; */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">global_mask_std</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">global_mask_std</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">global_mask_ext</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">global_mask_ext</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">global_mask_ext</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">global_mask_ext</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cc770_probe_chip</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Enable configuration, put chip in bus-off, disable ints */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">CTRL_CCE</span> <span class="o">|</span> <span class="n">CTRL_EAF</span> <span class="o">|</span> <span class="n">CTRL_INI</span><span class="p">);</span>
	<span class="cm">/* Configure cpu interface / CLKOUT disable */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cpu_interface</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">cpu_interface</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if hardware reset is still inactive or maybe there</span>
<span class="cm">	 * is no chip in this address space</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">cpu_interface</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CPUIF_RST</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probing @0x%p failed (reset)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Write and read back test pattern (some arbitrary values) */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mh">0x25</span><span class="p">);</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="mh">0x52</span><span class="p">);</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span> <span class="mh">0xc3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">!=</span> <span class="mh">0x25</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="o">!=</span> <span class="mh">0x52</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="mi">10</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span> <span class="o">!=</span> <span class="mh">0xc3</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;probing @0x%p failed (pattern)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			    <span class="n">priv</span><span class="o">-&gt;</span><span class="n">reg_base</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Check if this chip is a CC770 supporting additional functions */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">control</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">CTRL_EAF</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_normal_mode</span> <span class="o">|=</span> <span class="n">CTRL_EAF</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cc770_start</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* leave reset mode */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">state</span> <span class="o">!=</span> <span class="n">CAN_STATE_STOPPED</span><span class="p">)</span>
		<span class="n">set_reset_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* leave reset mode */</span>
	<span class="n">set_normal_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cc770_set_mode</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">can_mode</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">mode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CAN_MODE_START</span>:
		<span class="n">cc770_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cc770_set_bittiming</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">can_bittiming</span> <span class="o">*</span><span class="n">bt</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">bittiming</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">btr0</span><span class="p">,</span> <span class="n">btr1</span><span class="p">;</span>

	<span class="n">btr0</span> <span class="o">=</span> <span class="p">((</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">brp</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">sjw</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
	<span class="n">btr1</span> <span class="o">=</span> <span class="p">((</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">prop_seg</span> <span class="o">+</span> <span class="n">bt</span><span class="o">-&gt;</span><span class="n">phase_seg1</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span>
		<span class="p">(((</span><span class="n">bt</span><span class="o">-&gt;</span><span class="n">phase_seg2</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">ctrlmode</span> <span class="o">&amp;</span> <span class="n">CAN_CTRLMODE_3_SAMPLES</span><span class="p">)</span>
		<span class="n">btr1</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="n">netdev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;setting BTR0=0x%02x BTR1=0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">btr0</span><span class="p">,</span> <span class="n">btr1</span><span class="p">);</span>

	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bit_timing_0</span><span class="p">,</span> <span class="n">btr0</span><span class="p">);</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">bit_timing_1</span><span class="p">,</span> <span class="n">btr1</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cc770_get_berr_counter</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">can_berr_counter</span> <span class="o">*</span><span class="n">bec</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">bec</span><span class="o">-&gt;</span><span class="n">txerr</span> <span class="o">=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tx_error_counter</span><span class="p">);</span>
	<span class="n">bec</span><span class="o">-&gt;</span><span class="n">rxerr</span> <span class="o">=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rx_error_counter</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">netdev_tx_t</span> <span class="nf">cc770_start_xmit</span><span class="p">(</span><span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">,</span> <span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">can_frame</span> <span class="o">*</span><span class="n">cf</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">can_frame</span> <span class="o">*</span><span class="p">)</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mo</span> <span class="o">=</span> <span class="n">obj2msgobj</span><span class="p">(</span><span class="n">CC770_OBJ_TX</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">dlc</span><span class="p">,</span> <span class="n">rtr</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">can_dropped_invalid_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">skb</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span>
			    <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">TXRQST_UNC</span><span class="p">)</span> <span class="o">==</span> <span class="n">TXRQST_SET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TX register is still occupied!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">NETDEV_TX_BUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dlc</span> <span class="o">=</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_dlc</span><span class="p">;</span>
	<span class="n">id</span> <span class="o">=</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_id</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_id</span> <span class="o">&amp;</span> <span class="n">CAN_RTR_FLAG</span><span class="p">)</span>
		<span class="n">rtr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">rtr</span> <span class="o">=</span> <span class="n">MSGCFG_DIR</span><span class="p">;</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl1</span><span class="p">,</span>
			<span class="n">RMTPND_RES</span> <span class="o">|</span> <span class="n">TXRQST_RES</span> <span class="o">|</span> <span class="n">CPUUPD_SET</span> <span class="o">|</span> <span class="n">NEWDAT_RES</span><span class="p">);</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl0</span><span class="p">,</span>
			<span class="n">MSGVAL_SET</span> <span class="o">|</span> <span class="n">TXIE_SET</span> <span class="o">|</span> <span class="n">RXIE_RES</span> <span class="o">|</span> <span class="n">INTPND_RES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&amp;</span> <span class="n">CAN_EFF_FLAG</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id</span> <span class="o">&amp;=</span> <span class="n">CAN_EFF_MASK</span><span class="p">;</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">config</span><span class="p">,</span>
				<span class="p">(</span><span class="n">dlc</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">rtr</span> <span class="o">|</span> <span class="n">MSGCFG_XTD</span><span class="p">);</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">id</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">13</span><span class="p">);</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">21</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">id</span> <span class="o">&amp;=</span> <span class="n">CAN_SFF_MASK</span><span class="p">;</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">config</span><span class="p">,</span> <span class="p">(</span><span class="n">dlc</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="n">rtr</span><span class="p">);</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">id</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">dlc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="cm">/* Store echo skb before starting the transfer */</span>
	<span class="n">can_put_echo_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl1</span><span class="p">,</span>
			<span class="n">RMTPND_RES</span> <span class="o">|</span> <span class="n">TXRQST_SET</span> <span class="o">|</span> <span class="n">CPUUPD_RES</span> <span class="o">|</span> <span class="n">NEWDAT_UNC</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_bytes</span> <span class="o">+=</span> <span class="n">dlc</span><span class="p">;</span>


	<span class="cm">/*</span>
<span class="cm">	 * HM: We had some cases of repeated IRQs so make sure the</span>
<span class="cm">	 * INT is acknowledged I know it&#39;s already further up, but</span>
<span class="cm">	 * doing again fixed the issue</span>
<span class="cm">	 */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl0</span><span class="p">,</span>
			<span class="n">MSGVAL_UNC</span> <span class="o">|</span> <span class="n">TXIE_UNC</span> <span class="o">|</span> <span class="n">RXIE_UNC</span> <span class="o">|</span> <span class="n">INTPND_RES</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">NETDEV_TX_OK</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cc770_rx</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mo</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ctrl1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">can_frame</span> <span class="o">*</span><span class="n">cf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">config</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_can_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">config</span> <span class="o">=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">config</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctrl1</span> <span class="o">&amp;</span> <span class="n">RMTPND_SET</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Unfortunately, the chip does not store the real message</span>
<span class="cm">		 * identifier of the received remote transmission request</span>
<span class="cm">		 * frame. Therefore we set it to 0.</span>
<span class="cm">		 */</span>
		<span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_id</span> <span class="o">=</span> <span class="n">CAN_RTR_FLAG</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">MSGCFG_XTD</span><span class="p">)</span>
			<span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_id</span> <span class="o">|=</span> <span class="n">CAN_EFF_FLAG</span><span class="p">;</span>
		<span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_dlc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">config</span> <span class="o">&amp;</span> <span class="n">MSGCFG_XTD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">id</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="n">id</span> <span class="o">|=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">id</span> <span class="o">|=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
			<span class="n">id</span> <span class="o">|=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">;</span>
			<span class="n">id</span> <span class="o">&gt;&gt;=</span> <span class="mi">3</span><span class="p">;</span>
			<span class="n">id</span> <span class="o">|=</span> <span class="n">CAN_EFF_FLAG</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">id</span> <span class="o">=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">id</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
			<span class="n">id</span> <span class="o">|=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
			<span class="n">id</span> <span class="o">&gt;&gt;=</span> <span class="mi">5</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>
		<span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_dlc</span> <span class="o">=</span> <span class="n">get_can_dlc</span><span class="p">((</span><span class="n">config</span> <span class="o">&amp;</span> <span class="mh">0xf0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_dlc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">cf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_dlc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cc770_err</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">can_frame</span> <span class="o">*</span><span class="n">cf</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">lec</span><span class="p">;</span>

	<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;status interrupt (%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="n">skb</span> <span class="o">=</span> <span class="n">alloc_can_err_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">skb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="cm">/* Use extended functions of the CC770 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_normal_mode</span> <span class="o">&amp;</span> <span class="n">CTRL_EAF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">tx_error_counter</span><span class="p">);</span>
		<span class="n">cf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">rx_error_counter</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_BOFF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Disable interrupts */</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">control</span><span class="p">,</span> <span class="n">CTRL_INI</span><span class="p">);</span>
		<span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_id</span> <span class="o">|=</span> <span class="n">CAN_ERR_BUSOFF</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CAN_STATE_BUS_OFF</span><span class="p">;</span>
		<span class="n">can_bus_off</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_WARN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_id</span> <span class="o">|=</span> <span class="n">CAN_ERR_CRTL</span><span class="p">;</span>
		<span class="cm">/* Only the CC770 does show error passive */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CAN_ERR_CRTL_RX_PASSIVE</span> <span class="o">|</span>
				<span class="n">CAN_ERR_CRTL_TX_PASSIVE</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CAN_STATE_ERROR_PASSIVE</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">can_stats</span><span class="p">.</span><span class="n">error_passive</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">CAN_ERR_CRTL_RX_WARNING</span> <span class="o">|</span>
				<span class="n">CAN_ERR_CRTL_TX_WARNING</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CAN_STATE_ERROR_WARNING</span><span class="p">;</span>
			<span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">can_stats</span><span class="p">.</span><span class="n">error_warning</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Back to error avtive */</span>
		<span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_id</span> <span class="o">|=</span> <span class="n">CAN_ERR_PROT</span><span class="p">;</span>
		<span class="n">cf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">CAN_ERR_PROT_ACTIVE</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">state</span> <span class="o">=</span> <span class="n">CAN_STATE_ERROR_ACTIVE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lec</span> <span class="o">=</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_LEC_MASK</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lec</span> <span class="o">&lt;</span> <span class="mi">7</span> <span class="o">&amp;&amp;</span> <span class="n">lec</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lec</span> <span class="o">==</span> <span class="n">STAT_LEC_ACK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_id</span> <span class="o">|=</span> <span class="n">CAN_ERR_ACK</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_id</span> <span class="o">|=</span> <span class="n">CAN_ERR_PROT</span><span class="p">;</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">lec</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">case</span> <span class="n">STAT_LEC_STUFF</span>:
				<span class="n">cf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CAN_ERR_PROT_STUFF</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">STAT_LEC_FORM</span>:
				<span class="n">cf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CAN_ERR_PROT_FORM</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">STAT_LEC_BIT1</span>:
				<span class="n">cf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CAN_ERR_PROT_BIT1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">STAT_LEC_BIT0</span>:
				<span class="n">cf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CAN_ERR_PROT_BIT0</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">case</span> <span class="n">STAT_LEC_CRC</span>:
				<span class="n">cf</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CAN_ERR_PROT_LOC_CRC_SEQ</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">netif_rx</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_bytes</span> <span class="o">+=</span> <span class="n">cf</span><span class="o">-&gt;</span><span class="n">can_dlc</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cc770_status_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="cm">/* Reset the status register including RXOK and TXOK */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">STAT_LEC_MASK</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">STAT_WARN</span> <span class="o">|</span> <span class="n">STAT_BOFF</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_LEC_MASK</span><span class="p">)</span> <span class="o">!=</span> <span class="n">STAT_LEC_MASK</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cc770_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span> <span class="o">&amp;</span> <span class="n">STAT_BOFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cc770_rx_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mo</span> <span class="o">=</span> <span class="n">obj2msgobj</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ctrl1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">CC770_MAX_MSG</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl1</span> <span class="o">=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl1</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl1</span> <span class="o">&amp;</span> <span class="n">NEWDAT_SET</span><span class="p">))</span>  <span class="p">{</span>
			<span class="cm">/* Check for RTR if additional functions are enabled */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_normal_mode</span> <span class="o">&amp;</span> <span class="n">CTRL_EAF</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl0</span><span class="p">)</span> <span class="o">&amp;</span>
				      <span class="n">INTPND_SET</span><span class="p">))</span>
					<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ctrl1</span> <span class="o">&amp;</span> <span class="n">MSGLST_SET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_over_errors</span><span class="o">++</span><span class="p">;</span>
			<span class="n">stats</span><span class="o">-&gt;</span><span class="n">rx_errors</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mo</span> <span class="o">&lt;</span> <span class="n">MSGOBJ_LAST</span><span class="p">)</span>
			<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl1</span><span class="p">,</span>
					<span class="n">NEWDAT_RES</span> <span class="o">|</span> <span class="n">MSGLST_RES</span> <span class="o">|</span>
					<span class="n">TXRQST_UNC</span> <span class="o">|</span> <span class="n">RMTPND_UNC</span><span class="p">);</span>
		<span class="n">cc770_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mo</span><span class="p">,</span> <span class="n">ctrl1</span><span class="p">);</span>

		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl0</span><span class="p">,</span>
				<span class="n">MSGVAL_SET</span> <span class="o">|</span> <span class="n">TXIE_RES</span> <span class="o">|</span>
				<span class="n">RXIE_SET</span> <span class="o">|</span> <span class="n">INTPND_RES</span><span class="p">);</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl1</span><span class="p">,</span>
				<span class="n">NEWDAT_RES</span> <span class="o">|</span> <span class="n">MSGLST_RES</span> <span class="o">|</span>
				<span class="n">TXRQST_RES</span> <span class="o">|</span> <span class="n">RMTPND_RES</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cc770_rtr_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mo</span> <span class="o">=</span> <span class="n">obj2msgobj</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">ctrl0</span><span class="p">,</span> <span class="n">ctrl1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">CC770_MAX_MSG</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctrl0</span> <span class="o">=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ctrl0</span> <span class="o">&amp;</span> <span class="n">INTPND_SET</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">ctrl1</span> <span class="o">=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl1</span><span class="p">);</span>
		<span class="n">cc770_rx</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">mo</span><span class="p">,</span> <span class="n">ctrl1</span><span class="p">);</span>

		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl0</span><span class="p">,</span>
				<span class="n">MSGVAL_SET</span> <span class="o">|</span> <span class="n">TXIE_RES</span> <span class="o">|</span>
				<span class="n">RXIE_SET</span> <span class="o">|</span> <span class="n">INTPND_RES</span><span class="p">);</span>
		<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl1</span><span class="p">,</span>
				<span class="n">NEWDAT_RES</span> <span class="o">|</span> <span class="n">CPUUPD_SET</span> <span class="o">|</span>
				<span class="n">TXRQST_RES</span> <span class="o">|</span> <span class="n">RMTPND_RES</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cc770_tx_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">o</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">net_device_stats</span> <span class="o">*</span><span class="n">stats</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">stats</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mo</span> <span class="o">=</span> <span class="n">obj2msgobj</span><span class="p">(</span><span class="n">o</span><span class="p">);</span>

	<span class="cm">/* Nothing more to send, switch off interrupts */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl0</span><span class="p">,</span>
			<span class="n">MSGVAL_RES</span> <span class="o">|</span> <span class="n">TXIE_RES</span> <span class="o">|</span> <span class="n">RXIE_RES</span> <span class="o">|</span> <span class="n">INTPND_RES</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * We had some cases of repeated IRQ so make sure the</span>
<span class="cm">	 * INT is acknowledged</span>
<span class="cm">	 */</span>
	<span class="n">cc770_write_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">msgobj</span><span class="p">[</span><span class="n">mo</span><span class="p">].</span><span class="n">ctrl0</span><span class="p">,</span>
			<span class="n">MSGVAL_UNC</span> <span class="o">|</span> <span class="n">TXIE_UNC</span> <span class="o">|</span> <span class="n">RXIE_UNC</span> <span class="o">|</span> <span class="n">INTPND_RES</span><span class="p">);</span>

	<span class="n">stats</span><span class="o">-&gt;</span><span class="n">tx_packets</span><span class="o">++</span><span class="p">;</span>
	<span class="n">can_get_echo_skb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">netif_wake_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">irqreturn_t</span> <span class="nf">cc770_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">u8</span> <span class="n">intid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">o</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Shared interrupts and IRQ off? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">state</span> <span class="o">==</span> <span class="n">CAN_STATE_STOPPED</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">pre_irq</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">pre_irq</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">CC770_MAX_IRQ</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Read the highest pending interrupt request */</span>
		<span class="n">intid</span> <span class="o">=</span> <span class="n">cc770_read_reg</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">interrupt</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">intid</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">n</span><span class="o">++</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">intid</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Exit in case of bus-off */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cc770_status_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">o</span> <span class="o">=</span> <span class="n">intid2obj</span><span class="p">(</span><span class="n">intid</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">o</span> <span class="o">&gt;=</span> <span class="n">CC770_OBJ_MAX</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">netdev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unexpected interrupt id %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					   <span class="n">intid</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">obj_flags</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CC770_OBJ_FLAG_RTR</span><span class="p">)</span>
				<span class="n">cc770_rtr_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">o</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">obj_flags</span><span class="p">[</span><span class="n">o</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">CC770_OBJ_FLAG_RX</span><span class="p">)</span>
				<span class="n">cc770_rx_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">o</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">cc770_tx_interrupt</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">o</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">post_irq</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">post_irq</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&gt;=</span> <span class="n">CC770_MAX_IRQ</span><span class="p">)</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d messages handled in ISR&quot;</span><span class="p">,</span> <span class="n">n</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">?</span> <span class="n">IRQ_HANDLED</span> <span class="o">:</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cc770_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="cm">/* set chip into reset mode */</span>
	<span class="n">set_reset_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* common open */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">open_candev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cc770_interrupt</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">irq_flags</span><span class="p">,</span>
			  <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">close_candev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init and start chip */</span>
	<span class="n">cc770_start</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">netif_start_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">cc770_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">netif_stop_queue</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">set_reset_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="n">close_candev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="nf">alloc_cc770dev</span><span class="p">(</span><span class="kt">int</span> <span class="n">sizeof_priv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">alloc_candev</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cc770_priv</span><span class="p">)</span> <span class="o">+</span> <span class="n">sizeof_priv</span><span class="p">,</span>
			   <span class="n">CC770_ECHO_SKB_MAX</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">bittiming_const</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cc770_bittiming_const</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">do_set_bittiming</span> <span class="o">=</span> <span class="n">cc770_set_bittiming</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">do_set_mode</span> <span class="o">=</span> <span class="n">cc770_set_mode</span><span class="p">;</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">ctrlmode_supported</span> <span class="o">=</span> <span class="n">CAN_CTRLMODE_3_SAMPLES</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">obj_flags</span><span class="p">,</span> <span class="n">cc770_obj_flags</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cc770_obj_flags</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sizeof_priv</span><span class="p">)</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">priv</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">cc770_priv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">dev</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">alloc_cc770dev</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">free_cc770dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_candev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">free_cc770dev</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">net_device_ops</span> <span class="n">cc770_netdev_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">ndo_open</span> <span class="o">=</span> <span class="n">cc770_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_stop</span> <span class="o">=</span> <span class="n">cc770_close</span><span class="p">,</span>
	<span class="p">.</span><span class="n">ndo_start_xmit</span> <span class="o">=</span> <span class="n">cc770_start_xmit</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">register_cc770dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">cc770_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">netdev_priv</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">cc770_probe_chip</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">netdev_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">cc770_netdev_ops</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IFF_ECHO</span><span class="p">;</span>	<span class="cm">/* we support local echo */</span>

	<span class="cm">/* Should we use additional functions? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i82527_compat</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_normal_mode</span> <span class="o">&amp;</span> <span class="n">CTRL_EAF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">can</span><span class="p">.</span><span class="n">do_get_berr_counter</span> <span class="o">=</span> <span class="n">cc770_get_berr_counter</span><span class="p">;</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_normal_mode</span> <span class="o">=</span> <span class="n">CTRL_IE</span> <span class="o">|</span> <span class="n">CTRL_EAF</span> <span class="o">|</span> <span class="n">CTRL_EIE</span><span class="p">;</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;i82527 mode with additional functions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">control_normal_mode</span> <span class="o">=</span> <span class="n">CTRL_IE</span> <span class="o">|</span> <span class="n">CTRL_EIE</span><span class="p">;</span>
		<span class="n">netdev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;strict i82527 compatibility mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">chipset_init</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">set_reset_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">register_candev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">register_cc770dev</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">unregister_cc770dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">set_reset_mode</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">unregister_candev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">unregister_cc770dev</span><span class="p">);</span>

<span class="k">static</span> <span class="n">__init</span> <span class="kt">int</span> <span class="nf">cc770_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msgobj15_eff</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cc770_obj_flags</span><span class="p">[</span><span class="n">CC770_OBJ_RX0</span><span class="p">]</span> <span class="o">|=</span> <span class="n">CC770_OBJ_FLAG_EFF</span><span class="p">;</span>
		<span class="n">cc770_obj_flags</span><span class="p">[</span><span class="n">CC770_OBJ_RX1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">CC770_OBJ_FLAG_EFF</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;CAN netdevice driver</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">module_init</span><span class="p">(</span><span class="n">cc770_init</span><span class="p">);</span>

<span class="k">static</span> <span class="n">__exit</span> <span class="kt">void</span> <span class="nf">cc770_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;driver removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">cc770_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
