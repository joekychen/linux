<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › net › wimax › i2400m › control.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../../index.html"></a><h1>control.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Intel Wireless WiMAX Connection 2400m</span>
<span class="cm"> * Miscellaneous control functions for managing the device</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2007-2008 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Redistribution and use in source and binary forms, with or without</span>
<span class="cm"> * modification, are permitted provided that the following conditions</span>
<span class="cm"> * are met:</span>
<span class="cm"> *</span>
<span class="cm"> *   * Redistributions of source code must retain the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer.</span>
<span class="cm"> *   * Redistributions in binary form must reproduce the above copyright</span>
<span class="cm"> *     notice, this list of conditions and the following disclaimer in</span>
<span class="cm"> *     the documentation and/or other materials provided with the</span>
<span class="cm"> *     distribution.</span>
<span class="cm"> *   * Neither the name of Intel Corporation nor the names of its</span>
<span class="cm"> *     contributors may be used to endorse or promote products derived</span>
<span class="cm"> *     from this software without specific prior written permission.</span>
<span class="cm"> *</span>
<span class="cm"> * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS</span>
<span class="cm"> * &quot;AS IS&quot; AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR</span>
<span class="cm"> * A PARTICULAR PURPOSE ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT</span>
<span class="cm"> * OWNER OR CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL,</span>
<span class="cm"> * SPECIAL, EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT</span>
<span class="cm"> * LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE,</span>
<span class="cm"> * DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY</span>
<span class="cm"> * THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT</span>
<span class="cm"> * (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE</span>
<span class="cm"> * OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Intel Corporation &lt;linux-wimax@intel.com&gt;</span>
<span class="cm"> * Inaky Perez-Gonzalez &lt;inaky.perez-gonzalez@intel.com&gt;</span>
<span class="cm"> *  - Initial implementation</span>
<span class="cm"> *</span>
<span class="cm"> * This is a collection of functions used to control the device (plus</span>
<span class="cm"> * a few helpers).</span>
<span class="cm"> *</span>
<span class="cm"> * There are utilities for handling TLV buffers, hooks on the device&#39;s</span>
<span class="cm"> * reports to act on device changes of state [i2400m_report_hook()],</span>
<span class="cm"> * on acks to commands [i2400m_msg_ack_hook()], a helper for sending</span>
<span class="cm"> * commands to the device and blocking until a reply arrives</span>
<span class="cm"> * [i2400m_msg_to_dev()], a few high level commands for manipulating</span>
<span class="cm"> * the device state, powersving mode and configuration plus the</span>
<span class="cm"> * routines to setup the device once communication is stablished with</span>
<span class="cm"> * it [i2400m_dev_initialize()].</span>
<span class="cm"> *</span>
<span class="cm"> * ROADMAP</span>
<span class="cm"> *</span>
<span class="cm"> * i2400m_dev_initialize()       Called by i2400m_dev_start()</span>
<span class="cm"> *   i2400m_set_init_config()</span>
<span class="cm"> *   i2400m_cmd_get_state()</span>
<span class="cm"> * i2400m_dev_shutdown()        Called by i2400m_dev_stop()</span>
<span class="cm"> *   i2400m_reset()</span>
<span class="cm"> *</span>
<span class="cm"> * i2400m_{cmd,get,set}_*()</span>
<span class="cm"> *   i2400m_msg_to_dev()</span>
<span class="cm"> *   i2400m_msg_check_status()</span>
<span class="cm"> *</span>
<span class="cm"> * i2400m_report_hook()         Called on reception of an event</span>
<span class="cm"> *   i2400m_report_state_hook()</span>
<span class="cm"> *     i2400m_tlv_buffer_walk()</span>
<span class="cm"> *     i2400m_tlv_match()</span>
<span class="cm"> *     i2400m_report_tlv_system_state()</span>
<span class="cm"> *     i2400m_report_tlv_rf_switches_status()</span>
<span class="cm"> *     i2400m_report_tlv_media_status()</span>
<span class="cm"> *   i2400m_cmd_enter_powersave()</span>
<span class="cm"> *</span>
<span class="cm"> * i2400m_msg_ack_hook()        Called on reception of a reply to a</span>
<span class="cm"> *                              command, get or set</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &quot;i2400m.h&quot;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/wimax/i2400m.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>


<span class="cp">#define D_SUBMODULE control</span>
<span class="cp">#include &quot;debug-levels.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">i2400m_idle_mode_disabled</span><span class="p">;</span><span class="cm">/* 0 (idle mode enabled) by default */</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">idle_mode_disabled</span><span class="p">,</span> <span class="n">i2400m_idle_mode_disabled</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">idle_mode_disabled</span><span class="p">,</span>
		 <span class="s">&quot;If true, the device will not enable idle mode negotiation &quot;</span>
		 <span class="s">&quot;with the base station (when connected) to save power.&quot;</span><span class="p">);</span>

<span class="cm">/* 0 (power saving enabled) by default */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">i2400m_power_save_disabled</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">power_save_disabled</span><span class="p">,</span> <span class="n">i2400m_power_save_disabled</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">power_save_disabled</span><span class="p">,</span>
		 <span class="s">&quot;If true, the driver will not tell the device to enter &quot;</span>
		 <span class="s">&quot;power saving mode when it reports it is ready for it. &quot;</span>
		 <span class="s">&quot;False by default (so the device is told to do power &quot;</span>
		 <span class="s">&quot;saving).&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">i2400m_passive_mode</span><span class="p">;</span>	<span class="cm">/* 0 (passive mode disabled) by default */</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">passive_mode</span><span class="p">,</span> <span class="n">i2400m_passive_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">passive_mode</span><span class="p">,</span>
		 <span class="s">&quot;If true, the driver will not do any device setup &quot;</span>
		 <span class="s">&quot;and leave it up to user space, who must be properly &quot;</span>
		 <span class="s">&quot;setup.&quot;</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Return if a TLV is of a give type and size</span>
<span class="cm"> *</span>
<span class="cm"> * @tlv_hdr: pointer to the TLV</span>
<span class="cm"> * @tlv_type: type of the TLV we are looking for</span>
<span class="cm"> * @tlv_size: expected size of the TLV we are looking for (if -1,</span>
<span class="cm"> *            don&#39;t check the size). This includes the header</span>
<span class="cm"> * Returns: 0 if the TLV matches</span>
<span class="cm"> *          &lt; 0 if it doesn&#39;t match at all</span>
<span class="cm"> *          &gt; 0 total TLV + payload size, if the type matches, but not</span>
<span class="cm"> *              the size</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">ssize_t</span> <span class="nf">i2400m_tlv_match</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="o">*</span><span class="n">tlv</span><span class="p">,</span>
		     <span class="k">enum</span> <span class="n">i2400m_tlv</span> <span class="n">tlv_type</span><span class="p">,</span> <span class="kt">ssize_t</span> <span class="n">tlv_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tlv</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tlv_type</span><span class="p">)</span>	<span class="cm">/* Not our type? skip */</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlv_size</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span>
	    <span class="o">&amp;&amp;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tlv</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tlv</span><span class="p">)</span> <span class="o">!=</span> <span class="n">tlv_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tlv</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tlv</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;W: tlv type 0x%x mismatched because of &quot;</span>
		       <span class="s">&quot;size (got %zu vs %zu expected)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">tlv_type</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">tlv_size</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Given a buffer of TLVs, iterate over them</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device instance</span>
<span class="cm"> * @tlv_buf: pointer to the beginning of the TLV buffer</span>
<span class="cm"> * @buf_size: buffer size in bytes</span>
<span class="cm"> * @tlv_pos: seek position; this is assumed to be a pointer returned</span>
<span class="cm"> *           by i2400m_tlv_buffer_walk() [and thus, validated]. The</span>
<span class="cm"> *           TLV returned will be the one following this one.</span>
<span class="cm"> *</span>
<span class="cm"> * Usage:</span>
<span class="cm"> *</span>
<span class="cm"> * tlv_itr = NULL;</span>
<span class="cm"> * while (tlv_itr = i2400m_tlv_buffer_walk(i2400m, buf, size, tlv_itr))  {</span>
<span class="cm"> *         ...</span>
<span class="cm"> *         // Do stuff with tlv_itr, DON&#39;T MODIFY IT</span>
<span class="cm"> *         ...</span>
<span class="cm"> * }</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="o">*</span><span class="nf">i2400m_tlv_buffer_walk</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">tlv_buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buf_size</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="o">*</span><span class="n">tlv_pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="o">*</span><span class="n">tlv_top</span> <span class="o">=</span> <span class="n">tlv_buf</span> <span class="o">+</span> <span class="n">buf_size</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">offset</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">avail_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">type</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tlv_pos</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>	<span class="cm">/* Take the first one? */</span>
		<span class="n">tlv_pos</span> <span class="o">=</span> <span class="n">tlv_buf</span><span class="p">;</span>
	<span class="k">else</span>			<span class="cm">/* Nope, the next one */</span>
		<span class="n">tlv_pos</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">tlv_pos</span>
			<span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tlv_pos</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tlv_pos</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlv_pos</span> <span class="o">==</span> <span class="n">tlv_top</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* buffer done */</span>
		<span class="n">tlv_pos</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_beyond_end</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlv_pos</span> <span class="o">&gt;</span> <span class="n">tlv_top</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlv_pos</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_beyond_end</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">tlv_pos</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">tlv_buf</span><span class="p">;</span>
	<span class="n">avail_size</span> <span class="o">=</span> <span class="n">buf_size</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avail_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tlv_pos</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HW BUG? tlv_buf %p [%zu bytes], tlv @%zu: &quot;</span>
			<span class="s">&quot;short header</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">tlv_buf</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">offset</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_short_header</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tlv_pos</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">length</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tlv_pos</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">avail_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tlv_pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HW BUG? tlv_buf %p [%zu bytes], &quot;</span>
			<span class="s">&quot;tlv type 0x%04x @%zu: &quot;</span>
			<span class="s">&quot;short data (%zu bytes vs %zu needed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">tlv_buf</span><span class="p">,</span> <span class="n">buf_size</span><span class="p">,</span> <span class="n">type</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">avail_size</span><span class="p">,</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tlv_pos</span><span class="p">)</span> <span class="o">+</span> <span class="n">length</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_short_header</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">error_short_header:</span>
<span class="nl">error_beyond_end:</span>
	<span class="k">return</span> <span class="n">tlv_pos</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Find a TLV in a buffer of sequential TLVs</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> * @tlv_hdr: pointer to the first TLV in the sequence</span>
<span class="cm"> * @size: size of the buffer in bytes; all TLVs are assumed to fit</span>
<span class="cm"> *        fully in the buffer (otherwise we&#39;ll complain).</span>
<span class="cm"> * @tlv_type: type of the TLV we are looking for</span>
<span class="cm"> * @tlv_size: expected size of the TLV we are looking for (if -1,</span>
<span class="cm"> *            don&#39;t check the size). This includes the header</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: NULL if the TLV is not found, otherwise a pointer to</span>
<span class="cm"> *          it. If the sizes don&#39;t match, an error is printed and NULL</span>
<span class="cm"> *          returned.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="o">*</span><span class="nf">i2400m_tlv_find</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">,</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="o">*</span><span class="n">tlv_hdr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span>
	<span class="k">enum</span> <span class="n">i2400m_tlv</span> <span class="n">tlv_type</span><span class="p">,</span> <span class="kt">ssize_t</span> <span class="n">tlv_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">match</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="o">*</span><span class="n">tlv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">tlv</span> <span class="o">=</span> <span class="n">i2400m_tlv_buffer_walk</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">tlv_hdr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">tlv</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">match</span> <span class="o">=</span> <span class="n">i2400m_tlv_match</span><span class="p">(</span><span class="n">tlv</span><span class="p">,</span> <span class="n">tlv_type</span><span class="p">,</span> <span class="n">tlv_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="cm">/* found it :) */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">match</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;TLV type 0x%04x found with size &quot;</span>
				 <span class="s">&quot;mismatch (%zu vs %zu needed)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">tlv_type</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="n">tlv_size</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">tlv</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">errno</span><span class="p">;</span>
<span class="p">}</span> <span class="n">ms_to_errno</span><span class="p">[</span><span class="n">I2400M_MS_MAX</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="n">I2400M_MS_DONE_OK</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_DONE_IN_PROGRESS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_INVALID_OP</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;invalid opcode&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOSYS</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_BAD_STATE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;invalid state&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EILSEQ</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_ILLEGAL_VALUE</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;illegal value&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EINVAL</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_MISSING_PARAMS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;missing parameters&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ENOMSG</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_VERSION_ERROR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;bad version&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_ACCESSIBILITY_ERROR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;accesibility error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_BUSY</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;busy&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_CORRUPTED_TLV</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;corrupted TLV&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EILSEQ</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_UNINITIALIZED</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;not unitialized&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EILSEQ</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_UNKNOWN_ERROR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;unknown error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_PRODUCTION_ERROR</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;production error&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_NO_RF</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;no RF&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EIO</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_NOT_READY_FOR_POWERSAVE</span><span class="p">]</span> <span class="o">=</span>
		<span class="p">{</span> <span class="s">&quot;not ready for powersave&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EACCES</span> <span class="p">},</span>
	<span class="p">[</span><span class="n">I2400M_MS_THERMAL_CRITICAL</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="s">&quot;thermal critical&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">EL3HLT</span> <span class="p">},</span>
<span class="p">};</span>


<span class="cm">/*</span>
<span class="cm"> * i2400m_msg_check_status - translate a message&#39;s status code</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> * @l3l4_hdr: message header</span>
<span class="cm"> * @strbuf: buffer to place a formatted error message (unless NULL).</span>
<span class="cm"> * @strbuf_size: max amount of available space; larger messages will</span>
<span class="cm"> * be truncated.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: errno code corresponding to the status code in @l3l4_hdr</span>
<span class="cm"> *          and a message in @strbuf describing the error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2400m_msg_check_status</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">l3l4_hdr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">strbuf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">strbuf_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">i2400m_ms</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">l3l4_hdr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">str</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ms_to_errno</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">str</span> <span class="o">=</span> <span class="s">&quot;unknown status code&quot;</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBADR</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">str</span> <span class="o">=</span> <span class="n">ms_to_errno</span><span class="p">[</span><span class="n">status</span><span class="p">].</span><span class="n">msg</span><span class="p">;</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">ms_to_errno</span><span class="p">[</span><span class="n">status</span><span class="p">].</span><span class="n">errno</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strbuf</span><span class="p">)</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">strbuf</span><span class="p">,</span> <span class="n">strbuf_size</span><span class="p">,</span> <span class="s">&quot;%s (%d)&quot;</span><span class="p">,</span> <span class="n">str</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Act on a TLV System State reported by the device</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> * @ss: validated System State TLV</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">void</span> <span class="nf">i2400m_report_tlv_system_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_system_state</span> <span class="o">*</span><span class="n">ss</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wimax_dev</span> <span class="o">*</span><span class="n">wimax_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">wimax_dev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">i2400m_system_state</span> <span class="n">i2400m_state</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p ss %p [%u])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i2400m</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">i2400m_state</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">!=</span> <span class="n">i2400m_state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="n">i2400m_state</span><span class="p">;</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">state_wq</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">i2400m_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I2400M_SS_UNINITIALIZED</span>:
	<span class="k">case</span> <span class="n">I2400M_SS_INIT</span>:
	<span class="k">case</span> <span class="n">I2400M_SS_CONFIG</span>:
	<span class="k">case</span> <span class="n">I2400M_SS_PRODUCTION</span>:
		<span class="n">wimax_state_change</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">WIMAX_ST_UNINITIALIZED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I2400M_SS_RF_OFF</span>:
	<span class="k">case</span> <span class="n">I2400M_SS_RF_SHUTDOWN</span>:
		<span class="n">wimax_state_change</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">WIMAX_ST_RADIO_OFF</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I2400M_SS_READY</span>:
	<span class="k">case</span> <span class="n">I2400M_SS_STANDBY</span>:
	<span class="k">case</span> <span class="n">I2400M_SS_SLEEPACTIVE</span>:
		<span class="n">wimax_state_change</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">WIMAX_ST_READY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I2400M_SS_CONNECTING</span>:
	<span class="k">case</span> <span class="n">I2400M_SS_WIMAX_CONNECTED</span>:
		<span class="n">wimax_state_change</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">WIMAX_ST_READY</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I2400M_SS_SCAN</span>:
	<span class="k">case</span> <span class="n">I2400M_SS_OUT_OF_ZONE</span>:
		<span class="n">wimax_state_change</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">WIMAX_ST_SCANNING</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">I2400M_SS_IDLE</span>:
		<span class="n">d_printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;entering BS-negotiated idle mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">I2400M_SS_DISCONNECTING</span>:
	<span class="k">case</span> <span class="n">I2400M_SS_DATA_PATH_CONNECTED</span>:
		<span class="n">wimax_state_change</span><span class="p">(</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="n">WIMAX_ST_CONNECTED</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="cm">/* Huh? just in case, shut it down */</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HW BUG? unknown state %u: shutting down</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">i2400m_state</span><span class="p">);</span>
		<span class="n">i2400m_reset</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">I2400M_RT_WARM</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p ss %p [%u]) = void</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">i2400m</span><span class="p">,</span> <span class="n">ss</span><span class="p">,</span> <span class="n">i2400m_state</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Parse and act on a TLV Media Status sent by the device</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> * @ms: validated Media Status TLV</span>
<span class="cm"> *</span>
<span class="cm"> * This will set the carrier up on down based on the device&#39;s link</span>
<span class="cm"> * report. This is done asides of what the WiMAX stack does based on</span>
<span class="cm"> * the device&#39;s state as sometimes we need to do a link-renew (the BS</span>
<span class="cm"> * wants us to renew a DHCP lease, for example).</span>
<span class="cm"> *</span>
<span class="cm"> * In fact, doc says that every time we get a link-up, we should do a</span>
<span class="cm"> * DHCP negotiation...</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">void</span> <span class="nf">i2400m_report_tlv_media_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_media_status</span> <span class="o">*</span><span class="n">ms</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">wimax_dev</span> <span class="o">*</span><span class="n">wimax_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">wimax_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">net_device</span> <span class="o">*</span><span class="n">net_dev</span> <span class="o">=</span> <span class="n">wimax_dev</span><span class="o">-&gt;</span><span class="n">net_dev</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">i2400m_media_status</span> <span class="n">status</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">media_status</span><span class="p">);</span>

	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p ms %p [%u])</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i2400m</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I2400M_MEDIA_STATUS_LINK_UP</span>:
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">I2400M_MEDIA_STATUS_LINK_DOWN</span>:
		<span class="n">netif_carrier_off</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * This is the network telling us we need to retrain the DHCP</span>
<span class="cm">	 * lease -- so far, we are trusting the WiMAX Network Service</span>
<span class="cm">	 * in user space to pick this up and poke the DHCP client.</span>
<span class="cm">	 */</span>
	<span class="k">case</span> <span class="n">I2400M_MEDIA_STATUS_LINK_RENEW</span>:
		<span class="n">netif_carrier_on</span><span class="p">(</span><span class="n">net_dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HW BUG? unknown media status %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">status</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p ms %p [%u]) = void</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">i2400m</span><span class="p">,</span> <span class="n">ms</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Process a TLV from a &#39;state report&#39;</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> * @tlv: pointer to the TLV header; it has been already validated for</span>
<span class="cm"> *     consistent size.</span>
<span class="cm"> * @tag: for error messages</span>
<span class="cm"> *</span>
<span class="cm"> * Act on the TLVs from a &#39;state report&#39;.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">void</span> <span class="nf">i2400m_report_state_parse_tlv</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">,</span>
				   <span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="o">*</span><span class="n">tlv</span><span class="p">,</span>
				   <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_media_status</span> <span class="o">*</span><span class="n">ms</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_system_state</span> <span class="o">*</span><span class="n">ss</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_rf_switches_status</span> <span class="o">*</span><span class="n">rfss</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">i2400m_tlv_match</span><span class="p">(</span><span class="n">tlv</span><span class="p">,</span> <span class="n">I2400M_TLV_SYSTEM_STATE</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ss</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ss</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">tlv</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ss</span><span class="p">),</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="n">d_printf</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: system state TLV &quot;</span>
			 <span class="s">&quot;found (0x%04x), state 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">tag</span><span class="p">,</span> <span class="n">I2400M_TLV_SYSTEM_STATE</span><span class="p">,</span>
			 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ss</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">));</span>
		<span class="n">i2400m_report_tlv_system_state</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">ss</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">i2400m_tlv_match</span><span class="p">(</span><span class="n">tlv</span><span class="p">,</span> <span class="n">I2400M_TLV_RF_STATUS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rfss</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">rfss</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">tlv</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">rfss</span><span class="p">),</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="n">d_printf</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: RF status TLV &quot;</span>
			 <span class="s">&quot;found (0x%04x), sw 0x%02x hw 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">tag</span><span class="p">,</span> <span class="n">I2400M_TLV_RF_STATUS</span><span class="p">,</span>
			 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rfss</span><span class="o">-&gt;</span><span class="n">sw_rf_switch</span><span class="p">),</span>
			 <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">rfss</span><span class="o">-&gt;</span><span class="n">hw_rf_switch</span><span class="p">));</span>
		<span class="n">i2400m_report_tlv_rf_switches_status</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">rfss</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">0</span> <span class="o">==</span> <span class="n">i2400m_tlv_match</span><span class="p">(</span><span class="n">tlv</span><span class="p">,</span> <span class="n">I2400M_TLV_MEDIA_STATUS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ms</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ms</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">tlv</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">ms</span><span class="p">),</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="n">d_printf</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Media Status TLV: %u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">tag</span><span class="p">,</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">ms</span><span class="o">-&gt;</span><span class="n">media_status</span><span class="p">));</span>
		<span class="n">i2400m_report_tlv_media_status</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">ms</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Parse a &#39;state report&#39; and extract information</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> * @l3l4_hdr: pointer to message; it has been already validated for</span>
<span class="cm"> *            consistent size.</span>
<span class="cm"> * @size: size of the message (header + payload). The header length</span>
<span class="cm"> *        declaration is assumed to be congruent with @size (as in</span>
<span class="cm"> *        sizeof(*l3l4_hdr) + l3l4_hdr-&gt;length == size)</span>
<span class="cm"> *</span>
<span class="cm"> * Walk over the TLVs in a report state and act on them.</span>
<span class="cm"> */</span>
<span class="k">static</span>
<span class="kt">void</span> <span class="nf">i2400m_report_state_hook</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">,</span>
			      <span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">l3l4_hdr</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="o">*</span><span class="n">tlv</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">tlv_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">l3l4_hdr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p, l3l4_hdr %p, size %zu, %s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">i2400m</span><span class="p">,</span> <span class="n">l3l4_hdr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="n">tlv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">tlv</span> <span class="o">=</span> <span class="n">i2400m_tlv_buffer_walk</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">l3l4_hdr</span><span class="o">-&gt;</span><span class="n">pl</span><span class="p">,</span>
					     <span class="n">tlv_size</span><span class="p">,</span> <span class="n">tlv</span><span class="p">)))</span>
		<span class="n">i2400m_report_state_parse_tlv</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">tlv</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p, l3l4_hdr %p, size %zu, %s) = void</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">i2400m</span><span class="p">,</span> <span class="n">l3l4_hdr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * i2400m_report_hook - (maybe) act on a report</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> * @l3l4_hdr: pointer to message; it has been already validated for</span>
<span class="cm"> *            consistent size.</span>
<span class="cm"> * @size: size of the message (header + payload). The header length</span>
<span class="cm"> *        declaration is assumed to be congruent with @size (as in</span>
<span class="cm"> *        sizeof(*l3l4_hdr) + l3l4_hdr-&gt;length == size)</span>
<span class="cm"> *</span>
<span class="cm"> * Extract information we might need (like carrien on/off) from a</span>
<span class="cm"> * device report.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">i2400m_report_hook</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">l3l4_hdr</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">msg_type</span><span class="p">;</span>

	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p l3l4_hdr %p size %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">i2400m</span><span class="p">,</span> <span class="n">l3l4_hdr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
	<span class="cm">/* Chew on the message, we might need some information from</span>
<span class="cm">	 * here */</span>
	<span class="n">msg_type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">l3l4_hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">msg_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I2400M_MT_REPORT_STATE</span>:	<span class="cm">/* carrier detection... */</span>
		<span class="n">i2400m_report_state_hook</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span>
					 <span class="n">l3l4_hdr</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="s">&quot;REPORT STATE&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* If the device is ready for power save, then ask it to do</span>
<span class="cm">	 * it. */</span>
	<span class="k">case</span> <span class="n">I2400M_MT_REPORT_POWERSAVE_READY</span>:	<span class="cm">/* zzzzz */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">l3l4_hdr</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">==</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_MS_DONE_OK</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i2400m_power_save_disabled</span><span class="p">)</span>
				<span class="n">d_printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ready for powersave, &quot;</span>
					 <span class="s">&quot;not requesting (disabled by module &quot;</span>
					 <span class="s">&quot;parameter)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">d_printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ready for powersave, &quot;</span>
					 <span class="s">&quot;requesting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="n">i2400m_cmd_enter_powersave</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p l3l4_hdr %p size %zu) = void</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">i2400m</span><span class="p">,</span> <span class="n">l3l4_hdr</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * i2400m_msg_ack_hook - process cmd/set/get ack for internal status</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> * @l3l4_hdr: pointer to message; it has been already validated for</span>
<span class="cm"> *            consistent size.</span>
<span class="cm"> * @size: size of the message</span>
<span class="cm"> *</span>
<span class="cm"> * Extract information we might need from acks to commands and act on</span>
<span class="cm"> * it. This is akin to i2400m_report_hook(). Note most of this</span>
<span class="cm"> * processing should be done in the function that calls the</span>
<span class="cm"> * command. This is here for some cases where it can&#39;t happen...</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">i2400m_msg_ack_hook</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">,</span>
				 <span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">l3l4_hdr</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="n">ack_type</span><span class="p">,</span> <span class="n">ack_status</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">strerr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="cm">/* Chew on the message, we might need some information from</span>
<span class="cm">	 * here */</span>
	<span class="n">ack_type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">l3l4_hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">ack_status</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">l3l4_hdr</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">ack_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I2400M_MT_CMD_ENTER_POWERSAVE</span>:
		<span class="cm">/* This is just left here for the sake of example, as</span>
<span class="cm">		 * the processing is done somewhere else. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">result</span> <span class="o">=</span> <span class="n">i2400m_msg_check_status</span><span class="p">(</span>
				<span class="n">l3l4_hdr</span><span class="p">,</span> <span class="n">strerr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">strerr</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">d_printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;ready for power save: %zd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">size</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * i2400m_msg_size_check() - verify message size and header are congruent</span>
<span class="cm"> *</span>
<span class="cm"> * It is ok if the total message size is larger than the expected</span>
<span class="cm"> * size, as there can be padding.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2400m_msg_size_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">,</span>
			  <span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">l3l4_hdr</span><span class="p">,</span>
			  <span class="kt">size_t</span> <span class="n">msg_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="kt">size_t</span> <span class="n">expected_size</span><span class="p">;</span>
	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p l3l4_hdr %p msg_size %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">i2400m</span><span class="p">,</span> <span class="n">l3l4_hdr</span><span class="p">,</span> <span class="n">msg_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg_size</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">l3l4_hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad size for message header &quot;</span>
			<span class="s">&quot;(expected at least %zu, got %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">size_t</span><span class="p">)</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">l3l4_hdr</span><span class="p">),</span> <span class="n">msg_size</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_hdr_size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">expected_size</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">l3l4_hdr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">l3l4_hdr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg_size</span> <span class="o">&lt;</span> <span class="n">expected_size</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;bad size for message code 0x%04x (expected %zu, &quot;</span>
			<span class="s">&quot;got %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">l3l4_hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">),</span>
			<span class="n">expected_size</span><span class="p">,</span> <span class="n">msg_size</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">error_hdr_size:</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;(i2400m %p l3l4_hdr %p msg_size %zu) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">i2400m</span><span class="p">,</span> <span class="n">l3l4_hdr</span><span class="p">,</span> <span class="n">msg_size</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>



<span class="cm">/*</span>
<span class="cm"> * Cancel a wait for a command ACK</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> * @code: [negative] errno code to cancel with (don&#39;t use</span>
<span class="cm"> *     -EINPROGRESS)</span>
<span class="cm"> *</span>
<span class="cm"> * If there is an ack already filled out, free it.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">i2400m_msg_to_dev_cancel_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">,</span> <span class="kt">int</span> <span class="n">code</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">ack_skb</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ack_skb</span> <span class="o">=</span> <span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">ack_skb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ack_skb</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">))</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
	<span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">ack_skb</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">code</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * i2400m_msg_to_dev - Send a control message to the device and get a response</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * @msg_skb: an skb  *</span>
<span class="cm"> *</span>
<span class="cm"> * @buf: pointer to the buffer containing the message to be sent; it</span>
<span class="cm"> *           has to start with a &amp;struct i2400M_l3l4_hdr and then</span>
<span class="cm"> *           followed by the payload. Once this function returns, the</span>
<span class="cm"> *           buffer can be reused.</span>
<span class="cm"> *</span>
<span class="cm"> * @buf_len: buffer size</span>
<span class="cm"> *</span>
<span class="cm"> * Returns:</span>
<span class="cm"> *</span>
<span class="cm"> * Pointer to skb containing the ack message. You need to check the</span>
<span class="cm"> * pointer with IS_ERR(), as it might be an error code. Error codes</span>
<span class="cm"> * could happen because:</span>
<span class="cm"> *</span>
<span class="cm"> *  - the message wasn&#39;t formatted correctly</span>
<span class="cm"> *  - couldn&#39;t send the message</span>
<span class="cm"> *  - failed waiting for a response</span>
<span class="cm"> *  - the ack message wasn&#39;t formatted correctly</span>
<span class="cm"> *</span>
<span class="cm"> * The returned skb has been allocated with wimax_msg_to_user_alloc(),</span>
<span class="cm"> * it contains the response in a netlink attribute and is ready to be</span>
<span class="cm"> * passed up to user space with wimax_msg_to_user_send(). To access</span>
<span class="cm"> * the payload and its length, use wimax_msg_{data,len}() on the skb.</span>
<span class="cm"> *</span>
<span class="cm"> * The skb has to be freed with kfree_skb() once done.</span>
<span class="cm"> *</span>
<span class="cm"> * Description:</span>
<span class="cm"> *</span>
<span class="cm"> * This function delivers a message/command to the device and waits</span>
<span class="cm"> * for an ack to be received. The format is described in</span>
<span class="cm"> * linux/wimax/i2400m.h. In summary, a command/get/set is followed by an</span>
<span class="cm"> * ack.</span>
<span class="cm"> *</span>
<span class="cm"> * This function will not check the ack status, that&#39;s left up to the</span>
<span class="cm"> * caller.  Once done with the ack skb, it has to be kfree_skb()ed.</span>
<span class="cm"> *</span>
<span class="cm"> * The i2400m handles only one message at the same time, thus we need</span>
<span class="cm"> * the mutex to exclude other players.</span>
<span class="cm"> *</span>
<span class="cm"> * We write the message and then wait for an answer to come back. The</span>
<span class="cm"> * RX path intercepts control messages and handles them in</span>
<span class="cm"> * i2400m_rx_ctl(). Reports (notifications) are (maybe) processed</span>
<span class="cm"> * locally and then forwarded (as needed) to user space on the WiMAX</span>
<span class="cm"> * stack message pipe. Acks are saved and passed back to us through an</span>
<span class="cm"> * skb in i2400m-&gt;ack_skb which is ready to be given to generic</span>
<span class="cm"> * netlink if need be.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">i2400m_msg_to_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">buf_len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">msg_l3l4_hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">ack_skb</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">ack_l3l4_hdr</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ack_len</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ack_timeout</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">msg_type</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p buf %p len %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		  <span class="n">i2400m</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>

	<span class="n">rmb</span><span class="p">();</span>		<span class="cm">/* Make sure we see what i2400m_dev_reset_handle() */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">boot_mode</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EL3RST</span><span class="p">);</span>

	<span class="n">msg_l3l4_hdr</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="cm">/* Check msg &amp; payload consistency */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2400m_msg_size_check</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">msg_l3l4_hdr</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_bad_msg</span><span class="p">;</span>
	<span class="n">msg_type</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">msg_l3l4_hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>
	<span class="n">d_printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;CMD/GET/SET 0x%04x %zu bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">msg_type</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>
	<span class="n">d_dump</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">);</span>

	<span class="cm">/* Setup the completion, ack_skb (&quot;we are waiting&quot;) and send</span>
<span class="cm">	 * the message to the device */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">msg_mutex</span><span class="p">);</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">ack_skb</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">msg_completion</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2400m_tx</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">I2400M_PT_CTRL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;can&#39;t send message 0x%04x: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">msg_l3l4_hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">),</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_tx</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Some commands take longer to execute because of crypto ops,</span>
<span class="cm">	 * so we give them some more leeway on timeout */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">msg_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">I2400M_MT_GET_TLS_OPERATION_RESULT</span>:
	<span class="k">case</span> <span class="n">I2400M_MT_CMD_SEND_EAP_RESPONSE</span>:
		<span class="n">ack_timeout</span> <span class="o">=</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">HZ</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ack_timeout</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">trace_msg_from_user</span><span class="p">))</span>
		<span class="n">wimax_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="s">&quot;echo&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="cm">/* The RX path in rx.c will put any response for this message</span>
<span class="cm">	 * in i2400m-&gt;ack_skb and wake us up. If we cancel the wait,</span>
<span class="cm">	 * we need to change the value of i2400m-&gt;ack_skb to something</span>
<span class="cm">	 * not -EINPROGRESS so RX knows there is no one waiting. */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">wait_for_completion_interruptible_timeout</span><span class="p">(</span>
		<span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">msg_completion</span><span class="p">,</span> <span class="n">ack_timeout</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;timeout waiting for reply to message 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msg_type</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="n">i2400m_msg_to_dev_cancel_wait</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_wait_for_completion</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;error waiting for reply to message 0x%04x: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msg_type</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="n">i2400m_msg_to_dev_cancel_wait</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_wait_for_completion</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Pull out the ack data from i2400m-&gt;ack_skb -- see if it is</span>
<span class="cm">	 * an error and act accordingly */</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">ack_skb</span> <span class="o">=</span> <span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">ack_skb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">))</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">ack_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">rx_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_ack_status</span><span class="p">;</span>
	<span class="n">ack_l3l4_hdr</span> <span class="o">=</span> <span class="n">wimax_msg_data_len</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_len</span><span class="p">);</span>

	<span class="cm">/* Check the ack and deliver it if it is ok */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">trace_msg_from_user</span><span class="p">))</span>
		<span class="n">wimax_msg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">wimax_dev</span><span class="p">,</span> <span class="s">&quot;echo&quot;</span><span class="p">,</span>
			  <span class="n">ack_l3l4_hdr</span><span class="p">,</span> <span class="n">ack_len</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2400m_msg_size_check</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">ack_l3l4_hdr</span><span class="p">,</span> <span class="n">ack_len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HW BUG? reply to message 0x%04x: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msg_type</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_bad_ack_len</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg_type</span> <span class="o">!=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ack_l3l4_hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;HW BUG? bad reply 0x%04x to message 0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">ack_l3l4_hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">),</span> <span class="n">msg_type</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_bad_ack_type</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i2400m_msg_ack_hook</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">ack_l3l4_hdr</span><span class="p">,</span> <span class="n">ack_len</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">msg_mutex</span><span class="p">);</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p buf %p len %zu) = %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">i2400m</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">ack_skb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ack_skb</span><span class="p">;</span>

<span class="nl">error_bad_ack_type:</span>
<span class="nl">error_bad_ack_len:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
<span class="nl">error_ack_status:</span>
<span class="nl">error_wait_for_completion:</span>
<span class="nl">error_tx:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">msg_mutex</span><span class="p">);</span>
<span class="nl">error_bad_msg:</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p buf %p len %zu) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">i2400m</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">buf_len</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Definitions for the Enter Power Save command</span>
<span class="cm"> *</span>
<span class="cm"> * The Enter Power Save command requests the device to go into power</span>
<span class="cm"> * saving mode. The device will ack or nak the command depending on it</span>
<span class="cm"> * being ready for it. If it acks, we tell the USB subsystem to</span>
<span class="cm"> *</span>
<span class="cm"> * As well, the device might request to go into power saving mode by</span>
<span class="cm"> * sending a report (REPORT_POWERSAVE_READY), in which case, we issue</span>
<span class="cm"> * this command. The hookups in the RX coder allow</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">I2400M_WAKEUP_ENABLED</span>  <span class="o">=</span> <span class="mh">0x01</span><span class="p">,</span>
	<span class="n">I2400M_WAKEUP_DISABLED</span> <span class="o">=</span> <span class="mh">0x02</span><span class="p">,</span>
	<span class="n">I2400M_TLV_TYPE_WAKEUP_MODE</span> <span class="o">=</span> <span class="mi">144</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">i2400m_cmd_enter_power_save</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="n">tlv</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span> <span class="n">__packed</span><span class="p">;</span>


<span class="cm">/*</span>
<span class="cm"> * Request entering power save</span>
<span class="cm"> *</span>
<span class="cm"> * This command is (mainly) executed when the device indicates that it</span>
<span class="cm"> * is ready to go into powersave mode via a REPORT_POWERSAVE_READY.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2400m_cmd_enter_powersave</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">ack_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2400m_cmd_enter_power_save</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">strerr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_alloc</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_MT_CMD_ENTER_POWERSAVE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_L3L4_VERSION</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tlv</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_TLV_TYPE_WAKEUP_MODE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">tlv</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">val</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">val</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">I2400M_WAKEUP_ENABLED</span><span class="p">);</span>

	<span class="n">ack_skb</span> <span class="o">=</span> <span class="n">i2400m_msg_to_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to issue &#39;Enter power save&#39; command: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_msg_to_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2400m_msg_check_status</span><span class="p">(</span><span class="n">wimax_msg_data</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">),</span>
					 <span class="n">strerr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">strerr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">==</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">)</span>
		<span class="n">d_printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot enter power save mode</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&#39;Enter power save&#39; (0x%04x) command failed: &quot;</span>
			<span class="s">&quot;%d - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I2400M_MT_CMD_ENTER_POWERSAVE</span><span class="p">,</span>
			<span class="n">result</span><span class="p">,</span> <span class="n">strerr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">d_printf</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;device ready to power save</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
<span class="nl">error_msg_to_dev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="nl">error_alloc:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">i2400m_cmd_enter_powersave</span><span class="p">);</span>


<span class="cm">/*</span>
<span class="cm"> * Definitions for getting device information</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">I2400M_TLV_DETAILED_DEVICE_INFO</span> <span class="o">=</span> <span class="mi">140</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * i2400m_get_device_info - Query the device for detailed device information</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: an skb whose skb-&gt;data points to a &#39;struct</span>
<span class="cm"> *    i2400m_tlv_detailed_device_info&#39;. When done, kfree_skb() it. The</span>
<span class="cm"> *    skb is *guaranteed* to contain the whole TLV data structure.</span>
<span class="cm"> *</span>
<span class="cm"> *    On error, IS_ERR(skb) is true and ERR_PTR(skb) is the error</span>
<span class="cm"> *    code.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="nf">i2400m_get_device_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">ack_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">ack</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ack_len</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="o">*</span><span class="n">tlv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_detailed_device_info</span> <span class="o">*</span><span class="n">ddi</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">strerr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">ack_skb</span> <span class="o">=</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_alloc</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_MT_GET_DEVICE_INFO</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_L3L4_VERSION</span><span class="p">);</span>

	<span class="n">ack_skb</span> <span class="o">=</span> <span class="n">i2400m_msg_to_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to issue &#39;get device info&#39; command: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">));</span>
		<span class="k">goto</span> <span class="n">error_msg_to_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ack</span> <span class="o">=</span> <span class="n">wimax_msg_data_len</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_len</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2400m_msg_check_status</span><span class="p">(</span><span class="n">ack</span><span class="p">,</span> <span class="n">strerr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">strerr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&#39;get device info&#39; (0x%04x) command failed: &quot;</span>
			<span class="s">&quot;%d - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I2400M_MT_GET_DEVICE_INFO</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span>
			<span class="n">strerr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_cmd_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tlv</span> <span class="o">=</span> <span class="n">i2400m_tlv_find</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">ack</span><span class="o">-&gt;</span><span class="n">pl</span><span class="p">,</span> <span class="n">ack_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ack</span><span class="p">),</span>
			      <span class="n">I2400M_TLV_DETAILED_DEVICE_INFO</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ddi</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;GET DEVICE INFO: &quot;</span>
			<span class="s">&quot;detailed device info TLV not found (0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">I2400M_TLV_DETAILED_DEVICE_INFO</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_no_tlv</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">skb_pull</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">tlv</span> <span class="o">-</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">ack_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
<span class="nl">error_msg_to_dev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="nl">error_alloc:</span>
	<span class="k">return</span> <span class="n">ack_skb</span><span class="p">;</span>

<span class="nl">error_no_tlv:</span>
<span class="nl">error_cmd_failed:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Firmware interface versions we support */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">I2400M_HDIv_MAJOR</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>
	<span class="n">I2400M_HDIv_MINOR</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">I2400M_HDIv_MINOR_2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * i2400m_firmware_check - check firmware versions are compatible with</span>
<span class="cm"> * the driver</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 if ok, &lt; 0 errno code an error and a message in the</span>
<span class="cm"> *    kernel log.</span>
<span class="cm"> *</span>
<span class="cm"> * Long function, but quite simple; first chunk launches the command</span>
<span class="cm"> * and double checks the reply for the right TLV. Then we process the</span>
<span class="cm"> * TLV (where the meat is).</span>
<span class="cm"> *</span>
<span class="cm"> * Once we process the TLV that gives us the firmware&#39;s interface</span>
<span class="cm"> * version, we encode it and save it in i2400m-&gt;fw_version for future</span>
<span class="cm"> * reference.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2400m_firmware_check</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">ack_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">ack</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ack_len</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="o">*</span><span class="n">tlv</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_l4_message_versions</span> <span class="o">*</span><span class="n">l4mv</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">strerr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">branch</span><span class="p">;</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_alloc</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_MT_GET_LM_VERSION</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_L3L4_VERSION</span><span class="p">);</span>

	<span class="n">ack_skb</span> <span class="o">=</span> <span class="n">i2400m_msg_to_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to issue &#39;get lm version&#39; command: %-d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_msg_to_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ack</span> <span class="o">=</span> <span class="n">wimax_msg_data_len</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_len</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2400m_msg_check_status</span><span class="p">(</span><span class="n">ack</span><span class="p">,</span> <span class="n">strerr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">strerr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&#39;get lm version&#39; (0x%04x) command failed: &quot;</span>
			<span class="s">&quot;%d - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I2400M_MT_GET_LM_VERSION</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span>
			<span class="n">strerr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_cmd_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">tlv</span> <span class="o">=</span> <span class="n">i2400m_tlv_find</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">ack</span><span class="o">-&gt;</span><span class="n">pl</span><span class="p">,</span> <span class="n">ack_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ack</span><span class="p">),</span>
			      <span class="n">I2400M_TLV_L4_MESSAGE_VERSIONS</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">l4mv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">tlv</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;get lm version: TLV not found (0x%04x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">I2400M_TLV_L4_MESSAGE_VERSIONS</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_no_tlv</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">l4mv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">tlv</span><span class="p">,</span> <span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">l4mv</span><span class="p">),</span> <span class="n">hdr</span><span class="p">);</span>
	<span class="n">major</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">l4mv</span><span class="o">-&gt;</span><span class="n">major</span><span class="p">);</span>
	<span class="n">minor</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">l4mv</span><span class="o">-&gt;</span><span class="n">minor</span><span class="p">);</span>
	<span class="n">branch</span> <span class="o">=</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">l4mv</span><span class="o">-&gt;</span><span class="n">branch</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">major</span> <span class="o">!=</span> <span class="n">I2400M_HDIv_MAJOR</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unsupported major fw version &quot;</span>
			<span class="s">&quot;%u.%u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">branch</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_bad_major</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">minor</span> <span class="o">&lt;</span> <span class="n">I2400M_HDIv_MINOR_2</span> <span class="o">&amp;&amp;</span> <span class="n">minor</span> <span class="o">&gt;</span> <span class="n">I2400M_HDIv_MINOR</span><span class="p">)</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;untested minor fw version %u.%u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">branch</span><span class="p">);</span>
	<span class="cm">/* Yes, we ignore the branch -- we don&#39;t have to track it */</span>
	<span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">fw_version</span> <span class="o">=</span> <span class="n">major</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span> <span class="o">|</span> <span class="n">minor</span><span class="p">;</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;firmware interface version %u.%u.%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">branch</span><span class="p">);</span>
<span class="nl">error_bad_major:</span>
<span class="nl">error_no_tlv:</span>
<span class="nl">error_cmd_failed:</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
<span class="nl">error_msg_to_dev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="nl">error_alloc:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Send an DoExitIdle command to the device to ask it to go out of</span>
<span class="cm"> * basestation-idle mode.</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * This starts a renegotiation with the basestation that might involve</span>
<span class="cm"> * another crypto handshake with user space.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 if ok, &lt; 0 errno code on error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2400m_cmd_exit_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">ack_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">strerr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_alloc</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_MT_CMD_EXIT_IDLE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_L3L4_VERSION</span><span class="p">);</span>

	<span class="n">ack_skb</span> <span class="o">=</span> <span class="n">i2400m_msg_to_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to issue &#39;exit idle&#39; command: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">result</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_msg_to_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2400m_msg_check_status</span><span class="p">(</span><span class="n">wimax_msg_data</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">),</span>
					 <span class="n">strerr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">strerr</span><span class="p">));</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
<span class="nl">error_msg_to_dev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="nl">error_alloc:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Query the device for its state, update the WiMAX stack&#39;s idea of it</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 if ok, &lt; 0 errno code on error.</span>
<span class="cm"> *</span>
<span class="cm"> * Executes a &#39;Get State&#39; command and parses the returned</span>
<span class="cm"> * TLVs.</span>
<span class="cm"> *</span>
<span class="cm"> * Because this is almost identical to a &#39;Report State&#39;, we use</span>
<span class="cm"> * i2400m_report_state_hook() to parse the answer. This will set the</span>
<span class="cm"> * carrier state, as well as the RF Kill switches state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2400m_cmd_get_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">ack_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">ack</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ack_len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">strerr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_alloc</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_MT_GET_STATE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_L3L4_VERSION</span><span class="p">);</span>

	<span class="n">ack_skb</span> <span class="o">=</span> <span class="n">i2400m_msg_to_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to issue &#39;get state&#39; command: %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">));</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_msg_to_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ack</span> <span class="o">=</span> <span class="n">wimax_msg_data_len</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_len</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2400m_msg_check_status</span><span class="p">(</span><span class="n">ack</span><span class="p">,</span> <span class="n">strerr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">strerr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&#39;get state&#39; (0x%04x) command failed: &quot;</span>
			<span class="s">&quot;%d - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I2400M_MT_GET_STATE</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">strerr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_cmd_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i2400m_report_state_hook</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">ack</span><span class="p">,</span> <span class="n">ack_len</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ack</span><span class="p">),</span>
				 <span class="s">&quot;GET STATE&quot;</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
<span class="nl">error_cmd_failed:</span>
<span class="nl">error_msg_to_dev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="nl">error_alloc:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Set basic configuration settings</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> * @args: array of pointers to the TLV headers to send for</span>
<span class="cm"> *     configuration (each followed by its payload).</span>
<span class="cm"> *     TLV headers and payloads must be properly initialized, with the</span>
<span class="cm"> *     right endianess (LE).</span>
<span class="cm"> * @arg_size: number of pointers in the @args array</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">i2400m_set_init_config</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="o">**</span><span class="n">arg</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="n">args</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">ack_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">strerr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">argc</span><span class="p">,</span> <span class="n">argsize</span><span class="p">,</span> <span class="n">tlv_size</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="o">*</span><span class="n">tlv_hdr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="o">*</span><span class="n">itr</span><span class="p">;</span>

	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p arg %p args %zu)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i2400m</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">args</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">args</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">none</span><span class="p">;</span>
	<span class="cm">/* Compute the size of all the TLVs, so we can alloc a</span>
<span class="cm">	 * contiguous command block to copy them. */</span>
	<span class="n">argsize</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">argc</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">;</span> <span class="n">argc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlv_hdr</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">argc</span><span class="p">];</span>
		<span class="n">argsize</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tlv_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tlv_hdr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">WARN_ON</span><span class="p">(</span><span class="n">argc</span> <span class="o">&gt;=</span> <span class="mi">9</span><span class="p">);</span>	<span class="cm">/* As per hw spec */</span>

	<span class="cm">/* Alloc the space for the command and TLVs*/</span>
	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">argsize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_alloc</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_MT_SET_INIT_CONFIG</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">argsize</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_L3L4_VERSION</span><span class="p">);</span>

	<span class="cm">/* Copy the TLVs */</span>
	<span class="n">itr</span> <span class="o">=</span> <span class="n">buf</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">argc</span> <span class="o">&lt;</span> <span class="n">args</span><span class="p">;</span> <span class="n">argc</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tlv_hdr</span> <span class="o">=</span> <span class="n">arg</span><span class="p">[</span><span class="n">argc</span><span class="p">];</span>
		<span class="n">tlv_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">tlv_hdr</span><span class="p">)</span> <span class="o">+</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">tlv_hdr</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">itr</span><span class="p">,</span> <span class="n">tlv_hdr</span><span class="p">,</span> <span class="n">tlv_size</span><span class="p">);</span>
		<span class="n">itr</span> <span class="o">+=</span> <span class="n">tlv_size</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Send the message! */</span>
	<span class="n">ack_skb</span> <span class="o">=</span> <span class="n">i2400m_msg_to_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">+</span> <span class="n">argsize</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to issue &#39;init config&#39; command: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">result</span><span class="p">);</span>

		<span class="k">goto</span> <span class="n">error_msg_to_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2400m_msg_check_status</span><span class="p">(</span><span class="n">wimax_msg_data</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">),</span>
					 <span class="n">strerr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">strerr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&#39;init config&#39; (0x%04x) command failed: %d - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">I2400M_MT_SET_INIT_CONFIG</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">strerr</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
<span class="nl">error_msg_to_dev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
<span class="nl">error_alloc:</span>
<span class="nl">none:</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p arg %p args %zu) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">i2400m</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>

<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * i2400m_set_idle_timeout - Set the device&#39;s idle mode timeout</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: i2400m device descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * @msecs: milliseconds for the timeout to enter idle mode. Between</span>
<span class="cm"> *     100 to 300000 (5m); 0 to disable. In increments of 100.</span>
<span class="cm"> *</span>
<span class="cm"> * After this @msecs of the link being idle (no data being sent or</span>
<span class="cm"> * received), the device will negotiate with the basestation entering</span>
<span class="cm"> * idle mode for saving power. The connection is maintained, but</span>
<span class="cm"> * getting out of it (done in tx.c) will require some negotiation,</span>
<span class="cm"> * possible crypto re-handshake and a possible DHCP re-lease.</span>
<span class="cm"> *</span>
<span class="cm"> * Only available if fw_version &gt;= 0x00090002.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 if ok, &lt; 0 errno code on error.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2400m_set_idle_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">msecs</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">ack_skb</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="n">hdr</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">i2400m_tlv_config_idle_timeout</span> <span class="n">cit</span><span class="p">;</span>
	<span class="p">}</span> <span class="o">*</span><span class="n">cmd</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_l3l4_hdr</span> <span class="o">*</span><span class="n">ack</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">ack_len</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">strerr</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>

	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2400m_le_v1_3</span><span class="p">(</span><span class="n">i2400m</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error_alloc</span><span class="p">;</span>
	<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cmd</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_alloc</span><span class="p">;</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_MT_GET_STATE</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_L3L4_VERSION</span><span class="p">);</span>

	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cit</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
		<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_TLV_CONFIG_IDLE_TIMEOUT</span><span class="p">);</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cit</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cit</span><span class="p">.</span><span class="n">timeout</span><span class="p">));</span>
	<span class="n">cmd</span><span class="o">-&gt;</span><span class="n">cit</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="n">cpu_to_le32</span><span class="p">(</span><span class="n">msecs</span><span class="p">);</span>

	<span class="n">ack_skb</span> <span class="o">=</span> <span class="n">i2400m_msg_to_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">cmd</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Failed to issue &#39;set idle timeout&#39; command: &quot;</span>
			<span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">));</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_msg_to_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ack</span> <span class="o">=</span> <span class="n">wimax_msg_data_len</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ack_len</span><span class="p">);</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2400m_msg_check_status</span><span class="p">(</span><span class="n">ack</span><span class="p">,</span> <span class="n">strerr</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">strerr</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;&#39;set idle timeout&#39; (0x%04x) command failed: &quot;</span>
			<span class="s">&quot;%d - %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">I2400M_MT_GET_STATE</span><span class="p">,</span> <span class="n">result</span><span class="p">,</span> <span class="n">strerr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_cmd_failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">ack_skb</span><span class="p">);</span>
<span class="nl">error_cmd_failed:</span>
<span class="nl">error_msg_to_dev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">cmd</span><span class="p">);</span>
<span class="nl">error_alloc:</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * i2400m_dev_initialize - Initialize the device once communications are ready</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 if ok, &lt; 0 errno code on error.</span>
<span class="cm"> *</span>
<span class="cm"> * Configures the device to work the way we like it.</span>
<span class="cm"> *</span>
<span class="cm"> * At the point of this call, the device is registered with the WiMAX</span>
<span class="cm"> * and netdev stacks, firmware is uploaded and we can talk to the</span>
<span class="cm"> * device normally.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">i2400m_dev_initialize</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">i2400m_tlv_config_idle_parameters</span> <span class="n">idle_params</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2400m_tlv_config_idle_timeout</span> <span class="n">idle_timeout</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2400m_tlv_config_d2h_data_format</span> <span class="n">df</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2400m_tlv_config_dl_host_reorder</span> <span class="n">dlhr</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">i2400m_tlv_hdr</span> <span class="o">*</span><span class="n">args</span><span class="p">[</span><span class="mi">9</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="n">argc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i2400m</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2400m_passive_mode</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_passive</span><span class="p">;</span>
	<span class="cm">/* Disable idle mode? (enabled by default) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2400m_idle_mode_disabled</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2400m_le_v1_3</span><span class="p">(</span><span class="n">i2400m</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">idle_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_TLV_CONFIG_IDLE_PARAMETERS</span><span class="p">);</span>
			<span class="n">idle_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">idle_params</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idle_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">));</span>
			<span class="n">idle_params</span><span class="p">.</span><span class="n">idle_timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">idle_params</span><span class="p">.</span><span class="n">idle_paging_interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">args</span><span class="p">[</span><span class="n">argc</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idle_params</span><span class="p">.</span><span class="n">hdr</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">idle_timeout</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_TLV_CONFIG_IDLE_TIMEOUT</span><span class="p">);</span>
			<span class="n">idle_timeout</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">idle_timeout</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">idle_timeout</span><span class="p">.</span><span class="n">hdr</span><span class="p">));</span>
			<span class="n">idle_timeout</span><span class="p">.</span><span class="n">timeout</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">args</span><span class="p">[</span><span class="n">argc</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">idle_timeout</span><span class="p">.</span><span class="n">hdr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2400m_ge_v1_4</span><span class="p">(</span><span class="n">i2400m</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Enable extended RX data format? */</span>
		<span class="n">df</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
			<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_TLV_CONFIG_D2H_DATA_FORMAT</span><span class="p">);</span>
		<span class="n">df</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
			<span class="k">sizeof</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">df</span><span class="p">.</span><span class="n">hdr</span><span class="p">));</span>
		<span class="n">df</span><span class="p">.</span><span class="n">format</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">args</span><span class="p">[</span><span class="n">argc</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">df</span><span class="p">.</span><span class="n">hdr</span><span class="p">;</span>

		<span class="cm">/* Enable RX data reordering?</span>
<span class="cm">		 * (switch flipped in rx.c:i2400m_rx_setup() after fw upload) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2400m</span><span class="o">-&gt;</span><span class="n">rx_reorder</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dlhr</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span>
				<span class="n">cpu_to_le16</span><span class="p">(</span><span class="n">I2400M_TLV_CONFIG_DL_HOST_REORDER</span><span class="p">);</span>
			<span class="n">dlhr</span><span class="p">.</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">cpu_to_le16</span><span class="p">(</span>
				<span class="k">sizeof</span><span class="p">(</span><span class="n">dlhr</span><span class="p">)</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">dlhr</span><span class="p">.</span><span class="n">hdr</span><span class="p">));</span>
			<span class="n">dlhr</span><span class="p">.</span><span class="n">reorder</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">args</span><span class="p">[</span><span class="n">argc</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">dlhr</span><span class="p">.</span><span class="n">hdr</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2400m_set_init_config</span><span class="p">(</span><span class="n">i2400m</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">argc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
<span class="nl">out_passive:</span>
	<span class="cm">/*</span>
<span class="cm">	 * Update state: Here it just calls a get state; parsing the</span>
<span class="cm">	 * result (System State TLV and RF Status TLV [done in the rx</span>
<span class="cm">	 * path hooks]) will set the hardware and software RF-Kill</span>
<span class="cm">	 * status.</span>
<span class="cm">	 */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2400m_cmd_get_state</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>
<span class="nl">error:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to initialize the device: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p) = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i2400m</span><span class="p">,</span> <span class="n">result</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * i2400m_dev_shutdown - Shutdown a running device</span>
<span class="cm"> *</span>
<span class="cm"> * @i2400m: device descriptor</span>
<span class="cm"> *</span>
<span class="cm"> * Release resources acquired during the running of the device; in</span>
<span class="cm"> * theory, should also tell the device to go to sleep, switch off the</span>
<span class="cm"> * radio, all that, but at this point, in most cases (driver</span>
<span class="cm"> * disconnection, reset handling) we can&#39;t even talk to the device.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">i2400m_dev_shutdown</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2400m</span> <span class="o">*</span><span class="n">i2400m</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">i2400m_dev</span><span class="p">(</span><span class="n">i2400m</span><span class="p">);</span>

	<span class="n">d_fnstart</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i2400m</span><span class="p">);</span>
	<span class="n">d_fnend</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;(i2400m %p) = void</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i2400m</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:4}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../../javascript/docco.min.js"></script>
</html>
