<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › w1 › w1_io.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>w1_io.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	w1_io.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2004 Evgeniy Polyakov &lt;zbr@ioremap.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#include &quot;w1.h&quot;</span>
<span class="cp">#include &quot;w1_log.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">w1_delay_parm</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">delay_coef</span><span class="p">,</span> <span class="n">w1_delay_parm</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">w1_disable_irqs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">disable_irqs</span><span class="p">,</span> <span class="n">w1_disable_irqs</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">w1_crc8_table</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mi">0</span><span class="p">,</span> <span class="mi">94</span><span class="p">,</span> <span class="mi">188</span><span class="p">,</span> <span class="mi">226</span><span class="p">,</span> <span class="mi">97</span><span class="p">,</span> <span class="mi">63</span><span class="p">,</span> <span class="mi">221</span><span class="p">,</span> <span class="mi">131</span><span class="p">,</span> <span class="mi">194</span><span class="p">,</span> <span class="mi">156</span><span class="p">,</span> <span class="mi">126</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">163</span><span class="p">,</span> <span class="mi">253</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">65</span><span class="p">,</span>
	<span class="mi">157</span><span class="p">,</span> <span class="mi">195</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">127</span><span class="p">,</span> <span class="mi">252</span><span class="p">,</span> <span class="mi">162</span><span class="p">,</span> <span class="mi">64</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">227</span><span class="p">,</span> <span class="mi">189</span><span class="p">,</span> <span class="mi">62</span><span class="p">,</span> <span class="mi">96</span><span class="p">,</span> <span class="mi">130</span><span class="p">,</span> <span class="mi">220</span><span class="p">,</span>
	<span class="mi">35</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">159</span><span class="p">,</span> <span class="mi">193</span><span class="p">,</span> <span class="mi">66</span><span class="p">,</span> <span class="mi">28</span><span class="p">,</span> <span class="mi">254</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="mi">191</span><span class="p">,</span> <span class="mi">93</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">128</span><span class="p">,</span> <span class="mi">222</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">98</span><span class="p">,</span>
	<span class="mi">190</span><span class="p">,</span> <span class="mi">224</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">92</span><span class="p">,</span> <span class="mi">223</span><span class="p">,</span> <span class="mi">129</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">61</span><span class="p">,</span> <span class="mi">124</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">192</span><span class="p">,</span> <span class="mi">158</span><span class="p">,</span> <span class="mi">29</span><span class="p">,</span> <span class="mi">67</span><span class="p">,</span> <span class="mi">161</span><span class="p">,</span> <span class="mi">255</span><span class="p">,</span>
	<span class="mi">70</span><span class="p">,</span> <span class="mi">24</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">164</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">121</span><span class="p">,</span> <span class="mi">155</span><span class="p">,</span> <span class="mi">197</span><span class="p">,</span> <span class="mi">132</span><span class="p">,</span> <span class="mi">218</span><span class="p">,</span> <span class="mi">56</span><span class="p">,</span> <span class="mi">102</span><span class="p">,</span> <span class="mi">229</span><span class="p">,</span> <span class="mi">187</span><span class="p">,</span> <span class="mi">89</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span>
	<span class="mi">219</span><span class="p">,</span> <span class="mi">133</span><span class="p">,</span> <span class="mi">103</span><span class="p">,</span> <span class="mi">57</span><span class="p">,</span> <span class="mi">186</span><span class="p">,</span> <span class="mi">228</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">88</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">71</span><span class="p">,</span> <span class="mi">165</span><span class="p">,</span> <span class="mi">251</span><span class="p">,</span> <span class="mi">120</span><span class="p">,</span> <span class="mi">38</span><span class="p">,</span> <span class="mi">196</span><span class="p">,</span> <span class="mi">154</span><span class="p">,</span>
	<span class="mi">101</span><span class="p">,</span> <span class="mi">59</span><span class="p">,</span> <span class="mi">217</span><span class="p">,</span> <span class="mi">135</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">184</span><span class="p">,</span> <span class="mi">230</span><span class="p">,</span> <span class="mi">167</span><span class="p">,</span> <span class="mi">249</span><span class="p">,</span> <span class="mi">27</span><span class="p">,</span> <span class="mi">69</span><span class="p">,</span> <span class="mi">198</span><span class="p">,</span> <span class="mi">152</span><span class="p">,</span> <span class="mi">122</span><span class="p">,</span> <span class="mi">36</span><span class="p">,</span>
	<span class="mi">248</span><span class="p">,</span> <span class="mi">166</span><span class="p">,</span> <span class="mi">68</span><span class="p">,</span> <span class="mi">26</span><span class="p">,</span> <span class="mi">153</span><span class="p">,</span> <span class="mi">199</span><span class="p">,</span> <span class="mi">37</span><span class="p">,</span> <span class="mi">123</span><span class="p">,</span> <span class="mi">58</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">134</span><span class="p">,</span> <span class="mi">216</span><span class="p">,</span> <span class="mi">91</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">231</span><span class="p">,</span> <span class="mi">185</span><span class="p">,</span>
	<span class="mi">140</span><span class="p">,</span> <span class="mi">210</span><span class="p">,</span> <span class="mi">48</span><span class="p">,</span> <span class="mi">110</span><span class="p">,</span> <span class="mi">237</span><span class="p">,</span> <span class="mi">179</span><span class="p">,</span> <span class="mi">81</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">78</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="mi">242</span><span class="p">,</span> <span class="mi">172</span><span class="p">,</span> <span class="mi">47</span><span class="p">,</span> <span class="mi">113</span><span class="p">,</span> <span class="mi">147</span><span class="p">,</span> <span class="mi">205</span><span class="p">,</span>
	<span class="mi">17</span><span class="p">,</span> <span class="mi">79</span><span class="p">,</span> <span class="mi">173</span><span class="p">,</span> <span class="mi">243</span><span class="p">,</span> <span class="mi">112</span><span class="p">,</span> <span class="mi">46</span><span class="p">,</span> <span class="mi">204</span><span class="p">,</span> <span class="mi">146</span><span class="p">,</span> <span class="mi">211</span><span class="p">,</span> <span class="mi">141</span><span class="p">,</span> <span class="mi">111</span><span class="p">,</span> <span class="mi">49</span><span class="p">,</span> <span class="mi">178</span><span class="p">,</span> <span class="mi">236</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">80</span><span class="p">,</span>
	<span class="mi">175</span><span class="p">,</span> <span class="mi">241</span><span class="p">,</span> <span class="mi">19</span><span class="p">,</span> <span class="mi">77</span><span class="p">,</span> <span class="mi">206</span><span class="p">,</span> <span class="mi">144</span><span class="p">,</span> <span class="mi">114</span><span class="p">,</span> <span class="mi">44</span><span class="p">,</span> <span class="mi">109</span><span class="p">,</span> <span class="mi">51</span><span class="p">,</span> <span class="mi">209</span><span class="p">,</span> <span class="mi">143</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">82</span><span class="p">,</span> <span class="mi">176</span><span class="p">,</span> <span class="mi">238</span><span class="p">,</span>
	<span class="mi">50</span><span class="p">,</span> <span class="mi">108</span><span class="p">,</span> <span class="mi">142</span><span class="p">,</span> <span class="mi">208</span><span class="p">,</span> <span class="mi">83</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">239</span><span class="p">,</span> <span class="mi">177</span><span class="p">,</span> <span class="mi">240</span><span class="p">,</span> <span class="mi">174</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">18</span><span class="p">,</span> <span class="mi">145</span><span class="p">,</span> <span class="mi">207</span><span class="p">,</span> <span class="mi">45</span><span class="p">,</span> <span class="mi">115</span><span class="p">,</span>
	<span class="mi">202</span><span class="p">,</span> <span class="mi">148</span><span class="p">,</span> <span class="mi">118</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">171</span><span class="p">,</span> <span class="mi">245</span><span class="p">,</span> <span class="mi">23</span><span class="p">,</span> <span class="mi">73</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">234</span><span class="p">,</span> <span class="mi">105</span><span class="p">,</span> <span class="mi">55</span><span class="p">,</span> <span class="mi">213</span><span class="p">,</span> <span class="mi">139</span><span class="p">,</span>
	<span class="mi">87</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">235</span><span class="p">,</span> <span class="mi">181</span><span class="p">,</span> <span class="mi">54</span><span class="p">,</span> <span class="mi">104</span><span class="p">,</span> <span class="mi">138</span><span class="p">,</span> <span class="mi">212</span><span class="p">,</span> <span class="mi">149</span><span class="p">,</span> <span class="mi">203</span><span class="p">,</span> <span class="mi">41</span><span class="p">,</span> <span class="mi">119</span><span class="p">,</span> <span class="mi">244</span><span class="p">,</span> <span class="mi">170</span><span class="p">,</span> <span class="mi">72</span><span class="p">,</span> <span class="mi">22</span><span class="p">,</span>
	<span class="mi">233</span><span class="p">,</span> <span class="mi">183</span><span class="p">,</span> <span class="mi">85</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">136</span><span class="p">,</span> <span class="mi">214</span><span class="p">,</span> <span class="mi">52</span><span class="p">,</span> <span class="mi">106</span><span class="p">,</span> <span class="mi">43</span><span class="p">,</span> <span class="mi">117</span><span class="p">,</span> <span class="mi">151</span><span class="p">,</span> <span class="mi">201</span><span class="p">,</span> <span class="mi">74</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">246</span><span class="p">,</span> <span class="mi">168</span><span class="p">,</span>
	<span class="mi">116</span><span class="p">,</span> <span class="mi">42</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">21</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">169</span><span class="p">,</span> <span class="mi">247</span><span class="p">,</span> <span class="mi">182</span><span class="p">,</span> <span class="mi">232</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">84</span><span class="p">,</span> <span class="mi">215</span><span class="p">,</span> <span class="mi">137</span><span class="p">,</span> <span class="mi">107</span><span class="p">,</span> <span class="mi">53</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">w1_delay</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tm</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">tm</span> <span class="o">*</span> <span class="n">w1_delay_parm</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">w1_write_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">);</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">w1_read_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Generates a write-0 or write-1 cycle and samples the level.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">w1_touch_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">touch_bit</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">touch_bit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">bit</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">bit</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">w1_read_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">w1_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Generates a write-0 or write-1 cycle.</span>
<span class="cm"> * Only call if dev-&gt;bus_master-&gt;touch_bit is NULL</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">w1_write_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">w1_disable_irqs</span><span class="p">)</span> <span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">bit</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">write_bit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">w1_delay</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">write_bit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">w1_delay</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">write_bit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">w1_delay</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">write_bit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">w1_delay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">w1_disable_irqs</span><span class="p">)</span> <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Pre-write operation, currently only supporting strong pullups.</span>
<span class="cm"> * Program the hardware for a strong pullup, if one has been requested and</span>
<span class="cm"> * the hardware supports it.</span>
<span class="cm"> *</span>
<span class="cm"> * @param dev     the master device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">w1_pre_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pullup_duration</span> <span class="o">&amp;&amp;</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">enable_pullup</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">set_pullup</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">set_pullup</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pullup_duration</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Post-write operation, currently only supporting strong pullups.</span>
<span class="cm"> * If a strong pullup was requested, clear it if the hardware supports</span>
<span class="cm"> * them, or execute the delay otherwise, in either case clear the request.</span>
<span class="cm"> *</span>
<span class="cm"> * @param dev     the master device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">w1_post_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pullup_duration</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">enable_pullup</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">set_pullup</span><span class="p">)</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">set_pullup</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">msleep</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pullup_duration</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pullup_duration</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Writes 8 bits.</span>
<span class="cm"> *</span>
<span class="cm"> * @param dev     the master device</span>
<span class="cm"> * @param byte    the byte to write</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">w1_write_8</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w1_pre_write</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">write_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
				<span class="n">w1_pre_write</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">w1_touch_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">byte</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="n">w1_post_write</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">w1_write_8</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * Generates a write-1 cycle and samples the level.</span>
<span class="cm"> * Only call if dev-&gt;bus_master-&gt;touch_bit is NULL</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">w1_read_bit</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* sample timing is critical here */</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">write_bit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">w1_delay</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">write_bit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">w1_delay</span><span class="p">(</span><span class="mi">9</span><span class="p">);</span>

	<span class="n">result</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">read_bit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">w1_delay</span><span class="p">(</span><span class="mi">55</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Does a triplet - used for searching ROM addresses.</span>
<span class="cm"> * Return bits:</span>
<span class="cm"> *  bit 0 = id_bit</span>
<span class="cm"> *  bit 1 = comp_bit</span>
<span class="cm"> *  bit 2 = dir_taken</span>
<span class="cm"> * If both bits 0 &amp; 1 are set, the search should be restarted.</span>
<span class="cm"> *</span>
<span class="cm"> * @param dev     the master device</span>
<span class="cm"> * @param bdir    the bit to write if both id_bit and comp_bit are 0</span>
<span class="cm"> * @return        bit fields - see above</span>
<span class="cm"> */</span>
<span class="n">u8</span> <span class="nf">w1_triplet</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">bdir</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">triplet</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">triplet</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">bdir</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">id_bit</span>   <span class="o">=</span> <span class="n">w1_touch_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">comp_bit</span> <span class="o">=</span> <span class="n">w1_touch_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">u8</span> <span class="n">retval</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">id_bit</span> <span class="o">&amp;&amp;</span> <span class="n">comp_bit</span><span class="p">)</span>
			<span class="k">return</span> <span class="mh">0x03</span><span class="p">;</span>  <span class="cm">/* error */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">id_bit</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">comp_bit</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Both bits are valid, take the direction given */</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">bdir</span> <span class="o">?</span> <span class="mh">0x04</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Only one bit is valid, take that direction */</span>
			<span class="n">bdir</span> <span class="o">=</span> <span class="n">id_bit</span><span class="p">;</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="n">id_bit</span> <span class="o">?</span> <span class="mh">0x05</span> <span class="o">:</span> <span class="mh">0x02</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">touch_bit</span><span class="p">)</span>
			<span class="n">w1_touch_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bdir</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">w1_write_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">bdir</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Reads 8 bits.</span>
<span class="cm"> *</span>
<span class="cm"> * @param dev     the master device</span>
<span class="cm"> * @return        the byte read</span>
<span class="cm"> */</span>
<span class="n">u8</span> <span class="nf">w1_read_8</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">res</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">)</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">res</span> <span class="o">|=</span> <span class="p">(</span><span class="n">w1_touch_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">w1_read_8</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Writes a series of bytes.</span>
<span class="cm"> *</span>
<span class="cm"> * @param dev     the master device</span>
<span class="cm"> * @param buf     pointer to the data to write</span>
<span class="cm"> * @param len     the number of bytes to write</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">w1_write_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">write_block</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w1_pre_write</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">write_block</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">w1_write_8</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span> <span class="cm">/* calls w1_pre_write */</span>
	<span class="n">w1_post_write</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">w1_write_block</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Touches a series of bytes.</span>
<span class="cm"> *</span>
<span class="cm"> * @param dev     the master device</span>
<span class="cm"> * @param buf     pointer to the data to write</span>
<span class="cm"> * @param len     the number of bytes to write</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">w1_touch_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">7</span><span class="p">)</span>
				<span class="n">w1_pre_write</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="n">tmp</span> <span class="o">|=</span> <span class="n">w1_touch_bit</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="n">j</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="n">j</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">w1_touch_block</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Reads a series of bytes.</span>
<span class="cm"> *</span>
<span class="cm"> * @param dev     the master device</span>
<span class="cm"> * @param buf     pointer to the buffer to fill</span>
<span class="cm"> * @param len     the number of bytes to read</span>
<span class="cm"> * @return        the number of bytes read</span>
<span class="cm"> */</span>
<span class="n">u8</span> <span class="nf">w1_read_block</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">read_block</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">read_block</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">w1_read_8</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">w1_read_block</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Issues a reset bus sequence.</span>
<span class="cm"> *</span>
<span class="cm"> * @param  dev The bus master pointer</span>
<span class="cm"> * @return     0=Device present, 1=No device present or error</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">w1_reset_bus</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span><span class="p">(</span><span class="n">w1_disable_irqs</span><span class="p">)</span> <span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">reset_bus</span><span class="p">)</span>
		<span class="n">result</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">reset_bus</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">write_bit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="cm">/* minimum 480, max ? us</span>
<span class="cm">		 * be nice and sleep, except 18b20 spec lists 960us maximum,</span>
<span class="cm">		 * so until we can sleep with microsecond accuracy, spin.</span>
<span class="cm">		 * Feel free to come up with some other way to give up the</span>
<span class="cm">		 * cpu for such a short amount of time AND get it back in</span>
<span class="cm">		 * the maximum amount of time.</span>
<span class="cm">		 */</span>
		<span class="n">w1_delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">write_bit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">w1_delay</span><span class="p">(</span><span class="mi">70</span><span class="p">);</span>

		<span class="n">result</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">read_bit</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">;</span>
		<span class="cm">/* minmum 70 (above) + 430 = 500 us</span>
<span class="cm">		 * There aren&#39;t any timing requirements between a reset and</span>
<span class="cm">		 * the following transactions.  Sleeping is safe here.</span>
<span class="cm">		 */</span>
		<span class="cm">/* w1_delay(430); min required time */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span><span class="p">(</span><span class="n">w1_disable_irqs</span><span class="p">)</span> <span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">w1_reset_bus</span><span class="p">);</span>

<span class="n">u8</span> <span class="nf">w1_calc_crc8</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span> <span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">crc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span><span class="o">--</span><span class="p">)</span>
		<span class="n">crc</span> <span class="o">=</span> <span class="n">w1_crc8_table</span><span class="p">[</span><span class="n">crc</span> <span class="o">^</span> <span class="o">*</span><span class="n">data</span><span class="o">++</span><span class="p">];</span>

	<span class="k">return</span> <span class="n">crc</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">w1_calc_crc8</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">w1_search_devices</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">search_type</span><span class="p">,</span> <span class="n">w1_slave_found_callback</span> <span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">attempts</span><span class="o">++</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">search</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			<span class="n">search_type</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">w1_search</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">search_type</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Resets the bus and then selects the slave by sending either a skip rom</span>
<span class="cm"> * or a rom match.</span>
<span class="cm"> * The w1 master lock must be held.</span>
<span class="cm"> *</span>
<span class="cm"> * @param sl	the slave to select</span>
<span class="cm"> * @return 	0=success, anything else=error</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">w1_reset_select_slave</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w1_reset_bus</span><span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">slave_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">w1_write_8</span><span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="n">W1_SKIP_ROM</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="n">u8</span> <span class="n">match</span><span class="p">[</span><span class="mi">9</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">W1_MATCH_ROM</span><span class="p">,</span> <span class="p">};</span>
		<span class="n">u64</span> <span class="n">rn</span> <span class="o">=</span> <span class="n">le64_to_cpu</span><span class="p">(</span><span class="o">*</span><span class="p">((</span><span class="n">u64</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">));</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">match</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">rn</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">w1_write_block</span><span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="n">match</span><span class="p">,</span> <span class="mi">9</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">w1_reset_select_slave</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * When the workflow with a slave amongst many requires several</span>
<span class="cm"> * successive commands a reset between each, this function is similar</span>
<span class="cm"> * to doing a reset then a match ROM for the last matched ROM. The</span>
<span class="cm"> * advantage being that the matched ROM step is skipped in favor of the</span>
<span class="cm"> * resume command. The slave must support the command of course.</span>
<span class="cm"> *</span>
<span class="cm"> * If the bus has only one slave, traditionnaly the match ROM is skipped</span>
<span class="cm"> * and a &quot;SKIP ROM&quot; is done for efficiency. On multi-slave busses, this</span>
<span class="cm"> * doesn&#39;t work of course, but the resume command is the next best thing.</span>
<span class="cm"> *</span>
<span class="cm"> * The w1 master lock must be held.</span>
<span class="cm"> *</span>
<span class="cm"> * @param dev     the master device</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">w1_reset_resume_command</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w1_reset_bus</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* This will make only the last matched slave perform a skip ROM. */</span>
	<span class="n">w1_write_8</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">W1_RESUME_CMD</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">w1_reset_resume_command</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * Put out a strong pull-up of the specified duration after the next write</span>
<span class="cm"> * operation.  Not all hardware supports strong pullups.  Hardware that</span>
<span class="cm"> * doesn&#39;t support strong pullups will sleep for the given time after the</span>
<span class="cm"> * write operation without a strong pullup.  This is a one shot request for</span>
<span class="cm"> * the next write, specifying zero will clear a previous request.</span>
<span class="cm"> * The w1 master lock must be held.</span>
<span class="cm"> *</span>
<span class="cm"> * @param delay	time in milliseconds</span>
<span class="cm"> * @return	0=success, anything else=error</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">w1_next_pullup</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">pullup_duration</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">w1_next_pullup</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
