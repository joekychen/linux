<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › w1 › masters › ds1wm.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ds1wm.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * 1-wire busmaster driver for DS1WM and ASICs with embedded DS1WMs</span>
<span class="cm"> * such as HP iPAQs (including h5xxx, h2200, and devices with ASIC3</span>
<span class="cm"> * like hx4700).</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2004-2005, Szabolcs Gyurko &lt;szabolcs.gyurko@tlt.hu&gt;</span>
<span class="cm"> * Copyright (c) 2004-2007, Matt Reimer &lt;mreimer@vpop.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Use consistent with the GNU GPL is permitted,</span>
<span class="cm"> * provided that this copyright notice is</span>
<span class="cm"> * preserved in its entirety in all copies and derived works.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/irq.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/core.h&gt;</span>
<span class="cp">#include &lt;linux/mfd/ds1wm.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &quot;../w1.h&quot;</span>
<span class="cp">#include &quot;../w1_int.h&quot;</span>


<span class="cp">#define DS1WM_CMD	0x00	</span><span class="cm">/* R/W 4 bits command */</span><span class="cp"></span>
<span class="cp">#define DS1WM_DATA	0x01	</span><span class="cm">/* R/W 8 bits, transmit/receive buffer */</span><span class="cp"></span>
<span class="cp">#define DS1WM_INT	0x02	</span><span class="cm">/* R/W interrupt status */</span><span class="cp"></span>
<span class="cp">#define DS1WM_INT_EN	0x03	</span><span class="cm">/* R/W interrupt enable */</span><span class="cp"></span>
<span class="cp">#define DS1WM_CLKDIV	0x04	</span><span class="cm">/* R/W 5 bits of divisor and pre-scale */</span><span class="cp"></span>
<span class="cp">#define DS1WM_CNTRL	0x05	</span><span class="cm">/* R/W master control register (not used yet) */</span><span class="cp"></span>

<span class="cp">#define DS1WM_CMD_1W_RESET  (1 &lt;&lt; 0)	</span><span class="cm">/* force reset on 1-wire bus */</span><span class="cp"></span>
<span class="cp">#define DS1WM_CMD_SRA	    (1 &lt;&lt; 1)	</span><span class="cm">/* enable Search ROM accelerator mode */</span><span class="cp"></span>
<span class="cp">#define DS1WM_CMD_DQ_OUTPUT (1 &lt;&lt; 2)	</span><span class="cm">/* write only - forces bus low */</span><span class="cp"></span>
<span class="cp">#define DS1WM_CMD_DQ_INPUT  (1 &lt;&lt; 3)	</span><span class="cm">/* read only - reflects state of bus */</span><span class="cp"></span>
<span class="cp">#define DS1WM_CMD_RST	    (1 &lt;&lt; 5)	</span><span class="cm">/* software reset */</span><span class="cp"></span>
<span class="cp">#define DS1WM_CMD_OD	    (1 &lt;&lt; 7)	</span><span class="cm">/* overdrive */</span><span class="cp"></span>

<span class="cp">#define DS1WM_INT_PD	    (1 &lt;&lt; 0)	</span><span class="cm">/* presence detect */</span><span class="cp"></span>
<span class="cp">#define DS1WM_INT_PDR	    (1 &lt;&lt; 1)	</span><span class="cm">/* presence detect result */</span><span class="cp"></span>
<span class="cp">#define DS1WM_INT_TBE	    (1 &lt;&lt; 2)	</span><span class="cm">/* tx buffer empty */</span><span class="cp"></span>
<span class="cp">#define DS1WM_INT_TSRE	    (1 &lt;&lt; 3)	</span><span class="cm">/* tx shift register empty */</span><span class="cp"></span>
<span class="cp">#define DS1WM_INT_RBF	    (1 &lt;&lt; 4)	</span><span class="cm">/* rx buffer full */</span><span class="cp"></span>
<span class="cp">#define DS1WM_INT_RSRF	    (1 &lt;&lt; 5)	</span><span class="cm">/* rx shift register full */</span><span class="cp"></span>

<span class="cp">#define DS1WM_INTEN_EPD	    (1 &lt;&lt; 0)	</span><span class="cm">/* enable presence detect int */</span><span class="cp"></span>
<span class="cp">#define DS1WM_INTEN_IAS	    (1 &lt;&lt; 1)	</span><span class="cm">/* INTR active state */</span><span class="cp"></span>
<span class="cp">#define DS1WM_INTEN_ETBE    (1 &lt;&lt; 2)	</span><span class="cm">/* enable tx buffer empty int */</span><span class="cp"></span>
<span class="cp">#define DS1WM_INTEN_ETMT    (1 &lt;&lt; 3)	</span><span class="cm">/* enable tx shift register empty int */</span><span class="cp"></span>
<span class="cp">#define DS1WM_INTEN_ERBF    (1 &lt;&lt; 4)	</span><span class="cm">/* enable rx buffer full int */</span><span class="cp"></span>
<span class="cp">#define DS1WM_INTEN_ERSRF   (1 &lt;&lt; 5)	</span><span class="cm">/* enable rx shift register full int */</span><span class="cp"></span>
<span class="cp">#define DS1WM_INTEN_DQO	    (1 &lt;&lt; 6)	</span><span class="cm">/* enable direct bus driving ops */</span><span class="cp"></span>

<span class="cp">#define DS1WM_INTEN_NOT_IAS (~DS1WM_INTEN_IAS)	</span><span class="cm">/* all but INTR active state */</span><span class="cp"></span>

<span class="cp">#define DS1WM_TIMEOUT (HZ * 5)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">freq</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">divisor</span><span class="p">;</span>
<span class="p">}</span> <span class="n">freq</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>   <span class="mi">1000000</span><span class="p">,</span> <span class="mh">0x80</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">2000000</span><span class="p">,</span> <span class="mh">0x84</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">3000000</span><span class="p">,</span> <span class="mh">0x81</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">4000000</span><span class="p">,</span> <span class="mh">0x88</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">5000000</span><span class="p">,</span> <span class="mh">0x82</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">6000000</span><span class="p">,</span> <span class="mh">0x85</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">7000000</span><span class="p">,</span> <span class="mh">0x83</span> <span class="p">},</span>
	<span class="p">{</span>   <span class="mi">8000000</span><span class="p">,</span> <span class="mh">0x8c</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">10000000</span><span class="p">,</span> <span class="mh">0x86</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">12000000</span><span class="p">,</span> <span class="mh">0x89</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">14000000</span><span class="p">,</span> <span class="mh">0x87</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">16000000</span><span class="p">,</span> <span class="mh">0x90</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">20000000</span><span class="p">,</span> <span class="mh">0x8a</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">24000000</span><span class="p">,</span> <span class="mh">0x8d</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">28000000</span><span class="p">,</span> <span class="mh">0x8b</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">32000000</span><span class="p">,</span> <span class="mh">0x94</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">40000000</span><span class="p">,</span> <span class="mh">0x8e</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">48000000</span><span class="p">,</span> <span class="mh">0x91</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">56000000</span><span class="p">,</span> <span class="mh">0x8f</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">64000000</span><span class="p">,</span> <span class="mh">0x98</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">80000000</span><span class="p">,</span> <span class="mh">0x92</span> <span class="p">},</span>
	<span class="p">{</span>  <span class="mi">96000000</span><span class="p">,</span> <span class="mh">0x95</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">112000000</span><span class="p">,</span> <span class="mh">0x93</span> <span class="p">},</span>
	<span class="p">{</span> <span class="mi">128000000</span><span class="p">,</span> <span class="mh">0x9c</span> <span class="p">},</span>
<span class="cm">/* you can continue this table, consult the OPERATION - CLOCK DIVISOR</span>
<span class="cm">   section of the ds1wm spec sheet. */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="p">{</span>
	<span class="kt">void</span>     <span class="n">__iomem</span> <span class="o">*</span><span class="n">map</span><span class="p">;</span>
	<span class="kt">int</span>      <span class="n">bus_shift</span><span class="p">;</span> <span class="cm">/* # of shifts to calc register offsets */</span>
	<span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">mfd_cell</span>   <span class="o">*</span><span class="n">cell</span><span class="p">;</span>
	<span class="kt">int</span>      <span class="n">irq</span><span class="p">;</span>
	<span class="kt">int</span>      <span class="n">slave_present</span><span class="p">;</span>
	<span class="kt">void</span>     <span class="o">*</span><span class="n">reset_complete</span><span class="p">;</span>
	<span class="kt">void</span>     <span class="o">*</span><span class="n">read_complete</span><span class="p">;</span>
	<span class="kt">void</span>     <span class="o">*</span><span class="n">write_complete</span><span class="p">;</span>
	<span class="kt">int</span>      <span class="n">read_error</span><span class="p">;</span>
	<span class="cm">/* last byte received */</span>
	<span class="n">u8</span>       <span class="n">read_byte</span><span class="p">;</span>
	<span class="cm">/* byte to write that makes all intr disabled, */</span>
	<span class="cm">/* considering active_state (IAS) (optimization) */</span>
	<span class="n">u8</span>       <span class="n">int_en_reg_none</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reset_recover_delay</span><span class="p">;</span> <span class="cm">/* see ds1wm.h */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">ds1wm_write_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">,</span>
					<span class="n">u8</span> <span class="n">val</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__raw_writeb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">bus_shift</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">ds1wm_read_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">u32</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">__raw_readb</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">+</span> <span class="p">(</span><span class="n">reg</span> <span class="o">&lt;&lt;</span> <span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">bus_shift</span><span class="p">));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">ds1wm_isr</span><span class="p">(</span><span class="kt">int</span> <span class="n">isr</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">intr</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">inten</span> <span class="o">=</span> <span class="n">ds1wm_read_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">DS1WM_INT_EN</span><span class="p">);</span>
	<span class="cm">/* if no bits are set in int enable register (except the IAS)</span>
<span class="cm">	than go no further, reading the regs below has side effects */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">inten</span> <span class="o">&amp;</span> <span class="n">DS1WM_INTEN_NOT_IAS</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="n">ds1wm_write_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span>
		<span class="n">DS1WM_INT_EN</span><span class="p">,</span> <span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">int_en_reg_none</span><span class="p">);</span>

	<span class="cm">/* this read action clears the INTR and certain flags in ds1wm */</span>
	<span class="n">intr</span> <span class="o">=</span> <span class="n">ds1wm_read_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">DS1WM_INT</span><span class="p">);</span>

	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">slave_present</span> <span class="o">=</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">DS1WM_INT_PDR</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">DS1WM_INT_TSRE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">write_complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inten</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DS1WM_INTEN_ETMT</span><span class="p">;</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">write_complete</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">DS1WM_INT_RBF</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* this read clears the RBF flag */</span>
		<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">read_byte</span> <span class="o">=</span> <span class="n">ds1wm_read_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span>
		<span class="n">DS1WM_DATA</span><span class="p">);</span>
		<span class="n">inten</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DS1WM_INTEN_ERBF</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">read_complete</span><span class="p">)</span>
			<span class="n">complete</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">read_complete</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">intr</span> <span class="o">&amp;</span> <span class="n">DS1WM_INT_PD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">reset_complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">inten</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">DS1WM_INTEN_EPD</span><span class="p">;</span>
		<span class="n">complete</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">reset_complete</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">ds1wm_write_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">DS1WM_INT_EN</span><span class="p">,</span> <span class="n">inten</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1wm_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">reset_done</span><span class="p">);</span>

	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">reset_complete</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">reset_done</span><span class="p">;</span>

	<span class="cm">/* enable Presence detect only */</span>
	<span class="n">ds1wm_write_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">DS1WM_INT_EN</span><span class="p">,</span> <span class="n">DS1WM_INTEN_EPD</span> <span class="o">|</span>
	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">int_en_reg_none</span><span class="p">);</span>

	<span class="n">ds1wm_write_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">DS1WM_CMD</span><span class="p">,</span> <span class="n">DS1WM_CMD_1W_RESET</span><span class="p">);</span>

	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reset_done</span><span class="p">,</span> <span class="n">DS1WM_TIMEOUT</span><span class="p">);</span>
	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">reset_complete</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reset failed, timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">slave_present</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reset: no devices found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">reset_recover_delay</span><span class="p">)</span>
		<span class="n">msleep</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">reset_recover_delay</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1wm_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">write_done</span><span class="p">);</span>
	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">write_complete</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">write_done</span><span class="p">;</span>

	<span class="n">ds1wm_write_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">DS1WM_INT_EN</span><span class="p">,</span>
	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">int_en_reg_none</span> <span class="o">|</span> <span class="n">DS1WM_INTEN_ETMT</span><span class="p">);</span>

	<span class="n">ds1wm_write_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">DS1WM_DATA</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">write_done</span><span class="p">,</span> <span class="n">DS1WM_TIMEOUT</span><span class="p">);</span>

	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">write_complete</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;write failed, timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ds1wm_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">write_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeleft</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">intEnable</span> <span class="o">=</span> <span class="n">DS1WM_INTEN_ERBF</span> <span class="o">|</span> <span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">int_en_reg_none</span><span class="p">;</span>
	<span class="n">DECLARE_COMPLETION_ONSTACK</span><span class="p">(</span><span class="n">read_done</span><span class="p">);</span>

	<span class="n">ds1wm_read_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">DS1WM_DATA</span><span class="p">);</span>

	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">read_complete</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">read_done</span><span class="p">;</span>
	<span class="n">ds1wm_write_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">DS1WM_INT_EN</span><span class="p">,</span> <span class="n">intEnable</span><span class="p">);</span>

	<span class="n">ds1wm_write_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">DS1WM_DATA</span><span class="p">,</span> <span class="n">write_data</span><span class="p">);</span>
	<span class="n">timeleft</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">read_done</span><span class="p">,</span> <span class="n">DS1WM_TIMEOUT</span><span class="p">);</span>

	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">read_complete</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeleft</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;read failed, timed out</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">read_error</span> <span class="o">=</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="k">return</span> <span class="mh">0xFF</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">read_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">read_byte</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1wm_find_divisor</span><span class="p">(</span><span class="kt">int</span> <span class="n">gclk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="o">--</span><span class="n">i</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gclk</span> <span class="o">&gt;=</span> <span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">freq</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">freq</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">divisor</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ds1wm_up</span><span class="p">(</span><span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">divisor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ds1wm_driver_data</span> <span class="o">*</span><span class="n">plat</span> <span class="o">=</span> <span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">)</span>
		<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">enable</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">divisor</span> <span class="o">=</span> <span class="n">ds1wm_find_divisor</span><span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">clock_rate</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;found divisor 0x%x for clock %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">divisor</span><span class="p">,</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">clock_rate</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">divisor</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;no suitable divisor for %dHz clock</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">plat</span><span class="o">-&gt;</span><span class="n">clock_rate</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ds1wm_write_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">DS1WM_CLKDIV</span><span class="p">,</span> <span class="n">divisor</span><span class="p">);</span>

	<span class="cm">/* Let the w1 clock stabilize. */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">ds1wm_reset</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ds1wm_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ds1wm_reset</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">);</span>

	<span class="cm">/* Disable interrupts. */</span>
	<span class="n">ds1wm_write_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">DS1WM_INT_EN</span><span class="p">,</span>
		<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">int_en_reg_none</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">)</span>
		<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">disable</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>
<span class="cm">/* w1 methods */</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ds1wm_read_byte</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ds1wm_read</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ds1wm_write_byte</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">ds1wm_write</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u8</span> <span class="nf">ds1wm_reset_bus</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">ds1wm_reset</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ds1wm_search</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">master_dev</span><span class="p">,</span>
			<span class="n">u8</span> <span class="n">search_type</span><span class="p">,</span> <span class="n">w1_slave_found_callback</span> <span class="n">slave_found</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ms_discrep_bit</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">r</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* holds the progress of the search */</span>
	<span class="n">u64</span> <span class="n">r_prime</span><span class="p">,</span> <span class="n">d</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="n">slaves_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pass</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;search begin</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">++</span><span class="n">pass</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pass</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;too many attempts (100), search aborted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ds1wm_reset</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;pass: %d reset error (or no slaves)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pass: %d r : %0#18llx writing SEARCH_ROM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pass</span><span class="p">,</span> <span class="n">r</span><span class="p">);</span>
		<span class="n">ds1wm_write</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">search_type</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pass: %d entering ASM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
		<span class="n">ds1wm_write_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">DS1WM_CMD</span><span class="p">,</span> <span class="n">DS1WM_CMD_SRA</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pass: %d begining nibble loop</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>

		<span class="n">r_prime</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">d</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="cm">/* we work one nibble at a time */</span>
		<span class="cm">/* each nibble is interleaved to form a byte */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

			<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">resp</span><span class="p">,</span> <span class="n">_r</span><span class="p">,</span> <span class="n">_r_prime</span><span class="p">,</span> <span class="n">_d</span><span class="p">;</span>

			<span class="n">_r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">4</span><span class="o">*</span><span class="n">i</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">;</span>
			<span class="n">_r</span> <span class="o">=</span> <span class="p">((</span><span class="n">_r</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">_r</span> <span class="o">&amp;</span> <span class="mh">0x2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">_r</span> <span class="o">&amp;</span> <span class="mh">0x4</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">_r</span> <span class="o">&amp;</span> <span class="mh">0x8</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">);</span>

			<span class="cm">/* writes _r, then reads back: */</span>
			<span class="n">resp</span> <span class="o">=</span> <span class="n">ds1wm_read</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">_r</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">read_error</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;pass: %d nibble: %d read error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pass</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">_r_prime</span> <span class="o">=</span> <span class="p">((</span><span class="n">resp</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">resp</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">resp</span> <span class="o">&amp;</span> <span class="mh">0x20</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">resp</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">);</span>

			<span class="n">_d</span> <span class="o">=</span> <span class="p">((</span><span class="n">resp</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">resp</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">resp</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">((</span><span class="n">resp</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">);</span>

			<span class="n">r_prime</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">_r_prime</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>
			<span class="n">d</span> <span class="o">|=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">_d</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">read_error</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;pass: %d read error, retrying</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pass: %d r</span><span class="se">\&#39;</span><span class="s">: %0#18llx d:%0#18llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pass</span><span class="p">,</span> <span class="n">r_prime</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pass: %d nibble loop complete, exiting ASM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
		<span class="n">ds1wm_write_register</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">,</span> <span class="n">DS1WM_CMD</span><span class="p">,</span> <span class="o">~</span><span class="n">DS1WM_CMD_SRA</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pass: %d resetting bus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
		<span class="n">ds1wm_reset</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">r_prime</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">d</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">63</span><span class="p">)))</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;pass: %d bus error, retrying</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span> <span class="cm">/* start over */</span>
		<span class="p">}</span>


		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pass: %d found %0#18llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pass</span><span class="p">,</span> <span class="n">r_prime</span><span class="p">);</span>
		<span class="n">slave_found</span><span class="p">(</span><span class="n">master_dev</span><span class="p">,</span> <span class="n">r_prime</span><span class="p">);</span>
		<span class="o">++</span><span class="n">slaves_found</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pass: %d complete, preparing next pass</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pass</span><span class="p">);</span>

		<span class="cm">/* any discrepency found which we already choose the</span>
<span class="cm">		   &#39;1&#39; branch is now is now irrelevant we reveal the</span>
<span class="cm">		   next branch with this: */</span>
		<span class="n">d</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">r</span><span class="p">;</span>
		<span class="cm">/* find last bit set, i.e. the most signif. bit set */</span>
		<span class="n">ms_discrep_bit</span> <span class="o">=</span> <span class="n">fls64</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pass: %d new d:%0#18llx MS discrep bit:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">pass</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">ms_discrep_bit</span><span class="p">);</span>

		<span class="cm">/* prev_ms_discrep_bit = ms_discrep_bit;</span>
<span class="cm">		   prepare for next ROM search:		    */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ms_discrep_bit</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">r</span> <span class="o">=</span> <span class="p">(</span><span class="n">r</span> <span class="o">&amp;</span>  <span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0ull</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">ms_discrep_bit</span><span class="p">)))</span> <span class="o">|</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">ms_discrep_bit</span><span class="p">;</span>
	<span class="p">}</span> <span class="cm">/* end while true */</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;pass: %d total: %d search done ms d bit pos: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pass</span><span class="p">,</span>
		<span class="n">slaves_found</span><span class="p">,</span> <span class="n">ms_discrep_bit</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* --------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">w1_bus_master</span> <span class="n">ds1wm_master</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">read_byte</span>  <span class="o">=</span> <span class="n">ds1wm_read_byte</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_byte</span> <span class="o">=</span> <span class="n">ds1wm_write_byte</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_bus</span>  <span class="o">=</span> <span class="n">ds1wm_reset_bus</span><span class="p">,</span>
	<span class="p">.</span><span class="n">search</span>	    <span class="o">=</span> <span class="n">ds1wm_search</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1wm_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ds1wm_driver_data</span> <span class="o">*</span><span class="n">plat</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">ds1wm_data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">ds1wm_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ds1wm_data</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">ds1wm_data</span><span class="p">);</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* calculate bus shift from mem resource */</span>
	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">bus_shift</span> <span class="o">=</span> <span class="n">resource_size</span><span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">cell</span> <span class="o">=</span> <span class="n">mfd_get_cell</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">cell</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">plat</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">plat</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">res</span> <span class="o">=</span> <span class="n">platform_get_resource</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">int_en_reg_none</span> <span class="o">=</span> <span class="p">(</span><span class="n">plat</span><span class="o">-&gt;</span><span class="n">active_high</span> <span class="o">?</span> <span class="n">DS1WM_INTEN_IAS</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">reset_recover_delay</span> <span class="o">=</span> <span class="n">plat</span><span class="o">-&gt;</span><span class="n">reset_recover_delay</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IRQ_HIGHEDGE</span><span class="p">)</span>
		<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IORESOURCE_IRQ_LOWEDGE</span><span class="p">)</span>
		<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ds1wm_isr</span><span class="p">,</span>
			<span class="n">IRQF_DISABLED</span> <span class="o">|</span> <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="s">&quot;ds1wm&quot;</span><span class="p">,</span> <span class="n">ds1wm_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err1</span><span class="p">;</span>

	<span class="n">ds1wm_up</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">);</span>

	<span class="n">ds1wm_master</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">ds1wm_data</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">w1_add_master_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_master</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">err2:</span>
	<span class="n">ds1wm_down</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ds1wm_data</span><span class="p">);</span>
<span class="nl">err1:</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">);</span>
<span class="nl">err0:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1wm_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ds1wm_down</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1wm_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">ds1wm_up</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define ds1wm_suspend NULL</span>
<span class="cp">#define ds1wm_resume NULL</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds1wm_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds1wm_data</span> <span class="o">*</span><span class="n">ds1wm_data</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">w1_remove_master_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_master</span><span class="p">);</span>
	<span class="n">ds1wm_down</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">ds1wm_data</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">ds1wm_data</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">ds1wm_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>   <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;ds1wm&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>    <span class="o">=</span> <span class="n">ds1wm_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>   <span class="o">=</span> <span class="n">ds1wm_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>  <span class="o">=</span> <span class="n">ds1wm_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span>   <span class="o">=</span> <span class="n">ds1wm_resume</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">ds1wm_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;DS1WM w1 busmaster driver - (c) 2004 Szabolcs Gyurko</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">ds1wm_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds1wm_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">ds1wm_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">ds1wm_exit</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Szabolcs Gyurko &lt;szabolcs.gyurko@tlt.hu&gt;, &quot;</span>
	<span class="s">&quot;Matt Reimer &lt;mreimer@vpop.net&gt;,&quot;</span>
	<span class="s">&quot;Jean-Francois Dagenais &lt;dagenaisj@sonatest.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;DS1WM w1 busmaster driver&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
