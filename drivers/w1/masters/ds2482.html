<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › w1 › masters › ds2482.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>ds2482.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/**</span>
<span class="cm"> * ds2482.c - provides i2c to w1-master bridge(s)</span>
<span class="cm"> * Copyright (C) 2005  Ben Gardner &lt;bgardner@wabtec.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * The DS2482 is a sensor chip made by Dallas Semiconductor (Maxim).</span>
<span class="cm"> * It is a I2C to 1-wire bridge.</span>
<span class="cm"> * There are two variations: -100 and -800, which have 1 or 8 1-wire ports.</span>
<span class="cm"> * The complete datasheet can be obtained from MAXIM&#39;s website at:</span>
<span class="cm"> *   http://www.maxim-ic.com/quick_view2.cfm/qv_pk/4382</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;asm/delay.h&gt;</span>

<span class="cp">#include &quot;../w1.h&quot;</span>
<span class="cp">#include &quot;../w1_int.h&quot;</span>

<span class="cm">/**</span>
<span class="cm"> * The DS2482 registers - there are 3 registers that are addressed by a read</span>
<span class="cm"> * pointer. The read pointer is set by the last command executed.</span>
<span class="cm"> *</span>
<span class="cm"> * To read the data, issue a register read for any address</span>
<span class="cm"> */</span>
<span class="cp">#define DS2482_CMD_RESET		0xF0	</span><span class="cm">/* No param */</span><span class="cp"></span>
<span class="cp">#define DS2482_CMD_SET_READ_PTR		0xE1	</span><span class="cm">/* Param: DS2482_PTR_CODE_xxx */</span><span class="cp"></span>
<span class="cp">#define DS2482_CMD_CHANNEL_SELECT	0xC3	</span><span class="cm">/* Param: Channel byte - DS2482-800 only */</span><span class="cp"></span>
<span class="cp">#define DS2482_CMD_WRITE_CONFIG		0xD2	</span><span class="cm">/* Param: Config byte */</span><span class="cp"></span>
<span class="cp">#define DS2482_CMD_1WIRE_RESET		0xB4	</span><span class="cm">/* Param: None */</span><span class="cp"></span>
<span class="cp">#define DS2482_CMD_1WIRE_SINGLE_BIT	0x87	</span><span class="cm">/* Param: Bit byte (bit7) */</span><span class="cp"></span>
<span class="cp">#define DS2482_CMD_1WIRE_WRITE_BYTE	0xA5	</span><span class="cm">/* Param: Data byte */</span><span class="cp"></span>
<span class="cp">#define DS2482_CMD_1WIRE_READ_BYTE	0x96	</span><span class="cm">/* Param: None */</span><span class="cp"></span>
<span class="cm">/* Note to read the byte, Set the ReadPtr to Data then read (any addr) */</span>
<span class="cp">#define DS2482_CMD_1WIRE_TRIPLET	0x78	</span><span class="cm">/* Param: Dir byte (bit7) */</span><span class="cp"></span>

<span class="cm">/* Values for DS2482_CMD_SET_READ_PTR */</span>
<span class="cp">#define DS2482_PTR_CODE_STATUS		0xF0</span>
<span class="cp">#define DS2482_PTR_CODE_DATA		0xE1</span>
<span class="cp">#define DS2482_PTR_CODE_CHANNEL		0xD2	</span><span class="cm">/* DS2482-800 only */</span><span class="cp"></span>
<span class="cp">#define DS2482_PTR_CODE_CONFIG		0xC3</span>

<span class="cm">/**</span>
<span class="cm"> * Configure Register bit definitions</span>
<span class="cm"> * The top 4 bits always read 0.</span>
<span class="cm"> * To write, the top nibble must be the 1&#39;s compl. of the low nibble.</span>
<span class="cm"> */</span>
<span class="cp">#define DS2482_REG_CFG_1WS		0x08</span>
<span class="cp">#define DS2482_REG_CFG_SPU		0x04</span>
<span class="cp">#define DS2482_REG_CFG_PPM		0x02</span>
<span class="cp">#define DS2482_REG_CFG_APU		0x01</span>


<span class="cm">/**</span>
<span class="cm"> * Write and verify codes for the CHANNEL_SELECT command (DS2482-800 only).</span>
<span class="cm"> * To set the channel, write the value at the index of the channel.</span>
<span class="cm"> * Read and compare against the corresponding value to verify the change.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ds2482_chan_wr</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span> <span class="mh">0xF0</span><span class="p">,</span> <span class="mh">0xE1</span><span class="p">,</span> <span class="mh">0xD2</span><span class="p">,</span> <span class="mh">0xC3</span><span class="p">,</span> <span class="mh">0xB4</span><span class="p">,</span> <span class="mh">0xA5</span><span class="p">,</span> <span class="mh">0x96</span><span class="p">,</span> <span class="mh">0x87</span> <span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">ds2482_chan_rd</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span>
	<span class="p">{</span> <span class="mh">0xB8</span><span class="p">,</span> <span class="mh">0xB1</span><span class="p">,</span> <span class="mh">0xAA</span><span class="p">,</span> <span class="mh">0xA3</span><span class="p">,</span> <span class="mh">0x9C</span><span class="p">,</span> <span class="mh">0x95</span><span class="p">,</span> <span class="mh">0x8E</span><span class="p">,</span> <span class="mh">0x87</span> <span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * Status Register bit definitions (read only)</span>
<span class="cm"> */</span>
<span class="cp">#define DS2482_REG_STS_DIR		0x80</span>
<span class="cp">#define DS2482_REG_STS_TSB		0x40</span>
<span class="cp">#define DS2482_REG_STS_SBR		0x20</span>
<span class="cp">#define DS2482_REG_STS_RST		0x10</span>
<span class="cp">#define DS2482_REG_STS_LL		0x08</span>
<span class="cp">#define DS2482_REG_STS_SD		0x04</span>
<span class="cp">#define DS2482_REG_STS_PPD		0x02</span>
<span class="cp">#define DS2482_REG_STS_1WB		0x01</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">ds2482_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ds2482_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">);</span>


<span class="cm">/**</span>
<span class="cm"> * Driver data (common to all clients)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">ds2482_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;ds2482&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">ds2482_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;ds2482&quot;</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">ds2482_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">ds2482_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">ds2482_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Client data (each client gets its own)</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">ds2482_data</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ds2482_w1_chan</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds2482_data</span>	<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">channel</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w1_bus_master</span>	<span class="n">w1_bm</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">ds2482_data</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>	<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">mutex</span>		<span class="n">access_lock</span><span class="p">;</span>

	<span class="cm">/* 1-wire interface(s) */</span>
	<span class="kt">int</span>			<span class="n">w1_count</span><span class="p">;</span>	<span class="cm">/* 1 or 8 */</span>
	<span class="k">struct</span> <span class="n">ds2482_w1_chan</span>	<span class="n">w1_ch</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="cm">/* per-device values */</span>
	<span class="n">u8</span>			<span class="n">channel</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">read_prt</span><span class="p">;</span>	<span class="cm">/* see DS2482_PTR_CODE_xxx */</span>
	<span class="n">u8</span>			<span class="n">reg_config</span><span class="p">;</span>
<span class="p">};</span>


<span class="cm">/**</span>
<span class="cm"> * Sets the read pointer.</span>
<span class="cm"> * @param pdev		The ds2482 client pointer</span>
<span class="cm"> * @param read_ptr	see DS2482_PTR_CODE_xxx above</span>
<span class="cm"> * @return -1 on failure, 0 on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ds2482_select_register</span><span class="p">(</span><span class="k">struct</span> <span class="n">ds2482_data</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">read_ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">read_prt</span> <span class="o">!=</span> <span class="n">read_ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					      <span class="n">DS2482_CMD_SET_READ_PTR</span><span class="p">,</span>
					      <span class="n">read_ptr</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">read_prt</span> <span class="o">=</span> <span class="n">read_ptr</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Sends a command without a parameter</span>
<span class="cm"> * @param pdev	The ds2482 client pointer</span>
<span class="cm"> * @param cmd	DS2482_CMD_RESET,</span>
<span class="cm"> *		DS2482_CMD_1WIRE_RESET,</span>
<span class="cm"> *		DS2482_CMD_1WIRE_READ_BYTE</span>
<span class="cm"> * @return -1 on failure, 0 on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ds2482_send_cmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">ds2482_data</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">cmd</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_write_byte</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">cmd</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">read_prt</span> <span class="o">=</span> <span class="n">DS2482_PTR_CODE_STATUS</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Sends a command with a parameter</span>
<span class="cm"> * @param pdev	The ds2482 client pointer</span>
<span class="cm"> * @param cmd	DS2482_CMD_WRITE_CONFIG,</span>
<span class="cm"> *		DS2482_CMD_1WIRE_SINGLE_BIT,</span>
<span class="cm"> *		DS2482_CMD_1WIRE_WRITE_BYTE,</span>
<span class="cm"> *		DS2482_CMD_1WIRE_TRIPLET</span>
<span class="cm"> * @param byte	The data to send</span>
<span class="cm"> * @return -1 on failure, 0 on success</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">ds2482_send_cmd_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">ds2482_data</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				       <span class="n">u8</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">u8</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">byte</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* all cmds leave in STATUS, except CONFIG */</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">read_prt</span> <span class="o">=</span> <span class="p">(</span><span class="n">cmd</span> <span class="o">!=</span> <span class="n">DS2482_CMD_WRITE_CONFIG</span><span class="p">)</span> <span class="o">?</span>
			 <span class="n">DS2482_PTR_CODE_STATUS</span> <span class="o">:</span> <span class="n">DS2482_PTR_CODE_CONFIG</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * 1-Wire interface code</span>
<span class="cm"> */</span>

<span class="cp">#define DS2482_WAIT_IDLE_TIMEOUT	100</span>

<span class="cm">/**</span>
<span class="cm"> * Waits until the 1-wire interface is idle (not busy)</span>
<span class="cm"> *</span>
<span class="cm"> * @param pdev Pointer to the device structure</span>
<span class="cm"> * @return the last value read from status or -1 (failure)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds2482_wait_1wire_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">ds2482_data</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">temp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ds2482_select_register</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DS2482_PTR_CODE_STATUS</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">do</span> <span class="p">{</span>
			<span class="n">temp</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">temp</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&amp;</span> <span class="n">DS2482_REG_STS_1WB</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			 <span class="p">(</span><span class="o">++</span><span class="n">retries</span> <span class="o">&lt;</span> <span class="n">DS2482_WAIT_IDLE_TIMEOUT</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retries</span> <span class="o">&gt;=</span> <span class="n">DS2482_WAIT_IDLE_TIMEOUT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: timeout on channel %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">__func__</span><span class="p">,</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">temp</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Selects a w1 channel.</span>
<span class="cm"> * The 1-wire interface must be idle before calling this function.</span>
<span class="cm"> *</span>
<span class="cm"> * @param pdev		The ds2482 client pointer</span>
<span class="cm"> * @param channel	0-7</span>
<span class="cm"> * @return		-1 (failure) or 0 (success)</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds2482_set_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">ds2482_data</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">channel</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">DS2482_CMD_CHANNEL_SELECT</span><span class="p">,</span>
				      <span class="n">ds2482_chan_wr</span><span class="p">[</span><span class="n">channel</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">read_prt</span> <span class="o">=</span> <span class="n">DS2482_PTR_CODE_CHANNEL</span><span class="p">;</span>
	<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i2c_smbus_read_byte</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">)</span> <span class="o">==</span> <span class="n">ds2482_chan_rd</span><span class="p">[</span><span class="n">channel</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">pdev</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Performs the touch-bit function, which writes a 0 or 1 and reads the level.</span>
<span class="cm"> *</span>
<span class="cm"> * @param data	The ds2482 channel pointer</span>
<span class="cm"> * @param bit	The level to write: 0 or non-zero</span>
<span class="cm"> * @return	The level read: 0 or 1</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">ds2482_w1_touch_bit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">bit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds2482_w1_chan</span> <span class="o">*</span><span class="n">pchan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ds2482_data</span>    <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pchan</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span>

	<span class="cm">/* Select the channel */</span>
	<span class="n">ds2482_wait_1wire_idle</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">w1_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ds2482_set_channel</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pchan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

	<span class="cm">/* Send the touch command, wait until 1WB == 0, return the status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ds2482_send_cmd_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DS2482_CMD_1WIRE_SINGLE_BIT</span><span class="p">,</span>
				  <span class="n">bit</span> <span class="o">?</span> <span class="mh">0xFF</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ds2482_wait_1wire_idle</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">DS2482_REG_STS_SBR</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Performs the triplet function, which reads two bits and writes a bit.</span>
<span class="cm"> * The bit written is determined by the two reads:</span>
<span class="cm"> *   00 =&gt; dbit, 01 =&gt; 0, 10 =&gt; 1</span>
<span class="cm"> *</span>
<span class="cm"> * @param data	The ds2482 channel pointer</span>
<span class="cm"> * @param dbit	The direction to choose if both branches are valid</span>
<span class="cm"> * @return	b0=read1 b1=read2 b3=bit written</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">ds2482_w1_triplet</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">dbit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds2482_w1_chan</span> <span class="o">*</span><span class="n">pchan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ds2482_data</span>    <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pchan</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="mi">3</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span>

	<span class="cm">/* Select the channel */</span>
	<span class="n">ds2482_wait_1wire_idle</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">w1_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ds2482_set_channel</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pchan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

	<span class="cm">/* Send the triplet command, wait until 1WB == 0, return the status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ds2482_send_cmd_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DS2482_CMD_1WIRE_TRIPLET</span><span class="p">,</span>
				  <span class="n">dbit</span> <span class="o">?</span> <span class="mh">0xFF</span> <span class="o">:</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">ds2482_wait_1wire_idle</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span>

	<span class="cm">/* Decode the status */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">status</span> <span class="o">&gt;&gt;</span> <span class="mi">5</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Performs the write byte function.</span>
<span class="cm"> *</span>
<span class="cm"> * @param data	The ds2482 channel pointer</span>
<span class="cm"> * @param byte	The value to write</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ds2482_w1_write_byte</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">u8</span> <span class="n">byte</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds2482_w1_chan</span> <span class="o">*</span><span class="n">pchan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ds2482_data</span>    <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pchan</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span>

	<span class="cm">/* Select the channel */</span>
	<span class="n">ds2482_wait_1wire_idle</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">w1_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ds2482_set_channel</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pchan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

	<span class="cm">/* Send the write byte command */</span>
	<span class="n">ds2482_send_cmd_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DS2482_CMD_1WIRE_WRITE_BYTE</span><span class="p">,</span> <span class="n">byte</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Performs the read byte function.</span>
<span class="cm"> *</span>
<span class="cm"> * @param data	The ds2482 channel pointer</span>
<span class="cm"> * @return	The value read</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">ds2482_w1_read_byte</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds2482_w1_chan</span> <span class="o">*</span><span class="n">pchan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ds2482_data</span>    <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pchan</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">result</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span>

	<span class="cm">/* Select the channel */</span>
	<span class="n">ds2482_wait_1wire_idle</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">w1_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ds2482_set_channel</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pchan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

	<span class="cm">/* Send the read byte command */</span>
	<span class="n">ds2482_send_cmd</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DS2482_CMD_1WIRE_READ_BYTE</span><span class="p">);</span>

	<span class="cm">/* Wait until 1WB == 0 */</span>
	<span class="n">ds2482_wait_1wire_idle</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="cm">/* Select the data register */</span>
	<span class="n">ds2482_select_register</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DS2482_PTR_CODE_DATA</span><span class="p">);</span>

	<span class="cm">/* Read the data byte */</span>
	<span class="n">result</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte</span><span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * Sends a reset on the 1-wire interface</span>
<span class="cm"> *</span>
<span class="cm"> * @param data	The ds2482 channel pointer</span>
<span class="cm"> * @return	0=Device present, 1=No device present or error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">ds2482_w1_reset_bus</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds2482_w1_chan</span> <span class="o">*</span><span class="n">pchan</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ds2482_data</span>    <span class="o">*</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pchan</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span>

	<span class="cm">/* Select the channel */</span>
	<span class="n">ds2482_wait_1wire_idle</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">w1_count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">ds2482_set_channel</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pchan</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">);</span>

	<span class="cm">/* Send the reset command */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">ds2482_send_cmd</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DS2482_CMD_1WIRE_RESET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Wait until the reset is complete */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">ds2482_wait_1wire_idle</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">!</span><span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">DS2482_REG_STS_PPD</span><span class="p">);</span>

		<span class="cm">/* If the chip did reset since detect, re-config it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&amp;</span> <span class="n">DS2482_REG_STS_RST</span><span class="p">)</span>
			<span class="n">ds2482_send_cmd_data</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">DS2482_CMD_WRITE_CONFIG</span><span class="p">,</span>
					     <span class="mh">0xF0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds2482_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds2482_data</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">temp1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">i2c_check_functionality</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">adapter</span><span class="p">,</span>
				     <span class="n">I2C_FUNC_SMBUS_WRITE_BYTE_DATA</span> <span class="o">|</span>
				     <span class="n">I2C_FUNC_SMBUS_BYTE</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">ds2482_data</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">data</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="cm">/* Reset the device (sets the read_ptr to status) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ds2482_send_cmd</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DS2482_CMD_RESET</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DS2482 reset failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Sleep at least 525ns to allow the reset to complete */</span>
	<span class="n">ndelay</span><span class="p">(</span><span class="mi">525</span><span class="p">);</span>

	<span class="cm">/* Read the status byte - only reset bit and line should be set */</span>
	<span class="n">temp1</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp1</span> <span class="o">!=</span> <span class="p">(</span><span class="n">DS2482_REG_STS_LL</span> <span class="o">|</span> <span class="n">DS2482_REG_STS_RST</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;DS2482 reset status &quot;</span>
			 <span class="s">&quot;0x%02X - not a DS2482</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">temp1</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_free</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Detect the 8-port version */</span>
	<span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ds2482_set_channel</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">7</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_count</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>

	<span class="cm">/* Set all config items to 0 (off) */</span>
	<span class="n">ds2482_send_cmd_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">DS2482_CMD_WRITE_CONFIG</span><span class="p">,</span> <span class="mh">0xF0</span><span class="p">);</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">access_lock</span><span class="p">);</span>

	<span class="cm">/* Register 1-wire interface(s) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_count</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">channel</span> <span class="o">=</span> <span class="n">idx</span><span class="p">;</span>

		<span class="cm">/* Populate all the w1 bus master stuff */</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">w1_bm</span><span class="p">.</span><span class="n">data</span>       <span class="o">=</span> <span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">];</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">w1_bm</span><span class="p">.</span><span class="n">read_byte</span>  <span class="o">=</span> <span class="n">ds2482_w1_read_byte</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">w1_bm</span><span class="p">.</span><span class="n">write_byte</span> <span class="o">=</span> <span class="n">ds2482_w1_write_byte</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">w1_bm</span><span class="p">.</span><span class="n">touch_bit</span>  <span class="o">=</span> <span class="n">ds2482_w1_touch_bit</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">w1_bm</span><span class="p">.</span><span class="n">triplet</span>    <span class="o">=</span> <span class="n">ds2482_w1_triplet</span><span class="p">;</span>
		<span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">w1_bm</span><span class="p">.</span><span class="n">reset_bus</span>  <span class="o">=</span> <span class="n">ds2482_w1_reset_bus</span><span class="p">;</span>

		<span class="n">err</span> <span class="o">=</span> <span class="n">w1_add_master_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">w1_bm</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">exit_w1_remove</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">exit_w1_remove:</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_count</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">pdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">w1_remove_master_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">w1_bm</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">exit_free:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ds2482_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ds2482_data</span>   <span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>

	<span class="cm">/* Unregister the 1-wire bridge(s) */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_count</span><span class="p">;</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">pdev</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">w1_remove_master_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="o">-&gt;</span><span class="n">w1_ch</span><span class="p">[</span><span class="n">idx</span><span class="p">].</span><span class="n">w1_bm</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Free the memory */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">sensors_ds2482_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">i2c_add_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds2482_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">sensors_ds2482_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_del_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ds2482_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Ben Gardner &lt;bgardner@wabtec.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;DS2482 driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">sensors_ds2482_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">sensors_ds2482_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
