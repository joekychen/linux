<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › w1 › w1.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>w1.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *	w1.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2004 Evgeniy Polyakov &lt;zbr@ioremap.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>

<span class="cp">#include &lt;linux/atomic.h&gt;</span>

<span class="cp">#include &quot;w1.h&quot;</span>
<span class="cp">#include &quot;w1_log.h&quot;</span>
<span class="cp">#include &quot;w1_int.h&quot;</span>
<span class="cp">#include &quot;w1_family.h&quot;</span>
<span class="cp">#include &quot;w1_netlink.h&quot;</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Evgeniy Polyakov &lt;zbr@ioremap.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Driver for 1-wire Dallas network protocol.&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">w1_timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">w1_max_slave_count</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">w1_max_slave_ttl</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

<span class="n">module_param_named</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">w1_timeout</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">max_slave_count</span><span class="p">,</span> <span class="n">w1_max_slave_count</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="n">module_param_named</span><span class="p">(</span><span class="n">slave_ttl</span><span class="p">,</span> <span class="n">w1_max_slave_ttl</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">w1_mlock</span><span class="p">);</span>
<span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">w1_masters</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">w1_attach_slave_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">w1_reg_num</span> <span class="o">*</span><span class="n">rn</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w1_master_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w1_master_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">w1_master_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">dev_to_w1_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Releasing %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_bus_master</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">md</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">w1_slave_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span> <span class="o">=</span> <span class="n">dev_to_w1_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Releasing %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Waiting for %s to become free: refcnt=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">sl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">1000</span><span class="p">))</span>
			<span class="n">flush_signals</span><span class="p">(</span><span class="n">current</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">w1_family_put</span><span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
	<span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">slave_count</span><span class="o">--</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">released</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_slave_read_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span> <span class="o">=</span> <span class="n">dev_to_w1_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_slave_read_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span> <span class="o">=</span> <span class="n">dev_to_w1_slave</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">w1_slave_attr_name</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">w1_slave_read_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">w1_slave_attr_id</span> <span class="o">=</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">w1_slave_read_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cm">/* Default family */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_default_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span> <span class="o">=</span> <span class="n">kobj_to_w1_slave</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">w1_reset_select_slave</span><span class="p">(</span><span class="n">sl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_up</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">w1_write_block</span><span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

<span class="nl">out_up:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_default_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">bin_attr</span><span class="p">,</span>
			       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span> <span class="o">=</span> <span class="n">kobj_to_w1_slave</span><span class="p">(</span><span class="n">kobj</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">w1_read_block</span><span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">w1_default_attr</span> <span class="o">=</span> <span class="p">{</span>
      <span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
              <span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;rw&quot;</span><span class="p">,</span>
              <span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
      <span class="p">},</span>
      <span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">,</span>
      <span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">w1_default_read</span><span class="p">,</span>
      <span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">w1_default_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w1_default_add_slave</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1_default_attr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">w1_default_remove_slave</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1_default_attr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">w1_family_ops</span> <span class="n">w1_default_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">add_slave</span>	<span class="o">=</span> <span class="n">w1_default_add_slave</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_slave</span>	<span class="o">=</span> <span class="n">w1_default_remove_slave</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">w1_family</span> <span class="n">w1_default_family</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">fops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w1_default_fops</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">w1_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_uevent_env</span> <span class="o">*</span><span class="n">env</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bus_type</span> <span class="n">w1_bus_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;w1&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">w1_master_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uevent</span> <span class="o">=</span> <span class="n">w1_uevent</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">device_driver</span> <span class="n">w1_master_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;w1_master_driver&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w1_bus_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">w1_master_probe</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">device</span> <span class="n">w1_master_device</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w1_bus_type</span><span class="p">,</span>
	<span class="p">.</span><span class="n">init_name</span> <span class="o">=</span> <span class="s">&quot;w1 bus master&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w1_master_driver</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w1_master_release</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="n">w1_slave_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;w1_slave_driver&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w1_bus_type</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">struct device w1_slave_device = {</span>
<span class="c">	.parent = NULL,</span>
<span class="c">	.bus = &amp;w1_bus_type,</span>
<span class="c">	.init_name = &quot;w1 bus slave&quot;,</span>
<span class="c">	.driver = &amp;w1_slave_driver,</span>
<span class="c">	.release = &amp;w1_slave_release</span>
<span class="c">};</span>
<span class="cp">#endif  /*  0  */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_show_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">dev_to_w1_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_store_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span> <span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">dev_to_w1_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">search_count</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wake_up_process</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_show_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">dev_to_w1_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">search_count</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_store_pullup</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">dev_to_w1_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtol</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tmp</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">md</span><span class="o">-&gt;</span><span class="n">enable_pullup</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">wake_up_process</span><span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="kr">thread</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_show_pullup</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					       <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">dev_to_w1_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">enable_pullup</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_show_pointer</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">dev_to_w1_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;0x%p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">bus_master</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_show_timeout</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">w1_timeout</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_show_max_slave_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">dev_to_w1_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">max_slave_count</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_show_attempts</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">dev_to_w1_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%lu</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">attempts</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_show_slave_count</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">dev_to_w1_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">count</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">count</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">slave_count</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_show_slaves</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">dev_to_w1_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">slave_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">c</span> <span class="o">-=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="s">&quot;not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">list_head</span> <span class="o">*</span><span class="n">ent</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>

		<span class="n">list_for_each_safe</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">slist</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">sl</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">ent</span><span class="p">,</span> <span class="k">struct</span> <span class="n">w1_slave</span><span class="p">,</span> <span class="n">w1_slave_entry</span><span class="p">);</span>

			<span class="n">c</span> <span class="o">-=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_show_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">-=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span>
		<span class="s">&quot;write device id xx-xxxxxxxxxxxx to add slave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w1_atoreg_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">w1_reg_num</span> <span class="o">*</span><span class="n">rn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">family</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rn64_le</span><span class="p">;</span>

	<span class="cm">/* The CRC value isn&#39;t read from the user because the sysfs directory</span>
<span class="cm">	 * doesn&#39;t include it and most messages from the bus search don&#39;t</span>
<span class="cm">	 * print it either.  It would be unreasonable for the user to then</span>
<span class="cm">	 * provide it.</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">error_msg</span> <span class="o">=</span> <span class="s">&quot;bad slave string format, expecting &quot;</span>
		<span class="s">&quot;ff-dddddddddddd</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;-&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">i</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%02x-%012llx&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">family</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">error_msg</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">rn</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="n">family</span><span class="p">;</span>
	<span class="n">rn</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">rn64_le</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">rn</span><span class="p">);</span>
	<span class="n">rn</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">=</span> <span class="n">w1_calc_crc8</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rn64_le</span><span class="p">,</span> <span class="mi">7</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">	dev_info(dev, &quot;With CRC device is %02x.%012llx.%02x.\n&quot;,</span>
<span class="c">		  rn-&gt;family, (unsigned long long)rn-&gt;id, rn-&gt;crc);</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Searches the slaves in the w1_master and returns a pointer or NULL.</span>
<span class="cm"> * Note: must hold the mutex</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="nf">w1_slave_search_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">w1_reg_num</span> <span class="o">*</span><span class="n">rn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slist</span><span class="p">,</span> <span class="n">w1_slave_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">.</span><span class="n">family</span> <span class="o">==</span> <span class="n">rn</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&amp;&amp;</span>
				<span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">rn</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;&amp;</span>
				<span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">.</span><span class="n">crc</span> <span class="o">==</span> <span class="n">rn</span><span class="o">-&gt;</span><span class="n">crc</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">sl</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_store_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">dev_to_w1_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w1_reg_num</span> <span class="n">rn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">result</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w1_atoreg_num</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rn</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">sl</span> <span class="o">=</span> <span class="n">w1_slave_search_device</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rn</span><span class="p">);</span>
	<span class="cm">/* It would be nice to do a targeted search one the one-wire bus</span>
<span class="cm">	 * for the new device to see if it is out there or not.  But the</span>
<span class="cm">	 * current search doesn&#39;t support that.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device %s already exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">w1_attach_slave_device</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rn</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_show_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">c</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">c</span> <span class="o">-=</span> <span class="n">snprintf</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">c</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span>
		<span class="s">&quot;write device id xx-xxxxxxxxxxxx to remove slave</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">PAGE_SIZE</span> <span class="o">-</span> <span class="n">c</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">w1_master_attribute_store_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
						<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="n">dev_to_w1_master</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">w1_reg_num</span> <span class="n">rn</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">result</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">w1_atoreg_num</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rn</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">sl</span> <span class="o">=</span> <span class="n">w1_slave_search_device</span><span class="p">(</span><span class="n">md</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rn</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w1_slave_detach</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Device %02x-%012llx doesn&#39;t exists</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rn</span><span class="p">.</span><span class="n">family</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rn</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
		<span class="n">result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">md</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define W1_MASTER_ATTR_RO(_name, _mode)				\</span>
<span class="cp">	struct device_attribute w1_master_attribute_##_name =	\</span>
<span class="cp">		__ATTR(w1_master_##_name, _mode,		\</span>
<span class="cp">		       w1_master_attribute_show_##_name, NULL)</span>

<span class="cp">#define W1_MASTER_ATTR_RW(_name, _mode)				\</span>
<span class="cp">	struct device_attribute w1_master_attribute_##_name =	\</span>
<span class="cp">		__ATTR(w1_master_##_name, _mode,		\</span>
<span class="cp">		       w1_master_attribute_show_##_name,	\</span>
<span class="cp">		       w1_master_attribute_store_##_name)</span>

<span class="k">static</span> <span class="n">W1_MASTER_ATTR_RO</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="k">static</span> <span class="n">W1_MASTER_ATTR_RO</span><span class="p">(</span><span class="n">slaves</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="k">static</span> <span class="n">W1_MASTER_ATTR_RO</span><span class="p">(</span><span class="n">slave_count</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="k">static</span> <span class="n">W1_MASTER_ATTR_RO</span><span class="p">(</span><span class="n">max_slave_count</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="k">static</span> <span class="n">W1_MASTER_ATTR_RO</span><span class="p">(</span><span class="n">attempts</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="k">static</span> <span class="n">W1_MASTER_ATTR_RO</span><span class="p">(</span><span class="n">timeout</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="k">static</span> <span class="n">W1_MASTER_ATTR_RO</span><span class="p">(</span><span class="n">pointer</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">);</span>
<span class="k">static</span> <span class="n">W1_MASTER_ATTR_RW</span><span class="p">(</span><span class="n">search</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IWGRP</span><span class="p">);</span>
<span class="k">static</span> <span class="n">W1_MASTER_ATTR_RW</span><span class="p">(</span><span class="n">pullup</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IWGRP</span><span class="p">);</span>
<span class="k">static</span> <span class="n">W1_MASTER_ATTR_RW</span><span class="p">(</span><span class="n">add</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IWGRP</span><span class="p">);</span>
<span class="k">static</span> <span class="n">W1_MASTER_ATTR_RW</span><span class="p">(</span><span class="n">remove</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IWGRP</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">w1_master_default_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">w1_master_attribute_name</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">w1_master_attribute_slaves</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">w1_master_attribute_slave_count</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">w1_master_attribute_max_slave_count</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">w1_master_attribute_attempts</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">w1_master_attribute_timeout</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">w1_master_attribute_pointer</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">w1_master_attribute_search</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">w1_master_attribute_pullup</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">w1_master_attribute_add</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">w1_master_attribute_remove</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">w1_master_defattr_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">w1_master_default_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">w1_create_master_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1_master_defattr_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">w1_destroy_master_attributes</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">master</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1_master_defattr_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HOTPLUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w1_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_uevent_env</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">md</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">event_owner</span><span class="p">,</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">w1_master_driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">md</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">w1_master</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">event_owner</span> <span class="o">=</span> <span class="s">&quot;master&quot;</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">md</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">w1_slave_driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sl</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">w1_slave</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="n">event_owner</span> <span class="o">=</span> <span class="s">&quot;slave&quot;</span><span class="p">;</span>
		<span class="n">name</span> <span class="o">=</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unknown event.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Hotplug event for %s %s, bus_id=%s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">event_owner</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">!=</span> <span class="o">&amp;</span><span class="n">w1_slave_driver</span> <span class="o">||</span> <span class="o">!</span><span class="n">sl</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;W1_FID=%02X&quot;</span><span class="p">,</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">.</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;W1_SLAVE_ID=%024LX&quot;</span><span class="p">,</span>
			     <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">w1_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_uevent_env</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">__w1_attach_slave_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w1_slave_driver</span><span class="p">;</span>
	<span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w1_bus_type</span><span class="p">;</span>
	<span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">w1_slave_release</span><span class="p">;</span>

	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%02x-%012llx&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">.</span><span class="n">family</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>
	<span class="n">snprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">),</span>
		 <span class="s">&quot;%02x-%012llx&quot;</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">.</span><span class="n">family</span><span class="p">,</span>
		 <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">.</span><span class="n">id</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: registering %s as %p.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">sl</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;Device registration [%s] failed. err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create &quot;name&quot; entry */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1_slave_attr_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;sysfs file creation for [%s] failed. err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_unreg</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Create &quot;id&quot; entry */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1_slave_attr_id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;sysfs file creation for [%s] failed. err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_rem1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* if the family driver needs to initialize something... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">&amp;&amp;</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">fops</span><span class="o">-&gt;</span><span class="n">add_slave</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">fops</span><span class="o">-&gt;</span><span class="n">add_slave</span><span class="p">(</span><span class="n">sl</span><span class="p">))</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;sysfs file creation for [%s] failed. err=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">err</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_rem2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">w1_slave_entry</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span><span class="o">-&gt;</span><span class="n">slist</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out_rem2:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1_slave_attr_id</span><span class="p">);</span>
<span class="nl">out_rem1:</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1_slave_attr_name</span><span class="p">);</span>
<span class="nl">out_unreg:</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">w1_attach_slave_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">w1_reg_num</span> <span class="o">*</span><span class="n">rn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w1_family</span> <span class="o">*</span><span class="n">f</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w1_netlink_msg</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">sl</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_slave</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			 <span class="s">&quot;%s: failed to allocate new slave device.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">__func__</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="n">sl</span><span class="o">-&gt;</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">W1_SLAVE_ACTIVE</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">));</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">released</span><span class="p">);</span>

	<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_flock</span><span class="p">);</span>
	<span class="n">f</span> <span class="o">=</span> <span class="n">w1_family_registered</span><span class="p">(</span><span class="n">rn</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">f</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">f</span><span class="o">=</span> <span class="o">&amp;</span><span class="n">w1_default_family</span><span class="p">;</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Family %x for %02x.%012llx.%02x is not registered.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">rn</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">,</span> <span class="n">rn</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">rn</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">,</span> <span class="n">rn</span><span class="o">-&gt;</span><span class="n">crc</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">__w1_family_get</span><span class="p">(</span><span class="n">f</span><span class="p">);</span>
	<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_flock</span><span class="p">);</span>

	<span class="n">sl</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">=</span> <span class="n">f</span><span class="p">;</span>


	<span class="n">err</span> <span class="o">=</span> <span class="n">__w1_attach_slave_device</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: Attaching %s failed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
			 <span class="n">sl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">w1_family_put</span><span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">family</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sl</span><span class="o">-&gt;</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slave_ttl</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">slave_count</span><span class="o">++</span><span class="p">;</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">W1_SLAVE_ADD</span><span class="p">;</span>
	<span class="n">w1_netlink_send</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">w1_slave_detach</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_netlink_msg</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s: detaching %s [%p].</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">sl</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">w1_slave_entry</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">fops</span> <span class="o">&amp;&amp;</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">fops</span><span class="o">-&gt;</span><span class="n">remove_slave</span><span class="p">)</span>
		<span class="n">sl</span><span class="o">-&gt;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">fops</span><span class="o">-&gt;</span><span class="n">remove_slave</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">));</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">id</span><span class="p">.</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">.</span><span class="n">id</span><span class="p">));</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="n">W1_SLAVE_REMOVE</span><span class="p">;</span>
	<span class="n">w1_netlink_send</span><span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">master</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>

	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1_slave_attr_id</span><span class="p">);</span>
	<span class="n">device_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1_slave_attr_name</span><span class="p">);</span>
	<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">released</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="nf">w1_search_master_id</span><span class="p">(</span><span class="n">u32</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_mlock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1_masters</span><span class="p">,</span> <span class="n">w1_master_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_mlock</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span><span class="o">?</span><span class="n">dev</span><span class="o">:</span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="nf">w1_search_slave</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_reg_num</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_mlock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1_masters</span><span class="p">,</span> <span class="n">w1_master_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slist</span><span class="p">,</span> <span class="n">w1_slave_entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">.</span><span class="n">family</span> <span class="o">==</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">family</span> <span class="o">&amp;&amp;</span>
					<span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">.</span><span class="n">id</span> <span class="o">==</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&amp;&amp;</span>
					<span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">.</span><span class="n">crc</span> <span class="o">==</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">crc</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
				<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_mlock</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">found</span><span class="p">)</span><span class="o">?</span><span class="n">sl</span><span class="o">:</span><span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">w1_reconnect_slaves</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_family</span> <span class="o">*</span><span class="n">f</span><span class="p">,</span> <span class="kt">int</span> <span class="n">attach</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span><span class="p">,</span> <span class="o">*</span><span class="n">sln</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_mlock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1_masters</span><span class="p">,</span> <span class="n">w1_master_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reconnecting slaves in device %s &quot;</span>
			<span class="s">&quot;for family %02x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="n">sln</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slist</span><span class="p">,</span> <span class="n">w1_slave_entry</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* If it is a new family, slaves with the default</span>
<span class="cm">			 * family driver and are that family will be</span>
<span class="cm">			 * connected.  If the family is going away, devices</span>
<span class="cm">			 * matching that family are reconneced.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">attach</span> <span class="o">&amp;&amp;</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">fid</span> <span class="o">==</span> <span class="n">W1_FAMILY_DEFAULT</span>
				<span class="o">&amp;&amp;</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">.</span><span class="n">family</span> <span class="o">==</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">(</span><span class="o">!</span><span class="n">attach</span> <span class="o">&amp;&amp;</span> <span class="n">sl</span><span class="o">-&gt;</span><span class="n">family</span><span class="o">-&gt;</span><span class="n">fid</span> <span class="o">==</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">fid</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">struct</span> <span class="n">w1_reg_num</span> <span class="n">rn</span><span class="p">;</span>

				<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rn</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">reg_num</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">rn</span><span class="p">));</span>
				<span class="n">w1_slave_detach</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>

				<span class="n">w1_attach_slave_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rn</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Reconnecting slaves in device %s &quot;</span>
			<span class="s">&quot;has been finished.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_mlock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">w1_slave_found</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u64</span> <span class="n">rn</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">w1_reg_num</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">rn_le</span> <span class="o">=</span> <span class="n">cpu_to_le64</span><span class="p">(</span><span class="n">rn</span><span class="p">);</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">w1_reg_num</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">rn</span><span class="p">;</span>

	<span class="n">sl</span> <span class="o">=</span> <span class="n">w1_slave_search_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sl</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_bit</span><span class="p">(</span><span class="n">W1_SLAVE_ACTIVE</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rn</span> <span class="o">&amp;&amp;</span> <span class="n">tmp</span><span class="o">-&gt;</span><span class="n">crc</span> <span class="o">==</span> <span class="n">w1_calc_crc8</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rn_le</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
			<span class="n">w1_attach_slave_device</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * Performs a ROM Search &amp; registers any devices found.</span>
<span class="cm"> * The 1-wire search is a simple binary tree search.</span>
<span class="cm"> * For each bit of the address, we read two bits and write one bit.</span>
<span class="cm"> * The bit written will put to sleep all devies that don&#39;t match that bit.</span>
<span class="cm"> * When the two reads differ, the direction choice is obvious.</span>
<span class="cm"> * When both bits are 0, we must choose a path to take.</span>
<span class="cm"> * When we can scan all 64 bits without having to choose a path, we are done.</span>
<span class="cm"> *</span>
<span class="cm"> * See &quot;Application note 187 1-wire search algorithm&quot; at www.maxim-ic.com</span>
<span class="cm"> *</span>
<span class="cm"> * @dev        The master device to search</span>
<span class="cm"> * @cb         Function to call when a device is found</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">w1_search</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">search_type</span><span class="p">,</span> <span class="n">w1_slave_found_callback</span> <span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u64</span> <span class="n">last_rn</span><span class="p">,</span> <span class="n">rn</span><span class="p">,</span> <span class="n">tmp64</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">slave_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">last_zero</span><span class="p">,</span> <span class="n">last_device</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">search_bit</span><span class="p">,</span> <span class="n">desc_bit</span><span class="p">;</span>
	<span class="n">u8</span>  <span class="n">triplet_ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">search_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">rn</span> <span class="o">=</span> <span class="n">last_rn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">last_device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">last_zero</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">desc_bit</span> <span class="o">=</span> <span class="mi">64</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span> <span class="o">!</span><span class="n">last_device</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">slave_count</span><span class="o">++</span> <span class="o">&lt;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_slave_count</span><span class="p">)</span> <span class="p">)</span> <span class="p">{</span>
		<span class="n">last_rn</span> <span class="o">=</span> <span class="n">rn</span><span class="p">;</span>
		<span class="n">rn</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * Reset bus and all 1-wire device state machines</span>
<span class="cm">		 * so they can respond to our requests.</span>
<span class="cm">		 *</span>
<span class="cm">		 * Return 0 - device(s) present, 1 - no devices present.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">w1_reset_bus</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;No devices present on the wire.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Do fast search on single slave bus */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">max_slave_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">w1_write_8</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">W1_READ_ROM</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">w1_read_block</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rn</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span> <span class="o">==</span> <span class="mi">8</span> <span class="o">&amp;&amp;</span> <span class="n">rn</span><span class="p">)</span>
				<span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rn</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Start the search */</span>
		<span class="n">w1_write_8</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">search_type</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">64</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Determine the direction/search bit */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">desc_bit</span><span class="p">)</span>
				<span class="n">search_bit</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>	  <span class="cm">/* took the 0 path last time, so take the 1 path */</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">desc_bit</span><span class="p">)</span>
				<span class="n">search_bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	  <span class="cm">/* take the 0 path on the next branch */</span>
			<span class="k">else</span>
				<span class="n">search_bit</span> <span class="o">=</span> <span class="p">((</span><span class="n">last_rn</span> <span class="o">&gt;&gt;</span> <span class="n">i</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x1</span><span class="p">);</span>

			<span class="cm">/** Read two bits and write one bit */</span>
			<span class="n">triplet_ret</span> <span class="o">=</span> <span class="n">w1_triplet</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">search_bit</span><span class="p">);</span>

			<span class="cm">/* quit if no device responded */</span>
			<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">triplet_ret</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x03</span> <span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="cm">/* If both directions were valid, and we took the 0 path... */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">triplet_ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">last_zero</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>

			<span class="cm">/* extract the direction taken &amp; update the device number */</span>
			<span class="n">tmp64</span> <span class="o">=</span> <span class="p">(</span><span class="n">triplet_ret</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
			<span class="n">rn</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tmp64</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
				<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Abort w1_search</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">triplet_ret</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x03</span> <span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span> <span class="p">(</span><span class="n">desc_bit</span> <span class="o">==</span> <span class="n">last_zero</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">last_zero</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
				<span class="n">last_device</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">desc_bit</span> <span class="o">=</span> <span class="n">last_zero</span><span class="p">;</span>
			<span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rn</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">w1_search_process_cb</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">search_type</span><span class="p">,</span>
	<span class="n">w1_slave_found_callback</span> <span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_slave</span> <span class="o">*</span><span class="n">sl</span><span class="p">,</span> <span class="o">*</span><span class="n">sln</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slist</span><span class="p">,</span> <span class="n">w1_slave_entry</span><span class="p">)</span>
		<span class="n">clear_bit</span><span class="p">(</span><span class="n">W1_SLAVE_ACTIVE</span><span class="p">,</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">w1_search_devices</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">search_type</span><span class="p">,</span> <span class="n">cb</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">sl</span><span class="p">,</span> <span class="n">sln</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">slist</span><span class="p">,</span> <span class="n">w1_slave_entry</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="n">W1_SLAVE_ACTIVE</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!--</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">ttl</span><span class="p">)</span>
			<span class="n">w1_slave_detach</span><span class="p">(</span><span class="n">sl</span><span class="p">);</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">W1_SLAVE_ACTIVE</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">sl</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">))</span>
			<span class="n">sl</span><span class="o">-&gt;</span><span class="n">ttl</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">slave_ttl</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">search_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">search_count</span><span class="o">--</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">w1_search_process</span><span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">search_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">w1_search_process_cb</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">search_type</span><span class="p">,</span> <span class="n">w1_slave_found</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">w1_process</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="p">)</span> <span class="n">data</span><span class="p">;</span>
	<span class="cm">/* As long as w1_timeout is only set by a module parameter the sleep</span>
<span class="cm">	 * time can be calculated in jiffies once.</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">jtime</span> <span class="o">=</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">w1_timeout</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">kthread_should_stop</span><span class="p">())</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">search_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="n">w1_search_process</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">W1_SEARCH</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">try_to_freeze</span><span class="p">();</span>
		<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">kthread_should_stop</span><span class="p">())</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* Only sleep when the search is active. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">search_count</span><span class="p">)</span>
			<span class="n">schedule_timeout</span><span class="p">(</span><span class="n">jtime</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">refcnt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">w1_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Driver for 1-wire Dallas network protocol.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">w1_init_netlink</span><span class="p">();</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_bus_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Failed to register bus. err=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_exit_init</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_master_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;Failed to register master driver. err=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_bus_unregister</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_slave_driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
			<span class="s">&quot;Failed to register slave driver. err=%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">retval</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_out_master_unregister</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">/* For undoing the slave register if there was a step after it. */</span>
<span class="c">err_out_slave_unregister:</span>
<span class="c">	driver_unregister(&amp;w1_slave_driver);</span>
<span class="cp">#endif</span>

<span class="nl">err_out_master_unregister:</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_master_driver</span><span class="p">);</span>

<span class="nl">err_out_bus_unregister:</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_bus_type</span><span class="p">);</span>

<span class="nl">err_out_exit_init:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">w1_fini</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">w1_master</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

	<span class="cm">/* Set netlink removal messages and some cleanup */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">w1_masters</span><span class="p">,</span> <span class="n">w1_master_entry</span><span class="p">)</span>
		<span class="n">__w1_remove_master_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">w1_fini_netlink</span><span class="p">();</span>

	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_slave_driver</span><span class="p">);</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_master_driver</span><span class="p">);</span>
	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w1_bus_type</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">w1_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">w1_fini</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
