<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › remoteproc › remoteproc_virtio.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>remoteproc_virtio.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Remote processor messaging transport (OMAP platform-specific bits)</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2011 Texas Instruments, Inc.</span>
<span class="cm"> * Copyright (C) 2011 Google, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * Ohad Ben-Cohen &lt;ohad@wizery.com&gt;</span>
<span class="cm"> * Brian Swetland &lt;swetland@google.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This software is licensed under the terms of the GNU General Public</span>
<span class="cm"> * License version 2, as published by the Free Software Foundation, and</span>
<span class="cm"> * may be copied, distributed, and modified under those terms.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/remoteproc.h&gt;</span>
<span class="cp">#include &lt;linux/virtio.h&gt;</span>
<span class="cp">#include &lt;linux/virtio_config.h&gt;</span>
<span class="cp">#include &lt;linux/virtio_ids.h&gt;</span>
<span class="cp">#include &lt;linux/virtio_ring.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/kref.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &quot;remoteproc_internal.h&quot;</span>

<span class="cm">/* kick the remote processor, and let it know which virtqueue to poke at */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rproc_virtio_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="n">vq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rproc_vring</span> <span class="o">*</span><span class="n">rvring</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rproc</span> <span class="o">*</span><span class="n">rproc</span> <span class="o">=</span> <span class="n">rvring</span><span class="o">-&gt;</span><span class="n">rvdev</span><span class="o">-&gt;</span><span class="n">rproc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">notifyid</span> <span class="o">=</span> <span class="n">rvring</span><span class="o">-&gt;</span><span class="n">notifyid</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">rproc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;kicking vq index: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">notifyid</span><span class="p">);</span>

	<span class="n">rproc</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">kick</span><span class="p">(</span><span class="n">rproc</span><span class="p">,</span> <span class="n">notifyid</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rproc_vq_interrupt() - tell remoteproc that a virtqueue is interrupted</span>
<span class="cm"> * @rproc: handle to the remote processor</span>
<span class="cm"> * @notifyid: index of the signalled virtqueue (unique per this @rproc)</span>
<span class="cm"> *</span>
<span class="cm"> * This function should be called by the platform-specific rproc driver,</span>
<span class="cm"> * when the remote processor signals that a specific virtqueue has pending</span>
<span class="cm"> * messages available.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns IRQ_NONE if no message was found in the @notifyid virtqueue,</span>
<span class="cm"> * and otherwise returns IRQ_HANDLED.</span>
<span class="cm"> */</span>
<span class="n">irqreturn_t</span> <span class="nf">rproc_vq_interrupt</span><span class="p">(</span><span class="k">struct</span> <span class="n">rproc</span> <span class="o">*</span><span class="n">rproc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">notifyid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rproc_vring</span> <span class="o">*</span><span class="n">rvring</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">rproc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vq index %d is interrupted</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">notifyid</span><span class="p">);</span>

	<span class="n">rvring</span> <span class="o">=</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rproc</span><span class="o">-&gt;</span><span class="n">notifyids</span><span class="p">,</span> <span class="n">notifyid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rvring</span> <span class="o">||</span> <span class="o">!</span><span class="n">rvring</span><span class="o">-&gt;</span><span class="n">vq</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">vring_interrupt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rvring</span><span class="o">-&gt;</span><span class="n">vq</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">rproc_vq_interrupt</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="nf">rp_find_vq</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="n">id</span><span class="p">,</span>
				    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="n">vq</span><span class="p">),</span>
				    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rproc_vdev</span> <span class="o">*</span><span class="n">rvdev</span> <span class="o">=</span> <span class="n">vdev_to_rvdev</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rproc</span> <span class="o">*</span><span class="n">rproc</span> <span class="o">=</span> <span class="n">vdev_to_rproc</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rproc_vring</span> <span class="o">*</span><span class="n">rvring</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="n">vq</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span><span class="p">,</span> <span class="n">size</span><span class="p">;</span>

	<span class="cm">/* we&#39;re temporarily limited to two virtqueues per rvdev */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">rvdev</span><span class="o">-&gt;</span><span class="n">vring</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">rvring</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rvdev</span><span class="o">-&gt;</span><span class="n">vring</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>

	<span class="n">addr</span> <span class="o">=</span> <span class="n">rvring</span><span class="o">-&gt;</span><span class="n">va</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">rvring</span><span class="o">-&gt;</span><span class="n">len</span><span class="p">;</span>

	<span class="cm">/* zero vring */</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">vring_size</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">rvring</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">rproc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vring%d: va %p qsz %d notifyid %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">id</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">rvring</span><span class="o">-&gt;</span><span class="n">notifyid</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Create the new vq, and tell virtio we&#39;re not interested in</span>
<span class="cm">	 * the &#39;weak&#39; smp barriers, since we&#39;re talking with a real device.</span>
<span class="cm">	 */</span>
	<span class="n">vq</span> <span class="o">=</span> <span class="n">vring_new_virtqueue</span><span class="p">(</span><span class="n">len</span><span class="p">,</span> <span class="n">rvring</span><span class="o">-&gt;</span><span class="n">align</span><span class="p">,</span> <span class="n">vdev</span><span class="p">,</span> <span class="nb">false</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
					<span class="n">rproc_virtio_notify</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rproc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;vring_new_virtqueue %s failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rvring</span><span class="o">-&gt;</span><span class="n">vq</span> <span class="o">=</span> <span class="n">vq</span><span class="p">;</span>
	<span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv</span> <span class="o">=</span> <span class="n">rvring</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">vq</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rproc_virtio_del_vqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="n">vq</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">rproc</span> <span class="o">*</span><span class="n">rproc</span> <span class="o">=</span> <span class="n">vdev_to_rproc</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rproc_vring</span> <span class="o">*</span><span class="n">rvring</span><span class="p">;</span>

	<span class="cm">/* power down the remote processor before deleting vqs */</span>
	<span class="n">rproc_shutdown</span><span class="p">(</span><span class="n">rproc</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">vq</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">vqs</span><span class="p">,</span> <span class="n">list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rvring</span> <span class="o">=</span> <span class="n">vq</span><span class="o">-&gt;</span><span class="n">priv</span><span class="p">;</span>
		<span class="n">rvring</span><span class="o">-&gt;</span><span class="n">vq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">vring_del_virtqueue</span><span class="p">(</span><span class="n">vq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">rproc_virtio_find_vqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="n">nvqs</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">virtqueue</span> <span class="o">*</span><span class="n">vqs</span><span class="p">[],</span>
		       <span class="n">vq_callback_t</span> <span class="o">*</span><span class="n">callbacks</span><span class="p">[],</span>
		       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">names</span><span class="p">[])</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rproc</span> <span class="o">*</span><span class="n">rproc</span> <span class="o">=</span> <span class="n">vdev_to_rproc</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nvqs</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">vqs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">rp_find_vq</span><span class="p">(</span><span class="n">vdev</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">callbacks</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">vqs</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">vqs</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* now that the vqs are all set, boot the remote processor */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">rproc_boot</span><span class="p">(</span><span class="n">rproc</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">rproc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rproc_boot() failed %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">error:</span>
	<span class="n">rproc_virtio_del_vqs</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * We don&#39;t support yet real virtio status semantics.</span>
<span class="cm"> *</span>
<span class="cm"> * The plan is to provide this via the VDEV resource entry</span>
<span class="cm"> * which is part of the firmware: this way the remote processor</span>
<span class="cm"> * will be able to access the status values as set by us.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="nf">rproc_virtio_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rproc_virtio_set_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;status: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rproc_virtio_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;reset !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* provide the vdev features as retrieved from the firmware */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">rproc_virtio_get_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rproc_vdev</span> <span class="o">*</span><span class="n">rvdev</span> <span class="o">=</span> <span class="n">vdev_to_rvdev</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rvdev</span><span class="o">-&gt;</span><span class="n">dfeatures</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">rproc_virtio_finalize_features</span><span class="p">(</span><span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rproc_vdev</span> <span class="o">*</span><span class="n">rvdev</span> <span class="o">=</span> <span class="n">vdev_to_rvdev</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="cm">/* Give virtio_ring a chance to accept features */</span>
	<span class="n">vring_transport_features</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Remember the finalized features of our vdev, and provide it</span>
<span class="cm">	 * to the remote processor once it is powered on.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Similarly to the status field, we don&#39;t expose yet the negotiated</span>
<span class="cm">	 * features to the remote processors at this point. This will be</span>
<span class="cm">	 * fixed as part of a small resource table overhaul and then an</span>
<span class="cm">	 * extension of the virtio resource entries.</span>
<span class="cm">	 */</span>
	<span class="n">rvdev</span><span class="o">-&gt;</span><span class="n">gfeatures</span> <span class="o">=</span> <span class="n">vdev</span><span class="o">-&gt;</span><span class="n">features</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">virtio_config_ops</span> <span class="n">rproc_virtio_config_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">get_features</span>	<span class="o">=</span> <span class="n">rproc_virtio_get_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">finalize_features</span> <span class="o">=</span> <span class="n">rproc_virtio_finalize_features</span><span class="p">,</span>
	<span class="p">.</span><span class="n">find_vqs</span>	<span class="o">=</span> <span class="n">rproc_virtio_find_vqs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">del_vqs</span>	<span class="o">=</span> <span class="n">rproc_virtio_del_vqs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset</span>		<span class="o">=</span> <span class="n">rproc_virtio_reset</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_status</span>	<span class="o">=</span> <span class="n">rproc_virtio_set_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_status</span>	<span class="o">=</span> <span class="n">rproc_virtio_get_status</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * This function is called whenever vdev is released, and is responsible</span>
<span class="cm"> * to decrement the remote processor&#39;s refcount taken when vdev was</span>
<span class="cm"> * added.</span>
<span class="cm"> *</span>
<span class="cm"> * Never call this function directly; it will be called by the driver</span>
<span class="cm"> * core when needed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">rproc_vdev_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="n">dev_to_virtio</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">rproc</span> <span class="o">*</span><span class="n">rproc</span> <span class="o">=</span> <span class="n">vdev_to_rproc</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>

	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rproc</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="n">rproc_release</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rproc_add_virtio_dev() - register an rproc-induced virtio device</span>
<span class="cm"> * @rvdev: the remote vdev</span>
<span class="cm"> *</span>
<span class="cm"> * This function registers a virtio device. This vdev&#39;s partent is</span>
<span class="cm"> * the rproc device.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns 0 on success or an appropriate error value otherwise.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">rproc_add_virtio_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">rproc_vdev</span> <span class="o">*</span><span class="n">rvdev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">rproc</span> <span class="o">*</span><span class="n">rproc</span> <span class="o">=</span> <span class="n">rvdev</span><span class="o">-&gt;</span><span class="n">rproc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">rproc</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">virtio_device</span> <span class="o">*</span><span class="n">vdev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rvdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device</span>	<span class="o">=</span> <span class="n">id</span><span class="p">,</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">rproc_virtio_config_ops</span><span class="p">,</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">rproc_vdev_release</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;re indirectly making a non-temporary copy of the rproc pointer</span>
<span class="cm">	 * here, because drivers probed with this vdev will indirectly</span>
<span class="cm">	 * access the wrapping rproc.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Therefore we must increment the rproc refcount here, and decrement</span>
<span class="cm">	 * it _only_ when the vdev is released.</span>
<span class="cm">	 */</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rproc</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">register_virtio_device</span><span class="p">(</span><span class="n">vdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rproc</span><span class="o">-&gt;</span><span class="n">refcount</span><span class="p">,</span> <span class="n">rproc_release</span><span class="p">);</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;failed to register vdev: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;registered %s (type %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">),</span> <span class="n">id</span><span class="p">);</span>

<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rproc_remove_virtio_dev() - remove an rproc-induced virtio device</span>
<span class="cm"> * @rvdev: the remote vdev</span>
<span class="cm"> *</span>
<span class="cm"> * This function unregisters an existing virtio device.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">rproc_remove_virtio_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">rproc_vdev</span> <span class="o">*</span><span class="n">rvdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">unregister_virtio_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">rvdev</span><span class="o">-&gt;</span><span class="n">vdev</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
