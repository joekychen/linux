<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › misc › lis3lv02d › lis3lv02d.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>lis3lv02d.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  lis3lv02d.c - ST LIS3LV02DL accelerometer driver</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (C) 2007-2008 Yan Burman</span>
<span class="cm"> *  Copyright (C) 2008 Eric Piel</span>
<span class="cm"> *  Copyright (C) 2008-2009 Pavel Machek</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) KBUILD_MODNAME &quot;: &quot; fmt</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/input-polldev.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/freezer.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/miscdevice.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/atomic.h&gt;</span>
<span class="cp">#include &quot;lis3lv02d.h&quot;</span>

<span class="cp">#define DRIVER_NAME     &quot;lis3lv02d&quot;</span>

<span class="cm">/* joystick device poll interval in milliseconds */</span>
<span class="cp">#define MDPS_POLL_INTERVAL 50</span>
<span class="cp">#define MDPS_POLL_MIN	   0</span>
<span class="cp">#define MDPS_POLL_MAX	   2000</span>

<span class="cp">#define LIS3_SYSFS_POWERDOWN_DELAY 5000 </span><span class="cm">/* In milliseconds */</span><span class="cp"></span>

<span class="cp">#define SELFTEST_OK	       0</span>
<span class="cp">#define SELFTEST_FAIL	       -1</span>
<span class="cp">#define SELFTEST_IRQ	       -2</span>

<span class="cp">#define IRQ_LINE0	       0</span>
<span class="cp">#define IRQ_LINE1	       1</span>

<span class="cm">/*</span>
<span class="cm"> * The sensor can also generate interrupts (DRDY) but it&#39;s pretty pointless</span>
<span class="cm"> * because they are generated even if the data do not change. So it&#39;s better</span>
<span class="cm"> * to keep the interrupt for the free-fall event. The values are updated at</span>
<span class="cm"> * 40Hz (at the lowest frequency), but as it can be pretty time consuming on</span>
<span class="cm"> * some low processor, we poll the sensor only at 20Hz... enough for the</span>
<span class="cm"> * joystick.</span>
<span class="cm"> */</span>

<span class="cp">#define LIS3_PWRON_DELAY_WAI_12B	(5000)</span>
<span class="cp">#define LIS3_PWRON_DELAY_WAI_8B		(3000)</span>

<span class="cm">/*</span>
<span class="cm"> * LIS3LV02D spec says 1024 LSBs corresponds 1 G -&gt; 1LSB is 1000/1024 mG</span>
<span class="cm"> * LIS302D spec says: 18 mG / digit</span>
<span class="cm"> * LIS3_ACCURACY is used to increase accuracy of the intermediate</span>
<span class="cm"> * calculation results.</span>
<span class="cm"> */</span>
<span class="cp">#define LIS3_ACCURACY			1024</span>
<span class="cm">/* Sensitivity values for -2G +2G scale */</span>
<span class="cp">#define LIS3_SENSITIVITY_12B		((LIS3_ACCURACY * 1000) / 1024)</span>
<span class="cp">#define LIS3_SENSITIVITY_8B		(18 * LIS3_ACCURACY)</span>

<span class="cp">#define LIS3_DEFAULT_FUZZ_12B		3</span>
<span class="cp">#define LIS3_DEFAULT_FLAT_12B		3</span>
<span class="cp">#define LIS3_DEFAULT_FUZZ_8B		1</span>
<span class="cp">#define LIS3_DEFAULT_FLAT_8B		1</span>

<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="n">lis3_dev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">misc_wait</span>   <span class="o">=</span> <span class="n">__WAIT_QUEUE_HEAD_INITIALIZER</span><span class="p">(</span><span class="n">lis3_dev</span><span class="p">.</span><span class="n">misc_wait</span><span class="p">),</span>
<span class="p">};</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lis3_dev</span><span class="p">);</span>

<span class="cm">/* just like param_set_int() but does sanity-check so that it won&#39;t point</span>
<span class="cm"> * over the axis array size</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">param_set_axis</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">val</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">param_set_int</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">kp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span><span class="n">kp</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">val</span> <span class="o">=</span> <span class="o">-</span><span class="n">val</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span> <span class="o">||</span> <span class="n">val</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kernel_param_ops</span> <span class="n">param_ops_axis</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">set</span> <span class="o">=</span> <span class="n">param_set_axis</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">param_get_int</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define param_check_axis(name, p) param_check_int(name, p)</span>

<span class="n">module_param_array_named</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="n">lis3_dev</span><span class="p">.</span><span class="n">ac</span><span class="p">.</span><span class="n">as_array</span><span class="p">,</span> <span class="n">axis</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">axes</span><span class="p">,</span> <span class="s">&quot;Axis-mapping for x,y,z directions&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">s16</span> <span class="nf">lis3lv02d_read_8</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s8</span> <span class="n">lo</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">lo</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s16</span> <span class="nf">lis3lv02d_read_12</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">lo</span><span class="p">,</span> <span class="n">hi</span><span class="p">;</span>

	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">reg</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lo</span><span class="p">);</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">hi</span><span class="p">);</span>
	<span class="cm">/* In &quot;12 bit right justified&quot; mode, bit 6, bit 7, bit 8 = bit 5 */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">s16</span><span class="p">)((</span><span class="n">hi</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">lo</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lis3lv02d_get_axis - For the given axis, give the value converted</span>
<span class="cm"> * @axis:      1,2,3 - can also be negative</span>
<span class="cm"> * @hw_values: raw values returned by the hardware</span>
<span class="cm"> *</span>
<span class="cm"> * Returns the converted value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">lis3lv02d_get_axis</span><span class="p">(</span><span class="n">s8</span> <span class="n">axis</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hw_values</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">axis</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">hw_values</span><span class="p">[</span><span class="n">axis</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">hw_values</span><span class="p">[</span><span class="o">-</span><span class="n">axis</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * lis3lv02d_get_xyz - Get X, Y and Z axis values from the accelerometer</span>
<span class="cm"> * @lis3: pointer to the device struct</span>
<span class="cm"> * @x:    where to store the X axis value</span>
<span class="cm"> * @y:    where to store the Y axis value</span>
<span class="cm"> * @z:    where to store the Z axis value</span>
<span class="cm"> *</span>
<span class="cm"> * Note that 40Hz input device can eat up about 10% CPU at 800MHZ</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lis3lv02d_get_xyz</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">z</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">position</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">blkread</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">whoami</span> <span class="o">==</span> <span class="n">WAI_12B</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">u16</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
			<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">blkread</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">OUTX_L</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s16</span><span class="p">)</span><span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">];</span>
			<span class="cm">/* Data: x, dummy, y, dummy, z */</span>
			<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">blkread</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">OUTX</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
				<span class="n">position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s8</span><span class="p">)</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">position</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read_data</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">OUTX</span><span class="p">);</span>
		<span class="n">position</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read_data</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">OUTY</span><span class="p">);</span>
		<span class="n">position</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read_data</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">OUTZ</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">position</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">)</span> <span class="o">/</span> <span class="n">LIS3_ACCURACY</span><span class="p">;</span>

	<span class="o">*</span><span class="n">x</span> <span class="o">=</span> <span class="n">lis3lv02d_get_axis</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">x</span><span class="p">,</span> <span class="n">position</span><span class="p">);</span>
	<span class="o">*</span><span class="n">y</span> <span class="o">=</span> <span class="n">lis3lv02d_get_axis</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">y</span><span class="p">,</span> <span class="n">position</span><span class="p">);</span>
	<span class="o">*</span><span class="n">z</span> <span class="o">=</span> <span class="n">lis3lv02d_get_axis</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">z</span><span class="p">,</span> <span class="n">position</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* conversion btw sampling rate and the register values */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lis3_12_rates</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">40</span><span class="p">,</span> <span class="mi">160</span><span class="p">,</span> <span class="mi">640</span><span class="p">,</span> <span class="mi">2560</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lis3_8_rates</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">100</span><span class="p">,</span> <span class="mi">400</span><span class="p">};</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">lis3_3dc_rates</span><span class="p">[</span><span class="mi">16</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">1600</span><span class="p">,</span> <span class="mi">5000</span><span class="p">};</span>

<span class="cm">/* ODR is Output Data Rate */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">lis3lv02d_get_odr</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">shift</span><span class="p">;</span>

	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CTRL_REG1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">odr_mask</span><span class="p">;</span>
	<span class="n">shift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">odr_mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">odrs</span><span class="p">[(</span><span class="n">ctrl</span> <span class="o">&gt;&gt;</span> <span class="n">shift</span><span class="p">)];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lis3lv02d_get_pwron_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">div</span> <span class="o">=</span> <span class="n">lis3lv02d_get_odr</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">WARN_ONCE</span><span class="p">(</span><span class="n">div</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;device returned spurious data&quot;</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

	<span class="cm">/* LIS3 power on delay is quite long */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pwron_delay</span> <span class="o">/</span> <span class="n">div</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lis3lv02d_set_odr</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ctrl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">shift</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">rate</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CTRL_REG1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl</span><span class="p">);</span>
	<span class="n">ctrl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">odr_mask</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">hweight_long</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">odr_mask</span><span class="p">);</span> <span class="cm">/* # of possible values */</span>
	<span class="n">shift</span> <span class="o">=</span> <span class="n">ffs</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">odr_mask</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">odrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CTRL_REG1</span><span class="p">,</span>
					<span class="n">ctrl</span> <span class="o">|</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="n">shift</span><span class="p">));</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lis3lv02d_selftest</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">,</span> <span class="n">s16</span> <span class="n">results</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">ctlreg</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">s16</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">selftest</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">ctrl_reg_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">irq_cfg</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">irq_cfg</span> <span class="o">=</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">irq_cfg</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">whoami</span> <span class="o">==</span> <span class="n">WAI_8B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">data_ready_count</span><span class="p">[</span><span class="n">IRQ_LINE0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">data_ready_count</span><span class="p">[</span><span class="n">IRQ_LINE1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* Change interrupt cfg to data ready for selftest */</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">wake_thread</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">irq_cfg</span> <span class="o">=</span> <span class="n">LIS3_IRQ1_DATA_READY</span> <span class="o">|</span> <span class="n">LIS3_IRQ2_DATA_READY</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CTRL_REG3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ctrl_reg_data</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CTRL_REG3</span><span class="p">,</span> <span class="p">(</span><span class="n">ctrl_reg_data</span> <span class="o">&amp;</span>
				<span class="o">~</span><span class="p">(</span><span class="n">LIS3_IRQ1_MASK</span> <span class="o">|</span> <span class="n">LIS3_IRQ2_MASK</span><span class="p">))</span> <span class="o">|</span>
				<span class="p">(</span><span class="n">LIS3_IRQ1_DATA_READY</span> <span class="o">|</span> <span class="n">LIS3_IRQ2_DATA_READY</span><span class="p">));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">whoami</span> <span class="o">==</span> <span class="n">WAI_3DC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ctlreg</span> <span class="o">=</span> <span class="n">CTRL_REG4</span><span class="p">;</span>
		<span class="n">selftest</span> <span class="o">=</span> <span class="n">CTRL4_ST0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ctlreg</span> <span class="o">=</span> <span class="n">CTRL_REG1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">whoami</span> <span class="o">==</span> <span class="n">WAI_12B</span><span class="p">)</span>
			<span class="n">selftest</span> <span class="o">=</span> <span class="n">CTRL1_ST</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">selftest</span> <span class="o">=</span> <span class="n">CTRL1_STP</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">ctlreg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">ctlreg</span><span class="p">,</span> <span class="p">(</span><span class="n">reg</span> <span class="o">|</span> <span class="n">selftest</span><span class="p">));</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lis3lv02d_get_pwron_wait</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="cm">/* Read directly to avoid axis remap */</span>
	<span class="n">x</span> <span class="o">=</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read_data</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">OUTX</span><span class="p">);</span>
	<span class="n">y</span> <span class="o">=</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read_data</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">OUTY</span><span class="p">);</span>
	<span class="n">z</span> <span class="o">=</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read_data</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">OUTZ</span><span class="p">);</span>

	<span class="cm">/* back to normal settings */</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">ctlreg</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">lis3lv02d_get_pwron_wait</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read_data</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">OUTX</span><span class="p">);</span>
	<span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read_data</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">OUTY</span><span class="p">);</span>
	<span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">z</span> <span class="o">-</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read_data</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">OUTZ</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">whoami</span> <span class="o">==</span> <span class="n">WAI_8B</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Restore original interrupt configuration */</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">wake_thread</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CTRL_REG3</span><span class="p">,</span> <span class="n">ctrl_reg_data</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">irq_cfg</span> <span class="o">=</span> <span class="n">irq_cfg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">irq_cfg</span> <span class="o">&amp;</span> <span class="n">LIS3_IRQ1_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">data_ready_count</span><span class="p">[</span><span class="n">IRQ_LINE0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">SELFTEST_IRQ</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">irq_cfg</span> <span class="o">&amp;</span> <span class="n">LIS3_IRQ2_MASK</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">data_ready_count</span><span class="p">[</span><span class="n">IRQ_LINE1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">SELFTEST_IRQ</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Check against selftest acceptance limits */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">st_min_limits</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">||</span>
			    <span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">st_max_limits</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">SELFTEST_FAIL</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* test passed */</span>
<span class="nl">fail:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Order of registers in the list affects to order of the restore process.</span>
<span class="cm"> * Perhaps it is a good idea to set interrupt enable register as a last one</span>
<span class="cm"> * after all other configurations</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u8</span> <span class="n">lis3_wai8_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="n">FF_WU_CFG_1</span><span class="p">,</span> <span class="n">FF_WU_THS_1</span><span class="p">,</span> <span class="n">FF_WU_DURATION_1</span><span class="p">,</span>
			       <span class="n">FF_WU_CFG_2</span><span class="p">,</span> <span class="n">FF_WU_THS_2</span><span class="p">,</span> <span class="n">FF_WU_DURATION_2</span><span class="p">,</span>
			       <span class="n">CLICK_CFG</span><span class="p">,</span> <span class="n">CLICK_SRC</span><span class="p">,</span> <span class="n">CLICK_THSY_X</span><span class="p">,</span> <span class="n">CLICK_THSZ</span><span class="p">,</span>
			       <span class="n">CLICK_TIMELIMIT</span><span class="p">,</span> <span class="n">CLICK_LATENCY</span><span class="p">,</span> <span class="n">CLICK_WINDOW</span><span class="p">,</span>
			       <span class="n">CTRL_REG1</span><span class="p">,</span> <span class="n">CTRL_REG2</span><span class="p">,</span> <span class="n">CTRL_REG3</span><span class="p">};</span>

<span class="k">static</span> <span class="n">u8</span> <span class="n">lis3_wai12_regs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">FF_WU_CFG</span><span class="p">,</span> <span class="n">FF_WU_THS_L</span><span class="p">,</span> <span class="n">FF_WU_THS_H</span><span class="p">,</span>
			       <span class="n">FF_WU_DURATION</span><span class="p">,</span> <span class="n">DD_CFG</span><span class="p">,</span> <span class="n">DD_THSI_L</span><span class="p">,</span> <span class="n">DD_THSI_H</span><span class="p">,</span>
			       <span class="n">DD_THSE_L</span><span class="p">,</span> <span class="n">DD_THSE_H</span><span class="p">,</span>
			       <span class="n">CTRL_REG1</span><span class="p">,</span> <span class="n">CTRL_REG3</span><span class="p">,</span> <span class="n">CTRL_REG2</span><span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lis3_context_save</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">regs_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">reg_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">regs_stored</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lis3_context_restore</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">regs_stored</span><span class="p">)</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">regs_size</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">reg_cache</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">lis3lv02d_poweroff</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">reg_ctrl</span><span class="p">)</span>
		<span class="n">lis3_context_save</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>
	<span class="cm">/* disable X,Y,Z axis and power down */</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CTRL_REG1</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">reg_ctrl</span><span class="p">)</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">reg_ctrl</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">LIS3_REG_OFF</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lis3lv02d_poweroff</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">lis3lv02d_poweron</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Common configuration</span>
<span class="cm">	 * BDU: (12 bits sensors only) LSB and MSB values are not updated until</span>
<span class="cm">	 *      both have been read. So the value read will always be correct.</span>
<span class="cm">	 * Set BOOT bit to refresh factory tuning values.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CTRL_REG2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">reg</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">whoami</span> <span class="o">==</span>  <span class="n">WAI_12B</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">CTRL2_BDU</span> <span class="o">|</span> <span class="n">CTRL2_BOOT</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">CTRL2_BOOT_8B</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CTRL_REG2</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">lis3lv02d_get_pwron_wait</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">reg_ctrl</span><span class="p">)</span>
		<span class="n">lis3_context_restore</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lis3lv02d_poweron</span><span class="p">);</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">lis3lv02d_joystick_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_polled_dev</span> <span class="o">*</span><span class="n">pidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">pidev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">lis3lv02d_get_xyz</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">z</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">pidev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="n">x</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">pidev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="n">y</span><span class="p">);</span>
	<span class="n">input_report_abs</span><span class="p">(</span><span class="n">pidev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">ABS_Z</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">pidev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lis3lv02d_joystick_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_polled_dev</span> <span class="o">*</span><span class="n">pidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">pidev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">)</span>
		<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">whoami</span> <span class="o">==</span> <span class="n">WAI_8B</span> <span class="o">&amp;&amp;</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">)</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">wake_thread</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Update coordinates for the case where poll interval is 0 and</span>
<span class="cm">	 * the chip in running purely under interrupt control</span>
<span class="cm">	 */</span>
	<span class="n">lis3lv02d_joystick_poll</span><span class="p">(</span><span class="n">pidev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lis3lv02d_joystick_close</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_polled_dev</span> <span class="o">*</span><span class="n">pidev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">pidev</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">wake_thread</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">)</span>
		<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">lis302dl_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">test_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">misc_opened</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Be careful: on some HP laptops the bios force DD when on battery and</span>
<span class="cm">	 * the lid is closed. This leads to interrupts as soon as a little move</span>
<span class="cm">	 * is done.</span>
<span class="cm">	 */</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">);</span>
	<span class="n">kill_fasync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">async_queue</span><span class="p">,</span> <span class="n">SIGIO</span><span class="p">,</span> <span class="n">POLL_IN</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">wake_thread</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">IRQ_WAKE_THREAD</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lis302dl_interrupt_handle_click</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">click_src</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CLICK_SRC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">click_src</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">click_src</span> <span class="o">&amp;</span> <span class="n">CLICK_SINGLE_X</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mapped_btns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mapped_btns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">click_src</span> <span class="o">&amp;</span> <span class="n">CLICK_SINGLE_Y</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mapped_btns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mapped_btns</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">click_src</span> <span class="o">&amp;</span> <span class="n">CLICK_SINGLE_Z</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mapped_btns</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mapped_btns</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">input_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">lis302dl_data_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">dummy</span><span class="p">;</span>

	<span class="cm">/* Dummy read to ack interrupt */</span>
	<span class="n">lis3lv02d_get_xyz</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dummy</span><span class="p">);</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">data_ready_count</span><span class="p">[</span><span class="n">index</span><span class="p">]</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">lis302dl_interrupt_thread1_8b</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">irq_cfg</span> <span class="o">=</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">irq_cfg</span> <span class="o">&amp;</span> <span class="n">LIS3_IRQ1_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_cfg</span> <span class="o">==</span> <span class="n">LIS3_IRQ1_CLICK</span><span class="p">)</span>
		<span class="n">lis302dl_interrupt_handle_click</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">irq_cfg</span> <span class="o">==</span> <span class="n">LIS3_IRQ1_DATA_READY</span><span class="p">))</span>
		<span class="n">lis302dl_data_ready</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">IRQ_LINE0</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">lis3lv02d_joystick_poll</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">lis302dl_interrupt_thread2_8b</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">irq_cfg</span> <span class="o">=</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">irq_cfg</span> <span class="o">&amp;</span> <span class="n">LIS3_IRQ2_MASK</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">irq_cfg</span> <span class="o">==</span> <span class="n">LIS3_IRQ2_CLICK</span><span class="p">)</span>
		<span class="n">lis302dl_interrupt_handle_click</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">irq_cfg</span> <span class="o">==</span> <span class="n">LIS3_IRQ2_DATA_READY</span><span class="p">))</span>
		<span class="n">lis302dl_data_ready</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">IRQ_LINE1</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">lis3lv02d_joystick_poll</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lis3lv02d_misc_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">lis3lv02d</span><span class="p">,</span> <span class="n">miscdev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_and_set_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">misc_opened</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span> <span class="cm">/* already open */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">)</span>
		<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">);</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lis3lv02d_misc_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">lis3lv02d</span><span class="p">,</span> <span class="n">miscdev</span><span class="p">);</span>

	<span class="n">fasync_helper</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">async_queue</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">misc_opened</span><span class="p">);</span> <span class="cm">/* release the device */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">)</span>
		<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">lis3lv02d_misc_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">pos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">lis3lv02d</span><span class="p">,</span> <span class="n">miscdev</span><span class="p">);</span>

	<span class="n">DECLARE_WAITQUEUE</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span> <span class="n">current</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">byte_data</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>
		<span class="n">data</span> <span class="o">=</span> <span class="n">atomic_xchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">schedule</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">data</span> <span class="o">&lt;</span> <span class="mi">255</span><span class="p">)</span>
		<span class="n">byte_data</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">byte_data</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>

	<span class="cm">/* make sure we are not going into copy_to_user() with</span>
<span class="cm">	 * TASK_INTERRUPTIBLE state */</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">byte_data</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">byte_data</span><span class="p">)))</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">__set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">lis3lv02d_misc_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span><span class="n">wait</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">lis3lv02d</span><span class="p">,</span> <span class="n">miscdev</span><span class="p">);</span>

	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">misc_wait</span><span class="p">,</span> <span class="n">wait</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">lis3lv02d_misc_fasync</span><span class="p">(</span><span class="kt">int</span> <span class="n">fd</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">int</span> <span class="n">on</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span>
					      <span class="k">struct</span> <span class="n">lis3lv02d</span><span class="p">,</span> <span class="n">miscdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">fasync_helper</span><span class="p">(</span><span class="n">fd</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="n">on</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">async_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">lis3lv02d_misc_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>   <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>  <span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>    <span class="o">=</span> <span class="n">lis3lv02d_misc_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>    <span class="o">=</span> <span class="n">lis3lv02d_misc_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">lis3lv02d_misc_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>    <span class="o">=</span> <span class="n">lis3lv02d_misc_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">fasync</span>  <span class="o">=</span> <span class="n">lis3lv02d_misc_fasync</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span> <span class="nf">lis3lv02d_joystick_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">fuzz</span><span class="p">,</span> <span class="n">flat</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">btns</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="n">BTN_X</span><span class="p">,</span> <span class="n">BTN_Y</span><span class="p">,</span> <span class="n">BTN_Z</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="n">input_allocate_polled_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">=</span> <span class="n">lis3lv02d_joystick_poll</span><span class="p">;</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">open</span> <span class="o">=</span> <span class="n">lis3lv02d_joystick_open</span><span class="p">;</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">close</span> <span class="o">=</span> <span class="n">lis3lv02d_joystick_close</span><span class="p">;</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">poll_interval</span> <span class="o">=</span> <span class="n">MDPS_POLL_INTERVAL</span><span class="p">;</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">poll_interval_min</span> <span class="o">=</span> <span class="n">MDPS_POLL_MIN</span><span class="p">;</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">poll_interval_max</span> <span class="o">=</span> <span class="n">MDPS_POLL_MAX</span><span class="p">;</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">private</span> <span class="o">=</span> <span class="n">lis3</span><span class="p">;</span>
	<span class="n">input_dev</span> <span class="o">=</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span>       <span class="o">=</span> <span class="s">&quot;ST LIS3LV02DL Accelerometer&quot;</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span>       <span class="o">=</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;/input0&quot;</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_HOST</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>

	<span class="n">set_bit</span><span class="p">(</span><span class="n">EV_ABS</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">);</span>
	<span class="n">max_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mdps_max_val</span> <span class="o">*</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">)</span> <span class="o">/</span> <span class="n">LIS3_ACCURACY</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">whoami</span> <span class="o">==</span> <span class="n">WAI_12B</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fuzz</span> <span class="o">=</span> <span class="n">LIS3_DEFAULT_FUZZ_12B</span><span class="p">;</span>
		<span class="n">flat</span> <span class="o">=</span> <span class="n">LIS3_DEFAULT_FLAT_12B</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">fuzz</span> <span class="o">=</span> <span class="n">LIS3_DEFAULT_FUZZ_8B</span><span class="p">;</span>
		<span class="n">flat</span> <span class="o">=</span> <span class="n">LIS3_DEFAULT_FLAT_8B</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fuzz</span> <span class="o">=</span> <span class="p">(</span><span class="n">fuzz</span> <span class="o">*</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">)</span> <span class="o">/</span> <span class="n">LIS3_ACCURACY</span><span class="p">;</span>
	<span class="n">flat</span> <span class="o">=</span> <span class="p">(</span><span class="n">flat</span> <span class="o">*</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">)</span> <span class="o">/</span> <span class="n">LIS3_ACCURACY</span><span class="p">;</span>

	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_X</span><span class="p">,</span> <span class="o">-</span><span class="n">max_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">fuzz</span><span class="p">,</span> <span class="n">flat</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_Y</span><span class="p">,</span> <span class="o">-</span><span class="n">max_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">fuzz</span><span class="p">,</span> <span class="n">flat</span><span class="p">);</span>
	<span class="n">input_set_abs_params</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">ABS_Z</span><span class="p">,</span> <span class="o">-</span><span class="n">max_val</span><span class="p">,</span> <span class="n">max_val</span><span class="p">,</span> <span class="n">fuzz</span><span class="p">,</span> <span class="n">flat</span><span class="p">);</span>

	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mapped_btns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">lis3lv02d_get_axis</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">x</span><span class="p">),</span> <span class="n">btns</span><span class="p">);</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mapped_btns</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">lis3lv02d_get_axis</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">y</span><span class="p">),</span> <span class="n">btns</span><span class="p">);</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mapped_btns</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">lis3lv02d_get_axis</span><span class="p">(</span><span class="n">abs</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">ac</span><span class="p">.</span><span class="n">z</span><span class="p">),</span> <span class="n">btns</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_polled_device</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_free_polled_device</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lis3lv02d_joystick_enable</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">lis3lv02d_joystick_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">lis3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq2</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">irq2</span><span class="p">,</span> <span class="n">lis3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">misc_deregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">miscdev</span><span class="p">);</span>
	<span class="n">input_unregister_polled_device</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
	<span class="n">input_free_polled_device</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">);</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lis3lv02d_joystick_disable</span><span class="p">);</span>

<span class="cm">/* Sysfs stuff */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">lis3lv02d_sysfs_poweron</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * SYSFS functions are fast visitors so put-call</span>
<span class="cm">	 * immediately after the get-call. However, keep</span>
<span class="cm">	 * chip running for a while and schedule delayed</span>
<span class="cm">	 * suspend. This way periodic sysfs calls doesn&#39;t</span>
<span class="cm">	 * suffer from relatively long power up time.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">);</span>
		<span class="n">pm_runtime_put_noidle</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">);</span>
		<span class="n">pm_schedule_suspend</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">,</span> <span class="n">LIS3_SYSFS_POWERDOWN_DELAY</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">lis3lv02d_selftest_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">s16</span> <span class="n">values</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>

	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">ok</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;OK&quot;</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">fail</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;FAIL&quot;</span><span class="p">;</span>
	<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">irq</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;FAIL_IRQ&quot;</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>

	<span class="n">lis3lv02d_sysfs_poweron</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">lis3lv02d_selftest</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">values</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">SELFTEST_FAIL</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">fail</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SELFTEST_IRQ</span>:
		<span class="n">res</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">SELFTEST_OK</span>:
	<span class="nl">default:</span>
		<span class="n">res</span> <span class="o">=</span> <span class="n">ok</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s %d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span>
		<span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">values</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">lis3lv02d_position_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">;</span>

	<span class="n">lis3lv02d_sysfs_poweron</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">lis3lv02d_get_xyz</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">y</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">z</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;(%d,%d,%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">lis3lv02d_rate_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">lis3lv02d_sysfs_poweron</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lis3lv02d_get_odr</span><span class="p">(</span><span class="n">lis3</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">lis3lv02d_rate_set</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				<span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rate</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">lis3lv02d_sysfs_poweron</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3lv02d_set_odr</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">rate</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">selftest</span><span class="p">,</span> <span class="n">S_IRUSR</span><span class="p">,</span> <span class="n">lis3lv02d_selftest_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">position</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">lis3lv02d_position_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">rate</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">lis3lv02d_rate_show</span><span class="p">,</span>
					    <span class="n">lis3lv02d_rate_set</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">lis3lv02d_attributes</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_selftest</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_position</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_rate</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">lis3lv02d_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">lis3lv02d_attributes</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">lis3lv02d_add_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">platform_device_register_simple</span><span class="p">(</span><span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">lis3</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lis3lv02d_attribute_group</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">lis3lv02d_remove_fs</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">lis3lv02d_attribute_group</span><span class="p">);</span>
	<span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Barrier after the sysfs remove */</span>
		<span class="n">pm_runtime_barrier</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">);</span>

		<span class="cm">/* SYSFS may have left chip running. Turn off if necessary */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm_runtime_suspended</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">))</span>
			<span class="n">lis3lv02d_poweroff</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>

		<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">);</span>
		<span class="n">pm_runtime_set_suspended</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">reg_cache</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lis3lv02d_remove_fs</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">lis3lv02d_8b_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">lis3lv02d_platform_data</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ctrl2</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">hipass_ctrl</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">click_flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CLICK_CFG</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">click_flags</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CLICK_TIMELIMIT</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">click_time_limit</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CLICK_LATENCY</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">click_latency</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CLICK_WINDOW</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">click_window</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CLICK_THSZ</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">click_thresh_z</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CLICK_THSY_X</span><span class="p">,</span>
			<span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">click_thresh_x</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">click_thresh_y</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span> <span class="o">=</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">idev</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">;</span>
			<span class="n">input_set_capability</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">BTN_X</span><span class="p">);</span>
			<span class="n">input_set_capability</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">BTN_Y</span><span class="p">);</span>
			<span class="n">input_set_capability</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">EV_KEY</span><span class="p">,</span> <span class="n">BTN_Z</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">wakeup_flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">FF_WU_CFG_1</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">wakeup_flags</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">FF_WU_THS_1</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">wakeup_thresh</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
		<span class="cm">/* pdata value + 1 to keep this backward compatible*/</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">FF_WU_DURATION_1</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">duration1</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ctrl2</span> <span class="o">^=</span> <span class="n">HP_FF_WU1</span><span class="p">;</span> <span class="cm">/* Xor to keep compatible with old pdata*/</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">wakeup_flags2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">FF_WU_CFG_2</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">wakeup_flags2</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">FF_WU_THS_2</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">wakeup_thresh2</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">);</span>
		<span class="cm">/* pdata value + 1 to keep this backward compatible*/</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">FF_WU_DURATION_2</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">duration2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="n">ctrl2</span> <span class="o">^=</span> <span class="n">HP_FF_WU2</span><span class="p">;</span> <span class="cm">/* Xor to keep compatible with old pdata*/</span>
	<span class="p">}</span>
	<span class="cm">/* Configure hipass filters */</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CTRL_REG2</span><span class="p">,</span> <span class="n">ctrl2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq2</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq2</span><span class="p">,</span>
					<span class="nb">NULL</span><span class="p">,</span>
					<span class="n">lis302dl_interrupt_thread2_8b</span><span class="p">,</span>
					<span class="n">IRQF_TRIGGER_RISING</span> <span class="o">|</span> <span class="n">IRQF_ONESHOT</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq_flags2</span> <span class="o">&amp;</span> <span class="n">IRQF_TRIGGER_MASK</span><span class="p">),</span>
					<span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">lis3</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;No second IRQ. Limited functionality</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Initialise the accelerometer and the various subsystems.</span>
<span class="cm"> * Should be rather independent of the bus system.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">lis3lv02d_init_device</span><span class="p">(</span><span class="k">struct</span> <span class="n">lis3lv02d</span> <span class="o">*</span><span class="n">lis3</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="n">irq_handler_t</span> <span class="n">thread_fn</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">irq_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">whoami</span> <span class="o">=</span> <span class="n">lis3lv02d_read_8</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">WHO_AM_I</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">whoami</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WAI_12B</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;12 bits sensor found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read_data</span> <span class="o">=</span> <span class="n">lis3lv02d_read_12</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mdps_max_val</span> <span class="o">=</span> <span class="mi">2048</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pwron_delay</span> <span class="o">=</span> <span class="n">LIS3_PWRON_DELAY_WAI_12B</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">odrs</span> <span class="o">=</span> <span class="n">lis3_12_rates</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">odr_mask</span> <span class="o">=</span> <span class="n">CTRL1_DF0</span> <span class="o">|</span> <span class="n">CTRL1_DF1</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">scale</span> <span class="o">=</span> <span class="n">LIS3_SENSITIVITY_12B</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">lis3_wai12_regs</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">regs_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lis3_wai12_regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WAI_8B</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;8 bits sensor found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read_data</span> <span class="o">=</span> <span class="n">lis3lv02d_read_8</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mdps_max_val</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pwron_delay</span> <span class="o">=</span> <span class="n">LIS3_PWRON_DELAY_WAI_8B</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">odrs</span> <span class="o">=</span> <span class="n">lis3_8_rates</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">odr_mask</span> <span class="o">=</span> <span class="n">CTRL1_DR</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">scale</span> <span class="o">=</span> <span class="n">LIS3_SENSITIVITY_8B</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">regs</span> <span class="o">=</span> <span class="n">lis3_wai8_regs</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">regs_size</span> <span class="o">=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lis3_wai8_regs</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WAI_3DC</span>:
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;8 bits 3DC sensor found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">read_data</span> <span class="o">=</span> <span class="n">lis3lv02d_read_8</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mdps_max_val</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pwron_delay</span> <span class="o">=</span> <span class="n">LIS3_PWRON_DELAY_WAI_8B</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">odrs</span> <span class="o">=</span> <span class="n">lis3_3dc_rates</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">odr_mask</span> <span class="o">=</span> <span class="n">CTRL1_ODR0</span><span class="o">|</span><span class="n">CTRL1_ODR1</span><span class="o">|</span><span class="n">CTRL1_ODR2</span><span class="o">|</span><span class="n">CTRL1_ODR3</span><span class="p">;</span>
		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">scale</span> <span class="o">=</span> <span class="n">LIS3_SENSITIVITY_8B</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;unknown sensor type 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">whoami</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">reg_cache</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">max</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">lis3_wai8_regs</span><span class="p">),</span>
				     <span class="k">sizeof</span><span class="p">(</span><span class="n">lis3_wai12_regs</span><span class="p">)),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">reg_cache</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="n">DRIVER_NAME</span> <span class="s">&quot;out of memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">wake_thread</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">lis3lv02d_add_fs</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">lis3lv02d_poweron</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">lis3lv02d_remove_fs</span><span class="p">(</span><span class="n">lis3</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_runtime_set_active</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">);</span>
		<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pm_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">lis3lv02d_joystick_enable</span><span class="p">(</span><span class="n">lis3</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;joystick initialization failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* passing in platform specific data is purely optional and only</span>
<span class="cm">	 * used by the SPI transport layer at the moment */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">lis3lv02d_platform_data</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">whoami</span> <span class="o">==</span> <span class="n">WAI_8B</span><span class="p">)</span>
			<span class="n">lis3lv02d_8b_configure</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

		<span class="n">irq_flags</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq_flags1</span> <span class="o">&amp;</span> <span class="n">IRQF_TRIGGER_MASK</span><span class="p">;</span>

		<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">irq_cfg</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq_cfg</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">irq_cfg</span><span class="p">)</span>
			<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">write</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">CTRL_REG3</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">irq_cfg</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">default_rate</span><span class="p">)</span>
			<span class="n">lis3lv02d_set_odr</span><span class="p">(</span><span class="n">lis3</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">default_rate</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* bail if we did not get an IRQ from the bus layer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;No IRQ. Disabling /dev/freefall</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * The sensor can generate interrupts for free-fall and direction</span>
<span class="cm">	 * detection (distinguishable with FF_WU_SRC and DD_SRC) but to keep</span>
<span class="cm">	 * the things simple and _fast_ we activate it only for free-fall, so</span>
<span class="cm">	 * no need to read register (very slow with ACPI). For the same reason,</span>
<span class="cm">	 * we forbid shared interrupts.</span>
<span class="cm">	 *</span>
<span class="cm">	 * IRQF_TRIGGER_RISING seems pointless on HP laptops because the</span>
<span class="cm">	 * io-apic is not configurable (and generates a warning) but I keep it</span>
<span class="cm">	 * in case of support for other hardware.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">pdata</span> <span class="o">&amp;&amp;</span> <span class="n">lis3</span><span class="o">-&gt;</span><span class="n">whoami</span> <span class="o">==</span> <span class="n">WAI_8B</span><span class="p">)</span>
		<span class="n">thread_fn</span> <span class="o">=</span> <span class="n">lis302dl_interrupt_thread1_8b</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">thread_fn</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">lis302dl_interrupt</span><span class="p">,</span>
				<span class="n">thread_fn</span><span class="p">,</span>
				<span class="n">IRQF_TRIGGER_RISING</span> <span class="o">|</span> <span class="n">IRQF_ONESHOT</span> <span class="o">|</span>
				<span class="n">irq_flags</span><span class="p">,</span>
				<span class="n">DRIVER_NAME</span><span class="p">,</span> <span class="n">lis3</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Cannot get IRQ</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">miscdev</span><span class="p">.</span><span class="n">minor</span>	<span class="o">=</span> <span class="n">MISC_DYNAMIC_MINOR</span><span class="p">;</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">miscdev</span><span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;freefall&quot;</span><span class="p">;</span>
	<span class="n">lis3</span><span class="o">-&gt;</span><span class="n">miscdev</span><span class="p">.</span><span class="n">fops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">lis3lv02d_misc_fops</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">misc_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lis3</span><span class="o">-&gt;</span><span class="n">miscdev</span><span class="p">))</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;misc_register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">lis3lv02d_init_device</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;ST LIS3LV02Dx three-axis digital accelerometer driver&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Yan Burman, Eric Piel, Pavel Machek&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
