<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › misc › sgi-xp › xpc_uv.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>xpc_uv.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2008-2009 Silicon Graphics, Inc.  All Rights Reserved.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Cross Partition Communication (XPC) uv-based functions.</span>
<span class="cm"> *</span>
<span class="cm"> *     Architecture specific implementation of common functions.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/uv/uv_hub.h&gt;</span>
<span class="cp">#if defined CONFIG_X86_64</span>
<span class="cp">#include &lt;asm/uv/bios.h&gt;</span>
<span class="cp">#include &lt;asm/uv/uv_irq.h&gt;</span>
<span class="cp">#elif defined CONFIG_IA64_GENERIC || defined CONFIG_IA64_SGI_UV</span>
<span class="cp">#include &lt;asm/sn/intr.h&gt;</span>
<span class="cp">#include &lt;asm/sn/sn_sal.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &quot;../sgi-gru/gru.h&quot;</span>
<span class="cp">#include &quot;../sgi-gru/grukservices.h&quot;</span>
<span class="cp">#include &quot;xpc.h&quot;</span>

<span class="cp">#if defined CONFIG_IA64_GENERIC || defined CONFIG_IA64_SGI_UV</span>
<span class="k">struct</span> <span class="n">uv_IO_APIC_route_entry</span> <span class="p">{</span>
	<span class="n">__u64</span>	<span class="n">vector</span>		<span class="o">:</span>  <span class="mi">8</span><span class="p">,</span>
		<span class="n">delivery_mode</span>	<span class="o">:</span>  <span class="mi">3</span><span class="p">,</span>
		<span class="n">dest_mode</span>	<span class="o">:</span>  <span class="mi">1</span><span class="p">,</span>
		<span class="n">delivery_status</span>	<span class="o">:</span>  <span class="mi">1</span><span class="p">,</span>
		<span class="n">polarity</span>	<span class="o">:</span>  <span class="mi">1</span><span class="p">,</span>
		<span class="n">__reserved_1</span>	<span class="o">:</span>  <span class="mi">1</span><span class="p">,</span>
		<span class="n">trigger</span>		<span class="o">:</span>  <span class="mi">1</span><span class="p">,</span>
		<span class="n">mask</span>		<span class="o">:</span>  <span class="mi">1</span><span class="p">,</span>
		<span class="n">__reserved_2</span>	<span class="o">:</span> <span class="mi">15</span><span class="p">,</span>
		<span class="n">dest</span>		<span class="o">:</span> <span class="mi">32</span><span class="p">;</span>
<span class="p">};</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xpc_heartbeat_uv</span> <span class="o">*</span><span class="n">xpc_heartbeat_uv</span><span class="p">;</span>

<span class="cp">#define XPC_ACTIVATE_MSG_SIZE_UV	(1 * GRU_CACHE_LINE_BYTES)</span>
<span class="cp">#define XPC_ACTIVATE_MQ_SIZE_UV		(4 * XP_MAX_NPARTITIONS_UV * \</span>
<span class="cp">					 XPC_ACTIVATE_MSG_SIZE_UV)</span>
<span class="cp">#define XPC_ACTIVATE_IRQ_NAME		&quot;xpc_activate&quot;</span>

<span class="cp">#define XPC_NOTIFY_MSG_SIZE_UV		(2 * GRU_CACHE_LINE_BYTES)</span>
<span class="cp">#define XPC_NOTIFY_MQ_SIZE_UV		(4 * XP_MAX_NPARTITIONS_UV * \</span>
<span class="cp">					 XPC_NOTIFY_MSG_SIZE_UV)</span>
<span class="cp">#define XPC_NOTIFY_IRQ_NAME		&quot;xpc_notify&quot;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xpc_gru_mq_uv</span> <span class="o">*</span><span class="n">xpc_activate_mq_uv</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">xpc_gru_mq_uv</span> <span class="o">*</span><span class="n">xpc_notify_mq_uv</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_setup_partitions_uv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">partid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_partition_uv</span> <span class="o">*</span><span class="n">part_uv</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">partid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">partid</span> <span class="o">&lt;</span> <span class="n">XP_MAX_NPARTITIONS_UV</span><span class="p">;</span> <span class="n">partid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">part_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>

		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">cached_activate_gru_mq_desc_mutex</span><span class="p">);</span>
		<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags_lock</span><span class="p">);</span>
		<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">remote_act_state</span> <span class="o">=</span> <span class="n">XPC_P_AS_INACTIVE</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_teardown_partitions_uv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">partid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_partition_uv</span> <span class="o">*</span><span class="n">part_uv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">partid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">partid</span> <span class="o">&lt;</span> <span class="n">XP_MAX_NPARTITIONS_UV</span><span class="p">;</span> <span class="n">partid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">part_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">cached_activate_gru_mq_desc</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">cached_activate_gru_mq_desc_mutex</span><span class="p">);</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
			<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XPC_P_CACHED_ACTIVATE_GRU_MQ_DESC_UV</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">cached_activate_gru_mq_desc</span><span class="p">);</span>
			<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">cached_activate_gru_mq_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span>
				     <span class="n">cached_activate_gru_mq_desc_mutex</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_get_gru_mq_irq_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_gru_mq_uv</span> <span class="o">*</span><span class="n">mq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">irq_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">mmr_pnode</span> <span class="o">=</span> <span class="n">uv_blade_to_pnode</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_blade</span><span class="p">);</span>

<span class="cp">#if defined CONFIG_X86_64</span>
	<span class="n">mq</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">uv_setup_irq</span><span class="p">(</span><span class="n">irq_name</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_blade</span><span class="p">,</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_offset</span><span class="p">,</span>
			<span class="n">UV_AFFINITY_CPU</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;uv_setup_irq() returned error=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="o">-</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_value</span> <span class="o">=</span> <span class="n">uv_read_global_mmr64</span><span class="p">(</span><span class="n">mmr_pnode</span><span class="p">,</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_offset</span><span class="p">);</span>

<span class="cp">#elif defined CONFIG_IA64_GENERIC || defined CONFIG_IA64_SGI_UV</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">irq_name</span><span class="p">,</span> <span class="n">XPC_ACTIVATE_IRQ_NAME</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mq</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">SGI_XPC_ACTIVATE</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">irq_name</span><span class="p">,</span> <span class="n">XPC_NOTIFY_IRQ_NAME</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">mq</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">SGI_XPC_NOTIFY</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_value</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">cpu_physical_id</span><span class="p">(</span><span class="n">cpu</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">32</span> <span class="o">|</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
	<span class="n">uv_write_global_mmr64</span><span class="p">(</span><span class="n">mmr_pnode</span><span class="p">,</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_offset</span><span class="p">,</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_value</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="cp">#error not a supported configuration</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_release_gru_mq_irq_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_gru_mq_uv</span> <span class="o">*</span><span class="n">mq</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#if defined CONFIG_X86_64</span>
	<span class="n">uv_teardown_irq</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

<span class="cp">#elif defined CONFIG_IA64_GENERIC || defined CONFIG_IA64_SGI_UV</span>
	<span class="kt">int</span> <span class="n">mmr_pnode</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mmr_value</span><span class="p">;</span>

	<span class="n">mmr_pnode</span> <span class="o">=</span> <span class="n">uv_blade_to_pnode</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_blade</span><span class="p">);</span>
	<span class="n">mmr_value</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">uv_write_global_mmr64</span><span class="p">(</span><span class="n">mmr_pnode</span><span class="p">,</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_offset</span><span class="p">,</span> <span class="n">mmr_value</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="cp">#error not a supported configuration</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_gru_mq_watchlist_alloc_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_gru_mq_uv</span> <span class="o">*</span><span class="n">mq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

<span class="cp">#if defined CONFIG_IA64_GENERIC || defined CONFIG_IA64_SGI_UV</span>
	<span class="kt">int</span> <span class="n">mmr_pnode</span> <span class="o">=</span> <span class="n">uv_blade_to_pnode</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_blade</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sn_mq_watchlist_alloc</span><span class="p">(</span><span class="n">mmr_pnode</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">uv_gpa</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">),</span>
				    <span class="n">mq</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;sn_mq_watchlist_alloc() failed, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#elif defined CONFIG_X86_64</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uv_bios_mq_watchlist_alloc</span><span class="p">(</span><span class="n">uv_gpa</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">),</span>
					 <span class="n">mq</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_offset</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;uv_bios_mq_watchlist_alloc() failed, &quot;</span>
			<span class="s">&quot;ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
<span class="cp">#else</span>
	<span class="cp">#error not a supported configuration</span>
<span class="cp">#endif</span>

	<span class="n">mq</span><span class="o">-&gt;</span><span class="n">watchlist_num</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_gru_mq_watchlist_free_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_gru_mq_uv</span> <span class="o">*</span><span class="n">mq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mmr_pnode</span> <span class="o">=</span> <span class="n">uv_blade_to_pnode</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_blade</span><span class="p">);</span>

<span class="cp">#if defined CONFIG_X86_64</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">uv_bios_mq_watchlist_free</span><span class="p">(</span><span class="n">mmr_pnode</span><span class="p">,</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">watchlist_num</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">BIOS_STATUS_SUCCESS</span><span class="p">);</span>
<span class="cp">#elif defined CONFIG_IA64_GENERIC || defined CONFIG_IA64_SGI_UV</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sn_mq_watchlist_free</span><span class="p">(</span><span class="n">mmr_pnode</span><span class="p">,</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">watchlist_num</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">SALRET_OK</span><span class="p">);</span>
<span class="cp">#else</span>
	<span class="cp">#error not a supported configuration</span>
<span class="cp">#endif</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xpc_gru_mq_uv</span> <span class="o">*</span>
<span class="nf">xpc_create_gru_mq_uv</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mq_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">cpu</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">irq_name</span><span class="p">,</span>
		     <span class="n">irq_handler_t</span> <span class="n">irq_handler</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">xp_ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nasid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pg_order</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">page</span> <span class="o">*</span><span class="n">page</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_gru_mq_uv</span> <span class="o">*</span><span class="n">mq</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">uv_IO_APIC_route_entry</span> <span class="o">*</span><span class="n">mmr_value</span><span class="p">;</span>

	<span class="n">mq</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_gru_mq_uv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mq</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;xpc_create_gru_mq_uv() failed to kmalloc() &quot;</span>
			<span class="s">&quot;a xpc_gru_mq_uv structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mq</span><span class="o">-&gt;</span><span class="n">gru_mq_desc</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gru_message_queue_desc</span><span class="p">),</span>
				  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">gru_mq_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;xpc_create_gru_mq_uv() failed to kmalloc() &quot;</span>
			<span class="s">&quot;a gru_message_queue_desc structure</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pg_order</span> <span class="o">=</span> <span class="n">get_order</span><span class="p">(</span><span class="n">mq_size</span><span class="p">);</span>
	<span class="n">mq</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">=</span> <span class="n">pg_order</span> <span class="o">+</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">mq_size</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">;</span>

	<span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_blade</span> <span class="o">=</span> <span class="n">uv_cpu_to_blade_id</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>

	<span class="n">nid</span> <span class="o">=</span> <span class="n">cpu_to_node</span><span class="p">(</span><span class="n">cpu</span><span class="p">);</span>
	<span class="n">page</span> <span class="o">=</span> <span class="n">alloc_pages_exact_node</span><span class="p">(</span><span class="n">nid</span><span class="p">,</span> <span class="n">GFP_KERNEL</span> <span class="o">|</span> <span class="n">__GFP_ZERO</span> <span class="o">|</span> <span class="n">GFP_THISNODE</span><span class="p">,</span>
				<span class="n">pg_order</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;xpc_create_gru_mq_uv() failed to alloc %d &quot;</span>
			<span class="s">&quot;bytes of memory on nid=%d for GRU mq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mq_size</span><span class="p">,</span> <span class="n">nid</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_2</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">mq</span><span class="o">-&gt;</span><span class="n">address</span> <span class="o">=</span> <span class="n">page_address</span><span class="p">(</span><span class="n">page</span><span class="p">);</span>

	<span class="cm">/* enable generation of irq when GRU mq operation occurs to this mq */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_gru_mq_watchlist_alloc_uv</span><span class="p">(</span><span class="n">mq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_3</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_get_gru_mq_irq_uv</span><span class="p">(</span><span class="n">mq</span><span class="p">,</span> <span class="n">cpu</span><span class="p">,</span> <span class="n">irq_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_4</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">irq_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">irq_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;request_irq(irq=%d) returned error=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">mq</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="o">-</span><span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out_5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">nasid</span> <span class="o">=</span> <span class="n">UV_PNODE_TO_NASID</span><span class="p">(</span><span class="n">uv_cpu_to_pnode</span><span class="p">(</span><span class="n">cpu</span><span class="p">));</span>

	<span class="n">mmr_value</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">uv_IO_APIC_route_entry</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">mmr_value</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">gru_create_message_queue</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">gru_mq_desc</span><span class="p">,</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">mq_size</span><span class="p">,</span>
				     <span class="n">nasid</span><span class="p">,</span> <span class="n">mmr_value</span><span class="o">-&gt;</span><span class="n">vector</span><span class="p">,</span> <span class="n">mmr_value</span><span class="o">-&gt;</span><span class="n">dest</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;gru_create_message_queue() returned &quot;</span>
			<span class="s">&quot;error=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_6</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allow other partitions to access this GRU mq */</span>
	<span class="n">xp_ret</span> <span class="o">=</span> <span class="n">xp_expand_memprotect</span><span class="p">(</span><span class="n">xp_pa</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">),</span> <span class="n">mq_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xp_ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_6</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">mq</span><span class="p">;</span>

	<span class="cm">/* something went wrong */</span>
<span class="nl">out_6:</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="nl">out_5:</span>
	<span class="n">xpc_release_gru_mq_irq_uv</span><span class="p">(</span><span class="n">mq</span><span class="p">);</span>
<span class="nl">out_4:</span>
	<span class="n">xpc_gru_mq_watchlist_free_uv</span><span class="p">(</span><span class="n">mq</span><span class="p">);</span>
<span class="nl">out_3:</span>
	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">pg_order</span><span class="p">);</span>
<span class="nl">out_2:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">gru_mq_desc</span><span class="p">);</span>
<span class="nl">out_1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">mq</span><span class="p">);</span>
<span class="nl">out_0:</span>
	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_destroy_gru_mq_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_gru_mq_uv</span> <span class="o">*</span><span class="n">mq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mq_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pg_order</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* disallow other partitions to access GRU mq */</span>
	<span class="n">mq_size</span> <span class="o">=</span> <span class="mi">1UL</span> <span class="o">&lt;&lt;</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">order</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">xp_restrict_memprotect</span><span class="p">(</span><span class="n">xp_pa</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">),</span> <span class="n">mq_size</span><span class="p">);</span>
	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">);</span>

	<span class="cm">/* unregister irq handler and release mq irq/vector mapping */</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">xpc_release_gru_mq_irq_uv</span><span class="p">(</span><span class="n">mq</span><span class="p">);</span>

	<span class="cm">/* disable generation of irq when GRU mq op occurs to this mq */</span>
	<span class="n">xpc_gru_mq_watchlist_free_uv</span><span class="p">(</span><span class="n">mq</span><span class="p">);</span>

	<span class="n">pg_order</span> <span class="o">=</span> <span class="n">mq</span><span class="o">-&gt;</span><span class="n">order</span> <span class="o">-</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="n">free_pages</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">mq</span><span class="o">-&gt;</span><span class="n">address</span><span class="p">,</span> <span class="n">pg_order</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">mq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_send_gru_msg</span><span class="p">(</span><span class="k">struct</span> <span class="n">gru_message_queue_desc</span> <span class="o">*</span><span class="n">gru_mq_desc</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
		 <span class="kt">size_t</span> <span class="n">msg_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">xp_ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gru_send_message_gpa</span><span class="p">(</span><span class="n">gru_mq_desc</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msg_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">MQE_OK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xp_ret</span> <span class="o">=</span> <span class="n">xpSuccess</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">MQE_QUEUE_FULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;gru_send_message_gpa() returned &quot;</span>
				<span class="s">&quot;error=MQE_QUEUE_FULL</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* !!! handle QLimit reached; delay &amp; try again */</span>
			<span class="cm">/* ??? Do we add a limit to the number of retries? */</span>
			<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">MQE_CONGESTION</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;gru_send_message_gpa() returned &quot;</span>
				<span class="s">&quot;error=MQE_CONGESTION</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* !!! handle LB Overflow; simply try again */</span>
			<span class="cm">/* ??? Do we add a limit to the number of retries? */</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* !!! Currently this is MQE_UNEXPECTED_CB_ERR */</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;gru_send_message_gpa() returned &quot;</span>
				<span class="s">&quot;error=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">xp_ret</span> <span class="o">=</span> <span class="n">xpGruSendMqError</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">xp_ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_process_activate_IRQ_rcvd_uv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">partid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">act_state_req</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">xpc_activate_IRQ_rcvd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">partid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">partid</span> <span class="o">&lt;</span> <span class="n">XP_MAX_NPARTITIONS_UV</span><span class="p">;</span> <span class="n">partid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">act_state_req</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">xpc_activate_IRQ_rcvd</span><span class="o">--</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">xpc_activate_IRQ_rcvd</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">act_state_req</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">act_state_req</span><span class="p">;</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">act_state_req</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">act_state_req</span> <span class="o">==</span> <span class="n">XPC_P_ASR_ACTIVATE_UV</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">==</span> <span class="n">XPC_P_AS_INACTIVE</span><span class="p">)</span>
				<span class="n">xpc_activate_partition</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">==</span> <span class="n">XPC_P_AS_DEACTIVATING</span><span class="p">)</span>
				<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">xpReactivating</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">act_state_req</span> <span class="o">==</span> <span class="n">XPC_P_ASR_REACTIVATE_UV</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">==</span> <span class="n">XPC_P_AS_INACTIVE</span><span class="p">)</span>
				<span class="n">xpc_activate_partition</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">xpReactivating</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">act_state_req</span> <span class="o">==</span> <span class="n">XPC_P_ASR_DEACTIVATE_UV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">reason</span><span class="p">);</span>

		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">BUG</span><span class="p">();</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xpc_activate_IRQ_rcvd</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_handle_activate_mq_msg_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">xpc_activate_mq_msghdr_uv</span> <span class="o">*</span><span class="n">msg_hdr</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="n">part_setup</span><span class="p">,</span>
			      <span class="kt">int</span> <span class="o">*</span><span class="n">wakeup_hb_checker</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_partition_uv</span> <span class="o">*</span><span class="n">part_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_openclose_args</span> <span class="o">*</span><span class="n">args</span><span class="p">;</span>

	<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">remote_act_state</span> <span class="o">=</span> <span class="n">msg_hdr</span><span class="o">-&gt;</span><span class="n">act_state</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg_hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">XPC_ACTIVATE_MQ_MSG_SYNC_ACT_STATE_UV</span>:
		<span class="cm">/* syncing of remote_act_state was just done above */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">XPC_ACTIVATE_MQ_MSG_ACTIVATE_REQ_UV</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_activate_req_uv</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * ??? Do we deal here with ts_jiffies being different</span>
<span class="cm">		 * ??? if act_state != XPC_P_AS_INACTIVE instead of</span>
<span class="cm">		 * ??? below?</span>
<span class="cm">		 */</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">msg_hdr</span><span class="p">,</span> <span class="k">struct</span>
				   <span class="n">xpc_activate_mq_msg_activate_req_uv</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">act_state_req</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">xpc_activate_IRQ_rcvd</span><span class="o">++</span><span class="p">;</span>
		<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">act_state_req</span> <span class="o">=</span> <span class="n">XPC_P_ASR_ACTIVATE_UV</span><span class="p">;</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_rp_pa</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">rp_gpa</span><span class="p">;</span> <span class="cm">/* !!! _pa is _gpa */</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_rp_ts_jiffies</span> <span class="o">=</span> <span class="n">msg_hdr</span><span class="o">-&gt;</span><span class="n">rp_ts_jiffies</span><span class="p">;</span>
		<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">heartbeat_gpa</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">heartbeat_gpa</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">activate_gru_mq_desc_gpa</span> <span class="o">!=</span>
		    <span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">activate_gru_mq_desc_gpa</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
			<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XPC_P_CACHED_ACTIVATE_GRU_MQ_DESC_UV</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
			<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">activate_gru_mq_desc_gpa</span> <span class="o">=</span>
			    <span class="n">msg</span><span class="o">-&gt;</span><span class="n">activate_gru_mq_desc_gpa</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

		<span class="p">(</span><span class="o">*</span><span class="n">wakeup_hb_checker</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">XPC_ACTIVATE_MQ_MSG_DEACTIVATE_REQ_UV</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_deactivate_req_uv</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

		<span class="n">msg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">msg_hdr</span><span class="p">,</span> <span class="k">struct</span>
				   <span class="n">xpc_activate_mq_msg_deactivate_req_uv</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">act_state_req</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">xpc_activate_IRQ_rcvd</span><span class="o">++</span><span class="p">;</span>
		<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">act_state_req</span> <span class="o">=</span> <span class="n">XPC_P_ASR_DEACTIVATE_UV</span><span class="p">;</span>
		<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

		<span class="p">(</span><span class="o">*</span><span class="n">wakeup_hb_checker</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">XPC_ACTIVATE_MQ_MSG_CHCTL_CLOSEREQUEST_UV</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_chctl_closerequest_uv</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">part_setup</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">msg_hdr</span><span class="p">,</span> <span class="k">struct</span>
				   <span class="n">xpc_activate_mq_msg_chctl_closerequest_uv</span><span class="p">,</span>
				   <span class="n">hdr</span><span class="p">);</span>
		<span class="n">args</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_openclose_args</span><span class="p">[</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">ch_number</span><span class="p">];</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">ch_number</span><span class="p">]</span> <span class="o">|=</span> <span class="n">XPC_CHCTL_CLOSEREQUEST</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

		<span class="n">xpc_wakeup_channel_mgr</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">XPC_ACTIVATE_MQ_MSG_CHCTL_CLOSEREPLY_UV</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_chctl_closereply_uv</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">part_setup</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">msg_hdr</span><span class="p">,</span> <span class="k">struct</span>
				   <span class="n">xpc_activate_mq_msg_chctl_closereply_uv</span><span class="p">,</span>
				   <span class="n">hdr</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">ch_number</span><span class="p">]</span> <span class="o">|=</span> <span class="n">XPC_CHCTL_CLOSEREPLY</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

		<span class="n">xpc_wakeup_channel_mgr</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">XPC_ACTIVATE_MQ_MSG_CHCTL_OPENREQUEST_UV</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_chctl_openrequest_uv</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">part_setup</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">msg_hdr</span><span class="p">,</span> <span class="k">struct</span>
				   <span class="n">xpc_activate_mq_msg_chctl_openrequest_uv</span><span class="p">,</span>
				   <span class="n">hdr</span><span class="p">);</span>
		<span class="n">args</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_openclose_args</span><span class="p">[</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">ch_number</span><span class="p">];</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">local_nentries</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">ch_number</span><span class="p">]</span> <span class="o">|=</span> <span class="n">XPC_CHCTL_OPENREQUEST</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

		<span class="n">xpc_wakeup_channel_mgr</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">XPC_ACTIVATE_MQ_MSG_CHCTL_OPENREPLY_UV</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_chctl_openreply_uv</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">part_setup</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">msg_hdr</span><span class="p">,</span> <span class="k">struct</span>
				   <span class="n">xpc_activate_mq_msg_chctl_openreply_uv</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="n">args</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_openclose_args</span><span class="p">[</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">ch_number</span><span class="p">];</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">remote_nentries</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">local_nentries</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">;</span>
		<span class="n">args</span><span class="o">-&gt;</span><span class="n">local_msgqueue_pa</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">notify_gru_mq_desc_gpa</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">ch_number</span><span class="p">]</span> <span class="o">|=</span> <span class="n">XPC_CHCTL_OPENREPLY</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

		<span class="n">xpc_wakeup_channel_mgr</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">XPC_ACTIVATE_MQ_MSG_CHCTL_OPENCOMPLETE_UV</span>: <span class="p">{</span>
		<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_chctl_opencomplete_uv</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">part_setup</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">msg_hdr</span><span class="p">,</span> <span class="k">struct</span>
				<span class="n">xpc_activate_mq_msg_chctl_opencomplete_uv</span><span class="p">,</span> <span class="n">hdr</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">ch_number</span><span class="p">]</span> <span class="o">|=</span> <span class="n">XPC_CHCTL_OPENCOMPLETE</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

		<span class="n">xpc_wakeup_channel_mgr</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">case</span> <span class="n">XPC_ACTIVATE_MQ_MSG_MARK_ENGAGED_UV</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_P_ENGAGED_UV</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">XPC_ACTIVATE_MQ_MSG_MARK_DISENGAGED_UV</span>:
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XPC_P_ENGAGED_UV</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;received unknown activate_mq msg type=%d &quot;</span>
			<span class="s">&quot;from partition=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_hdr</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">XPC_PARTID</span><span class="p">(</span><span class="n">part</span><span class="p">));</span>

		<span class="cm">/* get hb checker to deactivate from the remote partition */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">act_state_req</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">xpc_activate_IRQ_rcvd</span><span class="o">++</span><span class="p">;</span>
		<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">act_state_req</span> <span class="o">=</span> <span class="n">XPC_P_ASR_DEACTIVATE_UV</span><span class="p">;</span>
		<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">=</span> <span class="n">xpBadMsgType</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

		<span class="p">(</span><span class="o">*</span><span class="n">wakeup_hb_checker</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg_hdr</span><span class="o">-&gt;</span><span class="n">rp_ts_jiffies</span> <span class="o">!=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_rp_ts_jiffies</span> <span class="o">&amp;&amp;</span>
	    <span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_rp_ts_jiffies</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * ??? Does what we do here need to be sensitive to</span>
<span class="cm">		 * ??? act_state or remote_act_state?</span>
<span class="cm">		 */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">act_state_req</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">xpc_activate_IRQ_rcvd</span><span class="o">++</span><span class="p">;</span>
		<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">act_state_req</span> <span class="o">=</span> <span class="n">XPC_P_ASR_REACTIVATE_UV</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

		<span class="p">(</span><span class="o">*</span><span class="n">wakeup_hb_checker</span><span class="p">)</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">xpc_handle_activate_IRQ_uv</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_activate_mq_msghdr_uv</span> <span class="o">*</span><span class="n">msg_hdr</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">partid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">wakeup_hb_checker</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">part_referenced</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg_hdr</span> <span class="o">=</span> <span class="n">gru_get_next_message</span><span class="p">(</span><span class="n">xpc_activate_mq_uv</span><span class="o">-&gt;</span><span class="n">gru_mq_desc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg_hdr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">partid</span> <span class="o">=</span> <span class="n">msg_hdr</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">partid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">partid</span> <span class="o">&gt;=</span> <span class="n">XP_MAX_NPARTITIONS_UV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;xpc_handle_activate_IRQ_uv() &quot;</span>
				<span class="s">&quot;received invalid partid=0x%x in message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">partid</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">];</span>

			<span class="n">part_referenced</span> <span class="o">=</span> <span class="n">xpc_part_ref</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
			<span class="n">xpc_handle_activate_mq_msg_uv</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">msg_hdr</span><span class="p">,</span>
						      <span class="n">part_referenced</span><span class="p">,</span>
						      <span class="o">&amp;</span><span class="n">wakeup_hb_checker</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">part_referenced</span><span class="p">)</span>
				<span class="n">xpc_part_deref</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">gru_free_message</span><span class="p">(</span><span class="n">xpc_activate_mq_uv</span><span class="o">-&gt;</span><span class="n">gru_mq_desc</span><span class="p">,</span> <span class="n">msg_hdr</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wakeup_hb_checker</span><span class="p">)</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_wq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_cache_remote_gru_mq_desc_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">gru_message_queue_desc</span> <span class="o">*</span><span class="n">gru_mq_desc</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gru_mq_desc_gpa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xp_remote_memcpy</span><span class="p">(</span><span class="n">uv_gpa</span><span class="p">(</span><span class="n">gru_mq_desc</span><span class="p">),</span> <span class="n">gru_mq_desc_gpa</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">gru_message_queue_desc</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">xpSuccess</span><span class="p">)</span>
		<span class="n">gru_mq_desc</span><span class="o">-&gt;</span><span class="n">mq</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_send_activate_IRQ_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">msg_size</span><span class="p">,</span>
			 <span class="kt">int</span> <span class="n">msg_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_activate_mq_msghdr_uv</span> <span class="o">*</span><span class="n">msg_hdr</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_partition_uv</span> <span class="o">*</span><span class="n">part_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">gru_message_queue_desc</span> <span class="o">*</span><span class="n">gru_mq_desc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">msg_size</span> <span class="o">&gt;</span> <span class="n">XPC_ACTIVATE_MSG_SIZE_UV</span><span class="p">);</span>

	<span class="n">msg_hdr</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">msg_type</span><span class="p">;</span>
	<span class="n">msg_hdr</span><span class="o">-&gt;</span><span class="n">partid</span> <span class="o">=</span> <span class="n">xp_partition_id</span><span class="p">;</span>
	<span class="n">msg_hdr</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span><span class="p">;</span>
	<span class="n">msg_hdr</span><span class="o">-&gt;</span><span class="n">rp_ts_jiffies</span> <span class="o">=</span> <span class="n">xpc_rsvd_page</span><span class="o">-&gt;</span><span class="n">ts_jiffies</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">cached_activate_gru_mq_desc_mutex</span><span class="p">);</span>
<span class="nl">again:</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_P_CACHED_ACTIVATE_GRU_MQ_DESC_UV</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">gru_mq_desc</span> <span class="o">=</span> <span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">cached_activate_gru_mq_desc</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gru_mq_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">gru_mq_desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span>
					      <span class="n">gru_message_queue_desc</span><span class="p">),</span>
					      <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">gru_mq_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">xpNoMemory</span><span class="p">;</span>
				<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">cached_activate_gru_mq_desc</span> <span class="o">=</span> <span class="n">gru_mq_desc</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_cache_remote_gru_mq_desc_uv</span><span class="p">(</span><span class="n">gru_mq_desc</span><span class="p">,</span>
						      <span class="n">part_uv</span><span class="o">-&gt;</span>
						      <span class="n">activate_gru_mq_desc_gpa</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">done</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_P_CACHED_ACTIVATE_GRU_MQ_DESC_UV</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ??? Is holding a spin_lock (ch-&gt;lock) during this call a bad idea? */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_send_gru_msg</span><span class="p">(</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">cached_activate_gru_mq_desc</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
			       <span class="n">msg_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">smp_rmb</span><span class="p">();</span>	<span class="cm">/* ensure a fresh copy of part_uv-&gt;flags */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_P_CACHED_ACTIVATE_GRU_MQ_DESC_UV</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">done:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">cached_activate_gru_mq_desc_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_activate_IRQ_part_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span>
			      <span class="kt">size_t</span> <span class="n">msg_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msg_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_send_activate_IRQ_uv</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msg_size</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">))</span>
		<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_activate_IRQ_ch_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">,</span>
			 <span class="kt">void</span> <span class="o">*</span><span class="n">msg</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">msg_size</span><span class="p">,</span> <span class="kt">int</span> <span class="n">msg_type</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_send_activate_IRQ_uv</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msg_size</span><span class="p">,</span> <span class="n">msg_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">irq_flags</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">);</span>

		<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">irq_flags</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_local_activate_IRQ_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">int</span> <span class="n">act_state_req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_partition_uv</span> <span class="o">*</span><span class="n">part_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * !!! Make our side think that the remote partition sent an activate</span>
<span class="cm">	 * !!! mq message our way by doing what the activate IRQ handler would</span>
<span class="cm">	 * !!! do had one really been sent.</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">act_state_req</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">xpc_activate_IRQ_rcvd</span><span class="o">++</span><span class="p">;</span>
	<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">act_state_req</span> <span class="o">=</span> <span class="n">act_state_req</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_get_partition_rsvd_page_pa_uv</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">rp_pa</span><span class="p">,</span>
				  <span class="kt">size_t</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s64</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

<span class="cp">#if defined CONFIG_X86_64</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">uv_bios_reserved_page_pa</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">rp_pa</span><span class="p">,</span>
					  <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">BIOS_STATUS_SUCCESS</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpSuccess</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">BIOS_STATUS_MORE_PASSES</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpNeedMoreInfo</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpBiosError</span><span class="p">;</span>

<span class="cp">#elif defined CONFIG_IA64_GENERIC || defined CONFIG_IA64_SGI_UV</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">sn_partition_reserved_page_pa</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span> <span class="n">rp_pa</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SALRET_OK</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpSuccess</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SALRET_MORE_PASSES</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpNeedMoreInfo</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpSalError</span><span class="p">;</span>

<span class="cp">#else</span>
	<span class="cp">#error not a supported configuration</span>
<span class="cp">#endif</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_setup_rsvd_page_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_rsvd_page</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_heartbeat_uv</span> <span class="o">=</span>
	    <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">sn_partition_id</span><span class="p">].</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">cached_heartbeat</span><span class="p">;</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">heartbeat_gpa</span> <span class="o">=</span> <span class="n">uv_gpa</span><span class="p">(</span><span class="n">xpc_heartbeat_uv</span><span class="p">);</span>
	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">activate_gru_mq_desc_gpa</span> <span class="o">=</span>
	    <span class="n">uv_gpa</span><span class="p">(</span><span class="n">xpc_activate_mq_uv</span><span class="o">-&gt;</span><span class="n">gru_mq_desc</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_allow_hb_uv</span><span class="p">(</span><span class="kt">short</span> <span class="n">partid</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_disallow_hb_uv</span><span class="p">(</span><span class="kt">short</span> <span class="n">partid</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_disallow_all_hbs_uv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_increment_heartbeat_uv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_heartbeat_uv</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_offline_heartbeat_uv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_increment_heartbeat_uv</span><span class="p">();</span>
	<span class="n">xpc_heartbeat_uv</span><span class="o">-&gt;</span><span class="n">offline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_online_heartbeat_uv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_increment_heartbeat_uv</span><span class="p">();</span>
	<span class="n">xpc_heartbeat_uv</span><span class="o">-&gt;</span><span class="n">offline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_heartbeat_init_uv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_heartbeat_uv</span><span class="o">-&gt;</span><span class="n">value</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">xpc_heartbeat_uv</span><span class="o">-&gt;</span><span class="n">offline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_heartbeat_exit_uv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_offline_heartbeat_uv</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_get_remote_heartbeat_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition_uv</span> <span class="o">*</span><span class="n">part_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xp_remote_memcpy</span><span class="p">(</span><span class="n">uv_gpa</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">cached_heartbeat</span><span class="p">),</span>
			       <span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">heartbeat_gpa</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_heartbeat_uv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">cached_heartbeat</span><span class="p">.</span><span class="n">value</span> <span class="o">==</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">last_heartbeat</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">cached_heartbeat</span><span class="p">.</span><span class="n">offline</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpNoHeartbeat</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">last_heartbeat</span> <span class="o">=</span> <span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">cached_heartbeat</span><span class="p">.</span><span class="n">value</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_request_partition_activation_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_rsvd_page</span> <span class="o">*</span><span class="n">remote_rp</span><span class="p">,</span>
				    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remote_rp_gpa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nasid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">partid</span> <span class="o">=</span> <span class="n">remote_rp</span><span class="o">-&gt;</span><span class="n">SAL_partid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_activate_req_uv</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_rp_pa</span> <span class="o">=</span> <span class="n">remote_rp_gpa</span><span class="p">;</span> <span class="cm">/* !!! _pa here is really _gpa */</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_rp_ts_jiffies</span> <span class="o">=</span> <span class="n">remote_rp</span><span class="o">-&gt;</span><span class="n">ts_jiffies</span><span class="p">;</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">heartbeat_gpa</span> <span class="o">=</span> <span class="n">remote_rp</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">heartbeat_gpa</span><span class="p">;</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">activate_gru_mq_desc_gpa</span> <span class="o">=</span>
	    <span class="n">remote_rp</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">activate_gru_mq_desc_gpa</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ??? Is it a good idea to make this conditional on what is</span>
<span class="cm">	 * ??? potentially stale state information?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">remote_act_state</span> <span class="o">==</span> <span class="n">XPC_P_AS_INACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msg</span><span class="p">.</span><span class="n">rp_gpa</span> <span class="o">=</span> <span class="n">uv_gpa</span><span class="p">(</span><span class="n">xpc_rsvd_page</span><span class="p">);</span>
		<span class="n">msg</span><span class="p">.</span><span class="n">heartbeat_gpa</span> <span class="o">=</span> <span class="n">xpc_rsvd_page</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">heartbeat_gpa</span><span class="p">;</span>
		<span class="n">msg</span><span class="p">.</span><span class="n">activate_gru_mq_desc_gpa</span> <span class="o">=</span>
		    <span class="n">xpc_rsvd_page</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">activate_gru_mq_desc_gpa</span><span class="p">;</span>
		<span class="n">xpc_send_activate_IRQ_part_uv</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
					   <span class="n">XPC_ACTIVATE_MQ_MSG_ACTIVATE_REQ_UV</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">==</span> <span class="n">XPC_P_AS_INACTIVE</span><span class="p">)</span>
		<span class="n">xpc_send_local_activate_IRQ_uv</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">XPC_P_ASR_ACTIVATE_UV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_request_partition_reactivation_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_send_local_activate_IRQ_uv</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">XPC_P_ASR_ACTIVATE_UV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_request_partition_deactivation_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_deactivate_req_uv</span> <span class="n">msg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * ??? Is it a good idea to make this conditional on what is</span>
<span class="cm">	 * ??? potentially stale state information?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">remote_act_state</span> <span class="o">!=</span> <span class="n">XPC_P_AS_DEACTIVATING</span> <span class="o">&amp;&amp;</span>
	    <span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">remote_act_state</span> <span class="o">!=</span> <span class="n">XPC_P_AS_INACTIVE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">msg</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
		<span class="n">xpc_send_activate_IRQ_part_uv</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
					 <span class="n">XPC_ACTIVATE_MQ_MSG_DEACTIVATE_REQ_UV</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_cancel_partition_deactivation_request_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nothing needs to be done */</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_init_fifo_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_fifo_head_uv</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">n_entries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">xpc_get_fifo_entry_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_fifo_head_uv</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_fifo_entry_uv</span> <span class="o">*</span><span class="n">first</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">first</span> <span class="o">=</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">first</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="n">first</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">head</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

		<span class="n">head</span><span class="o">-&gt;</span><span class="n">n_entries</span><span class="o">--</span><span class="p">;</span>
		<span class="n">BUG_ON</span><span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">n_entries</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">first</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">first</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_put_fifo_entry_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_fifo_head_uv</span> <span class="o">*</span><span class="n">head</span><span class="p">,</span>
		      <span class="k">struct</span> <span class="n">xpc_fifo_entry_uv</span> <span class="o">*</span><span class="n">last</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>

	<span class="n">last</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">last</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">last</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">head</span><span class="o">-&gt;</span><span class="n">first</span> <span class="o">=</span> <span class="n">last</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">last</span> <span class="o">=</span> <span class="n">last</span><span class="p">;</span>
	<span class="n">head</span><span class="o">-&gt;</span><span class="n">n_entries</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">head</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_n_of_fifo_entries_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_fifo_head_uv</span> <span class="o">*</span><span class="n">head</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">head</span><span class="o">-&gt;</span><span class="n">n_entries</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup the channel structures that are uv specific.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_setup_ch_structures_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_uv</span> <span class="o">*</span><span class="n">ch_uv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_number</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ch_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch_number</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">nchannels</span><span class="p">;</span> <span class="n">ch_number</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_number</span><span class="p">].</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>

		<span class="n">xpc_init_fifo_uv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">msg_slot_free_list</span><span class="p">);</span>
		<span class="n">xpc_init_fifo_uv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">recv_msg_list</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">xpSuccess</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Teardown the channel structures that are uv specific.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_teardown_ch_structures_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nothing needs to be done */</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_make_first_contact_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_uv</span> <span class="n">msg</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We send a sync msg to get the remote partition&#39;s remote_act_state</span>
<span class="cm">	 * updated to our current act_state which at this point should</span>
<span class="cm">	 * be XPC_P_AS_ACTIVATING.</span>
<span class="cm">	 */</span>
	<span class="n">xpc_send_activate_IRQ_part_uv</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
				      <span class="n">XPC_ACTIVATE_MQ_MSG_SYNC_ACT_STATE_UV</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">remote_act_state</span> <span class="o">==</span> <span class="n">XPC_P_AS_ACTIVATING</span><span class="p">)</span> <span class="o">||</span>
		 <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">remote_act_state</span> <span class="o">==</span> <span class="n">XPC_P_AS_ACTIVE</span><span class="p">)))</span> <span class="p">{</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;waiting to make first contact with &quot;</span>
			<span class="s">&quot;partition %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">XPC_PARTID</span><span class="p">(</span><span class="n">part</span><span class="p">));</span>

		<span class="cm">/* wait a 1/4 of a second or so */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">==</span> <span class="n">XPC_P_AS_DEACTIVATING</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">xpSuccess</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span>
<span class="nf">xpc_get_chctl_all_flags_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">xpc_channel_ctl_flags</span> <span class="n">chctl</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">chctl</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_allocate_send_msg_slot_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_uv</span> <span class="o">*</span><span class="n">ch_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_send_msg_slot_uv</span> <span class="o">*</span><span class="n">msg_slot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nentries</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">nentries</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">;</span> <span class="n">nentries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nentries</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nbytes</span> <span class="o">=</span> <span class="n">nentries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_send_msg_slot_uv</span><span class="p">);</span>
		<span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">send_msg_slots</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">send_msg_slots</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">entry</span> <span class="o">&lt;</span> <span class="n">nentries</span><span class="p">;</span> <span class="n">entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msg_slot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">send_msg_slots</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>

			<span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">msg_slot_number</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
			<span class="n">xpc_put_fifo_entry_uv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">msg_slot_free_list</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nentries</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">)</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span> <span class="o">=</span> <span class="n">nentries</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">xpSuccess</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">xpNoMemory</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_allocate_recv_msg_slot_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_uv</span> <span class="o">*</span><span class="n">ch_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_notify_mq_msg_uv</span> <span class="o">*</span><span class="n">msg_slot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nentries</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">nentries</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">;</span> <span class="n">nentries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nentries</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nbytes</span> <span class="o">=</span> <span class="n">nentries</span> <span class="o">*</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>
		<span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">recv_msg_slots</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">recv_msg_slots</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">entry</span> <span class="o">&lt;</span> <span class="n">nentries</span><span class="p">;</span> <span class="n">entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msg_slot</span> <span class="o">=</span> <span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">recv_msg_slots</span> <span class="o">+</span>
			    <span class="n">entry</span> <span class="o">*</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>

			<span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">msg_slot_number</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nentries</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">)</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span> <span class="o">=</span> <span class="n">nentries</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">xpSuccess</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">xpNoMemory</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate msg_slots associated with the channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_setup_msg_structures_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_channel_uv</span> <span class="o">*</span><span class="n">ch_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_SETUP</span><span class="p">);</span>

	<span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">cached_notify_gru_mq_desc</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span>
						   <span class="n">gru_message_queue_desc</span><span class="p">),</span>
						   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">cached_notify_gru_mq_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">xpNoMemory</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_allocate_send_msg_slot_uv</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_allocate_recv_msg_slot_uv</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">send_msg_slots</span><span class="p">);</span>
			<span class="n">xpc_init_fifo_uv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">msg_slot_free_list</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free up msg_slots and clear other stuff that were setup for the specified</span>
<span class="cm"> * channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_teardown_msg_structures_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_uv</span> <span class="o">*</span><span class="n">ch_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">spin_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">));</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">cached_notify_gru_mq_desc</span><span class="p">);</span>
	<span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">cached_notify_gru_mq_desc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_SETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xpc_init_fifo_uv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">msg_slot_free_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">send_msg_slots</span><span class="p">);</span>
		<span class="n">xpc_init_fifo_uv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">recv_msg_list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">recv_msg_slots</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_chctl_closerequest_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_chctl_closerequest_uv</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">ch_number</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
	<span class="n">xpc_send_activate_IRQ_ch_uv</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
				    <span class="n">XPC_ACTIVATE_MQ_MSG_CHCTL_CLOSEREQUEST_UV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_chctl_closereply_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_chctl_closereply_uv</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">ch_number</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">xpc_send_activate_IRQ_ch_uv</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
				    <span class="n">XPC_ACTIVATE_MQ_MSG_CHCTL_CLOSEREPLY_UV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_chctl_openrequest_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_chctl_openrequest_uv</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">ch_number</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">entry_size</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">local_nentries</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">;</span>
	<span class="n">xpc_send_activate_IRQ_ch_uv</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
				    <span class="n">XPC_ACTIVATE_MQ_MSG_CHCTL_OPENREQUEST_UV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_chctl_openreply_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_chctl_openreply_uv</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">ch_number</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">local_nentries</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">remote_nentries</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">;</span>
	<span class="n">msg</span><span class="p">.</span><span class="n">notify_gru_mq_desc_gpa</span> <span class="o">=</span> <span class="n">uv_gpa</span><span class="p">(</span><span class="n">xpc_notify_mq_uv</span><span class="o">-&gt;</span><span class="n">gru_mq_desc</span><span class="p">);</span>
	<span class="n">xpc_send_activate_IRQ_ch_uv</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
				    <span class="n">XPC_ACTIVATE_MQ_MSG_CHCTL_OPENREPLY_UV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_chctl_opencomplete_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_chctl_opencomplete_uv</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span><span class="p">.</span><span class="n">ch_number</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">xpc_send_activate_IRQ_ch_uv</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
				    <span class="n">XPC_ACTIVATE_MQ_MSG_CHCTL_OPENCOMPLETE_UV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_chctl_local_msgrequest_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">ch_number</span><span class="p">]</span> <span class="o">|=</span> <span class="n">XPC_CHCTL_MSGREQUEST</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

	<span class="n">xpc_wakeup_channel_mgr</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_save_remote_msgqueue_pa_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gru_mq_desc_gpa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_uv</span> <span class="o">*</span><span class="n">ch_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">cached_notify_gru_mq_desc</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">xpc_cache_remote_gru_mq_desc_uv</span><span class="p">(</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">cached_notify_gru_mq_desc</span><span class="p">,</span>
					       <span class="n">gru_mq_desc_gpa</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_indicate_partition_engaged_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_uv</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">xpc_send_activate_IRQ_part_uv</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
				      <span class="n">XPC_ACTIVATE_MQ_MSG_MARK_ENGAGED_UV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_indicate_partition_disengaged_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_activate_mq_msg_uv</span> <span class="n">msg</span><span class="p">;</span>

	<span class="n">xpc_send_activate_IRQ_part_uv</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="p">),</span>
				      <span class="n">XPC_ACTIVATE_MQ_MSG_MARK_DISENGAGED_UV</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_assume_partition_disengaged_uv</span><span class="p">(</span><span class="kt">short</span> <span class="n">partid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition_uv</span> <span class="o">*</span><span class="n">part_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XPC_P_ENGAGED_UV</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_partition_engaged_uv</span><span class="p">(</span><span class="kt">short</span> <span class="n">partid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_P_ENGAGED_UV</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_any_partition_engaged_uv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition_uv</span> <span class="o">*</span><span class="n">part_uv</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">partid</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">partid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">partid</span> <span class="o">&lt;</span> <span class="n">XP_MAX_NPARTITIONS_UV</span><span class="p">;</span> <span class="n">partid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">part_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_P_ENGAGED_UV</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_allocate_msg_slot_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span>
			 <span class="k">struct</span> <span class="n">xpc_send_msg_slot_uv</span> <span class="o">**</span><span class="n">address_of_msg_slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_send_msg_slot_uv</span> <span class="o">*</span><span class="n">msg_slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_fifo_entry_uv</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">xpc_get_fifo_entry_uv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">msg_slot_free_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_NOWAIT</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">xpNoWait</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_allocate_msg_wait</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpInterrupted</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="n">xpTimeout</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">msg_slot</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xpc_send_msg_slot_uv</span><span class="p">,</span> <span class="n">next</span><span class="p">);</span>
	<span class="o">*</span><span class="n">address_of_msg_slot</span> <span class="o">=</span> <span class="n">msg_slot</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">xpSuccess</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_free_msg_slot_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">xpc_send_msg_slot_uv</span> <span class="o">*</span><span class="n">msg_slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_put_fifo_entry_uv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">msg_slot_free_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">);</span>

	<span class="cm">/* wakeup anyone waiting for a free msg slot */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_on_msg_allocate_wq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">msg_allocate_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_notify_sender_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">xpc_send_msg_slot_uv</span> <span class="o">*</span><span class="n">msg_slot</span><span class="p">,</span>
		     <span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_notify_func</span> <span class="n">func</span> <span class="o">=</span> <span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">==</span> <span class="n">func</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_to_notify</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;msg_slot-&gt;func() called, msg_slot=0x%p &quot;</span>
			<span class="s">&quot;msg_slot_number=%d partid=%d channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_slot</span><span class="p">,</span>
			<span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">msg_slot_number</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="n">func</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;msg_slot-&gt;func() returned, msg_slot=0x%p &quot;</span>
			<span class="s">&quot;msg_slot_number=%d partid=%d channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">msg_slot</span><span class="p">,</span>
			<span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">msg_slot_number</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_handle_notify_mq_ack_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">xpc_notify_mq_msg_uv</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_send_msg_slot_uv</span> <span class="o">*</span><span class="n">msg_slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">msg_slot_number</span> <span class="o">%</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">;</span>

	<span class="n">msg_slot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">send_msg_slots</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">msg_slot_number</span> <span class="o">!=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">msg_slot_number</span><span class="p">);</span>
	<span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">msg_slot_number</span> <span class="o">+=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">xpc_notify_sender_uv</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">msg_slot</span><span class="p">,</span> <span class="n">xpMsgDelivered</span><span class="p">);</span>

	<span class="n">xpc_free_msg_slot_uv</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">msg_slot</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_handle_notify_mq_msg_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">xpc_notify_mq_msg_uv</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition_uv</span> <span class="o">*</span><span class="n">part_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_channel_uv</span> <span class="o">*</span><span class="n">ch_uv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_notify_mq_msg_uv</span> <span class="o">*</span><span class="n">msg_slot</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_number</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ch_number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ch_number</span> <span class="o">&gt;=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">nchannels</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;xpc_handle_notify_IRQ_uv() received invalid &quot;</span>
			<span class="s">&quot;channel number=0x%x in message from partid=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ch_number</span><span class="p">,</span> <span class="n">XPC_PARTID</span><span class="p">(</span><span class="n">part</span><span class="p">));</span>

		<span class="cm">/* get hb checker to deactivate from the remote partition */</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">act_state_req</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">xpc_activate_IRQ_rcvd</span><span class="o">++</span><span class="p">;</span>
		<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">act_state_req</span> <span class="o">=</span> <span class="n">XPC_P_ASR_DEACTIVATE_UV</span><span class="p">;</span>
		<span class="n">part_uv</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">=</span> <span class="n">xpBadChannelNumber</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_wq</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_number</span><span class="p">];</span>
	<span class="n">xpc_msgqueue_ref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xpc_msgqueue_deref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* see if we&#39;re really dealing with an ACK for a previously sent msg */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xpc_handle_notify_mq_ack_uv</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
		<span class="n">xpc_msgqueue_deref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* we&#39;re dealing with a normal message sent via the notify_mq */</span>
	<span class="n">ch_uv</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">;</span>

	<span class="n">msg_slot</span> <span class="o">=</span> <span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">recv_msg_slots</span> <span class="o">+</span>
	    <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">msg_slot_number</span> <span class="o">%</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">)</span> <span class="o">*</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>

	<span class="n">BUG_ON</span><span class="p">(</span><span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">msg_slot</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span><span class="p">);</span>

	<span class="n">xpc_put_fifo_entry_uv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_uv</span><span class="o">-&gt;</span><span class="n">recv_msg_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTEDCALLOUT_MADE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If there is an existing idle kthread get it to deliver</span>
<span class="cm">		 * the payload, otherwise we&#39;ll have to get the channel mgr</span>
<span class="cm">		 * for this partition to create a kthread to do the delivery.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">kthreads_idle</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">wake_up_nr</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">idle_wq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">xpc_send_chctl_local_msgrequest_uv</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">xpc_msgqueue_deref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">xpc_handle_notify_IRQ_uv</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_notify_mq_msg_uv</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">partid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">msg</span> <span class="o">=</span> <span class="n">gru_get_next_message</span><span class="p">(</span><span class="n">xpc_notify_mq_uv</span><span class="o">-&gt;</span><span class="n">gru_mq_desc</span><span class="p">))</span> <span class="o">!=</span>
	       <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">partid</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">partid</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">partid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">partid</span> <span class="o">&gt;=</span> <span class="n">XP_MAX_NPARTITIONS_UV</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;xpc_handle_notify_IRQ_uv() received &quot;</span>
				<span class="s">&quot;invalid partid=0x%x in message</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">partid</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">xpc_part_ref</span><span class="p">(</span><span class="n">part</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">xpc_handle_notify_mq_msg_uv</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
				<span class="n">xpc_part_deref</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">gru_free_message</span><span class="p">(</span><span class="n">xpc_notify_mq_uv</span><span class="o">-&gt;</span><span class="n">gru_mq_desc</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_n_of_deliverable_payloads_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">xpc_n_of_fifo_entries_uv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">recv_msg_list</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_process_msg_chctl_flags_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_number</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ndeliverable_payloads</span><span class="p">;</span>

	<span class="n">xpc_msgqueue_ref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

	<span class="n">ndeliverable_payloads</span> <span class="o">=</span> <span class="n">xpc_n_of_deliverable_payloads_uv</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ndeliverable_payloads</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTEDCALLOUT_MADE</span><span class="p">))</span> <span class="p">{</span>

		<span class="n">xpc_activate_kthreads</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ndeliverable_payloads</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">xpc_msgqueue_deref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_send_payload_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span>
		    <span class="n">u16</span> <span class="n">payload_size</span><span class="p">,</span> <span class="n">u8</span> <span class="n">notify_type</span><span class="p">,</span> <span class="n">xpc_notify_func</span> <span class="n">func</span><span class="p">,</span>
		    <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">xpSuccess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_send_msg_slot_uv</span> <span class="o">*</span><span class="n">msg_slot</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_notify_mq_msg_uv</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">msg_buffer</span><span class="p">[</span><span class="n">XPC_NOTIFY_MSG_SIZE_UV</span><span class="p">];</span>
	<span class="kt">size_t</span> <span class="n">msg_size</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">notify_type</span> <span class="o">!=</span> <span class="n">XPC_N_CALL</span><span class="p">);</span>

	<span class="n">msg_size</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_notify_mq_msghdr_uv</span><span class="p">)</span> <span class="o">+</span> <span class="n">payload_size</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">msg_size</span> <span class="o">&gt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">xpPayloadTooBig</span><span class="p">;</span>

	<span class="n">xpc_msgqueue_ref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpNotConnected</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_allocate_msg_slot_uv</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg_slot</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_to_notify</span><span class="p">);</span>

		<span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
		<span class="n">smp_wmb</span><span class="p">();</span> <span class="cm">/* a non-NULL func must hit memory after the key */</span>
		<span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_2</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xpc_notify_mq_msg_uv</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">msg_buffer</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">partid</span> <span class="o">=</span> <span class="n">xp_partition_id</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">ch_number</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">msg_size</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">msg_slot_number</span> <span class="o">=</span> <span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">msg_slot_number</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_size</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_send_gru_msg</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">cached_notify_gru_mq_desc</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
			       <span class="n">msg_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">xpSuccess</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_1</span><span class="p">;</span>

	<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">],</span> <span class="n">ret</span><span class="p">);</span>
<span class="nl">out_2:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Try to NULL the msg_slot&#39;s func field. If we fail, then</span>
<span class="cm">		 * xpc_notify_senders_of_disconnect_uv() beat us to it, in which</span>
<span class="cm">		 * case we need to pretend we succeeded to send the message</span>
<span class="cm">		 * since the user will get a callout for the disconnect error</span>
<span class="cm">		 * by xpc_notify_senders_of_disconnect_uv(), and to also get an</span>
<span class="cm">		 * error returned here will confuse them. Additionally, since</span>
<span class="cm">		 * in this case the channel is being disconnected we don&#39;t need</span>
<span class="cm">		 * to put the the msg_slot back on the free list.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">!=</span> <span class="n">func</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">xpSuccess</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out_1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_to_notify</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">xpc_free_msg_slot_uv</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">msg_slot</span><span class="p">);</span>
<span class="nl">out_1:</span>
	<span class="n">xpc_msgqueue_deref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Tell the callers of xpc_send_notify() that the status of their payloads</span>
<span class="cm"> * is unknown because the channel is now disconnecting.</span>
<span class="cm"> *</span>
<span class="cm"> * We don&#39;t worry about putting these msg_slots on the free list since the</span>
<span class="cm"> * msg_slots themselves are about to be kfree&#39;d.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_notify_senders_of_disconnect_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_send_msg_slot_uv</span> <span class="o">*</span><span class="n">msg_slot</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">entry</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">));</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">entry</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">entry</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">;</span> <span class="n">entry</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_to_notify</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">msg_slot</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">send_msg_slots</span><span class="p">[</span><span class="n">entry</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg_slot</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">xpc_notify_sender_uv</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">msg_slot</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the next deliverable message&#39;s payload.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">xpc_get_deliverable_payload_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_fifo_entry_uv</span> <span class="o">*</span><span class="n">entry</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_notify_mq_msg_uv</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">payload</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">entry</span> <span class="o">=</span> <span class="n">xpc_get_fifo_entry_uv</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">recv_msg_list</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">entry</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">msg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">entry</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xpc_notify_mq_msg_uv</span><span class="p">,</span>
					   <span class="n">hdr</span><span class="p">.</span><span class="n">u</span><span class="p">.</span><span class="n">next</span><span class="p">);</span>
			<span class="n">payload</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">payload</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_received_payload_uv</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_notify_mq_msg_uv</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xpc_notify_mq_msg_uv</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>

	<span class="cm">/* return an ACK to the sender of this message */</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">partid</span> <span class="o">=</span> <span class="n">xp_partition_id</span><span class="p">;</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* size of zero indicates this is an ACK */</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_send_gru_msg</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">uv</span><span class="p">.</span><span class="n">cached_notify_gru_mq_desc</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span>
			       <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_notify_mq_msghdr_uv</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span>
		<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">],</span> <span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xpc_arch_operations</span> <span class="n">xpc_arch_ops_uv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">setup_partitions</span> <span class="o">=</span> <span class="n">xpc_setup_partitions_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">teardown_partitions</span> <span class="o">=</span> <span class="n">xpc_teardown_partitions_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">process_activate_IRQ_rcvd</span> <span class="o">=</span> <span class="n">xpc_process_activate_IRQ_rcvd_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_partition_rsvd_page_pa</span> <span class="o">=</span> <span class="n">xpc_get_partition_rsvd_page_pa_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_rsvd_page</span> <span class="o">=</span> <span class="n">xpc_setup_rsvd_page_uv</span><span class="p">,</span>

	<span class="p">.</span><span class="n">allow_hb</span> <span class="o">=</span> <span class="n">xpc_allow_hb_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disallow_hb</span> <span class="o">=</span> <span class="n">xpc_disallow_hb_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disallow_all_hbs</span> <span class="o">=</span> <span class="n">xpc_disallow_all_hbs_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">increment_heartbeat</span> <span class="o">=</span> <span class="n">xpc_increment_heartbeat_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">offline_heartbeat</span> <span class="o">=</span> <span class="n">xpc_offline_heartbeat_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">online_heartbeat</span> <span class="o">=</span> <span class="n">xpc_online_heartbeat_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">heartbeat_init</span> <span class="o">=</span> <span class="n">xpc_heartbeat_init_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">heartbeat_exit</span> <span class="o">=</span> <span class="n">xpc_heartbeat_exit_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_remote_heartbeat</span> <span class="o">=</span> <span class="n">xpc_get_remote_heartbeat_uv</span><span class="p">,</span>

	<span class="p">.</span><span class="n">request_partition_activation</span> <span class="o">=</span>
		<span class="n">xpc_request_partition_activation_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_partition_reactivation</span> <span class="o">=</span>
		<span class="n">xpc_request_partition_reactivation_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_partition_deactivation</span> <span class="o">=</span>
		<span class="n">xpc_request_partition_deactivation_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cancel_partition_deactivation_request</span> <span class="o">=</span>
		<span class="n">xpc_cancel_partition_deactivation_request_uv</span><span class="p">,</span>

	<span class="p">.</span><span class="n">setup_ch_structures</span> <span class="o">=</span> <span class="n">xpc_setup_ch_structures_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">teardown_ch_structures</span> <span class="o">=</span> <span class="n">xpc_teardown_ch_structures_uv</span><span class="p">,</span>

	<span class="p">.</span><span class="n">make_first_contact</span> <span class="o">=</span> <span class="n">xpc_make_first_contact_uv</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_chctl_all_flags</span> <span class="o">=</span> <span class="n">xpc_get_chctl_all_flags_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_chctl_closerequest</span> <span class="o">=</span> <span class="n">xpc_send_chctl_closerequest_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_chctl_closereply</span> <span class="o">=</span> <span class="n">xpc_send_chctl_closereply_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_chctl_openrequest</span> <span class="o">=</span> <span class="n">xpc_send_chctl_openrequest_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_chctl_openreply</span> <span class="o">=</span> <span class="n">xpc_send_chctl_openreply_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_chctl_opencomplete</span> <span class="o">=</span> <span class="n">xpc_send_chctl_opencomplete_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">process_msg_chctl_flags</span> <span class="o">=</span> <span class="n">xpc_process_msg_chctl_flags_uv</span><span class="p">,</span>

	<span class="p">.</span><span class="n">save_remote_msgqueue_pa</span> <span class="o">=</span> <span class="n">xpc_save_remote_msgqueue_pa_uv</span><span class="p">,</span>

	<span class="p">.</span><span class="n">setup_msg_structures</span> <span class="o">=</span> <span class="n">xpc_setup_msg_structures_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">teardown_msg_structures</span> <span class="o">=</span> <span class="n">xpc_teardown_msg_structures_uv</span><span class="p">,</span>

	<span class="p">.</span><span class="n">indicate_partition_engaged</span> <span class="o">=</span> <span class="n">xpc_indicate_partition_engaged_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">indicate_partition_disengaged</span> <span class="o">=</span> <span class="n">xpc_indicate_partition_disengaged_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">assume_partition_disengaged</span> <span class="o">=</span> <span class="n">xpc_assume_partition_disengaged_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">partition_engaged</span> <span class="o">=</span> <span class="n">xpc_partition_engaged_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">any_partition_engaged</span> <span class="o">=</span> <span class="n">xpc_any_partition_engaged_uv</span><span class="p">,</span>

	<span class="p">.</span><span class="n">n_of_deliverable_payloads</span> <span class="o">=</span> <span class="n">xpc_n_of_deliverable_payloads_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_payload</span> <span class="o">=</span> <span class="n">xpc_send_payload_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_deliverable_payload</span> <span class="o">=</span> <span class="n">xpc_get_deliverable_payload_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">received_payload</span> <span class="o">=</span> <span class="n">xpc_received_payload_uv</span><span class="p">,</span>
	<span class="p">.</span><span class="n">notify_senders_of_disconnect</span> <span class="o">=</span> <span class="n">xpc_notify_senders_of_disconnect_uv</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span>
<span class="nf">xpc_init_uv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_arch_ops</span> <span class="o">=</span> <span class="n">xpc_arch_ops_uv</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_notify_mq_msghdr_uv</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">XPC_MSG_HDR_MAX_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;xpc_notify_mq_msghdr_uv is larger than %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">XPC_MSG_HDR_MAX_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">xpc_activate_mq_uv</span> <span class="o">=</span> <span class="n">xpc_create_gru_mq_uv</span><span class="p">(</span><span class="n">XPC_ACTIVATE_MQ_SIZE_UV</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						  <span class="n">XPC_ACTIVATE_IRQ_NAME</span><span class="p">,</span>
						  <span class="n">xpc_handle_activate_IRQ_uv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">xpc_activate_mq_uv</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">xpc_activate_mq_uv</span><span class="p">);</span>

	<span class="n">xpc_notify_mq_uv</span> <span class="o">=</span> <span class="n">xpc_create_gru_mq_uv</span><span class="p">(</span><span class="n">XPC_NOTIFY_MQ_SIZE_UV</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">XPC_NOTIFY_IRQ_NAME</span><span class="p">,</span>
						<span class="n">xpc_handle_notify_IRQ_uv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">xpc_notify_mq_uv</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xpc_destroy_gru_mq_uv</span><span class="p">(</span><span class="n">xpc_activate_mq_uv</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">xpc_notify_mq_uv</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">xpc_exit_uv</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_destroy_gru_mq_uv</span><span class="p">(</span><span class="n">xpc_notify_mq_uv</span><span class="p">);</span>
	<span class="n">xpc_destroy_gru_mq_uv</span><span class="p">(</span><span class="n">xpc_activate_mq_uv</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
