<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › misc › sgi-xp › xpc_sn2.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>xpc_sn2.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2008-2009 Silicon Graphics, Inc.  All Rights Reserved.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Cross Partition Communication (XPC) sn2-based functions.</span>
<span class="cm"> *</span>
<span class="cm"> *     Architecture specific implementation of common functions.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;asm/uncached.h&gt;</span>
<span class="cp">#include &lt;asm/sn/mspec.h&gt;</span>
<span class="cp">#include &lt;asm/sn/sn_sal.h&gt;</span>
<span class="cp">#include &quot;xpc.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Define the number of u64s required to represent all the C-brick nasids</span>
<span class="cm"> * as a bitmap.  The cross-partition kernel modules deal only with</span>
<span class="cm"> * C-brick nasids, thus the need for bitmaps which don&#39;t account for</span>
<span class="cm"> * odd-numbered (non C-brick) nasids.</span>
<span class="cm"> */</span>
<span class="cp">#define XPC_MAX_PHYSNODES_SN2	(MAX_NUMALINK_NODES / 2)</span>
<span class="cp">#define XP_NASID_MASK_BYTES_SN2	((XPC_MAX_PHYSNODES_SN2 + 7) / 8)</span>
<span class="cp">#define XP_NASID_MASK_WORDS_SN2	((XPC_MAX_PHYSNODES_SN2 + 63) / 64)</span>

<span class="cm">/*</span>
<span class="cm"> * Memory for XPC&#39;s amo variables is allocated by the MSPEC driver. These</span>
<span class="cm"> * pages are located in the lowest granule. The lowest granule uses 4k pages</span>
<span class="cm"> * for cached references and an alternate TLB handler to never provide a</span>
<span class="cm"> * cacheable mapping for the entire region. This will prevent speculative</span>
<span class="cm"> * reading of cached copies of our lines from being issued which will cause</span>
<span class="cm"> * a PI FSB Protocol error to be generated by the SHUB. For XPC, we need 64</span>
<span class="cm"> * amo variables (based on XP_MAX_NPARTITIONS_SN2) to identify the senders of</span>
<span class="cm"> * NOTIFY IRQs, 128 amo variables (based on XP_NASID_MASK_WORDS_SN2) to identify</span>
<span class="cm"> * the senders of ACTIVATE IRQs, 1 amo variable to identify which remote</span>
<span class="cm"> * partitions (i.e., XPCs) consider themselves currently engaged with the</span>
<span class="cm"> * local XPC and 1 amo variable to request partition deactivation.</span>
<span class="cm"> */</span>
<span class="cp">#define XPC_NOTIFY_IRQ_AMOS_SN2		0</span>
<span class="cp">#define XPC_ACTIVATE_IRQ_AMOS_SN2	(XPC_NOTIFY_IRQ_AMOS_SN2 + \</span>
<span class="cp">					 XP_MAX_NPARTITIONS_SN2)</span>
<span class="cp">#define XPC_ENGAGED_PARTITIONS_AMO_SN2	(XPC_ACTIVATE_IRQ_AMOS_SN2 + \</span>
<span class="cp">					 XP_NASID_MASK_WORDS_SN2)</span>
<span class="cp">#define XPC_DEACTIVATE_REQUEST_AMO_SN2	(XPC_ENGAGED_PARTITIONS_AMO_SN2 + 1)</span>

<span class="cm">/*</span>
<span class="cm"> * Buffer used to store a local copy of portions of a remote partition&#39;s</span>
<span class="cm"> * reserved page (either its header and part_nasids mask, or its vars).</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span><span class="n">xpc_remote_copy_buffer_base_sn2</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="o">*</span><span class="n">xpc_remote_copy_buffer_sn2</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xpc_vars_sn2</span> <span class="o">*</span><span class="n">xpc_vars_sn2</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">xpc_vars_part_sn2</span> <span class="o">*</span><span class="n">xpc_vars_part_sn2</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_setup_partitions_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nothing needs to be done */</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_teardown_partitions_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* nothing needs to be done */</span>
<span class="p">}</span>

<span class="cm">/* SH_IPI_ACCESS shub register value on startup */</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">xpc_sh1_IPI_access_sn2</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">xpc_sh2_IPI_access0_sn2</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">xpc_sh2_IPI_access1_sn2</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">xpc_sh2_IPI_access2_sn2</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">xpc_sh2_IPI_access3_sn2</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Change protections to allow IPI operations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_allow_IPI_ops_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nasid</span><span class="p">;</span>

	<span class="cm">/* !!! The following should get moved into SAL. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_shub2</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">xpc_sh2_IPI_access0_sn2</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">HUB_L</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">LOCAL_MMR_ADDR</span><span class="p">(</span><span class="n">SH2_IPI_ACCESS0</span><span class="p">));</span>
		<span class="n">xpc_sh2_IPI_access1_sn2</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">HUB_L</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">LOCAL_MMR_ADDR</span><span class="p">(</span><span class="n">SH2_IPI_ACCESS1</span><span class="p">));</span>
		<span class="n">xpc_sh2_IPI_access2_sn2</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">HUB_L</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">LOCAL_MMR_ADDR</span><span class="p">(</span><span class="n">SH2_IPI_ACCESS2</span><span class="p">));</span>
		<span class="n">xpc_sh2_IPI_access3_sn2</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">HUB_L</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">LOCAL_MMR_ADDR</span><span class="p">(</span><span class="n">SH2_IPI_ACCESS3</span><span class="p">));</span>

		<span class="n">for_each_online_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nasid</span> <span class="o">=</span> <span class="n">cnodeid_to_nasid</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
			<span class="n">HUB_S</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span> <span class="n">SH2_IPI_ACCESS0</span><span class="p">),</span>
			      <span class="o">-</span><span class="mi">1UL</span><span class="p">);</span>
			<span class="n">HUB_S</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span> <span class="n">SH2_IPI_ACCESS1</span><span class="p">),</span>
			      <span class="o">-</span><span class="mi">1UL</span><span class="p">);</span>
			<span class="n">HUB_S</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span> <span class="n">SH2_IPI_ACCESS2</span><span class="p">),</span>
			      <span class="o">-</span><span class="mi">1UL</span><span class="p">);</span>
			<span class="n">HUB_S</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span> <span class="n">SH2_IPI_ACCESS3</span><span class="p">),</span>
			      <span class="o">-</span><span class="mi">1UL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">xpc_sh1_IPI_access_sn2</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">HUB_L</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">LOCAL_MMR_ADDR</span><span class="p">(</span><span class="n">SH1_IPI_ACCESS</span><span class="p">));</span>

		<span class="n">for_each_online_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nasid</span> <span class="o">=</span> <span class="n">cnodeid_to_nasid</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
			<span class="n">HUB_S</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span> <span class="n">SH1_IPI_ACCESS</span><span class="p">),</span>
			      <span class="o">-</span><span class="mi">1UL</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Restrict protections to disallow IPI operations.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_disallow_IPI_ops_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nasid</span><span class="p">;</span>

	<span class="cm">/* !!! The following should get moved into SAL. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_shub2</span><span class="p">())</span> <span class="p">{</span>
		<span class="n">for_each_online_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nasid</span> <span class="o">=</span> <span class="n">cnodeid_to_nasid</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
			<span class="n">HUB_S</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span> <span class="n">SH2_IPI_ACCESS0</span><span class="p">),</span>
			      <span class="n">xpc_sh2_IPI_access0_sn2</span><span class="p">);</span>
			<span class="n">HUB_S</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span> <span class="n">SH2_IPI_ACCESS1</span><span class="p">),</span>
			      <span class="n">xpc_sh2_IPI_access1_sn2</span><span class="p">);</span>
			<span class="n">HUB_S</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span> <span class="n">SH2_IPI_ACCESS2</span><span class="p">),</span>
			      <span class="n">xpc_sh2_IPI_access2_sn2</span><span class="p">);</span>
			<span class="n">HUB_S</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span> <span class="n">SH2_IPI_ACCESS3</span><span class="p">),</span>
			      <span class="n">xpc_sh2_IPI_access3_sn2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">for_each_online_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">nasid</span> <span class="o">=</span> <span class="n">cnodeid_to_nasid</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
			<span class="n">HUB_S</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span> <span class="n">SH1_IPI_ACCESS</span><span class="p">),</span>
			      <span class="n">xpc_sh1_IPI_access_sn2</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * The following set of functions are used for the sending and receiving of</span>
<span class="cm"> * IRQs (also known as IPIs). There are two flavors of IRQs, one that is</span>
<span class="cm"> * associated with partition activity (SGI_XPC_ACTIVATE) and the other that</span>
<span class="cm"> * is associated with channel activity (SGI_XPC_NOTIFY).</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="n">u64</span>
<span class="nf">xpc_receive_IRQ_amo_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">FETCHOP_LOAD_OP</span><span class="p">(</span><span class="n">TO_AMO</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span><span class="n">variable</span><span class="p">),</span> <span class="n">FETCHOP_CLEAR</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_send_IRQ_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amo</span><span class="p">,</span> <span class="n">u64</span> <span class="n">flag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nasid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">phys_cpuid</span><span class="p">,</span>
		 <span class="kt">int</span> <span class="n">vector</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">irq_flags</span><span class="p">);</span>

	<span class="n">FETCHOP_STORE_OP</span><span class="p">(</span><span class="n">TO_AMO</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span><span class="n">variable</span><span class="p">),</span> <span class="n">FETCHOP_OR</span><span class="p">,</span> <span class="n">flag</span><span class="p">);</span>
	<span class="n">sn_send_IPI_phys</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span> <span class="n">phys_cpuid</span><span class="p">,</span> <span class="n">vector</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must always use the nofault function regardless of whether we</span>
<span class="cm">	 * are on a Shub 1.1 system or a Shub 1.2 slice 0xc processor. If we</span>
<span class="cm">	 * didn&#39;t, we&#39;d never know that the other partition is down and would</span>
<span class="cm">	 * keep sending IRQs and amos to it until the heartbeat times out.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">xp_nofault_PIOR</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">NASID_GET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span><span class="n">variable</span><span class="p">),</span>
						     <span class="n">xp_nofault_PIOR_target</span><span class="p">));</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">irq_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">xpSuccess</span> <span class="o">:</span> <span class="n">xpPioReadError</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span>
<span class="nf">xpc_init_IRQ_amo_sn2</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amo</span> <span class="o">=</span> <span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">amos_page</span> <span class="o">+</span> <span class="n">index</span><span class="p">;</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">xpc_receive_IRQ_amo_sn2</span><span class="p">(</span><span class="n">amo</span><span class="p">);</span>	<span class="cm">/* clear amo variable */</span>
	<span class="k">return</span> <span class="n">amo</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Functions associated with SGI_XPC_ACTIVATE IRQ.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Notify the heartbeat check thread that an activate IRQ has been received.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">xpc_handle_activate_IRQ_sn2</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">xpc_activate_IRQ_rcvd</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_wq</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Flag the appropriate amo variable and send an IRQ to the specified node.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_activate_IRQ_sn2</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">amos_page_pa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">from_nasid</span><span class="p">,</span>
			  <span class="kt">int</span> <span class="n">to_nasid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">to_phys_cpuid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">amos_page_pa</span> <span class="o">+</span>
					      <span class="p">(</span><span class="n">XPC_ACTIVATE_IRQ_AMOS_SN2</span> <span class="o">*</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amo</span><span class="p">)));</span>

	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">xpc_send_IRQ_sn2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amos</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">from_nasid</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)],</span>
			       <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">from_nasid</span> <span class="o">/</span> <span class="mi">2</span><span class="p">),</span> <span class="n">to_nasid</span><span class="p">,</span>
			       <span class="n">to_phys_cpuid</span><span class="p">,</span> <span class="n">SGI_XPC_ACTIVATE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_local_activate_IRQ_sn2</span><span class="p">(</span><span class="kt">int</span> <span class="n">from_nasid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amos</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">amos_page_pa</span> <span class="o">+</span>
					      <span class="p">(</span><span class="n">XPC_ACTIVATE_IRQ_AMOS_SN2</span> <span class="o">*</span>
					      <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amo</span><span class="p">)));</span>

	<span class="cm">/* fake the sending and receipt of an activate IRQ from remote nasid */</span>
	<span class="n">FETCHOP_STORE_OP</span><span class="p">(</span><span class="n">TO_AMO</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amos</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">from_nasid</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)].</span><span class="n">variable</span><span class="p">),</span>
			 <span class="n">FETCHOP_OR</span><span class="p">,</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">from_nasid</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">xpc_activate_IRQ_rcvd</span><span class="o">++</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_wq</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Functions associated with SGI_XPC_NOTIFY IRQ.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Check to see if any chctl flags were sent from the specified partition.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_check_for_sent_chctl_flags_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">xpc_channel_ctl_flags</span> <span class="n">chctl</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>

	<span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span> <span class="o">=</span> <span class="n">xpc_receive_IRQ_amo_sn2</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span>
						  <span class="n">local_chctl_amo_va</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span> <span class="o">|=</span> <span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;received notify IRQ from partid=%d, chctl.all_flags=&quot;</span>
		<span class="s">&quot;0x%llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">XPC_PARTID</span><span class="p">(</span><span class="n">part</span><span class="p">),</span> <span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span><span class="p">);</span>

	<span class="n">xpc_wakeup_channel_mgr</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Handle the receipt of a SGI_XPC_NOTIFY IRQ by seeing whether the specified</span>
<span class="cm"> * partition actually sent it. Since SGI_XPC_NOTIFY IRQs may be shared by more</span>
<span class="cm"> * than one partition, we use an amo structure per partition to indicate</span>
<span class="cm"> * whether a partition has sent an IRQ or not.  If it has, then wake up the</span>
<span class="cm"> * associated kthread to handle it.</span>
<span class="cm"> *</span>
<span class="cm"> * All SGI_XPC_NOTIFY IRQs received by XPC are the result of IRQs sent by XPC</span>
<span class="cm"> * running on other partitions.</span>
<span class="cm"> *</span>
<span class="cm"> * Noteworthy Arguments:</span>
<span class="cm"> *</span>
<span class="cm"> *	irq - Interrupt ReQuest number. NOT USED.</span>
<span class="cm"> *</span>
<span class="cm"> *	dev_id - partid of IRQ&#39;s potential sender.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">xpc_handle_notify_IRQ_sn2</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">partid</span> <span class="o">=</span> <span class="p">(</span><span class="kt">short</span><span class="p">)(</span><span class="n">u64</span><span class="p">)</span><span class="n">dev_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">];</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">partid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">partid</span> <span class="o">&gt;=</span> <span class="n">XP_MAX_NPARTITIONS_SN2</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpc_part_ref</span><span class="p">(</span><span class="n">part</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xpc_check_for_sent_chctl_flags_sn2</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>

		<span class="n">xpc_part_deref</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Check to see if xpc_handle_notify_IRQ_sn2() dropped any IRQs on the floor</span>
<span class="cm"> * because the write to their associated amo variable completed after the IRQ</span>
<span class="cm"> * was received.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_check_for_dropped_notify_IRQ_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition_sn2</span> <span class="o">*</span><span class="n">part_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpc_part_ref</span><span class="p">(</span><span class="n">part</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xpc_check_for_sent_chctl_flags_sn2</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>

		<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">dropped_notify_IRQ_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span>
		    <span class="n">XPC_DROPPED_NOTIFY_IRQ_WAIT_INTERVAL</span><span class="p">;</span>
		<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">dropped_notify_IRQ_timer</span><span class="p">);</span>
		<span class="n">xpc_part_deref</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send a notify IRQ to the remote partition that is associated with the</span>
<span class="cm"> * specified channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_notify_IRQ_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u8</span> <span class="n">chctl_flag</span><span class="p">,</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">chctl_flag_string</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xpc_partition_sn2</span> <span class="o">*</span><span class="n">part_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">xpc_channel_ctl_flags</span> <span class="n">chctl</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">!=</span> <span class="n">XPC_P_AS_DEACTIVATING</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="n">chctl_flag</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_send_IRQ_sn2</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_chctl_amo_va</span><span class="p">,</span>
				       <span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span><span class="p">,</span>
				       <span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">notify_IRQ_nasid</span><span class="p">,</span>
				       <span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">notify_IRQ_phys_cpuid</span><span class="p">,</span>
				       <span class="n">SGI_XPC_NOTIFY</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;%s sent to partid=%d, channel=%d, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">chctl_flag_string</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq_flags</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">);</span>
			<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">irq_flags</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cp">#define XPC_SEND_NOTIFY_IRQ_SN2(_ch, _ipi_f, _irq_f) \</span>
<span class="cp">		xpc_send_notify_IRQ_sn2(_ch, _ipi_f, #_ipi_f, _irq_f)</span>

<span class="cm">/*</span>
<span class="cm"> * Make it look like the remote partition, which is associated with the</span>
<span class="cm"> * specified channel, sent us a notify IRQ. This faked IRQ will be handled</span>
<span class="cm"> * by xpc_check_for_dropped_notify_IRQ_sn2().</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_local_notify_IRQ_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u8</span> <span class="n">chctl_flag</span><span class="p">,</span>
			      <span class="kt">char</span> <span class="o">*</span><span class="n">chctl_flag_string</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">];</span>
	<span class="k">union</span> <span class="n">xpc_channel_ctl_flags</span> <span class="n">chctl</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">=</span> <span class="n">chctl_flag</span><span class="p">;</span>
	<span class="n">FETCHOP_STORE_OP</span><span class="p">(</span><span class="n">TO_AMO</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">local_chctl_amo_va</span><span class="o">-&gt;</span>
				<span class="n">variable</span><span class="p">),</span> <span class="n">FETCHOP_OR</span><span class="p">,</span> <span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;%s sent local from partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">chctl_flag_string</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define XPC_SEND_LOCAL_NOTIFY_IRQ_SN2(_ch, _ipi_f) \</span>
<span class="cp">		xpc_send_local_notify_IRQ_sn2(_ch, _ipi_f, #_ipi_f)</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_chctl_closerequest_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_openclose_args</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">local_openclose_args</span><span class="p">;</span>

	<span class="n">args</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
	<span class="n">XPC_SEND_NOTIFY_IRQ_SN2</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">XPC_CHCTL_CLOSEREQUEST</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_chctl_closereply_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">XPC_SEND_NOTIFY_IRQ_SN2</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">XPC_CHCTL_CLOSEREPLY</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_chctl_openrequest_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_openclose_args</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">local_openclose_args</span><span class="p">;</span>

	<span class="n">args</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">local_nentries</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">;</span>
	<span class="n">XPC_SEND_NOTIFY_IRQ_SN2</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">XPC_CHCTL_OPENREQUEST</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_chctl_openreply_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_openclose_args</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">local_openclose_args</span><span class="p">;</span>

	<span class="n">args</span><span class="o">-&gt;</span><span class="n">remote_nentries</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">local_nentries</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">;</span>
	<span class="n">args</span><span class="o">-&gt;</span><span class="n">local_msgqueue_pa</span> <span class="o">=</span> <span class="n">xp_pa</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">local_msgqueue</span><span class="p">);</span>
	<span class="n">XPC_SEND_NOTIFY_IRQ_SN2</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">XPC_CHCTL_OPENREPLY</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_chctl_opencomplete_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">XPC_SEND_NOTIFY_IRQ_SN2</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">XPC_CHCTL_OPENCOMPLETE</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_chctl_msgrequest_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">XPC_SEND_NOTIFY_IRQ_SN2</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">XPC_CHCTL_MSGREQUEST</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_chctl_local_msgrequest_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">XPC_SEND_LOCAL_NOTIFY_IRQ_SN2</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">XPC_CHCTL_MSGREQUEST</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_save_remote_msgqueue_pa_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
				<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">msgqueue_pa</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">remote_msgqueue_pa</span> <span class="o">=</span> <span class="n">msgqueue_pa</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">xpSuccess</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This next set of functions are used to keep track of when a partition is</span>
<span class="cm"> * potentially engaged in accessing memory belonging to another partition.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_indicate_partition_engaged_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">remote_amos_page_pa</span> <span class="o">+</span>
					     <span class="p">(</span><span class="n">XPC_ENGAGED_PARTITIONS_AMO_SN2</span> <span class="o">*</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amo</span><span class="p">)));</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">irq_flags</span><span class="p">);</span>

	<span class="cm">/* set bit corresponding to our partid in remote partition&#39;s amo */</span>
	<span class="n">FETCHOP_STORE_OP</span><span class="p">(</span><span class="n">TO_AMO</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span><span class="n">variable</span><span class="p">),</span> <span class="n">FETCHOP_OR</span><span class="p">,</span>
			 <span class="n">BIT</span><span class="p">(</span><span class="n">sn_partition_id</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must always use the nofault function regardless of whether we</span>
<span class="cm">	 * are on a Shub 1.1 system or a Shub 1.2 slice 0xc processor. If we</span>
<span class="cm">	 * didn&#39;t, we&#39;d never know that the other partition is down and would</span>
<span class="cm">	 * keep sending IRQs and amos to it until the heartbeat times out.</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">xp_nofault_PIOR</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">NASID_GET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span>
							       <span class="n">variable</span><span class="p">),</span>
						     <span class="n">xp_nofault_PIOR_target</span><span class="p">));</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">irq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_indicate_partition_disengaged_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition_sn2</span> <span class="o">*</span><span class="n">part_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_amos_page_pa</span> <span class="o">+</span>
					     <span class="p">(</span><span class="n">XPC_ENGAGED_PARTITIONS_AMO_SN2</span> <span class="o">*</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amo</span><span class="p">)));</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">irq_flags</span><span class="p">);</span>

	<span class="cm">/* clear bit corresponding to our partid in remote partition&#39;s amo */</span>
	<span class="n">FETCHOP_STORE_OP</span><span class="p">(</span><span class="n">TO_AMO</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span><span class="n">variable</span><span class="p">),</span> <span class="n">FETCHOP_AND</span><span class="p">,</span>
			 <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">sn_partition_id</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must always use the nofault function regardless of whether we</span>
<span class="cm">	 * are on a Shub 1.1 system or a Shub 1.2 slice 0xc processor. If we</span>
<span class="cm">	 * didn&#39;t, we&#39;d never know that the other partition is down and would</span>
<span class="cm">	 * keep sending IRQs and amos to it until the heartbeat times out.</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">xp_nofault_PIOR</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">NASID_GET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span>
							       <span class="n">variable</span><span class="p">),</span>
						     <span class="n">xp_nofault_PIOR_target</span><span class="p">));</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">irq_flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send activate IRQ to get other side to see that we&#39;ve cleared our</span>
<span class="cm">	 * bit in their engaged partitions amo.</span>
<span class="cm">	 */</span>
	<span class="n">xpc_send_activate_IRQ_sn2</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_amos_page_pa</span><span class="p">,</span>
				  <span class="n">cnodeid_to_nasid</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
				  <span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">activate_IRQ_nasid</span><span class="p">,</span>
				  <span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">activate_IRQ_phys_cpuid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_assume_partition_disengaged_sn2</span><span class="p">(</span><span class="kt">short</span> <span class="n">partid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amo</span> <span class="o">=</span> <span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">amos_page</span> <span class="o">+</span>
			  <span class="n">XPC_ENGAGED_PARTITIONS_AMO_SN2</span><span class="p">;</span>

	<span class="cm">/* clear bit(s) based on partid mask in our partition&#39;s amo */</span>
	<span class="n">FETCHOP_STORE_OP</span><span class="p">(</span><span class="n">TO_AMO</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span><span class="n">variable</span><span class="p">),</span> <span class="n">FETCHOP_AND</span><span class="p">,</span>
			 <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">partid</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_partition_engaged_sn2</span><span class="p">(</span><span class="kt">short</span> <span class="n">partid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amo</span> <span class="o">=</span> <span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">amos_page</span> <span class="o">+</span>
			  <span class="n">XPC_ENGAGED_PARTITIONS_AMO_SN2</span><span class="p">;</span>

	<span class="cm">/* our partition&#39;s amo variable ANDed with partid mask */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">FETCHOP_LOAD_OP</span><span class="p">(</span><span class="n">TO_AMO</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span><span class="n">variable</span><span class="p">),</span> <span class="n">FETCHOP_LOAD</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">partid</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_any_partition_engaged_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amo</span> <span class="o">=</span> <span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">amos_page</span> <span class="o">+</span>
			  <span class="n">XPC_ENGAGED_PARTITIONS_AMO_SN2</span><span class="p">;</span>

	<span class="cm">/* our partition&#39;s amo variable */</span>
	<span class="k">return</span> <span class="n">FETCHOP_LOAD_OP</span><span class="p">(</span><span class="n">TO_AMO</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span><span class="n">variable</span><span class="p">),</span> <span class="n">FETCHOP_LOAD</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* original protection values for each node */</span>
<span class="k">static</span> <span class="n">u64</span> <span class="n">xpc_prot_vec_sn2</span><span class="p">[</span><span class="n">MAX_NUMNODES</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * Change protections to allow amo operations on non-Shub 1.1 systems.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_allow_amo_ops_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amos_page</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">xpSuccess</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * On SHUB 1.1, we cannot call sn_change_memprotect() since the BIST</span>
<span class="cm">	 * collides with memory operations. On those systems we call</span>
<span class="cm">	 * xpc_allow_amo_ops_shub_wars_1_1_sn2() instead.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_shub_wars_1_1</span><span class="p">())</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xp_expand_memprotect</span><span class="p">(</span><span class="n">ia64_tpa</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">amos_page</span><span class="p">),</span> <span class="n">PAGE_SIZE</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Change protections to allow amo operations on Shub 1.1 systems.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_allow_amo_ops_shub_wars_1_1_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">node</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nasid</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">enable_shub_wars_1_1</span><span class="p">())</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">for_each_online_node</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">nasid</span> <span class="o">=</span> <span class="n">cnodeid_to_nasid</span><span class="p">(</span><span class="n">node</span><span class="p">);</span>
		<span class="cm">/* save current protection values */</span>
		<span class="n">xpc_prot_vec_sn2</span><span class="p">[</span><span class="n">node</span><span class="p">]</span> <span class="o">=</span>
		    <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">HUB_L</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span>
						  <span class="n">SH1_MD_DQLP_MMR_DIR_PRIVEC0</span><span class="p">));</span>
		<span class="cm">/* open up everything */</span>
		<span class="n">HUB_S</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span>
					     <span class="n">SH1_MD_DQLP_MMR_DIR_PRIVEC0</span><span class="p">),</span>
		      <span class="o">-</span><span class="mi">1UL</span><span class="p">);</span>
		<span class="n">HUB_S</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span>
					     <span class="n">SH1_MD_DQRP_MMR_DIR_PRIVEC0</span><span class="p">),</span>
		      <span class="o">-</span><span class="mi">1UL</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_get_partition_rsvd_page_pa_sn2</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">u64</span> <span class="o">*</span><span class="n">cookie</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">rp_pa</span><span class="p">,</span>
				   <span class="kt">size_t</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s64</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">sn_partition_reserved_page_pa</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">cookie</span><span class="p">,</span>
			<span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">rp_pa</span><span class="p">,</span> <span class="p">(</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">len</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SALRET_OK</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpSuccess</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">SALRET_MORE_PASSES</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpNeedMoreInfo</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpSalError</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_setup_rsvd_page_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_rsvd_page</span> <span class="o">*</span><span class="n">rp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amos_page</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">xpc_vars_sn2</span> <span class="o">=</span> <span class="n">XPC_RP_VARS</span><span class="p">(</span><span class="n">rp</span><span class="p">);</span>

	<span class="n">rp</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">vars_pa</span> <span class="o">=</span> <span class="n">xp_pa</span><span class="p">(</span><span class="n">xpc_vars_sn2</span><span class="p">);</span>

	<span class="cm">/* vars_part array follows immediately after vars */</span>
	<span class="n">xpc_vars_part_sn2</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xpc_vars_part_sn2</span> <span class="o">*</span><span class="p">)((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">XPC_RP_VARS</span><span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="o">+</span>
							 <span class="n">XPC_RP_VARS_SIZE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Before clearing xpc_vars_sn2, see if a page of amos had been</span>
<span class="cm">	 * previously allocated. If not we&#39;ll need to allocate one and set</span>
<span class="cm">	 * permissions so that cross-partition amos are allowed.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The allocated amo page needs MCA reporting to remain disabled after</span>
<span class="cm">	 * XPC has unloaded.  To make this work, we keep a copy of the pointer</span>
<span class="cm">	 * to this page (i.e., amos_page) in the struct xpc_vars_sn2 structure,</span>
<span class="cm">	 * which is pointed to by the reserved page, and re-use that saved copy</span>
<span class="cm">	 * on subsequent loads of XPC. This amo page is never freed, and its</span>
<span class="cm">	 * memory protections are never restricted.</span>
<span class="cm">	 */</span>
	<span class="n">amos_page</span> <span class="o">=</span> <span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">amos_page</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">amos_page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">amos_page</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="p">)</span><span class="n">TO_AMO</span><span class="p">(</span><span class="n">uncached_alloc_page</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">amos_page</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;can&#39;t allocate page of amos</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Open up amo-R/W to cpu.  This is done on Shub 1.1 systems</span>
<span class="cm">		 * when xpc_allow_amo_ops_shub_wars_1_1_sn2() is called.</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_allow_amo_ops_sn2</span><span class="p">(</span><span class="n">amos_page</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;can&#39;t allow amo operations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">uncached_free_page</span><span class="p">(</span><span class="n">__IA64_UNCACHED_OFFSET</span> <span class="o">|</span>
					   <span class="n">TO_PHYS</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">amos_page</span><span class="p">),</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* clear xpc_vars_sn2 */</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">xpc_vars_sn2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_vars_sn2</span><span class="p">));</span>

	<span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">XPC_V_VERSION</span><span class="p">;</span>
	<span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">activate_IRQ_nasid</span> <span class="o">=</span> <span class="n">cpuid_to_nasid</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">activate_IRQ_phys_cpuid</span> <span class="o">=</span> <span class="n">cpu_physical_id</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">vars_part_pa</span> <span class="o">=</span> <span class="n">xp_pa</span><span class="p">(</span><span class="n">xpc_vars_part_sn2</span><span class="p">);</span>
	<span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">amos_page_pa</span> <span class="o">=</span> <span class="n">ia64_tpa</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">amos_page</span><span class="p">);</span>
	<span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">amos_page</span> <span class="o">=</span> <span class="n">amos_page</span><span class="p">;</span>	<span class="cm">/* save for next load of XPC */</span>

	<span class="cm">/* clear xpc_vars_part_sn2 */</span>
	<span class="n">memset</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">xpc_vars_part_sn2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_vars_part_sn2</span><span class="p">)</span> <span class="o">*</span>
	       <span class="n">XP_MAX_NPARTITIONS_SN2</span><span class="p">);</span>

	<span class="cm">/* initialize the activate IRQ related amo variables */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">xpc_nasid_mask_nlongs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">xpc_init_IRQ_amo_sn2</span><span class="p">(</span><span class="n">XPC_ACTIVATE_IRQ_AMOS_SN2</span> <span class="o">+</span> <span class="n">i</span><span class="p">);</span>

	<span class="cm">/* initialize the engaged remote partitions related amo variables */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">xpc_init_IRQ_amo_sn2</span><span class="p">(</span><span class="n">XPC_ENGAGED_PARTITIONS_AMO_SN2</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">xpc_init_IRQ_amo_sn2</span><span class="p">(</span><span class="n">XPC_DEACTIVATE_REQUEST_AMO_SN2</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_hb_allowed_sn2</span><span class="p">(</span><span class="kt">short</span> <span class="n">partid</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">heartbeating_to_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">test_bit</span><span class="p">(</span><span class="n">partid</span><span class="p">,</span> <span class="n">heartbeating_to_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_allow_hb_sn2</span><span class="p">(</span><span class="kt">short</span> <span class="n">partid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">xpc_vars_sn2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">set_bit</span><span class="p">(</span><span class="n">partid</span><span class="p">,</span> <span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">heartbeating_to_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_disallow_hb_sn2</span><span class="p">(</span><span class="kt">short</span> <span class="n">partid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">xpc_vars_sn2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">clear_bit</span><span class="p">(</span><span class="n">partid</span><span class="p">,</span> <span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">heartbeating_to_mask</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_disallow_all_hbs_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">xpc_vars_sn2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">heartbeating_to_mask</span><span class="p">,</span> <span class="n">xp_max_npartitions</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_increment_heartbeat_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">heartbeat</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_offline_heartbeat_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_increment_heartbeat_sn2</span><span class="p">();</span>
	<span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">heartbeat_offline</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_online_heartbeat_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_increment_heartbeat_sn2</span><span class="p">();</span>
	<span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">heartbeat_offline</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_heartbeat_init_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">xpc_vars_sn2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">bitmap_zero</span><span class="p">(</span><span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">heartbeating_to_mask</span><span class="p">,</span> <span class="n">XP_MAX_NPARTITIONS_SN2</span><span class="p">);</span>
	<span class="n">xpc_online_heartbeat_sn2</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_heartbeat_exit_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_offline_heartbeat_sn2</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_get_remote_heartbeat_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_vars_sn2</span> <span class="o">*</span><span class="n">remote_vars</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">remote_vars</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xpc_vars_sn2</span> <span class="o">*</span><span class="p">)</span><span class="n">xpc_remote_copy_buffer_sn2</span><span class="p">;</span>

	<span class="cm">/* pull the remote vars structure that contains the heartbeat */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">xp_remote_memcpy</span><span class="p">(</span><span class="n">xp_pa</span><span class="p">(</span><span class="n">remote_vars</span><span class="p">),</span>
			       <span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">remote_vars_pa</span><span class="p">,</span>
			       <span class="n">XPC_RP_VARS_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;partid=%d, heartbeat=%lld, last_heartbeat=%lld, &quot;</span>
		<span class="s">&quot;heartbeat_offline=%lld, HB_mask[0]=0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">XPC_PARTID</span><span class="p">(</span><span class="n">part</span><span class="p">),</span>
		<span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">heartbeat</span><span class="p">,</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">last_heartbeat</span><span class="p">,</span>
		<span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">heartbeat_offline</span><span class="p">,</span>
		<span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">heartbeating_to_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">heartbeat</span> <span class="o">==</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">last_heartbeat</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">heartbeat_offline</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="n">xpc_hb_allowed_sn2</span><span class="p">(</span><span class="n">sn_partition_id</span><span class="p">,</span>
				<span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">heartbeating_to_mask</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpNoHeartbeat</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">last_heartbeat</span> <span class="o">=</span> <span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">heartbeat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get a copy of the remote partition&#39;s XPC variables from the reserved page.</span>
<span class="cm"> *</span>
<span class="cm"> * remote_vars points to a buffer that is cacheline aligned for BTE copies and</span>
<span class="cm"> * assumed to be of size XPC_RP_VARS_SIZE.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_get_remote_vars_sn2</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remote_vars_pa</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">xpc_vars_sn2</span> <span class="o">*</span><span class="n">remote_vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">remote_vars_pa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">xpVarsNotSet</span><span class="p">;</span>

	<span class="cm">/* pull over the cross partition variables */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">xp_remote_memcpy</span><span class="p">(</span><span class="n">xp_pa</span><span class="p">(</span><span class="n">remote_vars</span><span class="p">),</span> <span class="n">remote_vars_pa</span><span class="p">,</span>
			       <span class="n">XPC_RP_VARS_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XPC_VERSION_MAJOR</span><span class="p">(</span><span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">)</span> <span class="o">!=</span>
	    <span class="n">XPC_VERSION_MAJOR</span><span class="p">(</span><span class="n">XPC_V_VERSION</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">xpBadVersion</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">xpSuccess</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_request_partition_activation_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_rsvd_page</span> <span class="o">*</span><span class="n">remote_rp</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remote_rp_pa</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nasid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_send_local_activate_IRQ_sn2</span><span class="p">(</span><span class="n">nasid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_request_partition_reactivation_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_send_local_activate_IRQ_sn2</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">activate_IRQ_nasid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_request_partition_deactivation_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition_sn2</span> <span class="o">*</span><span class="n">part_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_amos_page_pa</span> <span class="o">+</span>
					     <span class="p">(</span><span class="n">XPC_DEACTIVATE_REQUEST_AMO_SN2</span> <span class="o">*</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amo</span><span class="p">)));</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">irq_flags</span><span class="p">);</span>

	<span class="cm">/* set bit corresponding to our partid in remote partition&#39;s amo */</span>
	<span class="n">FETCHOP_STORE_OP</span><span class="p">(</span><span class="n">TO_AMO</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span><span class="n">variable</span><span class="p">),</span> <span class="n">FETCHOP_OR</span><span class="p">,</span>
			 <span class="n">BIT</span><span class="p">(</span><span class="n">sn_partition_id</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must always use the nofault function regardless of whether we</span>
<span class="cm">	 * are on a Shub 1.1 system or a Shub 1.2 slice 0xc processor. If we</span>
<span class="cm">	 * didn&#39;t, we&#39;d never know that the other partition is down and would</span>
<span class="cm">	 * keep sending IRQs and amos to it until the heartbeat times out.</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">xp_nofault_PIOR</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">NASID_GET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span>
							       <span class="n">variable</span><span class="p">),</span>
						     <span class="n">xp_nofault_PIOR_target</span><span class="p">));</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">irq_flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send activate IRQ to get other side to see that we&#39;ve set our</span>
<span class="cm">	 * bit in their deactivate request amo.</span>
<span class="cm">	 */</span>
	<span class="n">xpc_send_activate_IRQ_sn2</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_amos_page_pa</span><span class="p">,</span>
				  <span class="n">cnodeid_to_nasid</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
				  <span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">activate_IRQ_nasid</span><span class="p">,</span>
				  <span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">activate_IRQ_phys_cpuid</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_cancel_partition_deactivation_request_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amo</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">remote_amos_page_pa</span> <span class="o">+</span>
					     <span class="p">(</span><span class="n">XPC_DEACTIVATE_REQUEST_AMO_SN2</span> <span class="o">*</span>
					     <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">amo</span><span class="p">)));</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">irq_flags</span><span class="p">);</span>

	<span class="cm">/* clear bit corresponding to our partid in remote partition&#39;s amo */</span>
	<span class="n">FETCHOP_STORE_OP</span><span class="p">(</span><span class="n">TO_AMO</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span><span class="n">variable</span><span class="p">),</span> <span class="n">FETCHOP_AND</span><span class="p">,</span>
			 <span class="o">~</span><span class="n">BIT</span><span class="p">(</span><span class="n">sn_partition_id</span><span class="p">));</span>

	<span class="cm">/*</span>
<span class="cm">	 * We must always use the nofault function regardless of whether we</span>
<span class="cm">	 * are on a Shub 1.1 system or a Shub 1.2 slice 0xc processor. If we</span>
<span class="cm">	 * didn&#39;t, we&#39;d never know that the other partition is down and would</span>
<span class="cm">	 * keep sending IRQs and amos to it until the heartbeat times out.</span>
<span class="cm">	 */</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">xp_nofault_PIOR</span><span class="p">((</span><span class="n">u64</span> <span class="o">*</span><span class="p">)</span><span class="n">GLOBAL_MMR_ADDR</span><span class="p">(</span><span class="n">NASID_GET</span><span class="p">(</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span>
							       <span class="n">variable</span><span class="p">),</span>
						     <span class="n">xp_nofault_PIOR_target</span><span class="p">));</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">irq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_partition_deactivation_requested_sn2</span><span class="p">(</span><span class="kt">short</span> <span class="n">partid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">amo</span> <span class="o">=</span> <span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">amos_page</span> <span class="o">+</span>
			  <span class="n">XPC_DEACTIVATE_REQUEST_AMO_SN2</span><span class="p">;</span>

	<span class="cm">/* our partition&#39;s amo variable ANDed with partid mask */</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">FETCHOP_LOAD_OP</span><span class="p">(</span><span class="n">TO_AMO</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="o">&amp;</span><span class="n">amo</span><span class="o">-&gt;</span><span class="n">variable</span><span class="p">),</span> <span class="n">FETCHOP_LOAD</span><span class="p">)</span> <span class="o">&amp;</span>
		<span class="n">BIT</span><span class="p">(</span><span class="n">partid</span><span class="p">))</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Update the remote partition&#39;s info.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_update_partition_info_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="n">u8</span> <span class="n">remote_rp_version</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">remote_rp_ts_jiffies</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remote_rp_pa</span><span class="p">,</span>
			      <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remote_vars_pa</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">xpc_vars_sn2</span> <span class="o">*</span><span class="n">remote_vars</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition_sn2</span> <span class="o">*</span><span class="n">part_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>

	<span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_rp_version</span> <span class="o">=</span> <span class="n">remote_rp_version</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;  remote_rp_version = 0x%016x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_rp_version</span><span class="p">);</span>

	<span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_rp_ts_jiffies</span> <span class="o">=</span> <span class="o">*</span><span class="n">remote_rp_ts_jiffies</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;  remote_rp_ts_jiffies = 0x%016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_rp_ts_jiffies</span><span class="p">);</span>

	<span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_rp_pa</span> <span class="o">=</span> <span class="n">remote_rp_pa</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;  remote_rp_pa = 0x%016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_rp_pa</span><span class="p">);</span>

	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_vars_pa</span> <span class="o">=</span> <span class="n">remote_vars_pa</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;  remote_vars_pa = 0x%016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_vars_pa</span><span class="p">);</span>

	<span class="n">part</span><span class="o">-&gt;</span><span class="n">last_heartbeat</span> <span class="o">=</span> <span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">heartbeat</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;  last_heartbeat = 0x%016llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">last_heartbeat</span><span class="p">);</span>

	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_vars_part_pa</span> <span class="o">=</span> <span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">vars_part_pa</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;  remote_vars_part_pa = 0x%016lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_vars_part_pa</span><span class="p">);</span>

	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">activate_IRQ_nasid</span> <span class="o">=</span> <span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">activate_IRQ_nasid</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;  activate_IRQ_nasid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">activate_IRQ_nasid</span><span class="p">);</span>

	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">activate_IRQ_phys_cpuid</span> <span class="o">=</span>
	    <span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">activate_IRQ_phys_cpuid</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;  activate_IRQ_phys_cpuid = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">activate_IRQ_phys_cpuid</span><span class="p">);</span>

	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_amos_page_pa</span> <span class="o">=</span> <span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">amos_page_pa</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;  remote_amos_page_pa = 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_amos_page_pa</span><span class="p">);</span>

	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_vars_version</span> <span class="o">=</span> <span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;  remote_vars_version = 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_vars_version</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Prior code has determined the nasid which generated a activate IRQ.</span>
<span class="cm"> * Inspect that nasid to determine if its partition needs to be activated</span>
<span class="cm"> * or deactivated.</span>
<span class="cm"> *</span>
<span class="cm"> * A partition is considered &quot;awaiting activation&quot; if our partition</span>
<span class="cm"> * flags indicate it is not active and it has a heartbeat.  A</span>
<span class="cm"> * partition is considered &quot;awaiting deactivation&quot; if our partition</span>
<span class="cm"> * flags indicate it is active but it has no heartbeat or it is not</span>
<span class="cm"> * sending its heartbeat to us.</span>
<span class="cm"> *</span>
<span class="cm"> * To determine the heartbeat, the remote nasid must have a properly</span>
<span class="cm"> * initialized reserved page.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_identify_activate_IRQ_req_sn2</span><span class="p">(</span><span class="kt">int</span> <span class="n">nasid</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_rsvd_page</span> <span class="o">*</span><span class="n">remote_rp</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_vars_sn2</span> <span class="o">*</span><span class="n">remote_vars</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remote_rp_pa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remote_vars_pa</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">remote_rp_version</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reactivate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remote_rp_ts_jiffies</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">partid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_partition_sn2</span> <span class="o">*</span><span class="n">part_sn2</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* pull over the reserved page structure */</span>

	<span class="n">remote_rp</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xpc_rsvd_page</span> <span class="o">*</span><span class="p">)</span><span class="n">xpc_remote_copy_buffer_sn2</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_get_remote_rp</span><span class="p">(</span><span class="n">nasid</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">remote_rp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">remote_rp_pa</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;unable to get reserved page from nasid %d, &quot;</span>
			 <span class="s">&quot;which sent interrupt, reason=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nasid</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">remote_vars_pa</span> <span class="o">=</span> <span class="n">remote_rp</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">vars_pa</span><span class="p">;</span>
	<span class="n">remote_rp_version</span> <span class="o">=</span> <span class="n">remote_rp</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="n">remote_rp_ts_jiffies</span> <span class="o">=</span> <span class="n">remote_rp</span><span class="o">-&gt;</span><span class="n">ts_jiffies</span><span class="p">;</span>

	<span class="n">partid</span> <span class="o">=</span> <span class="n">remote_rp</span><span class="o">-&gt;</span><span class="n">SAL_partid</span><span class="p">;</span>
	<span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">];</span>
	<span class="n">part_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>

	<span class="cm">/* pull over the cross partition variables */</span>

	<span class="n">remote_vars</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xpc_vars_sn2</span> <span class="o">*</span><span class="p">)</span><span class="n">xpc_remote_copy_buffer_sn2</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_get_remote_vars_sn2</span><span class="p">(</span><span class="n">remote_vars_pa</span><span class="p">,</span> <span class="n">remote_vars</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;unable to get XPC variables from nasid %d, &quot;</span>
			 <span class="s">&quot;which sent interrupt, reason=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nasid</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

		<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">part</span><span class="o">-&gt;</span><span class="n">activate_IRQ_rcvd</span><span class="o">++</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;partid for nasid %d is %d; IRQs = %d; HB = &quot;</span>
		<span class="s">&quot;%lld:0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">nasid</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">partid</span><span class="p">,</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">activate_IRQ_rcvd</span><span class="p">,</span>
		<span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">heartbeat</span><span class="p">,</span> <span class="n">remote_vars</span><span class="o">-&gt;</span><span class="n">heartbeating_to_mask</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpc_partition_disengaged</span><span class="p">(</span><span class="n">part</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">==</span> <span class="n">XPC_P_AS_INACTIVE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">xpc_update_partition_info_sn2</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">remote_rp_version</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">remote_rp_ts_jiffies</span><span class="p">,</span>
					      <span class="n">remote_rp_pa</span><span class="p">,</span> <span class="n">remote_vars_pa</span><span class="p">,</span>
					      <span class="n">remote_vars</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xpc_partition_deactivation_requested_sn2</span><span class="p">(</span><span class="n">partid</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Other side is waiting on us to deactivate even though</span>
<span class="cm">			 * we already have.</span>
<span class="cm">			 */</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">xpc_activate_partition</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_rp_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_vars_version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">remote_rp_ts_jiffies</span> <span class="o">!=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_rp_ts_jiffies</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* the other side rebooted */</span>

		<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">xpc_partition_engaged_sn2</span><span class="p">(</span><span class="n">partid</span><span class="p">));</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">xpc_partition_deactivation_requested_sn2</span><span class="p">(</span><span class="n">partid</span><span class="p">));</span>

		<span class="n">xpc_update_partition_info_sn2</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">remote_rp_version</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">remote_rp_ts_jiffies</span><span class="p">,</span>
					      <span class="n">remote_rp_pa</span><span class="p">,</span> <span class="n">remote_vars_pa</span><span class="p">,</span>
					      <span class="n">remote_vars</span><span class="p">);</span>
		<span class="n">reactivate</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">disengage_timeout</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">xpc_partition_disengaged</span><span class="p">(</span><span class="n">part</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* still waiting on other side to disengage from us */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">reactivate</span><span class="p">)</span>
		<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">xpReactivating</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">xpc_partition_deactivation_requested_sn2</span><span class="p">(</span><span class="n">partid</span><span class="p">))</span>
		<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">xpOtherGoingDown</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Loop through the activation amo variables and process any bits</span>
<span class="cm"> * which are set.  Each bit indicates a nasid sending a partition</span>
<span class="cm"> * activation or deactivation request.</span>
<span class="cm"> *</span>
<span class="cm"> * Return #of IRQs detected.</span>
<span class="cm"> */</span>
<span class="kt">int</span>
<span class="nf">xpc_identify_activate_IRQ_sender_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">l</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">b</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nasid_mask_long</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">nasid</span><span class="p">;</span>		<span class="cm">/* remote nasid */</span>
	<span class="kt">int</span> <span class="n">n_IRQs_detected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="n">act_amos</span><span class="p">;</span>

	<span class="n">act_amos</span> <span class="o">=</span> <span class="n">xpc_vars_sn2</span><span class="o">-&gt;</span><span class="n">amos_page</span> <span class="o">+</span> <span class="n">XPC_ACTIVATE_IRQ_AMOS_SN2</span><span class="p">;</span>

	<span class="cm">/* scan through activate amo variables looking for non-zero entries */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">l</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">l</span> <span class="o">&lt;</span> <span class="n">xpc_nasid_mask_nlongs</span><span class="p">;</span> <span class="n">l</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xpc_exiting</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">nasid_mask_long</span> <span class="o">=</span> <span class="n">xpc_receive_IRQ_amo_sn2</span><span class="p">(</span><span class="o">&amp;</span><span class="n">act_amos</span><span class="p">[</span><span class="n">l</span><span class="p">]);</span>

		<span class="n">b</span> <span class="o">=</span> <span class="n">find_first_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nasid_mask_long</span><span class="p">,</span> <span class="n">BITS_PER_LONG</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">b</span> <span class="o">&gt;=</span> <span class="n">BITS_PER_LONG</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* no IRQs from nasids in this amo variable */</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;amo[%d] gave back 0x%lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span>
			<span class="n">nasid_mask_long</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If this nasid has been added to the machine since</span>
<span class="cm">		 * our partition was reset, this will retain the</span>
<span class="cm">		 * remote nasid in our reserved pages machine mask.</span>
<span class="cm">		 * This is used in the event of module reload.</span>
<span class="cm">		 */</span>
		<span class="n">xpc_mach_nasids</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">|=</span> <span class="n">nasid_mask_long</span><span class="p">;</span>

		<span class="cm">/* locate the nasid(s) which sent interrupts */</span>

		<span class="k">do</span> <span class="p">{</span>
			<span class="n">n_IRQs_detected</span><span class="o">++</span><span class="p">;</span>
			<span class="n">nasid</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span> <span class="o">*</span> <span class="n">BITS_PER_LONG</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;interrupt from nasid %lld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nasid</span><span class="p">);</span>
			<span class="n">xpc_identify_activate_IRQ_req_sn2</span><span class="p">(</span><span class="n">nasid</span><span class="p">);</span>

			<span class="n">b</span> <span class="o">=</span> <span class="n">find_next_bit</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nasid_mask_long</span><span class="p">,</span> <span class="n">BITS_PER_LONG</span><span class="p">,</span>
					  <span class="n">b</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">b</span> <span class="o">&lt;</span> <span class="n">BITS_PER_LONG</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">n_IRQs_detected</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_process_activate_IRQ_rcvd_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_IRQs_expected</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">n_IRQs_detected</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">n_IRQs_expected</span> <span class="o">=</span> <span class="n">xpc_activate_IRQ_rcvd</span><span class="p">;</span>
	<span class="n">xpc_activate_IRQ_rcvd</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_activate_IRQ_rcvd_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

	<span class="n">n_IRQs_detected</span> <span class="o">=</span> <span class="n">xpc_identify_activate_IRQ_sender_sn2</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">n_IRQs_detected</span> <span class="o">&lt;</span> <span class="n">n_IRQs_expected</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* retry once to help avoid missing amo */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">xpc_identify_activate_IRQ_sender_sn2</span><span class="p">();</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Setup the channel structures that are sn2 specific.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_setup_ch_structures_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition_sn2</span> <span class="o">*</span><span class="n">part_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_channel_sn2</span> <span class="o">*</span><span class="n">ch_sn2</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cpuid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_number</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timer_list</span> <span class="o">*</span><span class="n">timer</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">partid</span> <span class="o">=</span> <span class="n">XPC_PARTID</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>

	<span class="cm">/* allocate all the required GET/PUT values */</span>

	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_GPs</span> <span class="o">=</span>
	    <span class="n">xpc_kzalloc_cacheline_aligned</span><span class="p">(</span><span class="n">XPC_GP_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_GPs_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_GPs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;can&#39;t get memory for local get/put &quot;</span>
			<span class="s">&quot;values</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">xpNoMemory</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_GPs</span> <span class="o">=</span>
	    <span class="n">xpc_kzalloc_cacheline_aligned</span><span class="p">(</span><span class="n">XPC_GP_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
					  <span class="o">&amp;</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_GPs_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_GPs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;can&#39;t get memory for remote get/put &quot;</span>
			<span class="s">&quot;values</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">xpNoMemory</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_GPs_pa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* allocate all the required open and close args */</span>

	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_openclose_args</span> <span class="o">=</span>
	    <span class="n">xpc_kzalloc_cacheline_aligned</span><span class="p">(</span><span class="n">XPC_OPENCLOSE_ARGS_SIZE</span><span class="p">,</span>
					  <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">part_sn2</span><span class="o">-&gt;</span>
					  <span class="n">local_openclose_args_base</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_openclose_args</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;can&#39;t get memory for local connect args</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">xpNoMemory</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_openclose_args_pa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_chctl_amo_va</span> <span class="o">=</span> <span class="n">xpc_init_IRQ_amo_sn2</span><span class="p">(</span><span class="n">partid</span><span class="p">);</span>

	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">notify_IRQ_nasid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">notify_IRQ_phys_cpuid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_chctl_amo_va</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">notify_IRQ_owner</span><span class="p">,</span> <span class="s">&quot;xpc%02d&quot;</span><span class="p">,</span> <span class="n">partid</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">SGI_XPC_NOTIFY</span><span class="p">,</span> <span class="n">xpc_handle_notify_IRQ_sn2</span><span class="p">,</span>
			  <span class="n">IRQF_SHARED</span><span class="p">,</span> <span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">notify_IRQ_owner</span><span class="p">,</span>
			  <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">u64</span><span class="p">)</span><span class="n">partid</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;can&#39;t register NOTIFY IRQ handler, &quot;</span>
			<span class="s">&quot;errno=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ret</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">xpLackOfResources</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Setup a timer to check for dropped notify IRQs */</span>
	<span class="n">timer</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">dropped_notify_IRQ_timer</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">function</span> <span class="o">=</span>
	    <span class="p">(</span><span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">))</span><span class="n">xpc_check_for_dropped_notify_IRQ_sn2</span><span class="p">;</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">part</span><span class="p">;</span>
	<span class="n">timer</span><span class="o">-&gt;</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">XPC_DROPPED_NOTIFY_IRQ_WAIT_INTERVAL</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="n">timer</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ch_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch_number</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">nchannels</span><span class="p">;</span> <span class="n">ch_number</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_number</span><span class="p">].</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>

		<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_GP</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_GPs</span><span class="p">[</span><span class="n">ch_number</span><span class="p">];</span>
		<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_openclose_args</span> <span class="o">=</span>
		    <span class="o">&amp;</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_openclose_args</span><span class="p">[</span><span class="n">ch_number</span><span class="p">];</span>

		<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">msg_to_pull_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Setup the per partition specific variables required by the</span>
<span class="cm">	 * remote partition to establish channel connections with us.</span>
<span class="cm">	 *</span>
<span class="cm">	 * The setting of the magic # indicates that these per partition</span>
<span class="cm">	 * specific variables are ready to be used.</span>
<span class="cm">	 */</span>
	<span class="n">xpc_vars_part_sn2</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">GPs_pa</span> <span class="o">=</span> <span class="n">xp_pa</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_GPs</span><span class="p">);</span>
	<span class="n">xpc_vars_part_sn2</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">openclose_args_pa</span> <span class="o">=</span>
	    <span class="n">xp_pa</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_openclose_args</span><span class="p">);</span>
	<span class="n">xpc_vars_part_sn2</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">chctl_amo_pa</span> <span class="o">=</span>
	    <span class="n">xp_pa</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_chctl_amo_va</span><span class="p">);</span>
	<span class="n">cpuid</span> <span class="o">=</span> <span class="n">raw_smp_processor_id</span><span class="p">();</span>	<span class="cm">/* any CPU in this partition will do */</span>
	<span class="n">xpc_vars_part_sn2</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">notify_IRQ_nasid</span> <span class="o">=</span> <span class="n">cpuid_to_nasid</span><span class="p">(</span><span class="n">cpuid</span><span class="p">);</span>
	<span class="n">xpc_vars_part_sn2</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">notify_IRQ_phys_cpuid</span> <span class="o">=</span>
	    <span class="n">cpu_physical_id</span><span class="p">(</span><span class="n">cpuid</span><span class="p">);</span>
	<span class="n">xpc_vars_part_sn2</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">nchannels</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">nchannels</span><span class="p">;</span>
	<span class="n">xpc_vars_part_sn2</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">magic</span> <span class="o">=</span> <span class="n">XPC_VP_MAGIC1_SN2</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">xpSuccess</span><span class="p">;</span>

	<span class="cm">/* setup of ch structures failed */</span>
<span class="nl">out_3:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_openclose_args_base</span><span class="p">);</span>
	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_openclose_args</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out_2:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_GPs_base</span><span class="p">);</span>
	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_GPs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="nl">out_1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_GPs_base</span><span class="p">);</span>
	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_GPs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Teardown the channel structures that are sn2 specific.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_teardown_ch_structures_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition_sn2</span> <span class="o">*</span><span class="n">part_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">partid</span> <span class="o">=</span> <span class="n">XPC_PARTID</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Indicate that the variables specific to the remote partition are no</span>
<span class="cm">	 * longer available for its use.</span>
<span class="cm">	 */</span>
	<span class="n">xpc_vars_part_sn2</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">magic</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* in case we&#39;ve still got outstanding timers registered... */</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">dropped_notify_IRQ_timer</span><span class="p">);</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">SGI_XPC_NOTIFY</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">u64</span><span class="p">)</span><span class="n">partid</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_openclose_args_base</span><span class="p">);</span>
	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_openclose_args</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_GPs_base</span><span class="p">);</span>
	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_GPs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_GPs_base</span><span class="p">);</span>
	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_GPs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">local_chctl_amo_va</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Create a wrapper that hides the underlying mechanism for pulling a cacheline</span>
<span class="cm"> * (or multiple cachelines) from a remote partition.</span>
<span class="cm"> *</span>
<span class="cm"> * src_pa must be a cacheline aligned physical address on the remote partition.</span>
<span class="cm"> * dst must be a cacheline aligned virtual address on this partition.</span>
<span class="cm"> * cnt must be cacheline sized</span>
<span class="cm"> */</span>
<span class="cm">/* ??? Replace this function by call to xp_remote_memcpy() or bte_copy()? */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_pull_remote_cachelines_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dst</span><span class="p">,</span>
			       <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src_pa</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">cnt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">src_pa</span> <span class="o">!=</span> <span class="n">L1_CACHE_ALIGN</span><span class="p">(</span><span class="n">src_pa</span><span class="p">));</span>
	<span class="n">DBUG_ON</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dst</span> <span class="o">!=</span> <span class="n">L1_CACHE_ALIGN</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dst</span><span class="p">));</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">cnt</span> <span class="o">!=</span> <span class="n">L1_CACHE_ALIGN</span><span class="p">(</span><span class="n">cnt</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">==</span> <span class="n">XPC_P_AS_DEACTIVATING</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xp_remote_memcpy</span><span class="p">(</span><span class="n">xp_pa</span><span class="p">(</span><span class="n">dst</span><span class="p">),</span> <span class="n">src_pa</span><span class="p">,</span> <span class="n">cnt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;xp_remote_memcpy() from partition %d failed,&quot;</span>
			<span class="s">&quot; ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">XPC_PARTID</span><span class="p">(</span><span class="n">part</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Pull the remote per partition specific variables from the specified</span>
<span class="cm"> * partition.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_pull_remote_vars_part_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition_sn2</span> <span class="o">*</span><span class="n">part_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">buffer</span><span class="p">[</span><span class="n">L1_CACHE_BYTES</span> <span class="o">*</span> <span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xpc_vars_part_sn2</span> <span class="o">*</span><span class="n">pulled_entry_cacheline</span> <span class="o">=</span>
	    <span class="p">(</span><span class="k">struct</span> <span class="n">xpc_vars_part_sn2</span> <span class="o">*</span><span class="p">)</span><span class="n">L1_CACHE_ALIGN</span><span class="p">((</span><span class="n">u64</span><span class="p">)</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">xpc_vars_part_sn2</span> <span class="o">*</span><span class="n">pulled_entry</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remote_entry_cacheline_pa</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remote_entry_pa</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">partid</span> <span class="o">=</span> <span class="n">XPC_PARTID</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* pull the cacheline that contains the variables we&#39;re interested in */</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_vars_part_pa</span> <span class="o">!=</span>
		<span class="n">L1_CACHE_ALIGN</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_vars_part_pa</span><span class="p">));</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_vars_part_sn2</span><span class="p">)</span> <span class="o">!=</span> <span class="n">L1_CACHE_BYTES</span> <span class="o">/</span> <span class="mi">2</span><span class="p">);</span>

	<span class="n">remote_entry_pa</span> <span class="o">=</span> <span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_vars_part_pa</span> <span class="o">+</span>
	    <span class="n">sn_partition_id</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_vars_part_sn2</span><span class="p">);</span>

	<span class="n">remote_entry_cacheline_pa</span> <span class="o">=</span> <span class="p">(</span><span class="n">remote_entry_pa</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">L1_CACHE_BYTES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">pulled_entry</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xpc_vars_part_sn2</span> <span class="o">*</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">pulled_entry_cacheline</span>
						    <span class="o">+</span> <span class="p">(</span><span class="n">remote_entry_pa</span> <span class="o">&amp;</span>
						    <span class="p">(</span><span class="n">L1_CACHE_BYTES</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_pull_remote_cachelines_sn2</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">pulled_entry_cacheline</span><span class="p">,</span>
					     <span class="n">remote_entry_cacheline_pa</span><span class="p">,</span>
					     <span class="n">L1_CACHE_BYTES</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;failed to pull XPC vars_part from &quot;</span>
			<span class="s">&quot;partition %d, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">partid</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* see if they&#39;ve been set up yet */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">XPC_VP_MAGIC1_SN2</span> <span class="o">&amp;&amp;</span>
	    <span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="n">XPC_VP_MAGIC2_SN2</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;partition %d&#39;s XPC vars_part for &quot;</span>
				<span class="s">&quot;partition %d has bad magic value (=0x%llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">partid</span><span class="p">,</span> <span class="n">sn_partition_id</span><span class="p">,</span> <span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">magic</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">xpBadMagic</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* they&#39;ve not been initialized yet */</span>
		<span class="k">return</span> <span class="n">xpRetry</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpc_vars_part_sn2</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">magic</span> <span class="o">==</span> <span class="n">XPC_VP_MAGIC1_SN2</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* validate the variables */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">GPs_pa</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">openclose_args_pa</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">chctl_amo_pa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;partition %d&#39;s XPC vars_part for &quot;</span>
				<span class="s">&quot;partition %d are not valid</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">partid</span><span class="p">,</span>
				<span class="n">sn_partition_id</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">xpInvalidAddress</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* the variables we imported look to be valid */</span>

		<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_GPs_pa</span> <span class="o">=</span> <span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">GPs_pa</span><span class="p">;</span>
		<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_openclose_args_pa</span> <span class="o">=</span>
		    <span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">openclose_args_pa</span><span class="p">;</span>
		<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_chctl_amo_va</span> <span class="o">=</span>
		    <span class="p">(</span><span class="k">struct</span> <span class="n">amo</span> <span class="o">*</span><span class="p">)</span><span class="n">__va</span><span class="p">(</span><span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">chctl_amo_pa</span><span class="p">);</span>
		<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">notify_IRQ_nasid</span> <span class="o">=</span> <span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">notify_IRQ_nasid</span><span class="p">;</span>
		<span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">notify_IRQ_phys_cpuid</span> <span class="o">=</span>
		    <span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">notify_IRQ_phys_cpuid</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">nchannels</span> <span class="o">&gt;</span> <span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">nchannels</span><span class="p">)</span>
			<span class="n">part</span><span class="o">-&gt;</span><span class="n">nchannels</span> <span class="o">=</span> <span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">nchannels</span><span class="p">;</span>

		<span class="cm">/* let the other side know that we&#39;ve pulled their variables */</span>

		<span class="n">xpc_vars_part_sn2</span><span class="p">[</span><span class="n">partid</span><span class="p">].</span><span class="n">magic</span> <span class="o">=</span> <span class="n">XPC_VP_MAGIC2_SN2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pulled_entry</span><span class="o">-&gt;</span><span class="n">magic</span> <span class="o">==</span> <span class="n">XPC_VP_MAGIC1_SN2</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">xpRetry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">xpSuccess</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Establish first contact with the remote partititon. This involves pulling</span>
<span class="cm"> * the XPC per partition variables from the remote partition and waiting for</span>
<span class="cm"> * the remote partition to pull ours.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_make_first_contact_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition_sn2</span> <span class="o">*</span><span class="n">part_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Register the remote partition&#39;s amos with SAL so it can handle</span>
<span class="cm">	 * and cleanup errors within that address range should the remote</span>
<span class="cm">	 * partition go down. We don&#39;t unregister this range because it is</span>
<span class="cm">	 * difficult to tell when outstanding writes to the remote partition</span>
<span class="cm">	 * are finished and thus when it is safe to unregister. This should</span>
<span class="cm">	 * not result in wasted space in the SAL xp_addr_region table because</span>
<span class="cm">	 * we should get the same page for remote_amos_page_pa after module</span>
<span class="cm">	 * reloads and system reboots.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sn_register_xp_addr_region</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_amos_page_pa</span><span class="p">,</span>
				       <span class="n">PAGE_SIZE</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;xpc_activating(%d) failed to register &quot;</span>
			 <span class="s">&quot;xp_addr region</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">XPC_PARTID</span><span class="p">(</span><span class="n">part</span><span class="p">));</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpPhysAddrRegFailed</span><span class="p">;</span>
		<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Send activate IRQ to get other side to activate if they&#39;ve not</span>
<span class="cm">	 * already begun to do so.</span>
<span class="cm">	 */</span>
	<span class="n">xpc_send_activate_IRQ_sn2</span><span class="p">(</span><span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_amos_page_pa</span><span class="p">,</span>
				  <span class="n">cnodeid_to_nasid</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
				  <span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">activate_IRQ_nasid</span><span class="p">,</span>
				  <span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">activate_IRQ_phys_cpuid</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">((</span><span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_pull_remote_vars_part_sn2</span><span class="p">(</span><span class="n">part</span><span class="p">))</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpRetry</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;waiting to make first contact with &quot;</span>
			<span class="s">&quot;partition %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">XPC_PARTID</span><span class="p">(</span><span class="n">part</span><span class="p">));</span>

		<span class="cm">/* wait a 1/4 of a second or so */</span>
		<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">250</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">==</span> <span class="n">XPC_P_AS_DEACTIVATING</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">xpSuccess</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the chctl flags and pull the openclose args and/or remote GPs as needed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">u64</span>
<span class="nf">xpc_get_chctl_all_flags_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition_sn2</span> <span class="o">*</span><span class="n">part_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">xpc_channel_ctl_flags</span> <span class="n">chctl</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * See if there are any chctl flags to be handled.</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="n">chctl</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpc_any_openclose_chctl_flags_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chctl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_pull_remote_cachelines_sn2</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">part</span><span class="o">-&gt;</span>
						     <span class="n">remote_openclose_args</span><span class="p">,</span>
						     <span class="n">part_sn2</span><span class="o">-&gt;</span>
						     <span class="n">remote_openclose_args_pa</span><span class="p">,</span>
						     <span class="n">XPC_OPENCLOSE_ARGS_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;failed to pull openclose args from &quot;</span>
				<span class="s">&quot;partition %d, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">XPC_PARTID</span><span class="p">(</span><span class="n">part</span><span class="p">),</span>
				<span class="n">ret</span><span class="p">);</span>

			<span class="cm">/* don&#39;t bother processing chctl flags anymore */</span>
			<span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpc_any_msg_chctl_flags_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chctl</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_pull_remote_cachelines_sn2</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_GPs</span><span class="p">,</span>
						     <span class="n">part_sn2</span><span class="o">-&gt;</span><span class="n">remote_GPs_pa</span><span class="p">,</span>
						     <span class="n">XPC_GP_SIZE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;failed to pull GPs from partition &quot;</span>
				<span class="s">&quot;%d, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">XPC_PARTID</span><span class="p">(</span><span class="n">part</span><span class="p">),</span> <span class="n">ret</span><span class="p">);</span>

			<span class="cm">/* don&#39;t bother processing chctl flags anymore */</span>
			<span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate the local message queue and the notify queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_allocate_local_msgqueue_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_sn2</span> <span class="o">*</span><span class="n">ch_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nentries</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">nentries</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">;</span> <span class="n">nentries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nentries</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">nbytes</span> <span class="o">=</span> <span class="n">nentries</span> <span class="o">*</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>
		<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_msgqueue</span> <span class="o">=</span>
		    <span class="n">xpc_kzalloc_cacheline_aligned</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span>
						  <span class="o">&amp;</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_msgqueue_base</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_msgqueue</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">nbytes</span> <span class="o">=</span> <span class="n">nentries</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_notify_sn2</span><span class="p">);</span>
		<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">notify_queue</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">notify_queue</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_msgqueue_base</span><span class="p">);</span>
			<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_msgqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nentries</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;nentries=%d local_nentries=%d, &quot;</span>
				<span class="s">&quot;partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nentries</span><span class="p">,</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span> <span class="o">=</span> <span class="n">nentries</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">xpSuccess</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;can&#39;t get memory for local message queue and notify &quot;</span>
		<span class="s">&quot;queue, partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">xpNoMemory</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate the cached remote message queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_allocate_remote_msgqueue_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_sn2</span> <span class="o">*</span><span class="n">ch_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nentries</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">nbytes</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">nentries</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">;</span> <span class="n">nentries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">nentries</span><span class="o">--</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">nbytes</span> <span class="o">=</span> <span class="n">nentries</span> <span class="o">*</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>
		<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_msgqueue</span> <span class="o">=</span>
		    <span class="n">xpc_kzalloc_cacheline_aligned</span><span class="p">(</span><span class="n">nbytes</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ch_sn2</span><span class="o">-&gt;</span>
						  <span class="n">remote_msgqueue_base</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_msgqueue</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">nentries</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;nentries=%d remote_nentries=%d, &quot;</span>
				<span class="s">&quot;partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nentries</span><span class="p">,</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span> <span class="o">=</span> <span class="n">nentries</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">xpSuccess</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;can&#39;t get memory for cached remote message queue, &quot;</span>
		<span class="s">&quot;partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">xpNoMemory</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate message queues and other stuff associated with a channel.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: Assumes all of the channel sizes are filled in.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_setup_msg_structures_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_sn2</span> <span class="o">*</span><span class="n">ch_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_SETUP</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_allocate_local_msgqueue_sn2</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_allocate_remote_msgqueue_sn2</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_msgqueue_base</span><span class="p">);</span>
			<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_msgqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">notify_queue</span><span class="p">);</span>
			<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">notify_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Free up message queues and other stuff that were allocated for the specified</span>
<span class="cm"> * channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_teardown_msg_structures_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_sn2</span> <span class="o">*</span><span class="n">ch_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">spin_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">));</span>

	<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_msgqueue_pa</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_GP</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_GP</span><span class="o">-&gt;</span><span class="n">put</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_GP</span><span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_GP</span><span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_local_GP</span><span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_local_GP</span><span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">next_msg_to_pull</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_SETUP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;ch-&gt;flags=0x%x, partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="n">kfree</span><span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_msgqueue_base</span><span class="p">);</span>
		<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_msgqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_msgqueue_base</span><span class="p">);</span>
		<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_msgqueue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">notify_queue</span><span class="p">);</span>
		<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">notify_queue</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Notify those who wanted to be notified upon delivery of their message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_notify_senders_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">reason</span><span class="p">,</span> <span class="n">s64</span> <span class="n">put</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_notify_sn2</span> <span class="o">*</span><span class="n">notify</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">notify_type</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">get</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">get</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">get</span> <span class="o">&lt;</span> <span class="n">put</span> <span class="o">&amp;&amp;</span> <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_to_notify</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">notify</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">notify_queue</span><span class="p">[</span><span class="n">get</span> <span class="o">%</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		 * See if the notify entry indicates it was associated with</span>
<span class="cm">		 * a message who&#39;s sender wants to be notified. It is possible</span>
<span class="cm">		 * that it is, but someone else is doing or has done the</span>
<span class="cm">		 * notification.</span>
<span class="cm">		 */</span>
		<span class="n">notify_type</span> <span class="o">=</span> <span class="n">notify</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">notify_type</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
		    <span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notify</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">notify_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">!=</span> <span class="n">notify_type</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">notify_type</span> <span class="o">!=</span> <span class="n">XPC_N_CALL</span><span class="p">);</span>

		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_to_notify</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">notify</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;notify-&gt;func() called, notify=0x%p &quot;</span>
				<span class="s">&quot;msg_number=%lld partid=%d channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">notify</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

			<span class="n">notify</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
				     <span class="n">notify</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;notify-&gt;func() returned, notify=0x%p&quot;</span>
				<span class="s">&quot; msg_number=%lld partid=%d channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">notify</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_notify_senders_of_disconnect_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">xpc_notify_senders_sn2</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">w_local_GP</span><span class="p">.</span><span class="n">put</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clear some of the msg flags in the local message queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">xpc_clear_local_msgqueue_flags_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_sn2</span> <span class="o">*</span><span class="n">ch_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">get</span><span class="p">;</span>

	<span class="n">get</span> <span class="o">=</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">get</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_msgqueue</span> <span class="o">+</span>
					     <span class="p">(</span><span class="n">get</span> <span class="o">%</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">)</span> <span class="o">*</span>
					     <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">);</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_M_SN2_READY</span><span class="p">));</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">get</span> <span class="o">&lt;</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_GP</span><span class="p">.</span><span class="n">get</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Clear some of the msg flags in the remote message queue.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span>
<span class="nf">xpc_clear_remote_msgqueue_flags_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_sn2</span> <span class="o">*</span><span class="n">ch_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">put</span><span class="p">,</span> <span class="n">remote_nentries</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">;</span>

	<span class="cm">/* flags are zeroed when the buffer is allocated */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_GP</span><span class="p">.</span><span class="n">put</span> <span class="o">&lt;</span> <span class="n">remote_nentries</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">put</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">put</span><span class="p">,</span> <span class="n">remote_nentries</span><span class="p">);</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_msgqueue</span> <span class="o">+</span>
					     <span class="p">(</span><span class="n">put</span> <span class="o">%</span> <span class="n">remote_nentries</span><span class="p">)</span> <span class="o">*</span>
					     <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">);</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_M_SN2_READY</span><span class="p">));</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_M_SN2_DONE</span><span class="p">));</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">put</span> <span class="o">-</span> <span class="n">remote_nentries</span><span class="p">);</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">++</span><span class="n">put</span> <span class="o">&lt;</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_GP</span><span class="p">.</span><span class="n">put</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">xpc_n_of_deliverable_payloads_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">put</span> <span class="o">-</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">w_local_GP</span><span class="p">.</span><span class="n">get</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_process_msg_chctl_flags_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_number</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xpc_channel_sn2</span> <span class="o">*</span><span class="n">ch_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">npayloads_sent</span><span class="p">;</span>

	<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_GP</span> <span class="o">=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">remote_GPs</span><span class="p">[</span><span class="n">ch_number</span><span class="p">];</span>

	<span class="cm">/* See what, if anything, has changed for each connected channel */</span>

	<span class="n">xpc_msgqueue_ref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">get</span> <span class="o">==</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_GP</span><span class="p">.</span><span class="n">get</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">put</span> <span class="o">==</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_GP</span><span class="p">.</span><span class="n">put</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* nothing changed since GPs were last pulled */</span>
		<span class="n">xpc_msgqueue_deref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">xpc_msgqueue_deref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * First check to see if messages recently sent by us have been</span>
<span class="cm">	 * received by the other side. (The remote GET value will have</span>
<span class="cm">	 * changed since we last looked at it.)</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">get</span> <span class="o">!=</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_GP</span><span class="p">.</span><span class="n">get</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * We need to notify any senders that want to be notified</span>
<span class="cm">		 * that their sent messages have been received by their</span>
<span class="cm">		 * intended recipients. We need to do this before updating</span>
<span class="cm">		 * w_remote_GP.get so that we don&#39;t allocate the same message</span>
<span class="cm">		 * queue entries prematurely (see xpc_allocate_msg()).</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_to_notify</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Notify senders that messages sent have been</span>
<span class="cm">			 * received and delivered by the other side.</span>
<span class="cm">			 */</span>
			<span class="n">xpc_notify_senders_sn2</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">xpMsgDelivered</span><span class="p">,</span>
					       <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_GP</span><span class="p">.</span><span class="n">get</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Clear msg-&gt;flags in previously sent messages, so that</span>
<span class="cm">		 * they&#39;re ready for xpc_allocate_msg().</span>
<span class="cm">		 */</span>
		<span class="n">xpc_clear_local_msgqueue_flags_sn2</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

		<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">get</span> <span class="o">=</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_GP</span><span class="p">.</span><span class="n">get</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;w_remote_GP.get changed to %lld, partid=%d, &quot;</span>
			<span class="s">&quot;channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">get</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If anyone was waiting for message queue entries to become</span>
<span class="cm">		 * available, wake them up.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_on_msg_allocate_wq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">msg_allocate_wq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Now check for newly sent messages by the other side. (The remote</span>
<span class="cm">	 * PUT value will have changed since we last looked at it.)</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">put</span> <span class="o">!=</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_GP</span><span class="p">.</span><span class="n">put</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Clear msg-&gt;flags in previously received messages, so that</span>
<span class="cm">		 * they&#39;re ready for xpc_get_deliverable_payload_sn2().</span>
<span class="cm">		 */</span>
		<span class="n">xpc_clear_remote_msgqueue_flags_sn2</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

		<span class="n">smp_wmb</span><span class="p">();</span> <span class="cm">/* ensure flags have been cleared before bte_copy */</span>
		<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">put</span> <span class="o">=</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_GP</span><span class="p">.</span><span class="n">put</span><span class="p">;</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;w_remote_GP.put changed to %lld, partid=%d, &quot;</span>
			<span class="s">&quot;channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">put</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="n">npayloads_sent</span> <span class="o">=</span> <span class="n">xpc_n_of_deliverable_payloads_sn2</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">npayloads_sent</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;msgs waiting to be copied and &quot;</span>
				<span class="s">&quot;delivered=%d, partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">npayloads_sent</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTEDCALLOUT_MADE</span><span class="p">)</span>
				<span class="n">xpc_activate_kthreads</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">npayloads_sent</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">xpc_msgqueue_deref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span>
<span class="nf">xpc_pull_remote_msg_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">s64</span> <span class="n">get</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xpc_channel_sn2</span> <span class="o">*</span><span class="n">ch_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">remote_msg_pa</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">msg_index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">nmsgs</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">msg_offset</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">msg_to_pull_mutex</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we were interrupted by a signal */</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">get</span> <span class="o">&gt;=</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">next_msg_to_pull</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* pull as many messages as are ready and able to be pulled */</span>

		<span class="n">msg_index</span> <span class="o">=</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">next_msg_to_pull</span> <span class="o">%</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">;</span>

		<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">next_msg_to_pull</span> <span class="o">&gt;=</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">put</span><span class="p">);</span>
		<span class="n">nmsgs</span> <span class="o">=</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">put</span> <span class="o">-</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">next_msg_to_pull</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">msg_index</span> <span class="o">+</span> <span class="n">nmsgs</span> <span class="o">&gt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* ignore the ones that wrap the msg queue for now */</span>
			<span class="n">nmsgs</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span> <span class="o">-</span> <span class="n">msg_index</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">msg_offset</span> <span class="o">=</span> <span class="n">msg_index</span> <span class="o">*</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>
		<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_msgqueue</span> <span class="o">+</span>
		    <span class="n">msg_offset</span><span class="p">);</span>
		<span class="n">remote_msg_pa</span> <span class="o">=</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_msgqueue_pa</span> <span class="o">+</span> <span class="n">msg_offset</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_pull_remote_cachelines_sn2</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">remote_msg_pa</span><span class="p">,</span>
						     <span class="n">nmsgs</span> <span class="o">*</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;failed to pull %d msgs starting with&quot;</span>
				<span class="s">&quot; msg %lld from partition %d, channel=%d, &quot;</span>
				<span class="s">&quot;ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nmsgs</span><span class="p">,</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">next_msg_to_pull</span><span class="p">,</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

			<span class="n">XPC_DEACTIVATE_PARTITION</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">msg_to_pull_mutex</span><span class="p">);</span>
			<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">next_msg_to_pull</span> <span class="o">+=</span> <span class="n">nmsgs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">msg_to_pull_mutex</span><span class="p">);</span>

	<span class="cm">/* return the message we were looking for */</span>
	<span class="n">msg_offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">get</span> <span class="o">%</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">)</span> <span class="o">*</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">remote_msgqueue</span> <span class="o">+</span> <span class="n">msg_offset</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">msg</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get the next deliverable message&#39;s payload.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="o">*</span>
<span class="nf">xpc_get_deliverable_payload_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_sn2</span> <span class="o">*</span><span class="n">ch_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">payload</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">get</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">get</span> <span class="o">=</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_local_GP</span><span class="p">.</span><span class="n">get</span><span class="p">;</span>
		<span class="n">smp_rmb</span><span class="p">();</span>	<span class="cm">/* guarantee that .get loads before .put */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get</span> <span class="o">==</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">put</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="cm">/* There are messages waiting to be pulled and delivered.</span>
<span class="cm">		 * We need to try to secure one for ourselves. We&#39;ll do this</span>
<span class="cm">		 * by trying to increment w_local_GP.get and hope that no one</span>
<span class="cm">		 * else beats us to it. If they do, we&#39;ll we&#39;ll simply have</span>
<span class="cm">		 * to try again for the next one.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_local_GP</span><span class="p">.</span><span class="n">get</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">get</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="n">get</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we got the entry referenced by get */</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;w_local_GP.get changed to %lld, &quot;</span>
				<span class="s">&quot;partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

			<span class="cm">/* pull the message from the remote partition */</span>

			<span class="n">msg</span> <span class="o">=</span> <span class="n">xpc_pull_remote_msg_sn2</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">get</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">msg</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">!=</span> <span class="n">get</span><span class="p">);</span>
				<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_M_SN2_DONE</span><span class="p">);</span>
				<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_M_SN2_READY</span><span class="p">));</span>

				<span class="n">payload</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">payload</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Now we actually send the messages that are ready to be sent by advancing</span>
<span class="cm"> * the local message queue&#39;s Put value and then send a chctl msgrequest to the</span>
<span class="cm"> * recipient partition.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_send_msgs_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">s64</span> <span class="n">initial_put</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_sn2</span> <span class="o">*</span><span class="n">ch_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">put</span> <span class="o">=</span> <span class="n">initial_put</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">send_msgrequest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">put</span> <span class="o">==</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_local_GP</span><span class="p">.</span><span class="n">put</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">ch_sn2</span><span class="o">-&gt;</span>
						     <span class="n">local_msgqueue</span> <span class="o">+</span> <span class="p">(</span><span class="n">put</span> <span class="o">%</span>
						     <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">)</span> <span class="o">*</span>
						     <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_M_SN2_READY</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">put</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">put</span> <span class="o">==</span> <span class="n">initial_put</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* nothing&#39;s changed */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmpxchg_rel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_GP</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">,</span> <span class="n">initial_put</span><span class="p">,</span> <span class="n">put</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">initial_put</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* someone else beat us to it */</span>
			<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_GP</span><span class="o">-&gt;</span><span class="n">put</span> <span class="o">&lt;</span> <span class="n">initial_put</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* we just set the new value of local_GP-&gt;put */</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;local_GP-&gt;put changed to %lld, partid=%d, &quot;</span>
			<span class="s">&quot;channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">put</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="n">send_msgrequest</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * We need to ensure that the message referenced by</span>
<span class="cm">		 * local_GP-&gt;put is not XPC_M_SN2_READY or that local_GP-&gt;put</span>
<span class="cm">		 * equals w_local_GP.put, so we&#39;ll go have a look.</span>
<span class="cm">		 */</span>
		<span class="n">initial_put</span> <span class="o">=</span> <span class="n">put</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_msgrequest</span><span class="p">)</span>
		<span class="n">xpc_send_chctl_msgrequest_sn2</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Allocate an entry for a message from the message queue associated with the</span>
<span class="cm"> * specified channel.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_allocate_msg_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span>
		     <span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">**</span><span class="n">address_of_msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_sn2</span> <span class="o">*</span><span class="n">ch_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">put</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Get the next available message entry from the local message queue.</span>
<span class="cm">	 * If none are available, we&#39;ll make sure that we grab the latest</span>
<span class="cm">	 * GP values.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpTimeout</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">put</span> <span class="o">=</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_local_GP</span><span class="p">.</span><span class="n">put</span><span class="p">;</span>
		<span class="n">smp_rmb</span><span class="p">();</span>	<span class="cm">/* guarantee that .put loads before .get */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put</span> <span class="o">-</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_remote_GP</span><span class="p">.</span><span class="n">get</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">)</span> <span class="p">{</span>

			<span class="cm">/* There are available message entries. We need to try</span>
<span class="cm">			 * to secure one for ourselves. We&#39;ll do this by trying</span>
<span class="cm">			 * to increment w_local_GP.put as long as someone else</span>
<span class="cm">			 * doesn&#39;t beat us to it. If they do, we&#39;ll have to</span>
<span class="cm">			 * try again.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_local_GP</span><span class="p">.</span><span class="n">put</span><span class="p">,</span> <span class="n">put</span><span class="p">,</span> <span class="n">put</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">put</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* we got the entry referenced by put */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>	<span class="cm">/* try again */</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * There aren&#39;t any available msg entries at this time.</span>
<span class="cm">		 *</span>
<span class="cm">		 * In waiting for a message entry to become available,</span>
<span class="cm">		 * we set a timeout in case the other side is not sending</span>
<span class="cm">		 * completion interrupts. This lets us fake a notify IRQ</span>
<span class="cm">		 * that will cause the notify IRQ handler to fetch the latest</span>
<span class="cm">		 * GP values as if an interrupt was sent by the other side.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="n">xpTimeout</span><span class="p">)</span>
			<span class="n">xpc_send_chctl_local_msgrequest_sn2</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_NOWAIT</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">xpNoWait</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_allocate_msg_wait</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpInterrupted</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span> <span class="o">!=</span> <span class="n">xpTimeout</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get the message&#39;s address and initialize it */</span>
	<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_msgqueue</span> <span class="o">+</span>
				     <span class="p">(</span><span class="n">put</span> <span class="o">%</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">)</span> <span class="o">*</span>
				     <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">);</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">number</span> <span class="o">=</span> <span class="n">put</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;w_local_GP.put changed to %lld; msg=0x%p, &quot;</span>
		<span class="s">&quot;msg_number=%lld, partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">put</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="o">*</span><span class="n">address_of_msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">xpSuccess</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Common code that does the actual sending of the message by advancing the</span>
<span class="cm"> * local message queue&#39;s Put value and sends a chctl msgrequest to the</span>
<span class="cm"> * partition the message is being sent to.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_send_payload_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span>
		     <span class="n">u16</span> <span class="n">payload_size</span><span class="p">,</span> <span class="n">u8</span> <span class="n">notify_type</span><span class="p">,</span> <span class="n">xpc_notify_func</span> <span class="n">func</span><span class="p">,</span>
		     <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">xpSuccess</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_channel_sn2</span> <span class="o">*</span><span class="n">ch_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="n">msg</span> <span class="o">=</span> <span class="n">msg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_notify_sn2</span> <span class="o">*</span><span class="n">notify</span> <span class="o">=</span> <span class="n">notify</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">msg_number</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">put</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">notify_type</span> <span class="o">==</span> <span class="n">XPC_N_CALL</span> <span class="o">&amp;&amp;</span> <span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">XPC_MSG_SIZE</span><span class="p">(</span><span class="n">payload_size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">xpPayloadTooBig</span><span class="p">;</span>

	<span class="n">xpc_msgqueue_ref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpNotConnected</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_allocate_msg_sn2</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">msg</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_1</span><span class="p">;</span>

	<span class="n">msg_number</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_type</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Tell the remote side to send an ACK interrupt when the</span>
<span class="cm">		 * message has been delivered.</span>
<span class="cm">		 */</span>
		<span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_M_SN2_INTERRUPT</span><span class="p">;</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_to_notify</span><span class="p">);</span>

		<span class="n">notify</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">notify_queue</span><span class="p">[</span><span class="n">msg_number</span> <span class="o">%</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">];</span>
		<span class="n">notify</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
		<span class="n">notify</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
		<span class="n">notify</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">notify_type</span><span class="p">;</span>

		<span class="cm">/* ??? Is a mb() needed here? */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * An error occurred between our last error check and</span>
<span class="cm">			 * this one. We will try to clear the type field from</span>
<span class="cm">			 * the notify entry. If we succeed then</span>
<span class="cm">			 * xpc_disconnect_channel() didn&#39;t already process</span>
<span class="cm">			 * the notify entry.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">cmpxchg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">notify</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span> <span class="n">notify_type</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span>
			    <span class="n">notify_type</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_to_notify</span><span class="p">);</span>
				<span class="n">ret</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out_1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">payload</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_size</span><span class="p">);</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_M_SN2_READY</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The preceding store of msg-&gt;flags must occur before the following</span>
<span class="cm">	 * load of local_GP-&gt;put.</span>
<span class="cm">	 */</span>
	<span class="n">smp_mb</span><span class="p">();</span>

	<span class="cm">/* see if the message is next in line to be sent, if so send it */</span>

	<span class="n">put</span> <span class="o">=</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_GP</span><span class="o">-&gt;</span><span class="n">put</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put</span> <span class="o">==</span> <span class="n">msg_number</span><span class="p">)</span>
		<span class="n">xpc_send_msgs_sn2</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">put</span><span class="p">);</span>

<span class="nl">out_1:</span>
	<span class="n">xpc_msgqueue_deref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Now we actually acknowledge the messages that have been delivered and ack&#39;d</span>
<span class="cm"> * by advancing the cached remote message queue&#39;s Get value and if requested</span>
<span class="cm"> * send a chctl msgrequest to the message sender&#39;s partition.</span>
<span class="cm"> *</span>
<span class="cm"> * If a message has XPC_M_SN2_INTERRUPT set, send an interrupt to the partition</span>
<span class="cm"> * that sent the message.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_acknowledge_msgs_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="n">s64</span> <span class="n">initial_get</span><span class="p">,</span> <span class="n">u8</span> <span class="n">msg_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_channel_sn2</span> <span class="o">*</span><span class="n">ch_sn2</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">get</span> <span class="o">=</span> <span class="n">initial_get</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">send_msgrequest</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>

		<span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">get</span> <span class="o">==</span> <span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">w_local_GP</span><span class="p">.</span><span class="n">get</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="p">)((</span><span class="n">u64</span><span class="p">)</span><span class="n">ch_sn2</span><span class="o">-&gt;</span>
						     <span class="n">remote_msgqueue</span> <span class="o">+</span> <span class="p">(</span><span class="n">get</span> <span class="o">%</span>
						     <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">)</span> <span class="o">*</span>
						     <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_M_SN2_DONE</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">msg_flags</span> <span class="o">|=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>
			<span class="n">get</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get</span> <span class="o">==</span> <span class="n">initial_get</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* nothing&#39;s changed */</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">cmpxchg_rel</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_GP</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">,</span> <span class="n">initial_get</span><span class="p">,</span> <span class="n">get</span><span class="p">)</span> <span class="o">!=</span>
		    <span class="n">initial_get</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* someone else beat us to it */</span>
			<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch_sn2</span><span class="o">-&gt;</span><span class="n">local_GP</span><span class="o">-&gt;</span><span class="n">get</span> <span class="o">&lt;=</span> <span class="n">initial_get</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* we just set the new value of local_GP-&gt;get */</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;local_GP-&gt;get changed to %lld, partid=%d, &quot;</span>
			<span class="s">&quot;channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="n">send_msgrequest</span> <span class="o">=</span> <span class="p">(</span><span class="n">msg_flags</span> <span class="o">&amp;</span> <span class="n">XPC_M_SN2_INTERRUPT</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * We need to ensure that the message referenced by</span>
<span class="cm">		 * local_GP-&gt;get is not XPC_M_SN2_DONE or that local_GP-&gt;get</span>
<span class="cm">		 * equals w_local_GP.get, so we&#39;ll go have a look.</span>
<span class="cm">		 */</span>
		<span class="n">initial_get</span> <span class="o">=</span> <span class="n">get</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">send_msgrequest</span><span class="p">)</span>
		<span class="n">xpc_send_chctl_msgrequest_sn2</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_received_payload_sn2</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_msg_sn2</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">msg_number</span><span class="p">;</span>
	<span class="n">s64</span> <span class="n">get</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xpc_msg_sn2</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>
	<span class="n">msg_number</span> <span class="o">=</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;msg=0x%p, msg_number=%lld, partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">msg</span><span class="p">,</span> <span class="n">msg_number</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">DBUG_ON</span><span class="p">((((</span><span class="n">u64</span><span class="p">)</span><span class="n">msg</span> <span class="o">-</span> <span class="p">(</span><span class="n">u64</span><span class="p">)</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">remote_msgqueue</span><span class="p">)</span> <span class="o">/</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">)</span> <span class="o">!=</span>
		<span class="n">msg_number</span> <span class="o">%</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">);</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_M_SN2_READY</span><span class="p">));</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_M_SN2_DONE</span><span class="p">);</span>

	<span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_M_SN2_DONE</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * The preceding store of msg-&gt;flags must occur before the following</span>
<span class="cm">	 * load of local_GP-&gt;get.</span>
<span class="cm">	 */</span>
	<span class="n">smp_mb</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * See if this message is next in line to be acknowledged as having</span>
<span class="cm">	 * been delivered.</span>
<span class="cm">	 */</span>
	<span class="n">get</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">sn</span><span class="p">.</span><span class="n">sn2</span><span class="p">.</span><span class="n">local_GP</span><span class="o">-&gt;</span><span class="n">get</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">get</span> <span class="o">==</span> <span class="n">msg_number</span><span class="p">)</span>
		<span class="n">xpc_acknowledge_msgs_sn2</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">get</span><span class="p">,</span> <span class="n">msg</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">xpc_arch_operations</span> <span class="n">xpc_arch_ops_sn2</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">setup_partitions</span> <span class="o">=</span> <span class="n">xpc_setup_partitions_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">teardown_partitions</span> <span class="o">=</span> <span class="n">xpc_teardown_partitions_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">process_activate_IRQ_rcvd</span> <span class="o">=</span> <span class="n">xpc_process_activate_IRQ_rcvd_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_partition_rsvd_page_pa</span> <span class="o">=</span> <span class="n">xpc_get_partition_rsvd_page_pa_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">setup_rsvd_page</span> <span class="o">=</span> <span class="n">xpc_setup_rsvd_page_sn2</span><span class="p">,</span>

	<span class="p">.</span><span class="n">allow_hb</span> <span class="o">=</span> <span class="n">xpc_allow_hb_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disallow_hb</span> <span class="o">=</span> <span class="n">xpc_disallow_hb_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">disallow_all_hbs</span> <span class="o">=</span> <span class="n">xpc_disallow_all_hbs_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">increment_heartbeat</span> <span class="o">=</span> <span class="n">xpc_increment_heartbeat_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">offline_heartbeat</span> <span class="o">=</span> <span class="n">xpc_offline_heartbeat_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">online_heartbeat</span> <span class="o">=</span> <span class="n">xpc_online_heartbeat_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">heartbeat_init</span> <span class="o">=</span> <span class="n">xpc_heartbeat_init_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">heartbeat_exit</span> <span class="o">=</span> <span class="n">xpc_heartbeat_exit_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_remote_heartbeat</span> <span class="o">=</span> <span class="n">xpc_get_remote_heartbeat_sn2</span><span class="p">,</span>

	<span class="p">.</span><span class="n">request_partition_activation</span> <span class="o">=</span>
		<span class="n">xpc_request_partition_activation_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_partition_reactivation</span> <span class="o">=</span>
		<span class="n">xpc_request_partition_reactivation_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">request_partition_deactivation</span> <span class="o">=</span>
		<span class="n">xpc_request_partition_deactivation_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">cancel_partition_deactivation_request</span> <span class="o">=</span>
		<span class="n">xpc_cancel_partition_deactivation_request_sn2</span><span class="p">,</span>

	<span class="p">.</span><span class="n">setup_ch_structures</span> <span class="o">=</span> <span class="n">xpc_setup_ch_structures_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">teardown_ch_structures</span> <span class="o">=</span> <span class="n">xpc_teardown_ch_structures_sn2</span><span class="p">,</span>

	<span class="p">.</span><span class="n">make_first_contact</span> <span class="o">=</span> <span class="n">xpc_make_first_contact_sn2</span><span class="p">,</span>

	<span class="p">.</span><span class="n">get_chctl_all_flags</span> <span class="o">=</span> <span class="n">xpc_get_chctl_all_flags_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_chctl_closerequest</span> <span class="o">=</span> <span class="n">xpc_send_chctl_closerequest_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_chctl_closereply</span> <span class="o">=</span> <span class="n">xpc_send_chctl_closereply_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_chctl_openrequest</span> <span class="o">=</span> <span class="n">xpc_send_chctl_openrequest_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_chctl_openreply</span> <span class="o">=</span> <span class="n">xpc_send_chctl_openreply_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_chctl_opencomplete</span> <span class="o">=</span> <span class="n">xpc_send_chctl_opencomplete_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">process_msg_chctl_flags</span> <span class="o">=</span> <span class="n">xpc_process_msg_chctl_flags_sn2</span><span class="p">,</span>

	<span class="p">.</span><span class="n">save_remote_msgqueue_pa</span> <span class="o">=</span> <span class="n">xpc_save_remote_msgqueue_pa_sn2</span><span class="p">,</span>

	<span class="p">.</span><span class="n">setup_msg_structures</span> <span class="o">=</span> <span class="n">xpc_setup_msg_structures_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">teardown_msg_structures</span> <span class="o">=</span> <span class="n">xpc_teardown_msg_structures_sn2</span><span class="p">,</span>

	<span class="p">.</span><span class="n">indicate_partition_engaged</span> <span class="o">=</span> <span class="n">xpc_indicate_partition_engaged_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">indicate_partition_disengaged</span> <span class="o">=</span> <span class="n">xpc_indicate_partition_disengaged_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">partition_engaged</span> <span class="o">=</span> <span class="n">xpc_partition_engaged_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">any_partition_engaged</span> <span class="o">=</span> <span class="n">xpc_any_partition_engaged_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">assume_partition_disengaged</span> <span class="o">=</span> <span class="n">xpc_assume_partition_disengaged_sn2</span><span class="p">,</span>

	<span class="p">.</span><span class="n">n_of_deliverable_payloads</span> <span class="o">=</span> <span class="n">xpc_n_of_deliverable_payloads_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_payload</span> <span class="o">=</span> <span class="n">xpc_send_payload_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_deliverable_payload</span> <span class="o">=</span> <span class="n">xpc_get_deliverable_payload_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">received_payload</span> <span class="o">=</span> <span class="n">xpc_received_payload_sn2</span><span class="p">,</span>
	<span class="p">.</span><span class="n">notify_senders_of_disconnect</span> <span class="o">=</span> <span class="n">xpc_notify_senders_of_disconnect_sn2</span><span class="p">,</span>
<span class="p">};</span>

<span class="kt">int</span>
<span class="nf">xpc_init_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">buf_size</span><span class="p">;</span>

	<span class="n">xpc_arch_ops</span> <span class="o">=</span> <span class="n">xpc_arch_ops_sn2</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offsetof</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_msg_sn2</span><span class="p">,</span> <span class="n">payload</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">XPC_MSG_HDR_MAX_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;header portion of struct xpc_msg_sn2 is &quot;</span>
			<span class="s">&quot;larger than %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">XPC_MSG_HDR_MAX_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">E2BIG</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf_size</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">XPC_RP_VARS_SIZE</span><span class="p">,</span>
		       <span class="n">XPC_RP_HEADER_SIZE</span> <span class="o">+</span> <span class="n">XP_NASID_MASK_BYTES_SN2</span><span class="p">);</span>
	<span class="n">xpc_remote_copy_buffer_sn2</span> <span class="o">=</span> <span class="n">xpc_kmalloc_cacheline_aligned</span><span class="p">(</span><span class="n">buf_size</span><span class="p">,</span>
								   <span class="n">GFP_KERNEL</span><span class="p">,</span>
					      <span class="o">&amp;</span><span class="n">xpc_remote_copy_buffer_base_sn2</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">xpc_remote_copy_buffer_sn2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;can&#39;t get memory for remote copy buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* open up protections for IPI and [potentially] amo operations */</span>
	<span class="n">xpc_allow_IPI_ops_sn2</span><span class="p">();</span>
	<span class="n">xpc_allow_amo_ops_shub_wars_1_1_sn2</span><span class="p">();</span>

	<span class="cm">/*</span>
<span class="cm">	 * This is safe to do before the xpc_hb_checker thread has started</span>
<span class="cm">	 * because the handler releases a wait queue.  If an interrupt is</span>
<span class="cm">	 * received before the thread is waiting, it will not go to sleep,</span>
<span class="cm">	 * but rather immediately process the interrupt.</span>
<span class="cm">	 */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">SGI_XPC_ACTIVATE</span><span class="p">,</span> <span class="n">xpc_handle_activate_IRQ_sn2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
			  <span class="s">&quot;xpc hb&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">xpc_part</span><span class="p">,</span> <span class="s">&quot;can&#39;t register ACTIVATE IRQ handler, &quot;</span>
			<span class="s">&quot;errno=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">-</span><span class="n">ret</span><span class="p">);</span>
		<span class="n">xpc_disallow_IPI_ops_sn2</span><span class="p">();</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">xpc_remote_copy_buffer_base_sn2</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">xpc_exit_sn2</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">SGI_XPC_ACTIVATE</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">xpc_disallow_IPI_ops_sn2</span><span class="p">();</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">xpc_remote_copy_buffer_base_sn2</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
