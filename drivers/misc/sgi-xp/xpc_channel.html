<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › misc › sgi-xp › xpc_channel.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>xpc_channel.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is subject to the terms and conditions of the GNU General Public</span>
<span class="cm"> * License.  See the file &quot;COPYING&quot; in the main directory of this archive</span>
<span class="cm"> * for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2004-2009 Silicon Graphics, Inc.  All Rights Reserved.</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Cross Partition Communication (XPC) channel support.</span>
<span class="cm"> *</span>
<span class="cm"> *	This is the part of XPC that manages the channels and</span>
<span class="cm"> *	sends/receives messages across them to/from other partitions.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &quot;xpc.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * Process a connect message from a remote partition.</span>
<span class="cm"> *</span>
<span class="cm"> * Note: xpc_process_connect() is expecting to be called with the</span>
<span class="cm"> * spin_lock_irqsave held and will leave it locked upon return.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_process_connect</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">spin_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_OPENREQUEST</span><span class="p">)</span> <span class="o">||</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_ROPENREQUEST</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* nothing more to do for now */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTING</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_SETUP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">setup_msg_structures</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span>
			<span class="n">XPC_DISCONNECT_CHANNEL</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_C_SETUP</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">)</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_OPENREPLY</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_C_OPENREPLY</span><span class="p">;</span>
		<span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">send_chctl_openreply</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_ROPENREPLY</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_OPENCOMPLETE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XPC_C_OPENCOMPLETE</span> <span class="o">|</span> <span class="n">XPC_C_CONNECTED</span><span class="p">);</span>
		<span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">send_chctl_opencomplete</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_ROPENCOMPLETE</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;channel %d to partition %d connected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">);</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">XPC_C_CONNECTED</span> <span class="o">|</span> <span class="n">XPC_C_SETUP</span><span class="p">);</span>	<span class="cm">/* clear all else */</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * spin_lock_irqsave() is expected to be held on entry.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_process_disconnect</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">channel_was_connected</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_WASCONNECTED</span><span class="p">);</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">spin_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CLOSEREQUEST</span><span class="p">));</span>

	<span class="cm">/* make sure all activity has settled down first */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">kthreads_assigned</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span>
	    <span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">references</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">DBUG_ON</span><span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTEDCALLOUT_MADE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		<span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTINGCALLOUT_MADE</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">==</span> <span class="n">XPC_P_AS_DEACTIVATING</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* can&#39;t proceed until the other side disengages from us */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">partition_engaged</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* as long as the other side is up do the full protocol */</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_RCLOSEREQUEST</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CLOSEREPLY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_C_CLOSEREPLY</span><span class="p">;</span>
			<span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">send_chctl_closereply</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_RCLOSEREPLY</span><span class="p">))</span>
			<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* wake those waiting for notify completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_to_notify</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we do callout while holding ch-&gt;lock, callout can&#39;t block */</span>
		<span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">notify_senders_of_disconnect</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* both sides are disconnected now */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTINGCALLOUT_MADE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">);</span>
		<span class="n">xpc_disconnect_callout</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">xpDisconnected</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_to_notify</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* it&#39;s now safe to free the channel&#39;s message queues */</span>
	<span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">teardown_msg_structures</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">kthreads_assigned_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">kthreads_idle_limit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Mark the channel disconnected and clear all other flags, including</span>
<span class="cm">	 * XPC_C_SETUP (because of call to</span>
<span class="cm">	 * xpc_arch_ops.teardown_msg_structures()) but not including</span>
<span class="cm">	 * XPC_C_WDISCONNECT (if it was set).</span>
<span class="cm">	 */</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="p">(</span><span class="n">XPC_C_DISCONNECTED</span> <span class="o">|</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_WDISCONNECT</span><span class="p">));</span>

	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">nchannels_active</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel_was_connected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_info</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;channel %d to partition %d disconnected, &quot;</span>
			 <span class="s">&quot;reason=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_WDISCONNECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* we won&#39;t lose the CPU since we&#39;re holding ch-&gt;lock */</span>
		<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">wdisconnect_wait</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">delayed_chctl_flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">!=</span> <span class="n">XPC_P_AS_DEACTIVATING</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* time to take action on any delayed chctl flags */</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">);</span>
			<span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">]</span> <span class="o">|=</span>
			    <span class="n">ch</span><span class="o">-&gt;</span><span class="n">delayed_chctl_flags</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">delayed_chctl_flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Process a change in the channel&#39;s remote connection state.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">xpc_process_openclose_chctl_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch_number</span><span class="p">,</span>
				  <span class="n">u8</span> <span class="n">chctl_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_openclose_args</span> <span class="o">*</span><span class="n">args</span> <span class="o">=</span>
	    <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">remote_openclose_args</span><span class="p">[</span><span class="n">ch_number</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_number</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">reason</span><span class="p">;</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">create_kthread</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

<span class="nl">again:</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTED</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_WDISCONNECT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Delay processing chctl flags until thread waiting disconnect</span>
<span class="cm">		 * has had a chance to see that the channel is disconnected.</span>
<span class="cm">		 */</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">delayed_chctl_flags</span> <span class="o">|=</span> <span class="n">chctl_flags</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chctl_flags</span> <span class="o">&amp;</span> <span class="n">XPC_CHCTL_CLOSEREQUEST</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;XPC_CHCTL_CLOSEREQUEST (reason=%d) received &quot;</span>
			<span class="s">&quot;from partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">,</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * If RCLOSEREQUEST is set, we&#39;re probably waiting for</span>
<span class="cm">		 * RCLOSEREPLY. We should find it and a ROPENREQUEST packed</span>
<span class="cm">		 * with this RCLOSEREQUEST in the chctl_flags.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_RCLOSEREQUEST</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">));</span>
			<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CLOSEREQUEST</span><span class="p">));</span>
			<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CLOSEREPLY</span><span class="p">));</span>
			<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_RCLOSEREPLY</span><span class="p">);</span>

			<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chctl_flags</span> <span class="o">&amp;</span> <span class="n">XPC_CHCTL_CLOSEREPLY</span><span class="p">));</span>
			<span class="n">chctl_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XPC_CHCTL_CLOSEREPLY</span><span class="p">;</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_C_RCLOSEREPLY</span><span class="p">;</span>

			<span class="cm">/* both sides have finished disconnecting */</span>
			<span class="n">xpc_process_disconnect</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>
			<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTED</span><span class="p">));</span>
			<span class="k">goto</span> <span class="n">again</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">chctl_flags</span> <span class="o">&amp;</span> <span class="n">XPC_CHCTL_OPENREQUEST</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">ch_number</span><span class="p">]</span> <span class="o">&amp;</span>
				    <span class="n">XPC_CHCTL_OPENREQUEST</span><span class="p">)</span> <span class="p">{</span>

					<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">delayed_chctl_flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
					<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">);</span>
					<span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">ch_number</span><span class="p">]</span> <span class="o">|=</span>
					    <span class="n">XPC_CHCTL_CLOSEREQUEST</span><span class="p">;</span>
					<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">XPC_SET_REASON</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XPC_C_DISCONNECTED</span><span class="p">;</span>

			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">nchannels_active</span><span class="p">);</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XPC_C_CONNECTING</span> <span class="o">|</span> <span class="n">XPC_C_ROPENREQUEST</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">chctl_flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">XPC_CHCTL_OPENREQUEST</span> <span class="o">|</span> <span class="n">XPC_CHCTL_OPENREPLY</span> <span class="o">|</span>
		    <span class="n">XPC_CHCTL_OPENCOMPLETE</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The meaningful CLOSEREQUEST connection state fields are:</span>
<span class="cm">		 *      reason = reason connection is to be closed</span>
<span class="cm">		 */</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_C_RCLOSEREQUEST</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">reason</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">&lt;=</span> <span class="n">xpSuccess</span> <span class="o">||</span> <span class="n">reason</span> <span class="o">&gt;</span> <span class="n">xpUnknownReason</span><span class="p">)</span>
				<span class="n">reason</span> <span class="o">=</span> <span class="n">xpUnknownReason</span><span class="p">;</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">reason</span> <span class="o">==</span> <span class="n">xpUnregistering</span><span class="p">)</span>
				<span class="n">reason</span> <span class="o">=</span> <span class="n">xpOtherUnregistering</span><span class="p">;</span>

			<span class="n">XPC_DISCONNECT_CHANNEL</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>

			<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">chctl_flags</span> <span class="o">&amp;</span> <span class="n">XPC_CHCTL_CLOSEREPLY</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">xpc_process_disconnect</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chctl_flags</span> <span class="o">&amp;</span> <span class="n">XPC_CHCTL_CLOSEREPLY</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;XPC_CHCTL_CLOSEREPLY received from partid=&quot;</span>
			<span class="s">&quot;%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">!=</span> <span class="n">XPC_P_AS_DEACTIVATING</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CLOSEREQUEST</span><span class="p">));</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_RCLOSEREQUEST</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">ch_number</span><span class="p">]</span> <span class="o">&amp;</span>
			    <span class="n">XPC_CHCTL_CLOSEREQUEST</span><span class="p">)</span> <span class="p">{</span>

				<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">delayed_chctl_flags</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
				<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">);</span>
				<span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">ch_number</span><span class="p">]</span> <span class="o">|=</span>
				    <span class="n">XPC_CHCTL_CLOSEREPLY</span><span class="p">;</span>
				<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">chctl_lock</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_C_RCLOSEREPLY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CLOSEREPLY</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* both sides have finished disconnecting */</span>
			<span class="n">xpc_process_disconnect</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chctl_flags</span> <span class="o">&amp;</span> <span class="n">XPC_CHCTL_OPENREQUEST</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;XPC_CHCTL_OPENREQUEST (entry_size=%d, &quot;</span>
			<span class="s">&quot;local_nentries=%d) received from partid=%d, &quot;</span>
			<span class="s">&quot;channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">,</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">==</span> <span class="n">XPC_P_AS_DEACTIVATING</span> <span class="o">||</span>
		    <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_ROPENREQUEST</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XPC_C_DISCONNECTING</span> <span class="o">|</span> <span class="n">XPC_C_WDISCONNECT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">delayed_chctl_flags</span> <span class="o">|=</span> <span class="n">XPC_CHCTL_OPENREQUEST</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XPC_C_DISCONNECTED</span> <span class="o">|</span>
				       <span class="n">XPC_C_OPENREQUEST</span><span class="p">)));</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XPC_C_ROPENREQUEST</span> <span class="o">|</span> <span class="n">XPC_C_ROPENREPLY</span> <span class="o">|</span>
				     <span class="n">XPC_C_OPENREPLY</span> <span class="o">|</span> <span class="n">XPC_C_CONNECTED</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * The meaningful OPENREQUEST connection state fields are:</span>
<span class="cm">		 *      entry_size = size of channel&#39;s messages in bytes</span>
<span class="cm">		 *      local_nentries = remote partition&#39;s local_nentries</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">local_nentries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* assume OPENREQUEST was delayed by mistake */</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XPC_C_ROPENREQUEST</span> <span class="o">|</span> <span class="n">XPC_C_CONNECTING</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_OPENREQUEST</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">!=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">XPC_DISCONNECT_CHANNEL</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">xpUnequalMsgSizes</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>

			<span class="n">XPC_SET_REASON</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XPC_C_DISCONNECTED</span><span class="p">;</span>

			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">nchannels_active</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">xpc_process_connect</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chctl_flags</span> <span class="o">&amp;</span> <span class="n">XPC_CHCTL_OPENREPLY</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;XPC_CHCTL_OPENREPLY (local_msgqueue_pa=&quot;</span>
			<span class="s">&quot;0x%lx, local_nentries=%d, remote_nentries=%d) &quot;</span>
			<span class="s">&quot;received from partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">local_msgqueue_pa</span><span class="p">,</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">,</span>
			<span class="n">args</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XPC_C_DISCONNECTING</span> <span class="o">|</span> <span class="n">XPC_C_DISCONNECTED</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_OPENREQUEST</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">XPC_DISCONNECT_CHANNEL</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">xpOpenCloseError</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_ROPENREQUEST</span><span class="p">));</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTED</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * The meaningful OPENREPLY connection state fields are:</span>
<span class="cm">		 *      local_msgqueue_pa = physical address of remote</span>
<span class="cm">		 *                          partition&#39;s local_msgqueue</span>
<span class="cm">		 *      local_nentries = remote partition&#39;s local_nentries</span>
<span class="cm">		 *      remote_nentries = remote partition&#39;s remote_nentries</span>
<span class="cm">		 */</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">local_msgqueue_pa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">local_nentries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">remote_nentries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">save_remote_msgqueue_pa</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span>
						      <span class="n">args</span><span class="o">-&gt;</span><span class="n">local_msgqueue_pa</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">xpSuccess</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">XPC_DISCONNECT_CHANNEL</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">ret</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_C_ROPENREPLY</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">local_nentries</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;XPC_CHCTL_OPENREPLY: new &quot;</span>
				<span class="s">&quot;remote_nentries=%d, old remote_nentries=%d, &quot;</span>
				<span class="s">&quot;partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">args</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">,</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">remote_nentries</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">args</span><span class="o">-&gt;</span><span class="n">remote_nentries</span> <span class="o">&lt;</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;XPC_CHCTL_OPENREPLY: new &quot;</span>
				<span class="s">&quot;local_nentries=%d, old local_nentries=%d, &quot;</span>
				<span class="s">&quot;partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">args</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">,</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span> <span class="o">=</span> <span class="n">args</span><span class="o">-&gt;</span><span class="n">remote_nentries</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">xpc_process_connect</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chctl_flags</span> <span class="o">&amp;</span> <span class="n">XPC_CHCTL_OPENCOMPLETE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;XPC_CHCTL_OPENCOMPLETE received from &quot;</span>
			<span class="s">&quot;partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XPC_C_DISCONNECTING</span> <span class="o">|</span> <span class="n">XPC_C_DISCONNECTED</span><span class="p">))</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_OPENREQUEST</span><span class="p">)</span> <span class="o">||</span>
		    <span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_OPENREPLY</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">XPC_DISCONNECT_CHANNEL</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">xpOpenCloseError</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_ROPENREQUEST</span><span class="p">));</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_ROPENREPLY</span><span class="p">));</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTED</span><span class="p">));</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_C_ROPENCOMPLETE</span><span class="p">;</span>

		<span class="n">xpc_process_connect</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>
		<span class="n">create_kthread</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">create_kthread</span><span class="p">)</span>
		<span class="n">xpc_create_kthreads</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Attempt to establish a channel connection to a remote partition.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_connect_channel</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_registration</span> <span class="o">*</span><span class="n">registration</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_registrations</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mutex_trylock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">xpRetry</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">XPC_CHANNEL_REGISTERED</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">xpUnregistered</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTED</span><span class="p">);</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_OPENREQUEST</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* add info from the channel connect registration to the channel */</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">kthreads_assigned_limit</span> <span class="o">=</span> <span class="n">registration</span><span class="o">-&gt;</span><span class="n">assigned_limit</span><span class="p">;</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">kthreads_idle_limit</span> <span class="o">=</span> <span class="n">registration</span><span class="o">-&gt;</span><span class="n">idle_limit</span><span class="p">;</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">kthreads_assigned</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">kthreads_idle</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">kthreads_active</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">registration</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">;</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">registration</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">key</span> <span class="o">=</span> <span class="n">registration</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span> <span class="o">=</span> <span class="n">registration</span><span class="o">-&gt;</span><span class="n">nentries</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_ROPENREQUEST</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">registration</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">!=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* the local and remote sides aren&#39;t the same */</span>

			<span class="cm">/*</span>
<span class="cm">			 * Because XPC_DISCONNECT_CHANNEL() can block we&#39;re</span>
<span class="cm">			 * forced to up the registration sema before we unlock</span>
<span class="cm">			 * the channel lock. But that&#39;s okay here because we&#39;re</span>
<span class="cm">			 * done with the part that required the registration</span>
<span class="cm">			 * sema. XPC_DISCONNECT_CHANNEL() requires that the</span>
<span class="cm">			 * channel lock be locked and will unlock and relock</span>
<span class="cm">			 * the channel lock as needed.</span>
<span class="cm">			 */</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
			<span class="n">XPC_DISCONNECT_CHANNEL</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">xpUnequalMsgSizes</span><span class="p">,</span>
					       <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">xpUnequalMsgSizes</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">entry_size</span> <span class="o">=</span> <span class="n">registration</span><span class="o">-&gt;</span><span class="n">entry_size</span><span class="p">;</span>

		<span class="n">XPC_SET_REASON</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">XPC_C_DISCONNECTED</span><span class="p">;</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">].</span><span class="n">nchannels_active</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">registration</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* initiate the connection */</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XPC_C_OPENREQUEST</span> <span class="o">|</span> <span class="n">XPC_C_CONNECTING</span><span class="p">);</span>
	<span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">send_chctl_openrequest</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>

	<span class="n">xpc_process_connect</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">xpSuccess</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">xpc_process_sent_chctl_flags</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="k">union</span> <span class="n">xpc_channel_ctl_flags</span> <span class="n">chctl</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_number</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">ch_flags</span><span class="p">;</span>

	<span class="n">chctl</span><span class="p">.</span><span class="n">all_flags</span> <span class="o">=</span> <span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">get_chctl_all_flags</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Initiate channel connections for registered channels.</span>
<span class="cm">	 *</span>
<span class="cm">	 * For each connected channel that has pending messages activate idle</span>
<span class="cm">	 * kthreads and/or create new kthreads as needed.</span>
<span class="cm">	 */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ch_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch_number</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">nchannels</span><span class="p">;</span> <span class="n">ch_number</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_number</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		 * Process any open or close related chctl flags, and then deal</span>
<span class="cm">		 * with connecting or disconnecting the channel as required.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">ch_number</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">XPC_OPENCLOSE_CHCTL_FLAGS</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">xpc_process_openclose_chctl_flags</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">ch_number</span><span class="p">,</span>
							<span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">ch_number</span><span class="p">]);</span>
		<span class="p">}</span>

		<span class="n">ch_flags</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>	<span class="cm">/* need an atomic snapshot of flags */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch_flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
			<span class="n">xpc_process_disconnect</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">act_state</span> <span class="o">==</span> <span class="n">XPC_P_AS_DEACTIVATING</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch_flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTED</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch_flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_OPENREQUEST</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch_flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_SETUP</span><span class="p">);</span>
				<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">xpc_connect_channel</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * Process any message related chctl flags, this may involve</span>
<span class="cm">		 * the activation of kthreads to deliver any pending messages</span>
<span class="cm">		 * sent from the other partition.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">chctl</span><span class="p">.</span><span class="n">flags</span><span class="p">[</span><span class="n">ch_number</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">XPC_MSG_CHCTL_FLAGS</span><span class="p">)</span>
			<span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">process_msg_chctl_flags</span><span class="p">(</span><span class="n">part</span><span class="p">,</span> <span class="n">ch_number</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * XPC&#39;s heartbeat code calls this function to inform XPC that a partition is</span>
<span class="cm"> * going down.  XPC responds by tearing down the XPartition Communication</span>
<span class="cm"> * infrastructure used for the just downed partition.</span>
<span class="cm"> *</span>
<span class="cm"> * XPC&#39;s heartbeat code will never call this function and xpc_partition_up()</span>
<span class="cm"> * at the same time. Nor will it ever make multiple calls to either function</span>
<span class="cm"> * at the same time.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xpc_partition_going_down</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">,</span> <span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ch_number</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;deactivating partition %d, reason=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">XPC_PARTID</span><span class="p">(</span><span class="n">part</span><span class="p">),</span> <span class="n">reason</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">xpc_part_ref</span><span class="p">(</span><span class="n">part</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* infrastructure for this partition isn&#39;t currently set up */</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* disconnect channels associated with the partition going down */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">ch_number</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">ch_number</span> <span class="o">&lt;</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">nchannels</span><span class="p">;</span> <span class="n">ch_number</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_number</span><span class="p">];</span>

		<span class="n">xpc_msgqueue_ref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

		<span class="n">XPC_DISCONNECT_CHANNEL</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>

		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>
		<span class="n">xpc_msgqueue_deref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">xpc_wakeup_channel_mgr</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>

	<span class="n">xpc_part_deref</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by XP at the time of channel connection registration to cause</span>
<span class="cm"> * XPC to establish connections to all currently active partitions.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xpc_initiate_connect</span><span class="p">(</span><span class="kt">int</span> <span class="n">ch_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">short</span> <span class="n">partid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch_number</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ch_number</span> <span class="o">&gt;=</span> <span class="n">XPC_MAX_NCHANNELS</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">partid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">partid</span> <span class="o">&lt;</span> <span class="n">xp_max_npartitions</span><span class="p">;</span> <span class="n">partid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xpc_part_ref</span><span class="p">(</span><span class="n">part</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_number</span><span class="p">];</span>

			<span class="cm">/*</span>
<span class="cm">			 * Initiate the establishment of a connection on the</span>
<span class="cm">			 * newly registered channel to the remote partition.</span>
<span class="cm">			 */</span>
			<span class="n">xpc_wakeup_channel_mgr</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
			<span class="n">xpc_part_deref</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">xpc_connected_callout</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* let the registerer know that a connection has been established */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;ch-&gt;func() called, reason=xpConnected, &quot;</span>
			<span class="s">&quot;partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="n">xpConnected</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span>
			 <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">u64</span><span class="p">)</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">local_nentries</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;ch-&gt;func() returned, reason=xpConnected, &quot;</span>
			<span class="s">&quot;partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Called by XP at the time of channel connection unregistration to cause</span>
<span class="cm"> * XPC to teardown all current connections for the specified channel.</span>
<span class="cm"> *</span>
<span class="cm"> * Before returning xpc_initiate_disconnect() will wait until all connections</span>
<span class="cm"> * on the specified channel have been closed/torndown. So the caller can be</span>
<span class="cm"> * assured that they will not be receiving any more callouts from XPC to the</span>
<span class="cm"> * function they registered via xpc_connect().</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> *</span>
<span class="cm"> *	ch_number - channel # to unregister.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xpc_initiate_disconnect</span><span class="p">(</span><span class="kt">int</span> <span class="n">ch_number</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">irq_flags</span><span class="p">;</span>
	<span class="kt">short</span> <span class="n">partid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch_number</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ch_number</span> <span class="o">&gt;=</span> <span class="n">XPC_MAX_NCHANNELS</span><span class="p">);</span>

	<span class="cm">/* initiate the channel disconnect for every active partition */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">partid</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">partid</span> <span class="o">&lt;</span> <span class="n">xp_max_npartitions</span><span class="p">;</span> <span class="n">partid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">xpc_part_ref</span><span class="p">(</span><span class="n">part</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_number</span><span class="p">];</span>
			<span class="n">xpc_msgqueue_ref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

			<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTED</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_C_WDISCONNECT</span><span class="p">;</span>

				<span class="n">XPC_DISCONNECT_CHANNEL</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">xpUnregistering</span><span class="p">,</span>
						       <span class="o">&amp;</span><span class="n">irq_flags</span><span class="p">);</span>
			<span class="p">}</span>

			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

			<span class="n">xpc_msgqueue_deref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
			<span class="n">xpc_part_deref</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">xpc_disconnect_wait</span><span class="p">(</span><span class="n">ch_number</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * To disconnect a channel, and reflect it back to all who may be waiting.</span>
<span class="cm"> *</span>
<span class="cm"> * An OPEN is not allowed until XPC_C_DISCONNECTING is cleared by</span>
<span class="cm"> * xpc_process_disconnect(), and if set, XPC_C_WDISCONNECT is cleared by</span>
<span class="cm"> * xpc_disconnect_wait().</span>
<span class="cm"> *</span>
<span class="cm"> * THE CHANNEL IS TO BE LOCKED BY THE CALLER AND WILL REMAIN LOCKED UPON RETURN.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xpc_disconnect_channel</span><span class="p">(</span><span class="k">const</span> <span class="kt">int</span> <span class="n">line</span><span class="p">,</span> <span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span>
		       <span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">reason</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">channel_was_connected</span> <span class="o">=</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTED</span><span class="p">);</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="n">spin_is_locked</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XPC_C_DISCONNECTING</span> <span class="o">|</span> <span class="n">XPC_C_DISCONNECTED</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">XPC_C_CONNECTING</span> <span class="o">|</span> <span class="n">XPC_C_CONNECTED</span><span class="p">)));</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;reason=%d, line=%d, partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">reason</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

	<span class="n">XPC_SET_REASON</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">line</span><span class="p">);</span>

	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="p">(</span><span class="n">XPC_C_CLOSEREQUEST</span> <span class="o">|</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">);</span>
	<span class="cm">/* some of these may not have been set */</span>
	<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">XPC_C_OPENREQUEST</span> <span class="o">|</span> <span class="n">XPC_C_OPENREPLY</span> <span class="o">|</span>
		       <span class="n">XPC_C_ROPENREQUEST</span> <span class="o">|</span> <span class="n">XPC_C_ROPENREPLY</span> <span class="o">|</span>
		       <span class="n">XPC_C_CONNECTING</span> <span class="o">|</span> <span class="n">XPC_C_CONNECTED</span><span class="p">);</span>

	<span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">send_chctl_closerequest</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">irq_flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">channel_was_connected</span><span class="p">)</span>
		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">XPC_C_WASCONNECTED</span><span class="p">;</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">);</span>

	<span class="cm">/* wake all idle kthreads so they can exit */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">kthreads_idle</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">idle_wq</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_CONNECTEDCALLOUT_MADE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		   <span class="o">!</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTINGCALLOUT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* start a kthread that will do the xpDisconnecting callout */</span>
		<span class="n">xpc_create_kthreads</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* wake those waiting to allocate an entry from the local msg queue */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_on_msg_allocate_wq</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">msg_allocate_wq</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="o">*</span><span class="n">irq_flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">xpc_disconnect_callout</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">,</span> <span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">reason</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/*</span>
<span class="cm">	 * Let the channel&#39;s registerer know that the channel is being</span>
<span class="cm">	 * disconnected. We don&#39;t want to do this if the registerer was never</span>
<span class="cm">	 * informed of a connection being made.</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;ch-&gt;func() called, reason=%d, partid=%d, &quot;</span>
			<span class="s">&quot;channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

		<span class="n">ch</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="n">reason</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;ch-&gt;func() returned, reason=%d, partid=%d, &quot;</span>
			<span class="s">&quot;channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">reason</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for a message entry to become available for the specified channel,</span>
<span class="cm"> * but don&#39;t wait any longer than 1 jiffy.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_allocate_msg_wait</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">==</span> <span class="n">xpInterrupted</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_on_msg_allocate_wq</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">interruptible_sleep_on_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">msg_allocate_wq</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">n_on_msg_allocate_wq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">XPC_C_DISCONNECTING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">reason</span><span class="p">;</span>
		<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">reason</span> <span class="o">==</span> <span class="n">xpInterrupted</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpTimeout</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpInterrupted</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send a message that contains the user&#39;s payload on the specified channel</span>
<span class="cm"> * connected to the specified partition.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE that this routine can sleep waiting for a message entry to become</span>
<span class="cm"> * available. To not sleep, pass in the XPC_NOWAIT flag.</span>
<span class="cm"> *</span>
<span class="cm"> * Once sent, this routine will not wait for the message to be received, nor</span>
<span class="cm"> * will notification be given when it does happen.</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> *</span>
<span class="cm"> *	partid - ID of partition to which the channel is connected.</span>
<span class="cm"> *	ch_number - channel # to send message on.</span>
<span class="cm"> *	flags - see xp.h for valid flags.</span>
<span class="cm"> *	payload - pointer to the payload which is to be sent.</span>
<span class="cm"> *	payload_size - size of the payload in bytes.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_initiate_send</span><span class="p">(</span><span class="kt">short</span> <span class="n">partid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch_number</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span>
		  <span class="n">u16</span> <span class="n">payload_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">xpUnknownReason</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;payload=0x%p, partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span>
		<span class="n">partid</span><span class="p">,</span> <span class="n">ch_number</span><span class="p">);</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">partid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">partid</span> <span class="o">&gt;=</span> <span class="n">xp_max_npartitions</span><span class="p">);</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch_number</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ch_number</span> <span class="o">&gt;=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">nchannels</span><span class="p">);</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">payload</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpc_part_ref</span><span class="p">(</span><span class="n">part</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">send_payload</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_number</span><span class="p">],</span>
				  <span class="n">flags</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_size</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
		<span class="n">xpc_part_deref</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Send a message that contains the user&#39;s payload on the specified channel</span>
<span class="cm"> * connected to the specified partition.</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE that this routine can sleep waiting for a message entry to become</span>
<span class="cm"> * available. To not sleep, pass in the XPC_NOWAIT flag.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine will not wait for the message to be sent or received.</span>
<span class="cm"> *</span>
<span class="cm"> * Once the remote end of the channel has received the message, the function</span>
<span class="cm"> * passed as an argument to xpc_initiate_send_notify() will be called. This</span>
<span class="cm"> * allows the sender to free up or re-use any buffers referenced by the</span>
<span class="cm"> * message, but does NOT mean the message has been processed at the remote</span>
<span class="cm"> * end by a receiver.</span>
<span class="cm"> *</span>
<span class="cm"> * If this routine returns an error, the caller&#39;s function will NOT be called.</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> *</span>
<span class="cm"> *	partid - ID of partition to which the channel is connected.</span>
<span class="cm"> *	ch_number - channel # to send message on.</span>
<span class="cm"> *	flags - see xp.h for valid flags.</span>
<span class="cm"> *	payload - pointer to the payload which is to be sent.</span>
<span class="cm"> *	payload_size - size of the payload in bytes.</span>
<span class="cm"> *	func - function to call with asynchronous notification of message</span>
<span class="cm"> *		  receipt. THIS FUNCTION MUST BE NON-BLOCKING.</span>
<span class="cm"> *	key - user-defined key to be passed to the function when it&#39;s called.</span>
<span class="cm"> */</span>
<span class="k">enum</span> <span class="n">xp_retval</span>
<span class="nf">xpc_initiate_send_notify</span><span class="p">(</span><span class="kt">short</span> <span class="n">partid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch_number</span><span class="p">,</span> <span class="n">u32</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span>
			 <span class="n">u16</span> <span class="n">payload_size</span><span class="p">,</span> <span class="n">xpc_notify_func</span> <span class="n">func</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">key</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">];</span>
	<span class="k">enum</span> <span class="n">xp_retval</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">xpUnknownReason</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;payload=0x%p, partid=%d, channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span>
		<span class="n">partid</span><span class="p">,</span> <span class="n">ch_number</span><span class="p">);</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">partid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">partid</span> <span class="o">&gt;=</span> <span class="n">xp_max_npartitions</span><span class="p">);</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch_number</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ch_number</span> <span class="o">&gt;=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">nchannels</span><span class="p">);</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">payload</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">func</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">xpc_part_ref</span><span class="p">(</span><span class="n">part</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">send_payload</span><span class="p">(</span><span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_number</span><span class="p">],</span>
			  <span class="n">flags</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">payload_size</span><span class="p">,</span> <span class="n">XPC_N_CALL</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">key</span><span class="p">);</span>
		<span class="n">xpc_part_deref</span><span class="p">(</span><span class="n">part</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Deliver a message&#39;s payload to its intended recipient.</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xpc_deliver_payload</span><span class="p">(</span><span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">;</span>

	<span class="n">payload</span> <span class="o">=</span> <span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">get_deliverable_payload</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">payload</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * This ref is taken to protect the payload itself from being</span>
<span class="cm">		 * freed before the user is finished with it, which the user</span>
<span class="cm">		 * indicates by calling xpc_initiate_received().</span>
<span class="cm">		 */</span>
		<span class="n">xpc_msgqueue_ref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>

		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">kthreads_active</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;ch-&gt;func() called, payload=0x%p &quot;</span>
				<span class="s">&quot;partid=%d channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>

			<span class="cm">/* deliver the message to its intended recipient */</span>
			<span class="n">ch</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">(</span><span class="n">xpMsgReceived</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span>
				 <span class="n">ch</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">);</span>

			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">xpc_chan</span><span class="p">,</span> <span class="s">&quot;ch-&gt;func() returned, payload=0x%p &quot;</span>
				<span class="s">&quot;partid=%d channel=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">ch</span><span class="o">-&gt;</span><span class="n">partid</span><span class="p">,</span>
				<span class="n">ch</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ch</span><span class="o">-&gt;</span><span class="n">kthreads_active</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Acknowledge receipt of a delivered message&#39;s payload.</span>
<span class="cm"> *</span>
<span class="cm"> * This function, although called by users, does not call xpc_part_ref() to</span>
<span class="cm"> * ensure that the partition infrastructure is in place. It relies on the</span>
<span class="cm"> * fact that we called xpc_msgqueue_ref() in xpc_deliver_payload().</span>
<span class="cm"> *</span>
<span class="cm"> * Arguments:</span>
<span class="cm"> *</span>
<span class="cm"> *	partid - ID of partition to which the channel is connected.</span>
<span class="cm"> *	ch_number - channel # message received on.</span>
<span class="cm"> *	payload - pointer to the payload area allocated via</span>
<span class="cm"> *			xpc_initiate_send() or xpc_initiate_send_notify().</span>
<span class="cm"> */</span>
<span class="kt">void</span>
<span class="nf">xpc_initiate_received</span><span class="p">(</span><span class="kt">short</span> <span class="n">partid</span><span class="p">,</span> <span class="kt">int</span> <span class="n">ch_number</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">xpc_partition</span> <span class="o">*</span><span class="n">part</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">xpc_partitions</span><span class="p">[</span><span class="n">partid</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">xpc_channel</span> <span class="o">*</span><span class="n">ch</span><span class="p">;</span>

	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">partid</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">partid</span> <span class="o">&gt;=</span> <span class="n">xp_max_npartitions</span><span class="p">);</span>
	<span class="n">DBUG_ON</span><span class="p">(</span><span class="n">ch_number</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">ch_number</span> <span class="o">&gt;=</span> <span class="n">part</span><span class="o">-&gt;</span><span class="n">nchannels</span><span class="p">);</span>

	<span class="n">ch</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">part</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">[</span><span class="n">ch_number</span><span class="p">];</span>
	<span class="n">xpc_arch_ops</span><span class="p">.</span><span class="n">received_payload</span><span class="p">(</span><span class="n">ch</span><span class="p">,</span> <span class="n">payload</span><span class="p">);</span>

	<span class="cm">/* the call to xpc_msgqueue_ref() was done by xpc_deliver_payload()  */</span>
	<span class="n">xpc_msgqueue_deref</span><span class="p">(</span><span class="n">ch</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
