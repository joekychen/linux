<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › misc › altera-stapl › altera.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>altera.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * altera.c</span>
<span class="cm"> *</span>
<span class="cm"> * altera FPGA driver</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) Altera Corporation 1998-2001</span>
<span class="cm"> * Copyright (C) 2010,2011 NetUP Inc.</span>
<span class="cm"> * Copyright (C) 2010,2011 Igor M. Liplianin &lt;liplianin@netup.ru&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 675 Mass Ave, Cambridge, MA 02139, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;asm/unaligned.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;misc/altera.h&gt;</span>
<span class="cp">#include &quot;altera-exprt.h&quot;</span>
<span class="cp">#include &quot;altera-jtag.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">debug</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="s">&quot;enable debugging information&quot;</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;altera FPGA kernel module&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Igor M. Liplianin  &lt;liplianin@netup.ru&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

<span class="cp">#define dprintk(args...) \</span>
<span class="cp">	if (debug) { \</span>
<span class="cp">		printk(KERN_DEBUG args); \</span>
<span class="cp">	}</span>

<span class="k">enum</span> <span class="n">altera_fpga_opcode</span> <span class="p">{</span>
	<span class="n">OP_NOP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">OP_DUP</span><span class="p">,</span>
	<span class="n">OP_SWP</span><span class="p">,</span>
	<span class="n">OP_ADD</span><span class="p">,</span>
	<span class="n">OP_SUB</span><span class="p">,</span>
	<span class="n">OP_MULT</span><span class="p">,</span>
	<span class="n">OP_DIV</span><span class="p">,</span>
	<span class="n">OP_MOD</span><span class="p">,</span>
	<span class="n">OP_SHL</span><span class="p">,</span>
	<span class="n">OP_SHR</span><span class="p">,</span>
	<span class="n">OP_NOT</span><span class="p">,</span>
	<span class="n">OP_AND</span><span class="p">,</span>
	<span class="n">OP_OR</span><span class="p">,</span>
	<span class="n">OP_XOR</span><span class="p">,</span>
	<span class="n">OP_INV</span><span class="p">,</span>
	<span class="n">OP_GT</span><span class="p">,</span>
	<span class="n">OP_LT</span><span class="p">,</span>
	<span class="n">OP_RET</span><span class="p">,</span>
	<span class="n">OP_CMPS</span><span class="p">,</span>
	<span class="n">OP_PINT</span><span class="p">,</span>
	<span class="n">OP_PRNT</span><span class="p">,</span>
	<span class="n">OP_DSS</span><span class="p">,</span>
	<span class="n">OP_DSSC</span><span class="p">,</span>
	<span class="n">OP_ISS</span><span class="p">,</span>
	<span class="n">OP_ISSC</span><span class="p">,</span>
	<span class="n">OP_DPR</span> <span class="o">=</span> <span class="mh">0x1c</span><span class="p">,</span>
	<span class="n">OP_DPRL</span><span class="p">,</span>
	<span class="n">OP_DPO</span><span class="p">,</span>
	<span class="n">OP_DPOL</span><span class="p">,</span>
	<span class="n">OP_IPR</span><span class="p">,</span>
	<span class="n">OP_IPRL</span><span class="p">,</span>
	<span class="n">OP_IPO</span><span class="p">,</span>
	<span class="n">OP_IPOL</span><span class="p">,</span>
	<span class="n">OP_PCHR</span><span class="p">,</span>
	<span class="n">OP_EXIT</span><span class="p">,</span>
	<span class="n">OP_EQU</span><span class="p">,</span>
	<span class="n">OP_POPT</span><span class="p">,</span>
	<span class="n">OP_ABS</span> <span class="o">=</span> <span class="mh">0x2c</span><span class="p">,</span>
	<span class="n">OP_BCH0</span><span class="p">,</span>
	<span class="n">OP_PSH0</span> <span class="o">=</span> <span class="mh">0x2f</span><span class="p">,</span>
	<span class="n">OP_PSHL</span> <span class="o">=</span> <span class="mh">0x40</span><span class="p">,</span>
	<span class="n">OP_PSHV</span><span class="p">,</span>
	<span class="n">OP_JMP</span><span class="p">,</span>
	<span class="n">OP_CALL</span><span class="p">,</span>
	<span class="n">OP_NEXT</span><span class="p">,</span>
	<span class="n">OP_PSTR</span><span class="p">,</span>
	<span class="n">OP_SINT</span> <span class="o">=</span> <span class="mh">0x47</span><span class="p">,</span>
	<span class="n">OP_ST</span><span class="p">,</span>
	<span class="n">OP_ISTP</span><span class="p">,</span>
	<span class="n">OP_DSTP</span><span class="p">,</span>
	<span class="n">OP_SWPN</span><span class="p">,</span>
	<span class="n">OP_DUPN</span><span class="p">,</span>
	<span class="n">OP_POPV</span><span class="p">,</span>
	<span class="n">OP_POPE</span><span class="p">,</span>
	<span class="n">OP_POPA</span><span class="p">,</span>
	<span class="n">OP_JMPZ</span><span class="p">,</span>
	<span class="n">OP_DS</span><span class="p">,</span>
	<span class="n">OP_IS</span><span class="p">,</span>
	<span class="n">OP_DPRA</span><span class="p">,</span>
	<span class="n">OP_DPOA</span><span class="p">,</span>
	<span class="n">OP_IPRA</span><span class="p">,</span>
	<span class="n">OP_IPOA</span><span class="p">,</span>
	<span class="n">OP_EXPT</span><span class="p">,</span>
	<span class="n">OP_PSHE</span><span class="p">,</span>
	<span class="n">OP_PSHA</span><span class="p">,</span>
	<span class="n">OP_DYNA</span><span class="p">,</span>
	<span class="n">OP_EXPV</span> <span class="o">=</span> <span class="mh">0x5c</span><span class="p">,</span>
	<span class="n">OP_COPY</span> <span class="o">=</span> <span class="mh">0x80</span><span class="p">,</span>
	<span class="n">OP_REVA</span><span class="p">,</span>
	<span class="n">OP_DSC</span><span class="p">,</span>
	<span class="n">OP_ISC</span><span class="p">,</span>
	<span class="n">OP_WAIT</span><span class="p">,</span>
	<span class="n">OP_VS</span><span class="p">,</span>
	<span class="n">OP_CMPA</span> <span class="o">=</span> <span class="mh">0xc0</span><span class="p">,</span>
	<span class="n">OP_VSC</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">altera_procinfo</span> <span class="p">{</span>
	<span class="kt">char</span>			<span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="n">u8</span>			<span class="n">attrs</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">altera_procinfo</span>	<span class="o">*</span><span class="n">next</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* This function checks if enough parameters are available on the stack. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">altera_check_stack</span><span class="p">(</span><span class="kt">int</span> <span class="n">stack_ptr</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">stack_ptr</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">altera_export_int</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">s32</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Export: key = </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">, value = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#define HEX_LINE_CHARS 72</span>
<span class="cp">#define HEX_LINE_BITS (HEX_LINE_CHARS * 4)</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">altera_export_bool_array</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="n">s32</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="n">HEX_LINE_CHARS</span> <span class="o">+</span> <span class="mi">1</span><span class="p">];</span>
	<span class="n">s32</span> <span class="n">i</span><span class="p">,</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">size</span><span class="p">,</span> <span class="n">line</span><span class="p">,</span> <span class="n">lines</span><span class="p">,</span> <span class="n">linebits</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">HEX_LINE_BITS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Export: key = </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">, %d bits, value = HEX</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
							<span class="n">key</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">lines</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="p">(</span><span class="n">HEX_LINE_BITS</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">/</span> <span class="n">HEX_LINE_BITS</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">line</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">line</span> <span class="o">&lt;</span> <span class="n">lines</span><span class="p">;</span> <span class="o">++</span><span class="n">line</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">line</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">lines</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">linebits</span> <span class="o">=</span> <span class="n">HEX_LINE_BITS</span><span class="p">;</span>
				<span class="n">size</span> <span class="o">=</span> <span class="n">HEX_LINE_CHARS</span><span class="p">;</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="n">count</span> <span class="o">-</span> <span class="p">((</span><span class="n">line</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">HEX_LINE_BITS</span><span class="p">);</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">linebits</span> <span class="o">=</span>
					<span class="n">count</span> <span class="o">-</span> <span class="p">((</span><span class="n">lines</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">HEX_LINE_BITS</span><span class="p">);</span>
				<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">linebits</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
				<span class="n">offset</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">string</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="n">j</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">linebits</span><span class="p">;</span> <span class="o">++</span><span class="n">k</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">k</span> <span class="o">+</span> <span class="n">offset</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)))</span>
					<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s">&quot;%1x&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
					<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="o">--</span><span class="n">j</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">k</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s">&quot;%1x&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

			<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">string</span><span class="p">[</span><span class="n">size</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">j</span> <span class="o">=</span> <span class="n">size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)))</span>
				<span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s">&quot;%1x&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
				<span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="o">--</span><span class="n">j</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">string</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="s">&quot;%1x&quot;</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>

		<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;Export: key = </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">, %d bits, value = HEX %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">key</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">string</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">altera_execute</span><span class="p">(</span><span class="k">struct</span> <span class="n">altera_state</span> <span class="o">*</span><span class="n">astate</span><span class="p">,</span>
				<span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
				<span class="n">s32</span> <span class="n">program_size</span><span class="p">,</span>
				<span class="n">s32</span> <span class="o">*</span><span class="n">error_address</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">exit_code</span><span class="p">,</span>
				<span class="kt">int</span> <span class="o">*</span><span class="n">format_version</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">altera_config</span> <span class="o">*</span><span class="n">aconf</span> <span class="o">=</span> <span class="n">astate</span><span class="o">-&gt;</span><span class="n">config</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">msg_buff</span> <span class="o">=</span> <span class="n">astate</span><span class="o">-&gt;</span><span class="n">msg_buff</span><span class="p">;</span>
	<span class="kt">long</span> <span class="o">*</span><span class="n">stack</span> <span class="o">=</span> <span class="n">astate</span><span class="o">-&gt;</span><span class="n">stack</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">first_word</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">action_table</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">proc_table</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">str_table</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sym_table</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data_sect</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">code_sect</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">debug_sect</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">action_count</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">proc_count</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sym_count</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="kt">long</span> <span class="o">*</span><span class="n">vars</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">s32</span> <span class="o">*</span><span class="n">var_size</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">attrs</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">proc_attributes</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pc</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">opcode_address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">args</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">opcode</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">name_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">charbuf</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">long</span> <span class="n">long_tmp</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">variable_id</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">charptr_tmp</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">charptr_tmp2</span><span class="p">;</span>
	<span class="kt">long</span> <span class="o">*</span><span class="n">longptr_tmp</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">stack_ptr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">arg_count</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">done</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bad_opcode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">index2</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">long_count</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">long_idx</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">long_idx2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">j</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">uncomp_size</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">current_proc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">reverse</span><span class="p">;</span>

	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>

	<span class="n">dprintk</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="cm">/* Read header information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">program_size</span> <span class="o">&gt;</span> <span class="mi">52L</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">first_word</span>    <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_word</span> <span class="o">&amp;</span> <span class="mi">1L</span><span class="p">);</span>
		<span class="o">*</span><span class="n">format_version</span> <span class="o">=</span> <span class="n">version</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">version</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">action_table</span>  <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
		<span class="n">proc_table</span>    <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
		<span class="n">str_table</span>  <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span> <span class="o">+</span> <span class="n">delta</span><span class="p">]);</span>
		<span class="n">sym_table</span>  <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">16</span> <span class="o">+</span> <span class="n">delta</span><span class="p">]);</span>
		<span class="n">data_sect</span>  <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">20</span> <span class="o">+</span> <span class="n">delta</span><span class="p">]);</span>
		<span class="n">code_sect</span>  <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">24</span> <span class="o">+</span> <span class="n">delta</span><span class="p">]);</span>
		<span class="n">debug_sect</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">28</span> <span class="o">+</span> <span class="n">delta</span><span class="p">]);</span>
		<span class="n">action_count</span>  <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">40</span> <span class="o">+</span> <span class="n">delta</span><span class="p">]);</span>
		<span class="n">proc_count</span>    <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">44</span> <span class="o">+</span> <span class="n">delta</span><span class="p">]);</span>
		<span class="n">sym_count</span>  <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">48</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">delta</span><span class="p">)]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">first_word</span> <span class="o">!=</span> <span class="mh">0x4A414D00L</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">first_word</span> <span class="o">!=</span> <span class="mh">0x4A414D01L</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exit_done</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sym_count</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_done</span><span class="p">;</span>

	<span class="n">vars</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sym_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vars</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">var_size</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sym_count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s32</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">var_size</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">attrs</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">sym_count</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">proc_attributes</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">proc_count</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">proc_attributes</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exit_done</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="n">version</span> <span class="o">*</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sym_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="p">(</span><span class="n">sym_table</span> <span class="o">+</span> <span class="p">((</span><span class="mi">11</span> <span class="o">+</span> <span class="n">delta</span><span class="p">)</span> <span class="o">*</span> <span class="n">i</span><span class="p">));</span>

		<span class="n">value</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">3</span> <span class="o">+</span> <span class="n">delta</span><span class="p">]);</span>

		<span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">offset</span><span class="p">];</span>

		<span class="cm">/*</span>
<span class="cm">		 * use bit 7 of attribute byte to indicate that</span>
<span class="cm">		 * this buffer was dynamically allocated</span>
<span class="cm">		 * and should be freed later</span>
<span class="cm">		 */</span>
		<span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="mh">0x7f</span><span class="p">;</span>

		<span class="n">var_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">offset</span> <span class="o">+</span> <span class="mi">7</span> <span class="o">+</span> <span class="n">delta</span><span class="p">]);</span>

		<span class="cm">/*</span>
<span class="cm">		 * Attribute bits:</span>
<span class="cm">		 * bit 0: 0 = read-only, 1 = read-write</span>
<span class="cm">		 * bit 1: 0 = not compressed, 1 = compressed</span>
<span class="cm">		 * bit 2: 0 = not initialized, 1 = initialized</span>
<span class="cm">		 * bit 3: 0 = scalar, 1 = array</span>
<span class="cm">		 * bit 4: 0 = Boolean, 1 = integer</span>
<span class="cm">		 * bit 5: 0 = declared variable,</span>
<span class="cm">		 *	1 = compiler created temporary variable</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">)</span>
			<span class="cm">/* initialized scalar variable */</span>
			<span class="n">vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0e</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* initialized compressed Boolean array */</span>
			<span class="n">uncomp_size</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">data_sect</span> <span class="o">+</span> <span class="n">value</span><span class="p">]);</span>

			<span class="cm">/* allocate a buffer for the uncompressed data */</span>
			<span class="n">vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">kzalloc</span><span class="p">(</span><span class="n">uncomp_size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0L</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/* set flag so buffer will be freed later */</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

				<span class="cm">/* uncompress the data */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">altera_shrink</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">data_sect</span> <span class="o">+</span> <span class="n">value</span><span class="p">],</span>
						<span class="n">var_size</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
						<span class="n">uncomp_size</span><span class="p">,</span>
						<span class="n">version</span><span class="p">)</span> <span class="o">!=</span> <span class="n">uncomp_size</span><span class="p">)</span>
					<span class="cm">/* decompression failed */</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="n">var_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">uncomp_size</span> <span class="o">*</span> <span class="mi">8L</span><span class="p">;</span>

			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1e</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* initialized Boolean array */</span>
			<span class="n">vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">data_sect</span> <span class="o">+</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">p</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* initialized integer array */</span>
			<span class="n">vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">data_sect</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0c</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* uninitialized array */</span>

			<span class="cm">/* flag attrs so that memory is freed */</span>
			<span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">var_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">u32</span> <span class="n">size</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
					<span class="cm">/* integer array */</span>
					<span class="n">size</span> <span class="o">=</span> <span class="p">(</span><span class="n">var_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">s32</span><span class="p">));</span>
				<span class="k">else</span>
					<span class="cm">/* Boolean array */</span>
					<span class="n">size</span> <span class="o">=</span> <span class="p">((</span><span class="n">var_size</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7L</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8L</span><span class="p">);</span>

				<span class="n">vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">kzalloc</span><span class="p">(</span><span class="n">size</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* zero out memory */</span>
					<span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span>
						<span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">vars</span><span class="p">[</span><span class="n">i</span><span class="p">]))[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="p">}</span> <span class="k">else</span>
			<span class="n">vars</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>

<span class="nl">exit_done:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">altera_jinit</span><span class="p">(</span><span class="n">astate</span><span class="p">);</span>

	<span class="n">pc</span> <span class="o">=</span> <span class="n">code_sect</span><span class="p">;</span>
	<span class="n">msg_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * For JBC version 2, we will execute the procedures corresponding to</span>
<span class="cm">	 * the selected ACTION</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">aconf</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">action_found</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">action_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">action_found</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">name_id</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">action_table</span> <span class="o">+</span>
								<span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">i</span><span class="p">)]);</span>

				<span class="n">name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">str_table</span> <span class="o">+</span> <span class="n">name_id</span><span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">aconf</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">name</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">action_found</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">current_proc</span> <span class="o">=</span>
						<span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">action_table</span> <span class="o">+</span>
								<span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]);</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">action_found</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
				<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">int</span> <span class="n">first_time</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">current_proc</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="n">first_time</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">first_time</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="cm">/* check procedure attribute byte */</span>
				<span class="n">proc_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
						<span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">proc_table</span> <span class="o">+</span>
								<span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span>
									<span class="mh">0x03</span><span class="p">);</span>

				<span class="cm">/*</span>
<span class="cm">				 * BIT0 - OPTIONAL</span>
<span class="cm">				 * BIT1 - RECOMMENDED</span>
<span class="cm">				 * BIT6 - FORCED OFF</span>
<span class="cm">				 * BIT7 - FORCED ON</span>
<span class="cm">				 */</span>

				<span class="n">i</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">proc_table</span> <span class="o">+</span>
							<span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * Set current_proc to the first procedure</span>
<span class="cm">			 * to be executed</span>
<span class="cm">			 */</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">current_proc</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">((</span><span class="n">proc_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
				<span class="p">((</span><span class="n">proc_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">proc_table</span> <span class="o">+</span>
							<span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]);</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">((</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">current_proc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">((</span><span class="n">proc_attributes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">((</span><span class="n">proc_attributes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x40</span><span class="p">))))</span> <span class="p">{</span>
				<span class="n">current_proc</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">pc</span> <span class="o">=</span> <span class="n">code_sect</span> <span class="o">+</span>
					<span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">proc_table</span> <span class="o">+</span>
								<span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]);</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">&lt;</span> <span class="n">code_sect</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pc</span> <span class="o">&gt;=</span> <span class="n">debug_sect</span><span class="p">))</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="cm">/* there are no procedures to execute! */</span>
				<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">msg_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">done</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">opcode</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">pc</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
		<span class="n">opcode_address</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>
		<span class="o">++</span><span class="n">pc</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;opcode: %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">opcode</span><span class="p">);</span>

		<span class="n">arg_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">&gt;&gt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">arg_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">pc</span><span class="p">]);</span>
			<span class="n">pc</span> <span class="o">+=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">OP_NOP</span>:
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_DUP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="o">++</span><span class="n">stack_ptr</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_SWP</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_tmp</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_ADD</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_SUB</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_MULT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_DIV</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_MOD</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">%=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_SHL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;&lt;=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_SHR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_NOT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">^=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1L</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_AND</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_OR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">|=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_XOR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">^=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_INV</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">?</span> <span class="mi">0L</span> <span class="o">:</span> <span class="mi">1L</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_GT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span>
			<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">])</span> <span class="o">?</span>
									<span class="mi">1L</span> <span class="o">:</span> <span class="mi">0L</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_LT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span>
			<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">])</span> <span class="o">?</span>
									<span class="mi">1L</span> <span class="o">:</span> <span class="mi">0L</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_RET</span>:
			<span class="k">if</span> <span class="p">((</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stack_ptr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * We completed one of the main procedures</span>
<span class="cm">				 * of an ACTION.</span>
<span class="cm">				 * Find the next procedure</span>
<span class="cm">				 * to be executed and jump to it.</span>
<span class="cm">				 * If there are no more procedures, then EXIT.</span>
<span class="cm">				 */</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">proc_table</span> <span class="o">+</span>
						<span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="n">current_proc</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]);</span>
				<span class="k">while</span> <span class="p">((</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">((</span><span class="n">proc_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">((</span><span class="n">proc_attributes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc0</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x40</span><span class="p">)))</span>
					<span class="n">i</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">proc_table</span> <span class="o">+</span>
								<span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* no procedures to execute! */</span>
					<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="o">*</span><span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* success */</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">current_proc</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
					<span class="n">pc</span> <span class="o">=</span> <span class="n">code_sect</span> <span class="o">+</span> <span class="n">get_unaligned_be32</span><span class="p">(</span>
								<span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">proc_table</span> <span class="o">+</span>
								<span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">9</span><span class="p">]);</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">&lt;</span> <span class="n">code_sect</span><span class="p">)</span> <span class="o">||</span>
					    <span class="p">(</span><span class="n">pc</span> <span class="o">&gt;=</span> <span class="n">debug_sect</span><span class="p">))</span>
						<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="p">}</span>

			<span class="p">}</span> <span class="k">else</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">pc</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">]</span> <span class="o">+</span> <span class="n">code_sect</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">&lt;=</span> <span class="n">code_sect</span><span class="p">)</span> <span class="o">||</span>
					    <span class="p">(</span><span class="n">pc</span> <span class="o">&gt;=</span> <span class="n">debug_sect</span><span class="p">))</span>
						<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

				<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_CMPS</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Array short compare</span>
<span class="cm">			 * ...stack 0 is source 1 value</span>
<span class="cm">			 * ...stack 1 is source 2 value</span>
<span class="cm">			 * ...stack 2 is mask value</span>
<span class="cm">			 * ...stack 3 is count</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">s32</span> <span class="n">a</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
				<span class="n">s32</span> <span class="n">b</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">))</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="k">else</span> <span class="p">{</span>
					<span class="n">long_tmp</span> <span class="o">&amp;=</span> <span class="p">((</span><span class="o">-</span><span class="mi">1L</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">count</span><span class="p">));</span>

					<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					<span class="p">((</span><span class="n">a</span> <span class="o">&amp;</span> <span class="n">long_tmp</span><span class="p">)</span> <span class="o">==</span> <span class="p">(</span><span class="n">b</span> <span class="o">&amp;</span> <span class="n">long_tmp</span><span class="p">))</span>
								<span class="o">?</span> <span class="mi">1L</span> <span class="o">:</span> <span class="mi">0L</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_PINT</span>:
			<span class="cm">/*</span>
<span class="cm">			 * PRINT add integer</span>
<span class="cm">			 * ...stack 0 is integer value</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_buff</span><span class="p">[</span><span class="n">strlen</span><span class="p">(</span><span class="n">msg_buff</span><span class="p">)],</span>
					<span class="s">&quot;%ld&quot;</span><span class="p">,</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_PRNT</span>:
			<span class="cm">/* PRINT finish */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">msg_buff</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

			<span class="n">msg_buff</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_DSS</span>:
			<span class="cm">/*</span>
<span class="cm">			 * DRSCAN short</span>
<span class="cm">			 * ...stack 0 is scan data</span>
<span class="cm">			 * ...stack 1 is count</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">long_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">charbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_drscan</span><span class="p">(</span><span class="n">astate</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">charbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_DSSC</span>:
			<span class="cm">/*</span>
<span class="cm">			 * DRSCAN short with capture</span>
<span class="cm">			 * ...stack 0 is scan data</span>
<span class="cm">			 * ...stack 1 is count</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">long_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">charbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_swap_dr</span><span class="p">(</span><span class="n">astate</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">charbuf</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="n">charbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">charbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_ISS</span>:
			<span class="cm">/*</span>
<span class="cm">			 * IRSCAN short</span>
<span class="cm">			 * ...stack 0 is scan data</span>
<span class="cm">			 * ...stack 1 is count</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">long_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">charbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_irscan</span><span class="p">(</span><span class="n">astate</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">charbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_ISSC</span>:
			<span class="cm">/*</span>
<span class="cm">			 * IRSCAN short with capture</span>
<span class="cm">			 * ...stack 0 is scan data</span>
<span class="cm">			 * ...stack 1 is count</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
			<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">long_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">charbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_swap_ir</span><span class="p">(</span><span class="n">astate</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">charbuf</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="n">charbuf</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_unaligned_le32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">charbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_DPR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_set_dr_pre</span><span class="p">(</span><span class="o">&amp;</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">js</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_DPRL</span>:
			<span class="cm">/*</span>
<span class="cm">			 * DRPRE with literal data</span>
<span class="cm">			 * ...stack 0 is count</span>
<span class="cm">			 * ...stack 1 is literal data</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">long_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">charbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_set_dr_pre</span><span class="p">(</span><span class="o">&amp;</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">js</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
						<span class="n">charbuf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_DPO</span>:
			<span class="cm">/*</span>
<span class="cm">			 * DRPOST</span>
<span class="cm">			 * ...stack 0 is count</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">altera_set_dr_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">js</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_DPOL</span>:
			<span class="cm">/*</span>
<span class="cm">			 * DRPOST with literal data</span>
<span class="cm">			 * ...stack 0 is count</span>
<span class="cm">			 * ...stack 1 is literal data</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">long_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">charbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_set_dr_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">js</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="n">charbuf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_IPR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">altera_set_ir_pre</span><span class="p">(</span><span class="o">&amp;</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">js</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
								<span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_IPRL</span>:
			<span class="cm">/*</span>
<span class="cm">			 * IRPRE with literal data</span>
<span class="cm">			 * ...stack 0 is count</span>
<span class="cm">			 * ...stack 1 is literal data</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
				<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">long_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">charbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">altera_set_ir_pre</span><span class="p">(</span><span class="o">&amp;</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">js</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="n">charbuf</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_IPO</span>:
			<span class="cm">/*</span>
<span class="cm">			 * IRPOST</span>
<span class="cm">			 * ...stack 0 is count</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">altera_set_ir_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">js</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span>
							<span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_IPOL</span>:
			<span class="cm">/*</span>
<span class="cm">			 * IRPOST with literal data</span>
<span class="cm">			 * ...stack 0 is count</span>
<span class="cm">			 * ...stack 1 is literal data</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">put_unaligned_le32</span><span class="p">(</span><span class="n">long_tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">charbuf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_set_ir_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">js</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
							<span class="n">charbuf</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_PCHR</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">u8</span> <span class="n">ch</span><span class="p">;</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg_buff</span><span class="p">);</span>
				<span class="n">ch</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
				<span class="k">if</span> <span class="p">((</span><span class="n">ch</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">ch</span> <span class="o">&gt;</span> <span class="mi">127</span><span class="p">))</span> <span class="p">{</span>
					<span class="cm">/*</span>
<span class="cm">					 * character code out of range</span>
<span class="cm">					 * instead of flagging an error,</span>
<span class="cm">					 * force the value to 127</span>
<span class="cm">					 */</span>
					<span class="n">ch</span> <span class="o">=</span> <span class="mi">127</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">msg_buff</span><span class="p">[</span><span class="n">count</span><span class="p">]</span> <span class="o">=</span> <span class="n">ch</span><span class="p">;</span>
				<span class="n">msg_buff</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_EXIT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="o">*</span><span class="n">exit_code</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_EQU</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span>
			<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
				<span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">])</span> <span class="o">?</span>
									<span class="mi">1L</span> <span class="o">:</span> <span class="mi">0L</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_POPT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_ABS</span>:
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">-</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_BCH0</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Batch operation 0</span>
<span class="cm">			 * SWP</span>
<span class="cm">			 * SWPN 7</span>
<span class="cm">			 * SWP</span>
<span class="cm">			 * SWPN 6</span>
<span class="cm">			 * DUPN 8</span>
<span class="cm">			 * SWPN 2</span>
<span class="cm">			 * SWP</span>
<span class="cm">			 * DUPN 6</span>
<span class="cm">			 * DUPN 6</span>
<span class="cm">			 */</span>

			<span class="cm">/* SWP  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_tmp</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* SWPN 7 */</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="n">index</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_tmp</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* SWP  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_tmp</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* SWPN 6 */</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="n">index</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_tmp</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* DUPN 8 */</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">8</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="n">index</span><span class="p">];</span>
				<span class="o">++</span><span class="n">stack_ptr</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* SWPN 2 */</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="n">index</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_tmp</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* SWP  */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_tmp</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* DUPN 6 */</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="n">index</span><span class="p">];</span>
				<span class="o">++</span><span class="n">stack_ptr</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/* DUPN 6 */</span>
			<span class="n">index</span> <span class="o">=</span> <span class="mi">6</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="n">index</span><span class="p">];</span>
				<span class="o">++</span><span class="n">stack_ptr</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_PSH0</span>:
			<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_PSHL</span>:
			<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_PSHV</span>:
			<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_JMP</span>:
			<span class="n">pc</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">code_sect</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">&lt;</span> <span class="n">code_sect</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pc</span> <span class="o">&gt;=</span> <span class="n">debug_sect</span><span class="p">))</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_CALL</span>:
			<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">pc</span><span class="p">;</span>
			<span class="n">pc</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">code_sect</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">&lt;</span> <span class="n">code_sect</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">pc</span> <span class="o">&gt;=</span> <span class="n">debug_sect</span><span class="p">))</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_NEXT</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Process FOR / NEXT loop</span>
<span class="cm">			 * ...argument 0 is variable ID</span>
<span class="cm">			 * ...stack 0 is step value</span>
<span class="cm">			 * ...stack 1 is end value</span>
<span class="cm">			 * ...stack 2 is top address</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">s32</span> <span class="n">step</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">s32</span> <span class="n">end</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>
				<span class="n">s32</span> <span class="n">top</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">3</span><span class="p">];</span>
				<span class="n">s32</span> <span class="n">iterator</span> <span class="o">=</span> <span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
				<span class="kt">int</span> <span class="n">break_out</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">step</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">iterator</span> <span class="o">&lt;=</span> <span class="n">end</span><span class="p">)</span>
						<span class="n">break_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">iterator</span> <span class="o">&gt;=</span> <span class="n">end</span><span class="p">)</span>
					<span class="n">break_out</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">break_out</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">stack_ptr</span> <span class="o">-=</span> <span class="mi">3</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">iterator</span> <span class="o">+</span> <span class="n">step</span><span class="p">;</span>
					<span class="n">pc</span> <span class="o">=</span> <span class="n">top</span> <span class="o">+</span> <span class="n">code_sect</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">&lt;</span> <span class="n">code_sect</span><span class="p">)</span> <span class="o">||</span>
					    <span class="p">(</span><span class="n">pc</span> <span class="o">&gt;=</span> <span class="n">debug_sect</span><span class="p">))</span>
						<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_PSTR</span>:
			<span class="cm">/*</span>
<span class="cm">			 * PRINT add string</span>
<span class="cm">			 * ...argument 0 is string ID</span>
<span class="cm">			 */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">msg_buff</span><span class="p">);</span>
			<span class="n">strlcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">msg_buff</span><span class="p">[</span><span class="n">count</span><span class="p">],</span>
				<span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">str_table</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
				<span class="n">ALTERA_MESSAGE_LENGTH</span> <span class="o">-</span> <span class="n">count</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_SINT</span>:
			<span class="cm">/*</span>
<span class="cm">			 * STATE intermediate state</span>
<span class="cm">			 * ...argument 0 is state code</span>
<span class="cm">			 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_goto_jstate</span><span class="p">(</span><span class="n">astate</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_ST</span>:
			<span class="cm">/*</span>
<span class="cm">			 * STATE final state</span>
<span class="cm">			 * ...argument 0 is state code</span>
<span class="cm">			 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_goto_jstate</span><span class="p">(</span><span class="n">astate</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_ISTP</span>:
			<span class="cm">/*</span>
<span class="cm">			 * IRSTOP state</span>
<span class="cm">			 * ...argument 0 is state code</span>
<span class="cm">			 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_set_irstop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">js</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_DSTP</span>:
			<span class="cm">/*</span>
<span class="cm">			 * DRSTOP state</span>
<span class="cm">			 * ...argument 0 is state code</span>
<span class="cm">			 */</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_set_drstop</span><span class="p">(</span><span class="o">&amp;</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">js</span><span class="p">,</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">OP_SWPN</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Exchange top with Nth stack value</span>
<span class="cm">			 * ...argument 0 is 0-based stack entry</span>
<span class="cm">			 * to swap with top element</span>
<span class="cm">			 */</span>
			<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="n">index</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_tmp</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_DUPN</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Duplicate Nth stack value</span>
<span class="cm">			 * ...argument 0 is 0-based stack entry to duplicate</span>
<span class="cm">			 */</span>
			<span class="n">index</span> <span class="o">=</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="n">index</span><span class="p">];</span>
				<span class="o">++</span><span class="n">stack_ptr</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_POPV</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Pop stack into scalar variable</span>
<span class="cm">			 * ...argument 0 is variable ID</span>
<span class="cm">			 * ...stack 0 is value</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_POPE</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Pop stack into integer array element</span>
<span class="cm">			 * ...argument 0 is variable ID</span>
<span class="cm">			 * ...stack 0 is array index</span>
<span class="cm">			 * ...stack 1 is value</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">variable_id</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="cm">/*</span>
<span class="cm">			 * If variable is read-only,</span>
<span class="cm">			 * convert to writable array</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x9c</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1c</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Allocate a writable buffer for this array */</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">var_size</span><span class="p">[</span><span class="n">variable_id</span><span class="p">];</span>
				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">];</span>
				<span class="n">longptr_tmp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">count</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">longptr_tmp</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* copy previous contents into buffer */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">longptr_tmp</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
						<span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">long_tmp</span><span class="p">]);</span>
					<span class="n">long_tmp</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>
				<span class="p">}</span>

				<span class="cm">/*</span>
<span class="cm">				 * set bit 7 - buffer was</span>
<span class="cm">				 * dynamically allocated</span>
<span class="cm">				 */</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

				<span class="cm">/* clear bit 2 - variable is writable */</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">;</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="cm">/* check that variable is a writable integer array */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x18</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">longptr_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">];</span>

				<span class="cm">/* pop the array index */</span>
				<span class="n">index</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

				<span class="cm">/* pop the value and store it into the array */</span>
				<span class="n">longptr_tmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_POPA</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Pop stack into Boolean array</span>
<span class="cm">			 * ...argument 0 is variable ID</span>
<span class="cm">			 * ...stack 0 is count</span>
<span class="cm">			 * ...stack 1 is array index</span>
<span class="cm">			 * ...stack 2 is value</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">variable_id</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="cm">/*</span>
<span class="cm">			 * If variable is read-only,</span>
<span class="cm">			 * convert to writable array</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x9c</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0c</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Allocate a writable buffer for this array */</span>
				<span class="n">long_tmp</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">var_size</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7L</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3L</span><span class="p">;</span>
				<span class="n">charptr_tmp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">];</span>
				<span class="n">charptr_tmp</span> <span class="o">=</span>
					<span class="n">kzalloc</span><span class="p">(</span><span class="n">long_tmp</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">charptr_tmp</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* zero the buffer */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
					<span class="n">long_idx</span> <span class="o">&lt;</span> <span class="n">long_tmp</span><span class="p">;</span>
					<span class="o">++</span><span class="n">long_idx</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">charptr_tmp</span><span class="p">[</span><span class="n">long_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* copy previous contents into buffer */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
					<span class="n">long_idx</span> <span class="o">&lt;</span> <span class="n">var_size</span><span class="p">[</span><span class="n">variable_id</span><span class="p">];</span>
					<span class="o">++</span><span class="n">long_idx</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">long_idx2</span> <span class="o">=</span> <span class="n">long_idx</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">charptr_tmp2</span><span class="p">[</span><span class="n">long_idx2</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span>
						<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">long_idx2</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)))</span> <span class="p">{</span>
						<span class="n">charptr_tmp</span><span class="p">[</span><span class="n">long_idx</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span>
							<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
					<span class="p">}</span>
				<span class="p">}</span>

				<span class="cm">/*</span>
<span class="cm">				 * set bit 7 - buffer was</span>
<span class="cm">				 * dynamically allocated</span>
<span class="cm">				 */</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

				<span class="cm">/* clear bit 2 - variable is writable */</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">;</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * check that variable is</span>
<span class="cm">			 * a writable Boolean array</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">charptr_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">];</span>

			<span class="cm">/* pop the count (number of bits to copy) */</span>
			<span class="n">long_count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="cm">/* pop the array index */</span>
			<span class="n">long_idx</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="n">reverse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * stack 0 = array right index</span>
<span class="cm">				 * stack 1 = array left index</span>
<span class="cm">				 */</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">&gt;</span> <span class="n">long_count</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">reverse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">long_count</span><span class="p">;</span>
					<span class="n">long_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">long_idx</span> <span class="o">-</span>
								<span class="n">long_count</span><span class="p">;</span>
					<span class="n">long_idx</span> <span class="o">=</span> <span class="n">long_tmp</span><span class="p">;</span>

					<span class="cm">/* reverse POPA is not supported */</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">long_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">long_count</span> <span class="o">-</span>
								<span class="n">long_idx</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="cm">/* pop the data */</span>
			<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">long_count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">long_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">long_tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">s32</span><span class="p">)</span> <span class="n">i</span><span class="p">))</span>
					<span class="n">charptr_tmp</span><span class="p">[</span><span class="n">long_idx</span> <span class="o">&gt;&gt;</span> <span class="mi">3L</span><span class="p">]</span> <span class="o">|=</span>
						<span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">&amp;</span> <span class="mi">7L</span><span class="p">));</span>
				<span class="k">else</span>
					<span class="n">charptr_tmp</span><span class="p">[</span><span class="n">long_idx</span> <span class="o">&gt;&gt;</span> <span class="mi">3L</span><span class="p">]</span> <span class="o">&amp;=</span>
						<span class="o">~</span><span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">&amp;</span> <span class="mi">7L</span><span class="p">));</span>

				<span class="o">++</span><span class="n">long_idx</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_JMPZ</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Pop stack and branch if zero</span>
<span class="cm">			 * ...argument 0 is address</span>
<span class="cm">			 * ...stack 0 is condition value</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pc</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">code_sect</span><span class="p">;</span>
					<span class="k">if</span> <span class="p">((</span><span class="n">pc</span> <span class="o">&lt;</span> <span class="n">code_sect</span><span class="p">)</span> <span class="o">||</span>
					    <span class="p">(</span><span class="n">pc</span> <span class="o">&gt;=</span> <span class="n">debug_sect</span><span class="p">))</span>
						<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_DS</span>:
		<span class="k">case</span> <span class="n">OP_IS</span>:
			<span class="cm">/*</span>
<span class="cm">			 * DRSCAN</span>
<span class="cm">			 * IRSCAN</span>
<span class="cm">			 * ...argument 0 is scan data variable ID</span>
<span class="cm">			 * ...stack 0 is array index</span>
<span class="cm">			 * ...stack 1 is count</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">long_idx</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">long_count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">reverse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * stack 0 = array right index</span>
<span class="cm">				 * stack 1 = array left index</span>
<span class="cm">				 * stack 2 = count</span>
<span class="cm">				 */</span>
				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">long_count</span><span class="p">;</span>
				<span class="n">long_count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">&gt;</span> <span class="n">long_tmp</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">reverse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">long_idx</span> <span class="o">=</span> <span class="n">long_tmp</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">charptr_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">reverse</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * allocate a buffer</span>
<span class="cm">				 * and reverse the data order</span>
<span class="cm">				 */</span>
				<span class="n">charptr_tmp2</span> <span class="o">=</span> <span class="n">charptr_tmp</span><span class="p">;</span>
				<span class="n">charptr_tmp</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">((</span><span class="n">long_count</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">charptr_tmp</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">long_idx</span> <span class="o">+</span> <span class="n">long_count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
				<span class="n">long_idx2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">long_idx2</span> <span class="o">&lt;</span> <span class="n">long_count</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">charptr_tmp2</span><span class="p">[</span><span class="n">long_tmp</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span>
							<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">long_tmp</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)))</span>
						<span class="n">charptr_tmp</span><span class="p">[</span><span class="n">long_idx2</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span>
							<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">long_idx2</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
					<span class="k">else</span>
						<span class="n">charptr_tmp</span><span class="p">[</span><span class="n">long_idx2</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span>
							<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">long_idx2</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>

					<span class="o">--</span><span class="n">long_tmp</span><span class="p">;</span>
					<span class="o">++</span><span class="n">long_idx2</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="mh">0x51</span><span class="p">)</span> <span class="cm">/* DS */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">altera_drscan</span><span class="p">(</span><span class="n">astate</span><span class="p">,</span> <span class="n">long_count</span><span class="p">,</span>
						<span class="n">charptr_tmp</span><span class="p">,</span> <span class="n">long_idx</span><span class="p">);</span>
			<span class="k">else</span> <span class="cm">/* IS */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">altera_irscan</span><span class="p">(</span><span class="n">astate</span><span class="p">,</span> <span class="n">long_count</span><span class="p">,</span>
						<span class="n">charptr_tmp</span><span class="p">,</span> <span class="n">long_idx</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">charptr_tmp</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_DPRA</span>:
			<span class="cm">/*</span>
<span class="cm">			 * DRPRE with array data</span>
<span class="cm">			 * ...argument 0 is variable ID</span>
<span class="cm">			 * ...stack 0 is array index</span>
<span class="cm">			 * ...stack 1 is count</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/*</span>
<span class="cm">				 * stack 0 = array right index</span>
<span class="cm">				 * stack 1 = array left index</span>
<span class="cm">				 */</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="n">index</span><span class="p">;</span>

			<span class="n">charptr_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_set_dr_pre</span><span class="p">(</span><span class="o">&amp;</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">js</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
							<span class="n">charptr_tmp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_DPOA</span>:
			<span class="cm">/*</span>
<span class="cm">			 * DRPOST with array data</span>
<span class="cm">			 * ...argument 0 is variable ID</span>
<span class="cm">			 * ...stack 0 is array index</span>
<span class="cm">			 * ...stack 1 is count</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/*</span>
<span class="cm">				 * stack 0 = array right index</span>
<span class="cm">				 * stack 1 = array left index</span>
<span class="cm">				 */</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="n">index</span><span class="p">;</span>

			<span class="n">charptr_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_set_dr_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">js</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
							<span class="n">charptr_tmp</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_IPRA</span>:
			<span class="cm">/*</span>
<span class="cm">			 * IRPRE with array data</span>
<span class="cm">			 * ...argument 0 is variable ID</span>
<span class="cm">			 * ...stack 0 is array index</span>
<span class="cm">			 * ...stack 1 is count</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/*</span>
<span class="cm">				 * stack 0 = array right index</span>
<span class="cm">				 * stack 1 = array left index</span>
<span class="cm">				 */</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="n">index</span><span class="p">;</span>

			<span class="n">charptr_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_set_ir_pre</span><span class="p">(</span><span class="o">&amp;</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">js</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
							<span class="n">charptr_tmp</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_IPOA</span>:
			<span class="cm">/*</span>
<span class="cm">			 * IRPOST with array data</span>
<span class="cm">			 * ...argument 0 is variable ID</span>
<span class="cm">			 * ...stack 0 is array index</span>
<span class="cm">			 * ...stack 1 is count</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/*</span>
<span class="cm">				 * stack 0 = array right index</span>
<span class="cm">				 * stack 1 = array left index</span>
<span class="cm">				 */</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="n">index</span><span class="p">;</span>

			<span class="n">charptr_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
			<span class="n">status</span> <span class="o">=</span> <span class="n">altera_set_ir_post</span><span class="p">(</span><span class="o">&amp;</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">js</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span>
							<span class="n">charptr_tmp</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_EXPT</span>:
			<span class="cm">/*</span>
<span class="cm">			 * EXPORT</span>
<span class="cm">			 * ...argument 0 is string ID</span>
<span class="cm">			 * ...stack 0 is integer expression</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">str_table</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
				<span class="n">altera_export_int</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">long_tmp</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_PSHE</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Push integer array element</span>
<span class="cm">			 * ...argument 0 is variable ID</span>
<span class="cm">			 * ...stack 0 is array index</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">variable_id</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

			<span class="cm">/* check variable type */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x19</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* writable integer array */</span>
				<span class="n">longptr_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">];</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">longptr_tmp</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x1f</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* read-only integer array */</span>
				<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">+</span>
						<span class="p">(</span><span class="n">index</span> <span class="o">*</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">));</span>
				<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span>
					<span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">long_tmp</span><span class="p">]);</span>
			<span class="p">}</span> <span class="k">else</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_PSHA</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Push Boolean array</span>
<span class="cm">			 * ...argument 0 is variable ID</span>
<span class="cm">			 * ...stack 0 is count</span>
<span class="cm">			 * ...stack 1 is array index</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">variable_id</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

			<span class="cm">/* check that variable is a Boolean array */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x18</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">charptr_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">];</span>

			<span class="cm">/* pop the count (number of bits to copy) */</span>
			<span class="n">count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="cm">/* pop the array index */</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="cm">/*</span>
<span class="cm">				 * stack 0 = array right index</span>
<span class="cm">				 * stack 1 = array left index</span>
<span class="cm">				 */</span>
				<span class="n">count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">count</span> <span class="o">-</span> <span class="n">index</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">32</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">long_tmp</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">charptr_tmp</span><span class="p">[(</span><span class="n">i</span> <span class="o">+</span> <span class="n">index</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span>
						<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">((</span><span class="n">i</span> <span class="o">+</span> <span class="n">index</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)))</span>
					<span class="n">long_tmp</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1L</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>

			<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_tmp</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_DYNA</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Dynamically change size of array</span>
<span class="cm">			 * ...argument 0 is variable ID</span>
<span class="cm">			 * ...stack 0 is new size</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">variable_id</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
			<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">long_tmp</span> <span class="o">&gt;</span> <span class="n">var_size</span><span class="p">[</span><span class="n">variable_id</span><span class="p">])</span> <span class="p">{</span>
				<span class="n">var_size</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_tmp</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
					<span class="cm">/* allocate integer array */</span>
					<span class="n">long_tmp</span> <span class="o">*=</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">long</span><span class="p">);</span>
				<span class="k">else</span>
					<span class="cm">/* allocate Boolean array */</span>
					<span class="n">long_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">long_tmp</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>

				<span class="cm">/*</span>
<span class="cm">				 * If the buffer was previously allocated,</span>
<span class="cm">				 * free it</span>
<span class="cm">				 */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]);</span>
					<span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/*</span>
<span class="cm">				 * Allocate a new buffer</span>
<span class="cm">				 * of the requested size</span>
<span class="cm">				 */</span>
				<span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span>
					<span class="n">kzalloc</span><span class="p">(</span><span class="n">long_tmp</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/*</span>
<span class="cm">				 * Set the attribute bit to indicate that</span>
<span class="cm">				 * this buffer was dynamically allocated and</span>
<span class="cm">				 * should be freed later</span>
<span class="cm">				 */</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

				<span class="cm">/* zero out memory */</span>
				<span class="n">count</span> <span class="o">=</span> <span class="p">((</span><span class="n">var_size</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7L</span><span class="p">)</span> <span class="o">/</span>
									<span class="mi">8L</span><span class="p">);</span>
				<span class="n">charptr_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)(</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">index</span><span class="p">)</span>
					<span class="n">charptr_tmp</span><span class="p">[</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_EXPV</span>:
			<span class="cm">/*</span>
<span class="cm">			 * Export Boolean array</span>
<span class="cm">			 * ...argument 0 is string ID</span>
<span class="cm">			 * ...stack 0 is variable ID</span>
<span class="cm">			 * ...stack 1 is array right index</span>
<span class="cm">			 * ...stack 2 is array left index</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* EXPV is not supported in JBC 1.0 */</span>
				<span class="n">bad_opcode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">str_table</span> <span class="o">+</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
			<span class="n">variable_id</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">long_idx</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span><span class="cm">/* right indx */</span>
			<span class="n">long_idx2</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span><span class="cm">/* left indx */</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">&gt;</span> <span class="n">long_idx2</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* reverse indices not supported */</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">long_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">long_idx2</span> <span class="o">-</span> <span class="n">long_idx</span><span class="p">;</span>

			<span class="n">charptr_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">];</span>
			<span class="n">charptr_tmp2</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">long_idx</span> <span class="o">&amp;</span> <span class="mi">7L</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">s32</span> <span class="n">k</span> <span class="o">=</span> <span class="n">long_idx</span><span class="p">;</span>
				<span class="n">charptr_tmp2</span> <span class="o">=</span>
					<span class="n">kzalloc</span><span class="p">(((</span><span class="n">long_count</span> <span class="o">+</span> <span class="mi">7L</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8L</span><span class="p">),</span>
							<span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">charptr_tmp2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">long_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">charptr_tmp</span><span class="p">[</span><span class="n">k</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span>
							<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">k</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)))</span>
						<span class="n">charptr_tmp2</span><span class="p">[</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span>
								<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
					<span class="k">else</span>
						<span class="n">charptr_tmp2</span><span class="p">[</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span>
								<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>

					<span class="o">++</span><span class="n">k</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">charptr_tmp</span> <span class="o">=</span> <span class="n">charptr_tmp2</span><span class="p">;</span>

			<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">charptr_tmp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">charptr_tmp</span><span class="p">[</span><span class="n">long_idx</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">];</span>

			<span class="n">altera_export_bool_array</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">charptr_tmp</span><span class="p">,</span>
							<span class="n">long_count</span><span class="p">);</span>

			<span class="cm">/* free allocated buffer */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">long_idx</span> <span class="o">&amp;</span> <span class="mi">7L</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">charptr_tmp2</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_COPY</span>: <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Array copy</span>
<span class="cm">			 * ...argument 0 is dest ID</span>
<span class="cm">			 * ...argument 1 is source ID</span>
<span class="cm">			 * ...stack 0 is count</span>
<span class="cm">			 * ...stack 1 is dest index</span>
<span class="cm">			 * ...stack 2 is source index</span>
<span class="cm">			 */</span>
			<span class="n">s32</span> <span class="n">copy_count</span><span class="p">;</span>
			<span class="n">s32</span> <span class="n">copy_index</span><span class="p">;</span>
			<span class="n">s32</span> <span class="n">copy_index2</span><span class="p">;</span>
			<span class="n">s32</span> <span class="n">destleft</span><span class="p">;</span>
			<span class="n">s32</span> <span class="n">src_count</span><span class="p">;</span>
			<span class="n">s32</span> <span class="n">dest_count</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">src_reverse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="kt">int</span> <span class="n">dest_reverse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">copy_count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">copy_index</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">copy_index2</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">reverse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * stack 0 = source right index</span>
<span class="cm">				 * stack 1 = source left index</span>
<span class="cm">				 * stack 2 = destination right index</span>
<span class="cm">				 * stack 3 = destination left index</span>
<span class="cm">				 */</span>
				<span class="n">destleft</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">copy_count</span> <span class="o">&gt;</span> <span class="n">copy_index</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">src_reverse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">reverse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">src_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">copy_count</span> <span class="o">-</span> <span class="n">copy_index</span><span class="p">;</span>
					<span class="cm">/* copy_index = source start index */</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="n">src_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">copy_index</span> <span class="o">-</span> <span class="n">copy_count</span><span class="p">;</span>
					<span class="cm">/* source start index */</span>
					<span class="n">copy_index</span> <span class="o">=</span> <span class="n">copy_count</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">copy_index2</span> <span class="o">&gt;</span> <span class="n">destleft</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dest_reverse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">reverse</span> <span class="o">=</span> <span class="o">!</span><span class="n">reverse</span><span class="p">;</span>
					<span class="n">dest_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">copy_index2</span> <span class="o">-</span> <span class="n">destleft</span><span class="p">;</span>
					<span class="cm">/* destination start index */</span>
					<span class="n">copy_index2</span> <span class="o">=</span> <span class="n">destleft</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span>
					<span class="n">dest_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">destleft</span> <span class="o">-</span> <span class="n">copy_index2</span><span class="p">;</span>

				<span class="n">copy_count</span> <span class="o">=</span> <span class="p">(</span><span class="n">src_count</span> <span class="o">&lt;</span> <span class="n">dest_count</span><span class="p">)</span> <span class="o">?</span>
							<span class="n">src_count</span> <span class="o">:</span> <span class="n">dest_count</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">((</span><span class="n">src_reverse</span> <span class="o">||</span> <span class="n">dest_reverse</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">(</span><span class="n">src_count</span> <span class="o">!=</span> <span class="n">dest_count</span><span class="p">))</span>
					<span class="cm">/*</span>
<span class="cm">					 * If either the source or destination</span>
<span class="cm">					 * is reversed, we can&#39;t tolerate</span>
<span class="cm">					 * a length mismatch, because we</span>
<span class="cm">					 * &quot;left justify&quot; arrays when copying.</span>
<span class="cm">					 * This won&#39;t work correctly</span>
<span class="cm">					 * with reversed arrays.</span>
<span class="cm">					 */</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="n">count</span> <span class="o">=</span> <span class="n">copy_count</span><span class="p">;</span>
			<span class="n">index</span> <span class="o">=</span> <span class="n">copy_index</span><span class="p">;</span>
			<span class="n">index2</span> <span class="o">=</span> <span class="n">copy_index2</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * If destination is a read-only array,</span>
<span class="cm">			 * allocate a buffer and convert it to a writable array</span>
<span class="cm">			 */</span>
			<span class="n">variable_id</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x9c</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0c</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Allocate a writable buffer for this array */</span>
				<span class="n">long_tmp</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">var_size</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7L</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3L</span><span class="p">;</span>
				<span class="n">charptr_tmp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">];</span>
				<span class="n">charptr_tmp</span> <span class="o">=</span>
					<span class="n">kzalloc</span><span class="p">(</span><span class="n">long_tmp</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">charptr_tmp</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* zero the buffer */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span> <span class="n">long_idx</span> <span class="o">&lt;</span> <span class="n">long_tmp</span><span class="p">;</span>
								<span class="o">++</span><span class="n">long_idx</span><span class="p">)</span>
					<span class="n">charptr_tmp</span><span class="p">[</span><span class="n">long_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* copy previous contents into buffer */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
					<span class="n">long_idx</span> <span class="o">&lt;</span> <span class="n">var_size</span><span class="p">[</span><span class="n">variable_id</span><span class="p">];</span>
								<span class="o">++</span><span class="n">long_idx</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">long_idx2</span> <span class="o">=</span> <span class="n">long_idx</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">charptr_tmp2</span><span class="p">[</span><span class="n">long_idx2</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span>
						<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">long_idx2</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)))</span>
						<span class="n">charptr_tmp</span><span class="p">[</span><span class="n">long_idx</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span>
							<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>

				<span class="p">}</span>

				<span class="cm">/*</span>
<span class="cm">				set bit 7 - buffer was dynamically allocated */</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

				<span class="cm">/* clear bit 2 - variable is writable */</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">;</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">charptr_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
			<span class="n">charptr_tmp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>

			<span class="cm">/* check if destination is a writable Boolean array */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
				<span class="n">index2</span> <span class="o">+=</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>

			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">charptr_tmp2</span><span class="p">[</span><span class="n">index</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span>
							<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">index</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)))</span>
					<span class="n">charptr_tmp</span><span class="p">[</span><span class="n">index2</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span>
							<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">index2</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>
				<span class="k">else</span>
					<span class="n">charptr_tmp</span><span class="p">[</span><span class="n">index2</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;=</span>
						<span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">index2</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>

				<span class="o">++</span><span class="n">index</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">reverse</span><span class="p">)</span>
					<span class="o">--</span><span class="n">index2</span><span class="p">;</span>
				<span class="k">else</span>
					<span class="o">++</span><span class="n">index2</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_DSC</span>:
		<span class="k">case</span> <span class="n">OP_ISC</span>: <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * DRSCAN with capture</span>
<span class="cm">			 * IRSCAN with capture</span>
<span class="cm">			 * ...argument 0 is scan data variable ID</span>
<span class="cm">			 * ...argument 1 is capture variable ID</span>
<span class="cm">			 * ...stack 0 is capture index</span>
<span class="cm">			 * ...stack 1 is scan data index</span>
<span class="cm">			 * ...stack 2 is count</span>
<span class="cm">			 */</span>
			<span class="n">s32</span> <span class="n">scan_right</span><span class="p">,</span> <span class="n">scan_left</span><span class="p">;</span>
			<span class="n">s32</span> <span class="n">capture_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">s32</span> <span class="n">scan_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">s32</span> <span class="n">capture_index</span><span class="p">;</span>
			<span class="n">s32</span> <span class="n">scan_index</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">capture_index</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">scan_index</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * stack 0 = capture right index</span>
<span class="cm">				 * stack 1 = capture left index</span>
<span class="cm">				 * stack 2 = scan right index</span>
<span class="cm">				 * stack 3 = scan left index</span>
<span class="cm">				 * stack 4 = count</span>
<span class="cm">				 */</span>
				<span class="n">scan_right</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
				<span class="n">scan_left</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
				<span class="n">capture_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">scan_index</span> <span class="o">-</span> <span class="n">capture_index</span><span class="p">;</span>
				<span class="n">scan_count</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">scan_left</span> <span class="o">-</span> <span class="n">scan_right</span><span class="p">;</span>
				<span class="n">scan_index</span> <span class="o">=</span> <span class="n">scan_right</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">long_count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="cm">/*</span>
<span class="cm">			 * If capture array is read-only, allocate a buffer</span>
<span class="cm">			 * and convert it to a writable array</span>
<span class="cm">			 */</span>
			<span class="n">variable_id</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
				<span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x9c</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x0c</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* Allocate a writable buffer for this array */</span>
				<span class="n">long_tmp</span> <span class="o">=</span>
					<span class="p">(</span><span class="n">var_size</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">+</span> <span class="mi">7L</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">3L</span><span class="p">;</span>
				<span class="n">charptr_tmp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">];</span>
				<span class="n">charptr_tmp</span> <span class="o">=</span>
					<span class="n">kzalloc</span><span class="p">(</span><span class="n">long_tmp</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
				<span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">charptr_tmp</span><span class="p">;</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">vars</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
					<span class="k">break</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* zero the buffer */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span> <span class="n">long_idx</span> <span class="o">&lt;</span> <span class="n">long_tmp</span><span class="p">;</span>
								<span class="o">++</span><span class="n">long_idx</span><span class="p">)</span>
					<span class="n">charptr_tmp</span><span class="p">[</span><span class="n">long_idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="cm">/* copy previous contents into buffer */</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
					<span class="n">long_idx</span> <span class="o">&lt;</span> <span class="n">var_size</span><span class="p">[</span><span class="n">variable_id</span><span class="p">];</span>
								<span class="o">++</span><span class="n">long_idx</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">long_idx2</span> <span class="o">=</span> <span class="n">long_idx</span><span class="p">;</span>

					<span class="k">if</span> <span class="p">(</span><span class="n">charptr_tmp2</span><span class="p">[</span><span class="n">long_idx2</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span>
						<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">long_idx2</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)))</span>
						<span class="n">charptr_tmp</span><span class="p">[</span><span class="n">long_idx</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">|=</span>
							<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">long_idx</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">));</span>

				<span class="p">}</span>

				<span class="cm">/*</span>
<span class="cm">				 * set bit 7 - buffer was</span>
<span class="cm">				 * dynamically allocated</span>
<span class="cm">				 */</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>

				<span class="cm">/* clear bit 2 - variable is writable */</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x04</span><span class="p">;</span>
				<span class="n">attrs</span><span class="p">[</span><span class="n">variable_id</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x01</span><span class="p">;</span>

			<span class="p">}</span>

			<span class="n">charptr_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
			<span class="n">charptr_tmp2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="p">((</span><span class="n">long_count</span> <span class="o">&gt;</span> <span class="n">capture_count</span><span class="p">)</span> <span class="o">||</span>
					<span class="p">(</span><span class="n">long_count</span> <span class="o">&gt;</span> <span class="n">scan_count</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="cm">/*</span>
<span class="cm">			 * check that capture array</span>
<span class="cm">			 * is a writable Boolean array</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">attrs</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">&amp;</span> <span class="mh">0x1c</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x08</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">opcode</span> <span class="o">==</span> <span class="mh">0x82</span><span class="p">)</span> <span class="cm">/* DSC */</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">altera_swap_dr</span><span class="p">(</span><span class="n">astate</span><span class="p">,</span>
							<span class="n">long_count</span><span class="p">,</span>
							<span class="n">charptr_tmp</span><span class="p">,</span>
							<span class="n">scan_index</span><span class="p">,</span>
							<span class="n">charptr_tmp2</span><span class="p">,</span>
							<span class="n">capture_index</span><span class="p">);</span>
				<span class="k">else</span> <span class="cm">/* ISC */</span>
					<span class="n">status</span> <span class="o">=</span> <span class="n">altera_swap_ir</span><span class="p">(</span><span class="n">astate</span><span class="p">,</span>
							<span class="n">long_count</span><span class="p">,</span>
							<span class="n">charptr_tmp</span><span class="p">,</span>
							<span class="n">scan_index</span><span class="p">,</span>
							<span class="n">charptr_tmp2</span><span class="p">,</span>
							<span class="n">capture_index</span><span class="p">);</span>

			<span class="p">}</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">case</span> <span class="n">OP_WAIT</span>:
			<span class="cm">/*</span>
<span class="cm">			 * WAIT</span>
<span class="cm">			 * ...argument 0 is wait state</span>
<span class="cm">			 * ...argument 1 is end state</span>
<span class="cm">			 * ...stack 0 is cycles</span>
<span class="cm">			 * ...stack 1 is microseconds</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">long_tmp</span> <span class="o">!=</span> <span class="mi">0L</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">altera_wait_cycles</span><span class="p">(</span><span class="n">astate</span><span class="p">,</span> <span class="n">long_tmp</span><span class="p">,</span>
								<span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

			<span class="n">long_tmp</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">long_tmp</span> <span class="o">!=</span> <span class="mi">0L</span><span class="p">))</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">altera_wait_msecs</span><span class="p">(</span><span class="n">astate</span><span class="p">,</span>
								<span class="n">long_tmp</span><span class="p">,</span>
								<span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">altera_goto_jstate</span><span class="p">(</span><span class="n">astate</span><span class="p">,</span>
								<span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span> <span class="cm">/* throw away MAX cycles */</span>
				<span class="o">--</span><span class="n">stack_ptr</span><span class="p">;</span> <span class="cm">/* throw away MAX microseconds */</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">OP_CMPA</span>: <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Array compare</span>
<span class="cm">			 * ...argument 0 is source 1 ID</span>
<span class="cm">			 * ...argument 1 is source 2 ID</span>
<span class="cm">			 * ...argument 2 is mask ID</span>
<span class="cm">			 * ...stack 0 is source 1 index</span>
<span class="cm">			 * ...stack 1 is source 2 index</span>
<span class="cm">			 * ...stack 2 is mask index</span>
<span class="cm">			 * ...stack 3 is count</span>
<span class="cm">			 */</span>
			<span class="n">s32</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">source1</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]];</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">source2</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]];</span>
			<span class="n">u8</span> <span class="o">*</span><span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">args</span><span class="p">[</span><span class="mi">2</span><span class="p">]];</span>
			<span class="n">u32</span> <span class="n">index1</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">index2</span><span class="p">;</span>
			<span class="n">u32</span> <span class="n">mask_index</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">altera_check_stack</span><span class="p">(</span><span class="n">stack_ptr</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">))</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">index1</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">index2</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">mask_index</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
			<span class="n">long_count</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * stack 0 = source 1 right index</span>
<span class="cm">				 * stack 1 = source 1 left index</span>
<span class="cm">				 * stack 2 = source 2 right index</span>
<span class="cm">				 * stack 3 = source 2 left index</span>
<span class="cm">				 * stack 4 = mask right index</span>
<span class="cm">				 * stack 5 = mask left index</span>
<span class="cm">				 */</span>
				<span class="n">s32</span> <span class="n">mask_right</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
				<span class="n">s32</span> <span class="n">mask_left</span> <span class="o">=</span> <span class="n">stack</span><span class="p">[</span><span class="o">--</span><span class="n">stack_ptr</span><span class="p">];</span>
				<span class="cm">/* source 1 count */</span>
				<span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">index2</span> <span class="o">-</span> <span class="n">index1</span><span class="p">;</span>
				<span class="cm">/* source 2 count */</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">long_count</span> <span class="o">-</span> <span class="n">mask_index</span><span class="p">;</span>
				<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span> <span class="o">?</span> <span class="n">a</span> <span class="o">:</span> <span class="n">b</span><span class="p">;</span>
				<span class="cm">/* mask count */</span>
				<span class="n">b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">mask_left</span> <span class="o">-</span> <span class="n">mask_right</span><span class="p">;</span>
				<span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">)</span> <span class="o">?</span> <span class="n">a</span> <span class="o">:</span> <span class="n">b</span><span class="p">;</span>
				<span class="cm">/* source 2 start index */</span>
				<span class="n">index2</span> <span class="o">=</span> <span class="n">mask_index</span><span class="p">;</span>
				<span class="cm">/* mask start index */</span>
				<span class="n">mask_index</span> <span class="o">=</span> <span class="n">mask_right</span><span class="p">;</span>
				<span class="n">long_count</span> <span class="o">=</span> <span class="n">a</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">long_tmp</span> <span class="o">=</span> <span class="mi">1L</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">long_count</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERANGE</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">count</span> <span class="o">=</span> <span class="n">long_count</span><span class="p">;</span>

				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
					<span class="k">if</span> <span class="p">(</span><span class="n">mask</span><span class="p">[</span><span class="n">mask_index</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span>
						<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">mask_index</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)))</span> <span class="p">{</span>
						<span class="n">a</span> <span class="o">=</span> <span class="n">source1</span><span class="p">[</span><span class="n">index1</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span>
							<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">index1</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span>
								<span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
						<span class="n">b</span> <span class="o">=</span> <span class="n">source2</span><span class="p">[</span><span class="n">index2</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span>
							<span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">index2</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">))</span>
								<span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

						<span class="k">if</span> <span class="p">(</span><span class="n">a</span> <span class="o">!=</span> <span class="n">b</span><span class="p">)</span> <span class="cm">/* failure */</span>
							<span class="n">long_tmp</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
					<span class="p">}</span>
					<span class="o">++</span><span class="n">index1</span><span class="p">;</span>
					<span class="o">++</span><span class="n">index2</span><span class="p">;</span>
					<span class="o">++</span><span class="n">mask_index</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>

			<span class="n">stack</span><span class="p">[</span><span class="n">stack_ptr</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">long_tmp</span><span class="p">;</span>

			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="nl">default:</span>
			<span class="cm">/* Unrecognized opcode -- ERROR! */</span>
			<span class="n">bad_opcode</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">bad_opcode</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">stack_ptr</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">stack_ptr</span> <span class="o">&gt;=</span> <span class="n">ALTERA_STACK_SIZE</span><span class="p">))</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EOVERFLOW</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">done</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="o">*</span><span class="n">error_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">s32</span><span class="p">)(</span><span class="n">opcode_address</span> <span class="o">-</span> <span class="n">code_sect</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">altera_free_buffers</span><span class="p">(</span><span class="n">astate</span><span class="p">);</span>

	<span class="cm">/* Free all dynamically allocated arrays */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">attrs</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">vars</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sym_count</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">attrs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span>
				<span class="n">kfree</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">vars</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">vars</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">var_size</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">attrs</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">proc_attributes</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">altera_get_note</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">s32</span> <span class="n">program_size</span><span class="p">,</span>
			<span class="n">s32</span> <span class="o">*</span><span class="n">offset</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">key</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">value</span><span class="p">,</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span>
<span class="cm">/*</span>
<span class="cm"> * Gets key and value of NOTE fields in the JBC file.</span>
<span class="cm"> * Can be called in two modes:  if offset pointer is NULL,</span>
<span class="cm"> * then the function searches for note fields which match</span>
<span class="cm"> * the key string provided.  If offset is not NULL, then</span>
<span class="cm"> * the function finds the next note field of any key,</span>
<span class="cm"> * starting at the offset specified by the offset pointer.</span>
<span class="cm"> * Returns 0 for success, else appropriate error code</span>
<span class="cm"> */</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">note_strings</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">note_table</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">note_count</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">first_word</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key_ptr</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">value_ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* Read header information */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">program_size</span> <span class="o">&gt;</span> <span class="mi">52L</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">first_word</span>    <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_word</span> <span class="o">&amp;</span> <span class="mi">1L</span><span class="p">);</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">version</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">note_strings</span>  <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span> <span class="o">+</span> <span class="n">delta</span><span class="p">]);</span>
		<span class="n">note_table</span>    <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">12</span> <span class="o">+</span> <span class="n">delta</span><span class="p">]);</span>
		<span class="n">note_count</span>    <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">44</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">delta</span><span class="p">)]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">first_word</span> <span class="o">!=</span> <span class="mh">0x4A414D00L</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">first_word</span> <span class="o">!=</span> <span class="mh">0x4A414D01L</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">note_count</span> <span class="o">&lt;=</span> <span class="mi">0L</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We will search for the first note with a specific key,</span>
<span class="cm">		 * and return only the value</span>
<span class="cm">		 */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">note_count</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">key_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">note_strings</span> <span class="o">+</span>
					<span class="n">get_unaligned_be32</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">note_table</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">i</span><span class="p">)])];</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">strnicmp</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key_ptr</span><span class="p">,</span> <span class="n">strlen</span><span class="p">(</span><span class="n">key_ptr</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
						<span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

				<span class="n">value_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">note_strings</span> <span class="o">+</span>
						<span class="n">get_unaligned_be32</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">note_table</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])];</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">strlcpy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value_ptr</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * We will search for the next note, regardless of the key,</span>
<span class="cm">		 * and return both the value and the key</span>
<span class="cm">		 */</span>

		<span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="n">offset</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">i</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">&lt;</span> <span class="n">note_count</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">key</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">strlcpy</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">note_strings</span> <span class="o">+</span>
						<span class="n">get_unaligned_be32</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">note_table</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">i</span><span class="p">)])],</span>
					<span class="n">length</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">strlcpy</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">note_strings</span> <span class="o">+</span>
						<span class="n">get_unaligned_be32</span><span class="p">(</span>
						<span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">note_table</span> <span class="o">+</span> <span class="p">(</span><span class="mi">8</span> <span class="o">*</span> <span class="n">i</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">])],</span>
					<span class="n">length</span><span class="p">);</span>

			<span class="o">*</span><span class="n">offset</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">altera_check_crc</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="n">s32</span> <span class="n">program_size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">local_expected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="n">local_actual</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
	    <span class="n">shift_reg</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">bit</span><span class="p">,</span> <span class="n">feedback</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">databyte</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">crc_section</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">first_word</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">delta</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">program_size</span> <span class="o">&gt;</span> <span class="mi">52L</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">first_word</span>  <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_word</span> <span class="o">&amp;</span> <span class="mi">1L</span><span class="p">);</span>
		<span class="n">delta</span> <span class="o">=</span> <span class="n">version</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>

		<span class="n">crc_section</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">32</span> <span class="o">+</span> <span class="n">delta</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">first_word</span> <span class="o">!=</span> <span class="mh">0x4A414D00L</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">first_word</span> <span class="o">!=</span> <span class="mh">0x4A414D01L</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">crc_section</span> <span class="o">&gt;=</span> <span class="n">program_size</span><span class="p">)</span>
		<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">local_expected</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="n">get_unaligned_be16</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">crc_section</span><span class="p">]);</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">crc_section</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">databyte</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">bit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">bit</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">bit</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">feedback</span> <span class="o">=</span> <span class="p">(</span><span class="n">databyte</span> <span class="o">^</span> <span class="n">shift_reg</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">;</span>
				<span class="n">shift_reg</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">feedback</span><span class="p">)</span>
					<span class="n">shift_reg</span> <span class="o">^=</span> <span class="mh">0x8408</span><span class="p">;</span>

				<span class="n">databyte</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">local_actual</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)</span><span class="o">~</span><span class="n">shift_reg</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">local_expected</span> <span class="o">!=</span> <span class="n">local_actual</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EILSEQ</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">||</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">0</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: CRC matched: %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">local_actual</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EILSEQ</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: CRC mismatch: expected %04x, &quot;</span>
				<span class="s">&quot;actual %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">local_expected</span><span class="p">,</span>
				<span class="n">local_actual</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">ENODATA</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: expected CRC not found, &quot;</span>
				<span class="s">&quot;actual CRC = %04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">local_actual</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="o">-</span><span class="n">EIO</span>:
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: error: format isn&#39;t &quot;</span>
				<span class="s">&quot;recognized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: CRC function returned error &quot;</span>
				<span class="s">&quot;code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">altera_get_file_info</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					<span class="n">s32</span> <span class="n">program_size</span><span class="p">,</span>
					<span class="kt">int</span> <span class="o">*</span><span class="n">format_version</span><span class="p">,</span>
					<span class="kt">int</span> <span class="o">*</span><span class="n">action_count</span><span class="p">,</span>
					<span class="kt">int</span> <span class="o">*</span><span class="n">procedure_count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">first_word</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">program_size</span> <span class="o">&lt;=</span> <span class="mi">52L</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">first_word</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">first_word</span> <span class="o">==</span> <span class="mh">0x4A414D00L</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">first_word</span> <span class="o">==</span> <span class="mh">0x4A414D01L</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">version</span> <span class="o">=</span> <span class="p">(</span><span class="n">first_word</span> <span class="o">&amp;</span> <span class="mi">1L</span><span class="p">);</span>
		<span class="o">*</span><span class="n">format_version</span> <span class="o">=</span> <span class="n">version</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="o">*</span><span class="n">action_count</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">48</span><span class="p">]);</span>
			<span class="o">*</span><span class="n">procedure_count</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">52</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">altera_get_act_info</span><span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span>
					<span class="n">s32</span> <span class="n">program_size</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">index</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">**</span><span class="n">name</span><span class="p">,</span>
					<span class="kt">char</span> <span class="o">**</span><span class="n">description</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">altera_procinfo</span> <span class="o">**</span><span class="n">proc_list</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">altera_procinfo</span> <span class="o">*</span><span class="n">procptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">altera_procinfo</span> <span class="o">*</span><span class="n">tmpptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">first_word</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">action_table</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">proc_table</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">str_table</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">note_strings</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">action_count</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">proc_count</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">act_name_id</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">act_desc_id</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">act_proc_id</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">act_proc_name</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">act_proc_attribute</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">program_size</span> <span class="o">&lt;=</span> <span class="mi">52L</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="cm">/* Read header information */</span>
	<span class="n">first_word</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">first_word</span> <span class="o">!=</span> <span class="mh">0x4A414D01L</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">action_table</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>
	<span class="n">proc_table</span>   <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">8</span><span class="p">]);</span>
	<span class="n">str_table</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">12</span><span class="p">]);</span>
	<span class="n">note_strings</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">16</span><span class="p">]);</span>
	<span class="n">action_count</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">48</span><span class="p">]);</span>
	<span class="n">proc_count</span>   <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="mi">52</span><span class="p">]);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">&gt;=</span> <span class="n">action_count</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">act_name_id</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">action_table</span> <span class="o">+</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">index</span><span class="p">)]);</span>
	<span class="n">act_desc_id</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">action_table</span> <span class="o">+</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]);</span>
	<span class="n">act_proc_id</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">action_table</span> <span class="o">+</span> <span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]);</span>

	<span class="o">*</span><span class="n">name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">str_table</span> <span class="o">+</span> <span class="n">act_name_id</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">act_desc_id</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">note_strings</span> <span class="o">-</span> <span class="n">str_table</span><span class="p">))</span>
		<span class="o">*</span><span class="n">description</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">str_table</span> <span class="o">+</span> <span class="n">act_desc_id</span><span class="p">];</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">act_proc_name</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span>
					<span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">proc_table</span> <span class="o">+</span> <span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="n">act_proc_id</span><span class="p">)]);</span>
		<span class="n">act_proc_attribute</span> <span class="o">=</span>
			<span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">proc_table</span> <span class="o">+</span> <span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="n">act_proc_id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x03</span><span class="p">);</span>

		<span class="n">procptr</span> <span class="o">=</span>
				<span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">altera_procinfo</span><span class="p">),</span>
								<span class="n">GFP_KERNEL</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">procptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">status</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">procptr</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">str_table</span> <span class="o">+</span> <span class="n">act_proc_name</span><span class="p">];</span>
			<span class="n">procptr</span><span class="o">-&gt;</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">act_proc_attribute</span><span class="p">;</span>
			<span class="n">procptr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

			<span class="cm">/* add record to end of linked list */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">proc_list</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="o">*</span><span class="n">proc_list</span> <span class="o">=</span> <span class="n">procptr</span><span class="p">;</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="n">tmpptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">proc_list</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">tmpptr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
					<span class="n">tmpptr</span> <span class="o">=</span> <span class="n">tmpptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">tmpptr</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">procptr</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">act_proc_id</span> <span class="o">=</span> <span class="n">get_unaligned_be32</span><span class="p">(</span>
				<span class="o">&amp;</span><span class="n">p</span><span class="p">[</span><span class="n">proc_table</span> <span class="o">+</span> <span class="p">(</span><span class="mi">13</span> <span class="o">*</span> <span class="n">act_proc_id</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">act_proc_id</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">act_proc_id</span> <span class="o">&lt;</span> <span class="n">proc_count</span><span class="p">));</span>

	<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="n">altera_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">altera_config</span> <span class="o">*</span><span class="n">config</span><span class="p">,</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">altera_state</span> <span class="o">*</span><span class="n">astate</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">altera_procinfo</span> <span class="o">*</span><span class="n">proc_list</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">altera_procinfo</span> <span class="o">*</span><span class="n">procptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">key</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">action_name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">description</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">exec_result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">format_version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">action_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">procedure_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">error_address</span> <span class="o">=</span> <span class="mi">0L</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">33</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">value</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="mi">257</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_key</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">astate</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">altera_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">astate</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">free_value</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">astate</span><span class="o">-&gt;</span><span class="n">config</span> <span class="o">=</span> <span class="n">config</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">jtag_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dprintk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: using byteblaster!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">astate</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">jtag_io</span> <span class="o">=</span> <span class="n">netup_jtag_io_lpt</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">altera_check_crc</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">altera_get_file_info</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format_version</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">action_count</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">procedure_count</span><span class="p">);</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: File format is %s ByteCode format</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="p">(</span><span class="n">format_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;Jam STAPL&quot;</span> <span class="o">:</span>
						<span class="s">&quot;pre-standardized Jam 1.1&quot;</span><span class="p">);</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">altera_get_note</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">offset</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="mi">256</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: NOTE </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> = </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
					<span class="n">__func__</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">debug</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">format_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">action_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: Actions available:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">index</span> <span class="o">&lt;</span> <span class="n">action_count</span><span class="p">;</span> <span class="o">++</span><span class="n">index</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">altera_get_act_info</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
						<span class="n">index</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">action_name</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">description</span><span class="p">,</span>
						<span class="o">&amp;</span><span class="n">proc_list</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">description</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span>
						<span class="n">action_name</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s: %s </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span>
						<span class="n">action_name</span><span class="p">,</span>
						<span class="n">description</span><span class="p">);</span>

			<span class="n">procptr</span> <span class="o">=</span> <span class="n">proc_list</span><span class="p">;</span>
			<span class="k">while</span> <span class="p">(</span><span class="n">procptr</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">procptr</span><span class="o">-&gt;</span><span class="n">attrs</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;%s:    %s (%s)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">__func__</span><span class="p">,</span>
						<span class="n">procptr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
						<span class="p">(</span><span class="n">procptr</span><span class="o">-&gt;</span><span class="n">attrs</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span>
						<span class="s">&quot;optional&quot;</span> <span class="o">:</span> <span class="s">&quot;recommended&quot;</span><span class="p">);</span>

				<span class="n">proc_list</span> <span class="o">=</span> <span class="n">procptr</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="n">kfree</span><span class="p">(</span><span class="n">procptr</span><span class="p">);</span>
				<span class="n">procptr</span> <span class="o">=</span> <span class="n">proc_list</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">exec_result</span> <span class="o">=</span> <span class="n">altera_execute</span><span class="p">(</span><span class="n">astate</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">error_address</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">exit_code</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">format_version</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">exit_code</span><span class="p">)</span>
		<span class="n">exec_result</span> <span class="o">=</span> <span class="o">-</span><span class="n">EREMOTEIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">format_version</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">exec_result</span> <span class="o">==</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">astate</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">action</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: error: no action specified for &quot;</span>
				<span class="s">&quot;Jam STAPL file.</span><span class="se">\n</span><span class="s">program terminated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">__func__</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: error: action </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">&quot;</span>
				<span class="s">&quot; is not supported &quot;</span>
				<span class="s">&quot;for this Jam STAPL file.</span><span class="se">\n</span><span class="s">&quot;</span>
				<span class="s">&quot;Program terminated.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
				<span class="n">astate</span><span class="o">-&gt;</span><span class="n">config</span><span class="o">-&gt;</span><span class="n">action</span><span class="p">);</span>

	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">exec_result</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s: error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">exec_result</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">astate</span><span class="p">);</span>
<span class="nl">free_value:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
<span class="nl">free_key:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">altera_init</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
