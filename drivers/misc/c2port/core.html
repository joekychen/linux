<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › misc › c2port › core.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>core.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Silicon Labs C2 port core Linux support</span>
<span class="cm"> *</span>
<span class="cm"> *  Copyright (c) 2007 Rodolfo Giometti &lt;giometti@linux.it&gt;</span>
<span class="cm"> *  Copyright (c) 2007 Eurotech S.p.A. &lt;info@eurotech.it&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify it</span>
<span class="cm"> * under the terms of the GNU General Public License version 2 as published by</span>
<span class="cm"> * the Free Software Foundation</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/err.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/kmemcheck.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;linux/c2port.h&gt;</span>

<span class="cp">#define DRIVER_NAME             &quot;c2port&quot;</span>
<span class="cp">#define DRIVER_VERSION          &quot;0.51.0&quot;</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">c2port_idr_lock</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_IDR</span><span class="p">(</span><span class="n">c2port_idr</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Local variables</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">c2port_class</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * C2 registers &amp; commands defines</span>
<span class="cm"> */</span>

<span class="cm">/* C2 registers */</span>
<span class="cp">#define C2PORT_DEVICEID		0x00</span>
<span class="cp">#define C2PORT_REVID		0x01</span>
<span class="cp">#define C2PORT_FPCTL		0x02</span>
<span class="cp">#define C2PORT_FPDAT		0xB4</span>

<span class="cm">/* C2 interface commands */</span>
<span class="cp">#define C2PORT_GET_VERSION	0x01</span>
<span class="cp">#define C2PORT_DEVICE_ERASE	0x03</span>
<span class="cp">#define C2PORT_BLOCK_READ	0x06</span>
<span class="cp">#define C2PORT_BLOCK_WRITE	0x07</span>
<span class="cp">#define C2PORT_PAGE_ERASE	0x08</span>

<span class="cm">/* C2 status return codes */</span>
<span class="cp">#define C2PORT_INVALID_COMMAND	0x00</span>
<span class="cp">#define C2PORT_COMMAND_FAILED	0x02</span>
<span class="cp">#define C2PORT_COMMAND_OK	0x0d</span>

<span class="cm">/*</span>
<span class="cm"> * C2 port low level signal managements</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">c2port_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="cm">/* To reset the device we have to keep clock line low for at least</span>
<span class="cm">	 * 20us.</span>
<span class="cm">	 */</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2ck_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2ck_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">local_irq_enable</span><span class="p">();</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">c2port_strobe_ck</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="cm">/* During hi-low-hi transition we disable local IRQs to avoid</span>
<span class="cm">	 * interructions since C2 port specification says that it must be</span>
<span class="cm">	 * shorter than 5us, otherwise the microcontroller may consider</span>
<span class="cm">	 * it as a reset signal!</span>
<span class="cm">	 */</span>
	<span class="n">local_irq_disable</span><span class="p">();</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2ck_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2ck_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">local_irq_enable</span><span class="p">();</span>

	<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * C2 port basic functions</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">c2port_write_ar</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* START field */</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* INS field (11b, LSB first) */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_dir</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* ADDRESS field */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* STOP field */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_dir</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c2port_read_ar</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">addr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* START field */</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* INS field (10b, LSB first) */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_dir</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* ADDRESS field */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_dir</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="o">*</span><span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">addr</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* shift in 8-bit ADDRESS field LSB first */</span>

		<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_get</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="o">*</span><span class="n">addr</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* STOP field */</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c2port_write_dr</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* START field */</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* INS field (01b, LSB first) */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_dir</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* LENGTH field (00b, LSB first -&gt; 1 byte) */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* DATA field */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">);</span>
		<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* WAIT field */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_dir</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_get</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* STOP field */</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c2port_read_dr</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">timeout</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* START field */</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* INS field (00b, LSB first) */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_dir</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* LENGTH field (00b, LSB first -&gt; 1 byte) */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* WAIT field */</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_dir</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">timeout</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>
	<span class="k">do</span> <span class="p">{</span>
		<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_get</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="cm">/* DATA field */</span>
	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">data</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>	<span class="cm">/* shift in 8-bit DATA field LSB first */</span>

		<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_get</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
			<span class="o">*</span><span class="n">data</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* STOP field */</span>
	<span class="n">c2port_strobe_ck</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c2port_poll_in_busy</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">20</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">c2port_read_ar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">c2port_poll_out_ready</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">addr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">timeout</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">;</span> <span class="cm">/* erase flash needs long time... */</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">c2port_read_ar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">addr</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">udelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">timeout</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * sysfs methods</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">c2port_show_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">c2port_show_flash_blocks_num</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c2port_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">blocks_num</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">c2port_show_flash_block_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c2port_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">c2port_show_flash_size</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c2port_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">blocks_num</span> <span class="o">*</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">c2port_show_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">c2port_store_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">c2port_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">access</span> <span class="o">=</span> <span class="o">!!</span><span class="n">status</span><span class="p">;</span>

	<span class="cm">/* If access is &quot;on&quot; clock should be HIGH _before_ setting the line</span>
<span class="cm">	 * as output and data line should be set as INPUT anyway */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">)</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2ck_set</span><span class="p">(</span><span class="n">c2dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">(</span><span class="n">c2dev</span><span class="p">,</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">)</span>
		<span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_dir</span><span class="p">(</span><span class="n">c2dev</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">c2port_store_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Check the device access status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="n">c2port_reset</span><span class="p">(</span><span class="n">c2dev</span><span class="p">);</span>
	<span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">flash_access</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">__c2port_show_dev_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Select DEVICEID register for C2 data register accesses */</span>
	<span class="n">c2port_write_ar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">C2PORT_DEVICEID</span><span class="p">);</span>

	<span class="cm">/* Read and return the device ID register */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_read_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">c2port_show_dev_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Check the device access status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__c2port_show_dev_id</span><span class="p">(</span><span class="n">c2dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot read from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">__c2port_show_rev_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Select REVID register for C2 data register accesses */</span>
	<span class="n">c2port_write_ar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">C2PORT_REVID</span><span class="p">);</span>

	<span class="cm">/* Read and return the revision ID register */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_read_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">c2port_show_rev_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Check the device access status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__c2port_show_rev_id</span><span class="p">(</span><span class="n">c2dev</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot read from %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">c2port_show_flash_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">flash_access</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">__c2port_store_flash_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
						<span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Check the device access status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">flash_access</span> <span class="o">=</span> <span class="o">!!</span><span class="n">status</span><span class="p">;</span>

	<span class="cm">/* If flash_access is off we have nothing to do... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">flash_access</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Target the C2 flash programming control register for C2 data</span>
<span class="cm">	 * register access */</span>
	<span class="n">c2port_write_ar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">C2PORT_FPCTL</span><span class="p">);</span>

	<span class="cm">/* Write the first keycode to enable C2 Flash programming */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Write the second keycode to enable C2 Flash programming */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Delay for at least 20ms to ensure the target is ready for</span>
<span class="cm">	 * C2 flash programming */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">25</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">c2port_store_flash_access</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__c2port_store_flash_access</span><span class="p">(</span><span class="n">c2dev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot enable %s flash programming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">__c2port_write_flash_erase</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Target the C2 flash programming data register for C2 data register</span>
<span class="cm">	 * access.</span>
<span class="cm">	 */</span>
	<span class="n">c2port_write_ar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">C2PORT_FPDAT</span><span class="p">);</span>

	<span class="cm">/* Send device erase command */</span>
	<span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">C2PORT_DEVICE_ERASE</span><span class="p">);</span>

	<span class="cm">/* Wait for input acknowledge */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_in_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Should check status before starting FLASH access sequence */</span>

	<span class="cm">/* Wait for status information */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_out_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Read flash programming interface status */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_read_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">C2PORT_COMMAND_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Send a three-byte arming sequence to enable the device erase.</span>
<span class="cm">	 * If the sequence is not received correctly, the command will be</span>
<span class="cm">	 * ignored.</span>
<span class="cm">	 * Sequence is: 0xde, 0xad, 0xa5.</span>
<span class="cm">	 */</span>
	<span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xde</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_in_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xad</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_in_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mh">0xa5</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_in_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_out_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">c2port_store_flash_erase</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Check the device and flash access status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">access</span> <span class="o">||</span> <span class="o">!</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">flash_access</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__c2port_write_flash_erase</span><span class="p">(</span><span class="n">c2dev</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot erase %s flash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">__c2port_read_flash_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">nread</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Check for flash end */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">*</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">blocks_num</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">*</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">blocks_num</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">nread</span><span class="p">)</span>
		<span class="n">nread</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">*</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">blocks_num</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">nread</span><span class="p">)</span>
		<span class="n">nread</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nread</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">nread</span><span class="p">;</span>

	<span class="cm">/* Target the C2 flash programming data register for C2 data register</span>
<span class="cm">	 * access */</span>
	<span class="n">c2port_write_ar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">C2PORT_FPDAT</span><span class="p">);</span>

	<span class="cm">/* Send flash block read command */</span>
	<span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">C2PORT_BLOCK_READ</span><span class="p">);</span>

	<span class="cm">/* Wait for input acknowledge */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_in_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Should check status before starting FLASH access sequence */</span>

	<span class="cm">/* Wait for status information */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_out_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Read flash programming interface status */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_read_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">C2PORT_COMMAND_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Send address high byte */</span>
	<span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_in_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Send address low byte */</span>
	<span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_in_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Send address block size */</span>
	<span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nread</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_in_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Should check status before reading FLASH block */</span>

	<span class="cm">/* Wait for status information */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_out_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Read flash programming interface status */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_read_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">C2PORT_COMMAND_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Read flash block */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nread</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_out_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_read_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">buffer</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">nread</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">c2port_read_flash_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span> <span class="o">=</span>
			<span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">));</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Check the device and flash access status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">access</span> <span class="o">||</span> <span class="o">!</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">flash_access</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__c2port_read_flash_data</span><span class="p">(</span><span class="n">c2dev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot read %s flash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">__c2port_write_flash_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_ops</span> <span class="o">*</span><span class="n">ops</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">status</span><span class="p">,</span> <span class="n">nwrite</span> <span class="o">=</span> <span class="mi">128</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nwrite</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
		<span class="n">nwrite</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">*</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">blocks_num</span> <span class="o">-</span> <span class="n">offset</span> <span class="o">&lt;</span> <span class="n">nwrite</span><span class="p">)</span>
		<span class="n">nwrite</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">*</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">blocks_num</span> <span class="o">-</span> <span class="n">offset</span><span class="p">;</span>

	<span class="cm">/* Check for flash end */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">offset</span> <span class="o">&gt;=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">block_size</span> <span class="o">*</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">blocks_num</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Target the C2 flash programming data register for C2 data register</span>
<span class="cm">	 * access */</span>
	<span class="n">c2port_write_ar</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">C2PORT_FPDAT</span><span class="p">);</span>

	<span class="cm">/* Send flash block write command */</span>
	<span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">C2PORT_BLOCK_WRITE</span><span class="p">);</span>

	<span class="cm">/* Wait for input acknowledge */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_in_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Should check status before starting FLASH access sequence */</span>

	<span class="cm">/* Wait for status information */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_out_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Read flash programming interface status */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_read_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">C2PORT_COMMAND_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Send address high byte */</span>
	<span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_in_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Send address low byte */</span>
	<span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">offset</span> <span class="o">&amp;</span> <span class="mh">0x00ff</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_in_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Send address block size */</span>
	<span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">nwrite</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_in_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Should check status before writing FLASH block */</span>

	<span class="cm">/* Wait for status information */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_out_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Read flash programming interface status */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_read_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">C2PORT_COMMAND_OK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Write flash block */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nwrite</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_write_dr</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">*</span><span class="p">(</span><span class="n">buffer</span><span class="o">+</span><span class="n">i</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_in_busy</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="cm">/* Wait for last flash write to complete */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">c2port_poll_out_ready</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nwrite</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">c2port_write_flash_data</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="kt">char</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">offset</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span> <span class="o">=</span>
			<span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span>
						<span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">));</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Check the device access status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">access</span> <span class="o">||</span> <span class="o">!</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">flash_access</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">__c2port_write_flash_data</span><span class="p">(</span><span class="n">c2dev</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cannot write %s flash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Class attributes</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">c2port_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">c2port_show_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">flash_blocks_num</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">c2port_show_flash_blocks_num</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">flash_block_size</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">c2port_show_flash_block_size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">flash_size</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">c2port_show_flash_size</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">access</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">c2port_show_access</span><span class="p">,</span> <span class="n">c2port_store_access</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">reset</span><span class="p">,</span> <span class="mo">0200</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">c2port_store_reset</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">dev_id</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">c2port_show_dev_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">rev_id</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">c2port_show_rev_id</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>

	<span class="n">__ATTR</span><span class="p">(</span><span class="n">flash_access</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">c2port_show_flash_access</span><span class="p">,</span>
					<span class="n">c2port_store_flash_access</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">flash_erase</span><span class="p">,</span> <span class="mo">0200</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">c2port_store_flash_erase</span><span class="p">),</span>
	<span class="n">__ATTR_NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">c2port_bin_attrs</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;flash_data&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span>	<span class="o">=</span> <span class="mo">0644</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">read</span>	<span class="o">=</span> <span class="n">c2port_read_flash_data</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>	<span class="o">=</span> <span class="n">c2port_write_flash_data</span><span class="p">,</span>
	<span class="cm">/* .size is computed at run-time */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Exported functions</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="nf">c2port_device_register</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">c2port_ops</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">devdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="p">)</span> <span class="o">||</span> <span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">)</span> <span class="o">||</span> \
		<span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_dir</span><span class="p">)</span> <span class="o">||</span> <span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2ck_set</span><span class="p">)</span> <span class="o">||</span> \
		<span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_get</span><span class="p">)</span> <span class="o">||</span> <span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">c2d_set</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">EINVAL</span><span class="p">);</span>

	<span class="n">c2dev</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">kmemcheck_annotate_bitfield</span><span class="p">(</span><span class="n">c2dev</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="o">!</span><span class="n">c2dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="o">-</span><span class="n">ENOMEM</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">idr_pre_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2port_idr</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">error_idr_get_new</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2port_idr_lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">idr_get_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2port_idr</span><span class="p">,</span> <span class="n">c2dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2port_idr_lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error_idr_get_new</span><span class="p">;</span>
	<span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">id</span><span class="p">;</span>

	<span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">=</span> <span class="n">device_create</span><span class="p">(</span><span class="n">c2port_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">c2dev</span><span class="p">,</span>
					<span class="s">&quot;c2port%d&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_device_create</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">c2dev</span><span class="p">);</span>

	<span class="n">strncpy</span><span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">C2PORT_NAME_LEN</span><span class="p">);</span>
	<span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/* Create binary file */</span>
	<span class="n">c2port_bin_attrs</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">blocks_num</span> <span class="o">*</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_bin_file</span><span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c2port_bin_attrs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ret</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">error_device_create_bin_file</span><span class="p">;</span>

	<span class="cm">/* By default C2 port access is off */</span>
	<span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">access</span> <span class="o">=</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">flash_access</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ops</span><span class="o">-&gt;</span><span class="n">access</span><span class="p">(</span><span class="n">c2dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;C2 port %s added</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
	<span class="n">dev_info</span><span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s flash has %d blocks x %d bytes &quot;</span>
				<span class="s">&quot;(%d bytes total)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">name</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">blocks_num</span><span class="p">,</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">,</span>
				<span class="n">ops</span><span class="o">-&gt;</span><span class="n">blocks_num</span> <span class="o">*</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">block_size</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">c2dev</span><span class="p">;</span>

<span class="nl">error_device_create_bin_file:</span>
	<span class="n">device_destroy</span><span class="p">(</span><span class="n">c2port_class</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

<span class="nl">error_device_create:</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2port_idr_lock</span><span class="p">);</span>
	<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2port_idr</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2port_idr_lock</span><span class="p">);</span>

<span class="nl">error_idr_get_new:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c2dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ERR_PTR</span><span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">c2port_device_register</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">c2port_device_unregister</span><span class="p">(</span><span class="k">struct</span> <span class="n">c2port_device</span> <span class="o">*</span><span class="n">c2dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c2dev</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;C2 port %s removed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">device_remove_bin_file</span><span class="p">(</span><span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">c2port_bin_attrs</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2port_idr_lock</span><span class="p">);</span>
	<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2port_idr</span><span class="p">,</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c2port_idr_lock</span><span class="p">);</span>

	<span class="n">device_destroy</span><span class="p">(</span><span class="n">c2port_class</span><span class="p">,</span> <span class="n">c2dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">c2dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">c2port_device_unregister</span><span class="p">);</span>

<span class="cm">/*</span>
<span class="cm"> * Module stuff</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">c2port_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Silicon Labs C2 port support v. &quot;</span> <span class="n">DRIVER_VERSION</span>
		<span class="s">&quot; - (C) 2007 Rodolfo Giometti</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">c2port_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;c2port&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">c2port_class</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;c2port: failed to allocate class</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">c2port_class</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">c2port_class</span><span class="o">-&gt;</span><span class="n">dev_attrs</span> <span class="o">=</span> <span class="n">c2port_attrs</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">c2port_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">class_destroy</span><span class="p">(</span><span class="n">c2port_class</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">c2port_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">c2port_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Rodolfo Giometti &lt;giometti@linux.it&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Silicon Labs C2 port support v. &quot;</span> <span class="n">DRIVER_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
