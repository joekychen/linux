<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › misc › kgdbts.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>kgdbts.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * kgdbts is a test suite for kgdb for the sole purpose of validating</span>
<span class="cm"> * that key pieces of the kgdb internals are working properly such as</span>
<span class="cm"> * HW/SW breakpoints, single stepping, and NMI.</span>
<span class="cm"> *</span>
<span class="cm"> * Created by: Jason Wessel &lt;jason.wessel@windriver.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2008 Wind River Systems, Inc.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.</span>
<span class="cm"> * See the GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA</span>
<span class="cm"> */</span>
<span class="cm">/* Information about the kgdb test suite.</span>
<span class="cm"> * -------------------------------------</span>
<span class="cm"> *</span>
<span class="cm"> * The kgdb test suite is designed as a KGDB I/O module which</span>
<span class="cm"> * simulates the communications that a debugger would have with kgdb.</span>
<span class="cm"> * The tests are broken up in to a line by line and referenced here as</span>
<span class="cm"> * a &quot;get&quot; which is kgdb requesting input and &quot;put&quot; which is kgdb</span>
<span class="cm"> * sending a response.</span>
<span class="cm"> *</span>
<span class="cm"> * The kgdb suite can be invoked from the kernel command line</span>
<span class="cm"> * arguments system or executed dynamically at run time.  The test</span>
<span class="cm"> * suite uses the variable &quot;kgdbts&quot; to obtain the information about</span>
<span class="cm"> * which tests to run and to configure the verbosity level.  The</span>
<span class="cm"> * following are the various characters you can use with the kgdbts=</span>
<span class="cm"> * line:</span>
<span class="cm"> *</span>
<span class="cm"> * When using the &quot;kgdbts=&quot; you only choose one of the following core</span>
<span class="cm"> * test types:</span>
<span class="cm"> * A = Run all the core tests silently</span>
<span class="cm"> * V1 = Run all the core tests with minimal output</span>
<span class="cm"> * V2 = Run all the core tests in debug mode</span>
<span class="cm"> *</span>
<span class="cm"> * You can also specify optional tests:</span>
<span class="cm"> * N## = Go to sleep with interrupts of for ## seconds</span>
<span class="cm"> *       to test the HW NMI watchdog</span>
<span class="cm"> * F## = Break at do_fork for ## iterations</span>
<span class="cm"> * S## = Break at sys_open for ## iterations</span>
<span class="cm"> * I## = Run the single step test ## iterations</span>
<span class="cm"> *</span>
<span class="cm"> * NOTE: that the do_fork and sys_open tests are mutually exclusive.</span>
<span class="cm"> *</span>
<span class="cm"> * To invoke the kgdb test suite from boot you use a kernel start</span>
<span class="cm"> * argument as follows:</span>
<span class="cm"> * 	kgdbts=V1 kgdbwait</span>
<span class="cm"> * Or if you wanted to perform the NMI test for 6 seconds and do_fork</span>
<span class="cm"> * test for 100 forks, you could use:</span>
<span class="cm"> * 	kgdbts=V1N6F100 kgdbwait</span>
<span class="cm"> *</span>
<span class="cm"> * The test suite can also be invoked at run time with:</span>
<span class="cm"> *	echo kgdbts=V1N6F100 &gt; /sys/module/kgdbts/parameters/kgdbts</span>
<span class="cm"> * Or as another example:</span>
<span class="cm"> *	echo kgdbts=V2 &gt; /sys/module/kgdbts/parameters/kgdbts</span>
<span class="cm"> *</span>
<span class="cm"> * When developing a new kgdb arch specific implementation or</span>
<span class="cm"> * using these tests for the purpose of regression testing,</span>
<span class="cm"> * several invocations are required.</span>
<span class="cm"> *</span>
<span class="cm"> * 1) Boot with the test suite enabled by using the kernel arguments</span>
<span class="cm"> *       &quot;kgdbts=V1F100 kgdbwait&quot;</span>
<span class="cm"> *    ## If kgdb arch specific implementation has NMI use</span>
<span class="cm"> *       &quot;kgdbts=V1N6F100</span>
<span class="cm"> *</span>
<span class="cm"> * 2) After the system boot run the basic test.</span>
<span class="cm"> * echo kgdbts=V1 &gt; /sys/module/kgdbts/parameters/kgdbts</span>
<span class="cm"> *</span>
<span class="cm"> * 3) Run the concurrency tests.  It is best to use n+1</span>
<span class="cm"> *    while loops where n is the number of cpus you have</span>
<span class="cm"> *    in your system.  The example below uses only two</span>
<span class="cm"> *    loops.</span>
<span class="cm"> *</span>
<span class="cm"> * ## This tests break points on sys_open</span>
<span class="cm"> * while [ 1 ] ; do find / &gt; /dev/null 2&gt;&amp;1 ; done &amp;</span>
<span class="cm"> * while [ 1 ] ; do find / &gt; /dev/null 2&gt;&amp;1 ; done &amp;</span>
<span class="cm"> * echo kgdbts=V1S10000 &gt; /sys/module/kgdbts/parameters/kgdbts</span>
<span class="cm"> * fg # and hit control-c</span>
<span class="cm"> * fg # and hit control-c</span>
<span class="cm"> * ## This tests break points on do_fork</span>
<span class="cm"> * while [ 1 ] ; do date &gt; /dev/null ; done &amp;</span>
<span class="cm"> * while [ 1 ] ; do date &gt; /dev/null ; done &amp;</span>
<span class="cm"> * echo kgdbts=V1F1000 &gt; /sys/module/kgdbts/parameters/kgdbts</span>
<span class="cm"> * fg # and hit control-c</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/kgdb.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/syscalls.h&gt;</span>
<span class="cp">#include &lt;linux/nmi.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>

<span class="cp">#define v1printk(a...) do { \</span>
<span class="cp">	if (verbose) \</span>
<span class="cp">		printk(KERN_INFO a); \</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define v2printk(a...) do { \</span>
<span class="cp">	if (verbose &gt; 1) \</span>
<span class="cp">		printk(KERN_INFO a); \</span>
<span class="cp">		touch_nmi_watchdog();	\</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define eprintk(a...) do { \</span>
<span class="cp">		printk(KERN_ERR a); \</span>
<span class="cp">		WARN_ON(1); \</span>
<span class="cp">	} while (0)</span>
<span class="cp">#define MAX_CONFIG_LEN		40</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kgdb_io</span> <span class="n">kgdbts_io_ops</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">get_buf</span><span class="p">[</span><span class="n">BUFMAX</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">get_buf_cnt</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">put_buf</span><span class="p">[</span><span class="n">BUFMAX</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">put_buf_cnt</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">scratch_buf</span><span class="p">[</span><span class="n">BUFMAX</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">verbose</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">repeat_test</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">test_complete</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">send_ack</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">final_ack</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">force_hwbrks</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hwbreaks_ok</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hw_break_val</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">hw_break_val2</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cont_instead_of_sstep</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cont_thread_id</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sstep_thread_id</span><span class="p">;</span>
<span class="cp">#if defined(CONFIG_ARM) || defined(CONFIG_MIPS) || defined(CONFIG_SPARC)</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arch_needs_sstep_emulation</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">arch_needs_sstep_emulation</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">cont_addr</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">sstep_addr</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">restart_from_top_after_write</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sstep_state</span><span class="p">;</span>

<span class="cm">/* Storage for the registers, in GDB format. */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">kgdbts_gdb_regs</span><span class="p">[(</span><span class="n">NUMREGBYTES</span> <span class="o">+</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span>
					<span class="k">sizeof</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)];</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pt_regs</span> <span class="n">kgdbts_regs</span><span class="p">;</span>

<span class="cm">/* -1 = init not run yet, 0 = unconfigured, 1 = configured. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">configured</span>		<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_KGDB_TESTS_BOOT_STRING</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">config</span><span class="p">[</span><span class="n">MAX_CONFIG_LEN</span><span class="p">]</span> <span class="o">=</span> <span class="n">CONFIG_KGDB_TESTS_BOOT_STRING</span><span class="p">;</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kt">char</span> <span class="n">config</span><span class="p">[</span><span class="n">MAX_CONFIG_LEN</span><span class="p">];</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kparam_string</span> <span class="n">kps</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">string</span>			<span class="o">=</span> <span class="n">config</span><span class="p">,</span>
	<span class="p">.</span><span class="n">maxlen</span>			<span class="o">=</span> <span class="n">MAX_CONFIG_LEN</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">fill_get_buf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">test_struct</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">get</span><span class="p">;</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">put</span><span class="p">;</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">get_handler</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">put_handler</span><span class="p">)(</span><span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">test_state</span> <span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">test_struct</span> <span class="o">*</span><span class="n">tst</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">idx</span><span class="p">;</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">run_test</span><span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">validate_put</span><span class="p">)</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">);</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">test_state</span> <span class="n">ts</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kgdbts_unreg_thread</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Wait until the tests are complete and then ungresiter the I/O</span>
<span class="cm">	 * driver.</span>
<span class="cm">	 */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">final_ack</span><span class="p">)</span>
		<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">1500</span><span class="p">);</span>
	<span class="cm">/* Pause for any other threads to exit after final ack. */</span>
	<span class="n">msleep_interruptible</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">configured</span><span class="p">)</span>
		<span class="n">kgdb_unregister_io_module</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kgdbts_io_ops</span><span class="p">);</span>
	<span class="n">configured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* This is noinline such that it can be used for a single location to</span>
<span class="cm"> * place a breakpoint</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">noinline</span> <span class="kt">void</span> <span class="nf">kgdbts_break_test</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">v2printk</span><span class="p">(</span><span class="s">&quot;kgdbts: breakpoint complete</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Lookup symbol info in the kernel */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">lookup_addr</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;kgdbts_break_test&quot;</span><span class="p">))</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">kgdbts_break_test</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;sys_open&quot;</span><span class="p">))</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">do_sys_open</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;do_fork&quot;</span><span class="p">))</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">do_fork</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;hw_break_val&quot;</span><span class="p">))</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hw_break_val</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">addr</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">break_helper</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">bp_type</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arg</span><span class="p">)</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">lookup_addr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">addr</span> <span class="o">=</span> <span class="n">vaddr</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">scratch_buf</span><span class="p">,</span> <span class="s">&quot;%s,%lx,%i&quot;</span><span class="p">,</span> <span class="n">bp_type</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span>
		<span class="n">BREAK_INSTR_SIZE</span><span class="p">);</span>
	<span class="n">fill_get_buf</span><span class="p">(</span><span class="n">scratch_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sw_break</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">break_helper</span><span class="p">(</span><span class="n">force_hwbrks</span> <span class="o">?</span> <span class="s">&quot;Z1&quot;</span> <span class="o">:</span> <span class="s">&quot;Z0&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">sw_rem_break</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">break_helper</span><span class="p">(</span><span class="n">force_hwbrks</span> <span class="o">?</span> <span class="s">&quot;z1&quot;</span> <span class="o">:</span> <span class="s">&quot;z0&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_break</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">break_helper</span><span class="p">(</span><span class="s">&quot;Z1&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_rem_break</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">break_helper</span><span class="p">(</span><span class="s">&quot;z1&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_write_break</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">break_helper</span><span class="p">(</span><span class="s">&quot;Z2&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_rem_write_break</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">break_helper</span><span class="p">(</span><span class="s">&quot;z2&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_access_break</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">break_helper</span><span class="p">(</span><span class="s">&quot;Z4&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_rem_access_break</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">break_helper</span><span class="p">(</span><span class="s">&quot;z4&quot;</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_break_val_access</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw_break_val2</span> <span class="o">=</span> <span class="n">hw_break_val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hw_break_val_write</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">hw_break_val</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">get_thread_id_continue</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">put_str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">put_str</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;T&#39;</span> <span class="o">||</span> <span class="n">put_str</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">kgdb_hex2long</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cont_thread_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_and_rewind_pc</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">put_str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">lookup_addr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">kgdb_hex2mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">put_str</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">kgdbts_gdb_regs</span><span class="p">,</span>
		 <span class="n">NUMREGBYTES</span><span class="p">);</span>
	<span class="n">gdb_regs_to_pt_regs</span><span class="p">(</span><span class="n">kgdbts_gdb_regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kgdbts_regs</span><span class="p">);</span>
	<span class="n">ip</span> <span class="o">=</span> <span class="n">instruction_pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kgdbts_regs</span><span class="p">);</span>
	<span class="n">v2printk</span><span class="p">(</span><span class="s">&quot;Stopped at IP: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
<span class="cp">#ifdef GDB_ADJUSTS_BREAK_OFFSET</span>
	<span class="cm">/* On some arches, a breakpoint stop requires it to be decremented */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">addr</span> <span class="o">+</span> <span class="n">BREAK_INSTR_SIZE</span> <span class="o">==</span> <span class="n">ip</span><span class="p">)</span>
		<span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="n">BREAK_INSTR_SIZE</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">arch_needs_sstep_emulation</span> <span class="o">&amp;&amp;</span> <span class="n">sstep_addr</span> <span class="o">&amp;&amp;</span>
	    <span class="n">ip</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">==</span> <span class="n">sstep_addr</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;sys_open&quot;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;do_fork&quot;</span><span class="p">))))</span> <span class="p">{</span>
		<span class="cm">/* This is special case for emulated single step */</span>
		<span class="n">v2printk</span><span class="p">(</span><span class="s">&quot;Emul: rewind hit single step bp</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">restart_from_top_after_write</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;silent&quot;</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">ip</span> <span class="o">+</span> <span class="n">offset</span> <span class="o">!=</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: BP mismatch %lx expected %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ip</span> <span class="o">+</span> <span class="n">offset</span><span class="p">,</span> <span class="n">addr</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Readjust the instruction pointer if needed */</span>
	<span class="n">ip</span> <span class="o">+=</span> <span class="n">offset</span><span class="p">;</span>
	<span class="n">cont_addr</span> <span class="o">=</span> <span class="n">ip</span><span class="p">;</span>
<span class="cp">#ifdef GDB_ADJUSTS_BREAK_OFFSET</span>
	<span class="n">instruction_pointer_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kgdbts_regs</span><span class="p">,</span> <span class="n">ip</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">check_single_step</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">put_str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">lookup_addr</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">matched_id</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * From an arch indepent point of view the instruction pointer</span>
<span class="cm">	 * should be on a different instruction</span>
<span class="cm">	 */</span>
	<span class="n">kgdb_hex2mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">put_str</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">kgdbts_gdb_regs</span><span class="p">,</span>
		 <span class="n">NUMREGBYTES</span><span class="p">);</span>
	<span class="n">gdb_regs_to_pt_regs</span><span class="p">(</span><span class="n">kgdbts_gdb_regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kgdbts_regs</span><span class="p">);</span>
	<span class="n">v2printk</span><span class="p">(</span><span class="s">&quot;Singlestep stopped at IP: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">instruction_pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kgdbts_regs</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sstep_thread_id</span> <span class="o">!=</span> <span class="n">cont_thread_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Ensure we stopped in the same thread id as before, else the</span>
<span class="cm">		 * debugger should continue until the original thread that was</span>
<span class="cm">		 * single stepped is scheduled again, emulating gdb&#39;s behavior.</span>
<span class="cm">		 */</span>
		<span class="n">v2printk</span><span class="p">(</span><span class="s">&quot;ThrID does not match: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cont_thread_id</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">arch_needs_sstep_emulation</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">matched_id</span> <span class="o">&amp;&amp;</span>
			    <span class="n">instruction_pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kgdbts_regs</span><span class="p">)</span> <span class="o">!=</span> <span class="n">addr</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">continue_test</span><span class="p">;</span>
			<span class="n">matched_id</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ts</span><span class="p">.</span><span class="n">idx</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">sstep_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">cont_instead_of_sstep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">idx</span> <span class="o">-=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">continue_test:</span>
	<span class="n">matched_id</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">instruction_pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kgdbts_regs</span><span class="p">)</span> <span class="o">==</span> <span class="n">addr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: SingleStep failed at %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">instruction_pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kgdbts_regs</span><span class="p">));</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">write_regs</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">scratch_buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">scratch_buf</span><span class="p">));</span>
	<span class="n">scratch_buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;G&#39;</span><span class="p">;</span>
	<span class="n">pt_regs_to_gdb_regs</span><span class="p">(</span><span class="n">kgdbts_gdb_regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kgdbts_regs</span><span class="p">);</span>
	<span class="n">kgdb_mem2hex</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">kgdbts_gdb_regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">scratch_buf</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">NUMREGBYTES</span><span class="p">);</span>
	<span class="n">fill_get_buf</span><span class="p">(</span><span class="n">scratch_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">skip_back_repeat_test</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">go_back</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="n">repeat_test</span><span class="o">--</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">repeat_test</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">idx</span> <span class="o">-=</span> <span class="n">go_back</span><span class="p">;</span>
	<span class="n">fill_get_buf</span><span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">tst</span><span class="p">[</span><span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">get</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">got_break</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">put_str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">test_complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">put_str</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s">&quot;T0&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
			<span class="n">test_complete</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_cont_catch</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Always send detach because the test is completed at this point */</span>
	<span class="n">fill_get_buf</span><span class="p">(</span><span class="s">&quot;D&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">put_cont_catch</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">put_str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* This is at the end of the test and we catch any and all input */</span>
	<span class="n">v2printk</span><span class="p">(</span><span class="s">&quot;kgdbts: cleanup task: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sstep_thread_id</span><span class="p">);</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="o">--</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emul_reset</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">put_str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">put_str</span><span class="p">,</span> <span class="s">&quot;$OK&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">restart_from_top_after_write</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">restart_from_top_after_write</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">idx</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">emul_sstep_get</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arch_needs_sstep_emulation</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cont_instead_of_sstep</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">cont_instead_of_sstep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fill_get_buf</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">fill_get_buf</span><span class="p">(</span><span class="n">arg</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sstep_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="n">v2printk</span><span class="p">(</span><span class="s">&quot;Emulate single step</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="cm">/* Start by looking at the current PC */</span>
		<span class="n">fill_get_buf</span><span class="p">(</span><span class="s">&quot;g&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* set breakpoint */</span>
		<span class="n">break_helper</span><span class="p">(</span><span class="s">&quot;Z0&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sstep_addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="cm">/* Continue */</span>
		<span class="n">fill_get_buf</span><span class="p">(</span><span class="s">&quot;c&quot;</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="cm">/* Clear breakpoint */</span>
		<span class="n">break_helper</span><span class="p">(</span><span class="s">&quot;z0&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">sstep_addr</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: ERROR failed sstep get emulation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">sstep_state</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">emul_sstep_put</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">put_str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arch_needs_sstep_emulation</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">put_str</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_str</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;T&#39;</span> <span class="o">||</span> <span class="n">put_str</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="sc">&#39;0&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">kgdb_hex2long</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sstep_thread_id</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sstep_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">1</span>:
		<span class="cm">/* validate the &quot;g&quot; packet to get the IP */</span>
		<span class="n">kgdb_hex2mem</span><span class="p">(</span><span class="o">&amp;</span><span class="n">put_str</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">kgdbts_gdb_regs</span><span class="p">,</span>
			 <span class="n">NUMREGBYTES</span><span class="p">);</span>
		<span class="n">gdb_regs_to_pt_regs</span><span class="p">(</span><span class="n">kgdbts_gdb_regs</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kgdbts_regs</span><span class="p">);</span>
		<span class="n">v2printk</span><span class="p">(</span><span class="s">&quot;Stopped at IP: %lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">instruction_pointer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kgdbts_regs</span><span class="p">));</span>
		<span class="cm">/* Want to stop at IP + break instruction size by default */</span>
		<span class="n">sstep_addr</span> <span class="o">=</span> <span class="n">cont_addr</span> <span class="o">+</span> <span class="n">BREAK_INSTR_SIZE</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">put_str</span><span class="p">,</span> <span class="s">&quot;$OK&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: failed sstep break set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">put_str</span><span class="p">,</span> <span class="s">&quot;$T0&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: failed continue sstep</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">put_str</span><span class="p">[</span><span class="mi">11</span><span class="p">];</span>
			<span class="n">kgdb_hex2long</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">sstep_thread_id</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">4</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">put_str</span><span class="p">,</span> <span class="s">&quot;$OK&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: failed sstep break unset</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Single step is complete so continue on! */</span>
		<span class="n">sstep_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: ERROR failed sstep put emulation</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Continue on the same test line until emulation is complete */</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="o">--</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">final_ack_set</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">put_str</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strncmp</span><span class="p">(</span><span class="n">put_str</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">final_ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * Test to plant a breakpoint and detach, which should clear out the</span>
<span class="cm"> * breakpoint and restore the original instruction.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">test_struct</span> <span class="n">plant_and_detach_test</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;?&quot;</span><span class="p">,</span> <span class="s">&quot;S0*&quot;</span> <span class="p">},</span> <span class="cm">/* Clear break points */</span>
	<span class="p">{</span> <span class="s">&quot;kgdbts_break_test&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">sw_break</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* set sw breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span> <span class="p">},</span> <span class="cm">/* Detach */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Simple test to write in a software breakpoint, check for the</span>
<span class="cm"> * correct stop location and detach.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">test_struct</span> <span class="n">sw_breakpoint_test</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;?&quot;</span><span class="p">,</span> <span class="s">&quot;S0*&quot;</span> <span class="p">},</span> <span class="cm">/* Clear break points */</span>
	<span class="p">{</span> <span class="s">&quot;kgdbts_break_test&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">sw_break</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* set sw breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="s">&quot;T0*&quot;</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* Continue */</span>
	<span class="p">{</span> <span class="s">&quot;g&quot;</span><span class="p">,</span> <span class="s">&quot;kgdbts_break_test&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">check_and_rewind_pc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">write_regs</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;kgdbts_break_test&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">sw_rem_break</span> <span class="p">},</span> <span class="cm">/*remove breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span> <span class="p">},</span> <span class="cm">/* Detach */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>  <span class="n">got_break</span> <span class="p">},</span> <span class="cm">/* On success we made it here */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Test a known bad memory read location to test the fault handler and</span>
<span class="cm"> * read bytes 1-8 at the bad address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">test_struct</span> <span class="n">bad_read_test</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;?&quot;</span><span class="p">,</span> <span class="s">&quot;S0*&quot;</span> <span class="p">},</span> <span class="cm">/* Clear break points */</span>
	<span class="p">{</span> <span class="s">&quot;m0,1&quot;</span><span class="p">,</span> <span class="s">&quot;E*&quot;</span> <span class="p">},</span> <span class="cm">/* read 1 byte at address 1 */</span>
	<span class="p">{</span> <span class="s">&quot;m0,2&quot;</span><span class="p">,</span> <span class="s">&quot;E*&quot;</span> <span class="p">},</span> <span class="cm">/* read 1 byte at address 2 */</span>
	<span class="p">{</span> <span class="s">&quot;m0,3&quot;</span><span class="p">,</span> <span class="s">&quot;E*&quot;</span> <span class="p">},</span> <span class="cm">/* read 1 byte at address 3 */</span>
	<span class="p">{</span> <span class="s">&quot;m0,4&quot;</span><span class="p">,</span> <span class="s">&quot;E*&quot;</span> <span class="p">},</span> <span class="cm">/* read 1 byte at address 4 */</span>
	<span class="p">{</span> <span class="s">&quot;m0,5&quot;</span><span class="p">,</span> <span class="s">&quot;E*&quot;</span> <span class="p">},</span> <span class="cm">/* read 1 byte at address 5 */</span>
	<span class="p">{</span> <span class="s">&quot;m0,6&quot;</span><span class="p">,</span> <span class="s">&quot;E*&quot;</span> <span class="p">},</span> <span class="cm">/* read 1 byte at address 6 */</span>
	<span class="p">{</span> <span class="s">&quot;m0,7&quot;</span><span class="p">,</span> <span class="s">&quot;E*&quot;</span> <span class="p">},</span> <span class="cm">/* read 1 byte at address 7 */</span>
	<span class="p">{</span> <span class="s">&quot;m0,8&quot;</span><span class="p">,</span> <span class="s">&quot;E*&quot;</span> <span class="p">},</span> <span class="cm">/* read 1 byte at address 8 */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span> <span class="p">},</span> <span class="cm">/* Detach which removes all breakpoints and continues */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Test for hitting a breakpoint, remove it, single step, plant it</span>
<span class="cm"> * again and detach.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">test_struct</span> <span class="n">singlestep_break_test</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;?&quot;</span><span class="p">,</span> <span class="s">&quot;S0*&quot;</span> <span class="p">},</span> <span class="cm">/* Clear break points */</span>
	<span class="p">{</span> <span class="s">&quot;kgdbts_break_test&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">sw_break</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* set sw breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="s">&quot;T0*&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">get_thread_id_continue</span> <span class="p">},</span> <span class="cm">/* Continue */</span>
	<span class="p">{</span> <span class="s">&quot;kgdbts_break_test&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">sw_rem_break</span> <span class="p">},</span> <span class="cm">/*remove breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;g&quot;</span><span class="p">,</span> <span class="s">&quot;kgdbts_break_test&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">check_and_rewind_pc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">write_regs</span> <span class="p">},</span> <span class="cm">/* Write registers */</span>
	<span class="p">{</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;T0*&quot;</span><span class="p">,</span> <span class="n">emul_sstep_get</span><span class="p">,</span> <span class="n">emul_sstep_put</span> <span class="p">},</span> <span class="cm">/* Single step */</span>
	<span class="p">{</span> <span class="s">&quot;g&quot;</span><span class="p">,</span> <span class="s">&quot;kgdbts_break_test&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">check_single_step</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;kgdbts_break_test&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">sw_break</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* set sw breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="s">&quot;T0*&quot;</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* Continue */</span>
	<span class="p">{</span> <span class="s">&quot;g&quot;</span><span class="p">,</span> <span class="s">&quot;kgdbts_break_test&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">check_and_rewind_pc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">write_regs</span> <span class="p">},</span> <span class="cm">/* Write registers */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span> <span class="p">},</span> <span class="cm">/* Remove all breakpoints and continues */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Test for hitting a breakpoint at do_fork for what ever the number</span>
<span class="cm"> * of iterations required by the variable repeat_test.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">test_struct</span> <span class="n">do_fork_test</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;?&quot;</span><span class="p">,</span> <span class="s">&quot;S0*&quot;</span> <span class="p">},</span> <span class="cm">/* Clear break points */</span>
	<span class="p">{</span> <span class="s">&quot;do_fork&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">sw_break</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* set sw breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="s">&quot;T0*&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">get_thread_id_continue</span> <span class="p">},</span> <span class="cm">/* Continue */</span>
	<span class="p">{</span> <span class="s">&quot;do_fork&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">sw_rem_break</span> <span class="p">},</span> <span class="cm">/*remove breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;g&quot;</span><span class="p">,</span> <span class="s">&quot;do_fork&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">check_and_rewind_pc</span> <span class="p">},</span> <span class="cm">/* check location */</span>
	<span class="p">{</span> <span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">write_regs</span><span class="p">,</span> <span class="n">emul_reset</span> <span class="p">},</span> <span class="cm">/* Write registers */</span>
	<span class="p">{</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;T0*&quot;</span><span class="p">,</span> <span class="n">emul_sstep_get</span><span class="p">,</span> <span class="n">emul_sstep_put</span> <span class="p">},</span> <span class="cm">/* Single step */</span>
	<span class="p">{</span> <span class="s">&quot;g&quot;</span><span class="p">,</span> <span class="s">&quot;do_fork&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">check_single_step</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;do_fork&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">sw_break</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* set sw breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;7&quot;</span><span class="p">,</span> <span class="s">&quot;T0*&quot;</span><span class="p">,</span> <span class="n">skip_back_repeat_test</span> <span class="p">},</span> <span class="cm">/* Loop based on repeat_test */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">final_ack_set</span> <span class="p">},</span> <span class="cm">/* detach and unregister I/O */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">get_cont_catch</span><span class="p">,</span> <span class="n">put_cont_catch</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* Test for hitting a breakpoint at sys_open for what ever the number</span>
<span class="cm"> * of iterations required by the variable repeat_test.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">test_struct</span> <span class="n">sys_open_test</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;?&quot;</span><span class="p">,</span> <span class="s">&quot;S0*&quot;</span> <span class="p">},</span> <span class="cm">/* Clear break points */</span>
	<span class="p">{</span> <span class="s">&quot;sys_open&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">sw_break</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* set sw breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="s">&quot;T0*&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">get_thread_id_continue</span> <span class="p">},</span> <span class="cm">/* Continue */</span>
	<span class="p">{</span> <span class="s">&quot;sys_open&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">sw_rem_break</span> <span class="p">},</span> <span class="cm">/*remove breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;g&quot;</span><span class="p">,</span> <span class="s">&quot;sys_open&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">check_and_rewind_pc</span> <span class="p">},</span> <span class="cm">/* check location */</span>
	<span class="p">{</span> <span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">write_regs</span><span class="p">,</span> <span class="n">emul_reset</span> <span class="p">},</span> <span class="cm">/* Write registers */</span>
	<span class="p">{</span> <span class="s">&quot;s&quot;</span><span class="p">,</span> <span class="s">&quot;T0*&quot;</span><span class="p">,</span> <span class="n">emul_sstep_get</span><span class="p">,</span> <span class="n">emul_sstep_put</span> <span class="p">},</span> <span class="cm">/* Single step */</span>
	<span class="p">{</span> <span class="s">&quot;g&quot;</span><span class="p">,</span> <span class="s">&quot;sys_open&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">check_single_step</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;sys_open&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">sw_break</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* set sw breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;7&quot;</span><span class="p">,</span> <span class="s">&quot;T0*&quot;</span><span class="p">,</span> <span class="n">skip_back_repeat_test</span> <span class="p">},</span> <span class="cm">/* Loop based on repeat_test */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">final_ack_set</span> <span class="p">},</span> <span class="cm">/* detach and unregister I/O */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">get_cont_catch</span><span class="p">,</span> <span class="n">put_cont_catch</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Test for hitting a simple hw breakpoint</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">test_struct</span> <span class="n">hw_breakpoint_test</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;?&quot;</span><span class="p">,</span> <span class="s">&quot;S0*&quot;</span> <span class="p">},</span> <span class="cm">/* Clear break points */</span>
	<span class="p">{</span> <span class="s">&quot;kgdbts_break_test&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">hw_break</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* set hw breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="s">&quot;T0*&quot;</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* Continue */</span>
	<span class="p">{</span> <span class="s">&quot;g&quot;</span><span class="p">,</span> <span class="s">&quot;kgdbts_break_test&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">check_and_rewind_pc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">write_regs</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;kgdbts_break_test&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">hw_rem_break</span> <span class="p">},</span> <span class="cm">/*remove breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span> <span class="p">},</span> <span class="cm">/* Detach */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>  <span class="n">got_break</span> <span class="p">},</span> <span class="cm">/* On success we made it here */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Test for hitting a hw write breakpoint</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">test_struct</span> <span class="n">hw_write_break_test</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;?&quot;</span><span class="p">,</span> <span class="s">&quot;S0*&quot;</span> <span class="p">},</span> <span class="cm">/* Clear break points */</span>
	<span class="p">{</span> <span class="s">&quot;hw_break_val&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">hw_write_break</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* set hw breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="s">&quot;T0*&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">got_break</span> <span class="p">},</span> <span class="cm">/* Continue */</span>
	<span class="p">{</span> <span class="s">&quot;g&quot;</span><span class="p">,</span> <span class="s">&quot;silent&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">check_and_rewind_pc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">write_regs</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;hw_break_val&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">hw_rem_write_break</span> <span class="p">},</span> <span class="cm">/*remove breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span> <span class="p">},</span> <span class="cm">/* Detach */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>  <span class="n">got_break</span> <span class="p">},</span> <span class="cm">/* On success we made it here */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Test for hitting a hw access breakpoint</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">test_struct</span> <span class="n">hw_access_break_test</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;?&quot;</span><span class="p">,</span> <span class="s">&quot;S0*&quot;</span> <span class="p">},</span> <span class="cm">/* Clear break points */</span>
	<span class="p">{</span> <span class="s">&quot;hw_break_val&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">hw_access_break</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* set hw breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="s">&quot;T0*&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">got_break</span> <span class="p">},</span> <span class="cm">/* Continue */</span>
	<span class="p">{</span> <span class="s">&quot;g&quot;</span><span class="p">,</span> <span class="s">&quot;silent&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">check_and_rewind_pc</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;write&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">write_regs</span> <span class="p">},</span>
	<span class="p">{</span> <span class="s">&quot;hw_break_val&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="n">hw_rem_access_break</span> <span class="p">},</span> <span class="cm">/*remove breakpoint */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span> <span class="p">},</span> <span class="cm">/* Detach */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>  <span class="n">got_break</span> <span class="p">},</span> <span class="cm">/* On success we made it here */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Test for hitting a hw access breakpoint</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">test_struct</span> <span class="n">nmi_sleep_test</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="s">&quot;?&quot;</span><span class="p">,</span> <span class="s">&quot;S0*&quot;</span> <span class="p">},</span> <span class="cm">/* Clear break points */</span>
	<span class="p">{</span> <span class="s">&quot;c&quot;</span><span class="p">,</span> <span class="s">&quot;T0*&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">got_break</span> <span class="p">},</span> <span class="cm">/* Continue */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span> <span class="p">},</span> <span class="cm">/* Detach */</span>
	<span class="p">{</span> <span class="s">&quot;D&quot;</span><span class="p">,</span> <span class="s">&quot;OK&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>  <span class="n">got_break</span> <span class="p">},</span> <span class="cm">/* On success we made it here */</span>
	<span class="p">{</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span> <span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_get_buf</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">ch</span><span class="p">;</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">get_buf</span><span class="p">,</span> <span class="s">&quot;$&quot;</span><span class="p">);</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">get_buf</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">ch</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="n">count</span><span class="p">]))</span> <span class="p">{</span>
		<span class="n">checksum</span> <span class="o">+=</span> <span class="n">ch</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">get_buf</span><span class="p">,</span> <span class="s">&quot;#&quot;</span><span class="p">);</span>
	<span class="n">get_buf</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_hi</span><span class="p">(</span><span class="n">checksum</span><span class="p">);</span>
	<span class="n">get_buf</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">hex_asc_lo</span><span class="p">(</span><span class="n">checksum</span><span class="p">);</span>
	<span class="n">get_buf</span><span class="p">[</span><span class="n">count</span> <span class="o">+</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">v2printk</span><span class="p">(</span><span class="s">&quot;get%i: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">get_buf</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">validate_simple_test</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">put_str</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">chk_str</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">tst</span><span class="p">[</span><span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">put_handler</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ts</span><span class="p">.</span><span class="n">tst</span><span class="p">[</span><span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">put_handler</span><span class="p">(</span><span class="n">put_str</span><span class="p">,</span>
			<span class="n">ts</span><span class="p">.</span><span class="n">tst</span><span class="p">[</span><span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">put</span><span class="p">);</span>

	<span class="n">chk_str</span> <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tst</span><span class="p">[</span><span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">put</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">put_str</span> <span class="o">==</span> <span class="sc">&#39;$&#39;</span><span class="p">)</span>
		<span class="n">put_str</span><span class="o">++</span><span class="p">;</span>

	<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">chk_str</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">put_str</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* If someone does a * to match the rest of the string, allow</span>
<span class="cm">		 * it, or stop if the received string is complete.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">put_str</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">chk_str</span> <span class="o">==</span> <span class="sc">&#39;*&#39;</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">put_str</span> <span class="o">!=</span> <span class="o">*</span><span class="n">chk_str</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

		<span class="n">chk_str</span><span class="o">++</span><span class="p">;</span>
		<span class="n">put_str</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">chk_str</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="o">*</span><span class="n">put_str</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="o">||</span> <span class="o">*</span><span class="n">put_str</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">run_simple_test</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_get_char</span><span class="p">,</span> <span class="kt">int</span> <span class="n">chr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_get_char</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Send an ACK on the get if a prior put completed and set the</span>
<span class="cm">		 * send ack variable</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">send_ack</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">send_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="sc">&#39;+&#39;</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* On the first get char, fill the transmit buffer and then</span>
<span class="cm">		 * take from the get_string.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_buf_cnt</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">tst</span><span class="p">[</span><span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">get_handler</span><span class="p">)</span>
				<span class="n">ts</span><span class="p">.</span><span class="n">tst</span><span class="p">[</span><span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">get_handler</span><span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">tst</span><span class="p">[</span><span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">get</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">fill_get_buf</span><span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">tst</span><span class="p">[</span><span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">get</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">get_buf</span><span class="p">[</span><span class="n">get_buf_cnt</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: ERROR GET: EOB on &#39;%s&#39; at %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ts</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
			<span class="n">get_buf_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">fill_get_buf</span><span class="p">(</span><span class="s">&quot;D&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">get_buf</span><span class="p">[</span><span class="n">get_buf_cnt</span><span class="p">];</span>
		<span class="n">get_buf_cnt</span><span class="o">++</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* This callback is a put char which is when kgdb sends data to</span>
<span class="cm">	 * this I/O module.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">tst</span><span class="p">[</span><span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">get</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span> <span class="n">ts</span><span class="p">.</span><span class="n">tst</span><span class="p">[</span><span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">put</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\0&#39;</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">ts</span><span class="p">.</span><span class="n">tst</span><span class="p">[</span><span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">get_handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: ERROR: beyond end of test on&quot;</span>
			   <span class="s">&quot; &#39;%s&#39; line %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">put_buf_cnt</span> <span class="o">&gt;=</span> <span class="n">BUFMAX</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: ERROR: put buffer overflow on&quot;</span>
			   <span class="s">&quot; &#39;%s&#39; line %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
		<span class="n">put_buf_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Ignore everything until the first valid packet start &#39;$&#39; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_buf_cnt</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">chr</span> <span class="o">!=</span> <span class="sc">&#39;$&#39;</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">put_buf</span><span class="p">[</span><span class="n">put_buf_cnt</span><span class="p">]</span> <span class="o">=</span> <span class="n">chr</span><span class="p">;</span>
	<span class="n">put_buf_cnt</span><span class="o">++</span><span class="p">;</span>

	<span class="cm">/* End of packet == #XX so look for the &#39;#&#39; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">put_buf_cnt</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">&amp;&amp;</span> <span class="n">put_buf</span><span class="p">[</span><span class="n">put_buf_cnt</span> <span class="o">-</span> <span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;#&#39;</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">put_buf_cnt</span> <span class="o">&gt;=</span> <span class="n">BUFMAX</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: ERROR: put buffer overflow on&quot;</span>
				<span class="s">&quot; &#39;%s&#39; line %i</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">);</span>
			<span class="n">put_buf_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">put_buf</span><span class="p">[</span><span class="n">put_buf_cnt</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
		<span class="n">v2printk</span><span class="p">(</span><span class="s">&quot;put%i: %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">put_buf</span><span class="p">);</span>
		<span class="cm">/* Trigger check here */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">validate_put</span> <span class="o">&amp;&amp;</span> <span class="n">ts</span><span class="p">.</span><span class="n">validate_put</span><span class="p">(</span><span class="n">put_buf</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: ERROR PUT: end of test &quot;</span>
			   <span class="s">&quot;buffer on &#39;%s&#39; line %i expected %s got %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">ts</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">tst</span><span class="p">[</span><span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="p">].</span><span class="n">put</span><span class="p">,</span> <span class="n">put_buf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">idx</span><span class="o">++</span><span class="p">;</span>
		<span class="n">put_buf_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">get_buf_cnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">send_ack</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">init_simple_test</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">ts</span><span class="p">));</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">run_test</span> <span class="o">=</span> <span class="n">run_simple_test</span><span class="p">;</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">validate_put</span> <span class="o">=</span> <span class="n">validate_simple_test</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">run_plant_and_detach_test</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_early</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="n">before</span><span class="p">[</span><span class="n">BREAK_INSTR_SIZE</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">after</span><span class="p">[</span><span class="n">BREAK_INSTR_SIZE</span><span class="p">];</span>

	<span class="n">probe_kernel_read</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">kgdbts_break_test</span><span class="p">,</span>
	  <span class="n">BREAK_INSTR_SIZE</span><span class="p">);</span>
	<span class="n">init_simple_test</span><span class="p">();</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">tst</span> <span class="o">=</span> <span class="n">plant_and_detach_test</span><span class="p">;</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;plant_and_detach_test&quot;</span><span class="p">;</span>
	<span class="cm">/* Activate test with initial breakpoint */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_early</span><span class="p">)</span>
		<span class="n">kgdb_breakpoint</span><span class="p">();</span>
	<span class="n">probe_kernel_read</span><span class="p">(</span><span class="n">after</span><span class="p">,</span> <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">kgdbts_break_test</span><span class="p">,</span>
	  <span class="n">BREAK_INSTR_SIZE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">memcmp</span><span class="p">(</span><span class="n">before</span><span class="p">,</span> <span class="n">after</span><span class="p">,</span> <span class="n">BREAK_INSTR_SIZE</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_CRIT</span> <span class="s">&quot;kgdbts: ERROR kgdb corrupted memory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">panic</span><span class="p">(</span><span class="s">&quot;kgdb memory corruption&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* complete the detach test */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_early</span><span class="p">)</span>
		<span class="n">kgdbts_break_test</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">run_breakpoint_test</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_hw_breakpoint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">test_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_simple_test</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_hw_breakpoint</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">tst</span> <span class="o">=</span> <span class="n">hw_breakpoint_test</span><span class="p">;</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hw_breakpoint_test&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">tst</span> <span class="o">=</span> <span class="n">sw_breakpoint_test</span><span class="p">;</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sw_breakpoint_test&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Activate test with initial breakpoint */</span>
	<span class="n">kgdb_breakpoint</span><span class="p">();</span>
	<span class="cm">/* run code with the break point in it */</span>
	<span class="n">kgdbts_break_test</span><span class="p">();</span>
	<span class="n">kgdb_breakpoint</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_complete</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: ERROR %s test failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_hw_breakpoint</span><span class="p">)</span>
		<span class="n">hwbreaks_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">run_hw_break_test</span><span class="p">(</span><span class="kt">int</span> <span class="n">is_write_test</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">test_complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_simple_test</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_write_test</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">tst</span> <span class="o">=</span> <span class="n">hw_write_break_test</span><span class="p">;</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hw_write_break_test&quot;</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">tst</span> <span class="o">=</span> <span class="n">hw_access_break_test</span><span class="p">;</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;hw_access_break_test&quot;</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Activate test with initial breakpoint */</span>
	<span class="n">kgdb_breakpoint</span><span class="p">();</span>
	<span class="n">hw_break_val_access</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_write_test</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">test_complete</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: ERROR %s broke on access</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">ts</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
			<span class="n">hwbreaks_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">hw_break_val_write</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="n">kgdb_breakpoint</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">test_complete</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: ERROR %s test failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
	<span class="n">hwbreaks_ok</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">run_nmi_sleep_test</span><span class="p">(</span><span class="kt">int</span> <span class="n">nmi_sleep</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">init_simple_test</span><span class="p">();</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">tst</span> <span class="o">=</span> <span class="n">nmi_sleep_test</span><span class="p">;</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;nmi_sleep_test&quot;</span><span class="p">;</span>
	<span class="cm">/* Activate test with initial breakpoint */</span>
	<span class="n">kgdb_breakpoint</span><span class="p">();</span>
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="n">nmi_sleep</span><span class="o">*</span><span class="mi">1000</span><span class="p">);</span>
	<span class="n">touch_nmi_watchdog</span><span class="p">();</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_complete</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">)</span>
		<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: ERROR nmi_test did not hit nmi</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kgdb_breakpoint</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">test_complete</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">eprintk</span><span class="p">(</span><span class="s">&quot;kgdbts: ERROR %s test failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ts</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">run_bad_read_test</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_simple_test</span><span class="p">();</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">tst</span> <span class="o">=</span> <span class="n">bad_read_test</span><span class="p">;</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;bad_read_test&quot;</span><span class="p">;</span>
	<span class="cm">/* Activate test with initial breakpoint */</span>
	<span class="n">kgdb_breakpoint</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">run_do_fork_test</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_simple_test</span><span class="p">();</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">tst</span> <span class="o">=</span> <span class="n">do_fork_test</span><span class="p">;</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;do_fork_test&quot;</span><span class="p">;</span>
	<span class="cm">/* Activate test with initial breakpoint */</span>
	<span class="n">kgdb_breakpoint</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">run_sys_open_test</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_simple_test</span><span class="p">();</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">tst</span> <span class="o">=</span> <span class="n">sys_open_test</span><span class="p">;</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;sys_open_test&quot;</span><span class="p">;</span>
	<span class="cm">/* Activate test with initial breakpoint */</span>
	<span class="n">kgdb_breakpoint</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">run_singlestep_break_test</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">init_simple_test</span><span class="p">();</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">tst</span> <span class="o">=</span> <span class="n">singlestep_break_test</span><span class="p">;</span>
	<span class="n">ts</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;singlestep_breakpoint_test&quot;</span><span class="p">;</span>
	<span class="cm">/* Activate test with initial breakpoint */</span>
	<span class="n">kgdb_breakpoint</span><span class="p">();</span>
	<span class="n">kgdbts_break_test</span><span class="p">();</span>
	<span class="n">kgdbts_break_test</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kgdbts_run_tests</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">fork_test</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">do_sys_open_test</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">sstep_test</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">nmi_sleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">ptr</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="sc">&#39;F&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
		<span class="n">fork_test</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="sc">&#39;S&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
		<span class="n">do_sys_open_test</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
		<span class="n">nmi_sleep</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">strchr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="sc">&#39;I&#39;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
		<span class="n">sstep_test</span> <span class="o">=</span> <span class="n">simple_strtol</span><span class="p">(</span><span class="n">ptr</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">10</span><span class="p">);</span>

	<span class="cm">/* All HW break point tests */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">arch_kgdb_ops</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">KGDB_HW_BREAKPOINT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">hwbreaks_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">v1printk</span><span class="p">(</span><span class="s">&quot;kgdbts:RUN hw breakpoint test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">run_breakpoint_test</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">v1printk</span><span class="p">(</span><span class="s">&quot;kgdbts:RUN hw write breakpoint test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">run_hw_break_test</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="n">v1printk</span><span class="p">(</span><span class="s">&quot;kgdbts:RUN access write breakpoint test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">run_hw_break_test</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* required internal KGDB tests */</span>
	<span class="n">v1printk</span><span class="p">(</span><span class="s">&quot;kgdbts:RUN plant and detach test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">run_plant_and_detach_test</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">v1printk</span><span class="p">(</span><span class="s">&quot;kgdbts:RUN sw breakpoint test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">run_breakpoint_test</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">v1printk</span><span class="p">(</span><span class="s">&quot;kgdbts:RUN bad memory access test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">run_bad_read_test</span><span class="p">();</span>
	<span class="n">v1printk</span><span class="p">(</span><span class="s">&quot;kgdbts:RUN singlestep test %i iterations</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sstep_test</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sstep_test</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">run_singlestep_break_test</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">%</span> <span class="mi">100</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">v1printk</span><span class="p">(</span><span class="s">&quot;kgdbts:RUN singlestep [%i/%i]</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				 <span class="n">i</span><span class="p">,</span> <span class="n">sstep_test</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* ===Optional tests=== */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nmi_sleep</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">v1printk</span><span class="p">(</span><span class="s">&quot;kgdbts:RUN NMI sleep %i seconds test</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">nmi_sleep</span><span class="p">);</span>
		<span class="n">run_nmi_sleep_test</span><span class="p">(</span><span class="n">nmi_sleep</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If the do_fork test is run it will be the last test that is</span>
<span class="cm">	 * executed because a kernel thread will be spawned at the very</span>
<span class="cm">	 * end to unregister the debug hooks.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fork_test</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">repeat_test</span> <span class="o">=</span> <span class="n">fork_test</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;kgdbts:RUN do_fork for %i breakpoints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">repeat_test</span><span class="p">);</span>
		<span class="n">kthread_run</span><span class="p">(</span><span class="n">kgdbts_unreg_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;kgdbts_unreg&quot;</span><span class="p">);</span>
		<span class="n">run_do_fork_test</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* If the sys_open test is run it will be the last test that is</span>
<span class="cm">	 * executed because a kernel thread will be spawned at the very</span>
<span class="cm">	 * end to unregister the debug hooks.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">do_sys_open_test</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">repeat_test</span> <span class="o">=</span> <span class="n">do_sys_open_test</span><span class="p">;</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;kgdbts:RUN sys_open for %i breakpoints</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">repeat_test</span><span class="p">);</span>
		<span class="n">kthread_run</span><span class="p">(</span><span class="n">kgdbts_unreg_thread</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;kgdbts_unreg&quot;</span><span class="p">);</span>
		<span class="n">run_sys_open_test</span><span class="p">();</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* Shutdown and unregister */</span>
	<span class="n">kgdb_unregister_io_module</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kgdbts_io_ops</span><span class="p">);</span>
	<span class="n">configured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kgdbts_option_setup</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">opt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strlen</span><span class="p">(</span><span class="n">opt</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MAX_CONFIG_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;kgdbts: config string too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">strcpy</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">opt</span><span class="p">);</span>

	<span class="n">verbose</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s">&quot;V1&quot;</span><span class="p">))</span>
		<span class="n">verbose</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">strstr</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="s">&quot;V2&quot;</span><span class="p">))</span>
		<span class="n">verbose</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">__setup</span><span class="p">(</span><span class="s">&quot;kgdbts=&quot;</span><span class="p">,</span> <span class="n">kgdbts_option_setup</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">configure_kgdbts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">strlen</span><span class="p">(</span><span class="n">config</span><span class="p">)</span> <span class="o">||</span> <span class="n">isspace</span><span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
		<span class="k">goto</span> <span class="n">noconfig</span><span class="p">;</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">kgdbts_option_setup</span><span class="p">(</span><span class="n">config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">noconfig</span><span class="p">;</span>

	<span class="n">final_ack</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">run_plant_and_detach_test</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">kgdb_register_io_module</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kgdbts_io_ops</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">configured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">configured</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">kgdbts_run_tests</span><span class="p">();</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>

<span class="nl">noconfig:</span>
	<span class="n">config</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">configured</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_kgdbts</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Already configured? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">configured</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">configure_kgdbts</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kgdbts_get_char</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">run_test</span><span class="p">)</span>
		<span class="n">val</span> <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">run_test</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kgdbts_put_char</span><span class="p">(</span><span class="n">u8</span> <span class="n">chr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ts</span><span class="p">.</span><span class="n">run_test</span><span class="p">)</span>
		<span class="n">ts</span><span class="p">.</span><span class="n">run_test</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">chr</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">param_set_kgdbts_var</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">kmessage</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kernel_param</span> <span class="o">*</span><span class="n">kp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">kmessage</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;=</span> <span class="n">MAX_CONFIG_LEN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;kgdbts: config string too long</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSPC</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Only copy in the string if the init function has not run yet */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">configured</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">strcpy</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">kmessage</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">configured</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;kgdbts: ERROR: Already configured and running.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">strcpy</span><span class="p">(</span><span class="n">config</span><span class="p">,</span> <span class="n">kmessage</span><span class="p">);</span>
	<span class="cm">/* Chop out \n char as a result of echo */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">config</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;\n&#39;</span><span class="p">)</span>
		<span class="n">config</span><span class="p">[</span><span class="n">len</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>

	<span class="cm">/* Go and configure with the new params. */</span>
	<span class="k">return</span> <span class="n">configure_kgdbts</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kgdbts_pre_exp_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* Increment the module count when the debugger is active */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kgdb_connected</span><span class="p">)</span>
		<span class="n">try_module_get</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">kgdbts_post_exp_handler</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* decrement the module count when the debugger detaches */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kgdb_connected</span><span class="p">)</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kgdb_io</span> <span class="n">kgdbts_io_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>			<span class="o">=</span> <span class="s">&quot;kgdbts&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read_char</span>		<span class="o">=</span> <span class="n">kgdbts_get_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write_char</span>		<span class="o">=</span> <span class="n">kgdbts_put_char</span><span class="p">,</span>
	<span class="p">.</span><span class="n">pre_exception</span>		<span class="o">=</span> <span class="n">kgdbts_pre_exp_handler</span><span class="p">,</span>
	<span class="p">.</span><span class="n">post_exception</span>		<span class="o">=</span> <span class="n">kgdbts_post_exp_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_kgdbts</span><span class="p">);</span>
<span class="n">module_param_call</span><span class="p">(</span><span class="n">kgdbts</span><span class="p">,</span> <span class="n">param_set_kgdbts_var</span><span class="p">,</span> <span class="n">param_get_string</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kps</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">kgdbts</span><span class="p">,</span> <span class="s">&quot;&lt;A|V1|V2&gt;[F#|S#][N#]&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;KGDB Test Suite&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Wind River Systems, Inc.&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
