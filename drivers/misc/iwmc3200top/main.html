<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › misc › iwmc3200top › main.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>main.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * iwmc3200top - Intel Wireless MultiCom 3200 Top Driver</span>
<span class="cm"> * drivers/misc/iwmc3200top/main.c</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2009 Intel Corporation. All rights reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License version</span>
<span class="cm"> * 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301, USA.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Author Name: Maxim Grabarnik &lt;maxim.grabarnink@intel.com&gt;</span>
<span class="cm"> *  -</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sdio_ids.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sdio_func.h&gt;</span>
<span class="cp">#include &lt;linux/mmc/sdio.h&gt;</span>

<span class="cp">#include &quot;iwmc3200top.h&quot;</span>
<span class="cp">#include &quot;log.h&quot;</span>
<span class="cp">#include &quot;fw-msg.h&quot;</span>
<span class="cp">#include &quot;debugfs.h&quot;</span>


<span class="cp">#define DRIVER_DESCRIPTION &quot;Intel(R) IWMC 3200 Top Driver&quot;</span>
<span class="cp">#define DRIVER_COPYRIGHT &quot;Copyright (c) 2008 Intel Corporation.&quot;</span>

<span class="cp">#define DRIVER_VERSION  &quot;0.1.62&quot;</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="n">DRIVER_DESCRIPTION</span><span class="p">);</span>
<span class="n">MODULE_VERSION</span><span class="p">(</span><span class="n">DRIVER_VERSION</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="n">DRIVER_COPYRIGHT</span><span class="p">);</span>
<span class="n">MODULE_FIRMWARE</span><span class="p">(</span><span class="n">FW_NAME</span><span class="p">(</span><span class="n">FW_API_VER</span><span class="p">));</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">__iwmct_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwmct_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sdio_memcpy_toio</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">IWMC_SDIO_DATA_ADDR</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>

<span class="p">}</span>
<span class="kt">int</span> <span class="nf">iwmct_tx</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwmct_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">src</span><span class="p">,</span> <span class="kt">int</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">sdio_claim_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span>  <span class="n">__iwmct_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">src</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">sdio_release_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="cm">/*</span>
<span class="cm"> * This workers main task is to wait for OP_OPR_ALIVE</span>
<span class="cm"> * from TOP FW until ALIVE_MSG_TIMOUT timeout is elapsed.</span>
<span class="cm"> * When OP_OPR_ALIVE received it will issue</span>
<span class="cm"> * a call to &quot;bus_rescan_devices&quot;.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwmct_rescan_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwmct_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwmct_priv</span><span class="p">,</span> <span class="n">bus_rescan_worker</span><span class="p">);</span>

	<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">FW_MSG</span><span class="p">,</span> <span class="s">&quot;Calling bus_rescan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bus_rescan_devices</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;bus_rescan_devices FAILED!!!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">op_top_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwmct_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="k">struct</span> <span class="n">top_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">opcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">OP_OPR_ALIVE</span>:
		<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">FW_MSG</span><span class="p">,</span> <span class="s">&quot;Got ALIVE from device, wake rescan</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_rescan_worker</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">FW_MSG</span><span class="p">,</span> <span class="s">&quot;Received msg opcode 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">opcode</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_top_message</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwmct_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">top_msg</span> <span class="o">*</span><span class="n">msg</span><span class="p">;</span>

	<span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">top_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span> <span class="o">!=</span> <span class="n">COMM_TYPE_D2H</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">FW_MSG</span><span class="p">,</span>
			<span class="s">&quot;Message from TOP with invalid message type 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">type</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">FW_MSG</span><span class="p">,</span>
			<span class="s">&quot;Message from TOP is too short for message header &quot;</span>
			<span class="s">&quot;received %d bytes, expected at least %zd bytes</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">len</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&lt;</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span><span class="p">)</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">FW_MSG</span><span class="p">,</span>
			<span class="s">&quot;Message length (%d bytes) is shorter than &quot;</span>
			<span class="s">&quot;in header (%d bytes)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">len</span><span class="p">,</span> <span class="n">le16_to_cpu</span><span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">length</span><span class="p">));</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">category</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">COMM_CATEGORY_OPERATIONAL</span>:
		<span class="n">op_top_message</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">top_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">COMM_CATEGORY_DEBUG</span>:
	<span class="k">case</span> <span class="n">COMM_CATEGORY_TESTABILITY</span>:
	<span class="k">case</span> <span class="n">COMM_CATEGORY_DIAGNOSTICS</span>:
		<span class="n">iwmct_log_top_message</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">FW_MSG</span><span class="p">,</span>
			<span class="s">&quot;Message from TOP with unknown category 0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">msg</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">category</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">iwmct_send_hcmd</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwmct_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">cmd</span><span class="p">,</span> <span class="n">u16</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="o">*</span><span class="n">buf</span><span class="p">;</span>

	<span class="n">LOG_TRACE</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">FW_MSG</span><span class="p">,</span> <span class="s">&quot;Sending hcmd:</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* add padding to 256 for IWMC */</span>
	<span class="p">((</span><span class="k">struct</span> <span class="n">top_msg</span> <span class="o">*</span><span class="p">)</span><span class="n">cmd</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">hdr</span><span class="p">.</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">CMD_FLAG_PADDING_256</span><span class="p">;</span>

	<span class="n">LOG_HEXDUMP</span><span class="p">(</span><span class="n">FW_MSG</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">FW_HCMD_BLOCK_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">FW_MSG</span><span class="p">,</span> <span class="s">&quot;size %d exceeded hcmd max size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">len</span><span class="p">,</span> <span class="n">FW_HCMD_BLOCK_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">FW_HCMD_BLOCK_SIZE</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">FW_MSG</span><span class="p">,</span> <span class="s">&quot;kzalloc error, buf size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			  <span class="n">FW_HCMD_BLOCK_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">memcpy</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">iwmct_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">FW_HCMD_BLOCK_SIZE</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwmct_irq_read_worker</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">ws</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwmct_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwmct_work_struct</span> <span class="o">*</span><span class="n">read_req</span><span class="p">;</span>
	<span class="n">__le32</span> <span class="o">*</span><span class="n">buf</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iosize</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">barker</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">is_barker</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ws</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iwmct_priv</span><span class="p">,</span> <span class="n">isr_worker</span><span class="p">);</span>

	<span class="n">LOG_TRACE</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;enter iwmct_irq_read_worker %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ws</span><span class="p">);</span>

	<span class="cm">/* --------------------- Handshake with device -------------------- */</span>
	<span class="n">sdio_claim_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>

	<span class="cm">/* all list manipulations have to be protected by</span>
<span class="cm">	 * sdio_claim_host/sdio_release_host */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">read_req_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;read_req_list empty in read worker</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">read_req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">read_req_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			      <span class="k">struct</span> <span class="n">iwmct_work_struct</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">read_req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">iosize</span> <span class="o">=</span> <span class="n">read_req</span><span class="o">-&gt;</span><span class="n">iosize</span><span class="p">;</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">read_req</span><span class="p">);</span>

	<span class="n">buf</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="n">iosize</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buf</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;kzalloc error, buf size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iosize</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;iosize=%d, buf=%p, func=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">iosize</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">num</span><span class="p">);</span>

	<span class="cm">/* read from device */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_memcpy_fromio</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">IWMC_SDIO_DATA_ADDR</span><span class="p">,</span> <span class="n">iosize</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;error %d reading buffer</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_release</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">LOG_HEXDUMP</span><span class="p">(</span><span class="n">IRQ</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">iosize</span><span class="p">);</span>

	<span class="n">barker</span> <span class="o">=</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

	<span class="cm">/* Verify whether it&#39;s a barker and if not - treat as regular Rx */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">barker</span> <span class="o">==</span> <span class="n">IWMC_BARKER_ACK</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">barker</span> <span class="o">&amp;</span> <span class="n">BARKER_DNLOAD_BARKER_MSK</span><span class="p">)</span> <span class="o">==</span> <span class="n">IWMC_BARKER_REBOOT</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* Valid Barker is equal on first 4 dwords */</span>
		<span class="n">is_barker</span> <span class="o">=</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_barker</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">LOG_WARNING</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span>
				<span class="s">&quot;Potentially inconsistent barker &quot;</span>
				<span class="s">&quot;%08X_%08X_%08X_%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span>
				<span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">le32_to_cpu</span><span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">]));</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">is_barker</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Handle Top CommHub message */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_barker</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">sdio_release_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
		<span class="n">handle_top_message</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="p">(</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span> <span class="n">iosize</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">barker</span> <span class="o">==</span> <span class="n">IWMC_BARKER_ACK</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* Handle barkers */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev_sync</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span>
				  <span class="s">&quot;ACK barker arrived out-of-sync</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit_release</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Continuing to FW download (after Sync is completed)*/</span>
		<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev_sync</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;ACK barker arrived &quot;</span>
				<span class="s">&quot;- starting FW download</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="cm">/* REBOOT barker */</span>
		<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;Received reboot barker: %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">barker</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">barker</span> <span class="o">=</span> <span class="n">barker</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">barker</span> <span class="o">&amp;</span> <span class="n">BARKER_DNLOAD_SYNC_MSK</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Send the same barker back */</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">__iwmct_tx</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">iosize</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span>
					 <span class="s">&quot;error %d echoing barker</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">exit_release</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;Echoing barker to device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev_sync</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">exit_release</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Continuing to FW download (without Sync) */</span>
		<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;No sync requested &quot;</span>
				    <span class="s">&quot;- starting FW download</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">sdio_release_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">fw_download</span><span class="p">)</span>
		<span class="n">iwmct_fw_load</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;FW download not allowed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">goto</span> <span class="n">exit</span><span class="p">;</span>

<span class="nl">exit_release:</span>
	<span class="n">sdio_release_host</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">);</span>
<span class="nl">exit:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">LOG_TRACE</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;exit iwmct_irq_read_worker</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwmct_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwmct_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">iosize</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">IWMC_SDIO_INTR_GET_SIZE_ADDR</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwmct_work_struct</span> <span class="o">*</span><span class="n">read_req</span><span class="p">;</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">sdio_get_drvdata</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>

	<span class="n">LOG_TRACE</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;enter iwmct_irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* read the function&#39;s status register */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sdio_readb</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">IWMC_SDIO_INTR_STATUS_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>

	<span class="n">LOG_TRACE</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;iir value = %d, ret=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;iir = 0, exiting ISR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_clear_intr</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/*</span>
<span class="cm">	 * read 2 bytes of the transaction size</span>
<span class="cm">	 * IMPORTANT: sdio transaction size has to be read before clearing</span>
<span class="cm">	 * sdio interrupt!!!</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sdio_readb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">addr</span><span class="o">++</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">iosize</span> <span class="o">=</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">sdio_readb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">addr</span><span class="o">++</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
	<span class="n">iosize</span> <span class="o">+=</span> <span class="n">val</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;READ size %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iosize</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">iosize</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;READ size %d, exiting ISR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">iosize</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_clear_intr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* allocate a work structure to pass iosize to the worker */</span>
	<span class="n">read_req</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwmct_work_struct</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">read_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;failed to allocate read_req, exit ISR</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">exit_clear_intr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">read_req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
	<span class="n">read_req</span><span class="o">-&gt;</span><span class="n">iosize</span> <span class="o">=</span> <span class="n">iosize</span><span class="p">;</span>

	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">read_req_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">read_req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>

	<span class="cm">/* clear the function&#39;s interrupt request bit (write 1 to clear) */</span>
	<span class="n">sdio_writeb</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IWMC_SDIO_INTR_CLEAR_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>

	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">isr_worker</span><span class="p">);</span>

	<span class="n">LOG_TRACE</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">IRQ</span><span class="p">,</span> <span class="s">&quot;exit iwmct_irq</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

<span class="nl">exit_clear_intr:</span>
	<span class="cm">/* clear the function&#39;s interrupt request bit (write 1 to clear) */</span>
	<span class="n">sdio_writeb</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">IWMC_SDIO_INTR_CLEAR_ADDR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">blocks</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0604</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">blocks</span><span class="p">,</span> <span class="s">&quot;max_blocks_to_send&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">dump</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dump</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0604</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">dump</span><span class="p">,</span> <span class="s">&quot;dump_hex_content&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">jump</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">jump</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0604</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">direct</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">direct</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0604</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">checksum</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">checksum</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0604</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">fw_download</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">fw_download</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0604</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">block_size</span> <span class="o">=</span> <span class="n">IWMC_SDIO_BLK_SIZE</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">block_size</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0404</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">download_trans_blks</span> <span class="o">=</span> <span class="n">IWMC_DEFAULT_TR_BLK</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">download_trans_blks</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0604</span><span class="p">);</span>

<span class="k">static</span> <span class="n">bool</span> <span class="n">rubbish_barker</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">rubbish_barker</span><span class="p">,</span> <span class="n">bool</span><span class="p">,</span> <span class="mo">0604</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IWMC3200TOP_DEBUG</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">log_level</span><span class="p">[</span><span class="n">LOG_SRC_MAX</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">log_level_argc</span><span class="p">;</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">log_level</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">log_level_argc</span><span class="p">,</span> <span class="mo">0604</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">log_level</span><span class="p">,</span> <span class="s">&quot;log_level&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">log_level_fw</span><span class="p">[</span><span class="n">FW_LOG_SRC_MAX</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">log_level_fw_argc</span><span class="p">;</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">log_level_fw</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">log_level_fw_argc</span><span class="p">,</span> <span class="mo">0604</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">log_level_fw</span><span class="p">,</span> <span class="s">&quot;log_level_fw&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">iwmct_dbg_init_params</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwmct_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_IWMC3200TOP_DEBUG</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">log_level_argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;log_level[%d]=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">i</span><span class="p">,</span> <span class="n">log_level</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">iwmct_log_set_filter</span><span class="p">((</span><span class="n">log_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
			       <span class="n">log_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">log_level_fw_argc</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_notice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;log_level_fw[%d]=0x%X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
						<span class="n">i</span><span class="p">,</span> <span class="n">log_level_fw</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">iwmct_log_set_fw_filter</span><span class="p">((</span><span class="n">log_level_fw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">,</span>
				  <span class="n">log_level_fw</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">blocks</span> <span class="o">=</span> <span class="n">blocks</span><span class="p">;</span>
	<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;blocks=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">blocks</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">dump</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span><span class="n">dump</span><span class="p">;</span>
	<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;dump=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">dump</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">jump</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span><span class="n">jump</span><span class="p">;</span>
	<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;jump=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">jump</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">direct</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span><span class="n">direct</span><span class="p">;</span>
	<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;direct=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">direct</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">checksum</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span><span class="n">checksum</span><span class="p">;</span>
	<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;checksum=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">checksum</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">fw_download</span> <span class="o">=</span> <span class="p">(</span><span class="n">bool</span><span class="p">)</span><span class="n">fw_download</span><span class="p">;</span>
	<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;fw_download=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">fw_download</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">block_size</span> <span class="o">=</span> <span class="n">block_size</span><span class="p">;</span>
	<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;block_size=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">block_size</span><span class="p">);</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">download_trans_blks</span> <span class="o">=</span> <span class="n">download_trans_blks</span><span class="p">;</span>
	<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;download_trans_blks=%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">download_trans_blks</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*****************************************************************************</span>
<span class="cm"> *</span>
<span class="cm"> * sysfs attributes</span>
<span class="cm"> *</span>
<span class="cm"> *****************************************************************************/</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_iwmct_fw_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">d</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwmct_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">d</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">label_fw</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">cc_label_fw</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_iwmct_fw_version</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_IWMC3200TOP_DEBUG</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">log_level</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">show_iwmct_log_level</span><span class="p">,</span> <span class="n">store_iwmct_log_level</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">log_level_fw</span><span class="p">,</span> <span class="n">S_IWUSR</span> <span class="o">|</span> <span class="n">S_IRUGO</span><span class="p">,</span>
		   <span class="n">show_iwmct_log_level_fw</span><span class="p">,</span> <span class="n">store_iwmct_log_level_fw</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">iwmct_sysfs_entries</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_cc_label_fw</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_IWMC3200TOP_DEBUG</span>
	<span class="o">&amp;</span><span class="n">dev_attr_log_level</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_log_level_fw</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">iwmct_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">,</span>		<span class="cm">/* put in device directory */</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">iwmct_sysfs_entries</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">iwmct_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
			   <span class="k">const</span> <span class="k">struct</span> <span class="n">sdio_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwmct_priv</span> <span class="o">*</span><span class="n">priv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">val</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">addr</span> <span class="o">=</span> <span class="n">IWMC_SDIO_INTR_ENABLE_ADDR</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;enter iwmct_probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;IRQ polling period id %u msecs, HZ is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">jiffies_to_msecs</span><span class="p">(</span><span class="mi">2147483647</span><span class="p">),</span> <span class="n">HZ</span><span class="p">);</span>

	<span class="n">priv</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">iwmct_priv</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;kzalloc error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span><span class="p">;</span>
	<span class="n">sdio_set_drvdata</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">priv</span><span class="p">);</span>

	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_rescan_worker</span><span class="p">,</span> <span class="n">iwmct_rescan_worker</span><span class="p">);</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">isr_worker</span><span class="p">,</span> <span class="n">iwmct_irq_read_worker</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">wait_q</span><span class="p">);</span>

	<span class="n">sdio_claim_host</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="cm">/* FIXME: Remove after it is fixed in the Boot ROM upgrade */</span>
	<span class="n">func</span><span class="o">-&gt;</span><span class="n">enable_timeout</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>

	<span class="cm">/* In our HW, setting the block size also wakes up the boot rom. */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_set_block_size</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">block_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span>
			<span class="s">&quot;sdio_set_block_size() failure: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_sdio_enable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_enable_func</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;sdio_enable_func() failure: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_sdio_enable</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* init reset and dev_sync states */</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dev_sync</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* init read req queue */</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">read_req_list</span><span class="p">);</span>

	<span class="cm">/* process configurable parameters */</span>
	<span class="n">iwmct_dbg_init_params</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwmct_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;Failed to register attributes and &quot;</span>
			 <span class="s">&quot;initialize module_params</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_dev_attrs</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iwmct_dbgfs_register</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">DRV_NAME</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">direct</span> <span class="o">&amp;&amp;</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">download_trans_blks</span> <span class="o">&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span>
			 <span class="s">&quot;Reducing transaction to 8 blocks = 2K (from %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">download_trans_blks</span><span class="p">);</span>
		<span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">download_trans_blks</span> <span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">priv</span><span class="o">-&gt;</span><span class="n">trans_len</span> <span class="o">=</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">download_trans_blks</span> <span class="o">*</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbg</span><span class="p">.</span><span class="n">block_size</span><span class="p">;</span>
	<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;Transaction length = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">priv</span><span class="o">-&gt;</span><span class="n">trans_len</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sdio_claim_irq</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iwmct_irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;sdio_claim_irq() failure: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_claim_irq</span><span class="p">;</span>
	<span class="p">}</span>


	<span class="cm">/* Enable function&#39;s interrupt */</span>
	<span class="n">sdio_writeb</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">ret</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">LOG_ERROR</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;Failure writing to &quot;</span>
			  <span class="s">&quot;Interrupt Enable Register (%d): %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">error_enable_int</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sdio_release_host</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>

	<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;exit iwmct_probe</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="nl">error_enable_int:</span>
	<span class="n">sdio_release_irq</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
<span class="nl">error_claim_irq:</span>
	<span class="n">sdio_disable_func</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
<span class="nl">error_dev_attrs:</span>
	<span class="n">iwmct_dbgfs_unregister</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbgfs</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwmct_attribute_group</span><span class="p">);</span>
<span class="nl">error_sdio_enable:</span>
	<span class="n">sdio_release_host</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iwmct_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">sdio_func</span> <span class="o">*</span><span class="n">func</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iwmct_work_struct</span> <span class="o">*</span><span class="n">read_req</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iwmct_priv</span> <span class="o">*</span><span class="n">priv</span> <span class="o">=</span> <span class="n">sdio_get_drvdata</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>

	<span class="n">LOG_INFO</span><span class="p">(</span><span class="n">priv</span><span class="p">,</span> <span class="n">INIT</span><span class="p">,</span> <span class="s">&quot;enter</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">sdio_claim_host</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="n">sdio_release_irq</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="n">sdio_release_host</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>

	<span class="cm">/* Make sure works are finished */</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">bus_rescan_worker</span><span class="p">);</span>
	<span class="n">flush_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">isr_worker</span><span class="p">);</span>

	<span class="n">sdio_claim_host</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="n">sdio_disable_func</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">func</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">iwmct_attribute_group</span><span class="p">);</span>
	<span class="n">iwmct_dbgfs_unregister</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">dbgfs</span><span class="p">);</span>
	<span class="n">sdio_release_host</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>

	<span class="cm">/* free read requests */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">read_req_list</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">read_req</span> <span class="o">=</span> <span class="n">list_entry</span><span class="p">(</span><span class="n">priv</span><span class="o">-&gt;</span><span class="n">read_req_list</span><span class="p">.</span><span class="n">next</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">iwmct_work_struct</span><span class="p">,</span> <span class="n">list</span><span class="p">);</span>

		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">read_req</span><span class="o">-&gt;</span><span class="n">list</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">read_req</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">priv</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">sdio_device_id</span> <span class="n">iwmct_ids</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Intel Wireless MultiCom 3200 Top Driver */</span>
	<span class="p">{</span> <span class="n">SDIO_DEVICE</span><span class="p">(</span><span class="n">SDIO_VENDOR_ID_INTEL</span><span class="p">,</span> <span class="mh">0x1404</span><span class="p">)},</span>
	<span class="p">{</span> <span class="p">},</span>	<span class="cm">/* Terminating entry */</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">sdio</span><span class="p">,</span> <span class="n">iwmct_ids</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">sdio_driver</span> <span class="n">iwmct_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">iwmct_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">iwmct_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">name</span>		<span class="o">=</span> <span class="n">DRV_NAME</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span>	<span class="o">=</span> <span class="n">iwmct_ids</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">iwmct_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="cm">/* Default log filter settings */</span>
	<span class="n">iwmct_log_set_filter</span><span class="p">(</span><span class="n">LOG_SRC_ALL</span><span class="p">,</span> <span class="n">LOG_SEV_FILTER_RUNTIME</span><span class="p">);</span>
	<span class="n">iwmct_log_set_filter</span><span class="p">(</span><span class="n">LOG_SRC_FW_MSG</span><span class="p">,</span> <span class="n">LOG_SEV_FW_FILTER_ALL</span><span class="p">);</span>
	<span class="n">iwmct_log_set_fw_filter</span><span class="p">(</span><span class="n">LOG_SRC_ALL</span><span class="p">,</span> <span class="n">FW_LOG_SEV_FILTER_RUNTIME</span><span class="p">);</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sdio_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwmct_driver</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">iwmct_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">sdio_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iwmct_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">iwmct_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">iwmct_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
