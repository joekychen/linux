<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › misc › bh1770glc.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>bh1770glc.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * This file is part of the ROHM BH1770GLC / OSRAM SFH7770 sensor driver.</span>
<span class="cm"> * Chip is combined proximity and ambient light sensor.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2010 Nokia Corporation and/or its subsidiary(-ies).</span>
<span class="cm"> *</span>
<span class="cm"> * Contact: Samu Onkalo &lt;samu.p.onkalo@nokia.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or</span>
<span class="cm"> * modify it under the terms of the GNU General Public License</span>
<span class="cm"> * version 2 as published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful, but</span>
<span class="cm"> * WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.	 See the GNU</span>
<span class="cm"> * General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 51 Franklin St, Fifth Floor, Boston, MA</span>
<span class="cm"> * 02110-1301 USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/i2c.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/i2c/bh1770glc.h&gt;</span>
<span class="cp">#include &lt;linux/regulator/consumer.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#define BH1770_ALS_CONTROL	0x80 </span><span class="cm">/* ALS operation mode control */</span><span class="cp"></span>
<span class="cp">#define BH1770_PS_CONTROL	0x81 </span><span class="cm">/* PS operation mode control */</span><span class="cp"></span>
<span class="cp">#define BH1770_I_LED		0x82 </span><span class="cm">/* active LED and LED1, LED2 current */</span><span class="cp"></span>
<span class="cp">#define BH1770_I_LED3		0x83 </span><span class="cm">/* LED3 current setting */</span><span class="cp"></span>
<span class="cp">#define BH1770_ALS_PS_MEAS	0x84 </span><span class="cm">/* Forced mode trigger */</span><span class="cp"></span>
<span class="cp">#define BH1770_PS_MEAS_RATE	0x85 </span><span class="cm">/* PS meas. rate at stand alone mode */</span><span class="cp"></span>
<span class="cp">#define BH1770_ALS_MEAS_RATE	0x86 </span><span class="cm">/* ALS meas. rate at stand alone mode */</span><span class="cp"></span>
<span class="cp">#define BH1770_PART_ID		0x8a </span><span class="cm">/* Part number and revision ID */</span><span class="cp"></span>
<span class="cp">#define BH1770_MANUFACT_ID	0x8b </span><span class="cm">/* Manufacturerer ID */</span><span class="cp"></span>
<span class="cp">#define BH1770_ALS_DATA_0	0x8c </span><span class="cm">/* ALS DATA low byte */</span><span class="cp"></span>
<span class="cp">#define BH1770_ALS_DATA_1	0x8d </span><span class="cm">/* ALS DATA high byte */</span><span class="cp"></span>
<span class="cp">#define BH1770_ALS_PS_STATUS	0x8e </span><span class="cm">/* Measurement data and int status */</span><span class="cp"></span>
<span class="cp">#define BH1770_PS_DATA_LED1	0x8f </span><span class="cm">/* PS data from LED1 */</span><span class="cp"></span>
<span class="cp">#define BH1770_PS_DATA_LED2	0x90 </span><span class="cm">/* PS data from LED2 */</span><span class="cp"></span>
<span class="cp">#define BH1770_PS_DATA_LED3	0x91 </span><span class="cm">/* PS data from LED3 */</span><span class="cp"></span>
<span class="cp">#define BH1770_INTERRUPT	0x92 </span><span class="cm">/* Interrupt setting */</span><span class="cp"></span>
<span class="cp">#define BH1770_PS_TH_LED1	0x93 </span><span class="cm">/* PS interrupt threshold for LED1 */</span><span class="cp"></span>
<span class="cp">#define BH1770_PS_TH_LED2	0x94 </span><span class="cm">/* PS interrupt threshold for LED2 */</span><span class="cp"></span>
<span class="cp">#define BH1770_PS_TH_LED3	0x95 </span><span class="cm">/* PS interrupt threshold for LED3 */</span><span class="cp"></span>
<span class="cp">#define BH1770_ALS_TH_UP_0	0x96 </span><span class="cm">/* ALS upper threshold low byte */</span><span class="cp"></span>
<span class="cp">#define BH1770_ALS_TH_UP_1	0x97 </span><span class="cm">/* ALS upper threshold high byte */</span><span class="cp"></span>
<span class="cp">#define BH1770_ALS_TH_LOW_0	0x98 </span><span class="cm">/* ALS lower threshold low byte */</span><span class="cp"></span>
<span class="cp">#define BH1770_ALS_TH_LOW_1	0x99 </span><span class="cm">/* ALS lower threshold high byte */</span><span class="cp"></span>

<span class="cm">/* MANUFACT_ID */</span>
<span class="cp">#define BH1770_MANUFACT_ROHM	0x01</span>
<span class="cp">#define BH1770_MANUFACT_OSRAM	0x03</span>

<span class="cm">/* PART_ID */</span>
<span class="cp">#define BH1770_PART		0x90</span>
<span class="cp">#define BH1770_PART_MASK	0xf0</span>
<span class="cp">#define BH1770_REV_MASK		0x0f</span>
<span class="cp">#define BH1770_REV_SHIFT	0</span>
<span class="cp">#define BH1770_REV_0		0x00</span>
<span class="cp">#define BH1770_REV_1		0x01</span>

<span class="cm">/* Operating modes for both */</span>
<span class="cp">#define BH1770_STANDBY		0x00</span>
<span class="cp">#define BH1770_FORCED		0x02</span>
<span class="cp">#define BH1770_STANDALONE	0x03</span>
<span class="cp">#define BH1770_SWRESET		(0x01 &lt;&lt; 2)</span>

<span class="cp">#define BH1770_PS_TRIG_MEAS	(1 &lt;&lt; 0)</span>
<span class="cp">#define BH1770_ALS_TRIG_MEAS	(1 &lt;&lt; 1)</span>

<span class="cm">/* Interrupt control */</span>
<span class="cp">#define BH1770_INT_OUTPUT_MODE	(1 &lt;&lt; 3) </span><span class="cm">/* 0 = latched */</span><span class="cp"></span>
<span class="cp">#define BH1770_INT_POLARITY	(1 &lt;&lt; 2) </span><span class="cm">/* 1 = active high */</span><span class="cp"></span>
<span class="cp">#define BH1770_INT_ALS_ENA	(1 &lt;&lt; 1)</span>
<span class="cp">#define BH1770_INT_PS_ENA	(1 &lt;&lt; 0)</span>

<span class="cm">/* Interrupt status */</span>
<span class="cp">#define BH1770_INT_LED1_DATA	(1 &lt;&lt; 0)</span>
<span class="cp">#define BH1770_INT_LED1_INT	(1 &lt;&lt; 1)</span>
<span class="cp">#define BH1770_INT_LED2_DATA	(1 &lt;&lt; 2)</span>
<span class="cp">#define BH1770_INT_LED2_INT	(1 &lt;&lt; 3)</span>
<span class="cp">#define BH1770_INT_LED3_DATA	(1 &lt;&lt; 4)</span>
<span class="cp">#define BH1770_INT_LED3_INT	(1 &lt;&lt; 5)</span>
<span class="cp">#define BH1770_INT_LEDS_INT	((1 &lt;&lt; 1) | (1 &lt;&lt; 3) | (1 &lt;&lt; 5))</span>
<span class="cp">#define BH1770_INT_ALS_DATA	(1 &lt;&lt; 6)</span>
<span class="cp">#define BH1770_INT_ALS_INT	(1 &lt;&lt; 7)</span>

<span class="cm">/* Led channels */</span>
<span class="cp">#define BH1770_LED1		0x00</span>

<span class="cp">#define BH1770_DISABLE		0</span>
<span class="cp">#define BH1770_ENABLE		1</span>
<span class="cp">#define BH1770_PROX_CHANNELS	1</span>

<span class="cp">#define BH1770_LUX_DEFAULT_RATE	1 </span><span class="cm">/* Index to lux rate table */</span><span class="cp"></span>
<span class="cp">#define BH1770_PROX_DEFAULT_RATE 1 </span><span class="cm">/* Direct HW value =~ 50Hz */</span><span class="cp"></span>
<span class="cp">#define BH1770_PROX_DEF_RATE_THRESH 6 </span><span class="cm">/* Direct HW value =~ 5 Hz */</span><span class="cp"></span>
<span class="cp">#define BH1770_STARTUP_DELAY	50</span>
<span class="cp">#define BH1770_RESET_TIME	10</span>
<span class="cp">#define BH1770_TIMEOUT		2100 </span><span class="cm">/* Timeout in 2.1 seconds */</span><span class="cp"></span>

<span class="cp">#define BH1770_LUX_RANGE	65535</span>
<span class="cp">#define BH1770_PROX_RANGE	255</span>
<span class="cp">#define BH1770_COEF_SCALER	1024</span>
<span class="cp">#define BH1770_CALIB_SCALER	8192</span>
<span class="cp">#define BH1770_LUX_NEUTRAL_CALIB_VALUE (1 * BH1770_CALIB_SCALER)</span>
<span class="cp">#define BH1770_LUX_DEF_THRES	1000</span>
<span class="cp">#define BH1770_PROX_DEF_THRES	70</span>
<span class="cp">#define BH1770_PROX_DEF_ABS_THRES   100</span>
<span class="cp">#define BH1770_DEFAULT_PERSISTENCE  10</span>
<span class="cp">#define BH1770_PROX_MAX_PERSISTENCE 50</span>
<span class="cp">#define BH1770_LUX_GA_SCALE	16384</span>
<span class="cp">#define BH1770_LUX_CF_SCALE	2048 </span><span class="cm">/* CF ChipFactor */</span><span class="cp"></span>
<span class="cp">#define BH1770_NEUTRAL_CF	BH1770_LUX_CF_SCALE</span>
<span class="cp">#define BH1770_LUX_CORR_SCALE	4096</span>

<span class="cp">#define PROX_ABOVE_THRESHOLD	1</span>
<span class="cp">#define PROX_BELOW_THRESHOLD	0</span>

<span class="cp">#define PROX_IGNORE_LUX_LIMIT	500</span>

<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_platform_data</span>	<span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="kt">char</span>				<span class="n">chipname</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
	<span class="n">u8</span>				<span class="n">revision</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">i2c_client</span>		<span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">regulator_bulk_data</span>	<span class="n">regs</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">mutex</span>			<span class="n">mutex</span><span class="p">;</span> <span class="cm">/* avoid parallel access */</span>
	<span class="n">wait_queue_head_t</span>		<span class="n">wait</span><span class="p">;</span>

	<span class="n">bool</span>			<span class="n">int_mode_prox</span><span class="p">;</span>
	<span class="n">bool</span>			<span class="n">int_mode_lux</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">delayed_work</span>	<span class="n">prox_work</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">lux_cf</span><span class="p">;</span> <span class="cm">/* Chip specific factor */</span>
	<span class="n">u32</span>	<span class="n">lux_ga</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">lux_calib</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">lux_rate_index</span><span class="p">;</span>
	<span class="n">u32</span>	<span class="n">lux_corr</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">lux_data_raw</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">lux_threshold_hi</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">lux_threshold_lo</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">lux_thres_hi_onchip</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">lux_thres_lo_onchip</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">lux_wait_result</span><span class="p">;</span>

	<span class="kt">int</span>	<span class="n">prox_enable_count</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">prox_coef</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">prox_const</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">prox_rate</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">prox_rate_threshold</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">prox_persistence</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">prox_persistence_counter</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">prox_data</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">prox_threshold</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">prox_threshold_hw</span><span class="p">;</span>
	<span class="n">bool</span>	<span class="n">prox_force_update</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">prox_abs_thres</span><span class="p">;</span>
	<span class="n">u8</span>	<span class="n">prox_led</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">reg_vcc</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Vcc&quot;</span><span class="p">;</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">reg_vleds</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;Vleds&quot;</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * Supported stand alone rates in ms from chip data sheet</span>
<span class="cm"> * {10, 20, 30, 40, 70, 100, 200, 500, 1000, 2000};</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">prox_rates_hz</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">100</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">14</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">prox_rates_ms</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">500</span><span class="p">};</span>

<span class="cm">/* Supported IR-led currents in mA */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">u8</span> <span class="n">prox_curr_ma</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">200</span><span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Supported stand alone rates in ms from chip data sheet</span>
<span class="cm"> * {100, 200, 500, 1000, 2000};</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">const</span> <span class="n">s16</span> <span class="n">lux_rates_hz</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * interrupt control functions are called while keeping chip-&gt;mutex</span>
<span class="cm"> * excluding module probe / remove</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bh1770_lux_interrupt_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">lux</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_mode_lux</span> <span class="o">=</span> <span class="n">lux</span><span class="p">;</span>
	<span class="cm">/* Set interrupt modes, interrupt active low, latched */</span>
	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">BH1770_INTERRUPT</span><span class="p">,</span>
					<span class="p">(</span><span class="n">lux</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_mode_prox</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bh1770_prox_interrupt_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					<span class="kt">int</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_mode_prox</span> <span class="o">=</span> <span class="n">ps</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">BH1770_INTERRUPT</span><span class="p">,</span>
					<span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_mode_lux</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">ps</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/* chip-&gt;mutex is always kept here */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_lux_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rate_index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* sysfs may call this when the chip is powered off */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm_runtime_suspended</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Proper proximity response needs fastest lux rate (100ms) */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_enable_count</span><span class="p">)</span>
		<span class="n">rate_index</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">BH1770_ALS_MEAS_RATE</span><span class="p">,</span>
					<span class="n">rate_index</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_prox_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mode</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rate</span><span class="p">;</span>

	<span class="n">rate</span> <span class="o">=</span> <span class="p">(</span><span class="n">mode</span> <span class="o">==</span> <span class="n">PROX_ABOVE_THRESHOLD</span><span class="p">)</span> <span class="o">?</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_rate_threshold</span> <span class="o">:</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_rate</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">BH1770_PS_MEAS_RATE</span><span class="p">,</span>
					<span class="n">rate</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* InfraredLED is controlled by the chip during proximity scanning */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">bh1770_led_cfg</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* LED cfg, current for leds 1 and 2 */</span>
	<span class="k">return</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">BH1770_I_LED</span><span class="p">,</span>
					<span class="p">(</span><span class="n">BH1770_LED1</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">)</span> <span class="o">|</span>
					<span class="p">(</span><span class="n">BH1770_LED_5mA</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">|</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_led</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Following two functions converts raw ps values from HW to normalized</span>
<span class="cm"> * values. Purpose is to compensate differences between different sensor</span>
<span class="cm"> * versions and variants so that result means about the same between</span>
<span class="cm"> * versions.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">bh1770_psraw_to_adjusted</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">psraw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">adjusted</span><span class="p">;</span>
	<span class="n">adjusted</span> <span class="o">=</span> <span class="p">(</span><span class="n">u16</span><span class="p">)(((</span><span class="n">u32</span><span class="p">)(</span><span class="n">psraw</span> <span class="o">+</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_const</span><span class="p">)</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_coef</span><span class="p">)</span> <span class="o">/</span>
		<span class="n">BH1770_COEF_SCALER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adjusted</span> <span class="o">&gt;</span> <span class="n">BH1770_PROX_RANGE</span><span class="p">)</span>
		<span class="n">adjusted</span> <span class="o">=</span> <span class="n">BH1770_PROX_RANGE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">adjusted</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u8</span> <span class="nf">bh1770_psadjusted_to_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="n">ps</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">raw</span><span class="p">;</span>

	<span class="n">raw</span> <span class="o">=</span> <span class="p">(((</span><span class="n">u32</span><span class="p">)</span><span class="n">ps</span> <span class="o">*</span> <span class="n">BH1770_COEF_SCALER</span><span class="p">)</span> <span class="o">/</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_coef</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">raw</span> <span class="o">&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_const</span><span class="p">)</span>
		<span class="n">raw</span> <span class="o">=</span> <span class="n">raw</span> <span class="o">-</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_const</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">raw</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Following two functions converts raw lux values from HW to normalized</span>
<span class="cm"> * values. Purpose is to compensate differences between different sensor</span>
<span class="cm"> * versions and variants so that result means about the same between</span>
<span class="cm"> * versions. Chip-&gt;mutex is kept when this is called.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_prox_set_threshold</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* sysfs may call this when the chip is powered off */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm_runtime_suspended</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">tmp</span> <span class="o">=</span> <span class="n">bh1770_psadjusted_to_raw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_threshold</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_threshold_hw</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">;</span>

	<span class="k">return</span>	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">BH1770_PS_TH_LED1</span><span class="p">,</span>
					<span class="n">tmp</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">bh1770_lux_raw_to_adjusted</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="n">raw</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">lux</span><span class="p">;</span>
	<span class="n">lux</span> <span class="o">=</span> <span class="p">((</span><span class="n">u32</span><span class="p">)</span><span class="n">raw</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_corr</span><span class="p">)</span> <span class="o">/</span> <span class="n">BH1770_LUX_CORR_SCALE</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">min</span><span class="p">(</span><span class="n">lux</span><span class="p">,</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">BH1770_LUX_RANGE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u16</span> <span class="nf">bh1770_lux_adjusted_to_raw</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">adjusted</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">adjusted</span> <span class="o">*</span> <span class="n">BH1770_LUX_CORR_SCALE</span> <span class="o">/</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_corr</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* chip-&gt;mutex is kept when this is called */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_lux_update_thresholds</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					<span class="n">u16</span> <span class="n">threshold_hi</span><span class="p">,</span> <span class="n">u16</span> <span class="n">threshold_lo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* sysfs may call this when the chip is powered off */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm_runtime_suspended</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Compensate threshold values with the correction factors if not</span>
<span class="cm">	 * set to minimum or maximum.</span>
<span class="cm">	 * Min &amp; max values disables interrupts.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">threshold_hi</span> <span class="o">!=</span> <span class="n">BH1770_LUX_RANGE</span> <span class="o">&amp;&amp;</span> <span class="n">threshold_hi</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">threshold_hi</span> <span class="o">=</span> <span class="n">bh1770_lux_adjusted_to_raw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">threshold_hi</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">threshold_lo</span> <span class="o">!=</span> <span class="n">BH1770_LUX_RANGE</span> <span class="o">&amp;&amp;</span> <span class="n">threshold_lo</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">threshold_lo</span> <span class="o">=</span> <span class="n">bh1770_lux_adjusted_to_raw</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">threshold_lo</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_thres_hi_onchip</span> <span class="o">==</span> <span class="n">threshold_hi</span> <span class="o">&amp;&amp;</span>
	    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_thres_lo_onchip</span> <span class="o">==</span> <span class="n">threshold_lo</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_thres_hi_onchip</span> <span class="o">=</span> <span class="n">threshold_hi</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_thres_lo_onchip</span> <span class="o">=</span> <span class="n">threshold_lo</span><span class="p">;</span>

	<span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold_hi</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold_hi</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold_lo</span><span class="p">;</span>
	<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold_lo</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_i2c_block_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">BH1770_ALS_TH_UP_0</span><span class="p">,</span>
					<span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">data</span><span class="p">),</span>
					<span class="n">data</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_lux_get_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u16</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">BH1770_ALS_DATA_0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">data</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">BH1770_ALS_DATA_1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_data_raw</span> <span class="o">=</span> <span class="n">data</span> <span class="o">|</span> <span class="p">((</span><span class="n">ret</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Calculate correction value which contains chip and device specific parts */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="nf">bh1770_get_corr_value</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="cm">/* Impact of glass attenuation correction */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">BH1770_LUX_CORR_SCALE</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_ga</span><span class="p">)</span> <span class="o">/</span> <span class="n">BH1770_LUX_GA_SCALE</span><span class="p">;</span>
	<span class="cm">/* Impact of chip factor correction */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_cf</span><span class="p">)</span> <span class="o">/</span> <span class="n">BH1770_LUX_CF_SCALE</span><span class="p">;</span>
	<span class="cm">/* Impact of Device specific calibration correction */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">*</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_calib</span><span class="p">)</span> <span class="o">/</span> <span class="n">BH1770_CALIB_SCALER</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_lux_read_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">bh1770_lux_get_result</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">bh1770_lux_raw_to_adjusted</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_data_raw</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Chip on / off functions are called while keeping mutex except probe</span>
<span class="cm"> * or remove phase</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_chip_on</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">regulator_bulk_enable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">),</span>
					<span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">usleep_range</span><span class="p">(</span><span class="n">BH1770_STARTUP_DELAY</span><span class="p">,</span> <span class="n">BH1770_STARTUP_DELAY</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/* Reset the chip */</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">BH1770_ALS_CONTROL</span><span class="p">,</span>
				<span class="n">BH1770_SWRESET</span><span class="p">);</span>
	<span class="n">usleep_range</span><span class="p">(</span><span class="n">BH1770_RESET_TIME</span><span class="p">,</span> <span class="n">BH1770_RESET_TIME</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * ALS is started always since proximity needs als results</span>
<span class="cm">	 * for realibility estimation.</span>
<span class="cm">	 * Let&#39;s assume dark until the first ALS measurement is ready.</span>
<span class="cm">	 */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_data_raw</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">BH1770_ALS_CONTROL</span><span class="p">,</span> <span class="n">BH1770_STANDALONE</span><span class="p">);</span>

	<span class="cm">/* Assume reset defaults */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_thres_hi_onchip</span> <span class="o">=</span> <span class="n">BH1770_LUX_RANGE</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_thres_lo_onchip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bh1770_chip_off</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">BH1770_INTERRUPT</span><span class="p">,</span> <span class="n">BH1770_DISABLE</span><span class="p">);</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
				<span class="n">BH1770_ALS_CONTROL</span><span class="p">,</span> <span class="n">BH1770_STANDBY</span><span class="p">);</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
				<span class="n">BH1770_PS_CONTROL</span><span class="p">,</span> <span class="n">BH1770_STANDBY</span><span class="p">);</span>
	<span class="n">regulator_bulk_disable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">),</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* chip-&gt;mutex is kept when this is called */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_prox_mode_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_enable_count</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_force_update</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span> <span class="cm">/* Force immediate update */</span>

		<span class="n">bh1770_lux_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_rate_index</span><span class="p">);</span>
		<span class="n">bh1770_prox_set_threshold</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">bh1770_led_cfg</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="n">bh1770_prox_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">PROX_BELOW_THRESHOLD</span><span class="p">);</span>
		<span class="n">bh1770_prox_interrupt_control</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BH1770_ENABLE</span><span class="p">);</span>
		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">BH1770_PS_CONTROL</span><span class="p">,</span> <span class="n">BH1770_STANDALONE</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">bh1770_lux_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_rate_index</span><span class="p">);</span>
		<span class="n">bh1770_prox_interrupt_control</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BH1770_DISABLE</span><span class="p">);</span>
		<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span>
					<span class="n">BH1770_PS_CONTROL</span><span class="p">,</span> <span class="n">BH1770_STANDBY</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* chip-&gt;mutex is kept when this is called */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_prox_read_result</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">above</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">mode</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">BH1770_PS_DATA_LED1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_threshold_hw</span><span class="p">)</span>
		<span class="n">above</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">above</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * when ALS levels goes above limit, proximity result may be</span>
<span class="cm">	 * false proximity. Thus ignore the result. With real proximity</span>
<span class="cm">	 * there is a shadow causing low als levels.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_data_raw</span> <span class="o">&gt;</span> <span class="n">PROX_IGNORE_LUX_LIMIT</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_data</span> <span class="o">=</span> <span class="n">bh1770_psraw_to_adjusted</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="cm">/* Strong proximity level or force mode requires immediate response */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_data</span> <span class="o">&gt;=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_abs_thres</span> <span class="o">||</span>
	    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_force_update</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_persistence_counter</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_persistence</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_force_update</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="cm">/* Persistence filttering to reduce false proximity events */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">likely</span><span class="p">(</span><span class="n">above</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_persistence_counter</span> <span class="o">&lt;</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_persistence</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_persistence_counter</span><span class="o">++</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">mode</span> <span class="o">=</span> <span class="n">PROX_ABOVE_THRESHOLD</span><span class="p">;</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_persistence_counter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">mode</span> <span class="o">=</span> <span class="n">PROX_BELOW_THRESHOLD</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Set proximity detection rate based on above or below value */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bh1770_prox_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mode</span><span class="p">);</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;prox0_raw&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_detect</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">ret</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">manu</span><span class="p">,</span> <span class="n">part</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">BH1770_MANUFACT_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">manu</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">BH1770_PART_ID</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">error</span><span class="p">;</span>
	<span class="n">part</span> <span class="o">=</span> <span class="p">(</span><span class="n">u8</span><span class="p">)</span><span class="n">ret</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span> <span class="o">=</span> <span class="p">(</span><span class="n">part</span> <span class="o">&amp;</span> <span class="n">BH1770_REV_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="n">BH1770_REV_SHIFT</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_coef</span> <span class="o">=</span> <span class="n">BH1770_COEF_SCALER</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_const</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_cf</span> <span class="o">=</span> <span class="n">BH1770_NEUTRAL_CF</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">manu</span> <span class="o">==</span> <span class="n">BH1770_MANUFACT_ROHM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">part</span> <span class="o">&amp;</span> <span class="n">BH1770_PART_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">BH1770_PART</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipname</span><span class="p">),</span> <span class="s">&quot;BH1770GLC&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">manu</span> <span class="o">==</span> <span class="n">BH1770_MANUFACT_OSRAM</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">((</span><span class="n">part</span> <span class="o">&amp;</span> <span class="n">BH1770_PART_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">BH1770_PART</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">snprintf</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipname</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipname</span><span class="p">),</span> <span class="s">&quot;SFH7770&quot;</span><span class="p">);</span>
		<span class="cm">/* Values selected by comparing different versions */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_coef</span> <span class="o">=</span> <span class="mi">819</span><span class="p">;</span> <span class="cm">/* 0.8 * BH1770_COEF_SCALER */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_const</span> <span class="o">=</span> <span class="mi">40</span><span class="p">;</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="nl">error:</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;BH1770 or SFH7770 not found</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This work is re-scheduled at every proximity interrupt.</span>
<span class="cm"> * If this work is running, it means that there hasn&#39;t been any</span>
<span class="cm"> * proximity interrupt in time. Situation is handled as no-proximity.</span>
<span class="cm"> * It would be nice to have low-threshold interrupt or interrupt</span>
<span class="cm"> * when measurement and hi-threshold are both 0. But neither of those exists.</span>
<span class="cm"> * This is a workaroud for missing HW feature.</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">bh1770_prox_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bh1770_chip</span><span class="p">,</span> <span class="n">prox_work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">bh1770_prox_read_result</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* This is threaded irq handler */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">bh1770_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rate</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">BH1770_ALS_PS_STATUS</span><span class="p">);</span>

	<span class="cm">/* Acknowledge interrupt by reading this register */</span>
	<span class="n">i2c_smbus_read_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">BH1770_INTERRUPT</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Check if there is fresh data available for als.</span>
<span class="cm">	 * If this is the very first data, update thresholds after that.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BH1770_INT_ALS_DATA</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">bh1770_lux_get_result</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_wait_result</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_wait_result</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
			<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
			<span class="n">bh1770_lux_update_thresholds</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
						<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_threshold_hi</span><span class="p">,</span>
						<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_threshold_lo</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Disable interrupt logic to guarantee acknowledgement */</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">BH1770_INTERRUPT</span><span class="p">,</span>
				  <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BH1770_INT_ALS_INT</span><span class="p">))</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;lux0_input&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_mode_prox</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">BH1770_INT_LEDS_INT</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">rate</span> <span class="o">=</span> <span class="n">prox_rates_ms</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_rate_threshold</span><span class="p">];</span>
		<span class="n">bh1770_prox_read_result</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Re-enable interrupt logic */</span>
	<span class="n">i2c_smbus_write_byte_data</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="n">BH1770_INTERRUPT</span><span class="p">,</span>
				  <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_mode_lux</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">|</span>
				  <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_mode_prox</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Can&#39;t cancel work while keeping mutex since the work uses the</span>
<span class="cm">	 * same mutex.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rate</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Simulate missing no-proximity interrupt 50ms after the</span>
<span class="cm">		 * next expected interrupt time.</span>
<span class="cm">		 */</span>
		<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_work</span><span class="p">);</span>
		<span class="n">schedule_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_work</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">rate</span> <span class="o">+</span> <span class="mi">50</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_power_state_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">bh1770_lux_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_rate_index</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">bh1770_lux_interrupt_control</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BH1770_ENABLE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* This causes interrupt after the next measurement cycle */</span>
		<span class="n">bh1770_lux_update_thresholds</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BH1770_LUX_DEF_THRES</span><span class="p">,</span>
					<span class="n">BH1770_LUX_DEF_THRES</span><span class="p">);</span>
		<span class="cm">/* Inform that we are waiting for a result from ALS */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_wait_result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">bh1770_prox_mode_control</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm_runtime_suspended</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
<span class="nl">leave:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_power_state_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">!</span><span class="n">pm_runtime_suspended</span><span class="p">(</span><span class="n">dev</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_lux_result_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pm_runtime_suspended</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span> <span class="cm">/* Chip is not enabled at all */</span>

	<span class="n">timeout</span> <span class="o">=</span> <span class="n">wait_event_interruptible_timeout</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
					<span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_wait_result</span><span class="p">,</span>
					<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">BH1770_TIMEOUT</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">timeout</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bh1770_lux_read_result</span><span class="p">(</span><span class="n">chip</span><span class="p">));</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_lux_range_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BH1770_LUX_RANGE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_prox_enable_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="cm">/* Assume no proximity. Sensor will tell real state soon */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_enable_count</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_enable_count</span><span class="o">++</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_enable_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_enable_count</span><span class="o">--</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="k">goto</span> <span class="n">leave</span><span class="p">;</span>

	<span class="cm">/* Run control only when chip is powered on */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm_runtime_suspended</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">bh1770_prox_mode_control</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="nl">leave:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_prox_enable_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_enable_count</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_prox_result_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_enable_count</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">pm_runtime_suspended</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_prox_range_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BH1770_PROX_RANGE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_get_prox_rate_avail</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">prox_rates_hz</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">prox_rates_hz</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_get_prox_rate_above</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prox_rates_hz</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_rate_threshold</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_get_prox_rate_below</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">prox_rates_hz</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_rate</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_prox_rate_validate</span><span class="p">(</span><span class="kt">int</span> <span class="n">rate</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">prox_rates_hz</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate</span> <span class="o">&gt;=</span> <span class="n">prox_rates_hz</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_set_prox_rate_above</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_rate_threshold</span> <span class="o">=</span> <span class="n">bh1770_prox_rate_validate</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_set_prox_rate_below</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
					<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_rate</span> <span class="o">=</span> <span class="n">bh1770_prox_rate_validate</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_get_prox_thres</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_threshold</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_set_prox_thres</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">BH1770_PROX_RANGE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_threshold</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bh1770_prox_set_threshold</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_prox_persistence_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_persistence</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_prox_persistence_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">BH1770_PROX_MAX_PERSISTENCE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_persistence</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_prox_abs_thres_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_abs_thres</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_prox_abs_thres_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="n">BH1770_PROX_RANGE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_abs_thres</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_chip_id_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s rev %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">chipname</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">revision</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_lux_calib_default_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">BH1770_CALIB_SCALER</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_lux_calib_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">len</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%u</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_calib</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_lux_calib_store</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">old_calib</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">new_corr</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">old_calib</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_calib</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_calib</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">new_corr</span> <span class="o">=</span> <span class="n">bh1770_get_corr_value</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_corr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_calib</span> <span class="o">=</span> <span class="n">old_calib</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_corr</span> <span class="o">=</span> <span class="n">new_corr</span><span class="p">;</span>
	<span class="cm">/* Refresh thresholds on HW after changing correction value */</span>
	<span class="n">bh1770_lux_update_thresholds</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_threshold_hi</span><span class="p">,</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_threshold_lo</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_get_lux_rate_avail</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pos</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lux_rates_hz</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pos</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span><span class="p">,</span> <span class="s">&quot;%d &quot;</span><span class="p">,</span> <span class="n">lux_rates_hz</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span> <span class="o">+</span> <span class="n">pos</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">pos</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_get_lux_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lux_rates_hz</span><span class="p">[</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_rate_index</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_set_lux_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				      <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				      <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">rate_hz</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rate_hz</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">lux_rates_hz</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rate_hz</span> <span class="o">&gt;=</span> <span class="n">lux_rates_hz</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_rate_index</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">bh1770_lux_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_get_lux_thresh_above</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_threshold_hi</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_get_lux_thresh_below</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_threshold_lo</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_set_lux_thresh</span><span class="p">(</span><span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u16</span> <span class="o">*</span><span class="n">target</span><span class="p">,</span>
				<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">thresh</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">strict_strtoul</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">thresh</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">thresh</span> <span class="o">&gt;</span> <span class="n">BH1770_LUX_RANGE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="o">*</span><span class="n">target</span> <span class="o">=</span> <span class="n">thresh</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Don&#39;t update values in HW if we are still waiting for</span>
<span class="cm">	 * first interrupt to come after device handle open call.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_wait_result</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">bh1770_lux_update_thresholds</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
						<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_threshold_hi</span><span class="p">,</span>
						<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_threshold_lo</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_set_lux_thresh_above</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bh1770_set_lux_thresh</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_threshold_hi</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">bh1770_set_lux_thresh_below</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>  <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">bh1770_set_lux_thresh</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_threshold_lo</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">prox0_raw_en</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">bh1770_prox_enable_show</span><span class="p">,</span>
						<span class="n">bh1770_prox_enable_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">prox0_thresh_above1_value</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
						<span class="n">bh1770_prox_abs_thres_show</span><span class="p">,</span>
						<span class="n">bh1770_prox_abs_thres_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">prox0_thresh_above0_value</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
						<span class="n">bh1770_get_prox_thres</span><span class="p">,</span>
						<span class="n">bh1770_set_prox_thres</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">prox0_raw</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bh1770_prox_result_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">prox0_sensor_range</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bh1770_prox_range_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">prox0_thresh_above_count</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
						<span class="n">bh1770_prox_persistence_show</span><span class="p">,</span>
						<span class="n">bh1770_prox_persistence_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">prox0_rate_above</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
						<span class="n">bh1770_get_prox_rate_above</span><span class="p">,</span>
						<span class="n">bh1770_set_prox_rate_above</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">prox0_rate_below</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
						<span class="n">bh1770_get_prox_rate_below</span><span class="p">,</span>
						<span class="n">bh1770_set_prox_rate_below</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">prox0_rate_avail</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bh1770_get_prox_rate_avail</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">lux0_calibscale</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">bh1770_lux_calib_show</span><span class="p">,</span>
						<span class="n">bh1770_lux_calib_store</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">lux0_calibscale_default</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span>
						<span class="n">bh1770_lux_calib_default_show</span><span class="p">,</span>
						<span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">lux0_input</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bh1770_lux_result_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">lux0_sensor_range</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bh1770_lux_range_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">lux0_rate</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">bh1770_get_lux_rate</span><span class="p">,</span>
						<span class="n">bh1770_set_lux_rate</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">lux0_rate_avail</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bh1770_get_lux_rate_avail</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">lux0_thresh_above_value</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
						<span class="n">bh1770_get_lux_thresh_above</span><span class="p">,</span>
						<span class="n">bh1770_set_lux_thresh_above</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">lux0_thresh_below_value</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
						<span class="n">bh1770_get_lux_thresh_below</span><span class="p">,</span>
						<span class="n">bh1770_set_lux_thresh_below</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">chip_id</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">bh1770_chip_id_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">power_state</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">bh1770_power_state_show</span><span class="p">,</span>
						 <span class="n">bh1770_power_state_store</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">sysfs_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">dev_attr_lux0_calibscale</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_lux0_calibscale_default</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_lux0_input</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_lux0_sensor_range</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_lux0_rate</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_lux0_rate_avail</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_lux0_thresh_above_value</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_lux0_thresh_below_value</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_prox0_raw</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_prox0_sensor_range</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_prox0_raw_en</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_prox0_thresh_above_count</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_prox0_rate_above</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_prox0_rate_below</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_prox0_rate_avail</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_prox0_thresh_above0_value</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_prox0_thresh_above1_value</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_chip_id</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">dev_attr_power_state</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">bh1770_attribute_group</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">sysfs_attrs</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">bh1770_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				<span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">i2c_set_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span>  <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">mutex</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_work</span><span class="p">,</span> <span class="n">bh1770_prox_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;platform data is mandatory</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span>		<span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_calib</span>		<span class="o">=</span> <span class="n">BH1770_LUX_NEUTRAL_CALIB_VALUE</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_rate_index</span>	<span class="o">=</span> <span class="n">BH1770_LUX_DEFAULT_RATE</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_threshold_lo</span>	<span class="o">=</span> <span class="n">BH1770_LUX_DEF_THRES</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_threshold_hi</span>	<span class="o">=</span> <span class="n">BH1770_LUX_DEF_THRES</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">glass_attenuation</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_ga</span> <span class="o">=</span> <span class="n">BH1770_NEUTRAL_GA</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_ga</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">glass_attenuation</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_threshold</span>	<span class="o">=</span> <span class="n">BH1770_PROX_DEF_THRES</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_led</span>		<span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">led_def_curr</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_abs_thres</span>	<span class="o">=</span> <span class="n">BH1770_PROX_DEF_ABS_THRES</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_persistence</span>	<span class="o">=</span> <span class="n">BH1770_DEFAULT_PERSISTENCE</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_rate_threshold</span> <span class="o">=</span> <span class="n">BH1770_PROX_DEF_RATE_THRESH</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_rate</span>		<span class="o">=</span> <span class="n">BH1770_PROX_DEFAULT_RATE</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_data</span>		<span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">supply</span> <span class="o">=</span> <span class="n">reg_vcc</span><span class="p">;</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">supply</span> <span class="o">=</span> <span class="n">reg_vleds</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">regulator_bulk_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				 <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">),</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot get regulators</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">regulator_bulk_enable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">),</span>
				<span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Cannot enable regulators</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">usleep_range</span><span class="p">(</span><span class="n">BH1770_STARTUP_DELAY</span><span class="p">,</span> <span class="n">BH1770_STARTUP_DELAY</span> <span class="o">*</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">bh1770_detect</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>

	<span class="cm">/* Start chip */</span>
	<span class="n">bh1770_chip_on</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">pm_runtime_set_active</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_enable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_corr</span> <span class="o">=</span> <span class="n">bh1770_get_corr_value</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_corr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Improper correction values</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup_resources</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">setup_resources</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail3</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">bh1770_attribute_group</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Sysfs registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail4</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Chip needs level triggered interrupt to work. However,</span>
<span class="cm">	 * level triggering doesn&#39;t work always correctly with power</span>
<span class="cm">	 * management. Select both</span>
<span class="cm">	 */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">request_threaded_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span>
				<span class="n">bh1770_irq</span><span class="p">,</span>
				<span class="n">IRQF_TRIGGER_FALLING</span> <span class="o">|</span> <span class="n">IRQF_ONESHOT</span> <span class="o">|</span>
				<span class="n">IRQF_TRIGGER_LOW</span><span class="p">,</span>
				<span class="s">&quot;bh1770&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;could not get IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail5</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">regulator_bulk_disable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">),</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="nl">fail5:</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">bh1770_attribute_group</span><span class="p">);</span>
<span class="nl">fail4:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">release_resources</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">release_resources</span><span class="p">();</span>
<span class="nl">fail3:</span>
	<span class="n">regulator_bulk_disable</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">),</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
<span class="nl">fail2:</span>
	<span class="n">regulator_bulk_free</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">),</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
<span class="nl">fail1:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">bh1770_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">bh1770_attribute_group</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">release_resources</span><span class="p">)</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">release_resources</span><span class="p">();</span>

	<span class="n">cancel_delayed_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">prox_work</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm_runtime_suspended</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">bh1770_chip_off</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="n">pm_runtime_disable</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pm_runtime_set_suspended</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">regulator_bulk_free</span><span class="p">(</span><span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">),</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_client</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">bh1770_chip_off</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_client</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">bh1770_chip_on</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm_runtime_suspended</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * If we were enabled at suspend time, it is expected</span>
<span class="cm">		 * everything works nice and smoothly</span>
<span class="cm">		 */</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">bh1770_lux_rate</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_rate_index</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">|=</span> <span class="n">bh1770_lux_interrupt_control</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BH1770_ENABLE</span><span class="p">);</span>

		<span class="cm">/* This causes interrupt after the next measurement cycle */</span>
		<span class="n">bh1770_lux_update_thresholds</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">BH1770_LUX_DEF_THRES</span><span class="p">,</span>
					<span class="n">BH1770_LUX_DEF_THRES</span><span class="p">);</span>
		<span class="cm">/* Inform that we are waiting for a result from ALS */</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">lux_wait_result</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
		<span class="n">bh1770_prox_mode_control</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>
<span class="cp">#define bh1770_suspend	NULL</span>
<span class="cp">#define bh1770_shutdown NULL</span>
<span class="cp">#define bh1770_resume	NULL</span>
<span class="cp">#endif</span>

<span class="cp">#ifdef CONFIG_PM_RUNTIME</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_client</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">bh1770_chip_off</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">bh1770_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">i2c_client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i2c_client</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">bh1770_chip</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">i2c_get_clientdata</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="n">bh1770_chip_on</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">i2c_device_id</span> <span class="n">bh1770_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span><span class="s">&quot;bh1770glc&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{</span><span class="s">&quot;sfh7770&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
	<span class="p">{}</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">i2c</span><span class="p">,</span> <span class="n">bh1770_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">dev_pm_ops</span> <span class="n">bh1770_pm_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">SET_SYSTEM_SLEEP_PM_OPS</span><span class="p">(</span><span class="n">bh1770_suspend</span><span class="p">,</span> <span class="n">bh1770_resume</span><span class="p">)</span>
	<span class="n">SET_RUNTIME_PM_OPS</span><span class="p">(</span><span class="n">bh1770_runtime_suspend</span><span class="p">,</span> <span class="n">bh1770_runtime_resume</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">i2c_driver</span> <span class="n">bh1770_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>	 <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;bh1770glc&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">pm</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">bh1770_pm_ops</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>	  <span class="o">=</span> <span class="n">bh1770_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>	  <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">bh1770_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">bh1770_id</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_i2c_driver</span><span class="p">(</span><span class="n">bh1770_driver</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;BH1770GLC / SFH7770 combined ALS and proximity sensor&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Samu Onkalo, Nokia Corporation&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL v2&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
