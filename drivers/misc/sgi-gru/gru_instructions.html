<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › misc › sgi-gru › gru_instructions.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>gru_instructions.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Copyright (c) 2008 Silicon Graphics, Inc.  All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU Lesser General Public License as published by</span>
<span class="cm"> *  the Free Software Foundation; either version 2.1 of the License, or</span>
<span class="cm"> *  (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU Lesser General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU Lesser General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA</span>
<span class="cm"> */</span>

<span class="cp">#ifndef __GRU_INSTRUCTIONS_H__</span>
<span class="cp">#define __GRU_INSTRUCTIONS_H__</span>

<span class="k">extern</span> <span class="kt">int</span> <span class="n">gru_check_status_proc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">gru_wait_proc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">);</span>
<span class="k">extern</span> <span class="kt">void</span> <span class="n">gru_wait_abort_proc</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">);</span>



<span class="cm">/*</span>
<span class="cm"> * Architecture dependent functions</span>
<span class="cm"> */</span>

<span class="cp">#if defined(CONFIG_IA64)</span>
<span class="cp">#include &lt;linux/compiler.h&gt;</span>
<span class="cp">#include &lt;asm/intrinsics.h&gt;</span>
<span class="cp">#define __flush_cache(p)		ia64_fc((unsigned long)p)</span>
<span class="cm">/* Use volatile on IA64 to ensure ordering via st4.rel */</span>
<span class="cp">#define gru_ordered_store_ulong(p, v)					\</span>
<span class="cp">		do {							\</span>
<span class="cp">			barrier();					\</span>
<span class="cp">			*((volatile unsigned long *)(p)) = v; </span><span class="cm">/* force st.rel */</span><span class="cp">	\</span>
<span class="cp">		} while (0)</span>
<span class="cp">#elif defined(CONFIG_X86_64)</span>
<span class="cp">#include &lt;asm/cacheflush.h&gt;</span>
<span class="cp">#define __flush_cache(p)		clflush(p)</span>
<span class="cp">#define gru_ordered_store_ulong(p, v)					\</span>
<span class="cp">		do {							\</span>
<span class="cp">			barrier();					\</span>
<span class="cp">			*(unsigned long *)p = v;			\</span>
<span class="cp">		} while (0)</span>
<span class="cp">#else</span>
<span class="cp">#error &quot;Unsupported architecture&quot;</span>
<span class="cp">#endif</span>

<span class="cm">/*</span>
<span class="cm"> * Control block status and exception codes</span>
<span class="cm"> */</span>
<span class="cp">#define CBS_IDLE			0</span>
<span class="cp">#define CBS_EXCEPTION			1</span>
<span class="cp">#define CBS_ACTIVE			2</span>
<span class="cp">#define CBS_CALL_OS			3</span>

<span class="cm">/* CB substatus bitmasks */</span>
<span class="cp">#define CBSS_MSG_QUEUE_MASK		7</span>
<span class="cp">#define CBSS_IMPLICIT_ABORT_ACTIVE_MASK	8</span>

<span class="cm">/* CB substatus message queue values (low 3 bits of substatus) */</span>
<span class="cp">#define CBSS_NO_ERROR			0</span>
<span class="cp">#define CBSS_LB_OVERFLOWED		1</span>
<span class="cp">#define CBSS_QLIMIT_REACHED		2</span>
<span class="cp">#define CBSS_PAGE_OVERFLOW		3</span>
<span class="cp">#define CBSS_AMO_NACKED			4</span>
<span class="cp">#define CBSS_PUT_NACKED			5</span>

<span class="cm">/*</span>
<span class="cm"> * Structure used to fetch exception detail for CBs that terminate with</span>
<span class="cm"> * CBS_EXCEPTION</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">control_block_extended_exc_detail</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">cb</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">opc</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">ecause</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">exopc</span><span class="p">;</span>
	<span class="kt">long</span>		<span class="n">exceptdet0</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">exceptdet1</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">cbrstate</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">cbrexecstatus</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Instruction formats</span>
<span class="cm"> */</span>

<span class="cm">/*</span>
<span class="cm"> * Generic instruction format.</span>
<span class="cm"> * This definition has precise bit field definitions.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">gru_instruction_bits</span> <span class="p">{</span>
    <span class="cm">/* DW 0  - low */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">icmd</span><span class="o">:</span>      <span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">ima</span><span class="o">:</span>	   <span class="mi">3</span><span class="p">;</span>	<span class="cm">/* CB_DelRep, unmapped mode */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">reserved0</span><span class="o">:</span> <span class="mi">4</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">xtype</span><span class="o">:</span>     <span class="mi">3</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">iaa0</span><span class="o">:</span>      <span class="mi">2</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">iaa1</span><span class="o">:</span>      <span class="mi">2</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">reserved1</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">opc</span><span class="o">:</span>       <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* opcode */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">exopc</span><span class="o">:</span>     <span class="mi">8</span><span class="p">;</span>	<span class="cm">/* extended opcode */</span>
    <span class="cm">/* DW 0  - high */</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">idef2</span><span class="o">:</span>    <span class="mi">22</span><span class="p">;</span>	<span class="cm">/* TRi0 */</span>
    <span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">reserved2</span><span class="o">:</span> <span class="mi">2</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">istatus</span><span class="o">:</span>   <span class="mi">2</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">isubstatus</span><span class="o">:</span><span class="mi">4</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">reserved3</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span>		<span class="n">tlb_fault_color</span><span class="o">:</span> <span class="mi">1</span><span class="p">;</span>
    <span class="cm">/* DW 1 */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">idef4</span><span class="p">;</span>		<span class="cm">/* 42 bits: TRi1, BufSize */</span>
    <span class="cm">/* DW 2-6 */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">idef1</span><span class="p">;</span>		<span class="cm">/* BAddr0 */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">idef5</span><span class="p">;</span>		<span class="cm">/* Nelem */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">idef6</span><span class="p">;</span>		<span class="cm">/* Stride, Operand1 */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">idef3</span><span class="p">;</span>		<span class="cm">/* BAddr1, Value, Operand2 */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">reserved4</span><span class="p">;</span>
    <span class="cm">/* DW 7 */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">avalue</span><span class="p">;</span>		 <span class="cm">/* AValue */</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Generic instruction with friendlier names. This format is used</span>
<span class="cm"> * for inline instructions.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="p">{</span>
    <span class="cm">/* DW 0 */</span>
    <span class="k">union</span> <span class="p">{</span>
    	<span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">op64</span><span class="p">;</span>    <span class="cm">/* icmd,xtype,iaa0,ima,opc,tri0 */</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">op32</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">tri0</span><span class="p">;</span>
	<span class="p">};</span>
    <span class="p">};</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">tri1_bufsize</span><span class="p">;</span>		<span class="cm">/* DW 1 */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">baddr0</span><span class="p">;</span>			<span class="cm">/* DW 2 */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">nelem</span><span class="p">;</span>			<span class="cm">/* DW 3 */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">op1_stride</span><span class="p">;</span>		<span class="cm">/* DW 4 */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">op2_value_baddr1</span><span class="p">;</span>	<span class="cm">/* DW 5 */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">reserved0</span><span class="p">;</span>		<span class="cm">/* DW 6 */</span>
    <span class="kt">unsigned</span> <span class="kt">long</span>		<span class="n">avalue</span><span class="p">;</span>			<span class="cm">/* DW 7 */</span>
<span class="p">};</span>

<span class="cm">/* Some shifts and masks for the low 64 bits of a GRU command */</span>
<span class="cp">#define GRU_CB_ICMD_SHFT	0</span>
<span class="cp">#define GRU_CB_ICMD_MASK	0x1</span>
<span class="cp">#define GRU_CB_XTYPE_SHFT	8</span>
<span class="cp">#define GRU_CB_XTYPE_MASK	0x7</span>
<span class="cp">#define GRU_CB_IAA0_SHFT	11</span>
<span class="cp">#define GRU_CB_IAA0_MASK	0x3</span>
<span class="cp">#define GRU_CB_IAA1_SHFT	13</span>
<span class="cp">#define GRU_CB_IAA1_MASK	0x3</span>
<span class="cp">#define GRU_CB_IMA_SHFT		1</span>
<span class="cp">#define GRU_CB_IMA_MASK		0x3</span>
<span class="cp">#define GRU_CB_OPC_SHFT		16</span>
<span class="cp">#define GRU_CB_OPC_MASK		0xff</span>
<span class="cp">#define GRU_CB_EXOPC_SHFT	24</span>
<span class="cp">#define GRU_CB_EXOPC_MASK	0xff</span>
<span class="cp">#define GRU_IDEF2_SHFT		32</span>
<span class="cp">#define GRU_IDEF2_MASK		0x3ffff</span>
<span class="cp">#define GRU_ISTATUS_SHFT	56</span>
<span class="cp">#define GRU_ISTATUS_MASK	0x3</span>

<span class="cm">/* GRU instruction opcodes (opc field) */</span>
<span class="cp">#define OP_NOP		0x00</span>
<span class="cp">#define OP_BCOPY	0x01</span>
<span class="cp">#define OP_VLOAD	0x02</span>
<span class="cp">#define OP_IVLOAD	0x03</span>
<span class="cp">#define OP_VSTORE	0x04</span>
<span class="cp">#define OP_IVSTORE	0x05</span>
<span class="cp">#define OP_VSET		0x06</span>
<span class="cp">#define OP_IVSET	0x07</span>
<span class="cp">#define OP_MESQ		0x08</span>
<span class="cp">#define OP_GAMXR	0x09</span>
<span class="cp">#define OP_GAMIR	0x0a</span>
<span class="cp">#define OP_GAMIRR	0x0b</span>
<span class="cp">#define OP_GAMER	0x0c</span>
<span class="cp">#define OP_GAMERR	0x0d</span>
<span class="cp">#define OP_BSTORE	0x0e</span>
<span class="cp">#define OP_VFLUSH	0x0f</span>


<span class="cm">/* Extended opcodes values (exopc field) */</span>

<span class="cm">/* GAMIR - AMOs with implicit operands */</span>
<span class="cp">#define EOP_IR_FETCH	0x01 </span><span class="cm">/* Plain fetch of memory */</span><span class="cp"></span>
<span class="cp">#define EOP_IR_CLR	0x02 </span><span class="cm">/* Fetch and clear */</span><span class="cp"></span>
<span class="cp">#define EOP_IR_INC	0x05 </span><span class="cm">/* Fetch and increment */</span><span class="cp"></span>
<span class="cp">#define EOP_IR_DEC	0x07 </span><span class="cm">/* Fetch and decrement */</span><span class="cp"></span>
<span class="cp">#define EOP_IR_QCHK1	0x0d </span><span class="cm">/* Queue check, 64 byte msg */</span><span class="cp"></span>
<span class="cp">#define EOP_IR_QCHK2	0x0e </span><span class="cm">/* Queue check, 128 byte msg */</span><span class="cp"></span>

<span class="cm">/* GAMIRR - Registered AMOs with implicit operands */</span>
<span class="cp">#define EOP_IRR_FETCH	0x01 </span><span class="cm">/* Registered fetch of memory */</span><span class="cp"></span>
<span class="cp">#define EOP_IRR_CLR	0x02 </span><span class="cm">/* Registered fetch and clear */</span><span class="cp"></span>
<span class="cp">#define EOP_IRR_INC	0x05 </span><span class="cm">/* Registered fetch and increment */</span><span class="cp"></span>
<span class="cp">#define EOP_IRR_DEC	0x07 </span><span class="cm">/* Registered fetch and decrement */</span><span class="cp"></span>
<span class="cp">#define EOP_IRR_DECZ	0x0f </span><span class="cm">/* Registered fetch and decrement, update on zero*/</span><span class="cp"></span>

<span class="cm">/* GAMER - AMOs with explicit operands */</span>
<span class="cp">#define EOP_ER_SWAP	0x00 </span><span class="cm">/* Exchange argument and memory */</span><span class="cp"></span>
<span class="cp">#define EOP_ER_OR	0x01 </span><span class="cm">/* Logical OR with memory */</span><span class="cp"></span>
<span class="cp">#define EOP_ER_AND	0x02 </span><span class="cm">/* Logical AND with memory */</span><span class="cp"></span>
<span class="cp">#define EOP_ER_XOR	0x03 </span><span class="cm">/* Logical XOR with memory */</span><span class="cp"></span>
<span class="cp">#define EOP_ER_ADD	0x04 </span><span class="cm">/* Add value to memory */</span><span class="cp"></span>
<span class="cp">#define EOP_ER_CSWAP	0x08 </span><span class="cm">/* Compare with operand2, write operand1 if match*/</span><span class="cp"></span>
<span class="cp">#define EOP_ER_CADD	0x0c </span><span class="cm">/* Queue check, operand1*64 byte msg */</span><span class="cp"></span>

<span class="cm">/* GAMERR - Registered AMOs with explicit operands */</span>
<span class="cp">#define EOP_ERR_SWAP	0x00 </span><span class="cm">/* Exchange argument and memory */</span><span class="cp"></span>
<span class="cp">#define EOP_ERR_OR	0x01 </span><span class="cm">/* Logical OR with memory */</span><span class="cp"></span>
<span class="cp">#define EOP_ERR_AND	0x02 </span><span class="cm">/* Logical AND with memory */</span><span class="cp"></span>
<span class="cp">#define EOP_ERR_XOR	0x03 </span><span class="cm">/* Logical XOR with memory */</span><span class="cp"></span>
<span class="cp">#define EOP_ERR_ADD	0x04 </span><span class="cm">/* Add value to memory */</span><span class="cp"></span>
<span class="cp">#define EOP_ERR_CSWAP	0x08 </span><span class="cm">/* Compare with operand2, write operand1 if match*/</span><span class="cp"></span>
<span class="cp">#define EOP_ERR_EPOLL	0x09 </span><span class="cm">/* Poll for equality */</span><span class="cp"></span>
<span class="cp">#define EOP_ERR_NPOLL	0x0a </span><span class="cm">/* Poll for inequality */</span><span class="cp"></span>

<span class="cm">/* GAMXR - SGI Arithmetic unit */</span>
<span class="cp">#define EOP_XR_CSWAP	0x0b </span><span class="cm">/* Masked compare exchange */</span><span class="cp"></span>


<span class="cm">/* Transfer types (xtype field) */</span>
<span class="cp">#define XTYPE_B		0x0	</span><span class="cm">/* byte */</span><span class="cp"></span>
<span class="cp">#define XTYPE_S		0x1	</span><span class="cm">/* short (2-byte) */</span><span class="cp"></span>
<span class="cp">#define XTYPE_W		0x2	</span><span class="cm">/* word (4-byte) */</span><span class="cp"></span>
<span class="cp">#define XTYPE_DW	0x3	</span><span class="cm">/* doubleword (8-byte) */</span><span class="cp"></span>
<span class="cp">#define XTYPE_CL	0x6	</span><span class="cm">/* cacheline (64-byte) */</span><span class="cp"></span>


<span class="cm">/* Instruction access attributes (iaa0, iaa1 fields) */</span>
<span class="cp">#define IAA_RAM		0x0	</span><span class="cm">/* normal cached RAM access */</span><span class="cp"></span>
<span class="cp">#define IAA_NCRAM	0x2	</span><span class="cm">/* noncoherent RAM access */</span><span class="cp"></span>
<span class="cp">#define IAA_MMIO	0x1	</span><span class="cm">/* noncoherent memory-mapped I/O space */</span><span class="cp"></span>
<span class="cp">#define IAA_REGISTER	0x3	</span><span class="cm">/* memory-mapped registers, etc. */</span><span class="cp"></span>


<span class="cm">/* Instruction mode attributes (ima field) */</span>
<span class="cp">#define IMA_MAPPED	0x0	</span><span class="cm">/* Virtual mode  */</span><span class="cp"></span>
<span class="cp">#define IMA_CB_DELAY	0x1	</span><span class="cm">/* hold read responses until status changes */</span><span class="cp"></span>
<span class="cp">#define IMA_UNMAPPED	0x2	</span><span class="cm">/* bypass the TLBs (OS only) */</span><span class="cp"></span>
<span class="cp">#define IMA_INTERRUPT	0x4	</span><span class="cm">/* Interrupt when instruction completes */</span><span class="cp"></span>

<span class="cm">/* CBE ecause bits */</span>
<span class="cp">#define CBE_CAUSE_RI				(1 &lt;&lt; 0)</span>
<span class="cp">#define CBE_CAUSE_INVALID_INSTRUCTION		(1 &lt;&lt; 1)</span>
<span class="cp">#define CBE_CAUSE_UNMAPPED_MODE_FORBIDDEN	(1 &lt;&lt; 2)</span>
<span class="cp">#define CBE_CAUSE_PE_CHECK_DATA_ERROR		(1 &lt;&lt; 3)</span>
<span class="cp">#define CBE_CAUSE_IAA_GAA_MISMATCH		(1 &lt;&lt; 4)</span>
<span class="cp">#define CBE_CAUSE_DATA_SEGMENT_LIMIT_EXCEPTION	(1 &lt;&lt; 5)</span>
<span class="cp">#define CBE_CAUSE_OS_FATAL_TLB_FAULT		(1 &lt;&lt; 6)</span>
<span class="cp">#define CBE_CAUSE_EXECUTION_HW_ERROR		(1 &lt;&lt; 7)</span>
<span class="cp">#define CBE_CAUSE_TLBHW_ERROR			(1 &lt;&lt; 8)</span>
<span class="cp">#define CBE_CAUSE_RA_REQUEST_TIMEOUT		(1 &lt;&lt; 9)</span>
<span class="cp">#define CBE_CAUSE_HA_REQUEST_TIMEOUT		(1 &lt;&lt; 10)</span>
<span class="cp">#define CBE_CAUSE_RA_RESPONSE_FATAL		(1 &lt;&lt; 11)</span>
<span class="cp">#define CBE_CAUSE_RA_RESPONSE_NON_FATAL		(1 &lt;&lt; 12)</span>
<span class="cp">#define CBE_CAUSE_HA_RESPONSE_FATAL		(1 &lt;&lt; 13)</span>
<span class="cp">#define CBE_CAUSE_HA_RESPONSE_NON_FATAL		(1 &lt;&lt; 14)</span>
<span class="cp">#define CBE_CAUSE_ADDRESS_SPACE_DECODE_ERROR	(1 &lt;&lt; 15)</span>
<span class="cp">#define CBE_CAUSE_PROTOCOL_STATE_DATA_ERROR	(1 &lt;&lt; 16)</span>
<span class="cp">#define CBE_CAUSE_RA_RESPONSE_DATA_ERROR	(1 &lt;&lt; 17)</span>
<span class="cp">#define CBE_CAUSE_HA_RESPONSE_DATA_ERROR	(1 &lt;&lt; 18)</span>
<span class="cp">#define CBE_CAUSE_FORCED_ERROR			(1 &lt;&lt; 19)</span>

<span class="cm">/* CBE cbrexecstatus bits */</span>
<span class="cp">#define CBR_EXS_ABORT_OCC_BIT			0</span>
<span class="cp">#define CBR_EXS_INT_OCC_BIT			1</span>
<span class="cp">#define CBR_EXS_PENDING_BIT			2</span>
<span class="cp">#define CBR_EXS_QUEUED_BIT			3</span>
<span class="cp">#define CBR_EXS_TLB_INVAL_BIT			4</span>
<span class="cp">#define CBR_EXS_EXCEPTION_BIT			5</span>
<span class="cp">#define CBR_EXS_CB_INT_PENDING_BIT		6</span>

<span class="cp">#define CBR_EXS_ABORT_OCC			(1 &lt;&lt; CBR_EXS_ABORT_OCC_BIT)</span>
<span class="cp">#define CBR_EXS_INT_OCC				(1 &lt;&lt; CBR_EXS_INT_OCC_BIT)</span>
<span class="cp">#define CBR_EXS_PENDING				(1 &lt;&lt; CBR_EXS_PENDING_BIT)</span>
<span class="cp">#define CBR_EXS_QUEUED				(1 &lt;&lt; CBR_EXS_QUEUED_BIT)</span>
<span class="cp">#define CBR_EXS_TLB_INVAL			(1 &lt;&lt; CBR_EXS_TLB_INVAL_BIT)</span>
<span class="cp">#define CBR_EXS_EXCEPTION			(1 &lt;&lt; CBR_EXS_EXCEPTION_BIT)</span>
<span class="cp">#define CBR_EXS_CB_INT_PENDING			(1 &lt;&lt; CBR_EXS_CB_INT_PENDING_BIT)</span>

<span class="cm">/*</span>
<span class="cm"> * Exceptions are retried for the following cases. If any OTHER bits are set</span>
<span class="cm"> * in ecause, the exception is not retryable.</span>
<span class="cm"> */</span>
<span class="cp">#define EXCEPTION_RETRY_BITS (CBE_CAUSE_EXECUTION_HW_ERROR |		\</span>
<span class="cp">			      CBE_CAUSE_TLBHW_ERROR |			\</span>
<span class="cp">			      CBE_CAUSE_RA_REQUEST_TIMEOUT |		\</span>
<span class="cp">			      CBE_CAUSE_RA_RESPONSE_NON_FATAL |		\</span>
<span class="cp">			      CBE_CAUSE_HA_RESPONSE_NON_FATAL |		\</span>
<span class="cp">			      CBE_CAUSE_RA_RESPONSE_DATA_ERROR |	\</span>
<span class="cp">			      CBE_CAUSE_HA_RESPONSE_DATA_ERROR		\</span>
<span class="cp">			      )</span>

<span class="cm">/* Message queue head structure */</span>
<span class="k">union</span> <span class="n">gru_mesqhead</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span>	<span class="n">val</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">head</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">limit</span><span class="p">;</span>
	<span class="p">};</span>
<span class="p">};</span>


<span class="cm">/* Generate the low word of a GRU instruction */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span>
<span class="nf">__opdword</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">opcode</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">exopc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xtype</span><span class="p">,</span>
       <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">iaa0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">iaa1</span><span class="p">,</span>
       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">idef2</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ima</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">GRU_CB_ICMD_SHFT</span><span class="p">)</span> <span class="o">|</span>
	   <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">CBS_ACTIVE</span> <span class="o">&lt;&lt;</span> <span class="n">GRU_ISTATUS_SHFT</span><span class="p">)</span> <span class="o">|</span>
	   <span class="p">(</span><span class="n">idef2</span><span class="o">&lt;&lt;</span> <span class="n">GRU_IDEF2_SHFT</span><span class="p">)</span> <span class="o">|</span>
	   <span class="p">(</span><span class="n">iaa0</span> <span class="o">&lt;&lt;</span> <span class="n">GRU_CB_IAA0_SHFT</span><span class="p">)</span> <span class="o">|</span>
	   <span class="p">(</span><span class="n">iaa1</span> <span class="o">&lt;&lt;</span> <span class="n">GRU_CB_IAA1_SHFT</span><span class="p">)</span> <span class="o">|</span>
	   <span class="p">(</span><span class="n">ima</span> <span class="o">&lt;&lt;</span> <span class="n">GRU_CB_IMA_SHFT</span><span class="p">)</span> <span class="o">|</span>
	   <span class="p">(</span><span class="n">xtype</span> <span class="o">&lt;&lt;</span> <span class="n">GRU_CB_XTYPE_SHFT</span><span class="p">)</span> <span class="o">|</span>
	   <span class="p">(</span><span class="n">opcode</span> <span class="o">&lt;&lt;</span> <span class="n">GRU_CB_OPC_SHFT</span><span class="p">)</span> <span class="o">|</span>
	   <span class="p">(</span><span class="n">exopc</span> <span class="o">&lt;&lt;</span> <span class="n">GRU_CB_EXOPC_SHFT</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Architecture specific intrinsics</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_flush_cache</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__flush_cache</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Store the lower 64 bits of the command including the &quot;start&quot; bit. Then</span>
<span class="cm"> * start the instruction executing.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_start_instruction</span><span class="p">(</span><span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">op64</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gru_ordered_store_ulong</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">op64</span><span class="p">);</span>
	<span class="n">mb</span><span class="p">();</span>
	<span class="n">gru_flush_cache</span><span class="p">(</span><span class="n">ins</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* Convert &quot;hints&quot; to IMA */</span>
<span class="cp">#define CB_IMA(h)		((h) | IMA_UNMAPPED)</span>

<span class="cm">/* Convert data segment cache line index into TRI0 / TRI1 value */</span>
<span class="cp">#define GRU_DINDEX(i)		((i) * GRU_CACHE_LINE_BYTES)</span>

<span class="cm">/* Inline functions for GRU instructions.</span>
<span class="cm"> *     Note:</span>
<span class="cm"> *     	- nelem and stride are in elements</span>
<span class="cm"> *     	- tri0/tri1 is in bytes for the beginning of the data segment.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_vload_phys</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gpa</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tri0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iaa</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">gpa</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">iaa</span> <span class="o">&lt;&lt;</span> <span class="mi">62</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">op1_stride</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_VLOAD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_DW</span><span class="p">,</span> <span class="n">iaa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tri0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_vstore_phys</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">gpa</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tri0</span><span class="p">,</span> <span class="kt">int</span> <span class="n">iaa</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">gpa</span> <span class="o">|</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">iaa</span> <span class="o">&lt;&lt;</span> <span class="mi">62</span><span class="p">);</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">op1_stride</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_VSTORE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_DW</span><span class="p">,</span> <span class="n">iaa</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tri0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_vload</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_addr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tri0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xtype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nelem</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stride</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">mem_addr</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="n">nelem</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">op1_stride</span> <span class="o">=</span> <span class="n">stride</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_VLOAD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span> <span class="n">IAA_RAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">tri0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_vstore</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_addr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tri0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xtype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nelem</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stride</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">mem_addr</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="n">nelem</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">op1_stride</span> <span class="o">=</span> <span class="n">stride</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_VSTORE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span> <span class="n">IAA_RAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">tri0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_ivload</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_addr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tri0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tri1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xtype</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nelem</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">mem_addr</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="n">nelem</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">tri1_bufsize</span> <span class="o">=</span> <span class="n">tri1</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_IVLOAD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span> <span class="n">IAA_RAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">tri0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_ivstore</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_addr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tri0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tri1</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xtype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nelem</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">mem_addr</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="n">nelem</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">tri1_bufsize</span> <span class="o">=</span> <span class="n">tri1</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_IVSTORE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span> <span class="n">IAA_RAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">tri0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_vset</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_addr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xtype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nelem</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stride</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">mem_addr</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">op2_value_baddr1</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="n">nelem</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">op1_stride</span> <span class="o">=</span> <span class="n">stride</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_VSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span> <span class="n">IAA_RAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					 <span class="mi">0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_ivset</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_addr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tri1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">value</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xtype</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nelem</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">mem_addr</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">op2_value_baddr1</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="n">nelem</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">tri1_bufsize</span> <span class="o">=</span> <span class="n">tri1</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_IVSET</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span> <span class="n">IAA_RAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_vflush</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">mem_addr</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nelem</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">xtype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">stride</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">mem_addr</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">op1_stride</span> <span class="o">=</span> <span class="n">stride</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="n">nelem</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_VFLUSH</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span> <span class="n">IAA_RAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_nop</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_NOP</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_bcopy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dest</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tri0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xtype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nelem</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">bufsize</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">src</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">op2_value_baddr1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">dest</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="n">nelem</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">tri1_bufsize</span> <span class="o">=</span> <span class="n">bufsize</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_BCOPY</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span> <span class="n">IAA_RAM</span><span class="p">,</span>
					<span class="n">IAA_RAM</span><span class="p">,</span> <span class="n">tri0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_bstore</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dest</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tri0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xtype</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nelem</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">src</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">op2_value_baddr1</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">dest</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="n">nelem</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_BSTORE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">IAA_RAM</span><span class="p">,</span>
					<span class="n">tri0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_gamir</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exopc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xtype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">src</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_GAMIR</span><span class="p">,</span> <span class="n">exopc</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span> <span class="n">IAA_RAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_gamirr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exopc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xtype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">src</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_GAMIRR</span><span class="p">,</span> <span class="n">exopc</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span> <span class="n">IAA_RAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_gamer</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exopc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xtype</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">operand1</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">operand2</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">src</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">op1_stride</span> <span class="o">=</span> <span class="n">operand1</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">op2_value_baddr1</span> <span class="o">=</span> <span class="n">operand2</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_GAMER</span><span class="p">,</span> <span class="n">exopc</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span> <span class="n">IAA_RAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_gamerr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">exopc</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">xtype</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">operand1</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">operand2</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">src</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">op1_stride</span> <span class="o">=</span> <span class="n">operand1</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">op2_value_baddr1</span> <span class="o">=</span> <span class="n">operand2</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_GAMERR</span><span class="p">,</span> <span class="n">exopc</span><span class="p">,</span> <span class="n">xtype</span><span class="p">,</span> <span class="n">IAA_RAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="mi">0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_gamxr</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">src</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tri0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">src</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_GAMXR</span><span class="p">,</span> <span class="n">EOP_XR_CSWAP</span><span class="p">,</span> <span class="n">XTYPE_DW</span><span class="p">,</span>
				 <span class="n">IAA_RAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_mesq</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">queue</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">tri0</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">nelem</span><span class="p">,</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">hints</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">baddr0</span> <span class="o">=</span> <span class="p">(</span><span class="kt">long</span><span class="p">)</span><span class="n">queue</span><span class="p">;</span>
	<span class="n">ins</span><span class="o">-&gt;</span><span class="n">nelem</span> <span class="o">=</span> <span class="n">nelem</span><span class="p">;</span>
	<span class="n">gru_start_instruction</span><span class="p">(</span><span class="n">ins</span><span class="p">,</span> <span class="n">__opdword</span><span class="p">(</span><span class="n">OP_MESQ</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">XTYPE_CL</span><span class="p">,</span> <span class="n">IAA_RAM</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
					<span class="n">tri0</span><span class="p">,</span> <span class="n">CB_IMA</span><span class="p">(</span><span class="n">hints</span><span class="p">)));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">gru_get_amo_value</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">avalue</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gru_get_amo_value_head</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">avalue</span> <span class="o">&amp;</span> <span class="mh">0xffffffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gru_get_amo_value_limit</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_instruction</span> <span class="o">*</span><span class="n">ins</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ins</span><span class="o">-&gt;</span><span class="n">avalue</span> <span class="o">&gt;&gt;</span> <span class="mi">32</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="k">union</span> <span class="n">gru_mesqhead</span>  <span class="nf">gru_mesq_head</span><span class="p">(</span><span class="kt">int</span> <span class="n">head</span><span class="p">,</span> <span class="kt">int</span> <span class="n">limit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">gru_mesqhead</span> <span class="n">mqh</span><span class="p">;</span>

	<span class="n">mqh</span><span class="p">.</span><span class="n">head</span> <span class="o">=</span> <span class="n">head</span><span class="p">;</span>
	<span class="n">mqh</span><span class="p">.</span><span class="n">limit</span> <span class="o">=</span> <span class="n">limit</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">mqh</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get struct control_block_extended_exc_detail for CB.</span>
<span class="cm"> */</span>
<span class="k">extern</span> <span class="kt">int</span> <span class="n">gru_get_cb_exception_detail</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">,</span>
		       <span class="k">struct</span> <span class="n">control_block_extended_exc_detail</span> <span class="o">*</span><span class="n">excdet</span><span class="p">);</span>

<span class="cp">#define GRU_EXC_STR_SIZE		256</span>


<span class="cm">/*</span>
<span class="cm"> * Control block definition for checking status</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">gru_control_block_status</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">icmd</span>		<span class="o">:</span><span class="mi">1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">ima</span>		<span class="o">:</span><span class="mi">3</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">reserved0</span>	<span class="o">:</span><span class="mi">4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">unused1</span>		<span class="o">:</span><span class="mi">24</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">unused2</span>		<span class="o">:</span><span class="mi">24</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">istatus</span>		<span class="o">:</span><span class="mi">2</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">isubstatus</span>	<span class="o">:</span><span class="mi">4</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">unused3</span>		<span class="o">:</span><span class="mi">2</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Get CB status */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gru_get_cb_status</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_control_block_status</span> <span class="o">*</span><span class="n">cbs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cbs</span><span class="o">-&gt;</span><span class="n">istatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get CB message queue substatus */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gru_get_cb_message_queue_substatus</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_control_block_status</span> <span class="o">*</span><span class="n">cbs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cbs</span><span class="o">-&gt;</span><span class="n">isubstatus</span> <span class="o">&amp;</span> <span class="n">CBSS_MSG_QUEUE_MASK</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Get CB substatus */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gru_get_cb_substatus</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_control_block_status</span> <span class="o">*</span><span class="n">cbs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">cbs</span><span class="o">-&gt;</span><span class="n">isubstatus</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * User interface to check an instruction status. UPM and exceptions</span>
<span class="cm"> * are handled automatically. However, this function does NOT wait</span>
<span class="cm"> * for an active instruction to complete.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gru_check_status</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">gru_control_block_status</span> <span class="o">*</span><span class="n">cbs</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">cb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cbs</span><span class="o">-&gt;</span><span class="n">istatus</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="n">CBS_ACTIVE</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">gru_check_status_proc</span><span class="p">(</span><span class="n">cb</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * User interface (via inline function) to wait for an instruction</span>
<span class="cm"> * to complete. Completion status (IDLE or EXCEPTION is returned</span>
<span class="cm"> * to the user. Exception due to hardware errors are automatically</span>
<span class="cm"> * retried before returning an exception.</span>
<span class="cm"> *</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gru_wait</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gru_wait_proc</span><span class="p">(</span><span class="n">cb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Wait for CB to complete. Aborts program if error. (Note: error does NOT</span>
<span class="cm"> * mean TLB mis - only fatal errors such as memory parity error or user</span>
<span class="cm"> * bugs will cause termination.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">gru_wait_abort</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">cb</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">gru_wait_abort_proc</span><span class="p">(</span><span class="n">cb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get a pointer to the start of a gseg</span>
<span class="cm"> * 	p	- Any valid pointer within the gseg</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">gru_get_gseg_pointer</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">p</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">GRU_GSEG_PAGESIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get a pointer to a control block</span>
<span class="cm"> * 	gseg	- GSeg address returned from gru_get_thread_gru_segment()</span>
<span class="cm"> * 	index	- index of desired CB</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">gru_get_cb_pointer</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">gseg</span><span class="p">,</span>
						      <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gseg</span> <span class="o">+</span> <span class="n">GRU_CB_BASE</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="n">GRU_HANDLE_STRIDE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Get a pointer to a cacheline in the data segment portion of a GSeg</span>
<span class="cm"> * 	gseg	- GSeg address returned from gru_get_thread_gru_segment()</span>
<span class="cm"> * 	index	- index of desired cache line</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="o">*</span><span class="nf">gru_get_data_pointer</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">gseg</span><span class="p">,</span> <span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">gseg</span> <span class="o">+</span> <span class="n">GRU_DS_BASE</span> <span class="o">+</span> <span class="n">index</span> <span class="o">*</span> <span class="n">GRU_CACHE_LINE_BYTES</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Convert a vaddr into the tri index within the GSEG</span>
<span class="cm"> * 	vaddr		- virtual address of within gseg</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">gru_get_tri</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">vaddr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">((</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">vaddr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">GRU_GSEG_PAGESIZE</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="n">GRU_DS_BASE</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif		</span><span class="cm">/* __GRU_INSTRUCTIONS_H__ */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
