<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › misc › pch_phub.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>pch_phub.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Copyright (C) 2011 LAPIS Semiconductor Co., Ltd.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; version 2 of the License.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software</span>
<span class="cm"> * Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/pci.h&gt;</span>
<span class="cp">#include &lt;linux/io.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/if_ether.h&gt;</span>
<span class="cp">#include &lt;linux/ctype.h&gt;</span>
<span class="cp">#include &lt;linux/dmi.h&gt;</span>

<span class="cp">#define PHUB_STATUS 0x00		</span><span class="cm">/* Status Register offset */</span><span class="cp"></span>
<span class="cp">#define PHUB_CONTROL 0x04		</span><span class="cm">/* Control Register offset */</span><span class="cp"></span>
<span class="cp">#define PHUB_TIMEOUT 0x05		</span><span class="cm">/* Time out value for Status Register */</span><span class="cp"></span>
<span class="cp">#define PCH_PHUB_ROM_WRITE_ENABLE 0x01	</span><span class="cm">/* Enabling for writing ROM */</span><span class="cp"></span>
<span class="cp">#define PCH_PHUB_ROM_WRITE_DISABLE 0x00	</span><span class="cm">/* Disabling for writing ROM */</span><span class="cp"></span>
<span class="cp">#define PCH_PHUB_MAC_START_ADDR_EG20T 0x14  </span><span class="cm">/* MAC data area start address</span>
<span class="cm">					       offset */</span><span class="cp"></span>
<span class="cp">#define PCH_PHUB_MAC_START_ADDR_ML7223 0x20C  </span><span class="cm">/* MAC data area start address</span>
<span class="cm">						 offset */</span><span class="cp"></span>
<span class="cp">#define PCH_PHUB_ROM_START_ADDR_EG20T 0x80 </span><span class="cm">/* ROM data area start address offset</span>
<span class="cm">					      (Intel EG20T PCH)*/</span><span class="cp"></span>
<span class="cp">#define PCH_PHUB_ROM_START_ADDR_ML7213 0x400 </span><span class="cm">/* ROM data area start address</span>
<span class="cm">						offset(LAPIS Semicon ML7213)</span>
<span class="cm">					      */</span><span class="cp"></span>
<span class="cp">#define PCH_PHUB_ROM_START_ADDR_ML7223 0x400 </span><span class="cm">/* ROM data area start address</span>
<span class="cm">						offset(LAPIS Semicon ML7223)</span>
<span class="cm">					      */</span><span class="cp"></span>

<span class="cm">/* MAX number of INT_REDUCE_CONTROL registers */</span>
<span class="cp">#define MAX_NUM_INT_REDUCE_CONTROL_REG 128</span>
<span class="cp">#define PCI_DEVICE_ID_PCH1_PHUB 0x8801</span>
<span class="cp">#define PCH_MINOR_NOS 1</span>
<span class="cp">#define CLKCFG_CAN_50MHZ 0x12000000</span>
<span class="cp">#define CLKCFG_CANCLK_MASK 0xFF000000</span>
<span class="cp">#define CLKCFG_UART_MASK			0xFFFFFF</span>

<span class="cm">/* CM-iTC */</span>
<span class="cp">#define CLKCFG_UART_48MHZ			(1 &lt;&lt; 16)</span>
<span class="cp">#define CLKCFG_BAUDDIV				(2 &lt;&lt; 20)</span>
<span class="cp">#define CLKCFG_PLL2VCO				(8 &lt;&lt; 9)</span>
<span class="cp">#define CLKCFG_UARTCLKSEL			(1 &lt;&lt; 18)</span>

<span class="cm">/* Macros for ML7213 */</span>
<span class="cp">#define PCI_VENDOR_ID_ROHM			0x10db</span>
<span class="cp">#define PCI_DEVICE_ID_ROHM_ML7213_PHUB		0x801A</span>

<span class="cm">/* Macros for ML7223 */</span>
<span class="cp">#define PCI_DEVICE_ID_ROHM_ML7223_mPHUB	0x8012 </span><span class="cm">/* for Bus-m */</span><span class="cp"></span>
<span class="cp">#define PCI_DEVICE_ID_ROHM_ML7223_nPHUB	0x8002 </span><span class="cm">/* for Bus-n */</span><span class="cp"></span>

<span class="cm">/* Macros for ML7831 */</span>
<span class="cp">#define PCI_DEVICE_ID_ROHM_ML7831_PHUB 0x8801</span>

<span class="cm">/* SROM ACCESS Macro */</span>
<span class="cp">#define PCH_WORD_ADDR_MASK (~((1 &lt;&lt; 2) - 1))</span>

<span class="cm">/* Registers address offset */</span>
<span class="cp">#define PCH_PHUB_ID_REG				0x0000</span>
<span class="cp">#define PCH_PHUB_QUEUE_PRI_VAL_REG		0x0004</span>
<span class="cp">#define PCH_PHUB_RC_QUEUE_MAXSIZE_REG		0x0008</span>
<span class="cp">#define PCH_PHUB_BRI_QUEUE_MAXSIZE_REG		0x000C</span>
<span class="cp">#define PCH_PHUB_COMP_RESP_TIMEOUT_REG		0x0010</span>
<span class="cp">#define PCH_PHUB_BUS_SLAVE_CONTROL_REG		0x0014</span>
<span class="cp">#define PCH_PHUB_DEADLOCK_AVOID_TYPE_REG	0x0018</span>
<span class="cp">#define PCH_PHUB_INTPIN_REG_WPERMIT_REG0	0x0020</span>
<span class="cp">#define PCH_PHUB_INTPIN_REG_WPERMIT_REG1	0x0024</span>
<span class="cp">#define PCH_PHUB_INTPIN_REG_WPERMIT_REG2	0x0028</span>
<span class="cp">#define PCH_PHUB_INTPIN_REG_WPERMIT_REG3	0x002C</span>
<span class="cp">#define PCH_PHUB_INT_REDUCE_CONTROL_REG_BASE	0x0040</span>
<span class="cp">#define CLKCFG_REG_OFFSET			0x500</span>
<span class="cp">#define FUNCSEL_REG_OFFSET			0x508</span>

<span class="cp">#define PCH_PHUB_OROM_SIZE 15360</span>

<span class="cm">/**</span>
<span class="cm"> * struct pch_phub_reg - PHUB register structure</span>
<span class="cm"> * @phub_id_reg:			PHUB_ID register val</span>
<span class="cm"> * @q_pri_val_reg:			QUEUE_PRI_VAL register val</span>
<span class="cm"> * @rc_q_maxsize_reg:			RC_QUEUE_MAXSIZE register val</span>
<span class="cm"> * @bri_q_maxsize_reg:			BRI_QUEUE_MAXSIZE register val</span>
<span class="cm"> * @comp_resp_timeout_reg:		COMP_RESP_TIMEOUT register val</span>
<span class="cm"> * @bus_slave_control_reg:		BUS_SLAVE_CONTROL_REG register val</span>
<span class="cm"> * @deadlock_avoid_type_reg:		DEADLOCK_AVOID_TYPE register val</span>
<span class="cm"> * @intpin_reg_wpermit_reg0:		INTPIN_REG_WPERMIT register 0 val</span>
<span class="cm"> * @intpin_reg_wpermit_reg1:		INTPIN_REG_WPERMIT register 1 val</span>
<span class="cm"> * @intpin_reg_wpermit_reg2:		INTPIN_REG_WPERMIT register 2 val</span>
<span class="cm"> * @intpin_reg_wpermit_reg3:		INTPIN_REG_WPERMIT register 3 val</span>
<span class="cm"> * @int_reduce_control_reg:		INT_REDUCE_CONTROL registers val</span>
<span class="cm"> * @clkcfg_reg:				CLK CFG register val</span>
<span class="cm"> * @funcsel_reg:			Function select register value</span>
<span class="cm"> * @pch_phub_base_address:		Register base address</span>
<span class="cm"> * @pch_phub_extrom_base_address:	external rom base address</span>
<span class="cm"> * @pch_mac_start_address:		MAC address area start address</span>
<span class="cm"> * @pch_opt_rom_start_address:		Option ROM start address</span>
<span class="cm"> * @ioh_type:				Save IOH type</span>
<span class="cm"> * @pdev:				pointer to pci device struct</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">phub_id_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">q_pri_val_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">rc_q_maxsize_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bri_q_maxsize_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">comp_resp_timeout_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bus_slave_control_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">deadlock_avoid_type_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intpin_reg_wpermit_reg0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intpin_reg_wpermit_reg1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intpin_reg_wpermit_reg2</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">intpin_reg_wpermit_reg3</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">int_reduce_control_reg</span><span class="p">[</span><span class="n">MAX_NUM_INT_REDUCE_CONTROL_REG</span><span class="p">];</span>
	<span class="n">u32</span> <span class="n">clkcfg_reg</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">funcsel_reg</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pch_phub_base_address</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">pch_phub_extrom_base_address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pch_mac_start_address</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">pch_opt_rom_start_address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ioh_type</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* SROM SPEC for MAC address assignment offset */</span>
<span class="k">static</span> <span class="k">const</span> <span class="kt">int</span> <span class="n">pch_phub_mac_offset</span><span class="p">[</span><span class="n">ETH_ALEN</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mh">0x3</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">,</span> <span class="mh">0x1</span><span class="p">,</span> <span class="mh">0x0</span><span class="p">,</span> <span class="mh">0xb</span><span class="p">,</span> <span class="mh">0xa</span><span class="p">};</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">pch_phub_mutex</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pch_phub_read_modify_write_reg() - Reading modifying and writing register</span>
<span class="cm"> * @reg_addr_offset:	Register offset address value.</span>
<span class="cm"> * @data:		Writing value.</span>
<span class="cm"> * @mask:		Mask value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_phub_read_modify_write_reg</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg_addr_offset</span><span class="p">,</span>
					   <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">data</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">reg_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span> <span class="o">+</span> <span class="n">reg_addr_offset</span><span class="p">;</span>
	<span class="n">iowrite32</span><span class="p">(((</span><span class="n">ioread32</span><span class="p">(</span><span class="n">reg_addr</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">))</span> <span class="o">|</span> <span class="n">data</span><span class="p">,</span> <span class="n">reg_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* pch_phub_save_reg_conf - saves register configuration */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_phub_save_reg_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phub_id_reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_ID_REG</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">q_pri_val_reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_QUEUE_PRI_VAL_REG</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rc_q_maxsize_reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_RC_QUEUE_MAXSIZE_REG</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bri_q_maxsize_reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_BRI_QUEUE_MAXSIZE_REG</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">comp_resp_timeout_reg</span> <span class="o">=</span>
				<span class="n">ioread32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_COMP_RESP_TIMEOUT_REG</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bus_slave_control_reg</span> <span class="o">=</span>
				<span class="n">ioread32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_BUS_SLAVE_CONTROL_REG</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">deadlock_avoid_type_reg</span> <span class="o">=</span>
				<span class="n">ioread32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_DEADLOCK_AVOID_TYPE_REG</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg0</span> <span class="o">=</span>
				<span class="n">ioread32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_INTPIN_REG_WPERMIT_REG0</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg1</span> <span class="o">=</span>
				<span class="n">ioread32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_INTPIN_REG_WPERMIT_REG1</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg2</span> <span class="o">=</span>
				<span class="n">ioread32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_INTPIN_REG_WPERMIT_REG2</span><span class="p">);</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg3</span> <span class="o">=</span>
				<span class="n">ioread32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_INTPIN_REG_WPERMIT_REG3</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s : &quot;</span>
		<span class="s">&quot;chip-&gt;phub_id_reg=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;q_pri_val_reg=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;rc_q_maxsize_reg=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;bri_q_maxsize_reg=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;comp_resp_timeout_reg=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;bus_slave_control_reg=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;deadlock_avoid_type_reg=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;intpin_reg_wpermit_reg0=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;intpin_reg_wpermit_reg1=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;intpin_reg_wpermit_reg2=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;intpin_reg_wpermit_reg3=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phub_id_reg</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">q_pri_val_reg</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rc_q_maxsize_reg</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bri_q_maxsize_reg</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">comp_resp_timeout_reg</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bus_slave_control_reg</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">deadlock_avoid_type_reg</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg0</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg1</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg2</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg3</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NUM_INT_REDUCE_CONTROL_REG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reduce_control_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span>
		    <span class="n">ioread32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_INT_REDUCE_CONTROL_REG_BASE</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s : &quot;</span>
			<span class="s">&quot;chip-&gt;int_reduce_control_reg[%d]=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reduce_control_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">clkcfg_reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">CLKCFG_REG_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ioh_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ioh_type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">funcsel_reg</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">p</span> <span class="o">+</span> <span class="n">FUNCSEL_REG_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* pch_phub_restore_reg_conf - restore register configuration */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_phub_restore_reg_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="n">p</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span><span class="p">;</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">phub_id_reg</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_ID_REG</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">q_pri_val_reg</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_QUEUE_PRI_VAL_REG</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">rc_q_maxsize_reg</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_RC_QUEUE_MAXSIZE_REG</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bri_q_maxsize_reg</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_BRI_QUEUE_MAXSIZE_REG</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">comp_resp_timeout_reg</span><span class="p">,</span>
					<span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_COMP_RESP_TIMEOUT_REG</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">bus_slave_control_reg</span><span class="p">,</span>
					<span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_BUS_SLAVE_CONTROL_REG</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">deadlock_avoid_type_reg</span><span class="p">,</span>
					<span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_DEADLOCK_AVOID_TYPE_REG</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg0</span><span class="p">,</span>
					<span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_INTPIN_REG_WPERMIT_REG0</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg1</span><span class="p">,</span>
					<span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_INTPIN_REG_WPERMIT_REG1</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg2</span><span class="p">,</span>
					<span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_INTPIN_REG_WPERMIT_REG2</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg3</span><span class="p">,</span>
					<span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_INTPIN_REG_WPERMIT_REG3</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s : &quot;</span>
		<span class="s">&quot;chip-&gt;phub_id_reg=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;q_pri_val_reg=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;rc_q_maxsize_reg=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;bri_q_maxsize_reg=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;comp_resp_timeout_reg=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;bus_slave_control_reg=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;deadlock_avoid_type_reg=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;intpin_reg_wpermit_reg0=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;intpin_reg_wpermit_reg1=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;intpin_reg_wpermit_reg2=%x, &quot;</span>
		<span class="s">&quot;chip-&gt;intpin_reg_wpermit_reg3=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">phub_id_reg</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">q_pri_val_reg</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">rc_q_maxsize_reg</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bri_q_maxsize_reg</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">comp_resp_timeout_reg</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">bus_slave_control_reg</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">deadlock_avoid_type_reg</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg0</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg1</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg2</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">intpin_reg_wpermit_reg3</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_NUM_INT_REDUCE_CONTROL_REG</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reduce_control_reg</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			<span class="n">p</span> <span class="o">+</span> <span class="n">PCH_PHUB_INT_REDUCE_CONTROL_REG_BASE</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">i</span><span class="p">);</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s : &quot;</span>
			<span class="s">&quot;chip-&gt;int_reduce_control_reg[%d]=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">__func__</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">int_reduce_control_reg</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="p">}</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">clkcfg_reg</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">CLKCFG_REG_OFFSET</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ioh_type</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ioh_type</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">funcsel_reg</span><span class="p">,</span> <span class="n">p</span> <span class="o">+</span> <span class="n">FUNCSEL_REG_OFFSET</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_phub_read_serial_rom() - Reading Serial ROM</span>
<span class="cm"> * @offset_address:	Serial ROM offset address to read.</span>
<span class="cm"> * @data:		Read buffer for specified Serial ROM value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_phub_read_serial_rom</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset_address</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span> <span class="o">+</span>
								<span class="n">offset_address</span><span class="p">;</span>

	<span class="o">*</span><span class="n">data</span> <span class="o">=</span> <span class="n">ioread8</span><span class="p">(</span><span class="n">mem_addr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_phub_write_serial_rom() - Writing Serial ROM</span>
<span class="cm"> * @offset_address:	Serial ROM offset address.</span>
<span class="cm"> * @data:		Serial ROM value to write.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_phub_write_serial_rom</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
				     <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset_address</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">void</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">mem_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span> <span class="o">+</span>
					<span class="p">(</span><span class="n">offset_address</span> <span class="o">&amp;</span> <span class="n">PCH_WORD_ADDR_MASK</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">word_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pos</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">offset_address</span> <span class="o">%</span> <span class="mi">4</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span><span class="p">;</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="o">~</span><span class="p">(</span><span class="mh">0xFF</span> <span class="o">&lt;&lt;</span> <span class="n">pos</span><span class="p">);</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">PCH_PHUB_ROM_WRITE_ENABLE</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span> <span class="o">+</span> <span class="n">PHUB_CONTROL</span><span class="p">);</span>

	<span class="n">word_data</span> <span class="o">=</span> <span class="n">ioread32</span><span class="p">(</span><span class="n">mem_addr</span><span class="p">);</span>
	<span class="n">iowrite32</span><span class="p">((</span><span class="n">word_data</span> <span class="o">&amp;</span> <span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">data</span> <span class="o">&lt;&lt;</span> <span class="n">pos</span><span class="p">,</span> <span class="n">mem_addr</span><span class="p">);</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">ioread8</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span> <span class="o">+</span>
						<span class="n">PHUB_STATUS</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">PHUB_TIMEOUT</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
		<span class="n">i</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">iowrite32</span><span class="p">(</span><span class="n">PCH_PHUB_ROM_WRITE_DISABLE</span><span class="p">,</span>
			<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span> <span class="o">+</span> <span class="n">PHUB_CONTROL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_phub_read_serial_rom_val() - Read Serial ROM value</span>
<span class="cm"> * @offset_address:	Serial ROM address offset value.</span>
<span class="cm"> * @data:		Serial ROM value to read.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_phub_read_serial_rom_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset_address</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mem_addr</span><span class="p">;</span>

	<span class="n">mem_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_mac_start_address</span> <span class="o">+</span>
			<span class="n">pch_phub_mac_offset</span><span class="p">[</span><span class="n">offset_address</span><span class="p">];</span>

	<span class="n">pch_phub_read_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mem_addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_phub_write_serial_rom_val() - writing Serial ROM value</span>
<span class="cm"> * @offset_address:	Serial ROM address offset value.</span>
<span class="cm"> * @data:		Serial ROM value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_phub_write_serial_rom_val</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span>
					 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">offset_address</span><span class="p">,</span> <span class="n">u8</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mem_addr</span><span class="p">;</span>

	<span class="n">mem_addr</span> <span class="o">=</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_mac_start_address</span> <span class="o">+</span>
			<span class="n">pch_phub_mac_offset</span><span class="p">[</span><span class="n">offset_address</span><span class="p">];</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mem_addr</span><span class="p">,</span> <span class="n">data</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* pch_phub_gbe_serial_rom_conf - makes Serial ROM header format configuration</span>
<span class="cm"> * for Gigabit Ethernet MAC address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_phub_gbe_serial_rom_conf</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0b</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0a</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x09</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x08</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0f</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0e</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0d</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0c</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x13</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x12</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x11</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1b</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1a</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x23</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x22</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x21</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x20</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x27</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x26</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x25</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x24</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* pch_phub_gbe_serial_rom_conf_mp - makes SerialROM header format configuration</span>
<span class="cm"> * for Gigabit Ethernet MAC address</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_phub_gbe_serial_rom_conf_mp</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">offset_addr</span><span class="p">;</span>

	<span class="n">offset_addr</span> <span class="o">=</span> <span class="mh">0x200</span><span class="p">;</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x03</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x02</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x01</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x00</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x02</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x07</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x06</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x05</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x04</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x80</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0b</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x0a</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x09</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x08</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x18</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x13</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x12</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x11</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x10</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x19</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1b</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0xbc</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1a</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x19</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x40</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x18</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x3a</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1f</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1e</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1d</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">|=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="mh">0x1c</span> <span class="o">+</span> <span class="n">offset_addr</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_phub_read_gbe_mac_addr() - Read Gigabit Ethernet MAC address</span>
<span class="cm"> * @offset_address:	Gigabit Ethernet MAC address offset value.</span>
<span class="cm"> * @data:		Buffer of the Gigabit Ethernet MAC address value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pch_phub_read_gbe_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pch_phub_read_serial_rom_val</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pch_phub_write_gbe_mac_addr() - Write MAC address</span>
<span class="cm"> * @offset_address:	Gigabit Ethernet MAC address offset value.</span>
<span class="cm"> * @data:		Gigabit Ethernet MAC address value.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_phub_write_gbe_mac_addr</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span><span class="p">,</span> <span class="n">u8</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ioh_type</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">ioh_type</span> <span class="o">==</span> <span class="mi">5</span><span class="p">))</span> <span class="cm">/* EG20T or ML7831*/</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">pch_phub_gbe_serial_rom_conf</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">else</span>	<span class="cm">/* ML7223 */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">pch_phub_gbe_serial_rom_conf_mp</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ETH_ALEN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">pch_phub_write_serial_rom_val</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pch_phub_bin_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
				 <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">rom_signature</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">rom_length</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr_offset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">orom_size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">rom_size</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>
		<span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_phub_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">return_err_nomutex</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Get Rom signature */</span>
	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span> <span class="o">=</span> <span class="n">pci_map_rom</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rom_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">exrom_map_err</span><span class="p">;</span>

	<span class="n">pch_phub_read_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_opt_rom_start_address</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">rom_signature</span><span class="p">);</span>
	<span class="n">rom_signature</span> <span class="o">&amp;=</span> <span class="mh">0xff</span><span class="p">;</span>
	<span class="n">pch_phub_read_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_opt_rom_start_address</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">tmp</span><span class="p">);</span>
	<span class="n">rom_signature</span> <span class="o">|=</span> <span class="p">(</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rom_signature</span> <span class="o">==</span> <span class="mh">0xAA55</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pch_phub_read_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
					 <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_opt_rom_start_address</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">rom_length</span><span class="p">);</span>
		<span class="n">orom_size</span> <span class="o">=</span> <span class="n">rom_length</span> <span class="o">*</span> <span class="mi">512</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orom_size</span> <span class="o">&lt;</span> <span class="n">off</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">return_ok</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">orom_size</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">addr_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">return_ok</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">addr_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addr_offset</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">addr_offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pch_phub_read_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
			    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_opt_rom_start_address</span> <span class="o">+</span> <span class="n">addr_offset</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">buf</span><span class="p">[</span><span class="n">addr_offset</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODATA</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">return_err</span><span class="p">;</span>
	<span class="p">}</span>
<span class="nl">return_ok:</span>
	<span class="n">pci_unmap_rom</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_phub_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">addr_offset</span><span class="p">;</span>

<span class="nl">return_err:</span>
	<span class="n">pci_unmap_rom</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span><span class="p">);</span>
<span class="nl">exrom_map_err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_phub_mutex</span><span class="p">);</span>
<span class="nl">return_err_nomutex:</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pch_phub_bin_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">filp</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobject</span> <span class="o">*</span><span class="n">kobj</span><span class="p">,</span>
				  <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				  <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="n">loff_t</span> <span class="n">off</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">addr_offset</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="kt">ssize_t</span> <span class="n">rom_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span>
		<span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">kobj</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">kobj</span><span class="p">));</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">mutex_lock_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_phub_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">off</span> <span class="o">&gt;</span> <span class="n">PCH_PHUB_OROM_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">return_ok</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="n">PCH_PHUB_OROM_SIZE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">addr_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">return_ok</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span> <span class="o">=</span> <span class="n">pci_map_rom</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rom_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">exrom_map_err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">addr_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">addr_offset</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">addr_offset</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">PCH_PHUB_OROM_SIZE</span> <span class="o">&lt;</span> <span class="n">off</span> <span class="o">+</span> <span class="n">addr_offset</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">return_ok</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">pch_phub_write_serial_rom</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
			    <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_opt_rom_start_address</span> <span class="o">+</span> <span class="n">addr_offset</span> <span class="o">+</span> <span class="n">off</span><span class="p">,</span>
			    <span class="n">buf</span><span class="p">[</span><span class="n">addr_offset</span><span class="p">]);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">ret</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">return_err</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">return_ok:</span>
	<span class="n">pci_unmap_rom</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_phub_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">addr_offset</span><span class="p">;</span>

<span class="nl">return_err:</span>
	<span class="n">pci_unmap_rom</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span><span class="p">);</span>

<span class="nl">exrom_map_err:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_phub_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_pch_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			    <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mac</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">ssize_t</span> <span class="n">rom_size</span><span class="p">;</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span> <span class="o">=</span> <span class="n">pci_map_rom</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rom_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pch_phub_read_gbe_mac_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="n">pci_unmap_rom</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%pM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_pch_mac</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
			     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">mac</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
	<span class="kt">ssize_t</span> <span class="n">rom_size</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">!=</span> <span class="mi">18</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%02x:%02x:%02x:%02x:%02x:%02x&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mac</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mac</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mac</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mac</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
		<span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mac</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="p">(</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mac</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span> <span class="o">=</span> <span class="n">pci_map_rom</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rom_size</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">pch_phub_write_gbe_mac_addr</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span> <span class="n">mac</span><span class="p">);</span>
	<span class="n">pci_unmap_rom</span><span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_extrom_base_address</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">pch_mac</span><span class="p">,</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="n">show_pch_mac</span><span class="p">,</span> <span class="n">store_pch_mac</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bin_attribute</span> <span class="n">pch_bin_attr</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attr</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pch_firmware&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">mode</span> <span class="o">=</span> <span class="n">S_IRUGO</span> <span class="o">|</span> <span class="n">S_IWUSR</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">PCH_PHUB_OROM_SIZE</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">pch_phub_bin_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span> <span class="o">=</span> <span class="n">pch_phub_bin_write</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pch_phub_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span>
				    <span class="k">const</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span><span class="p">;</span>

	<span class="n">chip</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pch_phub_reg</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s : pci_enable_device FAILED(ret=%d)&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_pci_enable_dev</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s : pci_enable_device returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">ret</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_request_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">KBUILD_MODNAME</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s : pci_request_regions FAILED(ret=%d)&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">err_req_regions</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s : &quot;</span>
		<span class="s">&quot;pci_request_regions returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span> <span class="o">=</span> <span class="n">pci_iomap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>


	<span class="k">if</span> <span class="p">(</span><span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s : pci_iomap FAILED&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">err_pci_iomap</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s : pci_iomap SUCCESS and value &quot;</span>
		<span class="s">&quot;in pch_phub_base_address variable is %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span><span class="p">);</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span> <span class="cm">/* Save pci device struct */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* EG20T PCH */</span>
		<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">board_name</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev_attr_pch_mac</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_sysfs_create</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pch_bin_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_bin_attr</span><span class="p">;</span>

		<span class="n">pch_phub_read_modify_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
					       <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">CLKCFG_REG_OFFSET</span><span class="p">,</span>
					       <span class="n">CLKCFG_CAN_50MHZ</span><span class="p">,</span>
					       <span class="n">CLKCFG_CANCLK_MASK</span><span class="p">);</span>

		<span class="cm">/* quirk for CM-iTC board */</span>
		<span class="n">board_name</span> <span class="o">=</span> <span class="n">dmi_get_system_info</span><span class="p">(</span><span class="n">DMI_BOARD_NAME</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">board_name</span> <span class="o">&amp;&amp;</span> <span class="n">strstr</span><span class="p">(</span><span class="n">board_name</span><span class="p">,</span> <span class="s">&quot;CM-iTC&quot;</span><span class="p">))</span>
			<span class="n">pch_phub_read_modify_write_reg</span><span class="p">(</span><span class="n">chip</span><span class="p">,</span>
						<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">CLKCFG_REG_OFFSET</span><span class="p">,</span>
						<span class="n">CLKCFG_UART_48MHZ</span> <span class="o">|</span> <span class="n">CLKCFG_BAUDDIV</span> <span class="o">|</span>
						<span class="n">CLKCFG_PLL2VCO</span> <span class="o">|</span> <span class="n">CLKCFG_UARTCLKSEL</span><span class="p">,</span>
						<span class="n">CLKCFG_UART_MASK</span><span class="p">);</span>

		<span class="cm">/* set the prefech value */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x000affaa</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="cm">/* set the interrupt delay value */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x25</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span> <span class="o">+</span> <span class="mh">0x44</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_opt_rom_start_address</span> <span class="o">=</span> <span class="n">PCH_PHUB_ROM_START_ADDR_EG20T</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_mac_start_address</span> <span class="o">=</span> <span class="n">PCH_PHUB_MAC_START_ADDR_EG20T</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ML7213 IOH */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pch_bin_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_sysfs_create</span><span class="p">;</span>
		<span class="cm">/* set the prefech value</span>
<span class="cm">		 * Device2(USB OHCI #1/ USB EHCI #1/ USB Device):a</span>
<span class="cm">		 * Device4(SDIO #0,1,2):f</span>
<span class="cm">		 * Device6(SATA 2):f</span>
<span class="cm">		 * Device8(USB OHCI #0/ USB EHCI #0):a</span>
<span class="cm">		 */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x000affa0</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_opt_rom_start_address</span> <span class="o">=</span>\
						 <span class="n">PCH_PHUB_ROM_START_ADDR_ML7213</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ML7223 IOH Bus-m*/</span>
		<span class="cm">/* set the prefech value</span>
<span class="cm">		 * Device8(GbE)</span>
<span class="cm">		 */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x000a0000</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="cm">/* set the interrupt delay value */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x25</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span> <span class="o">+</span> <span class="mh">0x140</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_opt_rom_start_address</span> <span class="o">=</span>\
						 <span class="n">PCH_PHUB_ROM_START_ADDR_ML7223</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_mac_start_address</span> <span class="o">=</span> <span class="n">PCH_PHUB_MAC_START_ADDR_ML7223</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="mi">4</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ML7223 IOH Bus-n*/</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev_attr_pch_mac</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_sysfs_create</span><span class="p">;</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pch_bin_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_bin_attr</span><span class="p">;</span>
		<span class="cm">/* set the prefech value</span>
<span class="cm">		 * Device2(USB OHCI #0,1,2,3/ USB EHCI #0):a</span>
<span class="cm">		 * Device4(SDIO #0,1):f</span>
<span class="cm">		 * Device6(SATA 2):f</span>
<span class="cm">		 */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x0000ffa0</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_opt_rom_start_address</span> <span class="o">=</span>\
						 <span class="n">PCH_PHUB_ROM_START_ADDR_ML7223</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_mac_start_address</span> <span class="o">=</span> <span class="n">PCH_PHUB_MAC_START_ADDR_ML7223</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">==</span> <span class="mi">5</span><span class="p">)</span> <span class="p">{</span> <span class="cm">/* ML7831 */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">sysfs_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
					   <span class="o">&amp;</span><span class="n">dev_attr_pch_mac</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">err_sysfs_create</span><span class="p">;</span>

		<span class="n">retval</span> <span class="o">=</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pch_bin_attr</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">exit_bin_attr</span><span class="p">;</span>

		<span class="cm">/* set the prefech value */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x000affaa</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span> <span class="o">+</span> <span class="mh">0x14</span><span class="p">);</span>
		<span class="cm">/* set the interrupt delay value */</span>
		<span class="n">iowrite32</span><span class="p">(</span><span class="mh">0x25</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span> <span class="o">+</span> <span class="mh">0x44</span><span class="p">);</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_opt_rom_start_address</span> <span class="o">=</span> <span class="n">PCH_PHUB_ROM_START_ADDR_EG20T</span><span class="p">;</span>
		<span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_mac_start_address</span> <span class="o">=</span> <span class="n">PCH_PHUB_MAC_START_ADDR_EG20T</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">chip</span><span class="o">-&gt;</span><span class="n">ioh_type</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span><span class="p">;</span>
	<span class="n">pci_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">chip</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">exit_bin_attr:</span>
	<span class="n">sysfs_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_pch_mac</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>

<span class="nl">err_sysfs_create:</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span><span class="p">);</span>
<span class="nl">err_pci_iomap:</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_req_regions:</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
<span class="nl">err_pci_enable_dev:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
	<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__devexit</span> <span class="nf">pch_phub_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pch_phub_reg</span> <span class="o">*</span><span class="n">chip</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">sysfs_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_pch_mac</span><span class="p">.</span><span class="n">attr</span><span class="p">);</span>
	<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pch_bin_attr</span><span class="p">);</span>
	<span class="n">pci_iounmap</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">chip</span><span class="o">-&gt;</span><span class="n">pch_phub_base_address</span><span class="p">);</span>
	<span class="n">pci_release_regions</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">chip</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_phub_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pch_phub_save_reg_conf</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_save_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot; %s -pci_save_state returns %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pci_disable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pci_choose_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pch_phub_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">pci_set_power_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D0</span><span class="p">);</span>
	<span class="n">pci_restore_state</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pci_enable_device</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_err</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;%s-pci_enable_device failed(ret=%d) &quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pci_enable_wake</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">PCI_D3hot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pch_phub_restore_reg_conf</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#define pch_phub_suspend NULL</span>
<span class="cp">#define pch_phub_resume NULL</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">pch_phub_pcidev_id</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">INTEL</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_PCH1_PHUB</span><span class="p">),</span>       <span class="mi">1</span><span class="p">,</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ROHM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ROHM_ML7213_PHUB</span><span class="p">),</span> <span class="mi">2</span><span class="p">,</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ROHM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ROHM_ML7223_mPHUB</span><span class="p">),</span> <span class="mi">3</span><span class="p">,</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ROHM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ROHM_ML7223_nPHUB</span><span class="p">),</span> <span class="mi">4</span><span class="p">,</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="n">PCI_VDEVICE</span><span class="p">(</span><span class="n">ROHM</span><span class="p">,</span> <span class="n">PCI_DEVICE_ID_ROHM_ML7831_PHUB</span><span class="p">),</span> <span class="mi">5</span><span class="p">,</span>  <span class="p">},</span>
	<span class="p">{</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">pci</span><span class="p">,</span> <span class="n">pch_phub_pcidev_id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_driver</span> <span class="n">pch_phub_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pch_phub&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">id_table</span> <span class="o">=</span> <span class="n">pch_phub_pcidev_id</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">pch_phub_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">pch_phub_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">pch_phub_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">pch_phub_resume</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pch_phub_pci_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">pci_register_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_phub_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pch_phub_pci_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pci_unregister_driver</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pch_phub_driver</span><span class="p">);</span>
<span class="p">}</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">pch_phub_pci_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pch_phub_pci_exit</span><span class="p">);</span>

<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Intel EG20T PCH/LAPIS Semiconductor IOH(ML7213/ML7223) PHUB&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
