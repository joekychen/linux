<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › misc › ti-st › st_kim.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>st_kim.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> *  Shared Transport Line discipline driver Core</span>
<span class="cm"> *	Init Manager module responsible for GPIO control</span>
<span class="cm"> *	and firmware download</span>
<span class="cm"> *  Copyright (C) 2009-2010 Texas Instruments</span>
<span class="cm"> *  Author: Pavan Savoy &lt;pavan_savoy@ti.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> *  it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> *  published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> *  This program is distributed in the hope that it will be useful,</span>
<span class="cm"> *  but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> *  GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> *  You should have received a copy of the GNU General Public License</span>
<span class="cm"> *  along with this program; if not, write to the Free Software</span>
<span class="cm"> *  Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define pr_fmt(fmt) &quot;(stk) :&quot; fmt</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/debugfs.h&gt;</span>
<span class="cp">#include &lt;linux/seq_file.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/sysfs.h&gt;</span>
<span class="cp">#include &lt;linux/tty.h&gt;</span>

<span class="cp">#include &lt;linux/skbuff.h&gt;</span>
<span class="cp">#include &lt;linux/ti_wilink_st.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>


<span class="cp">#define MAX_ST_DEVICES	3	</span><span class="cm">/* Imagine 1 on each UART for now */</span><span class="cp"></span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">st_kim_devices</span><span class="p">[</span><span class="n">MAX_ST_DEVICES</span><span class="p">];</span>

<span class="cm">/**********************************************************************/</span>
<span class="cm">/* internal functions */</span>

<span class="cm">/**</span>
<span class="cm"> * st_get_plat_device -</span>
<span class="cm"> *	function which returns the reference to the platform device</span>
<span class="cm"> *	requested by id. As of now only 1 such device exists (id=0)</span>
<span class="cm"> *	the context requesting for reference can get the id to be</span>
<span class="cm"> *	requested by a. The protocol driver which is registering or</span>
<span class="cm"> *	b. the tty device which is opened.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="nf">st_get_plat_device</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">st_kim_devices</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * validate_firmware_response -</span>
<span class="cm"> *	function to return whether the firmware response was proper</span>
<span class="cm"> *	in case of error don&#39;t complete so that waiting for proper</span>
<span class="cm"> *	response times out</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">validate_firmware_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="n">kim_gdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">sk_buff</span> <span class="o">*</span><span class="n">skb</span> <span class="o">=</span> <span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no proper response during fw download&quot;</span><span class="p">);</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;data6 %x&quot;</span><span class="p">,</span> <span class="n">skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* keep waiting for the proper response */</span>
	<span class="p">}</span>
	<span class="cm">/* becos of all the script being downloaded */</span>
	<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_rcvd</span><span class="p">);</span>
	<span class="n">kfree_skb</span><span class="p">(</span><span class="n">skb</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* check for data len received inside kim_int_recv</span>
<span class="cm"> * most often hit the last case to update state to waiting for data</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">kim_check_data_len</span><span class="p">(</span><span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="n">kim_gdata</span><span class="p">,</span> <span class="kt">int</span> <span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">register</span> <span class="kt">int</span> <span class="n">room</span> <span class="o">=</span> <span class="n">skb_tailroom</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;len %d room %d&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span> <span class="n">room</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">len</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">validate_firmware_response</span><span class="p">(</span><span class="n">kim_gdata</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="n">room</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Received packet&#39;s payload length is larger.</span>
<span class="cm">		 * We can&#39;t accommodate it in created skb.</span>
<span class="cm">		 */</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Data length is too large len %d room %d&quot;</span><span class="p">,</span> <span class="n">len</span><span class="p">,</span>
			   <span class="n">room</span><span class="p">);</span>
		<span class="n">kfree_skb</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* Packet header has non-zero payload length and</span>
<span class="cm">		 * we have enough space in created skb. Lets read</span>
<span class="cm">		 * payload data */</span>
		<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_state</span> <span class="o">=</span> <span class="n">ST_W4_DATA</span><span class="p">;</span>
		<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">=</span> <span class="n">len</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">len</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Change ST LL state to continue to process next</span>
<span class="cm">	 * packet */</span>
	<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_state</span> <span class="o">=</span> <span class="n">ST_W4_PACKET_TYPE</span><span class="p">;</span>
	<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * kim_int_recv - receive function called during firmware download</span>
<span class="cm"> *	firmware download responses on different UART drivers</span>
<span class="cm"> *	have been observed to come in bursts of different</span>
<span class="cm"> *	tty_receive and hence the logic</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">kim_int_recv</span><span class="p">(</span><span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="n">kim_gdata</span><span class="p">,</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">long</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">type</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">plen</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="cm">/* Decode received bytes here */</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">ptr</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot; received null from TTY &quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">count</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_count</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">len</span> <span class="o">=</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_count</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
			<span class="n">memcpy</span><span class="p">(</span><span class="n">skb_put</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="n">len</span><span class="p">),</span> <span class="n">ptr</span><span class="p">,</span> <span class="n">len</span><span class="p">);</span>
			<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">count</span> <span class="o">-=</span> <span class="n">len</span><span class="p">;</span>
			<span class="n">ptr</span> <span class="o">+=</span> <span class="n">len</span><span class="p">;</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_count</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="cm">/* Check ST RX state machine , where are we? */</span>
			<span class="k">switch</span> <span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_state</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Waiting for complete packet ? */</span>
			<span class="k">case</span> <span class="n">ST_W4_DATA</span>:
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;Complete pkt received&quot;</span><span class="p">);</span>
				<span class="n">validate_firmware_response</span><span class="p">(</span><span class="n">kim_gdata</span><span class="p">);</span>
				<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_state</span> <span class="o">=</span> <span class="n">ST_W4_PACKET_TYPE</span><span class="p">;</span>
				<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
				<span class="k">continue</span><span class="p">;</span>
				<span class="cm">/* Waiting for Bluetooth event header ? */</span>
			<span class="k">case</span> <span class="n">ST_W4_HEADER</span>:
				<span class="n">plen</span> <span class="o">=</span>
				<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;event hdr: plen 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="o">*</span><span class="n">plen</span><span class="p">);</span>
				<span class="n">kim_check_data_len</span><span class="p">(</span><span class="n">kim_gdata</span><span class="p">,</span> <span class="o">*</span><span class="n">plen</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>	<span class="cm">/* end of switch */</span>
		<span class="p">}</span>		<span class="cm">/* end of if rx_state */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="o">*</span><span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Bluetooth event packet? */</span>
		<span class="k">case</span> <span class="mh">0x04</span>:
			<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_state</span> <span class="o">=</span> <span class="n">ST_W4_HEADER</span><span class="p">;</span>
			<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
			<span class="n">type</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;unknown packet&quot;</span><span class="p">);</span>
			<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
			<span class="n">count</span><span class="o">--</span><span class="p">;</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">ptr</span><span class="o">++</span><span class="p">;</span>
		<span class="n">count</span><span class="o">--</span><span class="p">;</span>
		<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_skb</span> <span class="o">=</span>
			<span class="n">alloc_skb</span><span class="p">(</span><span class="mi">1024</span><span class="o">+</span><span class="mi">8</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;can&#39;t allocate mem for new packet&quot;</span><span class="p">);</span>
			<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_state</span> <span class="o">=</span> <span class="n">ST_W4_PACKET_TYPE</span><span class="p">;</span>
			<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">skb_reserve</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="p">,</span> <span class="mi">8</span><span class="p">);</span>
		<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
		<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">rx_skb</span><span class="o">-&gt;</span><span class="n">cb</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">read_local_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="n">kim_gdata</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">bts_scr_name</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">version</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">chip</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">min_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">maj_ver</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="n">read_ver_cmd</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x01</span><span class="p">,</span> <span class="mh">0x10</span><span class="p">,</span> <span class="mh">0x00</span> <span class="p">};</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_rcvd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="mi">4</span> <span class="o">!=</span> <span class="n">st_int_write</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">core_data</span><span class="p">,</span> <span class="n">read_ver_cmd</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;kim: couldn&#39;t write 4 bytes&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span>
	    <span class="p">(</span><span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_rcvd</span><span class="p">,</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">CMD_RESP_TIME</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot; waiting for ver info- timed out &quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_rcvd</span><span class="p">);</span>

	<span class="n">version</span> <span class="o">=</span>
		<span class="n">MAKEWORD</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">resp_buffer</span><span class="p">[</span><span class="mi">13</span><span class="p">],</span>
				<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">resp_buffer</span><span class="p">[</span><span class="mi">14</span><span class="p">]);</span>
	<span class="n">chip</span> <span class="o">=</span> <span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x7C00</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">10</span><span class="p">;</span>
	<span class="n">min_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x007F</span><span class="p">);</span>
	<span class="n">maj_ver</span> <span class="o">=</span> <span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x0380</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">version</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">)</span>
		<span class="n">maj_ver</span> <span class="o">|=</span> <span class="mh">0x0008</span><span class="p">;</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">bts_scr_name</span><span class="p">,</span> <span class="s">&quot;TIInit_%d.%d.%d.bts&quot;</span><span class="p">,</span> <span class="n">chip</span><span class="p">,</span> <span class="n">maj_ver</span><span class="p">,</span> <span class="n">min_ver</span><span class="p">);</span>

	<span class="cm">/* to be accessed later via sysfs entry */</span>
	<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">full</span> <span class="o">=</span> <span class="n">version</span><span class="p">;</span>
	<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">chip</span> <span class="o">=</span> <span class="n">chip</span><span class="p">;</span>
	<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">maj_ver</span> <span class="o">=</span> <span class="n">maj_ver</span><span class="p">;</span>
	<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">min_ver</span> <span class="o">=</span> <span class="n">min_ver</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;%s&quot;</span><span class="p">,</span> <span class="n">bts_scr_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">skip_change_remote_baud</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">**</span><span class="n">ptr</span><span class="p">,</span> <span class="kt">long</span> <span class="o">*</span><span class="n">len</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">nxt_action</span><span class="p">,</span> <span class="o">*</span><span class="n">cur_action</span><span class="p">;</span>
	<span class="n">cur_action</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span><span class="p">;</span>

	<span class="n">nxt_action</span> <span class="o">=</span> <span class="n">cur_action</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bts_action</span><span class="p">)</span> <span class="o">+</span>
		<span class="p">((</span><span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="p">)</span> <span class="n">cur_action</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="p">)</span> <span class="n">nxt_action</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">!=</span> <span class="n">ACTION_WAIT_EVENT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;invalid action after change remote baud command&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bts_action</span><span class="p">)</span> <span class="o">+</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="p">)</span><span class="n">cur_action</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
		<span class="o">*</span><span class="n">len</span> <span class="o">=</span> <span class="o">*</span><span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bts_action</span><span class="p">)</span> <span class="o">+</span>
				<span class="p">((</span><span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="p">)</span><span class="n">cur_action</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="cm">/* warn user on not commenting these in firmware */</span>
		<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;skipping the wait event of change remote baud&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * download_firmware -</span>
<span class="cm"> *	internal function which parses through the .bts firmware</span>
<span class="cm"> *	script file intreprets SEND, DELAY actions only as of now</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">download_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="n">kim_gdata</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">action_ptr</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">bts_scr_name</span><span class="p">[</span><span class="mi">30</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span> <span class="p">};</span>	<span class="cm">/* 30 char long bts scr name? */</span>
	<span class="kt">int</span> <span class="n">wr_room_space</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">cmd_size</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">timeout</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">read_local_version</span><span class="p">(</span><span class="n">kim_gdata</span><span class="p">,</span> <span class="n">bts_scr_name</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;kim: failed to read local ver&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">err</span> <span class="o">=</span>
	    <span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="p">,</span> <span class="n">bts_scr_name</span><span class="p">,</span>
			     <span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">((</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span>
		     <span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot; request_firmware failed(errno %ld) for %s&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">,</span>
			   <span class="n">bts_scr_name</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ptr</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">len</span> <span class="o">=</span> <span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="cm">/* bts_header to remove out magic number and</span>
<span class="cm">	 * version</span>
<span class="cm">	 */</span>
	<span class="n">ptr</span> <span class="o">+=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bts_header</span><span class="p">);</span>
	<span class="n">len</span> <span class="o">-=</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bts_header</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">len</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">ptr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot; action size %d, type %d &quot;</span><span class="p">,</span>
			   <span class="p">((</span><span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">,</span>
			   <span class="p">((</span><span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(((</span><span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">ACTION_SEND_COMMAND</span>:	<span class="cm">/* action send */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;S&quot;</span><span class="p">);</span>
			<span class="n">action_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(((</span><span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span>
			    <span class="p">(((</span><span class="k">struct</span> <span class="n">hci_command</span> <span class="o">*</span><span class="p">)</span><span class="n">action_ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">opcode</span> <span class="o">==</span>
			     <span class="mh">0xFF36</span><span class="p">))</span> <span class="p">{</span>
				<span class="cm">/* ignore remote change</span>
<span class="cm">				 * baud rate HCI VS command */</span>
				<span class="n">pr_warn</span><span class="p">(</span><span class="s">&quot;change remote baud&quot;</span>
				    <span class="s">&quot; rate command in firmware&quot;</span><span class="p">);</span>
				<span class="n">skip_change_remote_baud</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ptr</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">len</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Make sure we have enough free space in uart</span>
<span class="cm">			 * tx buffer to write current firmware command</span>
<span class="cm">			 */</span>
			<span class="n">cmd_size</span> <span class="o">=</span> <span class="p">((</span><span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
			<span class="n">timeout</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">CMD_WR_TIME</span><span class="p">);</span>
			<span class="k">do</span> <span class="p">{</span>
				<span class="n">wr_room_space</span> <span class="o">=</span>
					<span class="n">st_get_uart_wr_room</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">core_data</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">wr_room_space</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Unable to get free &quot;</span>
							<span class="s">&quot;space info from uart tx buffer&quot;</span><span class="p">);</span>
					<span class="n">release_firmware</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="p">);</span>
					<span class="k">return</span> <span class="n">wr_room_space</span><span class="p">;</span>
				<span class="p">}</span>
				<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span> <span class="cm">/* wait 1ms before checking room */</span>
			<span class="p">}</span> <span class="k">while</span> <span class="p">((</span><span class="n">wr_room_space</span> <span class="o">&lt;</span> <span class="n">cmd_size</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
					<span class="n">time_before</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">));</span>

			<span class="cm">/* Timeout happened ? */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">time_after_eq</span><span class="p">(</span><span class="n">jiffies</span><span class="p">,</span> <span class="n">timeout</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Timeout while waiting for free &quot;</span>
						<span class="s">&quot;free space in uart tx buffer&quot;</span><span class="p">);</span>
				<span class="n">release_firmware</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/* reinit completion before sending for the</span>
<span class="cm">			 * relevant wait</span>
<span class="cm">			 */</span>
			<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_rcvd</span><span class="p">);</span>

			<span class="cm">/*</span>
<span class="cm">			 * Free space found in uart buffer, call st_int_write</span>
<span class="cm">			 * to send current firmware command to the uart tx</span>
<span class="cm">			 * buffer.</span>
<span class="cm">			 */</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">st_int_write</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">core_data</span><span class="p">,</span>
			<span class="p">((</span><span class="k">struct</span> <span class="n">bts_action_send</span> <span class="o">*</span><span class="p">)</span><span class="n">action_ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span>
					   <span class="p">((</span><span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">err</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">release_firmware</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="cm">/*</span>
<span class="cm">			 * Check number of bytes written to the uart tx buffer</span>
<span class="cm">			 * and requested command write size</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="n">cmd_size</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;Number of bytes written to uart &quot;</span>
						<span class="s">&quot;tx buffer are not matching with &quot;</span>
						<span class="s">&quot;requested cmd write size&quot;</span><span class="p">);</span>
				<span class="n">release_firmware</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ACTION_WAIT_EVENT</span>:  <span class="cm">/* wait */</span>
			<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;W&quot;</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wait_for_completion_timeout</span>
					<span class="p">(</span><span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_rcvd</span><span class="p">,</span>
					 <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">CMD_RESP_TIME</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;response timeout during fw download &quot;</span><span class="p">);</span>
				<span class="cm">/* timed out */</span>
				<span class="n">release_firmware</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="p">);</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_rcvd</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="n">ACTION_DELAY</span>:	<span class="cm">/* sleep */</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;sleep command in scr&quot;</span><span class="p">);</span>
			<span class="n">action_ptr</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(((</span><span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
			<span class="n">mdelay</span><span class="p">(((</span><span class="k">struct</span> <span class="n">bts_action_delay</span> <span class="o">*</span><span class="p">)</span><span class="n">action_ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">msec</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">len</span> <span class="o">=</span>
		    <span class="n">len</span> <span class="o">-</span> <span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bts_action</span><span class="p">)</span> <span class="o">+</span>
			   <span class="p">((</span><span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">);</span>
		<span class="n">ptr</span> <span class="o">=</span>
		    <span class="n">ptr</span> <span class="o">+</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">bts_action</span><span class="p">)</span> <span class="o">+</span>
		    <span class="p">((</span><span class="k">struct</span> <span class="n">bts_action</span> <span class="o">*</span><span class="p">)</span><span class="n">ptr</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* fw download complete */</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">fw_entry</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************************************************/</span>
<span class="cm">/* functions called from ST core */</span>
<span class="cm">/* called from ST Core, when REG_IN_PROGRESS (registration in progress)</span>
<span class="cm"> * can be because of</span>
<span class="cm"> * 1. response to read local version</span>
<span class="cm"> * 2. during send/recv&#39;s of firmware download</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">st_kim_recv</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">disc_data</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">long</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">st_data_s</span>	<span class="o">*</span><span class="n">st_gdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">st_data_s</span> <span class="o">*</span><span class="p">)</span><span class="n">disc_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span>	<span class="o">*</span><span class="n">kim_gdata</span> <span class="o">=</span> <span class="n">st_gdata</span><span class="o">-&gt;</span><span class="n">kim_data</span><span class="p">;</span>

	<span class="cm">/* copy to local buffer */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x01</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x10</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x04</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* must be the read_ver_cmd */</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">resp_buffer</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="n">complete_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_rcvd</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">kim_int_recv</span><span class="p">(</span><span class="n">kim_gdata</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
		<span class="cm">/* either completes or times out */</span>
	<span class="p">}</span>
	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* to signal completion of line discipline installation</span>
<span class="cm"> * called from ST Core, upon tty_open</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">st_kim_complete</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">kim_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span>	<span class="o">*</span><span class="n">kim_gdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="p">)</span><span class="n">kim_data</span><span class="p">;</span>
	<span class="n">complete</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">ldisc_installed</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * st_kim_start - called from ST Core upon 1st registration</span>
<span class="cm"> *	This involves toggling the chip enable gpio, reading</span>
<span class="cm"> *	the firmware version from chip, forming the fw file name</span>
<span class="cm"> *	based on the chip version, requesting the fw, parsing it</span>
<span class="cm"> *	and perform download(send/recv).</span>
<span class="cm"> */</span>
<span class="kt">long</span> <span class="nf">st_kim_start</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">kim_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">retry</span> <span class="o">=</span> <span class="n">POR_RETRY_COUNT</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_st_plat_data</span>	<span class="o">*</span><span class="n">pdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span>	<span class="o">*</span><span class="n">kim_gdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="p">)</span><span class="n">kim_data</span><span class="p">;</span>

	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>
	<span class="n">pdata</span> <span class="o">=</span> <span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="cm">/* platform specific enabling code here */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">chip_enable</span><span class="p">)</span>
			<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">chip_enable</span><span class="p">(</span><span class="n">kim_gdata</span><span class="p">);</span>

		<span class="cm">/* Configure BT nShutdown to HIGH state */</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">nshutdown</span><span class="p">,</span> <span class="n">GPIO_LOW</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">5</span><span class="p">);</span>	<span class="cm">/* FIXME: a proper toggle */</span>
		<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">nshutdown</span><span class="p">,</span> <span class="n">GPIO_HIGH</span><span class="p">);</span>
		<span class="n">mdelay</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
		<span class="cm">/* re-initialize the completion */</span>
		<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">ldisc_installed</span><span class="p">);</span>
		<span class="cm">/* send notification to UIM */</span>
		<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">ldisc_install</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ldisc_install = 1&quot;</span><span class="p">);</span>
		<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span>
				<span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;install&quot;</span><span class="p">);</span>
		<span class="cm">/* wait for ldisc to be installed */</span>
		<span class="n">err</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">ldisc_installed</span><span class="p">,</span>
				<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">LDISC_TIME</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* ldisc installation timeout,</span>
<span class="cm">			 * flush uart, power cycle BT_EN */</span>
			<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;ldisc installation timeout&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">st_kim_stop</span><span class="p">(</span><span class="n">kim_gdata</span><span class="p">);</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* ldisc installed now */</span>
			<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;line discipline installed&quot;</span><span class="p">);</span>
			<span class="n">err</span> <span class="o">=</span> <span class="n">download_firmware</span><span class="p">(</span><span class="n">kim_gdata</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">err</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* ldisc installed but fw download failed,</span>
<span class="cm">				 * flush uart &amp; power cycle BT_EN */</span>
				<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;download firmware failed&quot;</span><span class="p">);</span>
				<span class="n">err</span> <span class="o">=</span> <span class="n">st_kim_stop</span><span class="p">(</span><span class="n">kim_gdata</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	<span class="cm">/* on success don&#39;t retry */</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">retry</span><span class="o">--</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * st_kim_stop - stop communication with chip.</span>
<span class="cm"> *	This can be called from ST Core/KIM, on the-</span>
<span class="cm"> *	(a) last un-register when chip need not be powered there-after,</span>
<span class="cm"> *	(b) upon failure to either install ldisc or download firmware.</span>
<span class="cm"> *	The function is responsible to (a) notify UIM about un-installation,</span>
<span class="cm"> *	(b) flush UART if the ldisc was installed.</span>
<span class="cm"> *	(c) reset BT_EN - pull down nshutdown at the end.</span>
<span class="cm"> *	(d) invoke platform&#39;s chip disabling routine.</span>
<span class="cm"> */</span>
<span class="kt">long</span> <span class="nf">st_kim_stop</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">kim_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">err</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span>	<span class="o">*</span><span class="n">kim_gdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="p">)</span><span class="n">kim_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_st_plat_data</span>	<span class="o">*</span><span class="n">pdata</span> <span class="o">=</span>
		<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">tty_struct</span>	<span class="o">*</span><span class="n">tty</span> <span class="o">=</span> <span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">core_data</span><span class="o">-&gt;</span><span class="n">tty</span><span class="p">;</span>

	<span class="n">INIT_COMPLETION</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">ldisc_installed</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">tty</span><span class="p">)</span> <span class="p">{</span>	<span class="cm">/* can be called before ldisc is installed */</span>
		<span class="cm">/* Flush any pending characters in the driver and discipline. */</span>
		<span class="n">tty_ldisc_flush</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">tty_driver_flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
		<span class="n">tty</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">flush_buffer</span><span class="p">(</span><span class="n">tty</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* send uninstall notification to UIM */</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;ldisc_install = 0&quot;</span><span class="p">);</span>
	<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">ldisc_install</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">sysfs_notify</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;install&quot;</span><span class="p">);</span>

	<span class="cm">/* wait for ldisc to be un-installed */</span>
	<span class="n">err</span> <span class="o">=</span> <span class="n">wait_for_completion_timeout</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">ldisc_installed</span><span class="p">,</span>
			<span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">LDISC_TIME</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>		<span class="cm">/* timeout */</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot; timed out waiting for ldisc to be un-installed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ETIMEDOUT</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* By default configure BT nShutdown to LOW state */</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">nshutdown</span><span class="p">,</span> <span class="n">GPIO_LOW</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">nshutdown</span><span class="p">,</span> <span class="n">GPIO_HIGH</span><span class="p">);</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">gpio_set_value</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">nshutdown</span><span class="p">,</span> <span class="n">GPIO_LOW</span><span class="p">);</span>

	<span class="cm">/* platform specific disable */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">chip_disable</span><span class="p">)</span>
		<span class="n">pdata</span><span class="o">-&gt;</span><span class="n">chip_disable</span><span class="p">(</span><span class="n">kim_gdata</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************************************************/</span>
<span class="cm">/* functions called from subsystems */</span>
<span class="cm">/* called when debugfs entry is read from */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_version</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="n">kim_gdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">seq_printf</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="s">&quot;%04X %d.%d.%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">full</span><span class="p">,</span>
			<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">chip</span><span class="p">,</span> <span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">maj_ver</span><span class="p">,</span>
			<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">.</span><span class="n">min_ver</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">show_list</span><span class="p">(</span><span class="k">struct</span> <span class="n">seq_file</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">unused</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="n">kim_gdata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="p">)</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">private</span><span class="p">;</span>
	<span class="n">kim_st_list_protocols</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">core_data</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_install</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="n">kim_data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kim_data</span><span class="o">-&gt;</span><span class="n">ldisc_install</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef DEBUG</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_dev_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="n">kim_data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;storing dev name &gt;%s&lt;&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">kim_data</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;stored dev name &gt;%s&lt;&quot;</span><span class="p">,</span> <span class="n">kim_data</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">store_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="n">kim_data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;storing baud rate &gt;%s&lt;&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">kim_data</span><span class="o">-&gt;</span><span class="n">baud_rate</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;stored baud rate &gt;%ld&lt;&quot;</span><span class="p">,</span> <span class="n">kim_data</span><span class="o">-&gt;</span><span class="n">baud_rate</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif	</span><span class="cm">/* if DEBUG */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_dev_name</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="n">kim_data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kim_data</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_baud_rate</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="n">kim_data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kim_data</span><span class="o">-&gt;</span><span class="n">baud_rate</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_flow_cntrl</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span> <span class="o">*</span><span class="n">kim_data</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">kim_data</span><span class="o">-&gt;</span><span class="n">flow_cntrl</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* structures specific for sysfs entries */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="n">ldisc_install</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">install</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">show_install</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="n">uart_dev_name</span> <span class="o">=</span>
<span class="cp">#ifdef DEBUG	</span><span class="cm">/* TODO: move this to debug-fs if possible */</span><span class="cp"></span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">show_dev_name</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">store_dev_name</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">dev_name</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">show_dev_name</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="n">uart_baud_rate</span> <span class="o">=</span>
<span class="cp">#ifdef DEBUG	</span><span class="cm">/* TODO: move to debugfs */</span><span class="cp"></span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">baud_rate</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">show_baud_rate</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">store_baud_rate</span><span class="p">);</span>
<span class="cp">#else</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">baud_rate</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">show_baud_rate</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">kobj_attribute</span> <span class="n">uart_flow_cntrl</span> <span class="o">=</span>
<span class="n">__ATTR</span><span class="p">(</span><span class="n">flow_cntrl</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="n">show_flow_cntrl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute</span> <span class="o">*</span><span class="n">uim_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="o">&amp;</span><span class="n">ldisc_install</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">uart_dev_name</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">uart_baud_rate</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="o">&amp;</span><span class="n">uart_flow_cntrl</span><span class="p">.</span><span class="n">attr</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">attribute_group</span> <span class="n">uim_attr_grp</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">attrs</span> <span class="o">=</span> <span class="n">uim_attrs</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * st_kim_ref - reference the core&#39;s data</span>
<span class="cm"> *	This references the per-ST platform device in the arch/xx/</span>
<span class="cm"> *	board-xx.c file.</span>
<span class="cm"> *	This would enable multiple such platform devices to exist</span>
<span class="cm"> *	on a given platform</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">st_kim_ref</span><span class="p">(</span><span class="k">struct</span> <span class="n">st_data_s</span> <span class="o">**</span><span class="n">core_data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">platform_device</span>	<span class="o">*</span><span class="n">pdev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span>	<span class="o">*</span><span class="n">kim_gdata</span><span class="p">;</span>
	<span class="cm">/* get kim_gdata reference from platform device */</span>
	<span class="n">pdev</span> <span class="o">=</span> <span class="n">st_get_plat_device</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pdev</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">core_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">kim_gdata</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="o">*</span><span class="n">core_data</span> <span class="o">=</span> <span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">core_data</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kim_version_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">show_version</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kim_list_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">i</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">f</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">single_open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">show_list</span><span class="p">,</span> <span class="n">i</span><span class="o">-&gt;</span><span class="n">i_private</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">version_debugfs_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* version info */</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">kim_version_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">list_debugfs_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* protocols info */</span>
	<span class="p">.</span><span class="n">open</span> <span class="o">=</span> <span class="n">kim_list_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span> <span class="o">=</span> <span class="n">seq_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span> <span class="o">=</span> <span class="n">seq_lseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">single_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/**********************************************************************/</span>
<span class="cm">/* functions called from platform device driver subsystem</span>
<span class="cm"> * need to have a relevant platform device entry in the platform&#39;s</span>
<span class="cm"> * board-*.c file</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">dentry</span> <span class="o">*</span><span class="n">kim_debugfs_dir</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">kim_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">long</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span>	<span class="o">*</span><span class="n">kim_gdata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">ti_st_plat_data</span>	<span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">&lt;</span> <span class="n">MAX_ST_DEVICES</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* multiple devices could exist */</span>
		<span class="n">st_kim_devices</span><span class="p">[</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* platform&#39;s sure about existence of 1 device */</span>
		<span class="n">st_kim_devices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">kim_gdata</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">kim_data_s</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">kim_gdata</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;no mem to allocate&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_set_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="n">kim_gdata</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">st_core_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">core_data</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot; ST core init failed&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* refer to itself */</span>
	<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">core_data</span><span class="o">-&gt;</span><span class="n">kim_data</span> <span class="o">=</span> <span class="n">kim_gdata</span><span class="p">;</span>

	<span class="cm">/* Claim the chip enable nShutdown gpio from the system */</span>
	<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">nshutdown</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">nshutdown_gpio</span><span class="p">;</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">gpio_request</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">nshutdown</span><span class="p">,</span> <span class="s">&quot;kim&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot; gpio %ld request failed &quot;</span><span class="p">,</span> <span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">nshutdown</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Configure nShutdown GPIO as output=0 */</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">gpio_direction_output</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">nshutdown</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">unlikely</span><span class="p">(</span><span class="n">status</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot; unable to configure gpio %ld&quot;</span><span class="p">,</span> <span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">nshutdown</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* get reference of pdev for request_firmware</span>
<span class="cm">	 */</span>
	<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_pdev</span> <span class="o">=</span> <span class="n">pdev</span><span class="p">;</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_rcvd</span><span class="p">);</span>
	<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">ldisc_installed</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">sysfs_create_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uim_attr_grp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot;failed to create sysfs entries&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">status</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* copying platform data */</span>
	<span class="n">strncpy</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">dev_name</span><span class="p">,</span> <span class="n">UART_DEV_NAME_LEN</span><span class="p">);</span>
	<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">flow_cntrl</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">flow_cntrl</span><span class="p">;</span>
	<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">baud_rate</span> <span class="o">=</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">baud_rate</span><span class="p">;</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;sysfs entries created</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">kim_debugfs_dir</span> <span class="o">=</span> <span class="n">debugfs_create_dir</span><span class="p">(</span><span class="s">&quot;ti-st&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">kim_debugfs_dir</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pr_err</span><span class="p">(</span><span class="s">&quot; debugfs entries creation failed &quot;</span><span class="p">);</span>
		<span class="n">kim_debugfs_dir</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;version&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">kim_debugfs_dir</span><span class="p">,</span>
				<span class="n">kim_gdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">version_debugfs_fops</span><span class="p">);</span>
	<span class="n">debugfs_create_file</span><span class="p">(</span><span class="s">&quot;protocols&quot;</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">kim_debugfs_dir</span><span class="p">,</span>
				<span class="n">kim_gdata</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">list_debugfs_fops</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot; debugfs entries created &quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">kim_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* free the GPIOs requested */</span>
	<span class="k">struct</span> <span class="n">ti_st_plat_data</span>	<span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kim_data_s</span>	<span class="o">*</span><span class="n">kim_gdata</span><span class="p">;</span>

	<span class="n">kim_gdata</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* Free the Bluetooth/FM/GPIO</span>
<span class="cm">	 * nShutdown gpio from the system</span>
<span class="cm">	 */</span>
	<span class="n">gpio_free</span><span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">nshutdown_gpio</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;nshutdown GPIO Freed&quot;</span><span class="p">);</span>

	<span class="n">debugfs_remove_recursive</span><span class="p">(</span><span class="n">kim_debugfs_dir</span><span class="p">);</span>
	<span class="n">sysfs_remove_group</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">uim_attr_grp</span><span class="p">);</span>
	<span class="n">pr_info</span><span class="p">(</span><span class="s">&quot;sysfs entries removed&quot;</span><span class="p">);</span>

	<span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">kim_pdev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">st_core_exit</span><span class="p">(</span><span class="n">kim_gdata</span><span class="o">-&gt;</span><span class="n">core_data</span><span class="p">);</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">kim_gdata</span><span class="p">);</span>
	<span class="n">kim_gdata</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kim_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ti_st_plat_data</span>	<span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span> <span class="nf">kim_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">ti_st_plat_data</span>	<span class="o">*</span><span class="n">pdata</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">platform_data</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pdata</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">pdata</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="k">return</span> <span class="o">-</span><span class="n">EOPNOTSUPP</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**********************************************************************/</span>
<span class="cm">/* entry point for ST KIM module, called in from ST Core */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">kim_platform_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">kim_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">kim_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">kim_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">kim_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;kim&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">kim_platform_driver</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Pavan Savoy &lt;pavan_savoy@ti.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Shared Transport Driver for TI BT/FM/GPS combo chips &quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
