<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › firewire › core-cdev.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>core-cdev.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Char device for device raw access</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2005-2007  Kristian Hoegsberg &lt;krh@bitplanet.net&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License as published by</span>
<span class="cm"> * the Free Software Foundation; either version 2 of the License, or</span>
<span class="cm"> * (at your option) any later version.</span>
<span class="cm"> *</span>
<span class="cm"> * This program is distributed in the hope that it will be useful,</span>
<span class="cm"> * but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="cm"> * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="cm"> * GNU General Public License for more details.</span>
<span class="cm"> *</span>
<span class="cm"> * You should have received a copy of the GNU General Public License</span>
<span class="cm"> * along with this program; if not, write to the Free Software Foundation,</span>
<span class="cm"> * Inc., 59 Temple Place - Suite 330, Boston, MA 02111-1307, USA.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/bug.h&gt;</span>
<span class="cp">#include &lt;linux/compat.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/firewire.h&gt;</span>
<span class="cp">#include &lt;linux/firewire-cdev.h&gt;</span>
<span class="cp">#include &lt;linux/idr.h&gt;</span>
<span class="cp">#include &lt;linux/irqflags.h&gt;</span>
<span class="cp">#include &lt;linux/jiffies.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/kref.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>
<span class="cp">#include &lt;linux/poll.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt; </span><span class="cm">/* required for linux/wait.h */</span><span class="cp"></span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/time.h&gt;</span>
<span class="cp">#include &lt;linux/uaccess.h&gt;</span>
<span class="cp">#include &lt;linux/vmalloc.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>


<span class="cp">#include &quot;core.h&quot;</span>

<span class="cm">/*</span>
<span class="cm"> * ABI version history is documented in linux/firewire-cdev.h.</span>
<span class="cm"> */</span>
<span class="cp">#define FW_CDEV_KERNEL_VERSION			5</span>
<span class="cp">#define FW_CDEV_VERSION_EVENT_REQUEST2		4</span>
<span class="cp">#define FW_CDEV_VERSION_ALLOCATE_REGION_END	4</span>

<span class="k">struct</span> <span class="n">client</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">version</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>

	<span class="n">spinlock_t</span> <span class="n">lock</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">in_shutdown</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">idr</span> <span class="n">resource_idr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">event_list</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">wait</span><span class="p">;</span>
	<span class="n">wait_queue_head_t</span> <span class="n">tx_flush_wait</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">bus_reset_closure</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">fw_iso_context</span> <span class="o">*</span><span class="n">iso_context</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">iso_closure</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_iso_buffer</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">vm_start</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">buffer_is_mapped</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">phy_receiver_link</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">phy_receiver_closure</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">link</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">kref</span> <span class="n">kref</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">client_get</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">client_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">kref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">kref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">client</span><span class="p">,</span> <span class="n">kref</span><span class="p">);</span>

	<span class="n">fw_device_put</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">client_put</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">,</span> <span class="n">client_release</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">client_resource</span><span class="p">;</span>
<span class="k">typedef</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">client_resource_release_fn_t</span><span class="p">)(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="p">,</span>
					     <span class="k">struct</span> <span class="n">client_resource</span> <span class="o">*</span><span class="p">);</span>
<span class="k">struct</span> <span class="n">client_resource</span> <span class="p">{</span>
	<span class="n">client_resource_release_fn_t</span> <span class="n">release</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handle</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">address_handler_resource</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">client_resource</span> <span class="n">resource</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_address_handler</span> <span class="n">handler</span><span class="p">;</span>
	<span class="n">__u64</span> <span class="n">closure</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">outbound_transaction_resource</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">client_resource</span> <span class="n">resource</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_transaction</span> <span class="n">transaction</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">inbound_transaction_resource</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">client_resource</span> <span class="n">resource</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_card</span> <span class="o">*</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_request</span> <span class="o">*</span><span class="n">request</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">length</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">descriptor_resource</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">client_resource</span> <span class="n">resource</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_descriptor</span> <span class="n">descriptor</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iso_resource</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">client_resource</span> <span class="n">resource</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="cm">/* Schedule work and access todo only with client-&gt;lock held. */</span>
	<span class="k">struct</span> <span class="n">delayed_work</span> <span class="n">work</span><span class="p">;</span>
	<span class="k">enum</span> <span class="p">{</span><span class="n">ISO_RES_ALLOC</span><span class="p">,</span> <span class="n">ISO_RES_REALLOC</span><span class="p">,</span> <span class="n">ISO_RES_DEALLOC</span><span class="p">,</span>
	      <span class="n">ISO_RES_ALLOC_ONCE</span><span class="p">,</span> <span class="n">ISO_RES_DEALLOC_ONCE</span><span class="p">,}</span> <span class="n">todo</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">generation</span><span class="p">;</span>
	<span class="n">u64</span> <span class="n">channels</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">bandwidth</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iso_resource_event</span> <span class="o">*</span><span class="n">e_alloc</span><span class="p">,</span> <span class="o">*</span><span class="n">e_dealloc</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">release_iso_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">client_resource</span> <span class="o">*</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">schedule_iso_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">iso_resource</span> <span class="o">*</span><span class="n">r</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">client_get</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">queue_delayed_work</span><span class="p">(</span><span class="n">fw_workqueue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">delay</span><span class="p">))</span>
		<span class="n">client_put</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">schedule_if_iso_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">client_resource</span> <span class="o">*</span><span class="n">resource</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">==</span> <span class="n">release_iso_resource</span><span class="p">)</span>
		<span class="n">schedule_iso_resource</span><span class="p">(</span><span class="n">container_of</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span>
					<span class="k">struct</span> <span class="n">iso_resource</span><span class="p">,</span> <span class="n">resource</span><span class="p">),</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * dequeue_event() just kfree()&#39;s the event, so the event has to be</span>
<span class="cm"> * the first field in a struct XYZ_event.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">event</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="p">{</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">;</span> <span class="kt">size_t</span> <span class="n">size</span><span class="p">;</span> <span class="p">}</span> <span class="n">v</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">list_head</span> <span class="n">link</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">bus_reset_event</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">event</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_event_bus_reset</span> <span class="n">reset</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">outbound_transaction_event</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">event</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">outbound_transaction_resource</span> <span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_event_response</span> <span class="n">response</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">inbound_transaction_event</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">event</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">union</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fw_cdev_event_request</span> <span class="n">request</span><span class="p">;</span>
		<span class="k">struct</span> <span class="n">fw_cdev_event_request2</span> <span class="n">request2</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">req</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iso_interrupt_event</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">event</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_event_iso_interrupt</span> <span class="n">interrupt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iso_interrupt_mc_event</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">event</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_event_iso_interrupt_mc</span> <span class="n">interrupt</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">iso_resource_event</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">event</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_event_iso_resource</span> <span class="n">iso_resource</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">outbound_phy_packet_event</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">event</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_packet</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_event_phy_packet</span> <span class="n">phy_packet</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">inbound_phy_packet_event</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">event</span> <span class="n">event</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_event_phy_packet</span> <span class="n">phy_packet</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="nf">u64_to_uptr</span><span class="p">(</span><span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_compat_task</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u64</span> <span class="nf">uptr_to_u64</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_compat_task</span><span class="p">())</span>
		<span class="k">return</span> <span class="n">ptr_to_compat</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="nf">u64_to_uptr</span><span class="p">(</span><span class="n">u64</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">value</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">u64</span> <span class="nf">uptr_to_u64</span><span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">ptr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="p">(</span><span class="n">u64</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">ptr</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_COMPAT */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fw_device_op_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_device</span> <span class="o">*</span><span class="n">device</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>

	<span class="n">device</span> <span class="o">=</span> <span class="n">fw_device_get_by_devt</span><span class="p">(</span><span class="n">inode</span><span class="o">-&gt;</span><span class="n">i_rdev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw_device_is_shutdown</span><span class="p">(</span><span class="n">device</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">fw_device_put</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">client</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">client</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fw_device_put</span><span class="p">(</span><span class="n">device</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">idr_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">resource_idr</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">event_list</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tx_flush_wait</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">phy_receiver_link</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">kref</span><span class="p">);</span>

	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">nonseekable_open</span><span class="p">(</span><span class="n">inode</span><span class="p">,</span> <span class="n">file</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">queue_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
			<span class="kt">void</span> <span class="o">*</span><span class="n">data0</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size0</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data1</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">size1</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">data0</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">size0</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">data</span> <span class="o">=</span> <span class="n">data1</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">size</span> <span class="o">=</span> <span class="n">size1</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">event_list</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dequeue_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			 <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">event</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">size</span><span class="p">,</span> <span class="n">total</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">wait_event_interruptible</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span>
			<span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">event_list</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">fw_device_is_shutdown</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">event_list</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		       <span class="n">fw_device_is_shutdown</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">event</span> <span class="o">=</span> <span class="n">list_first_entry</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">event_list</span><span class="p">,</span> <span class="k">struct</span> <span class="n">event</span><span class="p">,</span> <span class="n">link</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">total</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">total</span> <span class="o">&lt;</span> <span class="n">count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">size</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">event</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">size</span><span class="p">,</span> <span class="n">count</span> <span class="o">-</span> <span class="n">total</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">buffer</span> <span class="o">+</span> <span class="n">total</span><span class="p">,</span> <span class="n">event</span><span class="o">-&gt;</span><span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">data</span><span class="p">,</span> <span class="n">size</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">total</span> <span class="o">+=</span> <span class="n">size</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">total</span><span class="p">;</span>

 <span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">fw_device_op_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buffer</span><span class="p">,</span>
				 <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">offset</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">dequeue_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">buffer</span><span class="p">,</span> <span class="n">count</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">fill_bus_reset_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_cdev_event_bus_reset</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">event</span><span class="o">-&gt;</span><span class="n">closure</span>	     <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">bus_reset_closure</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">type</span>          <span class="o">=</span> <span class="n">FW_CDEV_EVENT_BUS_RESET</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">generation</span>    <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">generation</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">node_id</span>       <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">node_id</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">local_node_id</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">local_node</span><span class="o">-&gt;</span><span class="n">node_id</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">bm_node_id</span>    <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">bm_node_id</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">irm_node_id</span>   <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">irm_node</span><span class="o">-&gt;</span><span class="n">node_id</span><span class="p">;</span>
	<span class="n">event</span><span class="o">-&gt;</span><span class="n">root_node_id</span>  <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">root_node</span><span class="o">-&gt;</span><span class="n">node_id</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">for_each_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_device</span> <span class="o">*</span><span class="n">device</span><span class="p">,</span>
			    <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">))</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">client_list_mutex</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">client_list</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
		<span class="n">callback</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">client_list_mutex</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">schedule_reallocations</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">schedule_if_iso_resource</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">queue_bus_reset_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">bus_reset_event</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fw_notice</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;out of memory when allocating event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">fill_bus_reset_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>

	<span class="n">queue_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">reset</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">idr_for_each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">resource_idr</span><span class="p">,</span> <span class="n">schedule_reallocations</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fw_device_cdev_update</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">for_each_client</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">queue_bus_reset_event</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wake_up_client</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fw_device_cdev_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_device</span> <span class="o">*</span><span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">for_each_client</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">wake_up_client</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">union</span> <span class="n">ioctl_arg</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_get_info</span>			<span class="n">get_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_send_request</span>		<span class="n">send_request</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_allocate</span>			<span class="n">allocate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_deallocate</span>		<span class="n">deallocate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_send_response</span>		<span class="n">send_response</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_initiate_bus_reset</span>	<span class="n">initiate_bus_reset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_add_descriptor</span>		<span class="n">add_descriptor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_remove_descriptor</span>	<span class="n">remove_descriptor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_create_iso_context</span>	<span class="n">create_iso_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_queue_iso</span>		<span class="n">queue_iso</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_start_iso</span>		<span class="n">start_iso</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_stop_iso</span>			<span class="n">stop_iso</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_get_cycle_timer</span>		<span class="n">get_cycle_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_allocate_iso_resource</span>	<span class="n">allocate_iso_resource</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_send_stream_packet</span>	<span class="n">send_stream_packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_get_cycle_timer2</span>		<span class="n">get_cycle_timer2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_send_phy_packet</span>		<span class="n">send_phy_packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_receive_phy_packets</span>	<span class="n">receive_phy_packets</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_set_iso_channels</span>		<span class="n">set_iso_channels</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_flush_iso</span>		<span class="n">flush_iso</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_get_info</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_get_info</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">get_info</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_event_bus_reset</span> <span class="n">bus_reset</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">version</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">=</span> <span class="n">FW_CDEV_KERNEL_VERSION</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">card</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>

	<span class="n">down_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_device_rwsem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">rom</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">size_t</span> <span class="n">want</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">rom_length</span><span class="p">;</span>
		<span class="kt">size_t</span> <span class="n">have</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">config_rom_length</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">u64_to_uptr</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">rom</span><span class="p">),</span>
				   <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">config_rom</span><span class="p">,</span> <span class="n">min</span><span class="p">(</span><span class="n">want</span><span class="p">,</span> <span class="n">have</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">rom_length</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">config_rom_length</span> <span class="o">*</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">up_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw_device_rwsem</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">client_list_mutex</span><span class="p">);</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">bus_reset_closure</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">bus_reset_closure</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">bus_reset</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fill_bus_reset_event</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus_reset</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">u64_to_uptr</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">bus_reset</span><span class="p">),</span>
				   <span class="o">&amp;</span><span class="n">bus_reset</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">bus_reset</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">))</span>
		<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">client_list</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">client_list_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="o">-</span><span class="n">EFAULT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">add_client_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">client_resource</span> <span class="o">*</span><span class="n">resource</span><span class="p">,</span> <span class="n">gfp_t</span> <span class="n">gfp_mask</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

 <span class="nl">retry:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">idr_pre_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">resource_idr</span><span class="p">,</span> <span class="n">gfp_mask</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ECANCELED</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">idr_get_new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">resource_idr</span><span class="p">,</span> <span class="n">resource</span><span class="p">,</span>
				  <span class="o">&amp;</span><span class="n">resource</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">client_get</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="n">schedule_if_iso_resource</span><span class="p">(</span><span class="n">resource</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">retry</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">release_client_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="n">u32</span> <span class="n">handle</span><span class="p">,</span>
				   <span class="n">client_resource_release_fn_t</span> <span class="n">release</span><span class="p">,</span>
				   <span class="k">struct</span> <span class="n">client_resource</span> <span class="o">**</span><span class="n">return_resource</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">client_resource</span> <span class="o">*</span><span class="n">resource</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span>
		<span class="n">resource</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">resource</span> <span class="o">=</span> <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">resource_idr</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">resource</span> <span class="o">&amp;&amp;</span> <span class="n">resource</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">==</span> <span class="n">release</span><span class="p">)</span>
		<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">resource_idr</span><span class="p">,</span> <span class="n">handle</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">resource</span> <span class="o">&amp;&amp;</span> <span class="n">resource</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">==</span> <span class="n">release</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">return_resource</span><span class="p">)</span>
		<span class="o">*</span><span class="n">return_resource</span> <span class="o">=</span> <span class="n">resource</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">resource</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">resource</span><span class="p">);</span>

	<span class="n">client_put</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_transaction</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				<span class="k">struct</span> <span class="n">client_resource</span> <span class="o">*</span><span class="n">resource</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">complete_transaction</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rcode</span><span class="p">,</span>
				 <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">outbound_transaction_event</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_event_response</span> <span class="o">*</span><span class="n">rsp</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">)</span>
		<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">=</span> <span class="n">length</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rcode</span> <span class="o">==</span> <span class="n">RCODE_COMPLETE</span><span class="p">)</span>
		<span class="n">memcpy</span><span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">payload</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">resource_idr</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">in_shutdown</span><span class="p">)</span>
		<span class="n">wake_up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tx_flush_wait</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">=</span> <span class="n">FW_CDEV_EVENT_RESPONSE</span><span class="p">;</span>
	<span class="n">rsp</span><span class="o">-&gt;</span><span class="n">rcode</span> <span class="o">=</span> <span class="n">rcode</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * In the case that sizeof(*rsp) doesn&#39;t align with the position of the</span>
<span class="cm">	 * data, and the read is short, preserve an extra copy of the data</span>
<span class="cm">	 * to stay compatible with a pre-2.6.27 bug.  Since the bug is harmless</span>
<span class="cm">	 * for short reads and some apps depended on it, this is both safe</span>
<span class="cm">	 * and prudent for compatibility.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span> <span class="o">-</span> <span class="n">offsetof</span><span class="p">(</span><span class="n">typeof</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">),</span> <span class="n">data</span><span class="p">))</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">),</span>
			    <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="n">rsp</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">rsp</span><span class="p">)</span> <span class="o">+</span> <span class="n">rsp</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span>
			    <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Drop the idr&#39;s reference */</span>
	<span class="n">client_put</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">fw_cdev_send_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">destination_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">speed</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">outbound_transaction_event</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">tcode</span> <span class="o">!=</span> <span class="n">TCODE_STREAM_DATA</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">4096</span> <span class="o">||</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">512</span> <span class="o">&lt;&lt;</span> <span class="n">speed</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">tcode</span> <span class="o">==</span> <span class="n">TCODE_WRITE_QUADLET_REQUEST</span> <span class="o">&amp;&amp;</span>
	    <span class="n">request</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">client</span> <span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">.</span><span class="n">closure</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">closure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">&amp;&amp;</span>
	    <span class="n">copy_from_user</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
			   <span class="n">u64_to_uptr</span><span class="p">(</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">resource</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">release_transaction</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">add_client_resource</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">resource</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">fw_send_request</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">r</span><span class="p">.</span><span class="n">transaction</span><span class="p">,</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">tcode</span><span class="p">,</span> <span class="n">destination_id</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">generation</span><span class="p">,</span>
			<span class="n">speed</span><span class="p">,</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">,</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">response</span><span class="p">.</span><span class="n">data</span><span class="p">,</span>
			<span class="n">request</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">,</span> <span class="n">complete_transaction</span><span class="p">,</span> <span class="n">e</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">failed:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_send_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">send_request</span><span class="p">.</span><span class="n">tcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCODE_WRITE_QUADLET_REQUEST</span>:
	<span class="k">case</span> <span class="n">TCODE_WRITE_BLOCK_REQUEST</span>:
	<span class="k">case</span> <span class="n">TCODE_READ_QUADLET_REQUEST</span>:
	<span class="k">case</span> <span class="n">TCODE_READ_BLOCK_REQUEST</span>:
	<span class="k">case</span> <span class="n">TCODE_LOCK_MASK_SWAP</span>:
	<span class="k">case</span> <span class="n">TCODE_LOCK_COMPARE_SWAP</span>:
	<span class="k">case</span> <span class="n">TCODE_LOCK_FETCH_ADD</span>:
	<span class="k">case</span> <span class="n">TCODE_LOCK_LITTLE_ADD</span>:
	<span class="k">case</span> <span class="n">TCODE_LOCK_BOUNDED_ADD</span>:
	<span class="k">case</span> <span class="n">TCODE_LOCK_WRAP_ADD</span>:
	<span class="k">case</span> <span class="n">TCODE_LOCK_VENDOR_DEPENDENT</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">init_request</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">send_request</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">node_id</span><span class="p">,</span>
			    <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">max_speed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="n">bool</span> <span class="nf">is_fcp_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_request</span> <span class="o">*</span><span class="n">request</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">client_resource</span> <span class="o">*</span><span class="n">resource</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">inbound_transaction_resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span>
			<span class="k">struct</span> <span class="n">inbound_transaction_resource</span><span class="p">,</span> <span class="n">resource</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_fcp_request</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">))</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">fw_send_response</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="n">RCODE_CONFLICT_ERROR</span><span class="p">);</span>

	<span class="n">fw_card_put</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">handle_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_request</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">tcode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">destination</span><span class="p">,</span> <span class="kt">int</span> <span class="n">source</span><span class="p">,</span>
			   <span class="kt">int</span> <span class="n">generation</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span> <span class="n">offset</span><span class="p">,</span>
			   <span class="kt">void</span> <span class="o">*</span><span class="n">payload</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">length</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">callback_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">address_handler_resource</span> <span class="o">*</span><span class="n">handler</span> <span class="o">=</span> <span class="n">callback_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_transaction_resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_transaction_event</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">size_t</span> <span class="n">event_size0</span><span class="p">;</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">fcp_frame</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* card may be different from handler-&gt;client-&gt;device-&gt;card */</span>
	<span class="n">fw_card_get</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="n">e</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">e</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fw_notice</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;out of memory when allocating event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">card</span>    <span class="o">=</span> <span class="n">card</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">data</span>    <span class="o">=</span> <span class="n">payload</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">length</span>  <span class="o">=</span> <span class="n">length</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">is_fcp_request</span><span class="p">(</span><span class="n">request</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * FIXME: Let core-transaction.c manage a</span>
<span class="cm">		 * single reference-counted copy?</span>
<span class="cm">		 */</span>
		<span class="n">fcp_frame</span> <span class="o">=</span> <span class="n">kmemdup</span><span class="p">(</span><span class="n">payload</span><span class="p">,</span> <span class="n">length</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fcp_frame</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

		<span class="n">r</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">=</span> <span class="n">fcp_frame</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">release_request</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">add_client_resource</span><span class="p">(</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">FW_CDEV_VERSION_EVENT_REQUEST2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fw_cdev_event_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">request</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">tcode</span> <span class="o">&amp;</span> <span class="mh">0x10</span><span class="p">)</span>
			<span class="n">tcode</span> <span class="o">=</span> <span class="n">TCODE_LOCK_REQUEST</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span>	<span class="o">=</span> <span class="n">FW_CDEV_EVENT_REQUEST</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">tcode</span>	<span class="o">=</span> <span class="n">tcode</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">offset</span>	<span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span>	<span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">handle</span>	<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">closure</span>	<span class="o">=</span> <span class="n">handler</span><span class="o">-&gt;</span><span class="n">closure</span><span class="p">;</span>
		<span class="n">event_size0</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fw_cdev_event_request2</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">.</span><span class="n">request2</span><span class="p">;</span>

		<span class="n">req</span><span class="o">-&gt;</span><span class="n">type</span>	<span class="o">=</span> <span class="n">FW_CDEV_EVENT_REQUEST2</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">tcode</span>	<span class="o">=</span> <span class="n">tcode</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">offset</span>	<span class="o">=</span> <span class="n">offset</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">source_node_id</span> <span class="o">=</span> <span class="n">source</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">destination_node_id</span> <span class="o">=</span> <span class="n">destination</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">card</span>	<span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">generation</span>	<span class="o">=</span> <span class="n">generation</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">length</span>	<span class="o">=</span> <span class="n">length</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">handle</span>	<span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">closure</span>	<span class="o">=</span> <span class="n">handler</span><span class="o">-&gt;</span><span class="n">closure</span><span class="p">;</span>
		<span class="n">event_size0</span>	<span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">queue_event</span><span class="p">(</span><span class="n">handler</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">req</span><span class="p">,</span> <span class="n">event_size0</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">failed:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">e</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">fcp_frame</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">is_fcp_request</span><span class="p">(</span><span class="n">request</span><span class="p">))</span>
		<span class="n">fw_send_response</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">RCODE_CONFLICT_ERROR</span><span class="p">);</span>

	<span class="n">fw_card_put</span><span class="p">(</span><span class="n">card</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_address_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">client_resource</span> <span class="o">*</span><span class="n">resource</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">address_handler_resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span>
	    <span class="n">container_of</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="k">struct</span> <span class="n">address_handler_resource</span><span class="p">,</span> <span class="n">resource</span><span class="p">);</span>

	<span class="n">fw_core_remove_address_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_allocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_allocate</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">allocate</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">address_handler_resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_address_region</span> <span class="n">region</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">region</span><span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">version</span> <span class="o">&lt;</span> <span class="n">FW_CDEV_VERSION_ALLOCATE_REGION_END</span><span class="p">)</span>
		<span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">region</span><span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">region_end</span><span class="p">;</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">.</span><span class="n">length</span>           <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">.</span><span class="n">address_callback</span> <span class="o">=</span> <span class="n">handle_request</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">.</span><span class="n">callback_data</span>    <span class="o">=</span> <span class="n">r</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">closure</span>   <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">closure</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">client</span>    <span class="o">=</span> <span class="n">client</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fw_core_add_address_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">region</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">handler</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">release_address_handler</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">add_client_resource</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">release_address_handler</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_deallocate</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">release_client_resource</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">deallocate</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
				       <span class="n">release_address_handler</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_send_response</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_send_response</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">send_response</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">client_resource</span> <span class="o">*</span><span class="n">resource</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_transaction_resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">release_client_resource</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">handle</span><span class="p">,</span>
				    <span class="n">release_request</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">resource</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="k">struct</span> <span class="n">inbound_transaction_resource</span><span class="p">,</span>
			 <span class="n">resource</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_fcp_request</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">!=</span> <span class="n">fw_get_response_length</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">u64_to_uptr</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fw_send_response</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">request</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">rcode</span><span class="p">);</span>
 <span class="nl">out:</span>
	<span class="n">fw_card_put</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_initiate_bus_reset</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">fw_schedule_bus_reset</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="nb">true</span><span class="p">,</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">initiate_bus_reset</span><span class="p">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_CDEV_SHORT_RESET</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			       <span class="k">struct</span> <span class="n">client_resource</span> <span class="o">*</span><span class="n">resource</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">descriptor_resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="k">struct</span> <span class="n">descriptor_resource</span><span class="p">,</span> <span class="n">resource</span><span class="p">);</span>

	<span class="n">fw_core_remove_descriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_add_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_add_descriptor</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">add_descriptor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">descriptor_resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* Access policy: Allow this ioctl only on local nodes&#39; device files. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">is_local</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">256</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">r</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">)</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">*</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">u64_to_uptr</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">),</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">length</span>    <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">immediate</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">immediate</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">key</span>       <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">key</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">.</span><span class="n">data</span>      <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fw_core_add_descriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>

	<span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">release_descriptor</span><span class="p">;</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">add_client_resource</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fw_core_remove_descriptor</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">descriptor</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">failed</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">failed:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_remove_descriptor</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">release_client_resource</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">arg</span><span class="o">-&gt;</span><span class="n">remove_descriptor</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span>
				       <span class="n">release_descriptor</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iso_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_iso_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span> <span class="n">u32</span> <span class="n">cycle</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">header_length</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iso_interrupt_event</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="n">header_length</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fw_notice</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;out of memory when allocating event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">.</span><span class="n">type</span>      <span class="o">=</span> <span class="n">FW_CDEV_EVENT_ISO_INTERRUPT</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">.</span><span class="n">closure</span>   <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_closure</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">.</span><span class="n">cycle</span>     <span class="o">=</span> <span class="n">cycle</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">.</span><span class="n">header_length</span> <span class="o">=</span> <span class="n">header_length</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">.</span><span class="n">header</span><span class="p">,</span> <span class="n">header</span><span class="p">,</span> <span class="n">header_length</span><span class="p">);</span>
	<span class="n">queue_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">)</span> <span class="o">+</span> <span class="n">header_length</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iso_mc_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_iso_context</span> <span class="o">*</span><span class="n">context</span><span class="p">,</span>
			    <span class="n">dma_addr_t</span> <span class="n">completed</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iso_interrupt_mc_event</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">),</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fw_notice</span><span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;out of memory when allocating event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">.</span><span class="n">type</span>      <span class="o">=</span> <span class="n">FW_CDEV_EVENT_ISO_INTERRUPT_MULTICHANNEL</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">.</span><span class="n">closure</span>   <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_closure</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">.</span><span class="n">completed</span> <span class="o">=</span> <span class="n">fw_iso_buffer_lookup</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
						      <span class="n">completed</span><span class="p">);</span>
	<span class="n">queue_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">interrupt</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">dma_data_direction</span> <span class="nf">iso_dma_direction</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_iso_context</span> <span class="o">*</span><span class="n">context</span><span class="p">)</span>
<span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">context</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_ISO_CONTEXT_TRANSMIT</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">DMA_TO_DEVICE</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="n">DMA_FROM_DEVICE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_create_iso_context</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_create_iso_context</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">create_iso_context</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_iso_context</span> <span class="o">*</span><span class="n">context</span><span class="p">;</span>
	<span class="n">fw_iso_callback_t</span> <span class="n">cb</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span><span class="n">FW_CDEV_ISO_CONTEXT_TRANSMIT</span> <span class="o">!=</span> <span class="n">FW_ISO_CONTEXT_TRANSMIT</span> <span class="o">||</span>
		     <span class="n">FW_CDEV_ISO_CONTEXT_RECEIVE</span>  <span class="o">!=</span> <span class="n">FW_ISO_CONTEXT_RECEIVE</span>  <span class="o">||</span>
		     <span class="n">FW_CDEV_ISO_CONTEXT_RECEIVE_MULTICHANNEL</span> <span class="o">!=</span>
					<span class="n">FW_ISO_CONTEXT_RECEIVE_MULTICHANNEL</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">FW_ISO_CONTEXT_TRANSMIT</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">SCODE_3200</span> <span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">cb</span> <span class="o">=</span> <span class="n">iso_callback</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FW_ISO_CONTEXT_RECEIVE</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">header_size</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">||</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">header_size</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">||</span>
		    <span class="n">a</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">63</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="n">cb</span> <span class="o">=</span> <span class="n">iso_callback</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">FW_ISO_CONTEXT_RECEIVE_MULTICHANNEL</span>:
		<span class="n">cb</span> <span class="o">=</span> <span class="p">(</span><span class="n">fw_iso_callback_t</span><span class="p">)</span><span class="n">iso_mc_callback</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">context</span> <span class="o">=</span> <span class="n">fw_iso_context_create</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">,</span>
			<span class="n">a</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">header_size</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">context</span><span class="p">))</span>
		<span class="k">return</span> <span class="n">PTR_ERR</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

	<span class="cm">/* We only support one context at this time. */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">fw_iso_context_destroy</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer_is_mapped</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fw_iso_buffer_map_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
					    <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
					    <span class="n">iso_dma_direction</span><span class="p">(</span><span class="n">context</span><span class="p">));</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
			<span class="n">fw_iso_context_destroy</span><span class="p">(</span><span class="n">context</span><span class="p">);</span>

			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer_is_mapped</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_closure</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">closure</span><span class="p">;</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span> <span class="o">=</span> <span class="n">context</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_set_iso_channels</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_set_iso_channels</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">set_iso_channels</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_iso_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fw_iso_context_set_channels</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Macros for decoding the iso packet control header. */</span>
<span class="cp">#define GET_PAYLOAD_LENGTH(v)	((v) &amp; 0xffff)</span>
<span class="cp">#define GET_INTERRUPT(v)	(((v) &gt;&gt; 16) &amp; 0x01)</span>
<span class="cp">#define GET_SKIP(v)		(((v) &gt;&gt; 17) &amp; 0x01)</span>
<span class="cp">#define GET_TAG(v)		(((v) &gt;&gt; 18) &amp; 0x03)</span>
<span class="cp">#define GET_SY(v)		(((v) &gt;&gt; 20) &amp; 0x0f)</span>
<span class="cp">#define GET_HEADER_LENGTH(v)	(((v) &gt;&gt; 24) &amp; 0xff)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_queue_iso</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_queue_iso</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">queue_iso</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_iso_packet</span> <span class="n">__user</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="o">*</span><span class="n">end</span><span class="p">,</span> <span class="o">*</span><span class="n">next</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_iso_context</span> <span class="o">*</span><span class="n">ctx</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">payload</span><span class="p">,</span> <span class="n">buffer_end</span><span class="p">,</span> <span class="n">transmit_header_bytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">control</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">struct</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">fw_iso_packet</span> <span class="n">packet</span><span class="p">;</span>
		<span class="n">u8</span> <span class="n">header</span><span class="p">[</span><span class="mi">256</span><span class="p">];</span>
	<span class="p">}</span> <span class="n">u</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the user passes a non-NULL data pointer, has mmap()&#39;ed</span>
<span class="cm">	 * the iso buffer, and the pointer points inside the buffer,</span>
<span class="cm">	 * we setup the payload pointers accordingly.  Otherwise we</span>
<span class="cm">	 * set them both to 0, which will still let packets with</span>
<span class="cm">	 * payload_length == 0 through.  In other words, if no packets</span>
<span class="cm">	 * use the indirect payload, the iso buffer need not be mapped</span>
<span class="cm">	 * and the a-&gt;data pointer is ignored.</span>
<span class="cm">	 */</span>
	<span class="n">payload</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">-</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="n">buffer_end</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">page_count</span> <span class="o">&lt;&lt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">data</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pages</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span>
	    <span class="n">payload</span> <span class="o">&gt;=</span> <span class="n">buffer_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">payload</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">buffer_end</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_ISO_CONTEXT_RECEIVE_MULTICHANNEL</span> <span class="o">&amp;&amp;</span> <span class="n">payload</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_cdev_iso_packet</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">u64_to_uptr</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">packets</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">end</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">p</span> <span class="o">+</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">;</span>
	<span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">(</span><span class="n">p</span> <span class="o">&lt;</span> <span class="n">end</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">get_user</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">control</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">payload_length</span> <span class="o">=</span> <span class="n">GET_PAYLOAD_LENGTH</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>
		<span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">interrupt</span> <span class="o">=</span> <span class="n">GET_INTERRUPT</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>
		<span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">skip</span> <span class="o">=</span> <span class="n">GET_SKIP</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>
		<span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">tag</span> <span class="o">=</span> <span class="n">GET_TAG</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>
		<span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">sy</span> <span class="o">=</span> <span class="n">GET_SY</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>
		<span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">header_length</span> <span class="o">=</span> <span class="n">GET_HEADER_LENGTH</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">FW_ISO_CONTEXT_TRANSMIT</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">header_length</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">transmit_header_bytes</span> <span class="o">=</span> <span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">header_length</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FW_ISO_CONTEXT_RECEIVE</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">header_length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">header_length</span> <span class="o">%</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">header_size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">FW_ISO_CONTEXT_RECEIVE_MULTICHANNEL</span>:
			<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">payload_length</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span>
			    <span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">payload_length</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span>
				<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">next</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">fw_cdev_iso_packet</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span>
			<span class="o">&amp;</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">[</span><span class="n">transmit_header_bytes</span> <span class="o">/</span> <span class="mi">4</span><span class="p">];</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">next</span> <span class="o">&gt;</span> <span class="n">end</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">__copy_from_user</span>
		    <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">header</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">,</span> <span class="n">transmit_header_bytes</span><span class="p">))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">skip</span> <span class="o">&amp;&amp;</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_ISO_CONTEXT_TRANSMIT</span> <span class="o">&amp;&amp;</span>
		    <span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">header_length</span> <span class="o">+</span> <span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">payload_length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">payload</span> <span class="o">+</span> <span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">payload_length</span> <span class="o">&gt;</span> <span class="n">buffer_end</span><span class="p">)</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">fw_iso_context_queue</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">,</span>
					 <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">payload</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="n">p</span> <span class="o">=</span> <span class="n">next</span><span class="p">;</span>
		<span class="n">payload</span> <span class="o">+=</span> <span class="n">u</span><span class="p">.</span><span class="n">packet</span><span class="p">.</span><span class="n">payload_length</span><span class="p">;</span>
		<span class="n">count</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">fw_iso_context_queue_flush</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">size</span>    <span class="o">-=</span> <span class="n">uptr_to_u64</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">-</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">packets</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">packets</span>  <span class="o">=</span> <span class="n">uptr_to_u64</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">data</span>     <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">+</span> <span class="n">payload</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_start_iso</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_start_iso</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">start_iso</span><span class="p">;</span>

	<span class="n">BUILD_BUG_ON</span><span class="p">(</span>
	    <span class="n">FW_CDEV_ISO_CONTEXT_MATCH_TAG0</span> <span class="o">!=</span> <span class="n">FW_ISO_CONTEXT_MATCH_TAG0</span> <span class="o">||</span>
	    <span class="n">FW_CDEV_ISO_CONTEXT_MATCH_TAG1</span> <span class="o">!=</span> <span class="n">FW_ISO_CONTEXT_MATCH_TAG1</span> <span class="o">||</span>
	    <span class="n">FW_CDEV_ISO_CONTEXT_MATCH_TAG2</span> <span class="o">!=</span> <span class="n">FW_ISO_CONTEXT_MATCH_TAG2</span> <span class="o">||</span>
	    <span class="n">FW_CDEV_ISO_CONTEXT_MATCH_TAG3</span> <span class="o">!=</span> <span class="n">FW_ISO_CONTEXT_MATCH_TAG3</span> <span class="o">||</span>
	    <span class="n">FW_CDEV_ISO_CONTEXT_MATCH_ALL_TAGS</span> <span class="o">!=</span> <span class="n">FW_ISO_CONTEXT_MATCH_ALL_TAGS</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">==</span> <span class="n">FW_ISO_CONTEXT_RECEIVE</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">tags</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">tags</span> <span class="o">&gt;</span> <span class="mi">15</span> <span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">sync</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fw_iso_context_start</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span><span class="p">,</span>
				    <span class="n">a</span><span class="o">-&gt;</span><span class="n">cycle</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">sync</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">tags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_stop_iso</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_stop_iso</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">stop_iso</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fw_iso_context_stop</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_flush_iso</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_flush_iso</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">flush_iso</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">fw_iso_context_flush_completions</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_get_cycle_timer2</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_get_cycle_timer2</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">get_cycle_timer2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">timespec</span> <span class="n">ts</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="n">u32</span> <span class="n">cycle_time</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">local_irq_disable</span><span class="p">();</span>

	<span class="n">cycle_time</span> <span class="o">=</span> <span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">read_csr</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="n">CSR_CYCLE_TIME</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">clk_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">CLOCK_REALTIME</span>:      <span class="n">getnstimeofday</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>                   <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOCK_MONOTONIC</span>:     <span class="n">do_posix_clock_monotonic_gettime</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">CLOCK_MONOTONIC_RAW</span>: <span class="n">getrawmonotonic</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ts</span><span class="p">);</span>                  <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_enable</span><span class="p">();</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">tv_sec</span>      <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_sec</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">tv_nsec</span>     <span class="o">=</span> <span class="n">ts</span><span class="p">.</span><span class="n">tv_nsec</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">cycle_timer</span> <span class="o">=</span> <span class="n">cycle_time</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_get_cycle_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_get_cycle_timer</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">get_cycle_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_get_cycle_timer2</span> <span class="n">ct2</span><span class="p">;</span>

	<span class="n">ct2</span><span class="p">.</span><span class="n">clk_id</span> <span class="o">=</span> <span class="n">CLOCK_REALTIME</span><span class="p">;</span>
	<span class="n">ioctl_get_cycle_timer2</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="p">(</span><span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ct2</span><span class="p">);</span>

	<span class="n">a</span><span class="o">-&gt;</span><span class="n">local_time</span> <span class="o">=</span> <span class="n">ct2</span><span class="p">.</span><span class="n">tv_sec</span> <span class="o">*</span> <span class="n">USEC_PER_SEC</span> <span class="o">+</span> <span class="n">ct2</span><span class="p">.</span><span class="n">tv_nsec</span> <span class="o">/</span> <span class="n">NSEC_PER_USEC</span><span class="p">;</span>
	<span class="n">a</span><span class="o">-&gt;</span><span class="n">cycle_timer</span> <span class="o">=</span> <span class="n">ct2</span><span class="p">.</span><span class="n">cycle_timer</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">iso_resource_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iso_resource_event</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iso_resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span>
			<span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iso_resource</span><span class="p">,</span> <span class="n">work</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">generation</span><span class="p">,</span> <span class="n">channel</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">,</span> <span class="n">todo</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">skip</span><span class="p">,</span> <span class="n">free</span><span class="p">,</span> <span class="n">success</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">generation</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">generation</span><span class="p">;</span>
	<span class="n">todo</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">todo</span><span class="p">;</span>
	<span class="cm">/* Allow 1000ms grace period for other reallocations. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_ALLOC</span> <span class="o">&amp;&amp;</span>
	    <span class="n">time_before64</span><span class="p">(</span><span class="n">get_jiffies_64</span><span class="p">(),</span>
			  <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">reset_jiffies</span> <span class="o">+</span> <span class="n">HZ</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">schedule_iso_resource</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">DIV_ROUND_UP</span><span class="p">(</span><span class="n">HZ</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
		<span class="n">skip</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* We could be called twice within the same generation. */</span>
		<span class="n">skip</span> <span class="o">=</span> <span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_REALLOC</span> <span class="o">&amp;&amp;</span>
		       <span class="n">r</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">==</span> <span class="n">generation</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">free</span> <span class="o">=</span> <span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_DEALLOC</span> <span class="o">||</span>
	       <span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_ALLOC_ONCE</span> <span class="o">||</span>
	       <span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_DEALLOC_ONCE</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">generation</span> <span class="o">=</span> <span class="n">generation</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skip</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">bandwidth</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">bandwidth</span><span class="p">;</span>

	<span class="n">fw_iso_resource_manage</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span> <span class="n">generation</span><span class="p">,</span>
			<span class="n">r</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">channel</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bandwidth</span><span class="p">,</span>
			<span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_ALLOC</span> <span class="o">||</span>
			<span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_REALLOC</span> <span class="o">||</span>
			<span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_ALLOC_ONCE</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Is this generation outdated already?  As long as this resource sticks</span>
<span class="cm">	 * in the idr, it will be scheduled again for a newer generation or at</span>
<span class="cm">	 * shutdown.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">channel</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_ALLOC</span> <span class="o">||</span> <span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_REALLOC</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">success</span> <span class="o">=</span> <span class="n">channel</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">bandwidth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * Transit from allocation to reallocation, except if the client</span>
<span class="cm">	 * requested deallocation in the meantime.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_ALLOC</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">todo</span> <span class="o">=</span> <span class="n">ISO_RES_REALLOC</span><span class="p">;</span>
	<span class="cm">/*</span>
<span class="cm">	 * Allocation or reallocation failure?  Pull this resource out of the</span>
<span class="cm">	 * idr and prepare for deletion, unless the client is shutting down.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_REALLOC</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">success</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">in_shutdown</span> <span class="o">&amp;&amp;</span>
	    <span class="n">idr_find</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">resource_idr</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">handle</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">idr_remove</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">resource_idr</span><span class="p">,</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">handle</span><span class="p">);</span>
		<span class="n">client_put</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
		<span class="n">free</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_ALLOC</span> <span class="o">&amp;&amp;</span> <span class="n">channel</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">=</span> <span class="mi">1ULL</span> <span class="o">&lt;&lt;</span> <span class="n">channel</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_REALLOC</span> <span class="o">&amp;&amp;</span> <span class="n">success</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_ALLOC</span> <span class="o">||</span> <span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_ALLOC_ONCE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">e_alloc</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">e_alloc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">e_dealloc</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">e_dealloc</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">iso_resource</span><span class="p">.</span><span class="n">handle</span>    <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">iso_resource</span><span class="p">.</span><span class="n">channel</span>   <span class="o">=</span> <span class="n">channel</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">iso_resource</span><span class="p">.</span><span class="n">bandwidth</span> <span class="o">=</span> <span class="n">bandwidth</span><span class="p">;</span>

	<span class="n">queue_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span>
		    <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">iso_resource</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">iso_resource</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">free</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cancel_delayed_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">e_alloc</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">e_dealloc</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">out:</span>
	<span class="n">client_put</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">release_iso_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">client_resource</span> <span class="o">*</span><span class="n">resource</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iso_resource</span> <span class="o">*</span><span class="n">r</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">resource</span><span class="p">,</span> <span class="k">struct</span> <span class="n">iso_resource</span><span class="p">,</span> <span class="n">resource</span><span class="p">);</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">todo</span> <span class="o">=</span> <span class="n">ISO_RES_DEALLOC</span><span class="p">;</span>
	<span class="n">schedule_iso_resource</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">init_iso_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">fw_cdev_allocate_iso_resource</span> <span class="o">*</span><span class="n">request</span><span class="p">,</span> <span class="kt">int</span> <span class="n">todo</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">iso_resource_event</span> <span class="o">*</span><span class="n">e1</span><span class="p">,</span> <span class="o">*</span><span class="n">e2</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">iso_resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">request</span><span class="o">-&gt;</span><span class="n">channels</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">request</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">&gt;</span> <span class="n">BANDWIDTH_AVAILABLE_INITIAL</span> <span class="o">||</span>
	    <span class="n">request</span><span class="o">-&gt;</span><span class="n">bandwidth</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">r</span>  <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">e1</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e1</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">e2</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e2</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">r</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">e1</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">e2</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_DELAYED_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">work</span><span class="p">,</span> <span class="n">iso_resource_work</span><span class="p">);</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">client</span>	<span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">todo</span>		<span class="o">=</span> <span class="n">todo</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">generation</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">channels</span>	<span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">channels</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">bandwidth</span>	<span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">bandwidth</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">e_alloc</span>	<span class="o">=</span> <span class="n">e1</span><span class="p">;</span>
	<span class="n">r</span><span class="o">-&gt;</span><span class="n">e_dealloc</span>	<span class="o">=</span> <span class="n">e2</span><span class="p">;</span>

	<span class="n">e1</span><span class="o">-&gt;</span><span class="n">iso_resource</span><span class="p">.</span><span class="n">closure</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">closure</span><span class="p">;</span>
	<span class="n">e1</span><span class="o">-&gt;</span><span class="n">iso_resource</span><span class="p">.</span><span class="n">type</span>    <span class="o">=</span> <span class="n">FW_CDEV_EVENT_ISO_RESOURCE_ALLOCATED</span><span class="p">;</span>
	<span class="n">e2</span><span class="o">-&gt;</span><span class="n">iso_resource</span><span class="p">.</span><span class="n">closure</span> <span class="o">=</span> <span class="n">request</span><span class="o">-&gt;</span><span class="n">closure</span><span class="p">;</span>
	<span class="n">e2</span><span class="o">-&gt;</span><span class="n">iso_resource</span><span class="p">.</span><span class="n">type</span>    <span class="o">=</span> <span class="n">FW_CDEV_EVENT_ISO_RESOURCE_DEALLOCATED</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">todo</span> <span class="o">==</span> <span class="n">ISO_RES_ALLOC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">release_iso_resource</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">add_client_resource</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">handle</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
		<span class="n">schedule_iso_resource</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">request</span><span class="o">-&gt;</span><span class="n">handle</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">.</span><span class="n">handle</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">fail:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">r</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">e1</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">e2</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_allocate_iso_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
				       <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">init_iso_resource</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">allocate_iso_resource</span><span class="p">,</span> <span class="n">ISO_RES_ALLOC</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_deallocate_iso_resource</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					 <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">release_client_resource</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
			<span class="n">arg</span><span class="o">-&gt;</span><span class="n">deallocate</span><span class="p">.</span><span class="n">handle</span><span class="p">,</span> <span class="n">release_iso_resource</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_allocate_iso_resource_once</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					    <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">init_iso_resource</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">allocate_iso_resource</span><span class="p">,</span> <span class="n">ISO_RES_ALLOC_ONCE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_deallocate_iso_resource_once</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					      <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">init_iso_resource</span><span class="p">(</span><span class="n">client</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">allocate_iso_resource</span><span class="p">,</span> <span class="n">ISO_RES_DEALLOC_ONCE</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Returns a speed code:  Maximum speed to or from this device,</span>
<span class="cm"> * limited by the device&#39;s link speed, the local node&#39;s link speed,</span>
<span class="cm"> * and all PHY port speeds between the two links.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_get_speed</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">max_speed</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_send_broadcast_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
					<span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_send_request</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">send_request</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">tcode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">TCODE_WRITE_QUADLET_REQUEST</span>:
	<span class="k">case</span> <span class="n">TCODE_WRITE_BLOCK_REQUEST</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Security policy: Only allow accesses to Units Space. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">&lt;</span> <span class="n">CSR_REGISTER_BASE</span> <span class="o">+</span> <span class="n">CSR_CONFIG_ROM_END</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">init_request</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">LOCAL_BUS</span> <span class="o">|</span> <span class="mh">0x3f</span><span class="p">,</span> <span class="n">SCODE_100</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_send_stream_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_send_stream_packet</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">send_stream_packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_cdev_send_request</span> <span class="n">request</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">dest</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">link_speed</span> <span class="o">||</span>
	    <span class="n">a</span><span class="o">-&gt;</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">1024</span> <span class="o">&lt;&lt;</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">tag</span> <span class="o">&gt;</span> <span class="mi">3</span> <span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">channel</span> <span class="o">&gt;</span> <span class="mi">63</span> <span class="o">||</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">sy</span> <span class="o">&gt;</span> <span class="mi">15</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dest</span> <span class="o">=</span> <span class="n">fw_stream_packet_destination_id</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">tag</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">channel</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">sy</span><span class="p">);</span>
	<span class="n">request</span><span class="p">.</span><span class="n">tcode</span>		<span class="o">=</span> <span class="n">TCODE_STREAM_DATA</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">length</span>		<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">length</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">closure</span>		<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">closure</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">data</span>		<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">;</span>
	<span class="n">request</span><span class="p">.</span><span class="n">generation</span>	<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">generation</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">init_request</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">request</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">outbound_phy_packet_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_packet</span> <span class="o">*</span><span class="n">packet</span><span class="p">,</span>
					 <span class="k">struct</span> <span class="n">fw_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">outbound_phy_packet_event</span> <span class="o">*</span><span class="n">e</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">packet</span><span class="p">,</span> <span class="k">struct</span> <span class="n">outbound_phy_packet_event</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">status</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* expected: */</span>
	<span class="k">case</span> <span class="n">ACK_COMPLETE</span>:	<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">rcode</span> <span class="o">=</span> <span class="n">RCODE_COMPLETE</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* should never happen with PHY packets: */</span>
	<span class="k">case</span> <span class="n">ACK_PENDING</span>:	<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">rcode</span> <span class="o">=</span> <span class="n">RCODE_COMPLETE</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACK_BUSY_X</span>:
	<span class="k">case</span> <span class="n">ACK_BUSY_A</span>:
	<span class="k">case</span> <span class="n">ACK_BUSY_B</span>:	<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">rcode</span> <span class="o">=</span> <span class="n">RCODE_BUSY</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACK_DATA_ERROR</span>:	<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">rcode</span> <span class="o">=</span> <span class="n">RCODE_DATA_ERROR</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ACK_TYPE_ERROR</span>:	<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">rcode</span> <span class="o">=</span> <span class="n">RCODE_TYPE_ERROR</span><span class="p">;</span>	<span class="k">break</span><span class="p">;</span>
	<span class="cm">/* stale generation; cancelled; on certain controllers: no ack */</span>
	<span class="nl">default:</span>		<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">rcode</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">packet</span><span class="o">-&gt;</span><span class="n">timestamp</span><span class="p">;</span>

	<span class="n">queue_event</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">,</span>
		    <span class="k">sizeof</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">)</span> <span class="o">+</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">length</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">client_put</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">client</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_send_phy_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_send_phy_packet</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">send_phy_packet</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">outbound_phy_packet_event</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>

	<span class="cm">/* Access policy: Allow this ioctl only on local nodes&#39; device files. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">is_local</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="n">e</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">client_get</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">client</span>		<span class="o">=</span> <span class="n">client</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">speed</span>		<span class="o">=</span> <span class="n">SCODE_100</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">generation</span>		<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">generation</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">header</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>		<span class="o">=</span> <span class="n">TCODE_LINK_INTERNAL</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>		<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>		<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">header_length</span>	<span class="o">=</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">.</span><span class="n">callback</span>		<span class="o">=</span> <span class="n">outbound_phy_packet_callback</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">closure</span>	<span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">closure</span><span class="p">;</span>
	<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">FW_CDEV_EVENT_PHY_PACKET_SENT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">is_ping_packet</span><span class="p">(</span><span class="n">a</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">length</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="n">card</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">send_request</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ioctl_receive_phy_packets</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">fw_cdev_receive_phy_packets</span> <span class="o">*</span><span class="n">a</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">arg</span><span class="o">-&gt;</span><span class="n">receive_phy_packets</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">fw_card</span> <span class="o">*</span><span class="n">card</span> <span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">;</span>

	<span class="cm">/* Access policy: Allow this ioctl only on local nodes&#39; device files. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">is_local</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">list_move_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">phy_receiver_link</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">phy_receiver_list</span><span class="p">);</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">phy_receiver_closure</span> <span class="o">=</span> <span class="n">a</span><span class="o">-&gt;</span><span class="n">closure</span><span class="p">;</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">fw_cdev_handle_phy_packet</span><span class="p">(</span><span class="k">struct</span> <span class="n">fw_card</span> <span class="o">*</span><span class="n">card</span><span class="p">,</span> <span class="k">struct</span> <span class="n">fw_packet</span> <span class="o">*</span><span class="n">p</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">inbound_phy_packet_event</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">phy_receiver_list</span><span class="p">,</span> <span class="n">phy_receiver_link</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">e</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="n">GFP_ATOMIC</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">e</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">fw_notice</span><span class="p">(</span><span class="n">card</span><span class="p">,</span> <span class="s">&quot;out of memory when allocating event</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">closure</span>	<span class="o">=</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">phy_receiver_closure</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">type</span>	<span class="o">=</span> <span class="n">FW_CDEV_EVENT_PHY_PACKET_RECEIVED</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">rcode</span>	<span class="o">=</span> <span class="n">RCODE_COMPLETE</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">length</span>	<span class="o">=</span> <span class="mi">8</span><span class="p">;</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>	<span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">.</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>	<span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">header</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">queue_event</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">event</span><span class="p">,</span>
			    <span class="o">&amp;</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">phy_packet</span><span class="p">)</span> <span class="o">+</span> <span class="mi">8</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span> <span class="k">const</span> <span class="n">ioctl_handlers</span><span class="p">[])(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="p">,</span> <span class="k">union</span> <span class="n">ioctl_arg</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">[</span><span class="mh">0x00</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_get_info</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x01</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_send_request</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x02</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_allocate</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x03</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_deallocate</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x04</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_send_response</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x05</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_initiate_bus_reset</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x06</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_add_descriptor</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x07</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_remove_descriptor</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x08</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_create_iso_context</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x09</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_queue_iso</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0a</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_start_iso</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0b</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_stop_iso</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0c</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_get_cycle_timer</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0d</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_allocate_iso_resource</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0e</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_deallocate_iso_resource</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x0f</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_allocate_iso_resource_once</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x10</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_deallocate_iso_resource_once</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x11</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_get_speed</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x12</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_send_broadcast_request</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x13</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_send_stream_packet</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x14</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_get_cycle_timer2</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x15</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_send_phy_packet</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x16</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_receive_phy_packets</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x17</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_set_iso_channels</span><span class="p">,</span>
	<span class="p">[</span><span class="mh">0x18</span><span class="p">]</span> <span class="o">=</span> <span class="n">ioctl_flush_iso</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">dispatch_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">,</span>
			  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">union</span> <span class="n">ioctl_arg</span> <span class="n">buffer</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw_device_is_shutdown</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_TYPE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">!=</span> <span class="sc">&#39;#&#39;</span> <span class="o">||</span>
	    <span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">ioctl_handlers</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buffer</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOTTY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">==</span> <span class="n">_IOC_READ</span><span class="p">)</span>
		<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_IOC_WRITE</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">arg</span><span class="p">,</span> <span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">ioctl_handlers</span><span class="p">[</span><span class="n">_IOC_NR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)](</span><span class="n">client</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">_IOC_DIR</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">_IOC_READ</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">copy_to_user</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">_IOC_SIZE</span><span class="p">(</span><span class="n">cmd</span><span class="p">)))</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">long</span> <span class="nf">fw_device_op_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dispatch_ioctl</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="p">(</span><span class="kt">void</span> <span class="n">__user</span> <span class="o">*</span><span class="p">)</span><span class="n">arg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_COMPAT</span>
<span class="k">static</span> <span class="kt">long</span> <span class="nf">fw_device_op_compat_ioctl</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span>
				      <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">cmd</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">dispatch_ioctl</span><span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">compat_ptr</span><span class="p">(</span><span class="n">arg</span><span class="p">));</span>
<span class="p">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fw_device_op_mmap</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">struct</span> <span class="n">vm_area_struct</span> <span class="o">*</span><span class="n">vma</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">size</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">page_count</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw_device_is_shutdown</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* FIXME: We could support multiple buffers, but we don&#39;t. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pages</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_flags</span> <span class="o">&amp;</span> <span class="n">VM_SHARED</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">client</span><span class="o">-&gt;</span><span class="n">vm_start</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="n">size</span> <span class="o">=</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_end</span> <span class="o">-</span> <span class="n">vma</span><span class="o">-&gt;</span><span class="n">vm_start</span><span class="p">;</span>
	<span class="n">page_count</span> <span class="o">=</span> <span class="n">size</span> <span class="o">&gt;&gt;</span> <span class="n">PAGE_SHIFT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">PAGE_MASK</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fw_iso_buffer_alloc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">page_count</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">fw_iso_buffer_map_dma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span>
				<span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">,</span>
				<span class="n">iso_dma_direction</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span><span class="p">));</span>
		<span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer_is_mapped</span> <span class="o">=</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">fw_iso_buffer_map_vma</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">vma</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">fail:</span>
	<span class="n">fw_iso_buffer_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">is_outbound_transaction_resource</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">client_resource</span> <span class="o">*</span><span class="n">resource</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">resource</span><span class="o">-&gt;</span><span class="n">release</span> <span class="o">==</span> <span class="n">release_transaction</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">has_outbound_transactions</span><span class="p">(</span><span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">idr_for_each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">resource_idr</span><span class="p">,</span>
			   <span class="n">is_outbound_transaction_resource</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">shutdown_resource</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">p</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">client_resource</span> <span class="o">*</span><span class="n">resource</span> <span class="o">=</span> <span class="n">p</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">resource</span><span class="o">-&gt;</span><span class="n">release</span><span class="p">(</span><span class="n">client</span><span class="p">,</span> <span class="n">resource</span><span class="p">);</span>
	<span class="n">client_put</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">fw_device_op_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event</span> <span class="o">*</span><span class="n">event</span><span class="p">,</span> <span class="o">*</span><span class="n">next_event</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">phy_receiver_link</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">client_list_mutex</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">link</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">client_list_mutex</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span><span class="p">)</span>
		<span class="n">fw_iso_context_destroy</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">iso_context</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">.</span><span class="n">pages</span><span class="p">)</span>
		<span class="n">fw_iso_buffer_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">buffer</span><span class="p">,</span> <span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="o">-&gt;</span><span class="n">card</span><span class="p">);</span>

	<span class="cm">/* Freeze client-&gt;resource_idr and client-&gt;event_list */</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">client</span><span class="o">-&gt;</span><span class="n">in_shutdown</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">wait_event</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">tx_flush_wait</span><span class="p">,</span> <span class="o">!</span><span class="n">has_outbound_transactions</span><span class="p">(</span><span class="n">client</span><span class="p">));</span>

	<span class="n">idr_for_each</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">resource_idr</span><span class="p">,</span> <span class="n">shutdown_resource</span><span class="p">,</span> <span class="n">client</span><span class="p">);</span>
	<span class="n">idr_remove_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">resource_idr</span><span class="p">);</span>
	<span class="n">idr_destroy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">resource_idr</span><span class="p">);</span>

	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">next_event</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">event_list</span><span class="p">,</span> <span class="n">link</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">event</span><span class="p">);</span>

	<span class="n">client_put</span><span class="p">(</span><span class="n">client</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">fw_device_op_poll</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="n">poll_table</span> <span class="o">*</span> <span class="n">pt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">client</span> <span class="o">*</span><span class="n">client</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">poll_wait</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">wait</span><span class="p">,</span> <span class="n">pt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fw_device_is_shutdown</span><span class="p">(</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">))</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLHUP</span> <span class="o">|</span> <span class="n">POLLERR</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">list_empty</span><span class="p">(</span><span class="o">&amp;</span><span class="n">client</span><span class="o">-&gt;</span><span class="n">event_list</span><span class="p">))</span>
		<span class="n">mask</span> <span class="o">|=</span> <span class="n">POLLIN</span> <span class="o">|</span> <span class="n">POLLRDNORM</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">fw_device_ops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">fw_device_op_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">fw_device_op_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">unlocked_ioctl</span>	<span class="o">=</span> <span class="n">fw_device_op_ioctl</span><span class="p">,</span>
	<span class="p">.</span><span class="n">mmap</span>		<span class="o">=</span> <span class="n">fw_device_op_mmap</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">fw_device_op_release</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>		<span class="o">=</span> <span class="n">fw_device_op_poll</span><span class="p">,</span>
<span class="cp">#ifdef CONFIG_COMPAT</span>
	<span class="p">.</span><span class="n">compat_ioctl</span>	<span class="o">=</span> <span class="n">fw_device_op_compat_ioctl</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
