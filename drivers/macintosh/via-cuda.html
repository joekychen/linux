<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › macintosh › via-cuda.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>via-cuda.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Device driver for the via-cuda on Apple Powermacs.</span>
<span class="cm"> *</span>
<span class="cm"> * The VIA (versatile interface adapter) interfaces to the CUDA,</span>
<span class="cm"> * a 6805 microprocessor core which controls the ADB (Apple Desktop</span>
<span class="cm"> * Bus) which connects to the keyboard and mouse.  The CUDA also</span>
<span class="cm"> * controls system power and the RTC (real time clock) chip.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1996 Paul Mackerras.</span>
<span class="cm"> */</span>
<span class="cp">#include &lt;stdarg.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/adb.h&gt;</span>
<span class="cp">#include &lt;linux/cuda.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#ifdef CONFIG_PPC</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#else</span>
<span class="cp">#include &lt;asm/macintosh.h&gt;</span>
<span class="cp">#include &lt;asm/macints.h&gt;</span>
<span class="cp">#include &lt;asm/mac_via.h&gt;</span>
<span class="cp">#endif</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>

<span class="k">static</span> <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">__iomem</span> <span class="o">*</span><span class="n">via</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">cuda_lock</span><span class="p">);</span>

<span class="cm">/* VIA registers - spaced 0x200 bytes apart */</span>
<span class="cp">#define RS		0x200		</span><span class="cm">/* skip between registers */</span><span class="cp"></span>
<span class="cp">#define B		0		</span><span class="cm">/* B-side data */</span><span class="cp"></span>
<span class="cp">#define A		RS		</span><span class="cm">/* A-side data */</span><span class="cp"></span>
<span class="cp">#define DIRB		(2*RS)		</span><span class="cm">/* B-side direction (1=output) */</span><span class="cp"></span>
<span class="cp">#define DIRA		(3*RS)		</span><span class="cm">/* A-side direction (1=output) */</span><span class="cp"></span>
<span class="cp">#define T1CL		(4*RS)		</span><span class="cm">/* Timer 1 ctr/latch (low 8 bits) */</span><span class="cp"></span>
<span class="cp">#define T1CH		(5*RS)		</span><span class="cm">/* Timer 1 counter (high 8 bits) */</span><span class="cp"></span>
<span class="cp">#define T1LL		(6*RS)		</span><span class="cm">/* Timer 1 latch (low 8 bits) */</span><span class="cp"></span>
<span class="cp">#define T1LH		(7*RS)		</span><span class="cm">/* Timer 1 latch (high 8 bits) */</span><span class="cp"></span>
<span class="cp">#define T2CL		(8*RS)		</span><span class="cm">/* Timer 2 ctr/latch (low 8 bits) */</span><span class="cp"></span>
<span class="cp">#define T2CH		(9*RS)		</span><span class="cm">/* Timer 2 counter (high 8 bits) */</span><span class="cp"></span>
<span class="cp">#define SR		(10*RS)		</span><span class="cm">/* Shift register */</span><span class="cp"></span>
<span class="cp">#define ACR		(11*RS)		</span><span class="cm">/* Auxiliary control register */</span><span class="cp"></span>
<span class="cp">#define PCR		(12*RS)		</span><span class="cm">/* Peripheral control register */</span><span class="cp"></span>
<span class="cp">#define IFR		(13*RS)		</span><span class="cm">/* Interrupt flag register */</span><span class="cp"></span>
<span class="cp">#define IER		(14*RS)		</span><span class="cm">/* Interrupt enable register */</span><span class="cp"></span>
<span class="cp">#define ANH		(15*RS)		</span><span class="cm">/* A-side data, no handshake */</span><span class="cp"></span>

<span class="cm">/* Bits in B data register: all active low */</span>
<span class="cp">#define TREQ		0x08		</span><span class="cm">/* Transfer request (input) */</span><span class="cp"></span>
<span class="cp">#define TACK		0x10		</span><span class="cm">/* Transfer acknowledge (output) */</span><span class="cp"></span>
<span class="cp">#define TIP		0x20		</span><span class="cm">/* Transfer in progress (output) */</span><span class="cp"></span>

<span class="cm">/* Bits in ACR */</span>
<span class="cp">#define SR_CTRL		0x1c		</span><span class="cm">/* Shift register control bits */</span><span class="cp"></span>
<span class="cp">#define SR_EXT		0x0c		</span><span class="cm">/* Shift on external clock */</span><span class="cp"></span>
<span class="cp">#define SR_OUT		0x10		</span><span class="cm">/* Shift out if 1 */</span><span class="cp"></span>

<span class="cm">/* Bits in IFR and IER */</span>
<span class="cp">#define IER_SET		0x80		</span><span class="cm">/* set bits in IER */</span><span class="cp"></span>
<span class="cp">#define IER_CLR		0		</span><span class="cm">/* clear bits in IER */</span><span class="cp"></span>
<span class="cp">#define SR_INT		0x04		</span><span class="cm">/* Shift register full/empty */</span><span class="cp"></span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">cuda_state</span> <span class="p">{</span>
    <span class="n">idle</span><span class="p">,</span>
    <span class="n">sent_first_byte</span><span class="p">,</span>
    <span class="n">sending</span><span class="p">,</span>
    <span class="n">reading</span><span class="p">,</span>
    <span class="n">read_done</span><span class="p">,</span>
    <span class="n">awaiting_reply</span>
<span class="p">}</span> <span class="n">cuda_state</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">current_req</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">last_req</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">cuda_rbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reply_ptr</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reading_reply</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">data_index</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cuda_irq</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">vias</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cuda_fully_inited</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_ADB</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cuda_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cuda_send_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sync</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cuda_adb_autopoll</span><span class="p">(</span><span class="kt">int</span> <span class="n">devs</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cuda_reset_adb_bus</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ADB */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">cuda_init_via</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cuda_start</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">cuda_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">cuda_input</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nb</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">cuda_poll</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cuda_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>

<span class="kt">int</span> <span class="n">cuda_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span>
		 <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="p">),</span> <span class="kt">int</span> <span class="n">nbytes</span><span class="p">,</span> <span class="p">...);</span>

<span class="cp">#ifdef CONFIG_ADB</span>
<span class="k">struct</span> <span class="n">adb_driver</span> <span class="n">via_cuda_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span>         <span class="o">=</span> <span class="s">&quot;CUDA&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span>        <span class="o">=</span> <span class="n">cuda_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">send_request</span> <span class="o">=</span> <span class="n">cuda_send_request</span><span class="p">,</span>
	<span class="p">.</span><span class="n">autopoll</span>     <span class="o">=</span> <span class="n">cuda_adb_autopoll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">poll</span>         <span class="o">=</span> <span class="n">cuda_poll</span><span class="p">,</span>
	<span class="p">.</span><span class="n">reset_bus</span>    <span class="o">=</span> <span class="n">cuda_reset_adb_bus</span><span class="p">,</span>
<span class="p">};</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ADB */</span><span class="cp"></span>

<span class="cp">#ifdef CONFIG_MAC</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">find_via_cuda</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">adb_request</span> <span class="n">req</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">adb_type</span> <span class="o">!=</span> <span class="n">MAC_ADB_CUDA</span><span class="p">)</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">via</span> <span class="o">=</span> <span class="n">via1</span><span class="p">;</span>
    <span class="n">cuda_state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">cuda_init_via</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cuda_init_via() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">via</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* enable autopoll */</span>
    <span class="n">cuda_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">CUDA_PACKET</span><span class="p">,</span> <span class="n">CUDA_AUTOPOLL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">)</span>
	<span class="n">cuda_poll</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="kt">int</span> <span class="n">__init</span> <span class="nf">find_via_cuda</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">adb_request</span> <span class="n">req</span><span class="p">;</span>
    <span class="n">phys_addr_t</span> <span class="n">taddr</span><span class="p">;</span>
    <span class="k">const</span> <span class="n">u32</span> <span class="o">*</span><span class="n">reg</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">vias</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">vias</span> <span class="o">=</span> <span class="n">of_find_node_by_name</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;via-cuda&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">vias</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">reg</span> <span class="o">=</span> <span class="n">of_get_property</span><span class="p">(</span><span class="n">vias</span><span class="p">,</span> <span class="s">&quot;reg&quot;</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;via-cuda: No </span><span class="se">\&quot;</span><span class="s">reg</span><span class="se">\&quot;</span><span class="s"> property !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">taddr</span> <span class="o">=</span> <span class="n">of_translate_address</span><span class="p">(</span><span class="n">vias</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">taddr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;via-cuda: Can&#39;t translate address !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">via</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">taddr</span><span class="p">,</span> <span class="mh">0x2000</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">via</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;via-cuda: Can&#39;t map address !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	    <span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">cuda_state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
    <span class="n">sys_ctrler</span> <span class="o">=</span> <span class="n">SYS_CTRLER_CUDA</span><span class="p">;</span>

    <span class="n">err</span> <span class="o">=</span> <span class="n">cuda_init_via</span><span class="p">();</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;cuda_init_via() failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">via</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Clear and enable interrupts, but only on PPC. On 68K it&#39;s done  */</span>
    <span class="cm">/* for us by the main VIA driver in arch/m68k/mac/via.c        */</span>

    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">],</span> <span class="mh">0x7f</span><span class="p">);</span>	<span class="cm">/* clear interrupts by writing 1s */</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">IER</span><span class="p">],</span> <span class="n">IER_SET</span><span class="o">|</span><span class="n">SR_INT</span><span class="p">);</span> <span class="cm">/* enable interrupt from SR */</span>

    <span class="cm">/* enable autopoll */</span>
    <span class="n">cuda_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">CUDA_PACKET</span><span class="p">,</span> <span class="n">CUDA_AUTOPOLL</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">)</span>
	<span class="n">cuda_poll</span><span class="p">();</span>

    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

 <span class="nl">fail:</span>
    <span class="n">of_node_put</span><span class="p">(</span><span class="n">vias</span><span class="p">);</span>
    <span class="n">vias</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* !defined CONFIG_MAC */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">via_cuda_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">via</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_MAC</span>
    <span class="n">cuda_irq</span> <span class="o">=</span> <span class="n">IRQ_MAC_ADB</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="n">cuda_irq</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">vias</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cuda_irq</span> <span class="o">==</span> <span class="n">NO_IRQ</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;via-cuda: can&#39;t map interrupts for %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">vias</span><span class="o">-&gt;</span><span class="n">full_name</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">cuda_irq</span><span class="p">,</span> <span class="n">cuda_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ADB&quot;</span><span class="p">,</span> <span class="n">cuda_interrupt</span><span class="p">))</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;via-cuda: can&#39;t request irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cuda_irq</span><span class="p">);</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;Macintosh CUDA driver v0.5 for Unified ADB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">cuda_fully_inited</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">device_initcall</span><span class="p">(</span><span class="n">via_cuda_start</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_ADB</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cuda_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">sys_ctrler</span> <span class="o">!=</span> <span class="n">SYS_CTRLER_CUDA</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="cp">#else</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">adb_type</span> <span class="o">!=</span> <span class="n">MAC_ADB_CUDA</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="cp">#endif</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">via</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ADB */</span><span class="cp"></span>

<span class="cp">#define WAIT_FOR(cond, what)					\</span>
<span class="cp">    do {                                                        \</span>
<span class="cp">    	int x;							\</span>
<span class="cp">	for (x = 1000; !(cond); --x) {				\</span>
<span class="cp">	    if (x == 0) {					\</span>
<span class="cp">		printk(&quot;Timeout waiting for &quot; what &quot;\n&quot;);	\</span>
<span class="cp">		return -ENXIO;					\</span>
<span class="cp">	    }							\</span>
<span class="cp">	    udelay(100);					\</span>
<span class="cp">	}							\</span>
<span class="cp">    } while (0)</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cuda_init_via</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">DIRB</span><span class="p">],</span> <span class="p">(</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">DIRB</span><span class="p">])</span> <span class="o">|</span> <span class="n">TACK</span> <span class="o">|</span> <span class="n">TIP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TREQ</span><span class="p">);</span>	<span class="cm">/* TACK &amp; TIP out */</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">|</span> <span class="n">TACK</span> <span class="o">|</span> <span class="n">TIP</span><span class="p">);</span>			<span class="cm">/* negate them */</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">]</span> <span class="p">,(</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SR_CTRL</span><span class="p">)</span> <span class="o">|</span> <span class="n">SR_EXT</span><span class="p">);</span>	<span class="cm">/* SR data in */</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">]);</span>						<span class="cm">/* clear any left-over data */</span>
<span class="cp">#ifdef CONFIG_PPC</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">IER</span><span class="p">],</span> <span class="mh">0x7f</span><span class="p">);</span>					<span class="cm">/* disable interrupts from VIA */</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">IER</span><span class="p">]);</span>
<span class="cp">#else</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">IER</span><span class="p">],</span> <span class="n">SR_INT</span><span class="p">);</span>					<span class="cm">/* disable SR interrupt from VIA */</span>
<span class="cp">#endif</span>

    <span class="cm">/* delay 4ms and then clear any pending interrupt */</span>
    <span class="n">mdelay</span><span class="p">(</span><span class="mi">4</span><span class="p">);</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">]);</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">],</span> <span class="n">SR_INT</span><span class="p">);</span>

    <span class="cm">/* sync with the CUDA - assert TACK without TIP */</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TACK</span><span class="p">);</span>

    <span class="cm">/* wait for the CUDA to assert TREQ in response */</span>
    <span class="n">WAIT_FOR</span><span class="p">((</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">TREQ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;CUDA response to sync&quot;</span><span class="p">);</span>

    <span class="cm">/* wait for the interrupt and then clear it */</span>
    <span class="n">WAIT_FOR</span><span class="p">(</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">SR_INT</span><span class="p">,</span> <span class="s">&quot;CUDA response to sync (2)&quot;</span><span class="p">);</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">]);</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">],</span> <span class="n">SR_INT</span><span class="p">);</span>

    <span class="cm">/* finish the sync by negating TACK */</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">|</span> <span class="n">TACK</span><span class="p">);</span>

    <span class="cm">/* wait for the CUDA to negate TREQ and the corresponding interrupt */</span>
    <span class="n">WAIT_FOR</span><span class="p">(</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">TREQ</span><span class="p">,</span> <span class="s">&quot;CUDA response to sync (3)&quot;</span><span class="p">);</span>
    <span class="n">WAIT_FOR</span><span class="p">(</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">SR_INT</span><span class="p">,</span> <span class="s">&quot;CUDA response to sync (4)&quot;</span><span class="p">);</span>
    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">]);</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">],</span> <span class="n">SR_INT</span><span class="p">);</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">|</span> <span class="n">TIP</span><span class="p">);</span>	<span class="cm">/* should be unnecessary */</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_ADB</span>
<span class="cm">/* Send an ADB command */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cuda_send_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sync</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">via</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">cuda_fully_inited</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
    <span class="p">}</span>
  
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_expected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

    <span class="n">i</span> <span class="o">=</span> <span class="n">cuda_write</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
	<span class="k">return</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sync</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">)</span>
	    <span class="n">cuda_poll</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* Enable/disable autopolling */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cuda_adb_autopoll</span><span class="p">(</span><span class="kt">int</span> <span class="n">devs</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">adb_request</span> <span class="n">req</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">via</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">cuda_fully_inited</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

    <span class="n">cuda_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">CUDA_PACKET</span><span class="p">,</span> <span class="n">CUDA_AUTOPOLL</span><span class="p">,</span> <span class="p">(</span><span class="n">devs</span><span class="o">?</span> <span class="mi">1</span><span class="o">:</span> <span class="mi">0</span><span class="p">));</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">)</span>
	<span class="n">cuda_poll</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Reset adb bus - how do we do this?? */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cuda_reset_adb_bus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">adb_request</span> <span class="n">req</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">((</span><span class="n">via</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">cuda_fully_inited</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>

    <span class="n">cuda_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">ADB_PACKET</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>		<span class="cm">/* maybe? */</span>
    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="p">.</span><span class="n">complete</span><span class="p">)</span>
	<span class="n">cuda_poll</span><span class="p">();</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ADB */</span><span class="cp"></span>
<span class="cm">/* Construct and send a cuda request */</span>
<span class="kt">int</span>
<span class="nf">cuda_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="p">),</span>
	     <span class="kt">int</span> <span class="n">nbytes</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
    <span class="kt">va_list</span> <span class="n">list</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">via</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">=</span> <span class="n">nbytes</span><span class="p">;</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
    <span class="n">va_start</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbytes</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
    <span class="n">va_end</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_expected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">cuda_write</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">cuda_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">CUDA_PACKET</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cuda_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">current_req</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">last_req</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">last_req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="n">current_req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="n">last_req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cuda_state</span> <span class="o">==</span> <span class="n">idle</span><span class="p">)</span>
	    <span class="n">cuda_start</span><span class="p">();</span>
    <span class="p">}</span>
    <span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cuda_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cuda_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

    <span class="cm">/* assert cuda_state == idle */</span>
    <span class="cm">/* get the packet to send */</span>
    <span class="n">req</span> <span class="o">=</span> <span class="n">current_req</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">TREQ</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span><span class="p">;</span>			<span class="cm">/* a byte is coming in from the CUDA */</span>

    <span class="cm">/* set the shift register to shift out and send a byte */</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">])</span> <span class="o">|</span> <span class="n">SR_OUT</span><span class="p">);</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">],</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIP</span><span class="p">);</span>
    <span class="n">cuda_state</span> <span class="o">=</span> <span class="n">sent_first_byte</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">cuda_poll</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* cuda_interrupt only takes a normal lock, we disable</span>
<span class="cm">     * interrupts here to avoid re-entering and thus deadlocking.</span>
<span class="cm">     */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cuda_irq</span><span class="p">)</span>
	<span class="n">disable_irq</span><span class="p">(</span><span class="n">cuda_irq</span><span class="p">);</span>
    <span class="n">cuda_interrupt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">cuda_irq</span><span class="p">)</span>
	<span class="n">enable_irq</span><span class="p">(</span><span class="n">cuda_irq</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">cuda_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">ibuf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
    <span class="kt">int</span> <span class="n">ibuf_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    
    <span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cuda_lock</span><span class="p">);</span>

    <span class="cm">/* On powermacs, this handler is registered for the VIA IRQ. But they use</span>
<span class="cm">     * just the shift register IRQ -- other VIA interrupt sources are disabled.</span>
<span class="cm">     * On m68k macs, the VIA IRQ sources are dispatched individually. Unless</span>
<span class="cm">     * we are polling, the shift register IRQ flag has already been cleared.</span>
<span class="cm">     */</span>

<span class="cp">#ifdef CONFIG_MAC</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">arg</span><span class="p">)</span>
<span class="cp">#endif</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">SR_INT</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
            <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cuda_lock</span><span class="p">);</span>
            <span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">],</span> <span class="n">SR_INT</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">status</span> <span class="o">=</span> <span class="p">(</span><span class="o">~</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TIP</span><span class="o">|</span><span class="n">TREQ</span><span class="p">))</span> <span class="o">|</span> <span class="p">(</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">])</span> <span class="o">&amp;</span> <span class="n">SR_OUT</span><span class="p">);</span>
    <span class="cm">/* printk(&quot;cuda_interrupt: state=%d status=%x\n&quot;, cuda_state, status); */</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">cuda_state</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">idle</span>:
	<span class="cm">/* CUDA has sent us the first byte of data - unsolicited */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">TREQ</span><span class="p">)</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;cuda: state=idle, status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">]);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIP</span><span class="p">);</span>
	<span class="n">cuda_state</span> <span class="o">=</span> <span class="n">reading</span><span class="p">;</span>
	<span class="n">reply_ptr</span> <span class="o">=</span> <span class="n">cuda_rbuf</span><span class="p">;</span>
	<span class="n">reading_reply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">awaiting_reply</span>:
	<span class="cm">/* CUDA has sent us the first byte of data of a reply */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">TREQ</span><span class="p">)</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;cuda: state=awaiting_reply, status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">]);</span>
	<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIP</span><span class="p">);</span>
	<span class="n">cuda_state</span> <span class="o">=</span> <span class="n">reading</span><span class="p">;</span>
	<span class="n">reply_ptr</span> <span class="o">=</span> <span class="n">current_req</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">;</span>
	<span class="n">reading_reply</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">sent_first_byte</span>:
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">TREQ</span> <span class="o">+</span> <span class="n">TIP</span> <span class="o">+</span> <span class="n">SR_OUT</span><span class="p">)</span> <span class="p">{</span>
	    <span class="cm">/* collision */</span>
	    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SR_OUT</span><span class="p">);</span>
	    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">]);</span>
	    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">|</span> <span class="n">TIP</span> <span class="o">|</span> <span class="n">TACK</span><span class="p">);</span>
	    <span class="n">cuda_state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="cm">/* assert status == TIP + SR_OUT */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">TIP</span> <span class="o">+</span> <span class="n">SR_OUT</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cuda: state=sent_first_byte status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">],</span> <span class="n">current_req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
	    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">^</span> <span class="n">TACK</span><span class="p">);</span>
	    <span class="n">data_index</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	    <span class="n">cuda_state</span> <span class="o">=</span> <span class="n">sending</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">sending</span>:
	<span class="n">req</span> <span class="o">=</span> <span class="n">current_req</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">data_index</span> <span class="o">&gt;=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SR_OUT</span><span class="p">);</span>
	    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">]);</span>
	    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">|</span> <span class="n">TACK</span> <span class="o">|</span> <span class="n">TIP</span><span class="p">);</span>
	    <span class="n">req</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_expected</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">cuda_state</span> <span class="o">=</span> <span class="n">awaiting_reply</span><span class="p">;</span>
	    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">current_req</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="cm">/* not sure about this */</span>
		<span class="n">cuda_state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
		<span class="n">cuda_start</span><span class="p">();</span>
	    <span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">],</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">data_index</span><span class="o">++</span><span class="p">]);</span>
	    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">^</span> <span class="n">TACK</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">reading</span>:
	<span class="o">*</span><span class="n">reply_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">TIP</span><span class="p">)</span> <span class="p">{</span>
	    <span class="cm">/* that&#39;s all folks */</span>
	    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">|</span> <span class="n">TACK</span> <span class="o">|</span> <span class="n">TIP</span><span class="p">);</span>
	    <span class="n">cuda_state</span> <span class="o">=</span> <span class="n">read_done</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="cm">/* assert status == TIP | TREQ */</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">TIP</span> <span class="o">+</span> <span class="n">TREQ</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cuda: state=reading status=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">^</span> <span class="n">TACK</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="k">case</span> <span class="n">read_done</span>:
	<span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reading_reply</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">req</span> <span class="o">=</span> <span class="n">current_req</span><span class="p">;</span>
	    <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">=</span> <span class="n">reply_ptr</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ADB_PACKET</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Have to adjust the reply from ADB commands */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">||</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		    <span class="cm">/* the 0x2 bit indicates no response */</span>
		    <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		    <span class="cm">/* leave just the command and result bytes in the reply */</span>
		    <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
		    <span class="n">memmove</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span><span class="p">);</span>
		<span class="p">}</span>
	    <span class="p">}</span>
	    <span class="n">current_req</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
	    <span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="cm">/* This is tricky. We must break the spinlock to call</span>
<span class="cm">	     * cuda_input. However, doing so means we might get</span>
<span class="cm">	     * re-entered from another CPU getting an interrupt</span>
<span class="cm">	     * or calling cuda_poll(). I ended up using the stack</span>
<span class="cm">	     * (it&#39;s only for 16 bytes) and moving the actual</span>
<span class="cm">	     * call to cuda_input to outside of the lock.</span>
<span class="cm">	     */</span>
	    <span class="n">ibuf_len</span> <span class="o">=</span> <span class="n">reply_ptr</span> <span class="o">-</span> <span class="n">cuda_rbuf</span><span class="p">;</span>
	    <span class="n">memcpy</span><span class="p">(</span><span class="n">ibuf</span><span class="p">,</span> <span class="n">cuda_rbuf</span><span class="p">,</span> <span class="n">ibuf_len</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">TREQ</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">],</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">])</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TIP</span><span class="p">);</span>
	    <span class="n">cuda_state</span> <span class="o">=</span> <span class="n">reading</span><span class="p">;</span>
	    <span class="n">reply_ptr</span> <span class="o">=</span> <span class="n">cuda_rbuf</span><span class="p">;</span>
	    <span class="n">reading_reply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="n">cuda_state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
	    <span class="n">cuda_start</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;cuda_interrupt: unknown cuda_state %d?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cuda_state</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cuda_lock</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">complete</span> <span class="o">&amp;&amp;</span> <span class="n">req</span><span class="p">)</span> <span class="p">{</span>
    	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="p">)</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">;</span>
    	<span class="n">mb</span><span class="p">();</span>
    	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    	<span class="cm">/* Here, we assume that if the request has a done member, the</span>
<span class="cm">    	 * struct request will survive to setting req-&gt;complete to 1</span>
<span class="cm">    	 */</span>
    	<span class="k">if</span> <span class="p">(</span><span class="n">done</span><span class="p">)</span>
		<span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="n">req</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ibuf_len</span><span class="p">)</span>
	<span class="n">cuda_input</span><span class="p">(</span><span class="n">ibuf</span><span class="p">,</span> <span class="n">ibuf_len</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">cuda_input</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ADB_PACKET</span>:
<span class="cp">#ifdef CONFIG_XMON</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nb</span> <span class="o">==</span> <span class="mi">5</span> <span class="o">&amp;&amp;</span> <span class="n">buf</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x2c</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">extern</span> <span class="kt">int</span> <span class="n">xmon_wants_key</span><span class="p">,</span> <span class="n">xmon_adb_keycode</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">xmon_wants_key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">xmon_adb_keycode</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">3</span><span class="p">];</span>
		<span class="k">return</span><span class="p">;</span>
	    <span class="p">}</span>
	<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_XMON */</span><span class="cp"></span>
<span class="cp">#ifdef CONFIG_ADB</span>
	<span class="n">adb_input</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">nb</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_ADB */</span><span class="cp"></span>
	<span class="k">break</span><span class="p">;</span>

    <span class="nl">default:</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;data from cuda (%d bytes):&quot;</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot; %.2x&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
