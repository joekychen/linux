<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › macintosh › windfarm_pm81.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>windfarm_pm81.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Windfarm PowerMac thermal control. iMac G5</span>
<span class="cm"> *</span>
<span class="cm"> * (c) Copyright 2005 Benjamin Herrenschmidt, IBM Corp.</span>
<span class="cm"> *                    &lt;benh@kernel.crashing.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Released under the term of the GNU GPL v2.</span>
<span class="cm"> *</span>
<span class="cm"> * The algorithm used is the PID control algorithm, used the same</span>
<span class="cm"> * way the published Darwin code does, using the same values that</span>
<span class="cm"> * are present in the Darwin 8.2 snapshot property lists (note however</span>
<span class="cm"> * that none of the code has been re-used, it&#39;s a complete re-implementation</span>
<span class="cm"> *</span>
<span class="cm"> * The various control loops found in Darwin config file are:</span>
<span class="cm"> *</span>
<span class="cm"> * PowerMac8,1 and PowerMac8,2</span>
<span class="cm"> * ===========================</span>
<span class="cm"> *</span>
<span class="cm"> * System Fans control loop. Different based on models. In addition to the</span>
<span class="cm"> * usual PID algorithm, the control loop gets 2 additional pairs of linear</span>
<span class="cm"> * scaling factors (scale/offsets) expressed as 4.12 fixed point values</span>
<span class="cm"> * signed offset, unsigned scale)</span>
<span class="cm"> *</span>
<span class="cm"> * The targets are modified such as:</span>
<span class="cm"> *  - the linked control (second control) gets the target value as-is</span>
<span class="cm"> *    (typically the drive fan)</span>
<span class="cm"> *  - the main control (first control) gets the target value scaled with</span>
<span class="cm"> *    the first pair of factors, and is then modified as below</span>
<span class="cm"> *  - the value of the target of the CPU Fan control loop is retrieved,</span>
<span class="cm"> *    scaled with the second pair of factors, and the max of that and</span>
<span class="cm"> *    the scaled target is applied to the main control.</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 2</span>
<span class="cm"> *   controls       : system-fan, drive-bay-fan</span>
<span class="cm"> *   sensors        : hd-temp</span>
<span class="cm"> *   PID params     : G_d = 0x15400000</span>
<span class="cm"> *                    G_p = 0x00200000</span>
<span class="cm"> *                    G_r = 0x000002fd</span>
<span class="cm"> *                    History = 2 entries</span>
<span class="cm"> *                    Input target = 0x3a0000</span>
<span class="cm"> *                    Interval = 5s</span>
<span class="cm"> *   linear-factors : offset = 0xff38 scale  = 0x0ccd</span>
<span class="cm"> *                    offset = 0x0208 scale  = 0x07ae</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 3</span>
<span class="cm"> *   controls       : system-fan, drive-bay-fan</span>
<span class="cm"> *   sensors        : hd-temp</span>
<span class="cm"> *   PID params     : G_d = 0x08e00000</span>
<span class="cm"> *                    G_p = 0x00566666</span>
<span class="cm"> *                    G_r = 0x0000072b</span>
<span class="cm"> *                    History = 2 entries</span>
<span class="cm"> *                    Input target = 0x350000</span>
<span class="cm"> *                    Interval = 5s</span>
<span class="cm"> *   linear-factors : offset = 0xff38 scale  = 0x0ccd</span>
<span class="cm"> *                    offset = 0x0000 scale  = 0x0000</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 5</span>
<span class="cm"> *   controls       : system-fan</span>
<span class="cm"> *   sensors        : hd-temp</span>
<span class="cm"> *   PID params     : G_d = 0x15400000</span>
<span class="cm"> *                    G_p = 0x00233333</span>
<span class="cm"> *                    G_r = 0x000002fd</span>
<span class="cm"> *                    History = 2 entries</span>
<span class="cm"> *                    Input target = 0x3a0000</span>
<span class="cm"> *                    Interval = 5s</span>
<span class="cm"> *   linear-factors : offset = 0x0000 scale  = 0x1000</span>
<span class="cm"> *                    offset = 0x0091 scale  = 0x0bae</span>
<span class="cm"> *</span>
<span class="cm"> * CPU Fan control loop. The loop is identical for all models. it</span>
<span class="cm"> * has an additional pair of scaling factor. This is used to scale the</span>
<span class="cm"> * systems fan control loop target result (the one before it gets scaled</span>
<span class="cm"> * by the System Fans control loop itself). Then, the max value of the</span>
<span class="cm"> * calculated target value and system fan value is sent to the fans</span>
<span class="cm"> *</span>
<span class="cm"> *   controls       : cpu-fan</span>
<span class="cm"> *   sensors        : cpu-temp cpu-power</span>
<span class="cm"> *   PID params     : From SMU sdb partition</span>
<span class="cm"> *   linear-factors : offset = 0xfb50 scale  = 0x1000</span>
<span class="cm"> *</span>
<span class="cm"> * CPU Slew control loop. Not implemented. The cpufreq driver in linux is</span>
<span class="cm"> * completely separate for now, though we could find a way to link it, either</span>
<span class="cm"> * as a client reacting to overtemp notifications, or directling monitoring</span>
<span class="cm"> * the CPU temperature</span>
<span class="cm"> *</span>
<span class="cm"> * WARNING ! The CPU control loop requires the CPU tmax for the current</span>
<span class="cm"> * operating point. However, we currently are completely separated from</span>
<span class="cm"> * the cpufreq driver and thus do not know what the current operating</span>
<span class="cm"> * point is. Fortunately, we also do not have any hardware supporting anything</span>
<span class="cm"> * but operating point 0 at the moment, thus we just peek that value directly</span>
<span class="cm"> * from the SDB partition. If we ever end up with actually slewing the system</span>
<span class="cm"> * clock and thus changing operating points, we&#39;ll have to find a way to</span>
<span class="cm"> * communicate with the CPU freq driver;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/smu.h&gt;</span>

<span class="cp">#include &quot;windfarm.h&quot;</span>
<span class="cp">#include &quot;windfarm_pid.h&quot;</span>

<span class="cp">#define VERSION &quot;0.4&quot;</span>

<span class="cp">#undef DEBUG</span>

<span class="cp">#ifdef DEBUG</span>
<span class="cp">#define DBG(args...)	printk(args)</span>
<span class="cp">#else</span>
<span class="cp">#define DBG(args...)	do { } while(0)</span>
<span class="cp">#endif</span>

<span class="cm">/* define this to force CPU overtemp to 74 degree, useful for testing</span>
<span class="cm"> * the overtemp code</span>
<span class="cm"> */</span>
<span class="cp">#undef HACKED_OVERTEMP</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">wf_smu_mach_model</span><span class="p">;</span>	<span class="cm">/* machine model id */</span>

<span class="cm">/* Controls &amp; sensors */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_sensor</span>	<span class="o">*</span><span class="n">sensor_cpu_power</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_sensor</span>	<span class="o">*</span><span class="n">sensor_cpu_temp</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_sensor</span>	<span class="o">*</span><span class="n">sensor_hd_temp</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_control</span> <span class="o">*</span><span class="n">fan_cpu_main</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_control</span> <span class="o">*</span><span class="n">fan_hd</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_control</span> <span class="o">*</span><span class="n">fan_system</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_control</span> <span class="o">*</span><span class="n">cpufreq_clamp</span><span class="p">;</span>

<span class="cm">/* Set to kick the control loop into life */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wf_smu_all_controls_ok</span><span class="p">,</span> <span class="n">wf_smu_all_sensors_ok</span><span class="p">,</span> <span class="n">wf_smu_started</span><span class="p">;</span>

<span class="cm">/* Failure handling.. could be nicer */</span>
<span class="cp">#define FAILURE_FAN		0x01</span>
<span class="cp">#define FAILURE_SENSOR		0x02</span>
<span class="cp">#define FAILURE_OVERTEMP	0x04</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">wf_smu_failure_state</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wf_smu_readjust</span><span class="p">,</span> <span class="n">wf_smu_skipping</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * ****** System Fans Control Loop ******</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* Parameters for the System Fans control loop. Parameters</span>
<span class="cm"> * not in this table such as interval, history size, ...</span>
<span class="cm"> * are common to all versions and thus hard coded for now.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wf_smu_sys_fans_param</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">model_id</span><span class="p">;</span>
	<span class="n">s32</span>	<span class="n">itarget</span><span class="p">;</span>
	<span class="n">s32</span>	<span class="n">gd</span><span class="p">,</span> <span class="n">gp</span><span class="p">,</span> <span class="n">gr</span><span class="p">;</span>

	<span class="n">s16</span>	<span class="n">offset0</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">scale0</span><span class="p">;</span>
	<span class="n">s16</span>	<span class="n">offset1</span><span class="p">;</span>
	<span class="n">u16</span>	<span class="n">scale1</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define WF_SMU_SYS_FANS_INTERVAL	5</span>
<span class="cp">#define WF_SMU_SYS_FANS_HISTORY_SIZE	2</span>

<span class="cm">/* State data used by the system fans control loop</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wf_smu_sys_fans_state</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">ticks</span><span class="p">;</span>
	<span class="n">s32</span>			<span class="n">sys_setpoint</span><span class="p">;</span>
	<span class="n">s32</span>			<span class="n">hd_setpoint</span><span class="p">;</span>
	<span class="n">s16</span>			<span class="n">offset0</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">scale0</span><span class="p">;</span>
	<span class="n">s16</span>			<span class="n">offset1</span><span class="p">;</span>
	<span class="n">u16</span>			<span class="n">scale1</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wf_pid_state</span>	<span class="n">pid</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * Configs for SMU System Fan control loop</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_smu_sys_fans_param</span> <span class="n">wf_smu_sys_all_params</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Model ID 2 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">model_id</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		<span class="p">.</span><span class="n">itarget</span>	<span class="o">=</span> <span class="mh">0x3a0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gd</span>		<span class="o">=</span> <span class="mh">0x15400000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gp</span>		<span class="o">=</span> <span class="mh">0x00200000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gr</span>		<span class="o">=</span> <span class="mh">0x000002fd</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset0</span>	<span class="o">=</span> <span class="mh">0xff38</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scale0</span>		<span class="o">=</span> <span class="mh">0x0ccd</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset1</span>	<span class="o">=</span> <span class="mh">0x0208</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scale1</span>		<span class="o">=</span> <span class="mh">0x07ae</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Model ID 3 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">model_id</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		<span class="p">.</span><span class="n">itarget</span>	<span class="o">=</span> <span class="mh">0x350000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gd</span>		<span class="o">=</span> <span class="mh">0x08e00000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gp</span>		<span class="o">=</span> <span class="mh">0x00566666</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gr</span>		<span class="o">=</span> <span class="mh">0x0000072b</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset0</span>	<span class="o">=</span> <span class="mh">0xff38</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scale0</span>		<span class="o">=</span> <span class="mh">0x0ccd</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset1</span>	<span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scale1</span>		<span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="cm">/* Model ID 5 */</span>
	<span class="p">{</span>
		<span class="p">.</span><span class="n">model_id</span>	<span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
		<span class="p">.</span><span class="n">itarget</span>	<span class="o">=</span> <span class="mh">0x3a0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gd</span>		<span class="o">=</span> <span class="mh">0x15400000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gp</span>		<span class="o">=</span> <span class="mh">0x00233333</span><span class="p">,</span>
		<span class="p">.</span><span class="n">gr</span>		<span class="o">=</span> <span class="mh">0x000002fd</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset0</span>	<span class="o">=</span> <span class="mh">0x0000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scale0</span>		<span class="o">=</span> <span class="mh">0x1000</span><span class="p">,</span>
		<span class="p">.</span><span class="n">offset1</span>	<span class="o">=</span> <span class="mh">0x0091</span><span class="p">,</span>
		<span class="p">.</span><span class="n">scale1</span>		<span class="o">=</span> <span class="mh">0x0bae</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>
<span class="cp">#define WF_SMU_SYS_FANS_NUM_CONFIGS ARRAY_SIZE(wf_smu_sys_all_params)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_smu_sys_fans_state</span> <span class="o">*</span><span class="n">wf_smu_sys_fans</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * ****** CPU Fans Control Loop ******</span>
<span class="cm"> *</span>
<span class="cm"> */</span>


<span class="cp">#define WF_SMU_CPU_FANS_INTERVAL	1</span>
<span class="cp">#define WF_SMU_CPU_FANS_MAX_HISTORY	16</span>
<span class="cp">#define WF_SMU_CPU_FANS_SIBLING_SCALE	0x00001000</span>
<span class="cp">#define WF_SMU_CPU_FANS_SIBLING_OFFSET	0xfffffb50</span>

<span class="cm">/* State data used by the cpu fans control loop</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">wf_smu_cpu_fans_state</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">ticks</span><span class="p">;</span>
	<span class="n">s32</span>			<span class="n">cpu_setpoint</span><span class="p">;</span>
	<span class="n">s32</span>			<span class="n">scale</span><span class="p">;</span>
	<span class="n">s32</span>			<span class="n">offset</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wf_cpu_pid_state</span>	<span class="n">pid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_smu_cpu_fans_state</span> <span class="o">*</span><span class="n">wf_smu_cpu_fans</span><span class="p">;</span>



<span class="cm">/*</span>
<span class="cm"> * ***** Implementation *****</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wf_smu_create_sys_fans</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wf_smu_sys_fans_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wf_pid_param</span> <span class="n">pid_param</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* First, locate the params for this model */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">WF_SMU_SYS_FANS_NUM_CONFIGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wf_smu_sys_all_params</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">model_id</span> <span class="o">==</span> <span class="n">wf_smu_mach_model</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">wf_smu_sys_all_params</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

	<span class="cm">/* No params found, put fans to max */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;windfarm: System fan config not found &quot;</span>
		       <span class="s">&quot;for this machine model, max fan speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Alloc &amp; initialize state */</span>
	<span class="n">wf_smu_sys_fans</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wf_smu_sys_fans_state</span><span class="p">),</span>
				  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wf_smu_sys_fans</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;windfarm: Memory allocation error&quot;</span>
		       <span class="s">&quot; max fan speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">wf_smu_sys_fans</span><span class="o">-&gt;</span><span class="n">ticks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">wf_smu_sys_fans</span><span class="o">-&gt;</span><span class="n">scale0</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">scale0</span><span class="p">;</span>
	<span class="n">wf_smu_sys_fans</span><span class="o">-&gt;</span><span class="n">offset0</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">offset0</span><span class="p">;</span>
	<span class="n">wf_smu_sys_fans</span><span class="o">-&gt;</span><span class="n">scale1</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">scale1</span><span class="p">;</span>
	<span class="n">wf_smu_sys_fans</span><span class="o">-&gt;</span><span class="n">offset1</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">offset1</span><span class="p">;</span>

	<span class="cm">/* Fill PID params */</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">gd</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">gp</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">gp</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">gr</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">gr</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">WF_SMU_SYS_FANS_INTERVAL</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">history_len</span> <span class="o">=</span> <span class="n">WF_SMU_SYS_FANS_HISTORY_SIZE</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">itarget</span> <span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">itarget</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">wf_control_get_min</span><span class="p">(</span><span class="n">fan_system</span><span class="p">);</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">wf_control_get_max</span><span class="p">(</span><span class="n">fan_system</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fan_hd</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pid_param</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span>
			<span class="n">max</span><span class="p">(</span><span class="n">pid_param</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">wf_control_get_min</span><span class="p">(</span><span class="n">fan_hd</span><span class="p">));</span>
		<span class="n">pid_param</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span>
			<span class="n">min</span><span class="p">(</span><span class="n">pid_param</span><span class="p">.</span><span class="n">max</span><span class="p">,</span> <span class="n">wf_control_get_max</span><span class="p">(</span><span class="n">fan_hd</span><span class="p">));</span>
	<span class="p">}</span>
	<span class="n">wf_pid_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wf_smu_sys_fans</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid_param</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;wf: System Fan control initialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;    itarged=%d.%03d, min=%d RPM, max=%d RPM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">FIX32TOPRINT</span><span class="p">(</span><span class="n">pid_param</span><span class="p">.</span><span class="n">itarget</span><span class="p">),</span> <span class="n">pid_param</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">pid_param</span><span class="p">.</span><span class="n">max</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">fail:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fan_system</span><span class="p">)</span>
		<span class="n">wf_control_set_max</span><span class="p">(</span><span class="n">fan_system</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fan_hd</span><span class="p">)</span>
		<span class="n">wf_control_set_max</span><span class="p">(</span><span class="n">fan_hd</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wf_smu_sys_fans_tick</span><span class="p">(</span><span class="k">struct</span> <span class="n">wf_smu_sys_fans_state</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">new_setpoint</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">scaled</span><span class="p">,</span> <span class="n">cputarget</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ticks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wf_smu_readjust</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">readjust</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ticks</span> <span class="o">=</span> <span class="n">WF_SMU_SYS_FANS_INTERVAL</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">wf_sensor_get</span><span class="p">(</span><span class="n">sensor_hd_temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;windfarm: HD temp sensor error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rc</span><span class="p">);</span>
		<span class="n">wf_smu_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_SENSOR</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;wf_smu: System Fans tick ! HD temp: %d.%03d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">FIX32TOPRINT</span><span class="p">(</span><span class="n">temp</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">itarget</span> <span class="o">+</span> <span class="mh">0x50000</span><span class="p">))</span>
		<span class="n">wf_smu_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_OVERTEMP</span><span class="p">;</span>

	<span class="n">new_setpoint</span> <span class="o">=</span> <span class="n">wf_pid_run</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;wf_smu: new_setpoint: %d RPM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">new_setpoint</span><span class="p">);</span>

	<span class="n">scaled</span> <span class="o">=</span> <span class="p">((((</span><span class="n">s64</span><span class="p">)</span><span class="n">new_setpoint</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">scale0</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">offset0</span><span class="p">;</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;wf_smu: scaled setpoint: %d RPM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">scaled</span><span class="p">);</span>

	<span class="n">cputarget</span> <span class="o">=</span> <span class="n">wf_smu_cpu_fans</span> <span class="o">?</span> <span class="n">wf_smu_cpu_fans</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">.</span><span class="n">target</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">cputarget</span> <span class="o">=</span> <span class="p">((((</span><span class="n">s64</span><span class="p">)</span><span class="n">cputarget</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">scale1</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">+</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">offset1</span><span class="p">;</span>
	<span class="n">scaled</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">scaled</span><span class="p">,</span> <span class="n">cputarget</span><span class="p">);</span>
	<span class="n">scaled</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">scaled</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">min</span><span class="p">);</span>
	<span class="n">scaled</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">scaled</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">max</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;wf_smu: adjusted setpoint: %d RPM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">scaled</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">sys_setpoint</span> <span class="o">==</span> <span class="n">scaled</span> <span class="o">&amp;&amp;</span> <span class="n">new_setpoint</span> <span class="o">==</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">hd_setpoint</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">sys_setpoint</span> <span class="o">=</span> <span class="n">scaled</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">hd_setpoint</span> <span class="o">=</span> <span class="n">new_setpoint</span><span class="p">;</span>
 <span class="nl">readjust:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fan_system</span> <span class="o">&amp;&amp;</span> <span class="n">wf_smu_failure_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">wf_control_set</span><span class="p">(</span><span class="n">fan_system</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">sys_setpoint</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;windfarm: Sys fan error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">rc</span><span class="p">);</span>
			<span class="n">wf_smu_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_FAN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fan_hd</span> <span class="o">&amp;&amp;</span> <span class="n">wf_smu_failure_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">wf_control_set</span><span class="p">(</span><span class="n">fan_hd</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">hd_setpoint</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;windfarm: HD fan error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">rc</span><span class="p">);</span>
			<span class="n">wf_smu_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_FAN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wf_smu_create_cpu_fans</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wf_cpu_pid_param</span> <span class="n">pid_param</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">smu_sdbp_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smu_sdbp_cpupiddata</span> <span class="o">*</span><span class="n">piddata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smu_sdbp_fvt</span> <span class="o">*</span><span class="n">fvt</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">tdelta</span><span class="p">,</span> <span class="n">maxpow</span><span class="p">,</span> <span class="n">powadj</span><span class="p">;</span>

	<span class="cm">/* First, locate the PID params in SMU SBD */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="n">smu_get_sdb_partition</span><span class="p">(</span><span class="n">SMU_SDB_CPUPIDDATA_ID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;windfarm: CPU PID fan config not found &quot;</span>
		       <span class="s">&quot;max fan speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">piddata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smu_sdbp_cpupiddata</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* Get the FVT params for operating point 0 (the only supported one</span>
<span class="cm">	 * for now) in order to get tmax</span>
<span class="cm">	 */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="n">smu_get_sdb_partition</span><span class="p">(</span><span class="n">SMU_SDB_FVT_ID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fvt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smu_sdbp_fvt</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">tmax</span> <span class="o">=</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span><span class="n">fvt</span><span class="o">-&gt;</span><span class="n">maxtemp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tmax</span> <span class="o">=</span> <span class="mh">0x5e0000</span><span class="p">;</span> <span class="cm">/* 94 degree default */</span>

	<span class="cm">/* Alloc &amp; initialize state */</span>
	<span class="n">wf_smu_cpu_fans</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">wf_smu_cpu_fans_state</span><span class="p">),</span>
				  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wf_smu_cpu_fans</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
       	<span class="n">wf_smu_cpu_fans</span><span class="o">-&gt;</span><span class="n">ticks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">wf_smu_cpu_fans</span><span class="o">-&gt;</span><span class="n">scale</span> <span class="o">=</span> <span class="n">WF_SMU_CPU_FANS_SIBLING_SCALE</span><span class="p">;</span>
	<span class="n">wf_smu_cpu_fans</span><span class="o">-&gt;</span><span class="n">offset</span> <span class="o">=</span> <span class="n">WF_SMU_CPU_FANS_SIBLING_OFFSET</span><span class="p">;</span>

	<span class="cm">/* Fill PID params */</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">WF_SMU_CPU_FANS_INTERVAL</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">history_len</span> <span class="o">=</span> <span class="n">piddata</span><span class="o">-&gt;</span><span class="n">history_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid_param</span><span class="p">.</span><span class="n">history_len</span> <span class="o">&gt;</span> <span class="n">WF_CPU_PID_MAX_HISTORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;windfarm: History size overflow on &quot;</span>
		       <span class="s">&quot;CPU control loop (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">piddata</span><span class="o">-&gt;</span><span class="n">history_len</span><span class="p">);</span>
		<span class="n">pid_param</span><span class="p">.</span><span class="n">history_len</span> <span class="o">=</span> <span class="n">WF_CPU_PID_MAX_HISTORY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">gd</span> <span class="o">=</span> <span class="n">piddata</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">gp</span> <span class="o">=</span> <span class="n">piddata</span><span class="o">-&gt;</span><span class="n">gp</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">gr</span> <span class="o">=</span> <span class="n">piddata</span><span class="o">-&gt;</span><span class="n">gr</span> <span class="o">/</span> <span class="n">pid_param</span><span class="p">.</span><span class="n">history_len</span><span class="p">;</span>

	<span class="n">tdelta</span> <span class="o">=</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span><span class="n">piddata</span><span class="o">-&gt;</span><span class="n">target_temp_delta</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">maxpow</span> <span class="o">=</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span><span class="n">piddata</span><span class="o">-&gt;</span><span class="n">max_power</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">powadj</span> <span class="o">=</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span><span class="n">piddata</span><span class="o">-&gt;</span><span class="n">power_adj</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">pid_param</span><span class="p">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">tmax</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">ttarget</span> <span class="o">=</span> <span class="n">tmax</span> <span class="o">-</span> <span class="n">tdelta</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">pmaxadj</span> <span class="o">=</span> <span class="n">maxpow</span> <span class="o">-</span> <span class="n">powadj</span><span class="p">;</span>

	<span class="n">pid_param</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">wf_control_get_min</span><span class="p">(</span><span class="n">fan_cpu_main</span><span class="p">);</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">wf_control_get_max</span><span class="p">(</span><span class="n">fan_cpu_main</span><span class="p">);</span>

	<span class="n">wf_cpu_pid_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wf_smu_cpu_fans</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid_param</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;wf: CPU Fan control initialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;    ttarged=%d.%03d, tmax=%d.%03d, min=%d RPM, max=%d RPM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">FIX32TOPRINT</span><span class="p">(</span><span class="n">pid_param</span><span class="p">.</span><span class="n">ttarget</span><span class="p">),</span> <span class="n">FIX32TOPRINT</span><span class="p">(</span><span class="n">pid_param</span><span class="p">.</span><span class="n">tmax</span><span class="p">),</span>
	    <span class="n">pid_param</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">pid_param</span><span class="p">.</span><span class="n">max</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;windfarm: CPU fan config not found</span><span class="se">\n</span><span class="s">&quot;</span>
	       <span class="s">&quot;for this machine model, max fan speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_clamp</span><span class="p">)</span>
		<span class="n">wf_control_set_max</span><span class="p">(</span><span class="n">cpufreq_clamp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fan_cpu_main</span><span class="p">)</span>
		<span class="n">wf_control_set_max</span><span class="p">(</span><span class="n">fan_cpu_main</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wf_smu_cpu_fans_tick</span><span class="p">(</span><span class="k">struct</span> <span class="n">wf_smu_cpu_fans_state</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">new_setpoint</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">systarget</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ticks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wf_smu_readjust</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">readjust</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ticks</span> <span class="o">=</span> <span class="n">WF_SMU_CPU_FANS_INTERVAL</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">wf_sensor_get</span><span class="p">(</span><span class="n">sensor_cpu_temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;windfarm: CPU temp sensor error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rc</span><span class="p">);</span>
		<span class="n">wf_smu_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_SENSOR</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">wf_sensor_get</span><span class="p">(</span><span class="n">sensor_cpu_power</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">power</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;windfarm: CPU power sensor error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rc</span><span class="p">);</span>
		<span class="n">wf_smu_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_SENSOR</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;wf_smu: CPU Fans tick ! CPU temp: %d.%03d, power: %d.%03d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	    <span class="n">FIX32TOPRINT</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="n">FIX32TOPRINT</span><span class="p">(</span><span class="n">power</span><span class="p">));</span>

<span class="cp">#ifdef HACKED_OVERTEMP</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="mh">0x4a0000</span><span class="p">)</span>
		<span class="n">wf_smu_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_OVERTEMP</span><span class="p">;</span>
<span class="cp">#else</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">tmax</span><span class="p">)</span>
		<span class="n">wf_smu_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_OVERTEMP</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="n">new_setpoint</span> <span class="o">=</span> <span class="n">wf_cpu_pid_run</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;wf_smu: new_setpoint: %d RPM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">new_setpoint</span><span class="p">);</span>

	<span class="n">systarget</span> <span class="o">=</span> <span class="n">wf_smu_sys_fans</span> <span class="o">?</span> <span class="n">wf_smu_sys_fans</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">.</span><span class="n">target</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">systarget</span> <span class="o">=</span> <span class="p">((((</span><span class="n">s64</span><span class="p">)</span><span class="n">systarget</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">s64</span><span class="p">)</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">scale</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span>
		<span class="o">+</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">new_setpoint</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">new_setpoint</span><span class="p">,</span> <span class="n">systarget</span><span class="p">);</span>
	<span class="n">new_setpoint</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">new_setpoint</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">min</span><span class="p">);</span>
	<span class="n">new_setpoint</span> <span class="o">=</span> <span class="n">min</span><span class="p">(</span><span class="n">new_setpoint</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">max</span><span class="p">);</span>

	<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;wf_smu: adjusted setpoint: %d RPM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">new_setpoint</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">cpu_setpoint</span> <span class="o">==</span> <span class="n">new_setpoint</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">cpu_setpoint</span> <span class="o">=</span> <span class="n">new_setpoint</span><span class="p">;</span>
 <span class="nl">readjust:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fan_cpu_main</span> <span class="o">&amp;&amp;</span> <span class="n">wf_smu_failure_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">wf_control_set</span><span class="p">(</span><span class="n">fan_cpu_main</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">cpu_setpoint</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;windfarm: CPU main fan&quot;</span>
			       <span class="s">&quot; error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="n">wf_smu_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_FAN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ****** Setup / Init / Misc ... ******</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wf_smu_tick</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_failure</span> <span class="o">=</span> <span class="n">wf_smu_failure_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_failure</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wf_smu_started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;wf: creating control loops !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">wf_smu_create_sys_fans</span><span class="p">();</span>
		<span class="n">wf_smu_create_cpu_fans</span><span class="p">();</span>
		<span class="n">wf_smu_started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Skipping ticks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wf_smu_skipping</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">wf_smu_skipping</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">wf_smu_failure_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wf_smu_sys_fans</span><span class="p">)</span>
		<span class="n">wf_smu_sys_fans_tick</span><span class="p">(</span><span class="n">wf_smu_sys_fans</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wf_smu_cpu_fans</span><span class="p">)</span>
		<span class="n">wf_smu_cpu_fans_tick</span><span class="p">(</span><span class="n">wf_smu_cpu_fans</span><span class="p">);</span>

	<span class="n">wf_smu_readjust</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">new_failure</span> <span class="o">=</span> <span class="n">wf_smu_failure_state</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">last_failure</span><span class="p">;</span>

	<span class="cm">/* If entering failure mode, clamp cpufreq and ramp all</span>
<span class="cm">	 * fans to full speed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wf_smu_failure_state</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">last_failure</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_clamp</span><span class="p">)</span>
			<span class="n">wf_control_set_max</span><span class="p">(</span><span class="n">cpufreq_clamp</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fan_system</span><span class="p">)</span>
			<span class="n">wf_control_set_max</span><span class="p">(</span><span class="n">fan_system</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fan_cpu_main</span><span class="p">)</span>
			<span class="n">wf_control_set_max</span><span class="p">(</span><span class="n">fan_cpu_main</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fan_hd</span><span class="p">)</span>
			<span class="n">wf_control_set_max</span><span class="p">(</span><span class="n">fan_hd</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* If leaving failure mode, unclamp cpufreq and readjust</span>
<span class="cm">	 * all fans on next iteration</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">wf_smu_failure_state</span> <span class="o">&amp;&amp;</span> <span class="n">last_failure</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_clamp</span><span class="p">)</span>
			<span class="n">wf_control_set_min</span><span class="p">(</span><span class="n">cpufreq_clamp</span><span class="p">);</span>
		<span class="n">wf_smu_readjust</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Overtemp condition detected, notify and start skipping a couple</span>
<span class="cm">	 * ticks to let the temperature go down</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_failure</span> <span class="o">&amp;</span> <span class="n">FAILURE_OVERTEMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wf_set_overtemp</span><span class="p">();</span>
		<span class="n">wf_smu_skipping</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We only clear the overtemp condition if overtemp is cleared</span>
<span class="cm">	 * _and_ no other failure is present. Since a sensor error will</span>
<span class="cm">	 * clear the overtemp condition (can&#39;t measure temperature) at</span>
<span class="cm">	 * the control loop levels, but we don&#39;t want to keep it clear</span>
<span class="cm">	 * here in this case</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_failure</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">last_failure</span> <span class="o">&amp;</span> <span class="n">FAILURE_OVERTEMP</span><span class="p">)</span>
		<span class="n">wf_clear_overtemp</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wf_smu_new_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">wf_control</span> <span class="o">*</span><span class="n">ct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wf_smu_all_controls_ok</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fan_cpu_main</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cpu-fan&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wf_get_control</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fan_cpu_main</span> <span class="o">=</span> <span class="n">ct</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fan_system</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;system-fan&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wf_get_control</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fan_system</span> <span class="o">=</span> <span class="n">ct</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_clamp</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cpufreq-clamp&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wf_get_control</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">cpufreq_clamp</span> <span class="o">=</span> <span class="n">ct</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Darwin property list says the HD fan is only for model ID</span>
<span class="cm">	 * 0, 1, 2 and 3</span>
<span class="cm">	 */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">wf_smu_mach_model</span> <span class="o">&gt;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fan_system</span> <span class="o">&amp;&amp;</span> <span class="n">fan_cpu_main</span> <span class="o">&amp;&amp;</span> <span class="n">cpufreq_clamp</span><span class="p">)</span>
			<span class="n">wf_smu_all_controls_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fan_hd</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;drive-bay-fan&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wf_get_control</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">fan_hd</span> <span class="o">=</span> <span class="n">ct</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">fan_system</span> <span class="o">&amp;&amp;</span> <span class="n">fan_hd</span> <span class="o">&amp;&amp;</span> <span class="n">fan_cpu_main</span> <span class="o">&amp;&amp;</span> <span class="n">cpufreq_clamp</span><span class="p">)</span>
		<span class="n">wf_smu_all_controls_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">wf_smu_new_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">wf_sensor</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">wf_smu_all_sensors_ok</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor_cpu_power</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cpu-power&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wf_get_sensor</span><span class="p">(</span><span class="n">sr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sensor_cpu_power</span> <span class="o">=</span> <span class="n">sr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor_cpu_temp</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;cpu-temp&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wf_get_sensor</span><span class="p">(</span><span class="n">sr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sensor_cpu_temp</span> <span class="o">=</span> <span class="n">sr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor_hd_temp</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sr</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;hd-temp&quot;</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wf_get_sensor</span><span class="p">(</span><span class="n">sr</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">sensor_hd_temp</span> <span class="o">=</span> <span class="n">sr</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sensor_cpu_power</span> <span class="o">&amp;&amp;</span> <span class="n">sensor_cpu_temp</span> <span class="o">&amp;&amp;</span> <span class="n">sensor_hd_temp</span><span class="p">)</span>
		<span class="n">wf_smu_all_sensors_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">wf_smu_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
			       <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span><span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WF_EVENT_NEW_CONTROL</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;wf: new control %s detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">((</span><span class="k">struct</span> <span class="n">wf_control</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">wf_smu_new_control</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="n">wf_smu_readjust</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WF_EVENT_NEW_SENSOR</span>:
		<span class="n">DBG</span><span class="p">(</span><span class="s">&quot;wf: new sensor %s detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		    <span class="p">((</span><span class="k">struct</span> <span class="n">wf_sensor</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">wf_smu_new_sensor</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WF_EVENT_TICK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">wf_smu_all_controls_ok</span> <span class="o">&amp;&amp;</span> <span class="n">wf_smu_all_sensors_ok</span><span class="p">)</span>
			<span class="n">wf_smu_tick</span><span class="p">();</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">wf_smu_events</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span>	<span class="o">=</span> <span class="n">wf_smu_notify</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wf_init_pm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">smu_sdbp_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">smu_get_sdb_partition</span><span class="p">(</span><span class="n">SMU_SDB_SENSORTREE_ID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">smu_sdbp_sensortree</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">smu_sdbp_sensortree</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">wf_smu_mach_model</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">model_id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;windfarm: Initializing for iMacG5 model ID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">wf_smu_mach_model</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">wf_smu_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wf_register_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wf_smu_events</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">wf_smu_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wf_unregister_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wf_smu_events</span><span class="p">);</span>

	<span class="cm">/* XXX We don&#39;t have yet a guarantee that our callback isn&#39;t</span>
<span class="cm">	 * in progress when returning from wf_unregister_client, so</span>
<span class="cm">	 * we add an arbitrary delay. I&#39;ll have to fix that in the core</span>
<span class="cm">	 */</span>
	<span class="n">msleep</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

	<span class="cm">/* Release all sensors */</span>
	<span class="cm">/* One more crappy race: I don&#39;t think we have any guarantee here</span>
<span class="cm">	 * that the attribute callback won&#39;t race with the sensor beeing</span>
<span class="cm">	 * disposed of, and I&#39;m not 100% certain what best way to deal</span>
<span class="cm">	 * with that except by adding locks all over... I&#39;ll do that</span>
<span class="cm">	 * eventually but heh, who ever rmmod this module anyway ?</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor_cpu_power</span><span class="p">)</span>
		<span class="n">wf_put_sensor</span><span class="p">(</span><span class="n">sensor_cpu_power</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor_cpu_temp</span><span class="p">)</span>
		<span class="n">wf_put_sensor</span><span class="p">(</span><span class="n">sensor_cpu_temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sensor_hd_temp</span><span class="p">)</span>
		<span class="n">wf_put_sensor</span><span class="p">(</span><span class="n">sensor_hd_temp</span><span class="p">);</span>

	<span class="cm">/* Release all controls */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fan_cpu_main</span><span class="p">)</span>
		<span class="n">wf_put_control</span><span class="p">(</span><span class="n">fan_cpu_main</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fan_hd</span><span class="p">)</span>
		<span class="n">wf_put_control</span><span class="p">(</span><span class="n">fan_hd</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fan_system</span><span class="p">)</span>
		<span class="n">wf_put_control</span><span class="p">(</span><span class="n">fan_system</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cpufreq_clamp</span><span class="p">)</span>
		<span class="n">wf_put_control</span><span class="p">(</span><span class="n">cpufreq_clamp</span><span class="p">);</span>

	<span class="cm">/* Destroy control loops state structures */</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wf_smu_sys_fans</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">wf_smu_cpu_fans</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">wf_smu_driver</span> <span class="o">=</span> <span class="p">{</span>
        <span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">wf_smu_probe</span><span class="p">,</span>
        <span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">wf_smu_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;windfarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">wf_smu_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerMac8,1&quot;</span><span class="p">)</span> <span class="o">||</span>
	    <span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerMac8,2&quot;</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">wf_init_pm</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef MODULE</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;windfarm_smu_controls&quot;</span><span class="p">);</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;windfarm_smu_sensors&quot;</span><span class="p">);</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;windfarm_lm75_sensor&quot;</span><span class="p">);</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;windfarm_cpufreq_clamp&quot;</span><span class="p">);</span>

<span class="cp">#endif </span><span class="cm">/* MODULE */</span><span class="cp"></span>
		<span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wf_smu_driver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">wf_smu_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">wf_smu_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">wf_smu_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">wf_smu_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Benjamin Herrenschmidt &lt;benh@kernel.crashing.org&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Thermal control logic for iMac G5&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;platform:windfarm&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
