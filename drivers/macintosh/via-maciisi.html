<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › macintosh › via-maciisi.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>via-maciisi.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Device driver for the IIsi-style ADB on some Mac LC and II-class machines</span>
<span class="cm"> *</span>
<span class="cm"> * Based on via-cuda.c and via-macii.c, as well as the original</span>
<span class="cm"> * adb-bus.c, which in turn is somewhat influenced by (but uses no</span>
<span class="cm"> * code from) the NetBSD HWDIRECT ADB code.  Original IIsi driver work</span>
<span class="cm"> * was done by Robert Thompson and integrated into the old style</span>
<span class="cm"> * driver by Michael Schmitz.</span>
<span class="cm"> *</span>
<span class="cm"> * Original sources (c) Alan Cox, Paul Mackerras, and others.</span>
<span class="cm"> *</span>
<span class="cm"> * Rewritten for Unified ADB by David Huggins-Daines &lt;dhd@debian.org&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * 7/13/2000- extensive changes by Andrew McPherson &lt;andrew@macduff.dhs.org&gt;</span>
<span class="cm"> * Works about 30% of the time now.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/adb.h&gt;</span>
<span class="cp">#include &lt;linux/cuda.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;asm/macintosh.h&gt;</span>
<span class="cp">#include &lt;asm/macints.h&gt;</span>
<span class="cp">#include &lt;asm/mac_via.h&gt;</span>

<span class="k">static</span> <span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">via</span><span class="p">;</span>

<span class="cm">/* VIA registers - spaced 0x200 bytes apart - only the ones we actually use */</span>
<span class="cp">#define RS		0x200		</span><span class="cm">/* skip between registers */</span><span class="cp"></span>
<span class="cp">#define B		0		</span><span class="cm">/* B-side data */</span><span class="cp"></span>
<span class="cp">#define A		RS		</span><span class="cm">/* A-side data */</span><span class="cp"></span>
<span class="cp">#define DIRB		(2*RS)		</span><span class="cm">/* B-side direction (1=output) */</span><span class="cp"></span>
<span class="cp">#define DIRA		(3*RS)		</span><span class="cm">/* A-side direction (1=output) */</span><span class="cp"></span>
<span class="cp">#define SR		(10*RS)		</span><span class="cm">/* Shift register */</span><span class="cp"></span>
<span class="cp">#define ACR		(11*RS)		</span><span class="cm">/* Auxiliary control register */</span><span class="cp"></span>
<span class="cp">#define IFR		(13*RS)		</span><span class="cm">/* Interrupt flag register */</span><span class="cp"></span>
<span class="cp">#define IER		(14*RS)		</span><span class="cm">/* Interrupt enable register */</span><span class="cp"></span>

<span class="cm">/* Bits in B data register: all active low */</span>
<span class="cp">#define TREQ		0x08		</span><span class="cm">/* Transfer request (input) */</span><span class="cp"></span>
<span class="cp">#define TACK		0x10		</span><span class="cm">/* Transfer acknowledge (output) */</span><span class="cp"></span>
<span class="cp">#define TIP		0x20		</span><span class="cm">/* Transfer in progress (output) */</span><span class="cp"></span>
<span class="cp">#define ST_MASK		0x30		</span><span class="cm">/* mask for selecting ADB state bits */</span><span class="cp"></span>

<span class="cm">/* Bits in ACR */</span>
<span class="cp">#define SR_CTRL		0x1c		</span><span class="cm">/* Shift register control bits */</span><span class="cp"></span>
<span class="cp">#define SR_EXT		0x0c		</span><span class="cm">/* Shift on external clock */</span><span class="cp"></span>
<span class="cp">#define SR_OUT		0x10		</span><span class="cm">/* Shift out if 1 */</span><span class="cp"></span>

<span class="cm">/* Bits in IFR and IER */</span>
<span class="cp">#define IER_SET		0x80		</span><span class="cm">/* set bits in IER */</span><span class="cp"></span>
<span class="cp">#define IER_CLR		0		</span><span class="cm">/* clear bits in IER */</span><span class="cp"></span>
<span class="cp">#define SR_INT		0x04		</span><span class="cm">/* Shift register full/empty */</span><span class="cp"></span>
<span class="cp">#define SR_DATA		0x08		</span><span class="cm">/* Shift register data */</span><span class="cp"></span>
<span class="cp">#define SR_CLOCK	0x10		</span><span class="cm">/* Shift register clock */</span><span class="cp"></span>

<span class="cp">#define ADB_DELAY 150</span>

<span class="cp">#undef DEBUG_MACIISI_ADB</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">adb_request</span><span class="o">*</span> <span class="n">current_req</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">adb_request</span><span class="o">*</span> <span class="n">last_req</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">maciisi_rbuf</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">reply_ptr</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">data_index</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reading_reply</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">reply_len</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">tmp</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">need_sync</span><span class="p">;</span>

<span class="k">static</span> <span class="k">enum</span> <span class="n">maciisi_state</span> <span class="p">{</span>
    <span class="n">idle</span><span class="p">,</span>
    <span class="n">sending</span><span class="p">,</span>
    <span class="n">reading</span><span class="p">,</span>
<span class="p">}</span> <span class="n">maciisi_state</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">maciisi_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">maciisi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">maciisi_send_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span><span class="o">*</span> <span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sync</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">maciisi_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">maciisi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span><span class="o">*</span> <span class="n">req</span><span class="p">);</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">maciisi_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">maciisi_input</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nb</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">maciisi_init_via</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">maciisi_poll</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">maciisi_start</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">struct</span> <span class="n">adb_driver</span> <span class="n">via_maciisi_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;Mac IIsi&quot;</span><span class="p">,</span>
	<span class="n">maciisi_probe</span><span class="p">,</span>
	<span class="n">maciisi_init</span><span class="p">,</span>
	<span class="n">maciisi_send_request</span><span class="p">,</span>
	<span class="nb">NULL</span><span class="p">,</span> <span class="cm">/* maciisi_adb_autopoll, */</span>
	<span class="n">maciisi_poll</span><span class="p">,</span>
	<span class="nb">NULL</span> <span class="cm">/* maciisi_reset_adb_bus */</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">maciisi_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">macintosh_config</span><span class="o">-&gt;</span><span class="n">adb_type</span> <span class="o">!=</span> <span class="n">MAC_ADB_IISI</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">via</span> <span class="o">=</span> <span class="n">via1</span><span class="p">;</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">maciisi_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">via</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">err</span> <span class="o">=</span> <span class="n">maciisi_init_via</span><span class="p">()))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;maciisi_init: maciisi_init_via() failed, code %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">err</span><span class="p">);</span>
		<span class="n">via</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">IRQ_MAC_ADB</span><span class="p">,</span> <span class="n">maciisi_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;ADB&quot;</span><span class="p">,</span>
			<span class="n">maciisi_interrupt</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;maciisi_init: can&#39;t get irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">IRQ_MAC_ADB</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;adb: Mac IIsi driver v0.2 for Unified ADB.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Flush data from the ADB controller */</span>
<span class="k">static</span> <span class="kt">void</span>
<span class="nf">maciisi_stfu</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TIP</span><span class="o">|</span><span class="n">TREQ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TREQ</span><span class="p">)</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
		<span class="n">printk</span> <span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;maciisi_stfu called with TREQ high!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	
	<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span>
	<span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SR_OUT</span><span class="p">;</span>
	<span class="n">via</span><span class="p">[</span><span class="n">IER</span><span class="p">]</span> <span class="o">=</span> <span class="n">IER_CLR</span> <span class="o">|</span> <span class="n">SR_INT</span><span class="p">;</span>

	<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TIP</span><span class="o">|</span><span class="n">TREQ</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TREQ</span><span class="p">))</span>
	<span class="p">{</span>
		<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TIP</span><span class="p">;</span>

		<span class="k">while</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">poll_timeout</span> <span class="o">=</span> <span class="n">ADB_DELAY</span> <span class="o">*</span> <span class="mi">5</span><span class="p">;</span>
			<span class="cm">/* Poll for SR interrupt */</span>
			<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SR_INT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">poll_timeout</span><span class="o">--</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
				<span class="n">status</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TIP</span><span class="o">|</span><span class="n">TREQ</span><span class="p">);</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">];</span> <span class="cm">/* Clear shift register */</span>
<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;maciisi_stfu: status %x timeout %d data %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">status</span><span class="p">,</span> <span class="n">poll_timeout</span><span class="p">,</span> <span class="n">tmp</span><span class="p">);</span>
<span class="cp">#endif	</span>
			<span class="k">if</span><span class="p">(</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TREQ</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
	
			<span class="cm">/* ACK on-off */</span>
			<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TACK</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span>
			<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TACK</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* end frame */</span>
		<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIP</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">via</span><span class="p">[</span><span class="n">IER</span><span class="p">]</span> <span class="o">=</span> <span class="n">IER_SET</span> <span class="o">|</span> <span class="n">SR_INT</span><span class="p">;</span>	
<span class="p">}</span>

<span class="cm">/* All specifically VIA-related initialization goes here */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">maciisi_init_via</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">i</span><span class="p">;</span>
	
	<span class="cm">/* Set the lines up. We want TREQ as input TACK|TIP as output */</span>
	<span class="n">via</span><span class="p">[</span><span class="n">DIRB</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">via</span><span class="p">[</span><span class="n">DIRB</span><span class="p">]</span> <span class="o">|</span> <span class="n">TACK</span> <span class="o">|</span> <span class="n">TIP</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TREQ</span><span class="p">;</span>
	<span class="cm">/* Shift register on input */</span>
	<span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">]</span>  <span class="o">=</span> <span class="p">(</span><span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">SR_CTRL</span><span class="p">)</span> <span class="o">|</span> <span class="n">SR_EXT</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;maciisi_init_via: initial status %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TIP</span><span class="o">|</span><span class="n">TREQ</span><span class="p">));</span>
<span class="cp">#endif</span>
	<span class="cm">/* Wipe any pending data and int */</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">];</span>
	<span class="cm">/* Enable keyboard interrupts */</span>
	<span class="n">via</span><span class="p">[</span><span class="n">IER</span><span class="p">]</span> <span class="o">=</span> <span class="n">IER_SET</span> <span class="o">|</span> <span class="n">SR_INT</span><span class="p">;</span>
	<span class="cm">/* Set initial state: idle */</span>
	<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TACK</span><span class="o">|</span><span class="n">TIP</span><span class="p">);</span>
	<span class="cm">/* Clear interrupt bit */</span>
	<span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">]</span> <span class="o">=</span> <span class="n">SR_INT</span><span class="p">;</span>

	<span class="k">for</span><span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">60</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span>
		<span class="n">maciisi_stfu</span><span class="p">();</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span>
		<span class="k">if</span><span class="p">(</span><span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">TREQ</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">60</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;maciisi_init_via: bus jam?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">maciisi_state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
	<span class="n">need_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Send a request, possibly waiting for a reply */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">maciisi_send_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span><span class="o">*</span> <span class="n">req</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sync</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dump_packet</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">via</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="p">}</span>

<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dump_packet</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;maciisi_send_request:&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %.2x&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; sync %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sync</span><span class="p">);</span>
	<span class="p">}</span>
<span class="cp">#endif</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_expected</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	
	<span class="n">i</span> <span class="o">=</span> <span class="n">maciisi_write</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">i</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="cm">/* Normally, if a packet requires syncing, that happens at the end of</span>
<span class="cm">		 * maciisi_send_request. But if the transfer fails, it will be restarted</span>
<span class="cm">		 * by maciisi_interrupt(). We use need_sync to tell maciisi_interrupt</span>
<span class="cm">		 * when to sync a packet that it sends out.</span>
<span class="cm">		 * </span>
<span class="cm">		 * Suggestions on a better way to do this are welcome.</span>
<span class="cm">		 */</span>
		<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span> <span class="o">&amp;&amp;</span> <span class="n">sync</span><span class="p">)</span>
			<span class="n">need_sync</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">need_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span><span class="p">(</span><span class="n">sync</span><span class="p">)</span>
		<span class="n">maciisi_sync</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* Poll the ADB chip until the request completes */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">maciisi_sync</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> 

<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;maciisi_sync called</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>

	<span class="cm">/* If for some reason the ADB chip shuts up on us, we want to avoid an endless loop. */</span>
	<span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">&amp;&amp;</span> <span class="n">count</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">50</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maciisi_poll</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="cm">/* This could be BAD... when the ADB controller doesn&#39;t respond</span>
<span class="cm">	 * for this long, it&#39;s probably not coming back :-( */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">50</span><span class="p">)</span> <span class="cm">/* Hopefully shouldn&#39;t happen */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;maciisi_send_request: poll timed out!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">maciisi_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="p">),</span>
	    <span class="kt">int</span> <span class="n">nbytes</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">=</span> <span class="n">nbytes</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_expected</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbytes</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">maciisi_send_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Enqueue a request, and run the queue if possible */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">maciisi_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span><span class="o">*</span> <span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* We will accept CUDA packets - the VIA sends them to us, so</span>
<span class="cm">           it figures that we should be able to send them to it */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">CUDA_PACKET</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;maciisi_write: packet too small or not an ADB or CUDA packet</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">current_req</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">last_req</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
		<span class="n">last_req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">current_req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
		<span class="n">last_req</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">maciisi_state</span> <span class="o">==</span> <span class="n">idle</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">i</span> <span class="o">=</span> <span class="n">maciisi_start</span><span class="p">();</span>
		<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
			<span class="k">return</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;maciisi_write: would start, but state is %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">maciisi_state</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">maciisi_start</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adb_request</span><span class="o">*</span> <span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TIP</span> <span class="o">|</span> <span class="n">TREQ</span><span class="p">);</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;maciisi_start called, state=%d, status=%x, ifr=%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">maciisi_state</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">]);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">maciisi_state</span> <span class="o">!=</span> <span class="n">idle</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* shouldn&#39;t happen */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;maciisi_start: maciisi_start called when driver busy!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">current_req</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TIP</span><span class="o">|</span><span class="n">TREQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TREQ</span><span class="p">))</span> <span class="p">{</span>
<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;maciisi_start: bus busy - aborting</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Okay, send */</span>
<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;maciisi_start: sending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	<span class="cm">/* Set state to active */</span>
	<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TIP</span><span class="p">;</span>
	<span class="cm">/* ACK off */</span>
	<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TACK</span><span class="p">;</span>
	<span class="cm">/* Delay */</span>
	<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span>
	<span class="cm">/* Shift out and send */</span>
	<span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SR_OUT</span><span class="p">;</span>
	<span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">data_index</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* ACK on */</span>
	<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TACK</span><span class="p">;</span>
	<span class="n">maciisi_state</span> <span class="o">=</span> <span class="n">sending</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">maciisi_poll</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SR_INT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">maciisi_interrupt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">else</span> <span class="cm">/* avoid calling this function too quickly in a loop */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span>

	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Shift register interrupt - this is *supposed* to mean that the</span>
<span class="cm">   register is either full or empty. In practice, I have no idea what</span>
<span class="cm">   it means :( */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span>
<span class="nf">maciisi_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span><span class="o">*</span> <span class="n">arg</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dump_reply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">local_irq_save</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TIP</span><span class="o">|</span><span class="n">TREQ</span><span class="p">);</span>
<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;state %d status %x ifr %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">maciisi_state</span><span class="p">,</span> <span class="n">status</span><span class="p">,</span> <span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">]);</span>
<span class="cp">#endif</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">SR_INT</span><span class="p">))</span> <span class="p">{</span>
		<span class="cm">/* Shouldn&#39;t happen, we hope */</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;maciisi_interrupt: called without interrupt flag set</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">IRQ_NONE</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Clear the interrupt */</span>
	<span class="cm">/* via[IFR] = SR_INT; */</span>

 <span class="nl">switch_start:</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">maciisi_state</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">idle</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TIP</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;maciisi_interrupt: state is idle but TIP asserted!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">reading_reply</span><span class="p">)</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span>
		<span class="cm">/* Shift in */</span>
		<span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SR_OUT</span><span class="p">;</span>
 		<span class="cm">/* Signal start of frame */</span>
		<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TIP</span><span class="p">;</span>
		<span class="cm">/* Clear the interrupt (throw this value on the floor, it&#39;s useless) */</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">];</span>
		<span class="cm">/* ACK adb chip, high-low */</span>
		<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TACK</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span>
		<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TACK</span><span class="p">;</span>
		<span class="n">reply_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">maciisi_state</span> <span class="o">=</span> <span class="n">reading</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reading_reply</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">reply_ptr</span> <span class="o">=</span> <span class="n">current_req</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">reply_ptr</span> <span class="o">=</span> <span class="n">maciisi_rbuf</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">sending</span>:
		<span class="cm">/* via[SR]; */</span>
		<span class="cm">/* Set ACK off */</span>
		<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TACK</span><span class="p">;</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">current_req</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TREQ</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* collision */</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;maciisi_interrupt: send collision</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="cm">/* Set idle and input */</span>
			<span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SR_OUT</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">];</span>
			<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIP</span><span class="p">;</span>
			<span class="cm">/* Must re-send */</span>
			<span class="n">reading_reply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">reply_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">maciisi_state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span>
			<span class="cm">/* process this now, because the IFR has been cleared */</span>
			<span class="k">goto</span> <span class="n">switch_start</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">data_index</span> <span class="o">&gt;=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Sent the whole packet, put the bus back in idle state */</span>
			<span class="cm">/* Shift in, we are about to read a reply (hopefully) */</span>
			<span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SR_OUT</span><span class="p">;</span>
			<span class="n">tmp</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">];</span>
			<span class="cm">/* End of frame */</span>
			<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIP</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">sent</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">maciisi_state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_expected</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Note: only set this once we&#39;ve</span>
<span class="cm">                                   successfully sent the packet */</span>
				<span class="n">reading_reply</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">current_req</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">)</span>
					<span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">)(</span><span class="n">req</span><span class="p">);</span>
				<span class="cm">/* Do any queued requests now */</span>
				<span class="n">i</span> <span class="o">=</span> <span class="n">maciisi_start</span><span class="p">();</span>
				<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">need_sync</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Packet needs to be synced */</span>
					<span class="n">maciisi_sync</span><span class="p">(</span><span class="n">current_req</span><span class="p">);</span>
				<span class="p">}</span>
				<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
					<span class="n">need_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Sending more stuff */</span>
			<span class="cm">/* Shift out */</span>
			<span class="n">via</span><span class="p">[</span><span class="n">ACR</span><span class="p">]</span> <span class="o">|=</span> <span class="n">SR_OUT</span><span class="p">;</span>
			<span class="cm">/* Write */</span>
			<span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">]</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">data_index</span><span class="o">++</span><span class="p">];</span>
			<span class="cm">/* Signal &#39;byte ready&#39; */</span>
			<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TACK</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">reading</span>:
		<span class="cm">/* Shift in */</span>
		<span class="cm">/* via[ACR] &amp;= ~SR_OUT; */</span> <span class="cm">/* Not in 2.2 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reply_len</span><span class="o">++</span> <span class="o">&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;maciisi_interrupt: reply too long, aborting read</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TACK</span><span class="p">;</span>
			<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span>
			<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TACK</span><span class="o">|</span><span class="n">TIP</span><span class="p">);</span>
			<span class="n">maciisi_state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">maciisi_start</span><span class="p">();</span>
			<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">need_sync</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Packet needs to be synced */</span>
				<span class="n">maciisi_sync</span><span class="p">(</span><span class="n">current_req</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
				<span class="n">need_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* Read data */</span>
		<span class="o">*</span><span class="n">reply_ptr</span><span class="o">++</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">];</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TIP</span><span class="o">|</span><span class="n">TREQ</span><span class="p">);</span>
		<span class="cm">/* ACK on/off */</span>
		<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">|=</span> <span class="n">TACK</span><span class="p">;</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span>
		<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TACK</span><span class="p">;</span>	
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TREQ</span><span class="p">))</span>
			<span class="k">break</span><span class="p">;</span> <span class="cm">/* more stuff to deal with */</span>
		
		<span class="cm">/* end of frame */</span>
		<span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TIP</span><span class="p">;</span>
		<span class="n">tmp</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">SR</span><span class="p">];</span> <span class="cm">/* That&#39;s what happens in 2.2 */</span>
		<span class="n">udelay</span><span class="p">(</span><span class="n">ADB_DELAY</span><span class="p">);</span> <span class="cm">/* Give controller time to recover */</span>

		<span class="cm">/* end of packet, deal with it */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">reading_reply</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">req</span> <span class="o">=</span> <span class="n">current_req</span><span class="p">;</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">=</span> <span class="n">reply_ptr</span> <span class="o">-</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ADB_PACKET</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Have to adjust the reply from ADB commands */</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">&lt;=</span> <span class="mi">2</span> <span class="o">||</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* the 0x2 bit indicates no response */</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* leave just the command and result bytes in the reply */</span>
					<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">-=</span> <span class="mi">2</span><span class="p">;</span>
					<span class="n">memmove</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span><span class="p">);</span>
				<span class="p">}</span>
			<span class="p">}</span>
<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dump_reply</span><span class="p">)</span> <span class="p">{</span>
				<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;maciisi_interrupt: reply is &quot;</span><span class="p">);</span>
				<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %.2x&quot;</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
				<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
<span class="cp">#endif</span>
			<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">current_req</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">)</span>
				<span class="p">(</span><span class="o">*</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">done</span><span class="p">)(</span><span class="n">req</span><span class="p">);</span>
			<span class="cm">/* Obviously, we got it */</span>
			<span class="n">reading_reply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">maciisi_input</span><span class="p">(</span><span class="n">maciisi_rbuf</span><span class="p">,</span> <span class="n">reply_ptr</span> <span class="o">-</span> <span class="n">maciisi_rbuf</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">maciisi_state</span> <span class="o">=</span> <span class="n">idle</span><span class="p">;</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">via</span><span class="p">[</span><span class="n">B</span><span class="p">]</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TIP</span><span class="o">|</span><span class="n">TREQ</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">TREQ</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Timeout?! More likely, another packet coming in already */</span>
<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;extra data after packet: status %x ifr %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">status</span><span class="p">,</span> <span class="n">via</span><span class="p">[</span><span class="n">IFR</span><span class="p">]);</span>
<span class="cp">#endif</span>
<span class="cp">#if 0</span><span class="c"></span>
<span class="c">			udelay(ADB_DELAY);</span>
<span class="c">			via[B] |= TIP;</span>

<span class="c">			maciisi_state = reading;</span>
<span class="c">			reading_reply = 0;</span>
<span class="c">			reply_ptr = maciisi_rbuf;</span>
<span class="cp">#else</span>
			<span class="cm">/* Process the packet now */</span>
			<span class="n">reading_reply</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">switch_start</span><span class="p">;</span>
<span class="cp">#endif</span>
			<span class="cm">/* We used to do this... but the controller might actually have data for us */</span>
			<span class="cm">/* maciisi_stfu(); */</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* Do any queued requests now if possible */</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">maciisi_start</span><span class="p">();</span>
			<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">need_sync</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Packet needs to be synced */</span>
				<span class="n">maciisi_sync</span><span class="p">(</span><span class="n">current_req</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">if</span><span class="p">(</span><span class="n">i</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span>
				<span class="n">need_sync</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;maciisi_interrupt: unknown maciisi_state %d?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">maciisi_state</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">local_irq_restore</span><span class="p">(</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">maciisi_input</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nb</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
<span class="cp">#endif</span>

    <span class="k">switch</span> <span class="p">(</span><span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">{</span>
    <span class="k">case</span> <span class="n">ADB_PACKET</span>:
	    <span class="n">adb_input</span><span class="p">(</span><span class="n">buf</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">nb</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x40</span><span class="p">);</span>
	    <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>
<span class="cp">#ifdef DEBUG_MACIISI_ADB</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;data from IIsi ADB (%d bytes):&quot;</span><span class="p">,</span> <span class="n">nb</span><span class="p">);</span>
	    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		    <span class="n">printk</span><span class="p">(</span><span class="s">&quot; %.2x&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="cp">#endif</span>
	    <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
