<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › macintosh › adb.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>adb.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Device driver for the Apple Desktop Bus</span>
<span class="cm"> * and the /dev/adb device on macintoshes.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 1996 Paul Mackerras.</span>
<span class="cm"> *</span>
<span class="cm"> * Modified to declare controllers as structures, added</span>
<span class="cm"> * client notification of bus reset and handles PowerBook</span>
<span class="cm"> * sleep, by Benjamin Herrenschmidt.</span>
<span class="cm"> *</span>
<span class="cm"> * To do:</span>
<span class="cm"> *</span>
<span class="cm"> * - /sys/bus/adb to list the devices and infos</span>
<span class="cm"> * - more /dev/adb to allow userland to receive the</span>
<span class="cm"> *   flow of auto-polling datas from a given device.</span>
<span class="cm"> * - move bus probe to a kernel thread</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/fs.h&gt;</span>
<span class="cp">#include &lt;linux/mm.h&gt;</span>
<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/adb.h&gt;</span>
<span class="cp">#include &lt;linux/cuda.h&gt;</span>
<span class="cp">#include &lt;linux/pmu.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/completion.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/kthread.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/mutex.h&gt;</span>

<span class="cp">#include &lt;asm/uaccess.h&gt;</span>
<span class="cp">#ifdef CONFIG_PPC</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#endif</span>


<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">adb_client_list</span><span class="p">);</span>

<span class="k">extern</span> <span class="k">struct</span> <span class="n">adb_driver</span> <span class="n">via_macii_driver</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">adb_driver</span> <span class="n">via_maciisi_driver</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">adb_driver</span> <span class="n">via_cuda_driver</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">adb_driver</span> <span class="n">adb_iop_driver</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">adb_driver</span> <span class="n">via_pmu_driver</span><span class="p">;</span>
<span class="k">extern</span> <span class="k">struct</span> <span class="n">adb_driver</span> <span class="n">macio_adb_driver</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">adb_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">adb_driver</span> <span class="o">*</span><span class="n">adb_driver_list</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_ADB_MACII</span>
	<span class="o">&amp;</span><span class="n">via_macii_driver</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ADB_MACIISI</span>
	<span class="o">&amp;</span><span class="n">via_maciisi_driver</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ADB_CUDA</span>
	<span class="o">&amp;</span><span class="n">via_cuda_driver</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ADB_IOP</span>
	<span class="o">&amp;</span><span class="n">adb_iop_driver</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#if defined(CONFIG_ADB_PMU) || defined(CONFIG_ADB_PMU68K)</span>
	<span class="o">&amp;</span><span class="n">via_pmu_driver</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_ADB_MACIO</span>
	<span class="o">&amp;</span><span class="n">macio_adb_driver</span><span class="p">,</span>
<span class="cp">#endif</span>
	<span class="nb">NULL</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">class</span> <span class="o">*</span><span class="n">adb_dev_class</span><span class="p">;</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">adb_driver</span> <span class="o">*</span><span class="n">adb_controller</span><span class="p">;</span>
<span class="n">BLOCKING_NOTIFIER_HEAD</span><span class="p">(</span><span class="n">adb_client_list</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">adb_got_sleep</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">adb_inited</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SEMAPHORE</span><span class="p">(</span><span class="n">adb_probe_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sleepy_trackpad</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">autopoll_devs</span><span class="p">;</span>
<span class="kt">int</span> <span class="n">__adb_probe_sync</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">adb_scan_bus</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_adb_reset_bus</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">adbdev_init</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">try_handler_change</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">adb_handler</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">original_address</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">handler_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">busy</span><span class="p">;</span>
<span class="p">}</span> <span class="n">adb_handler</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * The adb_handler_mutex mutex protects all accesses to the original_address</span>
<span class="cm"> * and handler_id fields of adb_handler[i] for all i, and changes to the</span>
<span class="cm"> * handler field.</span>
<span class="cm"> * Accesses to the handler field are protected by the adb_handler_lock</span>
<span class="cm"> * rwlock.  It is held across all calls to any handler, so that by the</span>
<span class="cm"> * time adb_unregister returns, we know that the old handler isn&#39;t being</span>
<span class="cm"> * called.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">adb_handler_mutex</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_RWLOCK</span><span class="p">(</span><span class="n">adb_handler_lock</span><span class="p">);</span>

<span class="cp">#if 0</span><span class="c"></span>
<span class="c">static void printADBreply(struct adb_request *req)</span>
<span class="c">{</span>
<span class="c">        int i;</span>

<span class="c">        printk(&quot;adb reply (%d)&quot;, req-&gt;reply_len);</span>
<span class="c">        for(i = 0; i &lt; req-&gt;reply_len; i++)</span>
<span class="c">                printk(&quot; %x&quot;, req-&gt;reply[i]);</span>
<span class="c">        printk(&quot;\n&quot;);</span>

<span class="c">}</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adb_scan_bus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">highFree</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">noMovement</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">devmask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adb_request</span> <span class="n">req</span><span class="p">;</span>
	
	<span class="cm">/* assumes adb_handler[] is all zeroes at this point */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* see if there is anything at address i */</span>
		<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span> <span class="o">|</span> <span class="n">ADBREQ_REPLY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="cm">/* one or more devices at this address */</span>
			<span class="n">adb_handler</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">original_address</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;</span> <span class="n">highFree</span><span class="p">)</span>
			<span class="n">highFree</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Note we reset noMovement to 0 each time we move a device */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">noMovement</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">noMovement</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">&amp;&amp;</span> <span class="n">highFree</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">noMovement</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adb_handler</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">original_address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Send a &quot;talk register 3&quot; command to address i</span>
<span class="cm">			 * to provoke a collision if there is more than</span>
<span class="cm">			 * one device at this address.</span>
<span class="cm">			 */</span>
			<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span> <span class="o">|</span> <span class="n">ADBREQ_REPLY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xf</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Move the device(s) which didn&#39;t detect a</span>
<span class="cm">			 * collision to address `highFree&#39;.  Hopefully</span>
<span class="cm">			 * this only moves one device.</span>
<span class="cm">			 */</span>
			<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">i</span><span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xb</span><span class="p">,</span> <span class="p">(</span><span class="n">highFree</span> <span class="o">|</span> <span class="mh">0x60</span><span class="p">),</span> <span class="mh">0xfe</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * See if anybody actually moved. This is suggested</span>
<span class="cm">			 * by HW TechNote 01:</span>
<span class="cm">			 *</span>
<span class="cm">			 * http://developer.apple.com/technotes/hw/hw_01.html</span>
<span class="cm">			 */</span>
			<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span> <span class="o">|</span> <span class="n">ADBREQ_REPLY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">highFree</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply_len</span> <span class="o">&lt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
			<span class="cm">/*</span>
<span class="cm">			 * Test whether there are any device(s) left</span>
<span class="cm">			 * at address i.</span>
<span class="cm">			 */</span>
			<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span> <span class="o">|</span> <span class="n">ADBREQ_REPLY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				    <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xf</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply_len</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * There are still one or more devices</span>
<span class="cm">				 * left at address i.  Register the one(s)</span>
<span class="cm">				 * we moved to `highFree&#39;, and find a new</span>
<span class="cm">				 * value for highFree.</span>
<span class="cm">				 */</span>
				<span class="n">adb_handler</span><span class="p">[</span><span class="n">highFree</span><span class="p">].</span><span class="n">original_address</span> <span class="o">=</span>
					<span class="n">adb_handler</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">original_address</span><span class="p">;</span>
				<span class="k">while</span> <span class="p">(</span><span class="n">highFree</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span>
				       <span class="n">adb_handler</span><span class="p">[</span><span class="n">highFree</span><span class="p">].</span><span class="n">original_address</span><span class="p">)</span>
					<span class="n">highFree</span><span class="o">--</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">highFree</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">)</span>
					<span class="k">break</span><span class="p">;</span>

				<span class="n">noMovement</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="p">{</span>
				<span class="cm">/*</span>
<span class="cm">				 * No devices left at address i; move the</span>
<span class="cm">				 * one(s) we moved to `highFree&#39; back to i.</span>
<span class="cm">				 */</span>
				<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">highFree</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xb</span><span class="p">,</span>
					    <span class="p">(</span><span class="n">i</span> <span class="o">|</span> <span class="mh">0x60</span><span class="p">),</span> <span class="mh">0xfe</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>	
	<span class="p">}</span>

	<span class="cm">/* Now fill in the handler_id field of the adb_handler entries. */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;adb devices:&quot;</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adb_handler</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">original_address</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span> <span class="o">|</span> <span class="n">ADBREQ_REPLY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
			    <span class="p">(</span><span class="n">i</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0xf</span><span class="p">);</span>
		<span class="n">adb_handler</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handler_id</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot; [%d]: %d %x&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">adb_handler</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">original_address</span><span class="p">,</span>
		       <span class="n">adb_handler</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handler_id</span><span class="p">);</span>
		<span class="n">devmask</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">devmask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * This kernel task handles ADB probing. It dies once probing is</span>
<span class="cm"> * completed.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">adb_probe_task</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;adb: starting probe task...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">do_adb_reset_bus</span><span class="p">();</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;adb: finished probe task...</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_probe_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">__adb_probe_task</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">bullshit</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">kthread_run</span><span class="p">(</span><span class="n">adb_probe_task</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;kadbprobe&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DECLARE_WORK</span><span class="p">(</span><span class="n">adb_reset_work</span><span class="p">,</span> <span class="n">__adb_probe_task</span><span class="p">);</span>

<span class="kt">int</span>
<span class="nf">adb_reset_bus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">__adb_probe_sync</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">do_adb_reset_bus</span><span class="p">();</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_probe_mutex</span><span class="p">);</span>
	<span class="n">schedule_work</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_reset_work</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_PM</span>
<span class="cm">/*</span>
<span class="cm"> * notify clients before sleep</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adb_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adb_got_sleep</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="cm">/* We need to get a lock on the probe thread */</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_probe_mutex</span><span class="p">);</span>
	<span class="cm">/* Stop autopoll */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">autopoll</span><span class="p">)</span>
		<span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">autopoll</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_client_list</span><span class="p">,</span> <span class="n">ADB_MSG_POWERDOWN</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * reset bus after sleep</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adb_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">adb_got_sleep</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_probe_mutex</span><span class="p">);</span>
	<span class="n">adb_reset_bus</span><span class="p">();</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PM */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">adb_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adb_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef CONFIG_PPC32</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine_is</span><span class="p">(</span><span class="n">chrp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>
<span class="cp">#ifdef CONFIG_MAC</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">MACH_IS_MAC</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="cm">/* xmon may do early-init */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adb_inited</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adb_inited</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		
	<span class="n">adb_controller</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">while</span> <span class="p">((</span><span class="n">driver</span> <span class="o">=</span> <span class="n">adb_driver_list</span><span class="p">[</span><span class="n">i</span><span class="o">++</span><span class="p">])</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">())</span> <span class="p">{</span>
			<span class="n">adb_controller</span> <span class="o">=</span> <span class="n">driver</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adb_controller</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">init</span> <span class="o">&amp;&amp;</span>
	    <span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">init</span><span class="p">())</span>
		<span class="n">adb_controller</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adb_controller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;Warning: no ADB interface detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
<span class="cp">#ifdef CONFIG_PPC</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;AAPL,PowerBook1998&quot;</span><span class="p">)</span> <span class="o">||</span>
			<span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerBook1,1&quot;</span><span class="p">))</span>
			<span class="n">sleepy_trackpad</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC */</span><span class="cp"></span>

		<span class="n">adbdev_init</span><span class="p">();</span>
		<span class="n">adb_reset_bus</span><span class="p">();</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="n">device_initcall</span><span class="p">(</span><span class="n">adb_init</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">do_adb_reset_bus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">adb_controller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		
	<span class="k">if</span> <span class="p">(</span><span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">autopoll</span><span class="p">)</span>
		<span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">autopoll</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

	<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_client_list</span><span class="p">,</span>
		<span class="n">ADB_MSG_PRE_RESET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sleepy_trackpad</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Let the trackpad settle down */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_mutex</span><span class="p">);</span>
	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_lock</span><span class="p">);</span>
	<span class="n">memset</span><span class="p">(</span><span class="n">adb_handler</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adb_handler</span><span class="p">));</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_lock</span><span class="p">);</span>

	<span class="cm">/* That one is still a bit synchronous, oh well... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">reset_bus</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">reset_bus</span><span class="p">();</span>
	<span class="k">else</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sleepy_trackpad</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Let the trackpad settle down */</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">1500</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">autopoll_devs</span> <span class="o">=</span> <span class="n">adb_scan_bus</span><span class="p">();</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">autopoll</span><span class="p">)</span>
			<span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">autopoll</span><span class="p">(</span><span class="n">autopoll_devs</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_mutex</span><span class="p">);</span>

	<span class="n">blocking_notifier_call_chain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_client_list</span><span class="p">,</span>
		<span class="n">ADB_MSG_POST_RESET</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">adb_poll</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">adb_controller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span><span class="o">||</span><span class="p">(</span><span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">poll</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">poll</span><span class="p">();</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">adb_sync_req_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="o">*</span><span class="n">comp</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>

	<span class="n">complete</span><span class="p">(</span><span class="n">comp</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">adb_request</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">done</span><span class="p">)(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="p">),</span>
	    <span class="kt">int</span> <span class="n">flags</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nbytes</span><span class="p">,</span> <span class="p">...)</span>
<span class="p">{</span>
	<span class="kt">va_list</span> <span class="n">list</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">completion</span> <span class="n">comp</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">adb_controller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">send_request</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nbytes</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">=</span> <span class="n">nbytes</span><span class="o">+</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">done</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_expected</span> <span class="o">=</span> <span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ADBREQ_REPLY</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ADB_PACKET</span><span class="p">;</span>
	<span class="n">va_start</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="n">nbytes</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nbytes</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">list</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>
	<span class="n">va_end</span><span class="p">(</span><span class="n">list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ADBREQ_NOSEND</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* Synchronous requests block using an on-stack completion */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ADBREQ_SYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">WARN_ON</span><span class="p">(</span><span class="n">done</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">adb_sync_req_done</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">comp</span><span class="p">;</span>
		<span class="n">init_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">send_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">ADBREQ_SYNC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">rc</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">)</span>
		<span class="n">wait_for_completion</span><span class="p">(</span><span class="o">&amp;</span><span class="n">comp</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

 <span class="cm">/* Ultimately this should return the number of devices with</span>
<span class="cm">    the given default id.</span>
<span class="cm">    And it does it now ! Note: changed behaviour: This function</span>
<span class="cm">    will now register if default_id _and_ handler_id both match</span>
<span class="cm">    but handler_id can be left to 0 to match with default_id only.</span>
<span class="cm">    When handler_id is set, this function will try to adjust</span>
<span class="cm">    the handler_id id it doesn&#39;t match. */</span>
<span class="kt">int</span>
<span class="nf">adb_register</span><span class="p">(</span><span class="kt">int</span> <span class="n">default_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">handler_id</span><span class="p">,</span> <span class="k">struct</span> <span class="n">adb_ids</span> <span class="o">*</span><span class="n">ids</span><span class="p">,</span>
	     <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">))</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_mutex</span><span class="p">);</span>
	<span class="n">ids</span><span class="o">-&gt;</span><span class="n">nids</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">adb_handler</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">original_address</span> <span class="o">==</span> <span class="n">default_id</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="o">!</span><span class="n">handler_id</span> <span class="o">||</span> <span class="p">(</span><span class="n">handler_id</span> <span class="o">==</span> <span class="n">adb_handler</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handler_id</span><span class="p">)</span> <span class="o">||</span> 
		    <span class="n">try_handler_change</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">handler_id</span><span class="p">)))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">adb_handler</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handler</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span>
				       <span class="s">&quot;Two handlers for ADB device %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">default_id</span><span class="p">);</span>
				<span class="k">continue</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_lock</span><span class="p">);</span>
			<span class="n">adb_handler</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">handler</span> <span class="o">=</span> <span class="n">handler</span><span class="p">;</span>
			<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_lock</span><span class="p">);</span>
			<span class="n">ids</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">[</span><span class="n">ids</span><span class="o">-&gt;</span><span class="n">nids</span><span class="o">++</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ids</span><span class="o">-&gt;</span><span class="n">nids</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">adb_unregister</span><span class="p">(</span><span class="kt">int</span> <span class="n">index</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_mutex</span><span class="p">);</span>
	<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adb_handler</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">handler</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">while</span><span class="p">(</span><span class="n">adb_handler</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">busy</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_lock</span><span class="p">);</span>
			<span class="n">yield</span><span class="p">();</span>
			<span class="n">write_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">adb_handler</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">handler</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">write_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_lock</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">adb_input</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autopoll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
	<span class="k">static</span> <span class="kt">int</span> <span class="n">dump_adb_input</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

	<span class="cm">/* We skip keystrokes and mouse moves when the sleep process</span>
<span class="cm">	 * has been started. We stop autopoll, but this is another security</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adb_got_sleep</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
		
	<span class="n">id</span> <span class="o">=</span> <span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dump_adb_input</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;adb packet: &quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nb</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot; %x&quot;</span><span class="p">,</span> <span class="n">buf</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;, id = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">write_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">handler</span> <span class="o">=</span> <span class="n">adb_handler</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">handler</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handler</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">adb_handler</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">write_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">handler</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="n">buf</span><span class="p">,</span> <span class="n">nb</span><span class="p">,</span> <span class="n">autopoll</span><span class="p">);</span>
		<span class="n">wmb</span><span class="p">();</span>
		<span class="n">adb_handler</span><span class="p">[</span><span class="n">id</span><span class="p">].</span><span class="n">busy</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
		
<span class="p">}</span>

<span class="cm">/* Try to change handler to new_id. Will return 1 if successful. */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">try_handler_change</span><span class="p">(</span><span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adb_request</span> <span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adb_handler</span><span class="p">[</span><span class="n">address</span><span class="p">].</span><span class="n">handler_id</span> <span class="o">==</span> <span class="n">new_id</span><span class="p">)</span>
	    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
	    <span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">address</span> <span class="o">|</span> <span class="mh">0x20</span><span class="p">,</span> <span class="n">new_id</span><span class="p">);</span>
	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span> <span class="o">|</span> <span class="n">ADBREQ_REPLY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
	    <span class="n">ADB_READREG</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="mi">3</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply_len</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
	    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">!=</span> <span class="n">new_id</span><span class="p">)</span>
	    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">adb_handler</span><span class="p">[</span><span class="n">address</span><span class="p">].</span><span class="n">handler_id</span> <span class="o">=</span> <span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">adb_try_handler_change</span><span class="p">(</span><span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="n">new_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_mutex</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">try_handler_change</span><span class="p">(</span><span class="n">address</span><span class="p">,</span> <span class="n">new_id</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="nf">adb_get_infos</span><span class="p">(</span><span class="kt">int</span> <span class="n">address</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">original_address</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">handler_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_mutex</span><span class="p">);</span>
	<span class="o">*</span><span class="n">original_address</span> <span class="o">=</span> <span class="n">adb_handler</span><span class="p">[</span><span class="n">address</span><span class="p">].</span><span class="n">original_address</span><span class="p">;</span>
	<span class="o">*</span><span class="n">handler_id</span> <span class="o">=</span> <span class="n">adb_handler</span><span class="p">[</span><span class="n">address</span><span class="p">].</span><span class="n">handler_id</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="p">(</span><span class="o">*</span><span class="n">original_address</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * /dev/adb device driver.</span>
<span class="cm"> */</span>

<span class="cp">#define ADB_MAJOR	56	</span><span class="cm">/* major number for /dev/adb */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">adbdev_state</span> <span class="p">{</span>
	<span class="n">spinlock_t</span>	<span class="n">lock</span><span class="p">;</span>
	<span class="n">atomic_t</span>	<span class="n">n_pending</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">completed</span><span class="p">;</span>
  	<span class="n">wait_queue_head_t</span> <span class="n">wait_queue</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">inuse</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">adb_write_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adbdev_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">adbdev_state</span> <span class="o">*</span><span class="p">)</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">arg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_pending</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">inuse</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_pending</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">adb_request</span> <span class="o">**</span><span class="n">ap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">completed</span><span class="p">;</span>
		<span class="k">while</span> <span class="p">(</span><span class="o">*</span><span class="n">ap</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">ap</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="o">*</span><span class="n">ap</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">next</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="o">*</span><span class="n">ap</span> <span class="o">=</span> <span class="n">req</span><span class="p">;</span>
		<span class="n">wake_up_interruptible</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">do_adb_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span>	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">switch</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
	<span class="p">{</span>
	<span class="k">case</span> <span class="n">ADB_QUERY_GETDEVINFO</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">&lt;</span> <span class="mi">3</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_mutex</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">adb_handler</span><span class="p">[</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]].</span><span class="n">original_address</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">adb_handler</span><span class="p">[</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]].</span><span class="n">handler_id</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_handler_mutex</span><span class="p">);</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
		<span class="n">adb_write_done</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adb_open</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adbdev_state</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">iminor</span><span class="p">(</span><span class="n">inode</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="n">adb_controller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">state</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">adbdev_state</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">spin_lock_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_pending</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">completed</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">);</span>
	<span class="n">state</span><span class="o">-&gt;</span><span class="n">inuse</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">adb_release</span><span class="p">(</span><span class="k">struct</span> <span class="n">inode</span> <span class="o">*</span><span class="n">inode</span><span class="p">,</span> <span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adbdev_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_pending</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
		    <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">completed</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">state</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">inuse</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_mutex</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">adb_read</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			<span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adbdev_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>
	<span class="n">wait_queue_t</span> <span class="n">wait</span> <span class="o">=</span> <span class="n">__WAITQUEUE_INITIALIZER</span><span class="p">(</span><span class="n">wait</span><span class="p">,</span><span class="n">current</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">))</span>
		<span class="n">count</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_WRITE</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">add_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_INTERRUPTIBLE</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
		<span class="n">req</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">completed</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">completed</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">next</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_pending</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">!=</span> <span class="nb">NULL</span> <span class="o">||</span> <span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		
		<span class="k">if</span> <span class="p">(</span><span class="n">file</span><span class="o">-&gt;</span><span class="n">f_flags</span> <span class="o">&amp;</span> <span class="n">O_NONBLOCK</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">signal_pending</span><span class="p">(</span><span class="n">current</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ERESTARTSYS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">schedule</span><span class="p">();</span>
		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">set_current_state</span><span class="p">(</span><span class="n">TASK_RUNNING</span><span class="p">);</span>
	<span class="n">remove_wait_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="n">count</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">copy_to_user</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="n">req</span><span class="o">-&gt;</span><span class="n">reply</span><span class="p">,</span> <span class="n">ret</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">adb_write</span><span class="p">(</span><span class="k">struct</span> <span class="n">file</span> <span class="o">*</span><span class="n">file</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">__user</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span>
			 <span class="kt">size_t</span> <span class="n">count</span><span class="p">,</span> <span class="n">loff_t</span> <span class="o">*</span><span class="n">ppos</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="cm">/*, i*/</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adbdev_state</span> <span class="o">*</span><span class="n">state</span> <span class="o">=</span> <span class="n">file</span><span class="o">-&gt;</span><span class="n">private_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="o">||</span> <span class="n">count</span> <span class="o">&gt;</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adb_controller</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">access_ok</span><span class="p">(</span><span class="n">VERIFY_READ</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span><span class="p">),</span>
					     <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">req</span><span class="o">-&gt;</span><span class="n">nbytes</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">done</span> <span class="o">=</span> <span class="n">adb_write_done</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">arg</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">state</span><span class="p">;</span>
	<span class="n">req</span><span class="o">-&gt;</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EFAULT</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">copy_from_user</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">buf</span><span class="p">,</span> <span class="n">count</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_pending</span><span class="p">);</span>

	<span class="cm">/* If a probe is in progress or we are sleeping, wait for it to complete */</span>
	<span class="n">down</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_probe_mutex</span><span class="p">);</span>

	<span class="cm">/* Queries are special requests sent to the ADB driver itself */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ADB_QUERY</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">do_adb_query</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_probe_mutex</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="cm">/* Special case for ADB_BUSRESET request, all others are sent to</span>
<span class="cm">	   the controller */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">ADB_PACKET</span><span class="p">)</span><span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">count</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
		<span class="o">&amp;&amp;</span><span class="p">(</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">ADB_BUSRESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">do_adb_reset_bus</span><span class="p">();</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_probe_mutex</span><span class="p">);</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_pending</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">count</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>	
		<span class="n">req</span><span class="o">-&gt;</span><span class="n">reply_expected</span> <span class="o">=</span> <span class="p">((</span><span class="n">req</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xc</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0xc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adb_controller</span> <span class="o">&amp;&amp;</span> <span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">send_request</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">adb_controller</span><span class="o">-&gt;</span><span class="n">send_request</span><span class="p">(</span><span class="n">req</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENXIO</span><span class="p">;</span>
		<span class="n">up</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_probe_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">n_pending</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>

<span class="nl">out:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">req</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">file_operations</span> <span class="n">adb_fops</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">llseek</span>		<span class="o">=</span> <span class="n">no_llseek</span><span class="p">,</span>
	<span class="p">.</span><span class="n">read</span>		<span class="o">=</span> <span class="n">adb_read</span><span class="p">,</span>
	<span class="p">.</span><span class="n">write</span>		<span class="o">=</span> <span class="n">adb_write</span><span class="p">,</span>
	<span class="p">.</span><span class="n">open</span>		<span class="o">=</span> <span class="n">adb_open</span><span class="p">,</span>
	<span class="p">.</span><span class="n">release</span>	<span class="o">=</span> <span class="n">adb_release</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">adb_pfdrv</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;adb&quot;</span><span class="p">,</span>
	<span class="p">},</span>
<span class="cp">#ifdef CONFIG_PM</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">adb_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">adb_resume</span><span class="p">,</span>
<span class="cp">#endif</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="n">adb_pfdev</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;adb&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span>
<span class="nf">adb_dummy_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span> <span class="o">==</span> <span class="o">&amp;</span><span class="n">adb_pfdev</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span>
<span class="nf">adbdev_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">register_chrdev</span><span class="p">(</span><span class="n">ADB_MAJOR</span><span class="p">,</span> <span class="s">&quot;adb&quot;</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">adb_fops</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;adb: unable to get major %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ADB_MAJOR</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adb_dev_class</span> <span class="o">=</span> <span class="n">class_create</span><span class="p">(</span><span class="n">THIS_MODULE</span><span class="p">,</span> <span class="s">&quot;adb&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">IS_ERR</span><span class="p">(</span><span class="n">adb_dev_class</span><span class="p">))</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">device_create</span><span class="p">(</span><span class="n">adb_dev_class</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">MKDEV</span><span class="p">(</span><span class="n">ADB_MAJOR</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="nb">NULL</span><span class="p">,</span> <span class="s">&quot;adb&quot;</span><span class="p">);</span>

	<span class="n">platform_device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_pfdev</span><span class="p">);</span>
	<span class="n">platform_driver_probe</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_pfdrv</span><span class="p">,</span> <span class="n">adb_dummy_probe</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
