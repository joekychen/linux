<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › macintosh › windfarm_pm121.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>windfarm_pm121.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * Windfarm PowerMac thermal control. iMac G5 iSight</span>
<span class="cm"> *</span>
<span class="cm"> * (c) Copyright 2007 Étienne Bersac &lt;bersace@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Bits &amp; pieces from windfarm_pm81.c by (c) Copyright 2005 Benjamin</span>
<span class="cm"> * Herrenschmidt, IBM Corp. &lt;benh@kernel.crashing.org&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Released under the term of the GNU GPL v2.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * PowerMac12,1</span>
<span class="cm"> * ============</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * The algorithm used is the PID control algorithm, used the same way</span>
<span class="cm"> * the published Darwin code does, using the same values that are</span>
<span class="cm"> * present in the Darwin 8.10 snapshot property lists (note however</span>
<span class="cm"> * that none of the code has been re-used, it&#39;s a complete</span>
<span class="cm"> * re-implementation</span>
<span class="cm"> *</span>
<span class="cm"> * There is two models using PowerMac12,1. Model 2 is iMac G5 iSight</span>
<span class="cm"> * 17&quot; while Model 3 is iMac G5 20&quot;. They do have both the same</span>
<span class="cm"> * controls with a tiny difference. The control-ids of hard-drive-fan</span>
<span class="cm"> * and cpu-fan is swapped.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Target Correction :</span>
<span class="cm"> *</span>
<span class="cm"> * controls have a target correction calculated as :</span>
<span class="cm"> *</span>
<span class="cm"> * new_min = ((((average_power * slope) &gt;&gt; 16) + offset) &gt;&gt; 16) + min_value</span>
<span class="cm"> * new_value = max(new_value, max(new_min, 0))</span>
<span class="cm"> *</span>
<span class="cm"> * OD Fan control correction.</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 2</span>
<span class="cm"> *   offset		: -19563152</span>
<span class="cm"> *   slope		:  1956315</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 3</span>
<span class="cm"> *   offset		: -15650652</span>
<span class="cm"> *   slope		:  1565065</span>
<span class="cm"> *</span>
<span class="cm"> * HD Fan control correction.</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 2</span>
<span class="cm"> *   offset		: -15650652</span>
<span class="cm"> *   slope		:  1565065</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 3</span>
<span class="cm"> *   offset		: -19563152</span>
<span class="cm"> *   slope		:  1956315</span>
<span class="cm"> *</span>
<span class="cm"> * CPU Fan control correction.</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 2</span>
<span class="cm"> *   offset		: -25431900</span>
<span class="cm"> *   slope		:  2543190</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 3</span>
<span class="cm"> *   offset		: -15650652</span>
<span class="cm"> *   slope		:  1565065</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * Target rubber-banding :</span>
<span class="cm"> *</span>
<span class="cm"> * Some controls have a target correction which depends on another</span>
<span class="cm"> * control value. The correction is computed in the following way :</span>
<span class="cm"> *</span>
<span class="cm"> * new_min = ref_value * slope + offset</span>
<span class="cm"> *</span>
<span class="cm"> * ref_value is the value of the reference control. If new_min is</span>
<span class="cm"> * greater than 0, then we correct the target value using :</span>
<span class="cm"> *</span>
<span class="cm"> * new_target = max (new_target, new_min &gt;&gt; 16)</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id : 2</span>
<span class="cm"> *   control	: cpu-fan</span>
<span class="cm"> *   ref	: optical-drive-fan</span>
<span class="cm"> *   offset	: -15650652</span>
<span class="cm"> *   slope	: 1565065</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id : 3</span>
<span class="cm"> *   control	: optical-drive-fan</span>
<span class="cm"> *   ref	: hard-drive-fan</span>
<span class="cm"> *   offset	: -32768000</span>
<span class="cm"> *   slope	: 65536</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * In order to have the moste efficient correction with those</span>
<span class="cm"> * dependencies, we must trigger HD loop before OD loop before CPU</span>
<span class="cm"> * loop.</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * The various control loops found in Darwin config file are:</span>
<span class="cm"> *</span>
<span class="cm"> * HD Fan control loop.</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 2</span>
<span class="cm"> *   control        : hard-drive-fan</span>
<span class="cm"> *   sensor         : hard-drive-temp</span>
<span class="cm"> *   PID params     : G_d = 0x00000000</span>
<span class="cm"> *                    G_p = 0x002D70A3</span>
<span class="cm"> *                    G_r = 0x00019999</span>
<span class="cm"> *                    History = 2 entries</span>
<span class="cm"> *                    Input target = 0x370000</span>
<span class="cm"> *                    Interval = 5s</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 3</span>
<span class="cm"> *   control        : hard-drive-fan</span>
<span class="cm"> *   sensor         : hard-drive-temp</span>
<span class="cm"> *   PID params     : G_d = 0x00000000</span>
<span class="cm"> *                    G_p = 0x002170A3</span>
<span class="cm"> *                    G_r = 0x00019999</span>
<span class="cm"> *                    History = 2 entries</span>
<span class="cm"> *                    Input target = 0x370000</span>
<span class="cm"> *                    Interval = 5s</span>
<span class="cm"> *</span>
<span class="cm"> * OD Fan control loop.</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 2</span>
<span class="cm"> *   control        : optical-drive-fan</span>
<span class="cm"> *   sensor         : optical-drive-temp</span>
<span class="cm"> *   PID params     : G_d = 0x00000000</span>
<span class="cm"> *                    G_p = 0x001FAE14</span>
<span class="cm"> *                    G_r = 0x00019999</span>
<span class="cm"> *                    History = 2 entries</span>
<span class="cm"> *                    Input target = 0x320000</span>
<span class="cm"> *                    Interval = 5s</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 3</span>
<span class="cm"> *   control        : optical-drive-fan</span>
<span class="cm"> *   sensor         : optical-drive-temp</span>
<span class="cm"> *   PID params     : G_d = 0x00000000</span>
<span class="cm"> *                    G_p = 0x001FAE14</span>
<span class="cm"> *                    G_r = 0x00019999</span>
<span class="cm"> *                    History = 2 entries</span>
<span class="cm"> *                    Input target = 0x320000</span>
<span class="cm"> *                    Interval = 5s</span>
<span class="cm"> *</span>
<span class="cm"> * GPU Fan control loop.</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 2</span>
<span class="cm"> *   control        : hard-drive-fan</span>
<span class="cm"> *   sensor         : gpu-temp</span>
<span class="cm"> *   PID params     : G_d = 0x00000000</span>
<span class="cm"> *                    G_p = 0x002A6666</span>
<span class="cm"> *                    G_r = 0x00019999</span>
<span class="cm"> *                    History = 2 entries</span>
<span class="cm"> *                    Input target = 0x5A0000</span>
<span class="cm"> *                    Interval = 5s</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 3</span>
<span class="cm"> *   control        : cpu-fan</span>
<span class="cm"> *   sensor         : gpu-temp</span>
<span class="cm"> *   PID params     : G_d = 0x00000000</span>
<span class="cm"> *                    G_p = 0x0010CCCC</span>
<span class="cm"> *                    G_r = 0x00019999</span>
<span class="cm"> *                    History = 2 entries</span>
<span class="cm"> *                    Input target = 0x500000</span>
<span class="cm"> *                    Interval = 5s</span>
<span class="cm"> *</span>
<span class="cm"> * KODIAK (aka northbridge) Fan control loop.</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 2</span>
<span class="cm"> *   control        : optical-drive-fan</span>
<span class="cm"> *   sensor         : north-bridge-temp</span>
<span class="cm"> *   PID params     : G_d = 0x00000000</span>
<span class="cm"> *                    G_p = 0x003BD70A</span>
<span class="cm"> *                    G_r = 0x00019999</span>
<span class="cm"> *                    History = 2 entries</span>
<span class="cm"> *                    Input target = 0x550000</span>
<span class="cm"> *                    Interval = 5s</span>
<span class="cm"> *</span>
<span class="cm"> * # model_id: 3</span>
<span class="cm"> *   control        : hard-drive-fan</span>
<span class="cm"> *   sensor         : north-bridge-temp</span>
<span class="cm"> *   PID params     : G_d = 0x00000000</span>
<span class="cm"> *                    G_p = 0x0030F5C2</span>
<span class="cm"> *                    G_r = 0x00019999</span>
<span class="cm"> *                    History = 2 entries</span>
<span class="cm"> *                    Input target = 0x550000</span>
<span class="cm"> *                    Interval = 5s</span>
<span class="cm"> *</span>
<span class="cm"> * CPU Fan control loop.</span>
<span class="cm"> *</span>
<span class="cm"> *   control        : cpu-fan</span>
<span class="cm"> *   sensors        : cpu-temp, cpu-power</span>
<span class="cm"> *   PID params     : from SDB partition</span>
<span class="cm"> *</span>
<span class="cm"> *</span>
<span class="cm"> * CPU Slew control loop.</span>
<span class="cm"> *</span>
<span class="cm"> *   control        : cpufreq-clamp</span>
<span class="cm"> *   sensor         : cpu-temp</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#undef	DEBUG</span>

<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>
<span class="cp">#include &lt;linux/wait.h&gt;</span>
<span class="cp">#include &lt;linux/kmod.h&gt;</span>
<span class="cp">#include &lt;linux/device.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;asm/prom.h&gt;</span>
<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/sections.h&gt;</span>
<span class="cp">#include &lt;asm/smu.h&gt;</span>

<span class="cp">#include &quot;windfarm.h&quot;</span>
<span class="cp">#include &quot;windfarm_pid.h&quot;</span>

<span class="cp">#define VERSION &quot;0.3&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pm121_mach_model</span><span class="p">;</span>	<span class="cm">/* machine model id */</span>

<span class="cm">/* Controls &amp; sensors */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_sensor</span>	<span class="o">*</span><span class="n">sensor_cpu_power</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_sensor</span>	<span class="o">*</span><span class="n">sensor_cpu_temp</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_sensor</span>	<span class="o">*</span><span class="n">sensor_cpu_voltage</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_sensor</span>	<span class="o">*</span><span class="n">sensor_cpu_current</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_sensor</span>	<span class="o">*</span><span class="n">sensor_gpu_temp</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_sensor</span>	<span class="o">*</span><span class="n">sensor_north_bridge_temp</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_sensor</span>	<span class="o">*</span><span class="n">sensor_hard_drive_temp</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_sensor</span>	<span class="o">*</span><span class="n">sensor_optical_drive_temp</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_sensor</span>	<span class="o">*</span><span class="n">sensor_incoming_air_temp</span><span class="p">;</span> <span class="cm">/* unused ! */</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">FAN_CPU</span><span class="p">,</span>
	<span class="n">FAN_HD</span><span class="p">,</span>
	<span class="n">FAN_OD</span><span class="p">,</span>
	<span class="n">CPUFREQ</span><span class="p">,</span>
	<span class="n">N_CONTROLS</span>
<span class="p">};</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_control</span> <span class="o">*</span><span class="n">controls</span><span class="p">[</span><span class="n">N_CONTROLS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>

<span class="cm">/* Set to kick the control loop into life */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pm121_all_controls_ok</span><span class="p">,</span> <span class="n">pm121_all_sensors_ok</span><span class="p">,</span> <span class="n">pm121_started</span><span class="p">;</span>

<span class="k">enum</span> <span class="p">{</span>
	<span class="n">FAILURE_FAN</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">0</span><span class="p">,</span>
	<span class="n">FAILURE_SENSOR</span>		<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">,</span>
	<span class="n">FAILURE_OVERTEMP</span>	<span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span>
<span class="p">};</span>

<span class="cm">/* All sys loops. Note the HD before the OD loop in order to have it</span>
<span class="cm">   run before. */</span>
<span class="k">enum</span> <span class="p">{</span>
	<span class="n">LOOP_GPU</span><span class="p">,</span>		<span class="cm">/* control = hd or cpu, but luckily,</span>
<span class="cm">				   it doesn&#39;t matter */</span>
	<span class="n">LOOP_HD</span><span class="p">,</span>		<span class="cm">/* control = hd */</span>
	<span class="n">LOOP_KODIAK</span><span class="p">,</span>		<span class="cm">/* control = hd or od */</span>
	<span class="n">LOOP_OD</span><span class="p">,</span>		<span class="cm">/* control = od */</span>
	<span class="n">N_LOOPS</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">loop_names</span><span class="p">[</span><span class="n">N_LOOPS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="s">&quot;GPU&quot;</span><span class="p">,</span>
	<span class="s">&quot;HD&quot;</span><span class="p">,</span>
	<span class="s">&quot;KODIAK&quot;</span><span class="p">,</span>
	<span class="s">&quot;OD&quot;</span><span class="p">,</span>
<span class="p">};</span>

<span class="cp">#define	PM121_NUM_CONFIGS	2</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pm121_failure_state</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pm121_readjust</span><span class="p">,</span> <span class="n">pm121_skipping</span><span class="p">;</span>
<span class="k">static</span> <span class="n">s32</span> <span class="n">average_power</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">pm121_correction</span> <span class="p">{</span>
	<span class="kt">int</span>	<span class="n">offset</span><span class="p">;</span>
	<span class="kt">int</span>	<span class="n">slope</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pm121_correction</span> <span class="n">corrections</span><span class="p">[</span><span class="n">N_CONTROLS</span><span class="p">][</span><span class="n">PM121_NUM_CONFIGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* FAN_OD */</span>
	<span class="p">{</span>
		<span class="cm">/* MODEL 2 */</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">19563152</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">slope</span>	<span class="o">=</span>  <span class="mi">1956315</span>
		<span class="p">},</span>
		<span class="cm">/* MODEL 3 */</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">15650652</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">slope</span>	<span class="o">=</span>  <span class="mi">1565065</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="cm">/* FAN_HD */</span>
	<span class="p">{</span>
		<span class="cm">/* MODEL 2 */</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">15650652</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">slope</span>	<span class="o">=</span>  <span class="mi">1565065</span>
		<span class="p">},</span>
		<span class="cm">/* MODEL 3 */</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">19563152</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">slope</span>	<span class="o">=</span>  <span class="mi">1956315</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="cm">/* FAN_CPU */</span>
	<span class="p">{</span>
		<span class="cm">/* MODEL 2 */</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">25431900</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">slope</span>	<span class="o">=</span>  <span class="mi">2543190</span>
		<span class="p">},</span>
		<span class="cm">/* MODEL 3 */</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">15650652</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">slope</span>	<span class="o">=</span>  <span class="mi">1565065</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="cm">/* CPUFREQ has no correction (and is not implemented at all) */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pm121_connection</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">control_id</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">ref_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm121_correction</span>	<span class="n">correction</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pm121_connection</span> <span class="n">pm121_connections</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* MODEL 2 */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">control_id</span>	<span class="o">=</span> <span class="n">FAN_CPU</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ref_id</span>	<span class="o">=</span> <span class="n">FAN_OD</span><span class="p">,</span>
	  <span class="p">{</span> <span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">32768000</span><span class="p">,</span>
	    <span class="p">.</span><span class="n">slope</span>	<span class="o">=</span>  <span class="mi">65536</span>
	  <span class="p">}</span>
	<span class="p">},</span>
	<span class="cm">/* MODEL 3 */</span>
	<span class="p">{</span> <span class="p">.</span><span class="n">control_id</span>	<span class="o">=</span> <span class="n">FAN_OD</span><span class="p">,</span>
	  <span class="p">.</span><span class="n">ref_id</span>	<span class="o">=</span> <span class="n">FAN_HD</span><span class="p">,</span>
	  <span class="p">{</span> <span class="p">.</span><span class="n">offset</span>	<span class="o">=</span> <span class="o">-</span><span class="mi">32768000</span><span class="p">,</span>
	    <span class="p">.</span><span class="n">slope</span>	<span class="o">=</span>  <span class="mi">65536</span>
	  <span class="p">}</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* pointer to the current model connection */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pm121_connection</span> <span class="o">*</span><span class="n">pm121_connection</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * ****** System Fans Control Loop ******</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* Since each loop handles only one control and we want to avoid</span>
<span class="cm"> * writing virtual control, we store the control correction with the</span>
<span class="cm"> * loop params. Some data are not set, there are common to all loop</span>
<span class="cm"> * and thus, hardcoded.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pm121_sys_param</span> <span class="p">{</span>
	<span class="cm">/* purely informative since we use mach_model-2 as index */</span>
	<span class="kt">int</span>			<span class="n">model_id</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wf_sensor</span>	<span class="o">**</span><span class="n">sensor</span><span class="p">;</span> <span class="cm">/* use sensor_id instead ? */</span>
	<span class="n">s32</span>			<span class="n">gp</span><span class="p">,</span> <span class="n">itarget</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">control_id</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pm121_sys_param</span>
<span class="n">pm121_sys_all_params</span><span class="p">[</span><span class="n">N_LOOPS</span><span class="p">][</span><span class="n">PM121_NUM_CONFIGS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* GPU Fan control loop */</span>
	<span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">model_id</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">sensor</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor_gpu_temp</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">gp</span>		<span class="o">=</span> <span class="mh">0x002A6666</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">itarget</span>	<span class="o">=</span> <span class="mh">0x5A0000</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">control_id</span>	<span class="o">=</span> <span class="n">FAN_HD</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">model_id</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">sensor</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor_gpu_temp</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">gp</span>		<span class="o">=</span> <span class="mh">0x0010CCCC</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">itarget</span>	<span class="o">=</span> <span class="mh">0x500000</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">control_id</span>	<span class="o">=</span> <span class="n">FAN_CPU</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="cm">/* HD Fan control loop */</span>
	<span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">model_id</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">sensor</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor_hard_drive_temp</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">gp</span>		<span class="o">=</span> <span class="mh">0x002D70A3</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">itarget</span>	<span class="o">=</span> <span class="mh">0x370000</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">control_id</span>	<span class="o">=</span> <span class="n">FAN_HD</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">model_id</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">sensor</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor_hard_drive_temp</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">gp</span>		<span class="o">=</span> <span class="mh">0x002170A3</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">itarget</span>	<span class="o">=</span> <span class="mh">0x370000</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">control_id</span>	<span class="o">=</span> <span class="n">FAN_HD</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="cm">/* KODIAK Fan control loop */</span>
	<span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">model_id</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">sensor</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor_north_bridge_temp</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">gp</span>		<span class="o">=</span> <span class="mh">0x003BD70A</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">itarget</span>	<span class="o">=</span> <span class="mh">0x550000</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">control_id</span>	<span class="o">=</span> <span class="n">FAN_OD</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">model_id</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">sensor</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor_north_bridge_temp</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">gp</span>		<span class="o">=</span> <span class="mh">0x0030F5C2</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">itarget</span>	<span class="o">=</span> <span class="mh">0x550000</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">control_id</span>	<span class="o">=</span> <span class="n">FAN_HD</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
	<span class="cm">/* OD Fan control loop */</span>
	<span class="p">{</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">model_id</span>	<span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">sensor</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor_optical_drive_temp</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">gp</span>		<span class="o">=</span> <span class="mh">0x001FAE14</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">itarget</span>	<span class="o">=</span> <span class="mh">0x320000</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">control_id</span>	<span class="o">=</span> <span class="n">FAN_OD</span><span class="p">,</span>
		<span class="p">},</span>
		<span class="p">{</span> <span class="p">.</span><span class="n">model_id</span>	<span class="o">=</span> <span class="mi">3</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">sensor</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">sensor_optical_drive_temp</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">gp</span>		<span class="o">=</span> <span class="mh">0x001FAE14</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">itarget</span>	<span class="o">=</span> <span class="mh">0x320000</span><span class="p">,</span>
		  <span class="p">.</span><span class="n">control_id</span>	<span class="o">=</span> <span class="n">FAN_OD</span><span class="p">,</span>
		<span class="p">},</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="cm">/* the hardcoded values */</span>
<span class="cp">#define	PM121_SYS_GD		0x00000000</span>
<span class="cp">#define	PM121_SYS_GR		0x00019999</span>
<span class="cp">#define	PM121_SYS_HISTORY_SIZE	2</span>
<span class="cp">#define	PM121_SYS_INTERVAL	5</span>

<span class="cm">/* State data used by the system fans control loop</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pm121_sys_state</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">ticks</span><span class="p">;</span>
	<span class="n">s32</span>			<span class="n">setpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wf_pid_state</span>	<span class="n">pid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pm121_sys_state</span> <span class="o">*</span><span class="n">pm121_sys_state</span><span class="p">[</span><span class="n">N_LOOPS</span><span class="p">]</span> <span class="o">=</span> <span class="p">{};</span>

<span class="cm">/*</span>
<span class="cm"> * ****** CPU Fans Control Loop ******</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cp">#define PM121_CPU_INTERVAL	1</span>

<span class="cm">/* State data used by the cpu fans control loop</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pm121_cpu_state</span> <span class="p">{</span>
	<span class="kt">int</span>			<span class="n">ticks</span><span class="p">;</span>
	<span class="n">s32</span>			<span class="n">setpoint</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wf_cpu_pid_state</span>	<span class="n">pid</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pm121_cpu_state</span> <span class="o">*</span><span class="n">pm121_cpu_state</span><span class="p">;</span>



<span class="cm">/*</span>
<span class="cm"> * ***** Implementation *****</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* correction the value using the output-low-bound correction algo */</span>
<span class="k">static</span> <span class="n">s32</span> <span class="nf">pm121_correct</span><span class="p">(</span><span class="n">s32</span> <span class="n">new_setpoint</span><span class="p">,</span>
			 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control_id</span><span class="p">,</span>
			 <span class="n">s32</span> <span class="n">min</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">new_min</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm121_correction</span> <span class="o">*</span><span class="n">correction</span><span class="p">;</span>
	<span class="n">correction</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">corrections</span><span class="p">[</span><span class="n">control_id</span><span class="p">][</span><span class="n">pm121_mach_model</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>

	<span class="n">new_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">average_power</span> <span class="o">*</span> <span class="n">correction</span><span class="o">-&gt;</span><span class="n">slope</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">new_min</span> <span class="o">+=</span> <span class="n">correction</span><span class="o">-&gt;</span><span class="n">offset</span><span class="p">;</span>
	<span class="n">new_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_min</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="n">min</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">max3</span><span class="p">(</span><span class="n">new_setpoint</span><span class="p">,</span> <span class="n">new_min</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">s32</span> <span class="nf">pm121_connect</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">control_id</span><span class="p">,</span> <span class="n">s32</span> <span class="n">setpoint</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">new_min</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">new_setpoint</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pm121_connection</span><span class="o">-&gt;</span><span class="n">control_id</span> <span class="o">==</span> <span class="n">control_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">controls</span><span class="p">[</span><span class="n">control_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="n">control_id</span><span class="p">],</span>
						     <span class="o">&amp;</span><span class="n">value</span><span class="p">);</span>
		<span class="n">new_min</span> <span class="o">=</span> <span class="n">value</span> <span class="o">*</span> <span class="n">pm121_connection</span><span class="o">-&gt;</span><span class="n">correction</span><span class="p">.</span><span class="n">slope</span><span class="p">;</span>
		<span class="n">new_min</span> <span class="o">+=</span> <span class="n">pm121_connection</span><span class="o">-&gt;</span><span class="n">correction</span><span class="p">.</span><span class="n">offset</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">new_min</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">new_setpoint</span> <span class="o">=</span> <span class="n">max</span><span class="p">(</span><span class="n">setpoint</span><span class="p">,</span> <span class="p">(</span><span class="n">new_min</span> <span class="o">&gt;&gt;</span> <span class="mi">16</span><span class="p">));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">new_setpoint</span> <span class="o">!=</span> <span class="n">setpoint</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pm121: %s depending on %s, &quot;</span>
					 <span class="s">&quot;corrected from %d to %d RPM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
					 <span class="n">controls</span><span class="p">[</span><span class="n">control_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					 <span class="n">controls</span><span class="p">[</span><span class="n">pm121_connection</span><span class="o">-&gt;</span><span class="n">ref_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
					 <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">setpoint</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span> <span class="n">new_setpoint</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">new_setpoint</span> <span class="o">=</span> <span class="n">setpoint</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="cm">/* no connection */</span>
	<span class="k">else</span>
		<span class="n">new_setpoint</span> <span class="o">=</span> <span class="n">setpoint</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">new_setpoint</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* FAN LOOPS */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm121_create_sys_fans</span><span class="p">(</span><span class="kt">int</span> <span class="n">loop_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm121_sys_param</span> <span class="o">*</span><span class="n">param</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wf_pid_param</span> <span class="n">pid_param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wf_control</span> <span class="o">*</span><span class="n">control</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="cm">/* First, locate the params for this model */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PM121_NUM_CONFIGS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm121_sys_all_params</span><span class="p">[</span><span class="n">loop_id</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">model_id</span> <span class="o">==</span> <span class="n">pm121_mach_model</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pm121_sys_all_params</span><span class="p">[</span><span class="n">loop_id</span><span class="p">][</span><span class="n">i</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* No params found, put fans to max */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">param</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm121: %s fan config not found &quot;</span>
		       <span class="s">&quot; for this machine model</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">loop_names</span><span class="p">[</span><span class="n">loop_id</span><span class="p">]);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">control</span> <span class="o">=</span> <span class="n">controls</span><span class="p">[</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">control_id</span><span class="p">];</span>

	<span class="cm">/* Alloc &amp; initialize state */</span>
	<span class="n">pm121_sys_state</span><span class="p">[</span><span class="n">loop_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm121_sys_state</span><span class="p">),</span>
					   <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm121_sys_state</span><span class="p">[</span><span class="n">loop_id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm121: Memory allocation error</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pm121_sys_state</span><span class="p">[</span><span class="n">loop_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">ticks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Fill PID params */</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">gd</span>		<span class="o">=</span> <span class="n">PM121_SYS_GD</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">gp</span>		<span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">gp</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">gr</span>		<span class="o">=</span> <span class="n">PM121_SYS_GR</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">interval</span>	<span class="o">=</span> <span class="n">PM121_SYS_INTERVAL</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">history_len</span>	<span class="o">=</span> <span class="n">PM121_SYS_HISTORY_SIZE</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">itarget</span>	<span class="o">=</span> <span class="n">param</span><span class="o">-&gt;</span><span class="n">itarget</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">min</span>		<span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_min</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">max</span>		<span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_max</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>

	<span class="n">wf_pid_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm121_sys_state</span><span class="p">[</span><span class="n">loop_id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid_param</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pm121: %s Fan control loop initialized.</span><span class="se">\n</span><span class="s">&quot;</span>
		 <span class="s">&quot;       itarged=%d.%03d, min=%d RPM, max=%d RPM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">loop_names</span><span class="p">[</span><span class="n">loop_id</span><span class="p">],</span> <span class="n">FIX32TOPRINT</span><span class="p">(</span><span class="n">pid_param</span><span class="p">.</span><span class="n">itarget</span><span class="p">),</span>
		 <span class="n">pid_param</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">pid_param</span><span class="p">.</span><span class="n">max</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="cm">/* note that this is not optimal since another loop may still</span>
<span class="cm">	   control the same control */</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm121: failed to set up %s loop &quot;</span>
	       <span class="s">&quot;setting </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s"> to max speed.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">loop_names</span><span class="p">[</span><span class="n">loop_id</span><span class="p">],</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">control</span><span class="p">)</span>
		<span class="n">wf_control_set_max</span><span class="p">(</span><span class="n">control</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm121_sys_fans_tick</span><span class="p">(</span><span class="kt">int</span> <span class="n">loop_id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pm121_sys_param</span> <span class="o">*</span><span class="n">param</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pm121_sys_state</span> <span class="o">*</span><span class="n">st</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wf_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wf_control</span> <span class="o">*</span><span class="n">control</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">temp</span><span class="p">,</span> <span class="n">new_setpoint</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">param</span> <span class="o">=</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">pm121_sys_all_params</span><span class="p">[</span><span class="n">loop_id</span><span class="p">][</span><span class="n">pm121_mach_model</span><span class="o">-</span><span class="mi">2</span><span class="p">]);</span>
	<span class="n">st</span> <span class="o">=</span> <span class="n">pm121_sys_state</span><span class="p">[</span><span class="n">loop_id</span><span class="p">];</span>
	<span class="n">sensor</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">sensor</span><span class="p">);</span>
	<span class="n">control</span> <span class="o">=</span> <span class="n">controls</span><span class="p">[</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">control_id</span><span class="p">];</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ticks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm121_readjust</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">readjust</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ticks</span> <span class="o">=</span> <span class="n">PM121_SYS_INTERVAL</span><span class="p">;</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">(</span><span class="n">sensor</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;windfarm: %s sensor error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
		<span class="n">pm121_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_SENSOR</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pm121: %s Fan tick ! %s: %d.%03d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">loop_names</span><span class="p">[</span><span class="n">loop_id</span><span class="p">],</span> <span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		 <span class="n">FIX32TOPRINT</span><span class="p">(</span><span class="n">temp</span><span class="p">));</span>

	<span class="n">new_setpoint</span> <span class="o">=</span> <span class="n">wf_pid_run</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="cm">/* correction */</span>
	<span class="n">new_setpoint</span> <span class="o">=</span> <span class="n">pm121_correct</span><span class="p">(</span><span class="n">new_setpoint</span><span class="p">,</span>
				     <span class="n">param</span><span class="o">-&gt;</span><span class="n">control_id</span><span class="p">,</span>
				     <span class="n">st</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">min</span><span class="p">);</span>
	<span class="cm">/* linked corretion */</span>
	<span class="n">new_setpoint</span> <span class="o">=</span> <span class="n">pm121_connect</span><span class="p">(</span><span class="n">param</span><span class="o">-&gt;</span><span class="n">control_id</span><span class="p">,</span> <span class="n">new_setpoint</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">new_setpoint</span> <span class="o">==</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">setpoint</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">setpoint</span> <span class="o">=</span> <span class="n">new_setpoint</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pm121: %s corrected setpoint: %d RPM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">control</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">new_setpoint</span><span class="p">);</span>
 <span class="nl">readjust:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">control</span> <span class="o">&amp;&amp;</span> <span class="n">pm121_failure_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">control</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_value</span><span class="p">(</span><span class="n">control</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">setpoint</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;windfarm: %s fan error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">control</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="n">pm121_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_FAN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* CPU LOOP */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm121_create_cpu_fans</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">wf_cpu_pid_param</span> <span class="n">pid_param</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">smu_sdbp_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smu_sdbp_cpupiddata</span> <span class="o">*</span><span class="n">piddata</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">smu_sdbp_fvt</span> <span class="o">*</span><span class="n">fvt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wf_control</span> <span class="o">*</span><span class="n">fan_cpu</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">tmax</span><span class="p">,</span> <span class="n">tdelta</span><span class="p">,</span> <span class="n">maxpow</span><span class="p">,</span> <span class="n">powadj</span><span class="p">;</span>

	<span class="n">fan_cpu</span> <span class="o">=</span> <span class="n">controls</span><span class="p">[</span><span class="n">FAN_CPU</span><span class="p">];</span>

	<span class="cm">/* First, locate the PID params in SMU SBD */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="n">smu_get_sdb_partition</span><span class="p">(</span><span class="n">SMU_SDB_CPUPIDDATA_ID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm121: CPU PID fan config not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">piddata</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smu_sdbp_cpupiddata</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>

	<span class="cm">/* Get the FVT params for operating point 0 (the only supported one</span>
<span class="cm">	 * for now) in order to get tmax</span>
<span class="cm">	 */</span>
	<span class="n">hdr</span> <span class="o">=</span> <span class="n">smu_get_sdb_partition</span><span class="p">(</span><span class="n">SMU_SDB_FVT_ID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">fvt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">smu_sdbp_fvt</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">tmax</span> <span class="o">=</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span><span class="n">fvt</span><span class="o">-&gt;</span><span class="n">maxtemp</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">tmax</span> <span class="o">=</span> <span class="mh">0x5e0000</span><span class="p">;</span> <span class="cm">/* 94 degree default */</span>

	<span class="cm">/* Alloc &amp; initialize state */</span>
	<span class="n">pm121_cpu_state</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm121_cpu_state</span><span class="p">),</span>
				  <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm121_cpu_state</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="n">pm121_cpu_state</span><span class="o">-&gt;</span><span class="n">ticks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* Fill PID params */</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">interval</span> <span class="o">=</span> <span class="n">PM121_CPU_INTERVAL</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">history_len</span> <span class="o">=</span> <span class="n">piddata</span><span class="o">-&gt;</span><span class="n">history_len</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pid_param</span><span class="p">.</span><span class="n">history_len</span> <span class="o">&gt;</span> <span class="n">WF_CPU_PID_MAX_HISTORY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm121: History size overflow on &quot;</span>
		       <span class="s">&quot;CPU control loop (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">piddata</span><span class="o">-&gt;</span><span class="n">history_len</span><span class="p">);</span>
		<span class="n">pid_param</span><span class="p">.</span><span class="n">history_len</span> <span class="o">=</span> <span class="n">WF_CPU_PID_MAX_HISTORY</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">gd</span> <span class="o">=</span> <span class="n">piddata</span><span class="o">-&gt;</span><span class="n">gd</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">gp</span> <span class="o">=</span> <span class="n">piddata</span><span class="o">-&gt;</span><span class="n">gp</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">gr</span> <span class="o">=</span> <span class="n">piddata</span><span class="o">-&gt;</span><span class="n">gr</span> <span class="o">/</span> <span class="n">pid_param</span><span class="p">.</span><span class="n">history_len</span><span class="p">;</span>

	<span class="n">tdelta</span> <span class="o">=</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span><span class="n">piddata</span><span class="o">-&gt;</span><span class="n">target_temp_delta</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">maxpow</span> <span class="o">=</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span><span class="n">piddata</span><span class="o">-&gt;</span><span class="n">max_power</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>
	<span class="n">powadj</span> <span class="o">=</span> <span class="p">((</span><span class="n">s32</span><span class="p">)</span><span class="n">piddata</span><span class="o">-&gt;</span><span class="n">power_adj</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="n">pid_param</span><span class="p">.</span><span class="n">tmax</span> <span class="o">=</span> <span class="n">tmax</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">ttarget</span> <span class="o">=</span> <span class="n">tmax</span> <span class="o">-</span> <span class="n">tdelta</span><span class="p">;</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">pmaxadj</span> <span class="o">=</span> <span class="n">maxpow</span> <span class="o">-</span> <span class="n">powadj</span><span class="p">;</span>

	<span class="n">pid_param</span><span class="p">.</span><span class="n">min</span> <span class="o">=</span> <span class="n">fan_cpu</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_min</span><span class="p">(</span><span class="n">fan_cpu</span><span class="p">);</span>
	<span class="n">pid_param</span><span class="p">.</span><span class="n">max</span> <span class="o">=</span> <span class="n">fan_cpu</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_max</span><span class="p">(</span><span class="n">fan_cpu</span><span class="p">);</span>

	<span class="n">wf_cpu_pid_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm121_cpu_state</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pid_param</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pm121: CPU Fan control initialized.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;       ttarged=%d.%03d, tmax=%d.%03d, min=%d RPM, max=%d RPM,</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">FIX32TOPRINT</span><span class="p">(</span><span class="n">pid_param</span><span class="p">.</span><span class="n">ttarget</span><span class="p">),</span> <span class="n">FIX32TOPRINT</span><span class="p">(</span><span class="n">pid_param</span><span class="p">.</span><span class="n">tmax</span><span class="p">),</span>
		 <span class="n">pid_param</span><span class="p">.</span><span class="n">min</span><span class="p">,</span> <span class="n">pid_param</span><span class="p">.</span><span class="n">max</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm121: CPU fan config not found, max fan speed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="n">CPUFREQ</span><span class="p">])</span>
		<span class="n">wf_control_set_max</span><span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="n">CPUFREQ</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fan_cpu</span><span class="p">)</span>
		<span class="n">wf_control_set_max</span><span class="p">(</span><span class="n">fan_cpu</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm121_cpu_fans_tick</span><span class="p">(</span><span class="k">struct</span> <span class="n">pm121_cpu_state</span> <span class="o">*</span><span class="n">st</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">s32</span> <span class="n">new_setpoint</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span> <span class="n">power</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">wf_control</span> <span class="o">*</span><span class="n">fan_cpu</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">ticks</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm121_readjust</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">readjust</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">ticks</span> <span class="o">=</span> <span class="n">PM121_CPU_INTERVAL</span><span class="p">;</span>

	<span class="n">fan_cpu</span> <span class="o">=</span> <span class="n">controls</span><span class="p">[</span><span class="n">FAN_CPU</span><span class="p">];</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sensor_cpu_temp</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">(</span><span class="n">sensor_cpu_temp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">temp</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm121: CPU temp sensor error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rc</span><span class="p">);</span>
		<span class="n">pm121_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_SENSOR</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">rc</span> <span class="o">=</span> <span class="n">sensor_cpu_power</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">get_value</span><span class="p">(</span><span class="n">sensor_cpu_power</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">power</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm121: CPU power sensor error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">rc</span><span class="p">);</span>
		<span class="n">pm121_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_SENSOR</span><span class="p">;</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pm121: CPU Fans tick ! CPU temp: %d.%03d°C, power: %d.%03d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		 <span class="n">FIX32TOPRINT</span><span class="p">(</span><span class="n">temp</span><span class="p">),</span> <span class="n">FIX32TOPRINT</span><span class="p">(</span><span class="n">power</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">temp</span> <span class="o">&gt;</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">tmax</span><span class="p">)</span>
		<span class="n">pm121_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_OVERTEMP</span><span class="p">;</span>

	<span class="n">new_setpoint</span> <span class="o">=</span> <span class="n">wf_cpu_pid_run</span><span class="p">(</span><span class="o">&amp;</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">,</span> <span class="n">power</span><span class="p">,</span> <span class="n">temp</span><span class="p">);</span>

	<span class="cm">/* correction */</span>
	<span class="n">new_setpoint</span> <span class="o">=</span> <span class="n">pm121_correct</span><span class="p">(</span><span class="n">new_setpoint</span><span class="p">,</span>
				     <span class="n">FAN_CPU</span><span class="p">,</span>
				     <span class="n">st</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">min</span><span class="p">);</span>

	<span class="cm">/* connected correction */</span>
	<span class="n">new_setpoint</span> <span class="o">=</span> <span class="n">pm121_connect</span><span class="p">(</span><span class="n">FAN_CPU</span><span class="p">,</span> <span class="n">new_setpoint</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">st</span><span class="o">-&gt;</span><span class="n">setpoint</span> <span class="o">==</span> <span class="n">new_setpoint</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="n">st</span><span class="o">-&gt;</span><span class="n">setpoint</span> <span class="o">=</span> <span class="n">new_setpoint</span><span class="p">;</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pm121: CPU corrected setpoint: %d RPM</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">new_setpoint</span><span class="p">);</span>

 <span class="nl">readjust:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fan_cpu</span> <span class="o">&amp;&amp;</span> <span class="n">pm121_failure_state</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">fan_cpu</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_value</span><span class="p">(</span><span class="n">fan_cpu</span><span class="p">,</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">setpoint</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">rc</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pm121: %s fan error %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">fan_cpu</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">rc</span><span class="p">);</span>
			<span class="n">pm121_failure_state</span> <span class="o">|=</span> <span class="n">FAILURE_FAN</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ****** Common ******</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm121_tick</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">last_failure</span> <span class="o">=</span> <span class="n">pm121_failure_state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">new_failure</span><span class="p">;</span>
	<span class="n">s32</span> <span class="n">total_power</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm121_started</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pm121: creating control loops !</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_LOOPS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="n">pm121_create_sys_fans</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>

		<span class="n">pm121_create_cpu_fans</span><span class="p">();</span>
		<span class="n">pm121_started</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* skipping ticks */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm121_skipping</span> <span class="o">&amp;&amp;</span> <span class="o">--</span><span class="n">pm121_skipping</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* compute average power */</span>
	<span class="n">total_power</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">pm121_cpu_state</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">history_len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">total_power</span> <span class="o">+=</span> <span class="n">pm121_cpu_state</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">.</span><span class="n">powers</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

	<span class="n">average_power</span> <span class="o">=</span> <span class="n">total_power</span> <span class="o">/</span> <span class="n">pm121_cpu_state</span><span class="o">-&gt;</span><span class="n">pid</span><span class="p">.</span><span class="n">param</span><span class="p">.</span><span class="n">history_len</span><span class="p">;</span>


	<span class="n">pm121_failure_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_LOOPS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pm121_sys_state</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="n">pm121_sys_fans_tick</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pm121_cpu_state</span><span class="p">)</span>
		<span class="n">pm121_cpu_fans_tick</span><span class="p">(</span><span class="n">pm121_cpu_state</span><span class="p">);</span>

	<span class="n">pm121_readjust</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">new_failure</span> <span class="o">=</span> <span class="n">pm121_failure_state</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">last_failure</span><span class="p">;</span>

	<span class="cm">/* If entering failure mode, clamp cpufreq and ramp all</span>
<span class="cm">	 * fans to full speed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pm121_failure_state</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">last_failure</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">N_CONTROLS</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">wf_control_set_max</span><span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If leaving failure mode, unclamp cpufreq and readjust</span>
<span class="cm">	 * all fans on next iteration</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm121_failure_state</span> <span class="o">&amp;&amp;</span> <span class="n">last_failure</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="n">CPUFREQ</span><span class="p">])</span>
			<span class="n">wf_control_set_min</span><span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="n">CPUFREQ</span><span class="p">]);</span>
		<span class="n">pm121_readjust</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Overtemp condition detected, notify and start skipping a couple</span>
<span class="cm">	 * ticks to let the temperature go down</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_failure</span> <span class="o">&amp;</span> <span class="n">FAILURE_OVERTEMP</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">wf_set_overtemp</span><span class="p">();</span>
		<span class="n">pm121_skipping</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* We only clear the overtemp condition if overtemp is cleared</span>
<span class="cm">	 * _and_ no other failure is present. Since a sensor error will</span>
<span class="cm">	 * clear the overtemp condition (can&#39;t measure temperature) at</span>
<span class="cm">	 * the control loop levels, but we don&#39;t want to keep it clear</span>
<span class="cm">	 * here in this case</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new_failure</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">last_failure</span> <span class="o">&amp;</span> <span class="n">FAILURE_OVERTEMP</span><span class="p">)</span>
		<span class="n">wf_clear_overtemp</span><span class="p">();</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_control</span><span class="o">*</span> <span class="nf">pm121_register_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">wf_control</span> <span class="o">*</span><span class="n">ct</span><span class="p">,</span>
						 <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">match</span><span class="p">,</span>
						 <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">controls</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">ct</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">match</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wf_get_control</span><span class="p">(</span><span class="n">ct</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">controls</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">ct</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">controls</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm121_new_control</span><span class="p">(</span><span class="k">struct</span> <span class="n">wf_control</span> <span class="o">*</span><span class="n">ct</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">all</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pm121_all_controls_ok</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">all</span> <span class="o">=</span> <span class="n">pm121_register_control</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="s">&quot;optical-drive-fan&quot;</span><span class="p">,</span> <span class="n">FAN_OD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">all</span><span class="p">;</span>
	<span class="n">all</span> <span class="o">=</span> <span class="n">pm121_register_control</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="s">&quot;hard-drive-fan&quot;</span><span class="p">,</span> <span class="n">FAN_HD</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">all</span><span class="p">;</span>
	<span class="n">all</span> <span class="o">=</span> <span class="n">pm121_register_control</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="s">&quot;cpu-fan&quot;</span><span class="p">,</span> <span class="n">FAN_CPU</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">all</span><span class="p">;</span>
	<span class="n">all</span> <span class="o">=</span> <span class="n">pm121_register_control</span><span class="p">(</span><span class="n">ct</span><span class="p">,</span> <span class="s">&quot;cpufreq-clamp&quot;</span><span class="p">,</span> <span class="n">CPUFREQ</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">all</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">all</span><span class="p">)</span>
		<span class="n">pm121_all_controls_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>




<span class="k">static</span> <span class="k">struct</span> <span class="n">wf_sensor</span><span class="o">*</span> <span class="nf">pm121_register_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">wf_sensor</span> <span class="o">*</span><span class="n">sensor</span><span class="p">,</span>
					       <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">match</span><span class="p">,</span>
					       <span class="k">struct</span> <span class="n">wf_sensor</span> <span class="o">**</span><span class="n">var</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">var</span> <span class="o">==</span> <span class="nb">NULL</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strcmp</span><span class="p">(</span><span class="n">sensor</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">match</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">wf_get_sensor</span><span class="p">(</span><span class="n">sensor</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="o">*</span><span class="n">var</span> <span class="o">=</span> <span class="n">sensor</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="o">*</span><span class="n">var</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm121_new_sensor</span><span class="p">(</span><span class="k">struct</span> <span class="n">wf_sensor</span> <span class="o">*</span><span class="n">sr</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">all</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pm121_all_sensors_ok</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">all</span> <span class="o">=</span> <span class="n">pm121_register_sensor</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="s">&quot;cpu-temp&quot;</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sensor_cpu_temp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">all</span><span class="p">;</span>
	<span class="n">all</span> <span class="o">=</span> <span class="n">pm121_register_sensor</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="s">&quot;cpu-current&quot;</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sensor_cpu_current</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">all</span><span class="p">;</span>
	<span class="n">all</span> <span class="o">=</span> <span class="n">pm121_register_sensor</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="s">&quot;cpu-voltage&quot;</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sensor_cpu_voltage</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">all</span><span class="p">;</span>
	<span class="n">all</span> <span class="o">=</span> <span class="n">pm121_register_sensor</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="s">&quot;cpu-power&quot;</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sensor_cpu_power</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">all</span><span class="p">;</span>
	<span class="n">all</span> <span class="o">=</span> <span class="n">pm121_register_sensor</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="s">&quot;hard-drive-temp&quot;</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sensor_hard_drive_temp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">all</span><span class="p">;</span>
	<span class="n">all</span> <span class="o">=</span> <span class="n">pm121_register_sensor</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="s">&quot;optical-drive-temp&quot;</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sensor_optical_drive_temp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">all</span><span class="p">;</span>
	<span class="n">all</span> <span class="o">=</span> <span class="n">pm121_register_sensor</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="s">&quot;incoming-air-temp&quot;</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sensor_incoming_air_temp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">all</span><span class="p">;</span>
	<span class="n">all</span> <span class="o">=</span> <span class="n">pm121_register_sensor</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="s">&quot;north-bridge-temp&quot;</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sensor_north_bridge_temp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">all</span><span class="p">;</span>
	<span class="n">all</span> <span class="o">=</span> <span class="n">pm121_register_sensor</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="s">&quot;gpu-temp&quot;</span><span class="p">,</span>
				    <span class="o">&amp;</span><span class="n">sensor_gpu_temp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">all</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">all</span><span class="p">)</span>
		<span class="n">pm121_all_sensors_ok</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>



<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm121_notify</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">self</span><span class="p">,</span>
			<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">event</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">event</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">WF_EVENT_NEW_CONTROL</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pm121: new control %s detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">((</span><span class="k">struct</span> <span class="n">wf_control</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">pm121_new_control</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WF_EVENT_NEW_SENSOR</span>:
		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pm121: new sensor %s detected</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			 <span class="p">((</span><span class="k">struct</span> <span class="n">wf_sensor</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="n">pm121_new_sensor</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">WF_EVENT_TICK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">pm121_all_controls_ok</span> <span class="o">&amp;&amp;</span> <span class="n">pm121_all_sensors_ok</span><span class="p">)</span>
			<span class="n">pm121_tick</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">pm121_events</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span>	<span class="o">=</span> <span class="n">pm121_notify</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm121_init_pm</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">smu_sdbp_header</span> <span class="o">*</span><span class="n">hdr</span><span class="p">;</span>

	<span class="n">hdr</span> <span class="o">=</span> <span class="n">smu_get_sdb_partition</span><span class="p">(</span><span class="n">SMU_SDB_SENSORTREE_ID</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hdr</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">struct</span> <span class="n">smu_sdbp_sensortree</span> <span class="o">*</span><span class="n">st</span> <span class="o">=</span>
			<span class="p">(</span><span class="k">struct</span> <span class="n">smu_sdbp_sensortree</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">hdr</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
		<span class="n">pm121_mach_model</span> <span class="o">=</span> <span class="n">st</span><span class="o">-&gt;</span><span class="n">model_id</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pm121_connection</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pm121_connections</span><span class="p">[</span><span class="n">pm121_mach_model</span> <span class="o">-</span> <span class="mi">2</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pm121: Initializing for iMac G5 iSight model ID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">pm121_mach_model</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pm121_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wf_register_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm121_events</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">pm121_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ddev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">wf_unregister_client</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm121_events</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">pm121_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">pm121_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">pm121_remove</span><span class="p">),</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;windfarm&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">platform_bus_type</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">pm121_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">of_machine_is_compatible</span><span class="p">(</span><span class="s">&quot;PowerMac12,1&quot;</span><span class="p">))</span>
		<span class="n">rc</span> <span class="o">=</span> <span class="n">pm121_init_pm</span><span class="p">();</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;windfarm_smu_controls&quot;</span><span class="p">);</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;windfarm_smu_sensors&quot;</span><span class="p">);</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;windfarm_smu_sat&quot;</span><span class="p">);</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;windfarm_lm75_sensor&quot;</span><span class="p">);</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;windfarm_max6690_sensor&quot;</span><span class="p">);</span>
		<span class="n">request_module</span><span class="p">(</span><span class="s">&quot;windfarm_cpufreq_clamp&quot;</span><span class="p">);</span>
		<span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm121_driver</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">pm121_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>

	<span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pm121_driver</span><span class="p">);</span>
<span class="p">}</span>


<span class="n">module_init</span><span class="p">(</span><span class="n">pm121_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">pm121_exit</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Étienne Bersac &lt;bersace@gmail.com&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Thermal control logic for iMac G5 (iSight)&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
