<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › macintosh › adbhid.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>adbhid.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/macintosh/adbhid.c</span>
<span class="cm"> *</span>
<span class="cm"> * ADB HID driver for Power Macintosh computers.</span>
<span class="cm"> *</span>
<span class="cm"> * Adapted from drivers/macintosh/mac_keyb.c by Franz Sirl.</span>
<span class="cm"> * drivers/macintosh/mac_keyb.c was Copyright (C) 1996 Paul Mackerras</span>
<span class="cm"> * with considerable contributions from Ben Herrenschmidt and others.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000 Franz Sirl.</span>
<span class="cm"> *</span>
<span class="cm"> * Adapted to ADB changes and support for more devices by</span>
<span class="cm"> * Benjamin Herrenschmidt. Adapted from code in MkLinux</span>
<span class="cm"> * and reworked.</span>
<span class="cm"> * </span>
<span class="cm"> * Supported devices:</span>
<span class="cm"> *</span>
<span class="cm"> * - Standard 1 button mouse</span>
<span class="cm"> * - All standard Apple Extended protocol (handler ID 4)</span>
<span class="cm"> * - mouseman and trackman mice &amp; trackballs </span>
<span class="cm"> * - PowerBook Trackpad (default setup: enable tapping)</span>
<span class="cm"> * - MicroSpeed mouse &amp; trackball (needs testing)</span>
<span class="cm"> * - CH Products Trackball Pro (needs testing)</span>
<span class="cm"> * - Contour Design (Contour Mouse)</span>
<span class="cm"> * - Hunter digital (NoHandsMouse)</span>
<span class="cm"> * - Kensignton TurboMouse 5 (needs testing)</span>
<span class="cm"> * - Mouse Systems A3 mice and trackballs &lt;aidan@kublai.com&gt;</span>
<span class="cm"> * - MacAlly 2-buttons mouse (needs testing) &lt;pochini@denise.shiny.it&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * To do:</span>
<span class="cm"> *</span>
<span class="cm"> * Improve Kensington support.</span>
<span class="cm"> * Split mouse/kbd</span>
<span class="cm"> * Move to syfs</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/notifier.h&gt;</span>
<span class="cp">#include &lt;linux/input.h&gt;</span>

<span class="cp">#include &lt;linux/adb.h&gt;</span>
<span class="cp">#include &lt;linux/cuda.h&gt;</span>
<span class="cp">#include &lt;linux/pmu.h&gt;</span>

<span class="cp">#include &lt;asm/machdep.h&gt;</span>
<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
<span class="cp">#include &lt;asm/backlight.h&gt;</span>
<span class="cp">#include &lt;asm/pmac_feature.h&gt;</span>
<span class="cp">#endif</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Franz Sirl &lt;Franz.Sirl-kernel@lauterbach.com&gt;&quot;</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">restore_capslock_events</span><span class="p">;</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">restore_capslock_events</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0644</span><span class="p">);</span>
<span class="n">MODULE_PARM_DESC</span><span class="p">(</span><span class="n">restore_capslock_events</span><span class="p">,</span>
	<span class="s">&quot;Produce keypress events for capslock on both keyup and keydown.&quot;</span><span class="p">);</span>

<span class="cp">#define KEYB_KEYREG	0	</span><span class="cm">/* register # for key up/down data */</span><span class="cp"></span>
<span class="cp">#define KEYB_LEDREG	2	</span><span class="cm">/* register # for leds on ADB keyboard */</span><span class="cp"></span>
<span class="cp">#define MOUSE_DATAREG	0	</span><span class="cm">/* reg# for movement/button codes from mouse */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">adb_message_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">adbhid_adb_notifier</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span>	<span class="o">=</span> <span class="n">adb_message_handler</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* Some special keys */</span>
<span class="cp">#define ADB_KEY_DEL		0x33</span>
<span class="cp">#define ADB_KEY_CMD		0x37</span>
<span class="cp">#define ADB_KEY_CAPSLOCK	0x39</span>
<span class="cp">#define ADB_KEY_FN		0x3f</span>
<span class="cp">#define ADB_KEY_FWDEL		0x75</span>
<span class="cp">#define ADB_KEY_POWER_OLD	0x7e</span>
<span class="cp">#define ADB_KEY_POWER		0x7f</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u16</span> <span class="n">adb_to_linux_keycodes</span><span class="p">[</span><span class="mi">128</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* 0x00 */</span> <span class="n">KEY_A</span><span class="p">,</span> 		<span class="cm">/*  30 */</span>
	<span class="cm">/* 0x01 */</span> <span class="n">KEY_S</span><span class="p">,</span> 		<span class="cm">/*  31 */</span>
	<span class="cm">/* 0x02 */</span> <span class="n">KEY_D</span><span class="p">,</span>		<span class="cm">/*  32 */</span>
	<span class="cm">/* 0x03 */</span> <span class="n">KEY_F</span><span class="p">,</span>		<span class="cm">/*  33 */</span>
	<span class="cm">/* 0x04 */</span> <span class="n">KEY_H</span><span class="p">,</span>		<span class="cm">/*  35 */</span>
	<span class="cm">/* 0x05 */</span> <span class="n">KEY_G</span><span class="p">,</span>		<span class="cm">/*  34 */</span>
	<span class="cm">/* 0x06 */</span> <span class="n">KEY_Z</span><span class="p">,</span>		<span class="cm">/*  44 */</span>
	<span class="cm">/* 0x07 */</span> <span class="n">KEY_X</span><span class="p">,</span>		<span class="cm">/*  45 */</span>
	<span class="cm">/* 0x08 */</span> <span class="n">KEY_C</span><span class="p">,</span>		<span class="cm">/*  46 */</span>
	<span class="cm">/* 0x09 */</span> <span class="n">KEY_V</span><span class="p">,</span>		<span class="cm">/*  47 */</span>
	<span class="cm">/* 0x0a */</span> <span class="n">KEY_102ND</span><span class="p">,</span>		<span class="cm">/*  86 */</span>
	<span class="cm">/* 0x0b */</span> <span class="n">KEY_B</span><span class="p">,</span>		<span class="cm">/*  48 */</span>
	<span class="cm">/* 0x0c */</span> <span class="n">KEY_Q</span><span class="p">,</span>		<span class="cm">/*  16 */</span>
	<span class="cm">/* 0x0d */</span> <span class="n">KEY_W</span><span class="p">,</span>		<span class="cm">/*  17 */</span>
	<span class="cm">/* 0x0e */</span> <span class="n">KEY_E</span><span class="p">,</span>		<span class="cm">/*  18 */</span>
	<span class="cm">/* 0x0f */</span> <span class="n">KEY_R</span><span class="p">,</span>		<span class="cm">/*  19 */</span>
	<span class="cm">/* 0x10 */</span> <span class="n">KEY_Y</span><span class="p">,</span>		<span class="cm">/*  21 */</span>
	<span class="cm">/* 0x11 */</span> <span class="n">KEY_T</span><span class="p">,</span>		<span class="cm">/*  20 */</span>
	<span class="cm">/* 0x12 */</span> <span class="n">KEY_1</span><span class="p">,</span>		<span class="cm">/*   2 */</span>
	<span class="cm">/* 0x13 */</span> <span class="n">KEY_2</span><span class="p">,</span>		<span class="cm">/*   3 */</span>
	<span class="cm">/* 0x14 */</span> <span class="n">KEY_3</span><span class="p">,</span>		<span class="cm">/*   4 */</span>
	<span class="cm">/* 0x15 */</span> <span class="n">KEY_4</span><span class="p">,</span>		<span class="cm">/*   5 */</span>
	<span class="cm">/* 0x16 */</span> <span class="n">KEY_6</span><span class="p">,</span>		<span class="cm">/*   7 */</span>
	<span class="cm">/* 0x17 */</span> <span class="n">KEY_5</span><span class="p">,</span>		<span class="cm">/*   6 */</span>
	<span class="cm">/* 0x18 */</span> <span class="n">KEY_EQUAL</span><span class="p">,</span>		<span class="cm">/*  13 */</span>
	<span class="cm">/* 0x19 */</span> <span class="n">KEY_9</span><span class="p">,</span>		<span class="cm">/*  10 */</span>
	<span class="cm">/* 0x1a */</span> <span class="n">KEY_7</span><span class="p">,</span>		<span class="cm">/*   8 */</span>
	<span class="cm">/* 0x1b */</span> <span class="n">KEY_MINUS</span><span class="p">,</span>		<span class="cm">/*  12 */</span>
	<span class="cm">/* 0x1c */</span> <span class="n">KEY_8</span><span class="p">,</span>		<span class="cm">/*   9 */</span>
	<span class="cm">/* 0x1d */</span> <span class="n">KEY_0</span><span class="p">,</span>		<span class="cm">/*  11 */</span>
	<span class="cm">/* 0x1e */</span> <span class="n">KEY_RIGHTBRACE</span><span class="p">,</span>	<span class="cm">/*  27 */</span>
	<span class="cm">/* 0x1f */</span> <span class="n">KEY_O</span><span class="p">,</span>		<span class="cm">/*  24 */</span>
	<span class="cm">/* 0x20 */</span> <span class="n">KEY_U</span><span class="p">,</span>		<span class="cm">/*  22 */</span>
	<span class="cm">/* 0x21 */</span> <span class="n">KEY_LEFTBRACE</span><span class="p">,</span>	<span class="cm">/*  26 */</span>
	<span class="cm">/* 0x22 */</span> <span class="n">KEY_I</span><span class="p">,</span>		<span class="cm">/*  23 */</span>
	<span class="cm">/* 0x23 */</span> <span class="n">KEY_P</span><span class="p">,</span>		<span class="cm">/*  25 */</span>
	<span class="cm">/* 0x24 */</span> <span class="n">KEY_ENTER</span><span class="p">,</span>		<span class="cm">/*  28 */</span>
	<span class="cm">/* 0x25 */</span> <span class="n">KEY_L</span><span class="p">,</span>		<span class="cm">/*  38 */</span>
	<span class="cm">/* 0x26 */</span> <span class="n">KEY_J</span><span class="p">,</span>		<span class="cm">/*  36 */</span>
	<span class="cm">/* 0x27 */</span> <span class="n">KEY_APOSTROPHE</span><span class="p">,</span>	<span class="cm">/*  40 */</span>
	<span class="cm">/* 0x28 */</span> <span class="n">KEY_K</span><span class="p">,</span>		<span class="cm">/*  37 */</span>
	<span class="cm">/* 0x29 */</span> <span class="n">KEY_SEMICOLON</span><span class="p">,</span>	<span class="cm">/*  39 */</span>
	<span class="cm">/* 0x2a */</span> <span class="n">KEY_BACKSLASH</span><span class="p">,</span>	<span class="cm">/*  43 */</span>
	<span class="cm">/* 0x2b */</span> <span class="n">KEY_COMMA</span><span class="p">,</span>		<span class="cm">/*  51 */</span>
	<span class="cm">/* 0x2c */</span> <span class="n">KEY_SLASH</span><span class="p">,</span>		<span class="cm">/*  53 */</span>
	<span class="cm">/* 0x2d */</span> <span class="n">KEY_N</span><span class="p">,</span>		<span class="cm">/*  49 */</span>
	<span class="cm">/* 0x2e */</span> <span class="n">KEY_M</span><span class="p">,</span>		<span class="cm">/*  50 */</span>
	<span class="cm">/* 0x2f */</span> <span class="n">KEY_DOT</span><span class="p">,</span>		<span class="cm">/*  52 */</span>
	<span class="cm">/* 0x30 */</span> <span class="n">KEY_TAB</span><span class="p">,</span>		<span class="cm">/*  15 */</span>
	<span class="cm">/* 0x31 */</span> <span class="n">KEY_SPACE</span><span class="p">,</span>		<span class="cm">/*  57 */</span>
	<span class="cm">/* 0x32 */</span> <span class="n">KEY_GRAVE</span><span class="p">,</span>		<span class="cm">/*  41 */</span>
	<span class="cm">/* 0x33 */</span> <span class="n">KEY_BACKSPACE</span><span class="p">,</span>	<span class="cm">/*  14 */</span>
	<span class="cm">/* 0x34 */</span> <span class="n">KEY_KPENTER</span><span class="p">,</span>		<span class="cm">/*  96 */</span>
	<span class="cm">/* 0x35 */</span> <span class="n">KEY_ESC</span><span class="p">,</span>		<span class="cm">/*   1 */</span>
	<span class="cm">/* 0x36 */</span> <span class="n">KEY_LEFTCTRL</span><span class="p">,</span>	<span class="cm">/*  29 */</span>
	<span class="cm">/* 0x37 */</span> <span class="n">KEY_LEFTMETA</span><span class="p">,</span>	<span class="cm">/* 125 */</span>
	<span class="cm">/* 0x38 */</span> <span class="n">KEY_LEFTSHIFT</span><span class="p">,</span>	<span class="cm">/*  42 */</span>
	<span class="cm">/* 0x39 */</span> <span class="n">KEY_CAPSLOCK</span><span class="p">,</span>	<span class="cm">/*  58 */</span>
	<span class="cm">/* 0x3a */</span> <span class="n">KEY_LEFTALT</span><span class="p">,</span>		<span class="cm">/*  56 */</span>
	<span class="cm">/* 0x3b */</span> <span class="n">KEY_LEFT</span><span class="p">,</span>		<span class="cm">/* 105 */</span>
	<span class="cm">/* 0x3c */</span> <span class="n">KEY_RIGHT</span><span class="p">,</span>		<span class="cm">/* 106 */</span>
	<span class="cm">/* 0x3d */</span> <span class="n">KEY_DOWN</span><span class="p">,</span>		<span class="cm">/* 108 */</span>
	<span class="cm">/* 0x3e */</span> <span class="n">KEY_UP</span><span class="p">,</span>		<span class="cm">/* 103 */</span>
	<span class="cm">/* 0x3f */</span> <span class="n">KEY_FN</span><span class="p">,</span>		<span class="cm">/* 0x1d0 */</span>
	<span class="cm">/* 0x40 */</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* 0x41 */</span> <span class="n">KEY_KPDOT</span><span class="p">,</span>		<span class="cm">/*  83 */</span>
	<span class="cm">/* 0x42 */</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* 0x43 */</span> <span class="n">KEY_KPASTERISK</span><span class="p">,</span>	<span class="cm">/*  55 */</span>
	<span class="cm">/* 0x44 */</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* 0x45 */</span> <span class="n">KEY_KPPLUS</span><span class="p">,</span>		<span class="cm">/*  78 */</span>
	<span class="cm">/* 0x46 */</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* 0x47 */</span> <span class="n">KEY_NUMLOCK</span><span class="p">,</span>		<span class="cm">/*  69 */</span>
	<span class="cm">/* 0x48 */</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* 0x49 */</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* 0x4a */</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* 0x4b */</span> <span class="n">KEY_KPSLASH</span><span class="p">,</span>		<span class="cm">/*  98 */</span>
	<span class="cm">/* 0x4c */</span> <span class="n">KEY_KPENTER</span><span class="p">,</span>		<span class="cm">/*  96 */</span>
	<span class="cm">/* 0x4d */</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* 0x4e */</span> <span class="n">KEY_KPMINUS</span><span class="p">,</span>		<span class="cm">/*  74 */</span>
	<span class="cm">/* 0x4f */</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* 0x50 */</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* 0x51 */</span> <span class="n">KEY_KPEQUAL</span><span class="p">,</span>		<span class="cm">/* 117 */</span>
	<span class="cm">/* 0x52 */</span> <span class="n">KEY_KP0</span><span class="p">,</span>		<span class="cm">/*  82 */</span>
	<span class="cm">/* 0x53 */</span> <span class="n">KEY_KP1</span><span class="p">,</span>		<span class="cm">/*  79 */</span>
	<span class="cm">/* 0x54 */</span> <span class="n">KEY_KP2</span><span class="p">,</span>		<span class="cm">/*  80 */</span>
	<span class="cm">/* 0x55 */</span> <span class="n">KEY_KP3</span><span class="p">,</span>		<span class="cm">/*  81 */</span>
	<span class="cm">/* 0x56 */</span> <span class="n">KEY_KP4</span><span class="p">,</span>		<span class="cm">/*  75 */</span>
	<span class="cm">/* 0x57 */</span> <span class="n">KEY_KP5</span><span class="p">,</span>		<span class="cm">/*  76 */</span>
	<span class="cm">/* 0x58 */</span> <span class="n">KEY_KP6</span><span class="p">,</span>		<span class="cm">/*  77 */</span>
	<span class="cm">/* 0x59 */</span> <span class="n">KEY_KP7</span><span class="p">,</span>		<span class="cm">/*  71 */</span>
	<span class="cm">/* 0x5a */</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* 0x5b */</span> <span class="n">KEY_KP8</span><span class="p">,</span>		<span class="cm">/*  72 */</span>
	<span class="cm">/* 0x5c */</span> <span class="n">KEY_KP9</span><span class="p">,</span>		<span class="cm">/*  73 */</span>
	<span class="cm">/* 0x5d */</span> <span class="n">KEY_YEN</span><span class="p">,</span>		<span class="cm">/* 124 */</span>
	<span class="cm">/* 0x5e */</span> <span class="n">KEY_RO</span><span class="p">,</span>		<span class="cm">/*  89 */</span>
	<span class="cm">/* 0x5f */</span> <span class="n">KEY_KPCOMMA</span><span class="p">,</span>		<span class="cm">/* 121 */</span>
	<span class="cm">/* 0x60 */</span> <span class="n">KEY_F5</span><span class="p">,</span>		<span class="cm">/*  63 */</span>
	<span class="cm">/* 0x61 */</span> <span class="n">KEY_F6</span><span class="p">,</span>		<span class="cm">/*  64 */</span>
	<span class="cm">/* 0x62 */</span> <span class="n">KEY_F7</span><span class="p">,</span>		<span class="cm">/*  65 */</span>
	<span class="cm">/* 0x63 */</span> <span class="n">KEY_F3</span><span class="p">,</span>		<span class="cm">/*  61 */</span>
	<span class="cm">/* 0x64 */</span> <span class="n">KEY_F8</span><span class="p">,</span>		<span class="cm">/*  66 */</span>
	<span class="cm">/* 0x65 */</span> <span class="n">KEY_F9</span><span class="p">,</span>		<span class="cm">/*  67 */</span>
	<span class="cm">/* 0x66 */</span> <span class="n">KEY_HANJA</span><span class="p">,</span>		<span class="cm">/* 123 */</span>
	<span class="cm">/* 0x67 */</span> <span class="n">KEY_F11</span><span class="p">,</span>		<span class="cm">/*  87 */</span>
	<span class="cm">/* 0x68 */</span> <span class="n">KEY_HANGEUL</span><span class="p">,</span>		<span class="cm">/* 122 */</span>
	<span class="cm">/* 0x69 */</span> <span class="n">KEY_SYSRQ</span><span class="p">,</span>		<span class="cm">/*  99 */</span>
	<span class="cm">/* 0x6a */</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* 0x6b */</span> <span class="n">KEY_SCROLLLOCK</span><span class="p">,</span>	<span class="cm">/*  70 */</span>
	<span class="cm">/* 0x6c */</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* 0x6d */</span> <span class="n">KEY_F10</span><span class="p">,</span>		<span class="cm">/*  68 */</span>
	<span class="cm">/* 0x6e */</span> <span class="n">KEY_COMPOSE</span><span class="p">,</span>		<span class="cm">/* 127 */</span>
	<span class="cm">/* 0x6f */</span> <span class="n">KEY_F12</span><span class="p">,</span>		<span class="cm">/*  88 */</span>
	<span class="cm">/* 0x70 */</span> <span class="mi">0</span><span class="p">,</span>
	<span class="cm">/* 0x71 */</span> <span class="n">KEY_PAUSE</span><span class="p">,</span>		<span class="cm">/* 119 */</span>
	<span class="cm">/* 0x72 */</span> <span class="n">KEY_INSERT</span><span class="p">,</span>		<span class="cm">/* 110 */</span>
	<span class="cm">/* 0x73 */</span> <span class="n">KEY_HOME</span><span class="p">,</span>		<span class="cm">/* 102 */</span>
	<span class="cm">/* 0x74 */</span> <span class="n">KEY_PAGEUP</span><span class="p">,</span>		<span class="cm">/* 104 */</span>
	<span class="cm">/* 0x75 */</span> <span class="n">KEY_DELETE</span><span class="p">,</span>		<span class="cm">/* 111 */</span>
	<span class="cm">/* 0x76 */</span> <span class="n">KEY_F4</span><span class="p">,</span>		<span class="cm">/*  62 */</span>
	<span class="cm">/* 0x77 */</span> <span class="n">KEY_END</span><span class="p">,</span>		<span class="cm">/* 107 */</span>
	<span class="cm">/* 0x78 */</span> <span class="n">KEY_F2</span><span class="p">,</span>		<span class="cm">/*  60 */</span>
	<span class="cm">/* 0x79 */</span> <span class="n">KEY_PAGEDOWN</span><span class="p">,</span>	<span class="cm">/* 109 */</span>
	<span class="cm">/* 0x7a */</span> <span class="n">KEY_F1</span><span class="p">,</span>		<span class="cm">/*  59 */</span>
	<span class="cm">/* 0x7b */</span> <span class="n">KEY_RIGHTSHIFT</span><span class="p">,</span>	<span class="cm">/*  54 */</span>
	<span class="cm">/* 0x7c */</span> <span class="n">KEY_RIGHTALT</span><span class="p">,</span>	<span class="cm">/* 100 */</span>
	<span class="cm">/* 0x7d */</span> <span class="n">KEY_RIGHTCTRL</span><span class="p">,</span>	<span class="cm">/*  97 */</span>
	<span class="cm">/* 0x7e */</span> <span class="n">KEY_RIGHTMETA</span><span class="p">,</span>	<span class="cm">/* 126 */</span>
	<span class="cm">/* 0x7f */</span> <span class="n">KEY_POWER</span><span class="p">,</span>		<span class="cm">/* 116 */</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">adbhid</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">default_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">original_handler_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">current_handler_id</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">mouse_kind</span><span class="p">;</span>
	<span class="n">u16</span> <span class="o">*</span><span class="n">keycode</span><span class="p">;</span>
	<span class="kt">char</span> <span class="n">name</span><span class="p">[</span><span class="mi">64</span><span class="p">];</span>
	<span class="kt">char</span> <span class="n">phys</span><span class="p">[</span><span class="mi">32</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">flags</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define FLAG_FN_KEY_PRESSED		0x00000001</span>
<span class="cp">#define FLAG_POWER_FROM_FN		0x00000002</span>
<span class="cp">#define FLAG_EMU_FWDEL_DOWN		0x00000004</span>
<span class="cp">#define FLAG_CAPSLOCK_TRANSLATE		0x00000008</span>
<span class="cp">#define FLAG_CAPSLOCK_DOWN		0x00000010</span>
<span class="cp">#define FLAG_CAPSLOCK_IGNORE_NEXT	0x00000020</span>
<span class="cp">#define FLAG_POWER_KEY_PRESSED		0x00000040</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">adbhid</span> <span class="o">*</span><span class="n">adbhid</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">adbhid_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">adbhid_input_keycode</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">int</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">init_trackpad</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_trackball</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_turbomouse</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_microspeed</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">void</span> <span class="n">init_ms_a3</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">adb_ids</span> <span class="n">keyboard_ids</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">adb_ids</span> <span class="n">mouse_ids</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">adb_ids</span> <span class="n">buttons_ids</span><span class="p">;</span>

<span class="cm">/* Kind of keyboard, see Apple technote 1152  */</span>
<span class="cp">#define ADB_KEYBOARD_UNKNOWN	0</span>
<span class="cp">#define ADB_KEYBOARD_ANSI	0x0100</span>
<span class="cp">#define ADB_KEYBOARD_ISO	0x0200</span>
<span class="cp">#define ADB_KEYBOARD_JIS	0x0300</span>

<span class="cm">/* Kind of mouse  */</span>
<span class="cp">#define ADBMOUSE_STANDARD_100	0	</span><span class="cm">/* Standard 100cpi mouse (handler 1) */</span><span class="cp"></span>
<span class="cp">#define ADBMOUSE_STANDARD_200	1	</span><span class="cm">/* Standard 200cpi mouse (handler 2) */</span><span class="cp"></span>
<span class="cp">#define ADBMOUSE_EXTENDED	2	</span><span class="cm">/* Apple Extended mouse (handler 4) */</span><span class="cp"></span>
<span class="cp">#define ADBMOUSE_TRACKBALL	3	</span><span class="cm">/* TrackBall (handler 4) */</span><span class="cp"></span>
<span class="cp">#define ADBMOUSE_TRACKPAD       4	</span><span class="cm">/* Apple&#39;s PowerBook trackpad (handler 4) */</span><span class="cp"></span>
<span class="cp">#define ADBMOUSE_TURBOMOUSE5    5	</span><span class="cm">/* Turbomouse 5 (previously req. mousehack) */</span><span class="cp"></span>
<span class="cp">#define ADBMOUSE_MICROSPEED	6	</span><span class="cm">/* Microspeed mouse (&amp;trackball ?), MacPoint */</span><span class="cp"></span>
<span class="cp">#define ADBMOUSE_TRACKBALLPRO	7	</span><span class="cm">/* Trackball Pro (special buttons) */</span><span class="cp"></span>
<span class="cp">#define ADBMOUSE_MS_A3		8	</span><span class="cm">/* Mouse systems A3 trackball (handler 3) */</span><span class="cp"></span>
<span class="cp">#define ADBMOUSE_MACALLY2	9	</span><span class="cm">/* MacAlly 2-button mouse */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">adbhid_keyboard_input</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">apoll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ADB HID on ID %d not yet registered, packet %#02x, %#02x, %#02x, %#02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		       <span class="n">id</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* first check this is from register 0 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">nb</span> <span class="o">!=</span> <span class="mi">3</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="o">!=</span> <span class="n">KEYB_KEYREG</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>		<span class="cm">/* ignore it */</span>
	<span class="n">adbhid_input_keycode</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">||</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7f</span> <span class="o">&amp;&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x7f</span><span class="p">)))</span>
		<span class="n">adbhid_input_keycode</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">adbhid_input_keycode</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">scancode</span><span class="p">,</span> <span class="kt">int</span> <span class="n">repeat</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adbhid</span> <span class="o">*</span><span class="n">ahid</span> <span class="o">=</span> <span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">];</span>
	<span class="kt">int</span> <span class="n">keycode</span><span class="p">,</span> <span class="n">up_flag</span><span class="p">,</span> <span class="n">key</span><span class="p">;</span>

	<span class="n">keycode</span> <span class="o">=</span> <span class="n">scancode</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">;</span>
	<span class="n">up_flag</span> <span class="o">=</span> <span class="n">scancode</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">restore_capslock_events</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">keycode</span> <span class="o">==</span> <span class="n">ADB_KEY_CAPSLOCK</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">up_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Key pressed, turning on the CapsLock LED.</span>
<span class="cm">			 * The next 0xff will be interpreted as a release. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_CAPSLOCK_IGNORE_NEXT</span><span class="p">)</span> <span class="p">{</span>
				<span class="cm">/* Throw away this key event if it happens</span>
<span class="cm">				 * just after resume. */</span>
				<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLAG_CAPSLOCK_IGNORE_NEXT</span><span class="p">;</span>
				<span class="k">return</span><span class="p">;</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAG_CAPSLOCK_TRANSLATE</span>
					<span class="o">|</span> <span class="n">FLAG_CAPSLOCK_DOWN</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">scancode</span> <span class="o">==</span> <span class="mh">0xff</span> <span class="o">&amp;&amp;</span>
			   <span class="o">!</span><span class="p">(</span><span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_POWER_KEY_PRESSED</span><span class="p">))</span> <span class="p">{</span>
			<span class="cm">/* Scancode 0xff usually signifies that the capslock</span>
<span class="cm">			 * key was either pressed or released, or that the</span>
<span class="cm">			 * power button was released. */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_CAPSLOCK_TRANSLATE</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">keycode</span> <span class="o">=</span> <span class="n">ADB_KEY_CAPSLOCK</span><span class="p">;</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_CAPSLOCK_DOWN</span><span class="p">)</span> <span class="p">{</span>
					<span class="cm">/* Key released */</span>
					<span class="n">up_flag</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
					<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLAG_CAPSLOCK_DOWN</span><span class="p">;</span>
				<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
					<span class="cm">/* Key pressed */</span>
					<span class="n">up_flag</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
					<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLAG_CAPSLOCK_TRANSLATE</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Spurious caps lock event &quot;</span>
						 <span class="s">&quot;(scancode 0xff).</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">keycode</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ADB_KEY_CAPSLOCK</span>:
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">restore_capslock_events</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Generate down/up events for CapsLock every time. */</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">ahid</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_CAPSLOCK</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">ahid</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">ahid</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_CAPSLOCK</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">input_sync</span><span class="p">(</span><span class="n">ahid</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
			<span class="k">return</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PPC_PMAC</span>
	<span class="k">case</span> <span class="n">ADB_KEY_POWER_OLD</span>: <span class="cm">/* Power key on PBook 3400 needs remapping */</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">pmac_call_feature</span><span class="p">(</span><span class="n">PMAC_FTR_GET_MB_INFO</span><span class="p">,</span>
			<span class="nb">NULL</span><span class="p">,</span> <span class="n">PMAC_MB_INFO_MODEL</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PMAC_TYPE_COMET</span>:
		<span class="k">case</span> <span class="n">PMAC_TYPE_HOOPER</span>:
		<span class="k">case</span> <span class="n">PMAC_TYPE_KANGA</span>:
			<span class="n">keycode</span> <span class="o">=</span> <span class="n">ADB_KEY_POWER</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADB_KEY_POWER</span>:
		<span class="cm">/* Keep track of the power key state */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span>
			<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLAG_POWER_KEY_PRESSED</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAG_POWER_KEY_PRESSED</span><span class="p">;</span>

		<span class="cm">/* Fn + Command will produce a bogus &quot;power&quot; keycode */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_FN_KEY_PRESSED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">keycode</span> <span class="o">=</span> <span class="n">ADB_KEY_CMD</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span>
				<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLAG_POWER_FROM_FN</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAG_POWER_FROM_FN</span><span class="p">;</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_POWER_FROM_FN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">keycode</span> <span class="o">=</span> <span class="n">ADB_KEY_CMD</span><span class="p">;</span>
			<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLAG_POWER_FROM_FN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADB_KEY_FN</span>:
		<span class="cm">/* Keep track of the Fn key state */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLAG_FN_KEY_PRESSED</span><span class="p">;</span>
			<span class="cm">/* Emulate Fn+delete = forward delete */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_EMU_FWDEL_DOWN</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLAG_EMU_FWDEL_DOWN</span><span class="p">;</span>
				<span class="n">keycode</span> <span class="o">=</span> <span class="n">ADB_KEY_FWDEL</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAG_FN_KEY_PRESSED</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">ADB_KEY_DEL</span>:
		<span class="cm">/* Emulate Fn+delete = forward delete */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_FN_KEY_PRESSED</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">keycode</span> <span class="o">=</span> <span class="n">ADB_KEY_FWDEL</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">up_flag</span><span class="p">)</span>
				<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">FLAG_EMU_FWDEL_DOWN</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAG_EMU_FWDEL_DOWN</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">break</span><span class="p">;</span>
<span class="cp">#endif </span><span class="cm">/* CONFIG_PPC_PMAC */</span><span class="cp"></span>
	<span class="p">}</span>

	<span class="n">key</span> <span class="o">=</span> <span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">keycode</span><span class="p">];</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="o">!</span><span class="n">up_flag</span><span class="p">);</span>
		<span class="n">input_sync</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Unhandled ADB key (scancode %#02x) %s.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">keycode</span><span class="p">,</span>
		       <span class="n">up_flag</span> <span class="o">?</span> <span class="s">&quot;released&quot;</span> <span class="o">:</span> <span class="s">&quot;pressed&quot;</span><span class="p">);</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">adbhid_mouse_input</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autopoll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ADB HID on ID %d not yet registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

  <span class="cm">/*</span>
<span class="cm">    Handler 1 -- 100cpi original Apple mouse protocol.</span>
<span class="cm">    Handler 2 -- 200cpi original Apple mouse protocol.</span>

<span class="cm">    For Apple&#39;s standard one-button mouse protocol the data array will</span>
<span class="cm">    contain the following values:</span>

<span class="cm">                BITS    COMMENTS</span>
<span class="cm">    data[0] = dddd 1100 ADB command: Talk, register 0, for device dddd.</span>
<span class="cm">    data[1] = bxxx xxxx First button and x-axis motion.</span>
<span class="cm">    data[2] = byyy yyyy Second button and y-axis motion.</span>

<span class="cm">    Handler 4 -- Apple Extended mouse protocol.</span>

<span class="cm">    For Apple&#39;s 3-button mouse protocol the data array will contain the</span>
<span class="cm">    following values:</span>

<span class="cm">		BITS    COMMENTS</span>
<span class="cm">    data[0] = dddd 1100 ADB command: Talk, register 0, for device dddd.</span>
<span class="cm">    data[1] = bxxx xxxx Left button and x-axis motion.</span>
<span class="cm">    data[2] = byyy yyyy Second button and y-axis motion.</span>
<span class="cm">    data[3] = byyy bxxx Third button and fourth button.  Y is additional</span>
<span class="cm">	      high bits of y-axis motion.  XY is additional</span>
<span class="cm">	      high bits of x-axis motion.</span>

<span class="cm">    MacAlly 2-button mouse protocol.</span>

<span class="cm">    For MacAlly 2-button mouse protocol the data array will contain the</span>
<span class="cm">    following values:</span>

<span class="cm">		BITS    COMMENTS</span>
<span class="cm">    data[0] = dddd 1100 ADB command: Talk, register 0, for device dddd.</span>
<span class="cm">    data[1] = bxxx xxxx Left button and x-axis motion.</span>
<span class="cm">    data[2] = byyy yyyy Right button and y-axis motion.</span>
<span class="cm">    data[3] = ???? ???? unknown</span>
<span class="cm">    data[4] = ???? ???? unknown</span>

<span class="cm">  */</span>

	<span class="cm">/* If it&#39;s a trackpad, we alias the second button to the first.</span>
<span class="cm">	   NOTE: Apple sends an ADB flush command to the trackpad when</span>
<span class="cm">	         the first (the real) button is released. We could do</span>
<span class="cm">		 this here using async flush requests.</span>
<span class="cm">	*/</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mouse_kind</span><span class="p">)</span>
	<span class="p">{</span>
	    <span class="k">case</span> <span class="n">ADBMOUSE_TRACKPAD</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|</span> <span class="mh">0x80</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">ADBMOUSE_MICROSPEED</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x77</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="o">|</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">ADBMOUSE_TRACKBALLPRO</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">(((</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">)</span>
			<span class="o">&amp;</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x08</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x77</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="k">case</span> <span class="n">ADBMOUSE_MS_A3</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x01</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x7f</span><span class="p">)</span> <span class="o">|</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x02</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">6</span><span class="p">);</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x04</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="n">ADBMOUSE_MACALLY2</span>:
		<span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x80</span><span class="p">)</span> <span class="o">?</span> <span class="mh">0x80</span> <span class="o">:</span> <span class="mh">0x00</span><span class="p">;</span>
		<span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">|=</span> <span class="mh">0x80</span><span class="p">;</span>  <span class="cm">/* Right button is mapped as button 3 */</span>
		<span class="n">nb</span><span class="o">=</span><span class="mi">4</span><span class="p">;</span>
                <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_LEFT</span><span class="p">,</span>   <span class="o">!</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>
	<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_MIDDLE</span><span class="p">,</span> <span class="o">!</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">nb</span> <span class="o">&gt;=</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">mouse_kind</span> <span class="o">!=</span> <span class="n">ADBMOUSE_TRACKPAD</span><span class="p">)</span>
		<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">BTN_RIGHT</span><span class="p">,</span>  <span class="o">!</span><span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">));</span>

	<span class="n">input_report_rel</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">REL_X</span><span class="p">,</span>
			 <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">64</span> <span class="o">?</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x7f</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x7f</span><span class="p">)</span><span class="o">-</span><span class="mi">128</span> <span class="p">));</span>
	<span class="n">input_report_rel</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">REL_Y</span><span class="p">,</span>
			 <span class="p">((</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x7f</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">64</span> <span class="o">?</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x7f</span><span class="p">)</span> <span class="o">:</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">&amp;</span><span class="mh">0x7f</span><span class="p">)</span><span class="o">-</span><span class="mi">128</span> <span class="p">));</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">adbhid_buttons_input</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="o">*</span><span class="n">data</span><span class="p">,</span> <span class="kt">int</span> <span class="n">nb</span><span class="p">,</span> <span class="kt">int</span> <span class="n">autopoll</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;ADB HID on ID %d not yet registered</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">original_handler_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="nl">default:</span>
	<span class="k">case</span> <span class="mh">0x02</span>: <span class="cm">/* Adjustable keyboard button device */</span>
	  <span class="p">{</span>
		<span class="kt">int</span> <span class="n">down</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">));</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x0</span>:	<span class="cm">/* microphone */</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_SOUND</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x1</span>:	<span class="cm">/* mute */</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_MUTE</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x2</span>:	<span class="cm">/* volume decrease */</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_VOLUMEDOWN</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x3</span>:	<span class="cm">/* volume increase */</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_VOLUMEUP</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Unhandled ADB_MISC event %02x, %02x, %02x, %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	  <span class="p">}</span>
	  <span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="mh">0x1f</span>: <span class="cm">/* Powerbook button device */</span>
	  <span class="p">{</span>
		<span class="kt">int</span> <span class="n">down</span> <span class="o">=</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xf</span><span class="p">));</span>

		<span class="cm">/*</span>
<span class="cm">		 * XXX: Where is the contrast control for the passive?</span>
<span class="cm">		 *  -- Cort</span>
<span class="cm">		 */</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x0f</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x8</span>:	<span class="cm">/* mute */</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_MUTE</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x7</span>:	<span class="cm">/* volume decrease */</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_VOLUMEDOWN</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x6</span>:	<span class="cm">/* volume increase */</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_VOLUMEUP</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0xb</span>:	<span class="cm">/* eject */</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_EJECTCD</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0xa</span>:	<span class="cm">/* brightness decrease */</span>
<span class="cp">#ifdef CONFIG_PMAC_BACKLIGHT</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">down</span><span class="p">)</span>
				<span class="n">pmac_backlight_key_down</span><span class="p">();</span>
<span class="cp">#endif</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_BRIGHTNESSDOWN</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x9</span>:	<span class="cm">/* brightness increase */</span>
<span class="cp">#ifdef CONFIG_PMAC_BACKLIGHT</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">down</span><span class="p">)</span>
				<span class="n">pmac_backlight_key_up</span><span class="p">();</span>
<span class="cp">#endif</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_BRIGHTNESSUP</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0xc</span>:	<span class="cm">/* videomode switch */</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_SWITCHVIDEOMODE</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0xd</span>:	<span class="cm">/* keyboard illumination toggle */</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_KBDILLUMTOGGLE</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0xe</span>:	<span class="cm">/* keyboard illumination decrease */</span>
			<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_KBDILLUMDOWN</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0xf</span>:
			<span class="k">switch</span> <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="p">{</span>
			<span class="k">case</span> <span class="mh">0x8f</span>:
			<span class="k">case</span> <span class="mh">0x0f</span>:
				<span class="cm">/* keyboard illumination increase */</span>
				<span class="n">input_report_key</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">,</span> <span class="n">KEY_KBDILLUMUP</span><span class="p">,</span> <span class="n">down</span><span class="p">);</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="k">case</span> <span class="mh">0x7f</span>:
			<span class="k">case</span> <span class="mh">0xff</span>:
				<span class="cm">/* keypad overlay toogle */</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="nl">default:</span>
				<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Unhandled ADB_MISC event %02x, %02x, %02x, %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				       <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="p">}</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Unhandled ADB_MISC event %02x, %02x, %02x, %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			       <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
	  <span class="p">}</span>
	  <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">input_sync</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">adb_request</span> <span class="n">led_request</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">leds_pending</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">leds_req_pending</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pending_devs</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pending_led_start</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pending_led_end</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">leds_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">leds_done</span><span class="p">(</span><span class="k">struct</span> <span class="n">adb_request</span> <span class="o">*</span><span class="n">req</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">leds</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">device</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leds_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pending_led_start</span> <span class="o">!=</span> <span class="n">pending_led_end</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">device</span> <span class="o">=</span> <span class="n">pending_devs</span><span class="p">[</span><span class="n">pending_led_start</span><span class="p">];</span>
		<span class="n">leds</span> <span class="o">=</span> <span class="n">leds_pending</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>
		<span class="n">leds_pending</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pending_led_start</span><span class="o">++</span><span class="p">;</span>
		<span class="n">pending_led_start</span> <span class="o">=</span> <span class="p">(</span><span class="n">pending_led_start</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="n">pending_led_start</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">pending</span> <span class="o">=</span> <span class="n">leds_req_pending</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">leds_req_pending</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leds_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pending</span><span class="p">)</span>
		<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led_request</span><span class="p">,</span> <span class="n">leds_done</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
			    <span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">KEYB_LEDREG</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">,</span> <span class="o">~</span><span class="n">leds</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">real_leds</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">leds</span><span class="p">,</span> <span class="kt">int</span> <span class="n">device</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leds_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">leds_req_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">leds_req_pending</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leds_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>	       
		<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">led_request</span><span class="p">,</span> <span class="n">leds_done</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
			    <span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">KEYB_LEDREG</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">,</span> <span class="o">~</span><span class="n">leds</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">leds_pending</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">&amp;</span> <span class="mh">0x100</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pending_devs</span><span class="p">[</span><span class="n">pending_led_end</span><span class="p">]</span> <span class="o">=</span> <span class="n">device</span><span class="p">;</span>
			<span class="n">pending_led_end</span><span class="o">++</span><span class="p">;</span>
			<span class="n">pending_led_end</span> <span class="o">=</span> <span class="p">(</span><span class="n">pending_led_end</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">?</span> <span class="n">pending_led_end</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">leds_pending</span><span class="p">[</span><span class="n">device</span><span class="p">]</span> <span class="o">=</span> <span class="n">leds</span> <span class="o">|</span> <span class="mh">0x100</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">leds_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>	       
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Event callback from the input module. Events that change the state of</span>
<span class="cm"> * the hardware are processed here.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">adbhid_kbd_event</span><span class="p">(</span><span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">type</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">code</span><span class="p">,</span> <span class="kt">int</span> <span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adbhid</span> <span class="o">*</span><span class="n">adbhid</span> <span class="o">=</span> <span class="n">input_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">leds</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">EV_LED</span>:
		<span class="n">leds</span> <span class="o">=</span>  <span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LED_SCROLLL</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">)</span> <span class="o">?</span> <span class="mi">4</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LED_NUML</span><span class="p">,</span>    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">)</span> <span class="o">?</span> <span class="mi">1</span> <span class="o">:</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span>
			<span class="p">(</span><span class="n">test_bit</span><span class="p">(</span><span class="n">LED_CAPSL</span><span class="p">,</span>   <span class="n">dev</span><span class="o">-&gt;</span><span class="n">led</span><span class="p">)</span> <span class="o">?</span> <span class="mi">2</span> <span class="o">:</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">real_leds</span><span class="p">(</span><span class="n">leds</span><span class="p">,</span> <span class="n">adbhid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">adbhid_kbd_capslock_remember</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adbhid</span> <span class="o">*</span><span class="n">ahid</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ahid</span> <span class="o">=</span> <span class="n">adbhid</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ahid</span> <span class="o">&amp;&amp;</span> <span class="n">ahid</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">==</span> <span class="n">ADB_KEYBOARD</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">FLAG_CAPSLOCK_TRANSLATE</span><span class="p">)</span>
				<span class="n">ahid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">FLAG_CAPSLOCK_IGNORE_NEXT</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">adb_message_handler</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">code</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">x</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">code</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ADB_MSG_PRE_RESET</span>:
	<span class="k">case</span> <span class="n">ADB_MSG_POWERDOWN</span>:
		<span class="cm">/* Stop the repeat timer. Autopoll is already off at this point */</span>
		<span class="p">{</span>
			<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
					<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adbhid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">);</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* Stop pending led requests */</span>
		<span class="k">while</span> <span class="p">(</span><span class="n">leds_req_pending</span><span class="p">)</span>
			<span class="n">adb_poll</span><span class="p">();</span>

		<span class="cm">/* After resume, and if the capslock LED is on, the PMU will</span>
<span class="cm">		 * send a &quot;capslock down&quot; key event. This confuses the</span>
<span class="cm">		 * restore_capslock_events logic. Remember if the capslock</span>
<span class="cm">		 * LED was on before suspend so the unwanted key event can</span>
<span class="cm">		 * be ignored after resume. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">restore_capslock_events</span><span class="p">)</span>
			<span class="n">adbhid_kbd_capslock_remember</span><span class="p">();</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ADB_MSG_POST_RESET</span>:
		<span class="n">adbhid_probe</span><span class="p">();</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">NOTIFY_DONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">adbhid_input_register</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">default_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">original_handler_id</span><span class="p">,</span>
		      <span class="kt">int</span> <span class="n">current_handler_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mouse_kind</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adbhid</span> <span class="o">*</span><span class="n">hid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">input_dev</span> <span class="o">*</span><span class="n">input_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">err</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">])</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Trying to reregister ADB HID on ID %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EEXIST</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="n">hid</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">adbhid</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="n">input_dev</span> <span class="o">=</span> <span class="n">input_allocate_device</span><span class="p">();</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hid</span> <span class="o">||</span> <span class="o">!</span><span class="n">input_dev</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sprintf</span><span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">,</span> <span class="s">&quot;adb%d:%d.%02x/input&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">,</span> <span class="n">default_id</span><span class="p">,</span> <span class="n">original_handler_id</span><span class="p">);</span>

	<span class="n">hid</span><span class="o">-&gt;</span><span class="n">input</span> <span class="o">=</span> <span class="n">input_dev</span><span class="p">;</span>
	<span class="n">hid</span><span class="o">-&gt;</span><span class="n">id</span> <span class="o">=</span> <span class="n">default_id</span><span class="p">;</span>
	<span class="n">hid</span><span class="o">-&gt;</span><span class="n">original_handler_id</span> <span class="o">=</span> <span class="n">original_handler_id</span><span class="p">;</span>
	<span class="n">hid</span><span class="o">-&gt;</span><span class="n">current_handler_id</span> <span class="o">=</span> <span class="n">current_handler_id</span><span class="p">;</span>
	<span class="n">hid</span><span class="o">-&gt;</span><span class="n">mouse_kind</span> <span class="o">=</span> <span class="n">mouse_kind</span><span class="p">;</span>
	<span class="n">hid</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">input_set_drvdata</span><span class="p">(</span><span class="n">input_dev</span><span class="p">,</span> <span class="n">hid</span><span class="p">);</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">name</span> <span class="o">=</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">phys</span> <span class="o">=</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">phys</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">bustype</span> <span class="o">=</span> <span class="n">BUS_ADB</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">vendor</span> <span class="o">=</span> <span class="mh">0x0001</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">default_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">|</span> <span class="n">original_handler_id</span><span class="p">;</span>
	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="mh">0x0100</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">default_id</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">ADB_KEYBOARD</span>:
		<span class="n">hid</span><span class="o">-&gt;</span><span class="n">keycode</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="n">adb_to_linux_keycodes</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="n">sprintf</span><span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ADB keyboard&quot;</span><span class="p">);</span>

		<span class="n">memcpy</span><span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">,</span> <span class="n">adb_to_linux_keycodes</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">adb_to_linux_keycodes</span><span class="p">));</span>

		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Detected ADB keyboard, type &quot;</span><span class="p">);</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">original_handler_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="nl">default:</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;&lt;unknown&gt;.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">ADB_KEYBOARD_UNKNOWN</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x01</span>: <span class="k">case</span> <span class="mh">0x02</span>: <span class="k">case</span> <span class="mh">0x03</span>: <span class="k">case</span> <span class="mh">0x06</span>: <span class="k">case</span> <span class="mh">0x08</span>:
		<span class="k">case</span> <span class="mh">0x0C</span>: <span class="k">case</span> <span class="mh">0x10</span>: <span class="k">case</span> <span class="mh">0x18</span>: <span class="k">case</span> <span class="mh">0x1B</span>: <span class="k">case</span> <span class="mh">0x1C</span>:
		<span class="k">case</span> <span class="mh">0xC0</span>: <span class="k">case</span> <span class="mh">0xC3</span>: <span class="k">case</span> <span class="mh">0xC6</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ANSI.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">ADB_KEYBOARD_ANSI</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x04</span>: <span class="k">case</span> <span class="mh">0x05</span>: <span class="k">case</span> <span class="mh">0x07</span>: <span class="k">case</span> <span class="mh">0x09</span>: <span class="k">case</span> <span class="mh">0x0D</span>:
		<span class="k">case</span> <span class="mh">0x11</span>: <span class="k">case</span> <span class="mh">0x14</span>: <span class="k">case</span> <span class="mh">0x19</span>: <span class="k">case</span> <span class="mh">0x1D</span>: <span class="k">case</span> <span class="mh">0xC1</span>:
		<span class="k">case</span> <span class="mh">0xC4</span>: <span class="k">case</span> <span class="mh">0xC7</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ISO, swapping keys.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">ADB_KEYBOARD_ISO</span><span class="p">;</span>
			<span class="n">i</span> <span class="o">=</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
			<span class="n">hid</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
			<span class="n">hid</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="mi">50</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="mh">0x12</span>: <span class="k">case</span> <span class="mh">0x15</span>: <span class="k">case</span> <span class="mh">0x16</span>: <span class="k">case</span> <span class="mh">0x17</span>: <span class="k">case</span> <span class="mh">0x1A</span>:
		<span class="k">case</span> <span class="mh">0x1E</span>: <span class="k">case</span> <span class="mh">0xC2</span>: <span class="k">case</span> <span class="mh">0xC5</span>: <span class="k">case</span> <span class="mh">0xC8</span>: <span class="k">case</span> <span class="mh">0xC9</span>:
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;JIS.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">version</span> <span class="o">=</span> <span class="n">ADB_KEYBOARD_JIS</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">128</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="n">set_bit</span><span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>

		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_LED</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_REP</span><span class="p">);</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">ledbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">LED_SCROLLL</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">LED_CAPSL</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">LED_NUML</span><span class="p">);</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">event</span> <span class="o">=</span> <span class="n">adbhid_kbd_event</span><span class="p">;</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keycodemax</span> <span class="o">=</span> <span class="n">KEY_FN</span><span class="p">;</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keycodesize</span> <span class="o">=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ADB_MOUSE</span>:
		<span class="n">sprintf</span><span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ADB mouse&quot;</span><span class="p">);</span>

		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_REL</span><span class="p">);</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">[</span><span class="n">BIT_WORD</span><span class="p">(</span><span class="n">BTN_MOUSE</span><span class="p">)]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_LEFT</span><span class="p">)</span> <span class="o">|</span>
			<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_MIDDLE</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">BTN_RIGHT</span><span class="p">);</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">relbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">REL_X</span><span class="p">)</span> <span class="o">|</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">REL_Y</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">ADB_MISC</span>:
		<span class="k">switch</span> <span class="p">(</span><span class="n">original_handler_id</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mh">0x02</span>: <span class="cm">/* Adjustable keyboard button device */</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ADB adjustable keyboard buttons&quot;</span><span class="p">);</span>
			<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_REP</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_SOUND</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_MUTE</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_VOLUMEUP</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_VOLUMEDOWN</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">case</span> <span class="mh">0x1f</span>: <span class="cm">/* Powerbook button device */</span>
			<span class="n">sprintf</span><span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="s">&quot;ADB Powerbook buttons&quot;</span><span class="p">);</span>
			<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">evbit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_KEY</span><span class="p">)</span> <span class="o">|</span>
				<span class="n">BIT_MASK</span><span class="p">(</span><span class="n">EV_REP</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_MUTE</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_VOLUMEUP</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_VOLUMEDOWN</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_BRIGHTNESSUP</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_BRIGHTNESSDOWN</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_EJECTCD</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_SWITCHVIDEOMODE</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_KBDILLUMTOGGLE</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_KBDILLUMDOWN</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="n">set_bit</span><span class="p">(</span><span class="n">KEY_KBDILLUMUP</span><span class="p">,</span> <span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keybit</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="cm">/* else fall through */</span>

	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Trying to register unknown ADB device to input layer.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">err</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">keycode</span> <span class="o">=</span> <span class="n">hid</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">;</span>

	<span class="n">err</span> <span class="o">=</span> <span class="n">input_register_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">err</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">default_id</span> <span class="o">==</span> <span class="n">ADB_KEYBOARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* HACK WARNING!! This should go away as soon there is an utility</span>
<span class="cm">		 * to control that for event devices.</span>
<span class="cm">		 */</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_DELAY</span><span class="p">]</span> <span class="o">=</span> <span class="mi">500</span><span class="p">;</span>   <span class="cm">/* input layer default: 250 */</span>
		<span class="n">input_dev</span><span class="o">-&gt;</span><span class="n">rep</span><span class="p">[</span><span class="n">REP_PERIOD</span><span class="p">]</span> <span class="o">=</span> <span class="mi">66</span><span class="p">;</span> <span class="cm">/* input layer default: 33 */</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

 <span class="nl">fail:</span>	<span class="n">input_free_device</span><span class="p">(</span><span class="n">input_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">hid</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hid</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">hid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">err</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">adbhid_input_unregister</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">input_unregister_device</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">keycode</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]);</span>
	<span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="n">u16</span>
<span class="nf">adbhid_input_reregister</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">default_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">org_handler_id</span><span class="p">,</span>
			<span class="kt">int</span> <span class="n">cur_handler_id</span><span class="p">,</span> <span class="kt">int</span> <span class="n">mk</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">])</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">id</span><span class="p">]</span><span class="o">-&gt;</span><span class="n">input</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">product</span> <span class="o">!=</span>
		    <span class="p">((</span><span class="n">id</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">)</span><span class="o">|</span><span class="p">(</span><span class="n">default_id</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span><span class="o">|</span><span class="n">org_handler_id</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">adbhid_input_unregister</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="n">adbhid_input_register</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">default_id</span><span class="p">,</span> <span class="n">org_handler_id</span><span class="p">,</span>
					      <span class="n">cur_handler_id</span><span class="p">,</span> <span class="n">mk</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span>
		<span class="n">adbhid_input_register</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">default_id</span><span class="p">,</span> <span class="n">org_handler_id</span><span class="p">,</span>
				      <span class="n">cur_handler_id</span><span class="p">,</span> <span class="n">mk</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">id</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">adbhid_input_devcleanup</span><span class="p">(</span><span class="n">u16</span> <span class="n">exist</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">for</span><span class="p">(</span><span class="n">i</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span><span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adbhid</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">exist</span><span class="o">&amp;</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">)))</span>
			<span class="n">adbhid_input_unregister</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">adbhid_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adb_request</span> <span class="n">req</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">default_id</span><span class="p">,</span> <span class="n">org_handler_id</span><span class="p">,</span> <span class="n">cur_handler_id</span><span class="p">;</span>
	<span class="n">u16</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">adb_register</span><span class="p">(</span><span class="n">ADB_MOUSE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mouse_ids</span><span class="p">,</span> <span class="n">adbhid_mouse_input</span><span class="p">);</span>
	<span class="n">adb_register</span><span class="p">(</span><span class="n">ADB_KEYBOARD</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">keyboard_ids</span><span class="p">,</span> <span class="n">adbhid_keyboard_input</span><span class="p">);</span>
	<span class="n">adb_register</span><span class="p">(</span><span class="n">ADB_MISC</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">buttons_ids</span><span class="p">,</span> <span class="n">adbhid_buttons_input</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">keyboard_ids</span><span class="p">.</span><span class="n">nids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">keyboard_ids</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">adb_get_infos</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">default_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">org_handler_id</span><span class="p">);</span>

		<span class="cm">/* turn off all leds */</span>
		<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
			    <span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">KEYB_LEDREG</span><span class="p">),</span> <span class="mh">0xff</span><span class="p">,</span> <span class="mh">0xff</span><span class="p">);</span>

		<span class="cm">/* Enable full feature set of the keyboard</span>
<span class="cm">		   -&gt;get it to send separate codes for left and right shift,</span>
<span class="cm">		   control, option keys */</span>
<span class="cp">#if 0</span><span class="c">		/* handler 5 doesn&#39;t send separate codes for R modifiers */</span>
<span class="c">		if (adb_try_handler_change(id, 5))</span>
<span class="c">			printk(&quot;ADB keyboard at %d, handler set to 5\n&quot;, id);</span>
<span class="c">		else</span>
<span class="cp">#endif</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">adb_try_handler_change</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ADB keyboard at %d, handler set to 3</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ADB keyboard at %d, handler 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>

		<span class="n">adb_get_infos</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">default_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_handler_id</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">adbhid_input_reregister</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">default_id</span><span class="p">,</span> <span class="n">org_handler_id</span><span class="p">,</span>
					       <span class="n">cur_handler_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">buttons_ids</span><span class="p">.</span><span class="n">nids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">buttons_ids</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

		<span class="n">adb_get_infos</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">default_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">org_handler_id</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">adbhid_input_reregister</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">default_id</span><span class="p">,</span> <span class="n">org_handler_id</span><span class="p">,</span>
					       <span class="n">org_handler_id</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Try to switch all mice to handler 4, or 2 for three-button</span>
<span class="cm">	   mode and full resolution. */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">mouse_ids</span><span class="p">.</span><span class="n">nids</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">id</span> <span class="o">=</span> <span class="n">mouse_ids</span><span class="p">.</span><span class="n">id</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="kt">int</span> <span class="n">mouse_kind</span><span class="p">;</span>

		<span class="n">adb_get_infos</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">default_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">org_handler_id</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">adb_try_handler_change</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ADB mouse at %d, handler set to 4&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="n">mouse_kind</span> <span class="o">=</span> <span class="n">ADBMOUSE_EXTENDED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adb_try_handler_change</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mh">0x2F</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ADB mouse at %d, handler set to 0x2F&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="n">mouse_kind</span> <span class="o">=</span> <span class="n">ADBMOUSE_MICROSPEED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adb_try_handler_change</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ADB mouse at %d, handler set to 0x42&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="n">mouse_kind</span> <span class="o">=</span> <span class="n">ADBMOUSE_TRACKBALLPRO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adb_try_handler_change</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mh">0x66</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ADB mouse at %d, handler set to 0x66&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="n">mouse_kind</span> <span class="o">=</span> <span class="n">ADBMOUSE_MICROSPEED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adb_try_handler_change</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mh">0x5F</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ADB mouse at %d, handler set to 0x5F&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="n">mouse_kind</span> <span class="o">=</span> <span class="n">ADBMOUSE_MICROSPEED</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adb_try_handler_change</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ADB mouse at %d, handler set to 3&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="n">mouse_kind</span> <span class="o">=</span> <span class="n">ADBMOUSE_MS_A3</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">adb_try_handler_change</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ADB mouse at %d, handler set to 2&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="n">mouse_kind</span> <span class="o">=</span> <span class="n">ADBMOUSE_STANDARD_200</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">printk</span><span class="p">(</span><span class="s">&quot;ADB mouse at %d, handler 1&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
			<span class="n">mouse_kind</span> <span class="o">=</span> <span class="n">ADBMOUSE_STANDARD_100</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">mouse_kind</span> <span class="o">==</span> <span class="n">ADBMOUSE_TRACKBALLPRO</span><span class="p">)</span>
		    <span class="o">||</span> <span class="p">(</span><span class="n">mouse_kind</span> <span class="o">==</span> <span class="n">ADBMOUSE_MICROSPEED</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">init_microspeed</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mouse_kind</span> <span class="o">==</span> <span class="n">ADBMOUSE_MS_A3</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">init_ms_a3</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">mouse_kind</span> <span class="o">==</span>  <span class="n">ADBMOUSE_EXTENDED</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/*</span>
<span class="cm">			 * Register 1 is usually used for device</span>
<span class="cm">			 * identification.  Here, we try to identify</span>
<span class="cm">			 * a known device and call the appropriate</span>
<span class="cm">			 * init function.</span>
<span class="cm">			 */</span>
			<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span> <span class="o">|</span> <span class="n">ADBREQ_REPLY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
				    <span class="n">ADB_READREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mi">1</span><span class="p">));</span>

			<span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="p">.</span><span class="n">reply_len</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x9a</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">((</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x21</span><span class="p">)</span>
			    	<span class="o">||</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x20</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">mouse_kind</span> <span class="o">=</span> <span class="n">ADBMOUSE_TRACKBALL</span><span class="p">;</span>
				<span class="n">init_trackball</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="p">.</span><span class="n">reply_len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x74</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x70</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x61</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x64</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mouse_kind</span> <span class="o">=</span> <span class="n">ADBMOUSE_TRACKPAD</span><span class="p">;</span>
				<span class="n">init_trackpad</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="p">.</span><span class="n">reply_len</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4b</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4d</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4c</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x31</span><span class="p">))</span> <span class="p">{</span>
				<span class="n">mouse_kind</span> <span class="o">=</span> <span class="n">ADBMOUSE_TURBOMOUSE5</span><span class="p">;</span>
				<span class="n">init_turbomouse</span><span class="p">(</span><span class="n">id</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">req</span><span class="p">.</span><span class="n">reply_len</span> <span class="o">==</span> <span class="mi">9</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4b</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x4f</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
			    <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x49</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">==</span> <span class="mh">0x54</span><span class="p">))</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">adb_try_handler_change</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mh">0x42</span><span class="p">))</span> <span class="p">{</span>
					<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">ADB MacAlly 2-button mouse at %d, handler set to 0x42&quot;</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
					<span class="n">mouse_kind</span> <span class="o">=</span> <span class="n">ADBMOUSE_MACALLY2</span><span class="p">;</span>
				<span class="p">}</span>
			<span class="p">}</span>
		<span class="p">}</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">adb_get_infos</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">default_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">cur_handler_id</span><span class="p">);</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">adbhid_input_reregister</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="n">default_id</span><span class="p">,</span> <span class="n">org_handler_id</span><span class="p">,</span>
					       <span class="n">cur_handler_id</span><span class="p">,</span> <span class="n">mouse_kind</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">adbhid_input_devcleanup</span><span class="p">(</span><span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">init_trackpad</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adb_request</span> <span class="n">req</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">8</span><span class="p">];</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; (trackpad)&quot;</span><span class="p">);</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span> <span class="o">|</span> <span class="n">ADBREQ_REPLY</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
		    <span class="n">ADB_READREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">req</span><span class="p">.</span><span class="n">reply_len</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">)</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;bad length for reg. 1</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
	<span class="p">{</span>
	    <span class="n">memcpy</span><span class="p">(</span><span class="n">r1_buffer</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">req</span><span class="p">.</span><span class="n">reply</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">8</span><span class="p">);</span>

	    <span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
	        <span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
	            <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	            <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	            <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	            <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	            <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
	            <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
	            <span class="mh">0x0d</span><span class="p">,</span>
	            <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

            <span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
	        <span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
	    	    <span class="mh">0x99</span><span class="p">,</span>
	    	    <span class="mh">0x94</span><span class="p">,</span>
	    	    <span class="mh">0x19</span><span class="p">,</span>
	    	    <span class="mh">0xff</span><span class="p">,</span>
	    	    <span class="mh">0xb2</span><span class="p">,</span>
	    	    <span class="mh">0x8a</span><span class="p">,</span>
	    	    <span class="mh">0x1b</span><span class="p">,</span>
	    	    <span class="mh">0x50</span><span class="p">);</span>

	    <span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
	        <span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
	            <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
	            <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
	            <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
	            <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
	            <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span>
	            <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span>
	            <span class="mh">0x03</span><span class="p">,</span> <span class="cm">/*r1_buffer[6],*/</span>
	            <span class="n">r1_buffer</span><span class="p">[</span><span class="mi">7</span><span class="p">]);</span>

	    <span class="cm">/* Without this flush, the trackpad may be locked up */</span>
	    <span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADB_FLUSH</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> 
<span class="nf">init_trackball</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adb_request</span> <span class="n">req</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; (trackman/mouseman)&quot;</span><span class="p">);</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mo">00</span><span class="p">,</span><span class="mh">0x81</span><span class="p">);</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mo">01</span><span class="p">,</span><span class="mh">0x81</span><span class="p">);</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mo">02</span><span class="p">,</span><span class="mh">0x81</span><span class="p">);</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mo">03</span><span class="p">,</span><span class="mh">0x38</span><span class="p">);</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mo">00</span><span class="p">,</span><span class="mh">0x81</span><span class="p">);</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mo">01</span><span class="p">,</span><span class="mh">0x81</span><span class="p">);</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mo">02</span><span class="p">,</span><span class="mh">0x81</span><span class="p">);</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span> <span class="mo">03</span><span class="p">,</span><span class="mh">0x38</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">init_turbomouse</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adb_request</span> <span class="n">req</span><span class="p">;</span>

        <span class="n">printk</span><span class="p">(</span><span class="s">&quot; (TurboMouse 5)&quot;</span><span class="p">);</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADB_FLUSH</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADB_FLUSH</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
	<span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
	    <span class="mh">0xe7</span><span class="p">,</span>
	    <span class="mh">0x8c</span><span class="p">,</span>
	    <span class="mi">0</span><span class="p">,</span>
	    <span class="mi">0</span><span class="p">,</span>
	    <span class="mi">0</span><span class="p">,</span>
	    <span class="mh">0xff</span><span class="p">,</span>
	    <span class="mh">0xff</span><span class="p">,</span>
	    <span class="mh">0x94</span><span class="p">);</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADB_FLUSH</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span>
	<span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
	    <span class="mh">0xa5</span><span class="p">,</span>
	    <span class="mh">0x14</span><span class="p">,</span>
	    <span class="mi">0</span><span class="p">,</span>
	    <span class="mi">0</span><span class="p">,</span>
	    <span class="mh">0x69</span><span class="p">,</span>
	    <span class="mh">0xff</span><span class="p">,</span>
	    <span class="mh">0xff</span><span class="p">,</span>
	    <span class="mh">0x27</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">init_microspeed</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adb_request</span> <span class="n">req</span><span class="p">;</span>

        <span class="n">printk</span><span class="p">(</span><span class="s">&quot; (Microspeed/MacPoint or compatible)&quot;</span><span class="p">);</span>

	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADB_FLUSH</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>

	<span class="cm">/* This will initialize mice using the Microspeed, MacPoint and</span>
<span class="cm">	   other compatible firmware. Bit 12 enables extended protocol.</span>
<span class="cm">	   </span>
<span class="cm">	   Register 1 Listen (4 Bytes)</span>
<span class="cm">            0 -  3     Button is mouse (set also for double clicking!!!)</span>
<span class="cm">            4 -  7     Button is locking (affects change speed also)</span>
<span class="cm">            8 - 11     Button changes speed</span>
<span class="cm">           12          1 = Extended mouse mode, 0 = normal mouse mode</span>
<span class="cm">           13 - 15     unused 0</span>
<span class="cm">           16 - 23     normal speed</span>
<span class="cm">           24 - 31     changed speed</span>

<span class="cm">       Register 1 talk holds version and product identification information.</span>
<span class="cm">       Register 1 Talk (4 Bytes):</span>
<span class="cm">            0 -  7     Product code</span>
<span class="cm">            8 - 23     undefined, reserved</span>
<span class="cm">           24 - 31     Version number</span>
<span class="cm">        </span>
<span class="cm">       Speed 0 is max. 1 to 255 set speed in increments of 1/256 of max.</span>
<span class="cm"> */</span>
	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span>
	<span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
	    <span class="mh">0x20</span><span class="p">,</span>	<span class="cm">/* alt speed = 0x20 (rather slow) */</span>
	    <span class="mh">0x00</span><span class="p">,</span>	<span class="cm">/* norm speed = 0x00 (fastest) */</span>
	    <span class="mh">0x10</span><span class="p">,</span>	<span class="cm">/* extended protocol, no speed change */</span>
	    <span class="mh">0x07</span><span class="p">);</span>	<span class="cm">/* all buttons enabled as mouse buttons, no locking */</span>


	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADB_FLUSH</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">init_ms_a3</span><span class="p">(</span><span class="kt">int</span> <span class="n">id</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">adb_request</span> <span class="n">req</span><span class="p">;</span>

	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; (Mouse Systems A3 Mouse, or compatible)&quot;</span><span class="p">);</span>
	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span>
	<span class="n">ADB_WRITEREG</span><span class="p">(</span><span class="n">id</span><span class="p">,</span> <span class="mh">0x2</span><span class="p">),</span>
	    <span class="mh">0x00</span><span class="p">,</span>
	    <span class="mh">0x07</span><span class="p">);</span>
 
 	<span class="n">adb_request</span><span class="p">(</span><span class="o">&amp;</span><span class="n">req</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">ADBREQ_SYNC</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">ADB_FLUSH</span><span class="p">(</span><span class="n">id</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">adbhid_init</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="cp">#ifndef CONFIG_MAC</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">machine_is</span><span class="p">(</span><span class="n">chrp</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">machine_is</span><span class="p">(</span><span class="n">powermac</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="cp">#endif</span>

	<span class="n">led_request</span><span class="p">.</span><span class="n">complete</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="n">adbhid_probe</span><span class="p">();</span>

	<span class="n">blocking_notifier_chain_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">adb_client_list</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">adbhid_adb_notifier</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">adbhid_exit</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
<span class="p">}</span>
 
<span class="n">module_init</span><span class="p">(</span><span class="n">adbhid_init</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">adbhid_exit</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
