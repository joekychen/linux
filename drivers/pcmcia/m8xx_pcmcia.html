<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pcmcia › m8xx_pcmcia.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>m8xx_pcmcia.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * m8xx_pcmcia.c - Linux PCMCIA socket driver for the mpc8xx series.</span>
<span class="cm"> *</span>
<span class="cm"> * (C) 1999-2000 Magnus Damm &lt;damm@opensource.se&gt;</span>
<span class="cm"> * (C) 2001-2002 Montavista Software, Inc.</span>
<span class="cm"> *     &lt;mlocke@mvista.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * Support for two slots by Cyclades Corporation</span>
<span class="cm"> *     &lt;oliver.kurth@cyclades.de&gt;</span>
<span class="cm"> * Further fixes, v2.6 kernel port</span>
<span class="cm"> *     &lt;marcelo.tosatti@cyclades.com&gt;</span>
<span class="cm"> * </span>
<span class="cm"> * Some fixes, additions (C) 2005-2007 Montavista Software, Inc.</span>
<span class="cm"> *     &lt;vbordug@ru.mvista.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * &quot;The ExCA standard specifies that socket controllers should provide</span>
<span class="cm"> * two IO and five memory windows per socket, which can be independently</span>
<span class="cm"> * configured and positioned in the host address space and mapped to</span>
<span class="cm"> * arbitrary segments of card address space. &quot; - David A Hinds. 1999</span>
<span class="cm"> *</span>
<span class="cm"> * This controller does _not_ meet the ExCA standard.</span>
<span class="cm"> *</span>
<span class="cm"> * m8xx pcmcia controller brief info:</span>
<span class="cm"> * + 8 windows (attrib, mem, i/o)</span>
<span class="cm"> * + up to two slots (SLOT_A and SLOT_B)</span>
<span class="cm"> * + inputpins, outputpins, event and mask registers.</span>
<span class="cm"> * - no offset register. sigh.</span>
<span class="cm"> *</span>
<span class="cm"> * Because of the lacking offset register we must map the whole card.</span>
<span class="cm"> * We assign each memory window PCMCIA_MEM_WIN_SIZE address space.</span>
<span class="cm"> * Make sure there is (PCMCIA_MEM_WIN_SIZE * PCMCIA_MEM_WIN_NO</span>
<span class="cm"> * * PCMCIA_SOCKETS_NO) bytes at PCMCIA_MEM_WIN_BASE.</span>
<span class="cm"> * The i/o windows are dynamically allocated at PCMCIA_IO_WIN_BASE.</span>
<span class="cm"> * They are maximum 64KByte each...</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/fsl_devices.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;linux/of_device.h&gt;</span>
<span class="cp">#include &lt;linux/of_platform.h&gt;</span>

<span class="cp">#include &lt;asm/io.h&gt;</span>
<span class="cp">#include &lt;asm/time.h&gt;</span>
<span class="cp">#include &lt;asm/mpc8xx.h&gt;</span>
<span class="cp">#include &lt;asm/8xx_immap.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/fs_pd.h&gt;</span>

<span class="cp">#include &lt;pcmcia/ss.h&gt;</span>

<span class="cp">#define pcmcia_info(args...) printk(KERN_INFO &quot;m8xx_pcmcia: &quot;args)</span>
<span class="cp">#define pcmcia_error(args...) printk(KERN_ERR &quot;m8xx_pcmcia: &quot;args)</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">version</span> <span class="o">=</span> <span class="s">&quot;Version 0.06, Aug 2005&quot;</span><span class="p">;</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual MPL/GPL&quot;</span><span class="p">);</span>

<span class="cp">#if !defined(CONFIG_PCMCIA_SLOT_A) &amp;&amp; !defined(CONFIG_PCMCIA_SLOT_B)</span>

<span class="cm">/* The RPX series use SLOT_B */</span>
<span class="cp">#if defined(CONFIG_RPXCLASSIC) || defined(CONFIG_RPXLITE)</span>
<span class="cp">#define CONFIG_PCMCIA_SLOT_B</span>
<span class="cp">#define CONFIG_BD_IS_MHZ</span>
<span class="cp">#endif</span>

<span class="cm">/* The ADS board use SLOT_A */</span>
<span class="cp">#ifdef CONFIG_ADS</span>
<span class="cp">#define CONFIG_PCMCIA_SLOT_A</span>
<span class="cp">#define CONFIG_BD_IS_MHZ</span>
<span class="cp">#endif</span>

<span class="cm">/* The FADS series are a mess */</span>
<span class="cp">#ifdef CONFIG_FADS</span>
<span class="cp">#if defined(CONFIG_MPC860T) || defined(CONFIG_MPC860) || defined(CONFIG_MPC821)</span>
<span class="cp">#define CONFIG_PCMCIA_SLOT_A</span>
<span class="cp">#else</span>
<span class="cp">#define CONFIG_PCMCIA_SLOT_B</span>
<span class="cp">#endif</span>
<span class="cp">#endif</span>

<span class="cp">#if defined(CONFIG_MPC885ADS)</span>
<span class="cp">#define CONFIG_PCMCIA_SLOT_A</span>
<span class="cp">#define PCMCIA_GLITCHY_CD</span>
<span class="cp">#endif</span>

<span class="cm">/* Cyclades ACS uses both slots */</span>
<span class="cp">#ifdef CONFIG_PRxK</span>
<span class="cp">#define CONFIG_PCMCIA_SLOT_A</span>
<span class="cp">#define CONFIG_PCMCIA_SLOT_B</span>
<span class="cp">#endif</span>

<span class="cp">#endif				</span><span class="cm">/* !defined(CONFIG_PCMCIA_SLOT_A) &amp;&amp; !defined(CONFIG_PCMCIA_SLOT_B) */</span><span class="cp"></span>

<span class="cp">#if defined(CONFIG_PCMCIA_SLOT_A) &amp;&amp; defined(CONFIG_PCMCIA_SLOT_B)</span>

<span class="cp">#define PCMCIA_SOCKETS_NO 2</span>
<span class="cm">/* We have only 8 windows, dualsocket support will be limited. */</span>
<span class="cp">#define PCMCIA_MEM_WIN_NO 2</span>
<span class="cp">#define PCMCIA_IO_WIN_NO  2</span>
<span class="cp">#define PCMCIA_SLOT_MSG &quot;SLOT_A and SLOT_B&quot;</span>

<span class="cp">#elif defined(CONFIG_PCMCIA_SLOT_A) || defined(CONFIG_PCMCIA_SLOT_B)</span>

<span class="cp">#define PCMCIA_SOCKETS_NO 1</span>
<span class="cm">/* full support for one slot */</span>
<span class="cp">#define PCMCIA_MEM_WIN_NO 5</span>
<span class="cp">#define PCMCIA_IO_WIN_NO  2</span>

<span class="cm">/* define _slot_ to be able to optimize macros */</span>

<span class="cp">#ifdef CONFIG_PCMCIA_SLOT_A</span>
<span class="cp">#define _slot_ 0</span>
<span class="cp">#define PCMCIA_SLOT_MSG &quot;SLOT_A&quot;</span>
<span class="cp">#else</span>
<span class="cp">#define _slot_ 1</span>
<span class="cp">#define PCMCIA_SLOT_MSG &quot;SLOT_B&quot;</span>
<span class="cp">#endif</span>

<span class="cp">#else</span>
<span class="cp">#error m8xx_pcmcia: Bad configuration!</span>
<span class="cp">#endif</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="cp">#define PCMCIA_MEM_WIN_BASE 0xe0000000	</span><span class="cm">/* base address for memory window 0   */</span><span class="cp"></span>
<span class="cp">#define PCMCIA_MEM_WIN_SIZE 0x04000000	</span><span class="cm">/* each memory window is 64 MByte     */</span><span class="cp"></span>
<span class="cp">#define PCMCIA_IO_WIN_BASE  _IO_BASE	</span><span class="cm">/* base address for io window 0       */</span><span class="cp"></span>
<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pcmcia_schlvl</span><span class="p">;</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">events_lock</span><span class="p">);</span>

<span class="cp">#define PCMCIA_SOCKET_KEY_5V 1</span>
<span class="cp">#define PCMCIA_SOCKET_KEY_LV 2</span>

<span class="cm">/* look up table for pgcrx registers */</span>
<span class="k">static</span> <span class="n">u32</span> <span class="o">*</span><span class="n">m8xx_pgcrx</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * This structure is used to address each window in the PCMCIA controller.</span>
<span class="cm"> *</span>
<span class="cm"> * Keep in mind that we assume that pcmcia_win[n+1] is mapped directly</span>
<span class="cm"> * after pcmcia_win[n]...</span>
<span class="cm"> */</span>

<span class="k">struct</span> <span class="n">pcmcia_win</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">br</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">or</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/*</span>
<span class="cm"> * For some reason the hardware guys decided to make both slots share</span>
<span class="cm"> * some registers.</span>
<span class="cm"> *</span>
<span class="cm"> * Could someone invent object oriented hardware ?</span>
<span class="cm"> *</span>
<span class="cm"> * The macros are used to get the right bit from the registers.</span>
<span class="cm"> * SLOT_A : slot = 0</span>
<span class="cm"> * SLOT_B : slot = 1</span>
<span class="cm"> */</span>

<span class="cp">#define M8XX_PCMCIA_VS1(slot)      (0x80000000 &gt;&gt; (slot &lt;&lt; 4))</span>
<span class="cp">#define M8XX_PCMCIA_VS2(slot)      (0x40000000 &gt;&gt; (slot &lt;&lt; 4))</span>
<span class="cp">#define M8XX_PCMCIA_VS_MASK(slot)  (0xc0000000 &gt;&gt; (slot &lt;&lt; 4))</span>
<span class="cp">#define M8XX_PCMCIA_VS_SHIFT(slot) (30 - (slot &lt;&lt; 4))</span>

<span class="cp">#define M8XX_PCMCIA_WP(slot)       (0x20000000 &gt;&gt; (slot &lt;&lt; 4))</span>
<span class="cp">#define M8XX_PCMCIA_CD2(slot)      (0x10000000 &gt;&gt; (slot &lt;&lt; 4))</span>
<span class="cp">#define M8XX_PCMCIA_CD1(slot)      (0x08000000 &gt;&gt; (slot &lt;&lt; 4))</span>
<span class="cp">#define M8XX_PCMCIA_BVD2(slot)     (0x04000000 &gt;&gt; (slot &lt;&lt; 4))</span>
<span class="cp">#define M8XX_PCMCIA_BVD1(slot)     (0x02000000 &gt;&gt; (slot &lt;&lt; 4))</span>
<span class="cp">#define M8XX_PCMCIA_RDY(slot)      (0x01000000 &gt;&gt; (slot &lt;&lt; 4))</span>
<span class="cp">#define M8XX_PCMCIA_RDY_L(slot)    (0x00800000 &gt;&gt; (slot &lt;&lt; 4))</span>
<span class="cp">#define M8XX_PCMCIA_RDY_H(slot)    (0x00400000 &gt;&gt; (slot &lt;&lt; 4))</span>
<span class="cp">#define M8XX_PCMCIA_RDY_R(slot)    (0x00200000 &gt;&gt; (slot &lt;&lt; 4))</span>
<span class="cp">#define M8XX_PCMCIA_RDY_F(slot)    (0x00100000 &gt;&gt; (slot &lt;&lt; 4))</span>
<span class="cp">#define M8XX_PCMCIA_MASK(slot)     (0xFFFF0000 &gt;&gt; (slot &lt;&lt; 4))</span>

<span class="cp">#define M8XX_PCMCIA_POR_VALID    0x00000001</span>
<span class="cp">#define M8XX_PCMCIA_POR_WRPROT   0x00000002</span>
<span class="cp">#define M8XX_PCMCIA_POR_ATTRMEM  0x00000010</span>
<span class="cp">#define M8XX_PCMCIA_POR_IO       0x00000018</span>
<span class="cp">#define M8XX_PCMCIA_POR_16BIT    0x00000040</span>

<span class="cp">#define M8XX_PGCRX(slot)  m8xx_pgcrx[slot]</span>

<span class="cp">#define M8XX_PGCRX_CXOE    0x00000080</span>
<span class="cp">#define M8XX_PGCRX_CXRESET 0x00000040</span>

<span class="cm">/* we keep one lookup table per socket to check flags */</span>

<span class="cp">#define PCMCIA_EVENTS_MAX 5	</span><span class="cm">/* 4 max at a time + termination */</span><span class="cp"></span>

<span class="k">struct</span> <span class="n">event_table</span> <span class="p">{</span>
	<span class="n">u32</span> <span class="n">regbit</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">eventbit</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">const</span> <span class="kt">char</span> <span class="n">driver_name</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&quot;m8xx-pcmcia&quot;</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">socket_info</span> <span class="p">{</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">,</span> <span class="n">u32</span> <span class="n">events</span><span class="p">);</span>
	<span class="kt">void</span> <span class="o">*</span><span class="n">info</span><span class="p">;</span>

	<span class="n">u32</span> <span class="n">slot</span><span class="p">;</span>
	<span class="n">pcmconf8xx_t</span> <span class="o">*</span><span class="n">pcmcia</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">bus_freq</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">hwirq</span><span class="p">;</span>

	<span class="n">socket_state_t</span> <span class="n">state</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pccard_mem_map</span> <span class="n">mem_win</span><span class="p">[</span><span class="n">PCMCIA_MEM_WIN_NO</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pccard_io_map</span> <span class="n">io_win</span><span class="p">[</span><span class="n">PCMCIA_IO_WIN_NO</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">event_table</span> <span class="n">events</span><span class="p">[</span><span class="n">PCMCIA_EVENTS_MAX</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="n">socket</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">socket_info</span> <span class="n">socket</span><span class="p">[</span><span class="n">PCMCIA_SOCKETS_NO</span><span class="p">];</span>

<span class="cm">/*</span>
<span class="cm"> * Search this table to see if the windowsize is</span>
<span class="cm"> * supported...</span>
<span class="cm"> */</span>

<span class="cp">#define M8XX_SIZES_NO 32</span>

<span class="k">static</span> <span class="k">const</span> <span class="n">u32</span> <span class="n">m8xx_size_to_gray</span><span class="p">[</span><span class="n">M8XX_SIZES_NO</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="mh">0x00000001</span><span class="p">,</span> <span class="mh">0x00000002</span><span class="p">,</span> <span class="mh">0x00000008</span><span class="p">,</span> <span class="mh">0x00000004</span><span class="p">,</span>
	<span class="mh">0x00000080</span><span class="p">,</span> <span class="mh">0x00000040</span><span class="p">,</span> <span class="mh">0x00000010</span><span class="p">,</span> <span class="mh">0x00000020</span><span class="p">,</span>
	<span class="mh">0x00008000</span><span class="p">,</span> <span class="mh">0x00004000</span><span class="p">,</span> <span class="mh">0x00001000</span><span class="p">,</span> <span class="mh">0x00002000</span><span class="p">,</span>
	<span class="mh">0x00000100</span><span class="p">,</span> <span class="mh">0x00000200</span><span class="p">,</span> <span class="mh">0x00000800</span><span class="p">,</span> <span class="mh">0x00000400</span><span class="p">,</span>

	<span class="mh">0x0fffffff</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span>
	<span class="mh">0x01000000</span><span class="p">,</span> <span class="mh">0x02000000</span><span class="p">,</span> <span class="mh">0xffffffff</span><span class="p">,</span> <span class="mh">0x04000000</span><span class="p">,</span>
	<span class="mh">0x00010000</span><span class="p">,</span> <span class="mh">0x00020000</span><span class="p">,</span> <span class="mh">0x00080000</span><span class="p">,</span> <span class="mh">0x00040000</span><span class="p">,</span>
	<span class="mh">0x00800000</span><span class="p">,</span> <span class="mh">0x00400000</span><span class="p">,</span> <span class="mh">0x00100000</span><span class="p">,</span> <span class="mh">0x00200000</span>
<span class="p">};</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">m8xx_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="cp">#define PCMCIA_BMT_LIMIT (15*4)	</span><span class="cm">/* Bus Monitor Timeout value */</span><span class="cp"></span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>
<span class="cm">/* board specific stuff:                                                     */</span>
<span class="cm">/* voltage_set(), hardware_enable() and hardware_disable()                   */</span>
<span class="cm">/* ------------------------------------------------------------------------- */</span>
<span class="cm">/* RPX Boards from Embedded Planet                                           */</span>

<span class="cp">#if defined(CONFIG_RPXCLASSIC) || defined(CONFIG_RPXLITE)</span>

<span class="cm">/* The RPX boards seems to have it&#39;s bus monitor timeout set to 6*8 clocks.</span>
<span class="cm"> * SYPCR is write once only, therefore must the slowest memory be faster</span>
<span class="cm"> * than the bus monitor or we will get a machine check due to the bus timeout.</span>
<span class="cm"> */</span>

<span class="cp">#define PCMCIA_BOARD_MSG &quot;RPX CLASSIC or RPX LITE&quot;</span>

<span class="cp">#undef PCMCIA_BMT_LIMIT</span>
<span class="cp">#define PCMCIA_BMT_LIMIT (6*8)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">voltage_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">33</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">BCSR1_PCVCTL4</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">50</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">BCSR1_PCVCTL5</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">33</span>:
	<span class="k">case</span> <span class="mi">50</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span> <span class="o">==</span> <span class="n">vpp</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">BCSR1_PCVCTL6</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">120</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">BCSR1_PCVCTL7</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">((</span><span class="n">vcc</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vcc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)))</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* first, turn off all power */</span>

	<span class="n">out_be32</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">RPX_CSR_ADDR</span><span class="p">),</span>
		 <span class="n">in_be32</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">RPX_CSR_ADDR</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BCSR1_PCVCTL4</span> <span class="o">|</span>
						     <span class="n">BCSR1_PCVCTL5</span> <span class="o">|</span>
						     <span class="n">BCSR1_PCVCTL6</span> <span class="o">|</span>
						     <span class="n">BCSR1_PCVCTL7</span><span class="p">));</span>

	<span class="cm">/* enable new powersettings */</span>

	<span class="n">out_be32</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">RPX_CSR_ADDR</span><span class="p">),</span> <span class="n">in_be32</span><span class="p">(((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">RPX_CSR_ADDR</span><span class="p">))</span> <span class="o">|</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define socket_get(_slot_) PCMCIA_SOCKET_KEY_5V</span>
<span class="cp">#define hardware_enable(_slot_)	</span><span class="cm">/* No hardware to enable */</span><span class="cp"></span>
<span class="cp">#define hardware_disable(_slot_)	</span><span class="cm">/* No hardware to disable */</span><span class="cp"></span>

<span class="cp">#endif				</span><span class="cm">/* CONFIG_RPXCLASSIC */</span><span class="cp"></span>

<span class="cm">/* FADS Boards from Motorola                                               */</span>

<span class="cp">#if defined(CONFIG_FADS)</span>

<span class="cp">#define PCMCIA_BOARD_MSG &quot;FADS&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">voltage_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">33</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">BCSR1_PCCVCC0</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">50</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">BCSR1_PCCVCC1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">33</span>:
	<span class="k">case</span> <span class="mi">50</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span> <span class="o">==</span> <span class="n">vpp</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">BCSR1_PCCVPP1</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">120</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">vcc</span> <span class="o">==</span> <span class="mi">33</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vcc</span> <span class="o">==</span> <span class="mi">50</span><span class="p">))</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">BCSR1_PCCVPP0</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* first, turn off all power */</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">BCSR1</span><span class="p">,</span>
		 <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">BCSR1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">BCSR1_PCCVCC_MASK</span> <span class="o">|</span>
					    <span class="n">BCSR1_PCCVPP_MASK</span><span class="p">));</span>

	<span class="cm">/* enable new powersettings */</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">BCSR1</span><span class="p">,</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">BCSR1</span><span class="p">)</span> <span class="o">|</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define socket_get(_slot_) PCMCIA_SOCKET_KEY_5V</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hardware_enable</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">BCSR1</span><span class="p">,</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">BCSR1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">BCSR1_PCCEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">hardware_disable</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">out_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">BCSR1</span><span class="p">,</span> <span class="n">in_be32</span><span class="p">((</span><span class="n">u32</span> <span class="o">*</span><span class="p">)</span> <span class="n">BCSR1</span><span class="p">)</span> <span class="o">|</span> <span class="n">BCSR1_PCCEN</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/* MPC885ADS Boards */</span>

<span class="cp">#if defined(CONFIG_MPC885ADS)</span>

<span class="cp">#define PCMCIA_BOARD_MSG &quot;MPC885ADS&quot;</span>
<span class="cp">#define socket_get(_slot_) PCMCIA_SOCKET_KEY_5V</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hardware_enable</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m8xx_pcmcia_ops</span><span class="p">.</span><span class="n">hw_ctrl</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">hardware_disable</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">m8xx_pcmcia_ops</span><span class="p">.</span><span class="n">hw_ctrl</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">voltage_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">m8xx_pcmcia_ops</span><span class="p">.</span><span class="n">voltage_set</span><span class="p">(</span><span class="n">slot</span><span class="p">,</span> <span class="n">vcc</span><span class="p">,</span> <span class="n">vpp</span><span class="p">);</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/* ------------------------------------------------------------------------- */</span>
<span class="cm">/* Motorola MBX860                                                           */</span>

<span class="cp">#if defined(CONFIG_MBX)</span>

<span class="cp">#define PCMCIA_BOARD_MSG &quot;MBX&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">voltage_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">33</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">CSR2_VCC_33</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">50</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">CSR2_VCC_50</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">33</span>:
	<span class="k">case</span> <span class="mi">50</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span> <span class="o">==</span> <span class="n">vpp</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">CSR2_VPP_VCC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">120</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">vcc</span> <span class="o">==</span> <span class="mi">33</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vcc</span> <span class="o">==</span> <span class="mi">50</span><span class="p">))</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">CSR2_VPP_12</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* first, turn off all power */</span>
	<span class="n">out_8</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">MBX_CSR2_ADDR</span><span class="p">,</span>
	      <span class="n">in_8</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">MBX_CSR2_ADDR</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">CSR2_VCC_MASK</span> <span class="o">|</span> <span class="n">CSR2_VPP_MASK</span><span class="p">));</span>

	<span class="cm">/* enable new powersettings */</span>
	<span class="n">out_8</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">MBX_CSR2_ADDR</span><span class="p">,</span> <span class="n">in_8</span><span class="p">((</span><span class="n">u8</span> <span class="o">*</span><span class="p">)</span> <span class="n">MBX_CSR2_ADDR</span><span class="p">)</span> <span class="o">|</span> <span class="n">reg</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define socket_get(_slot_) PCMCIA_SOCKET_KEY_5V</span>
<span class="cp">#define hardware_enable(_slot_)	</span><span class="cm">/* No hardware to enable */</span><span class="cp"></span>
<span class="cp">#define hardware_disable(_slot_)	</span><span class="cm">/* No hardware to disable */</span><span class="cp"></span>

<span class="cp">#endif				</span><span class="cm">/* CONFIG_MBX */</span><span class="cp"></span>

<span class="cp">#if defined(CONFIG_PRxK)</span>
<span class="cp">#include &lt;asm/cpld.h&gt;</span>
<span class="k">extern</span> <span class="k">volatile</span> <span class="n">fpga_pc_regs</span> <span class="o">*</span><span class="n">fpga_pc</span><span class="p">;</span>

<span class="cp">#define PCMCIA_BOARD_MSG &quot;MPC855T&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">voltage_set</span><span class="p">(</span><span class="kt">int</span> <span class="n">slot</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vcc</span><span class="p">,</span> <span class="kt">int</span> <span class="n">vpp</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">regread</span><span class="p">;</span>
	<span class="n">cpld_regs</span> <span class="o">*</span><span class="n">ccpld</span> <span class="o">=</span> <span class="n">get_cpld</span><span class="p">();</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vcc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">33</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">PCMCIA_VCC_33</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">50</span>:
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">PCMCIA_VCC_50</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">vpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">33</span>:
	<span class="k">case</span> <span class="mi">50</span>:
		<span class="k">if</span> <span class="p">(</span><span class="n">vcc</span> <span class="o">==</span> <span class="n">vpp</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">PCMCIA_VPP_VCC</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">120</span>:
		<span class="k">if</span> <span class="p">((</span><span class="n">vcc</span> <span class="o">==</span> <span class="mi">33</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">vcc</span> <span class="o">==</span> <span class="mi">50</span><span class="p">))</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">PCMCIA_VPP_12</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>
	<span class="n">regread</span> <span class="o">=</span> <span class="n">in_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccpld</span><span class="o">-&gt;</span><span class="n">fpga_pc_ctl</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span>
	    <span class="p">(</span><span class="n">regread</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">PCMCIA_VCC_MASK</span> <span class="o">|</span> <span class="n">PCMCIA_VPP_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">slot</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">))))</span> <span class="p">{</span>
		<span class="cm">/* enable new powersettings */</span>
		<span class="n">regread</span> <span class="o">=</span>
		    <span class="n">regread</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">((</span><span class="n">PCMCIA_VCC_MASK</span> <span class="o">|</span> <span class="n">PCMCIA_VPP_MASK</span><span class="p">)</span> <span class="o">&gt;&gt;</span>
				<span class="p">(</span><span class="n">slot</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">));</span>
		<span class="n">out_8</span><span class="p">(</span><span class="o">&amp;</span><span class="n">ccpld</span><span class="o">-&gt;</span><span class="n">fpga_pc_ctl</span><span class="p">,</span> <span class="n">reg</span> <span class="o">|</span> <span class="n">regread</span><span class="p">);</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">100</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#define socket_get(_slot_) PCMCIA_SOCKET_KEY_LV</span>
<span class="cp">#define hardware_enable(_slot_)	</span><span class="cm">/* No hardware to enable */</span><span class="cp"></span>
<span class="cp">#define hardware_disable(_slot_)	</span><span class="cm">/* No hardware to disable */</span><span class="cp"></span>

<span class="cp">#endif				</span><span class="cm">/* CONFIG_PRxK */</span><span class="cp"></span>

<span class="k">static</span> <span class="n">u32</span> <span class="n">pending_events</span><span class="p">[</span><span class="n">PCMCIA_SOCKETS_NO</span><span class="p">];</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">pending_event_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">m8xx_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">socket_info</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">event_table</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">pscr</span><span class="p">,</span> <span class="n">pipr</span><span class="p">,</span> <span class="n">per</span><span class="p">;</span>
	<span class="n">pcmconf8xx_t</span> <span class="o">*</span><span class="n">pcmcia</span> <span class="o">=</span> <span class="n">socket</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pcmcia</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;m8xx_pcmcia: Interrupt!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="cm">/* get interrupt sources */</span>

	<span class="n">pscr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_pscr</span><span class="p">);</span>
	<span class="n">pipr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_pipr</span><span class="p">);</span>
	<span class="n">per</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_per</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCMCIA_SOCKETS_NO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
		<span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">events</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">while</span> <span class="p">(</span><span class="n">e</span><span class="o">-&gt;</span><span class="n">regbit</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pscr</span> <span class="o">&amp;</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">regbit</span><span class="p">)</span>
				<span class="n">events</span> <span class="o">|=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">eventbit</span><span class="p">;</span>

			<span class="n">e</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/*</span>
<span class="cm">		 * report only if both card detect signals are the same</span>
<span class="cm">		 * not too nice done,</span>
<span class="cm">		 * we depend on that CD2 is the bit to the left of CD1...</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">SS_DETECT</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(((</span><span class="n">pipr</span> <span class="o">&amp;</span> <span class="n">M8XX_PCMCIA_CD2</span><span class="p">(</span><span class="n">i</span><span class="p">))</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">^</span>
			    <span class="p">(</span><span class="n">pipr</span> <span class="o">&amp;</span> <span class="n">M8XX_PCMCIA_CD1</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">events</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SS_DETECT</span><span class="p">;</span>
			<span class="p">}</span>
<span class="cp">#ifdef PCMCIA_GLITCHY_CD</span>
		<span class="cm">/*</span>
<span class="cm">		 * I&#39;ve experienced CD problems with my ADS board.</span>
<span class="cm">		 * We make an extra check to see if there was a</span>
<span class="cm">		 * real change of Card detection.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">((</span><span class="n">events</span> <span class="o">&amp;</span> <span class="n">SS_DETECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">((</span><span class="n">pipr</span> <span class="o">&amp;</span>
		      <span class="p">(</span><span class="n">M8XX_PCMCIA_CD2</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">|</span> <span class="n">M8XX_PCMCIA_CD1</span><span class="p">(</span><span class="n">i</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">Vcc</span> <span class="o">|</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">Vpp</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">events</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">SS_DETECT</span><span class="p">;</span>
			<span class="cm">/*printk( &quot;CD glitch workaround - CD = 0x%08x!\n&quot;,</span>
<span class="cm">			   (pipr &amp; (M8XX_PCMCIA_CD2(i)</span>
<span class="cm">			   | M8XX_PCMCIA_CD1(i)))); */</span>
		<span class="p">}</span>
<span class="cp">#endif</span>

		<span class="cm">/* call the handler */</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;m8xx_pcmcia: slot %u: events = 0x%02x, pscr = 0x%08x, &quot;</span>
			<span class="s">&quot;pipr = 0x%08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">events</span><span class="p">,</span> <span class="n">pscr</span><span class="p">,</span> <span class="n">pipr</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pending_event_lock</span><span class="p">);</span>
			<span class="n">pending_events</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">|=</span> <span class="n">events</span><span class="p">;</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pending_event_lock</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Turn off RDY_L bits in the PER mask on</span>
<span class="cm">			 * CD interrupt receival.</span>
<span class="cm">			 *</span>
<span class="cm">			 * They can generate bad interrupts on the</span>
<span class="cm">			 * ACS4,8,16,32.   - marcelo</span>
<span class="cm">			 */</span>
			<span class="n">per</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">M8XX_PCMCIA_RDY_L</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
			<span class="n">per</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">M8XX_PCMCIA_RDY_L</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_per</span><span class="p">,</span> <span class="n">per</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">)</span>
				<span class="n">pcmcia_parse_events</span><span class="p">(</span><span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* clear the interrupt sources */</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_pscr</span><span class="p">,</span> <span class="n">pscr</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;m8xx_pcmcia: Interrupt done.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">m8xx_get_graycode</span><span class="p">(</span><span class="n">u32</span> <span class="n">size</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">k</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;</span> <span class="n">M8XX_SIZES_NO</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">m8xx_size_to_gray</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="n">size</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">k</span> <span class="o">==</span> <span class="n">M8XX_SIZES_NO</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">m8xx_size_to_gray</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
		<span class="n">k</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">k</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u32</span> <span class="nf">m8xx_get_speed</span><span class="p">(</span><span class="n">u32</span> <span class="n">ns</span><span class="p">,</span> <span class="n">u32</span> <span class="n">is_io</span><span class="p">,</span> <span class="n">u32</span> <span class="n">bus_freq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">reg</span><span class="p">,</span> <span class="n">clocks</span><span class="p">,</span> <span class="n">psst</span><span class="p">,</span> <span class="n">psl</span><span class="p">,</span> <span class="n">psht</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ns</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/*</span>
<span class="cm">		 * We get called with IO maps setup to 0ns</span>
<span class="cm">		 * if not specified by the user.</span>
<span class="cm">		 * They should be 255ns.</span>
<span class="cm">		 */</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">is_io</span><span class="p">)</span>
			<span class="n">ns</span> <span class="o">=</span> <span class="mi">255</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">ns</span> <span class="o">=</span> <span class="mi">100</span><span class="p">;</span>	<span class="cm">/* fast memory if 0 */</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * In PSST, PSL, PSHT fields we tell the controller</span>
<span class="cm">	 * timing parameters in CLKOUT clock cycles.</span>
<span class="cm">	 * CLKOUT is the same as GCLK2_50.</span>
<span class="cm">	 */</span>

<span class="cm">/* how we want to adjust the timing - in percent */</span>

<span class="cp">#define ADJ 180			</span><span class="cm">/* 80 % longer accesstime - to be sure */</span><span class="cp"></span>

	<span class="n">clocks</span> <span class="o">=</span> <span class="p">((</span><span class="n">bus_freq</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">*</span> <span class="n">ns</span><span class="p">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">;</span>
	<span class="n">clocks</span> <span class="o">=</span> <span class="p">(</span><span class="n">clocks</span> <span class="o">*</span> <span class="n">ADJ</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">100</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">clocks</span> <span class="o">&gt;=</span> <span class="n">PCMCIA_BMT_LIMIT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Max access time limit reached</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">clocks</span> <span class="o">=</span> <span class="n">PCMCIA_BMT_LIMIT</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">psst</span> <span class="o">=</span> <span class="n">clocks</span> <span class="o">/</span> <span class="mi">7</span><span class="p">;</span>	<span class="cm">/* setup time */</span>
	<span class="n">psht</span> <span class="o">=</span> <span class="n">clocks</span> <span class="o">/</span> <span class="mi">7</span><span class="p">;</span>	<span class="cm">/* hold time */</span>
	<span class="n">psl</span> <span class="o">=</span> <span class="p">(</span><span class="n">clocks</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span> <span class="o">/</span> <span class="mi">7</span><span class="p">;</span>	<span class="cm">/* strobe length */</span>

	<span class="n">psst</span> <span class="o">+=</span> <span class="n">clocks</span> <span class="o">-</span> <span class="p">(</span><span class="n">psst</span> <span class="o">+</span> <span class="n">psht</span> <span class="o">+</span> <span class="n">psl</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">psst</span> <span class="o">&lt;&lt;</span> <span class="mi">12</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">psl</span> <span class="o">&lt;&lt;</span> <span class="mi">7</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">psht</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">reg</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m8xx_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lsock</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket_info</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket_info</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">lsock</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">pipr</span><span class="p">,</span> <span class="n">reg</span><span class="p">;</span>
	<span class="n">pcmconf8xx_t</span> <span class="o">*</span><span class="n">pcmcia</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pcmcia</span><span class="p">;</span>

	<span class="n">pipr</span> <span class="o">=</span> <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_pipr</span><span class="p">);</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">pipr</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">M8XX_PCMCIA_CD1</span><span class="p">(</span><span class="n">lsock</span><span class="p">)</span>
			   <span class="o">|</span> <span class="n">M8XX_PCMCIA_CD2</span><span class="p">(</span><span class="n">lsock</span><span class="p">)))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">?</span> <span class="n">SS_DETECT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pipr</span> <span class="o">&amp;</span> <span class="n">M8XX_PCMCIA_WP</span><span class="p">(</span><span class="n">lsock</span><span class="p">))</span> <span class="o">?</span> <span class="n">SS_WRPROT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_IOCARD</span><span class="p">)</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pipr</span> <span class="o">&amp;</span> <span class="n">M8XX_PCMCIA_BVD1</span><span class="p">(</span><span class="n">lsock</span><span class="p">))</span> <span class="o">?</span> <span class="n">SS_STSCHG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pipr</span> <span class="o">&amp;</span> <span class="n">M8XX_PCMCIA_RDY</span><span class="p">(</span><span class="n">lsock</span><span class="p">))</span> <span class="o">?</span> <span class="n">SS_READY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pipr</span> <span class="o">&amp;</span> <span class="n">M8XX_PCMCIA_BVD1</span><span class="p">(</span><span class="n">lsock</span><span class="p">))</span> <span class="o">?</span> <span class="n">SS_BATDEAD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">pipr</span> <span class="o">&amp;</span> <span class="n">M8XX_PCMCIA_BVD2</span><span class="p">(</span><span class="n">lsock</span><span class="p">))</span> <span class="o">?</span> <span class="n">SS_BATWARN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">Vcc</span> <span class="o">|</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span><span class="p">.</span><span class="n">Vpp</span><span class="p">)</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="n">SS_POWERON</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Voltage detection:</span>
<span class="cm">	 * This driver only supports 16-Bit pc-cards.</span>
<span class="cm">	 * Cardbus is not handled here.</span>
<span class="cm">	 *</span>
<span class="cm">	 * To determine what voltage to use we must read the VS1 and VS2 pin.</span>
<span class="cm">	 * Depending on what socket type is present,</span>
<span class="cm">	 * different combinations mean different things.</span>
<span class="cm">	 *</span>
<span class="cm">	 * Card Key  Socket Key   VS1   VS2   Card         Vcc for CIS parse</span>
<span class="cm">	 *</span>
<span class="cm">	 * 5V        5V, LV*      NC    NC    5V only       5V (if available)</span>
<span class="cm">	 *</span>
<span class="cm">	 * 5V        5V, LV*      GND   NC    5 or 3.3V     as low as possible</span>
<span class="cm">	 *</span>
<span class="cm">	 * 5V        5V, LV*      GND   GND   5, 3.3, x.xV  as low as possible</span>
<span class="cm">	 *</span>
<span class="cm">	 * LV*       5V            -     -    shall not fit into socket</span>
<span class="cm">	 *</span>
<span class="cm">	 * LV*       LV*          GND   NC    3.3V only     3.3V</span>
<span class="cm">	 *</span>
<span class="cm">	 * LV*       LV*          NC    GND   x.xV          x.xV (if avail.)</span>
<span class="cm">	 *</span>
<span class="cm">	 * LV*       LV*          GND   GND   3.3 or x.xV   as low as possible</span>
<span class="cm">	 *</span>
<span class="cm">	 * *LV means Low Voltage</span>
<span class="cm">	 *</span>
<span class="cm">	 *</span>
<span class="cm">	 * That gives us the following table:</span>
<span class="cm">	 *</span>
<span class="cm">	 * Socket    VS1  VS2   Voltage</span>
<span class="cm">	 *</span>
<span class="cm">	 * 5V        NC   NC    5V</span>
<span class="cm">	 * 5V        NC   GND   none (should not be possible)</span>
<span class="cm">	 * 5V        GND  NC    &gt;= 3.3V</span>
<span class="cm">	 * 5V        GND  GND   &gt;= x.xV</span>
<span class="cm">	 *</span>
<span class="cm">	 * LV        NC   NC    5V   (if available)</span>
<span class="cm">	 * LV        NC   GND   x.xV (if available)</span>
<span class="cm">	 * LV        GND  NC    3.3V</span>
<span class="cm">	 * LV        GND  GND   &gt;= x.xV</span>
<span class="cm">	 *</span>
<span class="cm">	 * So, how do I determine if I have a 5V or a LV</span>
<span class="cm">	 * socket on my board?  Look at the socket!</span>
<span class="cm">	 *</span>
<span class="cm">	 *</span>
<span class="cm">	 * Socket with 5V key:</span>
<span class="cm">	 * ++--------------------------------------------+</span>
<span class="cm">	 * ||                                            |</span>
<span class="cm">	 * ||                                           ||</span>
<span class="cm">	 * ||                                           ||</span>
<span class="cm">	 * |                                             |</span>
<span class="cm">	 * +---------------------------------------------+</span>
<span class="cm">	 *</span>
<span class="cm">	 * Socket with LV key:</span>
<span class="cm">	 * ++--------------------------------------------+</span>
<span class="cm">	 * ||                                            |</span>
<span class="cm">	 * |                                            ||</span>
<span class="cm">	 * |                                            ||</span>
<span class="cm">	 * |                                             |</span>
<span class="cm">	 * +---------------------------------------------+</span>
<span class="cm">	 *</span>
<span class="cm">	 *</span>
<span class="cm">	 * With other words - LV only cards does not fit</span>
<span class="cm">	 * into the 5V socket!</span>
<span class="cm">	 */</span>

	<span class="cm">/* read out VS1 and VS2 */</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="p">(</span><span class="n">pipr</span> <span class="o">&amp;</span> <span class="n">M8XX_PCMCIA_VS_MASK</span><span class="p">(</span><span class="n">lsock</span><span class="p">))</span>
	    <span class="o">&gt;&gt;</span> <span class="n">M8XX_PCMCIA_VS_SHIFT</span><span class="p">(</span><span class="n">lsock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">socket_get</span><span class="p">(</span><span class="n">lsock</span><span class="p">)</span> <span class="o">==</span> <span class="n">PCMCIA_SOCKET_KEY_LV</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">reg</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="mi">1</span>:
			<span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="n">SS_3VCARD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* GND, NC - 3.3V only */</span>
		<span class="k">case</span> <span class="mi">2</span>:
			<span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="n">SS_XVCARD</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>	<span class="cm">/* NC. GND - x.xV only */</span>
		<span class="p">};</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;m8xx_pcmcia: GetStatus(%d) = %#2.2x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lsock</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m8xx_set_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="n">socket_state_t</span> <span class="o">*</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lsock</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket_info</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket_info</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">lsock</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">event_table</span> <span class="o">*</span><span class="n">e</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">pcmconf8xx_t</span> <span class="o">*</span><span class="n">pcmcia</span> <span class="o">=</span> <span class="n">socket</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pcmcia</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;m8xx_pcmcia: SetSocket(%d, flags %#3.3x, Vcc %d, Vpp %d, &quot;</span>
		<span class="s">&quot;io_irq %d, csc_mask %#2.2x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lsock</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
		<span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">io_irq</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span><span class="p">);</span>

	<span class="cm">/* First, set voltage - bail out if invalid */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">voltage_set</span><span class="p">(</span><span class="n">lsock</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="cm">/* Take care of reset... */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_RESET</span><span class="p">)</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="n">lsock</span><span class="p">),</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="n">lsock</span><span class="p">))</span> <span class="o">|</span> <span class="n">M8XX_PGCRX_CXRESET</span><span class="p">);</span>	<span class="cm">/* active high */</span>
	<span class="k">else</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="n">lsock</span><span class="p">),</span>
			 <span class="n">in_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="n">lsock</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">M8XX_PGCRX_CXRESET</span><span class="p">);</span>

	<span class="cm">/* ... and output enable. */</span>

	<span class="cm">/* The CxOE signal is connected to a 74541 on the ADS.</span>
<span class="cm">	   I guess most other boards used the ADS as a reference.</span>
<span class="cm">	   I tried to control the CxOE signal with SS_OUTPUT_ENA,</span>
<span class="cm">	   but the reset signal seems connected via the 541.</span>
<span class="cm">	   If the CxOE is left high are some signals tristated and</span>
<span class="cm">	   no pullups are present -&gt; the cards act weird.</span>
<span class="cm">	   So right now the buffers are enabled if the power is on. */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span> <span class="o">||</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span><span class="p">)</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="n">lsock</span><span class="p">),</span> <span class="n">in_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="n">lsock</span><span class="p">))</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">M8XX_PGCRX_CXOE</span><span class="p">);</span>	<span class="cm">/* active low */</span>
	<span class="k">else</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="n">lsock</span><span class="p">),</span>
			 <span class="n">in_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="n">lsock</span><span class="p">))</span> <span class="o">|</span> <span class="n">M8XX_PGCRX_CXOE</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;d better turn off interrupts before</span>
<span class="cm">	 * we mess with the events-table..</span>
<span class="cm">	 */</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Play around with the interrupt mask to be able to</span>
<span class="cm">	 * give the events the generic pcmcia driver wants us to.</span>
<span class="cm">	 */</span>

	<span class="n">e</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">events</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_DETECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">e</span><span class="o">-&gt;</span><span class="n">eventbit</span> <span class="o">=</span> <span class="n">SS_DETECT</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">regbit</span> <span class="o">=</span> <span class="p">(</span><span class="n">M8XX_PCMCIA_CD2</span><span class="p">(</span><span class="n">lsock</span><span class="p">)</span>
				    <span class="o">|</span> <span class="n">M8XX_PCMCIA_CD1</span><span class="p">(</span><span class="n">lsock</span><span class="p">));</span>
		<span class="n">e</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_IOCARD</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * I/O card</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_STSCHG</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">eventbit</span> <span class="o">=</span> <span class="n">SS_STSCHG</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">regbit</span> <span class="o">=</span> <span class="n">M8XX_PCMCIA_BVD1</span><span class="p">(</span><span class="n">lsock</span><span class="p">);</span>
			<span class="n">e</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/*</span>
<span class="cm">		 * If io_irq is non-zero we should enable irq.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">io_irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="n">lsock</span><span class="p">),</span>
				 <span class="n">in_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="n">lsock</span><span class="p">))</span> <span class="o">|</span>
				 <span class="n">mk_int_int_mask</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">hwirq</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span>
			<span class="cm">/*</span>
<span class="cm">			 * Strange thing here:</span>
<span class="cm">			 * The manual does not tell us which interrupt</span>
<span class="cm">			 * the sources generate.</span>
<span class="cm">			 * Anyhow, I found out that RDY_L generates IREQLVL.</span>
<span class="cm">			 *</span>
<span class="cm">			 * We use level triggerd interrupts, and they don&#39;t</span>
<span class="cm">			 * have to be cleared in PSCR in the interrupt handler.</span>
<span class="cm">			 */</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">M8XX_PCMCIA_RDY_L</span><span class="p">(</span><span class="n">lsock</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="n">lsock</span><span class="p">),</span>
				 <span class="n">in_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="n">lsock</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Memory card</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_BATDEAD</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">eventbit</span> <span class="o">=</span> <span class="n">SS_BATDEAD</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">regbit</span> <span class="o">=</span> <span class="n">M8XX_PCMCIA_BVD1</span><span class="p">(</span><span class="n">lsock</span><span class="p">);</span>
			<span class="n">e</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_BATWARN</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">eventbit</span> <span class="o">=</span> <span class="n">SS_BATWARN</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">regbit</span> <span class="o">=</span> <span class="n">M8XX_PCMCIA_BVD2</span><span class="p">(</span><span class="n">lsock</span><span class="p">);</span>
			<span class="n">e</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="cm">/* What should I trigger on - low/high,raise,fall? */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_READY</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">e</span><span class="o">-&gt;</span><span class="n">eventbit</span> <span class="o">=</span> <span class="n">SS_READY</span><span class="p">;</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">e</span><span class="o">-&gt;</span><span class="n">regbit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="c1">//??</span>
			<span class="n">e</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="n">e</span><span class="o">-&gt;</span><span class="n">regbit</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>		<span class="cm">/* terminate list */</span>

	<span class="cm">/*</span>
<span class="cm">	 * Clear the status changed .</span>
<span class="cm">	 * Port A and Port B share the same port.</span>
<span class="cm">	 * Writing ones will clear the bits.</span>
<span class="cm">	 */</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_pscr</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Write the mask.</span>
<span class="cm">	 * Port A and Port B share the same port.</span>
<span class="cm">	 * Need for read-modify-write.</span>
<span class="cm">	 * Ones will enable the interrupt.</span>
<span class="cm">	 */</span>

	<span class="n">reg</span> <span class="o">|=</span>
	    <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span>
		    <span class="n">pcmc_per</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">M8XX_PCMCIA_MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">M8XX_PCMCIA_MASK</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_per</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">events_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="cm">/* copy the struct and modify the copy */</span>

	<span class="n">s</span><span class="o">-&gt;</span><span class="n">state</span> <span class="o">=</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m8xx_set_io_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pccard_io_map</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lsock</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket_info</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">socket_info</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">lsock</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pcmcia_win</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">winnr</span><span class="p">;</span>
	<span class="n">pcmconf8xx_t</span> <span class="o">*</span><span class="n">pcmcia</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pcmcia</span><span class="p">;</span>

<span class="cp">#define M8XX_SIZE (io-&gt;stop - io-&gt;start + 1)</span>
<span class="cp">#define M8XX_BASE (PCMCIA_IO_WIN_BASE + io-&gt;start)</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;m8xx_pcmcia: SetIOMap(%d, %d, %#2.2x, %d ns, &quot;</span>
		<span class="s">&quot;%#4.4llx-%#4.4llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lsock</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
		<span class="n">io</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">&gt;=</span> <span class="n">PCMCIA_IO_WIN_NO</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">&lt;</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">=</span> <span class="n">m8xx_get_graycode</span><span class="p">(</span><span class="n">M8XX_SIZE</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ACTIVE</span><span class="p">)</span> <span class="p">{</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;m8xx_pcmcia: io-&gt;flags &amp; MAP_ACTIVE</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

		<span class="n">winnr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCMCIA_MEM_WIN_NO</span> <span class="o">*</span> <span class="n">PCMCIA_SOCKETS_NO</span><span class="p">)</span>
		    <span class="o">+</span> <span class="p">(</span><span class="n">lsock</span> <span class="o">*</span> <span class="n">PCMCIA_IO_WIN_NO</span><span class="p">)</span> <span class="o">+</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">;</span>

		<span class="cm">/* setup registers */</span>

		<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_pbr0</span><span class="p">;</span>
		<span class="n">w</span> <span class="o">+=</span> <span class="n">winnr</span><span class="p">;</span>

		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">or</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* turn off window first */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">,</span> <span class="n">M8XX_BASE</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">&lt;&lt;=</span> <span class="mi">27</span><span class="p">;</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">M8XX_PCMCIA_POR_IO</span> <span class="o">|</span> <span class="p">(</span><span class="n">lsock</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">);</span>

		<span class="n">reg</span> <span class="o">|=</span> <span class="n">m8xx_get_speed</span><span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">bus_freq</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_WRPROT</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">M8XX_PCMCIA_POR_WRPROT</span><span class="p">;</span>

		<span class="cm">/*if(io-&gt;flags &amp; (MAP_16BIT | MAP_AUTOSZ)) */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_16BIT</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">M8XX_PCMCIA_POR_16BIT</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ACTIVE</span><span class="p">)</span>
			<span class="n">reg</span> <span class="o">|=</span> <span class="n">M8XX_PCMCIA_POR_VALID</span><span class="p">;</span>

		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">or</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;m8xx_pcmcia: Socket %u: Mapped io window %u at &quot;</span>
			<span class="s">&quot;%#8.8x, OR = %#8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lsock</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">or</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* shutdown IO window */</span>
		<span class="n">winnr</span> <span class="o">=</span> <span class="p">(</span><span class="n">PCMCIA_MEM_WIN_NO</span> <span class="o">*</span> <span class="n">PCMCIA_SOCKETS_NO</span><span class="p">)</span>
		    <span class="o">+</span> <span class="p">(</span><span class="n">lsock</span> <span class="o">*</span> <span class="n">PCMCIA_IO_WIN_NO</span><span class="p">)</span> <span class="o">+</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">;</span>

		<span class="cm">/* setup registers */</span>

		<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_pbr0</span><span class="p">;</span>
		<span class="n">w</span> <span class="o">+=</span> <span class="n">winnr</span><span class="p">;</span>

		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">or</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* turn off window */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* turn off base address */</span>

		<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;m8xx_pcmcia: Socket %u: Unmapped io window %u at &quot;</span>
			<span class="s">&quot;%#8.8x, OR = %#8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lsock</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">or</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* copy the struct and modify the copy */</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_win</span><span class="p">[</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">]</span> <span class="o">=</span> <span class="o">*</span><span class="n">io</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">io_win</span><span class="p">[</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">MAP_WRPROT</span> <span class="o">|</span> <span class="n">MAP_16BIT</span> <span class="o">|</span> <span class="n">MAP_ACTIVE</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;m8xx_pcmcia: SetIOMap exit</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m8xx_set_mem_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span>
			    <span class="k">struct</span> <span class="n">pccard_mem_map</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">lsock</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">socket_info</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">slot</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">socket_info</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">lsock</span><span class="p">];</span>
	<span class="k">struct</span> <span class="n">pcmcia_win</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pccard_mem_map</span> <span class="o">*</span><span class="n">old</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">reg</span><span class="p">,</span> <span class="n">winnr</span><span class="p">;</span>
	<span class="n">pcmconf8xx_t</span> <span class="o">*</span><span class="n">pcmcia</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pcmcia</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;m8xx_pcmcia: SetMemMap(%d, %d, %#2.2x, %d ns, &quot;</span>
		<span class="s">&quot;%#5.5llx, %#5.5x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lsock</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">static_start</span><span class="p">,</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">card_start</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">&gt;=</span> <span class="n">PCMCIA_MEM_WIN_NO</span><span class="p">)</span></pre></div></td></tr>


<tr id="section-2"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-2">&#182;</a></div><pre><code>     || ((mem-&gt;s) &gt;= PCMCIA_MEM_WIN_SIZE)
</code></pre></td><td class="code"><div class="highlight"><pre>	    <span class="o">||</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">card_start</span> <span class="o">&gt;=</span> <span class="mh">0x04000000</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">static_start</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">)</span>	<span class="cm">/* 4KByte resolution */</span>
	    <span class="o">||</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">card_start</span> <span class="o">&amp;</span> <span class="mh">0xfff</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="n">reg</span> <span class="o">=</span> <span class="n">m8xx_get_graycode</span><span class="p">(</span><span class="n">PCMCIA_MEM_WIN_SIZE</span><span class="p">))</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;Cannot set size to 0x%08x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">PCMCIA_MEM_WIN_SIZE</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">reg</span> <span class="o">&lt;&lt;=</span> <span class="mi">27</span><span class="p">;</span>

	<span class="n">winnr</span> <span class="o">=</span> <span class="p">(</span><span class="n">lsock</span> <span class="o">*</span> <span class="n">PCMCIA_MEM_WIN_NO</span><span class="p">)</span> <span class="o">+</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">;</span>

	<span class="cm">/* Setup the window in the pcmcia controller */</span>

	<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_pbr0</span><span class="p">;</span>
	<span class="n">w</span> <span class="o">+=</span> <span class="n">winnr</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">|=</span> <span class="n">lsock</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">;</span>

	<span class="n">reg</span> <span class="o">|=</span> <span class="n">m8xx_get_speed</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">bus_freq</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ATTRIB</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">M8XX_PCMCIA_POR_ATTRMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_WRPROT</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">M8XX_PCMCIA_POR_WRPROT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_16BIT</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">M8XX_PCMCIA_POR_16BIT</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ACTIVE</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">M8XX_PCMCIA_POR_VALID</span><span class="p">;</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">or</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;m8xx_pcmcia: Socket %u: Mapped memory window %u at %#8.8x, &quot;</span>
		<span class="s">&quot;OR = %#8.8x.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lsock</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">,</span> <span class="n">w</span><span class="o">-&gt;</span><span class="n">or</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* get the new base address */</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">static_start</span> <span class="o">=</span> <span class="n">PCMCIA_MEM_WIN_BASE</span> <span class="o">+</span>
		    <span class="p">(</span><span class="n">PCMCIA_MEM_WIN_SIZE</span> <span class="o">*</span> <span class="n">winnr</span><span class="p">)</span>
		    <span class="o">+</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">card_start</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;m8xx_pcmcia: SetMemMap(%d, %d, %#2.2x, %d ns, &quot;</span>
		<span class="s">&quot;%#5.5llx, %#5.5x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">lsock</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">static_start</span><span class="p">,</span>
		<span class="n">mem</span><span class="o">-&gt;</span><span class="n">card_start</span><span class="p">);</span>

	<span class="cm">/* copy the struct and modify the copy */</span>

	<span class="n">old</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">mem_win</span><span class="p">[</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">];</span>

	<span class="o">*</span><span class="n">old</span> <span class="o">=</span> <span class="o">*</span><span class="n">mem</span><span class="p">;</span>
	<span class="n">old</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">MAP_ATTRIB</span> <span class="o">|</span> <span class="n">MAP_WRPROT</span> <span class="o">|</span> <span class="n">MAP_16BIT</span> <span class="o">|</span> <span class="n">MAP_ACTIVE</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m8xx_sock_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">pccard_io_map</span> <span class="n">io</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
	<span class="n">pccard_mem_map</span> <span class="n">mem</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span> <span class="p">};</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;m8xx_pcmcia: sock_init(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="p">);</span>

	<span class="n">m8xx_set_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dead_socket</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCMCIA_IO_WIN_NO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io</span><span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">m8xx_set_io_map</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCMCIA_MEM_WIN_NO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mem</span><span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">m8xx_set_mem_map</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m8xx_sock_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">m8xx_set_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dead_socket</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pccard_operations</span> <span class="n">m8xx_services</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">m8xx_sock_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">m8xx_sock_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_status</span> <span class="o">=</span> <span class="n">m8xx_get_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_socket</span> <span class="o">=</span> <span class="n">m8xx_set_socket</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_io_map</span> <span class="o">=</span> <span class="n">m8xx_set_io_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mem_map</span> <span class="o">=</span> <span class="n">m8xx_set_mem_map</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">m8xx_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_win</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">m</span><span class="p">,</span> <span class="n">hwirq</span><span class="p">;</span>
	<span class="n">pcmconf8xx_t</span> <span class="o">*</span><span class="n">pcmcia</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">device_node</span> <span class="o">*</span><span class="n">np</span> <span class="o">=</span> <span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">of_node</span><span class="p">;</span>

	<span class="n">pcmcia_info</span><span class="p">(</span><span class="s">&quot;%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">version</span><span class="p">);</span>

	<span class="n">pcmcia</span> <span class="o">=</span> <span class="n">of_iomap</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcmcia</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pcmcia_schlvl</span> <span class="o">=</span> <span class="n">irq_of_parse_and_map</span><span class="p">(</span><span class="n">np</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">hwirq</span> <span class="o">=</span> <span class="n">irq_map</span><span class="p">[</span><span class="n">pcmcia_schlvl</span><span class="p">].</span><span class="n">hwirq</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pcmcia_schlvl</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">pcmcia</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">m8xx_pgcrx</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_pgcra</span><span class="p">;</span>
	<span class="n">m8xx_pgcrx</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_pgcrb</span><span class="p">;</span>

	<span class="n">pcmcia_info</span><span class="p">(</span><span class="n">PCMCIA_BOARD_MSG</span> <span class="s">&quot; using &quot;</span> <span class="n">PCMCIA_SLOT_MSG</span>
		    <span class="s">&quot; with IRQ %u  (%d). </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">pcmcia_schlvl</span><span class="p">,</span> <span class="n">hwirq</span><span class="p">);</span>

	<span class="cm">/* Configure Status change interrupt */</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">pcmcia_schlvl</span><span class="p">,</span> <span class="n">m8xx_interrupt</span><span class="p">,</span> <span class="n">IRQF_SHARED</span><span class="p">,</span>
			<span class="n">driver_name</span><span class="p">,</span> <span class="n">socket</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pcmcia_error</span><span class="p">(</span><span class="s">&quot;Cannot allocate IRQ %u for SCHLVL!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			     <span class="n">pcmcia_schlvl</span><span class="p">);</span>
		<span class="n">iounmap</span><span class="p">(</span><span class="n">pcmcia</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_pbr0</span><span class="p">;</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_pscr</span><span class="p">,</span> <span class="n">M8XX_PCMCIA_MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">M8XX_PCMCIA_MASK</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
	<span class="n">clrbits32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_per</span><span class="p">,</span> <span class="n">M8XX_PCMCIA_MASK</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="n">M8XX_PCMCIA_MASK</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>

	<span class="cm">/* connect interrupt and disable CxOE */</span>

	<span class="n">out_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
		 <span class="n">M8XX_PGCRX_CXOE</span> <span class="o">|</span> <span class="p">(</span><span class="n">mk_int_int_mask</span><span class="p">(</span><span class="n">hwirq</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>
	<span class="n">out_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
		 <span class="n">M8XX_PGCRX_CXOE</span> <span class="o">|</span> <span class="p">(</span><span class="n">mk_int_int_mask</span><span class="p">(</span><span class="n">hwirq</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">));</span>

	<span class="cm">/* initialize the fixed memory windows */</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCMCIA_SOCKETS_NO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">PCMCIA_MEM_WIN_NO</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">br</span><span class="p">,</span> <span class="n">PCMCIA_MEM_WIN_BASE</span> <span class="o">+</span>
				 <span class="p">(</span><span class="n">PCMCIA_MEM_WIN_SIZE</span>
				  <span class="o">*</span> <span class="p">(</span><span class="n">m</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">PCMCIA_MEM_WIN_NO</span><span class="p">)));</span>

			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">or</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* set to not valid */</span>

			<span class="n">w</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* turn off voltage */</span>
	<span class="n">voltage_set</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">voltage_set</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* Enable external hardware */</span>
	<span class="n">hardware_enable</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
	<span class="n">hardware_enable</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCMCIA_SOCKETS_NO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">slot</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
		<span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span>
		    <span class="n">SS_CAP_PCCARD</span> <span class="o">|</span> <span class="n">SS_CAP_MEM_ALIGN</span> <span class="o">|</span> <span class="n">SS_CAP_STATIC_MAP</span><span class="p">;</span>
		<span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="mh">0x000</span><span class="p">;</span>
		<span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">map_size</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
		<span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">io_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">pci_irq</span> <span class="o">=</span> <span class="n">pcmcia_schlvl</span><span class="p">;</span>
		<span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">m8xx_services</span><span class="p">;</span>
		<span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">resource_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pccard_iodyn_ops</span><span class="p">;</span>
		<span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">cb_dev</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
		<span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">ofdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
		<span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pcmcia</span> <span class="o">=</span> <span class="n">pcmcia</span><span class="p">;</span>
		<span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">bus_freq</span> <span class="o">=</span> <span class="n">ppc_proc_freq</span><span class="p">;</span>
		<span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">hwirq</span> <span class="o">=</span> <span class="n">hwirq</span><span class="p">;</span>

	<span class="p">}</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCMCIA_SOCKETS_NO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">pcmcia_register_socket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">pcmcia_error</span><span class="p">(</span><span class="s">&quot;Socket register failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">m8xx_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">ofdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">m</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_win</span> <span class="o">*</span><span class="n">w</span><span class="p">;</span>
	<span class="n">pcmconf8xx_t</span> <span class="o">*</span><span class="n">pcmcia</span> <span class="o">=</span> <span class="n">socket</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">pcmcia</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCMCIA_SOCKETS_NO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_pbr0</span><span class="p">;</span>

		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_pscr</span><span class="p">,</span> <span class="n">M8XX_PCMCIA_MASK</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_per</span><span class="p">,</span>
			 <span class="n">in_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia</span><span class="o">-&gt;</span><span class="n">pcmc_per</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">M8XX_PCMCIA_MASK</span><span class="p">(</span><span class="n">i</span><span class="p">));</span>

		<span class="cm">/* turn off interrupt and disable CxOE */</span>
		<span class="n">out_be32</span><span class="p">(</span><span class="n">M8XX_PGCRX</span><span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="n">M8XX_PGCRX_CXOE</span><span class="p">);</span>

		<span class="cm">/* turn off memory windows */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">m</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">m</span> <span class="o">&lt;</span> <span class="n">PCMCIA_MEM_WIN_NO</span><span class="p">;</span> <span class="n">m</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">out_be32</span><span class="p">(</span><span class="o">&amp;</span><span class="n">w</span><span class="o">-&gt;</span><span class="n">or</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>	<span class="cm">/* set to not valid */</span>
			<span class="n">w</span><span class="o">++</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* turn off voltage */</span>
		<span class="n">voltage_set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="cm">/* disable external hardware */</span>
		<span class="n">hardware_disable</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCMCIA_SOCKETS_NO</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pcmcia_unregister_socket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">pcmcia</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">pcmcia_schlvl</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">const</span> <span class="k">struct</span> <span class="n">of_device_id</span> <span class="n">m8xx_pcmcia_match</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span>
	 <span class="p">.</span><span class="n">type</span> <span class="o">=</span> <span class="s">&quot;pcmcia&quot;</span><span class="p">,</span>
	 <span class="p">.</span><span class="n">compatible</span> <span class="o">=</span> <span class="s">&quot;fsl,pq-pcmcia&quot;</span><span class="p">,</span>
	 <span class="p">},</span>
	<span class="p">{},</span>
<span class="p">};</span>

<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">of</span><span class="p">,</span> <span class="n">m8xx_pcmcia_match</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">m8xx_pcmcia_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">driver_name</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
		<span class="p">.</span><span class="n">of_match_table</span> <span class="o">=</span> <span class="n">m8xx_pcmcia_match</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">m8xx_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">m8xx_remove</span><span class="p">,</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">m8xx_pcmcia_driver</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
