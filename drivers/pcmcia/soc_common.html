<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pcmcia › soc_common.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>soc_common.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * linux/drivers/pcmcia/soc_common.h</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (C) 2000 John G Dorsey &lt;john+@cs.cmu.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file contains definitions for the PCMCIA support code common to</span>
<span class="cm"> * integrated SOCs like the SA-11x0 and PXA2xx microprocessors.</span>
<span class="cm"> */</span>
<span class="cp">#ifndef _ASM_ARCH_PCMCIA</span>
<span class="cp">#define _ASM_ARCH_PCMCIA</span>

<span class="cm">/* include the world */</span>
<span class="cp">#include &lt;linux/clk.h&gt;</span>
<span class="cp">#include &lt;linux/cpufreq.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ss.h&gt;</span>
<span class="cp">#include &lt;pcmcia/cistpl.h&gt;</span>


<span class="k">struct</span> <span class="n">device</span><span class="p">;</span>
<span class="k">struct</span> <span class="n">pcmcia_low_level</span><span class="p">;</span>

<span class="cm">/*</span>
<span class="cm"> * This structure encapsulates per-socket state which we might need to</span>
<span class="cm"> * use when responding to a Card Services query of some kind.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_socket</span>	<span class="n">socket</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Info from low level handler</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">nr</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span>		<span class="o">*</span><span class="n">clk</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Core PCMCIA state</span>
<span class="cm">	 */</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pcmcia_low_level</span> <span class="o">*</span><span class="n">ops</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">status</span><span class="p">;</span>
	<span class="n">socket_state_t</span>		<span class="n">cs_state</span><span class="p">;</span>

	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">spd_io</span><span class="p">[</span><span class="n">MAX_IO_WIN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">spd_mem</span><span class="p">[</span><span class="n">MAX_WIN</span><span class="p">];</span>
	<span class="kt">unsigned</span> <span class="kt">short</span>		<span class="n">spd_attr</span><span class="p">[</span><span class="n">MAX_WIN</span><span class="p">];</span>

	<span class="k">struct</span> <span class="n">resource</span>		<span class="n">res_skt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="n">res_io</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="n">res_mem</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span>		<span class="n">res_attr</span><span class="p">;</span>
	<span class="kt">void</span> <span class="n">__iomem</span>		<span class="o">*</span><span class="n">virt_io</span><span class="p">;</span>

	<span class="k">struct</span> <span class="p">{</span>
		<span class="kt">int</span>		<span class="n">gpio</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">irq</span><span class="p">;</span>
		<span class="k">const</span> <span class="kt">char</span>	<span class="o">*</span><span class="n">name</span><span class="p">;</span>
	<span class="p">}</span> <span class="n">stat</span><span class="p">[</span><span class="mi">4</span><span class="p">];</span>
<span class="cp">#define SOC_STAT_CD		0	</span><span class="cm">/* Card detect */</span><span class="cp"></span>
<span class="cp">#define SOC_STAT_BVD1		1	</span><span class="cm">/* BATDEAD / IOSTSCHG */</span><span class="cp"></span>
<span class="cp">#define SOC_STAT_BVD2		2	</span><span class="cm">/* BATWARN / IOSPKR */</span><span class="cp"></span>
<span class="cp">#define SOC_STAT_RDY		3	</span><span class="cm">/* Ready / Interrupt */</span><span class="cp"></span>

	<span class="kt">unsigned</span> <span class="kt">int</span>		<span class="n">irq_state</span><span class="p">;</span>

	<span class="k">struct</span> <span class="n">timer_list</span>	<span class="n">poll_timer</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">list_head</span>	<span class="n">node</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">skt_dev_info</span> <span class="p">{</span>
	<span class="kt">int</span> <span class="n">nskt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">clk</span> <span class="o">*</span><span class="n">clk</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="n">skt</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pcmcia_state</span> <span class="p">{</span>
  <span class="kt">unsigned</span> <span class="n">detect</span><span class="o">:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nl">ready:</span> <span class="mi">1</span><span class="p">,</span>
             <span class="nl">bvd1:</span> <span class="mi">1</span><span class="p">,</span>
             <span class="nl">bvd2:</span> <span class="mi">1</span><span class="p">,</span>
           <span class="nl">wrprot:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nl">vs_3v:</span> <span class="mi">1</span><span class="p">,</span>
            <span class="nl">vs_Xv:</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">struct</span> <span class="n">pcmcia_low_level</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">module</span> <span class="o">*</span><span class="n">owner</span><span class="p">;</span>

	<span class="cm">/* first socket in system */</span>
	<span class="kt">int</span> <span class="n">first</span><span class="p">;</span>
	<span class="cm">/* nr of sockets */</span>
	<span class="kt">int</span> <span class="n">nr</span><span class="p">;</span>

	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">hw_init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">hw_shutdown</span><span class="p">)(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="p">);</span>

	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">socket_state</span><span class="p">)(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pcmcia_state</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">configure_socket</span><span class="p">)(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="p">,</span> <span class="k">const</span> <span class="n">socket_state_t</span> <span class="o">*</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Enable card status IRQs on (re-)initialisation.  This can</span>
<span class="cm">	 * be called at initialisation, power management event, or</span>
<span class="cm">	 * pcmcia event.</span>
<span class="cm">	 */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">socket_init</span><span class="p">)(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Disable card status IRQs and PCMCIA bus on suspend.</span>
<span class="cm">	 */</span>
	<span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">socket_suspend</span><span class="p">)(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Hardware specific timing routines.</span>
<span class="cm">	 * If provided, the get_timing routine overrides the SOC default.</span>
<span class="cm">	 */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">get_timing</span><span class="p">)(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">set_timing</span><span class="p">)(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">show_timing</span><span class="p">)(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
	<span class="cm">/*</span>
<span class="cm">	 * CPUFREQ support.</span>
<span class="cm">	 */</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">frequency_change</span><span class="p">)(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span><span class="p">,</span> <span class="k">struct</span> <span class="n">cpufreq_freqs</span> <span class="o">*</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">soc_pcmcia_timing</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">io</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">mem</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">attr</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">soc_common_pcmcia_get_timing</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="p">,</span> <span class="k">struct</span> <span class="n">soc_pcmcia_timing</span> <span class="o">*</span><span class="p">);</span>

<span class="kt">void</span> <span class="n">soc_pcmcia_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pcmcia_low_level</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>
<span class="kt">void</span> <span class="n">soc_pcmcia_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">);</span>
<span class="kt">int</span> <span class="n">soc_pcmcia_add_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">);</span>


<span class="cp">#ifdef CONFIG_PCMCIA_DEBUG</span>

<span class="k">extern</span> <span class="kt">void</span> <span class="n">soc_pcmcia_debug</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">func</span><span class="p">,</span>
			     <span class="kt">int</span> <span class="n">lvl</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">fmt</span><span class="p">,</span> <span class="p">...);</span>

<span class="cp">#define debug(skt, lvl, fmt, arg...) \</span>
<span class="cp">	soc_pcmcia_debug(skt, __func__, lvl, fmt , ## arg)</span>

<span class="cp">#else</span>
<span class="cp">#define debug(skt, lvl, fmt, arg...) do { } while (0)</span>
<span class="cp">#endif</span>


<span class="cm">/*</span>
<span class="cm"> * The PC Card Standard, Release 7, section 4.13.4, says that twIORD</span>
<span class="cm"> * has a minimum value of 165ns. Section 4.13.5 says that twIOWR has</span>
<span class="cm"> * a minimum value of 165ns, as well. Section 4.7.2 (describing</span>
<span class="cm"> * common and attribute memory write timing) says that twWE has a</span>
<span class="cm"> * minimum value of 150ns for a 250ns cycle time (for 5V operation;</span>
<span class="cm"> * see section 4.7.4), or 300ns for a 600ns cycle time (for 3.3V</span>
<span class="cm"> * operation, also section 4.7.4). Section 4.7.3 says that taOE</span>
<span class="cm"> * has a maximum value of 150ns for a 300ns cycle time (for 5V</span>
<span class="cm"> * operation), or 300ns for a 600ns cycle time (for 3.3V operation).</span>
<span class="cm"> *</span>
<span class="cm"> * When configuring memory maps, Card Services appears to adopt the policy</span>
<span class="cm"> * that a memory access time of &quot;0&quot; means &quot;use the default.&quot; The default</span>
<span class="cm"> * PCMCIA I/O command width time is 165ns. The default PCMCIA 5V attribute</span>
<span class="cm"> * and memory command width time is 150ns; the PCMCIA 3.3V attribute and</span>
<span class="cm"> * memory command width time is 300ns.</span>
<span class="cm"> */</span>
<span class="cp">#define SOC_PCMCIA_IO_ACCESS		(165)</span>
<span class="cp">#define SOC_PCMCIA_5V_MEM_ACCESS	(150)</span>
<span class="cp">#define SOC_PCMCIA_3V_MEM_ACCESS	(300)</span>
<span class="cp">#define SOC_PCMCIA_ATTR_MEM_ACCESS	(300)</span>

<span class="cm">/*</span>
<span class="cm"> * The socket driver actually works nicely in interrupt-driven form,</span>
<span class="cm"> * so the (relatively infrequent) polling is &quot;just to be sure.&quot;</span>
<span class="cm"> */</span>
<span class="cp">#define SOC_PCMCIA_POLL_PERIOD    (2*HZ)</span>


<span class="cm">/* I/O pins replacing memory pins</span>
<span class="cm"> * (PCMCIA System Architecture, 2nd ed., by Don Anderson, p.75)</span>
<span class="cm"> *</span>
<span class="cm"> * These signals change meaning when going from memory-only to</span>
<span class="cm"> * memory-or-I/O interface:</span>
<span class="cm"> */</span>
<span class="cp">#define iostschg bvd1</span>
<span class="cp">#define iospkr   bvd2</span>

<span class="cp">#endif</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
an class="o">==</span> <span class="n">SOC_STAT_RDY</span><span class="p">)</span>
				<span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">pci_irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span> <span class="o">=</span> <span class="n">irq</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">,</span>
					  <span class="n">soc_common_pcmcia_interrupt</span><span class="p">,</span>
					  <span class="n">IRQF_TRIGGER_NONE</span><span class="p">,</span>
					  <span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">,</span> <span class="n">skt</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span><span class="p">))</span>
					<span class="n">gpio_free</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span><span class="p">);</span>
				<span class="n">__soc_pcmcia_hw_shutdown</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
				<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_pcmcia_hw_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_RISING</span><span class="p">);</span>
			<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_BOTH</span><span class="p">);</span>
		<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_pcmcia_hw_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">)</span>
			<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">irq</span><span class="p">,</span> <span class="n">IRQ_TYPE_NONE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="nf">soc_common_pcmcia_skt_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_state</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">stat</span><span class="p">;</span>

	<span class="n">memset</span><span class="p">(</span><span class="o">&amp;</span><span class="n">state</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_state</span><span class="p">));</span>

	<span class="cm">/* Make battery voltage state report &#39;good&#39; */</span>
	<span class="n">state</span><span class="p">.</span><span class="n">bvd1</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">state</span><span class="p">.</span><span class="n">bvd2</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* CD is active low by default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">SOC_STAT_CD</span><span class="p">].</span><span class="n">gpio</span><span class="p">))</span>
		<span class="n">state</span><span class="p">.</span><span class="n">detect</span> <span class="o">=</span> <span class="o">!</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">SOC_STAT_CD</span><span class="p">].</span><span class="n">gpio</span><span class="p">);</span>

	<span class="cm">/* RDY and BVD are active high by default */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">SOC_STAT_RDY</span><span class="p">].</span><span class="n">gpio</span><span class="p">))</span>
		<span class="n">state</span><span class="p">.</span><span class="n">ready</span> <span class="o">=</span> <span class="o">!!</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">SOC_STAT_RDY</span><span class="p">].</span><span class="n">gpio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">SOC_STAT_BVD1</span><span class="p">].</span><span class="n">gpio</span><span class="p">))</span>
		<span class="n">state</span><span class="p">.</span><span class="n">bvd1</span> <span class="o">=</span> <span class="o">!!</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">SOC_STAT_BVD1</span><span class="p">].</span><span class="n">gpio</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">gpio_is_valid</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">SOC_STAT_BVD2</span><span class="p">].</span><span class="n">gpio</span><span class="p">))</span>
		<span class="n">state</span><span class="p">.</span><span class="n">bvd2</span> <span class="o">=</span> <span class="o">!!</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">SOC_STAT_BVD2</span><span class="p">].</span><span class="n">gpio</span><span class="p">);</span>

	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">socket_state</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>

	<span class="n">stat</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">detect</span>  <span class="o">?</span> <span class="n">SS_DETECT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stat</span> <span class="o">|=</span> <span class="n">state</span><span class="p">.</span><span class="n">ready</span>  <span class="o">?</span> <span class="n">SS_READY</span>  <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stat</span> <span class="o">|=</span> <span class="n">state</span><span class="p">.</span><span class="n">wrprot</span> <span class="o">?</span> <span class="n">SS_WRPROT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stat</span> <span class="o">|=</span> <span class="n">state</span><span class="p">.</span><span class="n">vs_3v</span>  <span class="o">?</span> <span class="n">SS_3VCARD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">stat</span> <span class="o">|=</span> <span class="n">state</span><span class="p">.</span><span class="n">vs_Xv</span>  <span class="o">?</span> <span class="n">SS_XVCARD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* The power status of individual sockets is not available</span>
<span class="cm">	 * explicitly from the hardware, so we just remember the state</span>
<span class="cm">	 * and regurgitate it upon request:</span>
<span class="cm">	 */</span>
	<span class="n">stat</span> <span class="o">|=</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">cs_state</span><span class="p">.</span><span class="n">Vcc</span> <span class="o">?</span> <span class="n">SS_POWERON</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">cs_state</span><span class="p">.</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_IOCARD</span><span class="p">)</span>
		<span class="n">stat</span> <span class="o">|=</span> <span class="n">state</span><span class="p">.</span><span class="n">bvd1</span> <span class="o">?</span> <span class="n">SS_STSCHG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">bvd1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">stat</span> <span class="o">|=</span> <span class="n">SS_BATDEAD</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">bvd2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">stat</span> <span class="o">|=</span> <span class="n">SS_BATWARN</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">stat</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * soc_common_pcmcia_config_skt</span>
<span class="cm"> * ^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="cm"> *</span>
<span class="cm"> * Convert PCMCIA socket state to our socket configure structure.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_common_pcmcia_config_skt</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">,</span> <span class="n">socket_state_t</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">configure_socket</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * This really needs a better solution.  The IRQ</span>
<span class="cm">		 * may or may not be claimed by the driver.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">irq_state</span> <span class="o">!=</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">io_irq</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skt</span><span class="o">-&gt;</span><span class="n">irq_state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">pci_irq</span><span class="p">,</span>
					 <span class="n">IRQ_TYPE_EDGE_FALLING</span><span class="p">);</span>
		<span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">irq_state</span> <span class="o">==</span> <span class="mi">1</span> <span class="o">&amp;&amp;</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">io_irq</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">skt</span><span class="o">-&gt;</span><span class="n">irq_state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">pci_irq</span><span class="p">,</span> <span class="n">IRQ_TYPE_NONE</span><span class="p">);</span>
		<span class="p">}</span>

		<span class="n">skt</span><span class="o">-&gt;</span><span class="n">cs_state</span> <span class="o">=</span> <span class="o">*</span><span class="n">state</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;soc_common_pcmcia: unable to configure &quot;</span>
		       <span class="s">&quot;socket %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* soc_common_pcmcia_sock_init()</span>
<span class="cm"> * ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="cm"> *</span>
<span class="cm"> * (Re-)Initialise the socket, turning on status interrupts</span>
<span class="cm"> * and PCMCIA bus.  This must wait for power to stabilise</span>
<span class="cm"> * so that the card status signals report correctly.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_common_pcmcia_sock_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span> <span class="o">=</span> <span class="n">to_soc_pcmcia_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>

	<span class="n">debug</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;initializing socket</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">socket_init</span><span class="p">)</span>
		<span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">socket_init</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>
	<span class="n">soc_pcmcia_hw_enable</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * soc_common_pcmcia_suspend()</span>
<span class="cm"> * ^^^^^^^^^^^^^^^^^^^^^^^^^^^</span>
<span class="cm"> *</span>
<span class="cm"> * Remove power on the socket, disable IRQs from the card.</span>
<span class="cm"> * Turn off status interrupts, and disable the PCMCIA bus.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_common_pcmcia_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span> <span class="o">=</span> <span class="n">to_soc_pcmcia_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>

	<span class="n">debug</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;suspending socket</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">soc_pcmcia_hw_disable</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">socket_suspend</span><span class="p">)</span>
		<span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">socket_suspend</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">status_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_common_check_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">events</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;entering PCMCIA monitoring thread</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">do</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

		<span class="n">status</span> <span class="o">=</span> <span class="n">soc_common_pcmcia_skt_state</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>

		<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="n">status</span> <span class="o">^</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">cs_state</span><span class="p">.</span><span class="n">csc_mask</span><span class="p">;</span>
		<span class="n">skt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
		<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">status_lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

		<span class="n">debug</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;events: %s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">events</span> <span class="o">==</span> <span class="mi">0</span>         <span class="o">?</span> <span class="s">&quot;&lt;NONE&gt;&quot;</span>   <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">events</span> <span class="o">&amp;</span> <span class="n">SS_DETECT</span>  <span class="o">?</span> <span class="s">&quot;DETECT &quot;</span>  <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">events</span> <span class="o">&amp;</span> <span class="n">SS_READY</span>   <span class="o">?</span> <span class="s">&quot;READY &quot;</span>   <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">events</span> <span class="o">&amp;</span> <span class="n">SS_BATDEAD</span> <span class="o">?</span> <span class="s">&quot;BATDEAD &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">events</span> <span class="o">&amp;</span> <span class="n">SS_BATWARN</span> <span class="o">?</span> <span class="s">&quot;BATWARN &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">events</span> <span class="o">&amp;</span> <span class="n">SS_STSCHG</span>  <span class="o">?</span> <span class="s">&quot;STSCHG &quot;</span>  <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">)</span>
			<span class="n">pcmcia_parse_events</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">events</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* Let&#39;s poll for events in addition to IRQs since IRQ only is unreliable... */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_common_pcmcia_poll_event</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">dummy</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="p">)</span><span class="n">dummy</span><span class="p">;</span>
	<span class="n">debug</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="s">&quot;polling for events</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">poll_timer</span><span class="p">,</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SOC_PCMCIA_POLL_PERIOD</span><span class="p">);</span>

	<span class="n">soc_common_check_status</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Service routine for socket driver interrupts (requested by the</span>
<span class="cm"> * low-level PCMCIA init() operation via soc_common_pcmcia_thread()).</span>
<span class="cm"> * The actual interrupt-servicing work is performed by</span>
<span class="cm"> * soc_common_pcmcia_thread(), largely because the Card Services event-</span>
<span class="cm"> * handling code performs scheduling operations which cannot be</span>
<span class="cm"> * executed from within an interrupt context.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">soc_common_pcmcia_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="s">&quot;servicing IRQ %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

	<span class="n">soc_common_check_status</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> *  Implements the get_status() operation for the in-kernel PCMCIA</span>
<span class="cm"> * service (formerly SS_GetStatus in Card Services). Essentially just</span>
<span class="cm"> * fills in bits in `status&#39; according to internal driver state or</span>
<span class="cm"> * the value of the voltage detect chipselect register.</span>
<span class="cm"> *</span>
<span class="cm"> * As a debugging note, during card startup, the PCMCIA core issues</span>
<span class="cm"> * three set_socket() commands in a row the first with RESET deasserted,</span>
<span class="cm"> * the second with RESET asserted, and the last with RESET deasserted</span>
<span class="cm"> * again. Following the third set_socket(), a get_status() command will</span>
<span class="cm"> * be issued. The kernel is looking for the SS_READY flag (see</span>
<span class="cm"> * setup_socket(), reset_socket(), and unreset_socket() in cs.c).</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">soc_common_pcmcia_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span> <span class="o">=</span> <span class="n">to_soc_pcmcia_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>

	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">soc_common_pcmcia_skt_state</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>
	<span class="o">*</span><span class="n">status</span> <span class="o">=</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Implements the set_socket() operation for the in-kernel PCMCIA</span>
<span class="cm"> * service (formerly SS_SetSocket in Card Services). We more or</span>
<span class="cm"> * less punt all of this work and let the kernel handle the details</span>
<span class="cm"> * of power configuration, reset, &amp;c. We also record the value of</span>
<span class="cm"> * `state&#39; in order to regurgitate it to the PCMCIA core later.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_common_pcmcia_set_socket</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="n">socket_state_t</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span> <span class="o">=</span> <span class="n">to_soc_pcmcia_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>

	<span class="n">debug</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;mask: %s%s%s%s%s%s flags: %s%s%s%s%s%s Vcc %d Vpp %d irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="o">?</span> <span class="s">&quot;&lt;NONE&gt; &quot;</span> <span class="o">:</span>	<span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_DETECT</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;DETECT &quot;</span> <span class="o">:</span>	<span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_READY</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;READY &quot;</span> <span class="o">:</span>	<span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_BATDEAD</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;BATDEAD &quot;</span> <span class="o">:</span>	<span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_BATWARN</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;BATWARN &quot;</span> <span class="o">:</span>	<span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_STSCHG</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;STSCHG &quot;</span> <span class="o">:</span>	<span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="o">?</span> <span class="s">&quot;&lt;NONE&gt; &quot;</span> <span class="o">:</span>	<span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_PWR_AUTO</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;PWR_AUTO &quot;</span> <span class="o">:</span>	<span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_IOCARD</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;IOCARD &quot;</span> <span class="o">:</span>	<span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_RESET</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;RESET &quot;</span> <span class="o">:</span>	<span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_SPKR_ENA</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;SPKR_ENA &quot;</span> <span class="o">:</span>	<span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_OUTPUT_ENA</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;OUTPUT_ENA &quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
			<span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">io_irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">soc_common_pcmcia_config_skt</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Implements the set_io_map() operation for the in-kernel PCMCIA</span>
<span class="cm"> * service (formerly SS_SetIOMap in Card Services). We configure</span>
<span class="cm"> * the map speed as requested, but override the address ranges</span>
<span class="cm"> * supplied by Card Services.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, -1 on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_common_pcmcia_set_io_map</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pccard_io_map</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span> <span class="o">=</span> <span class="n">to_soc_pcmcia_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;map %u  speed %u start 0x%08llx stop 0x%08llx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
		<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
	<span class="n">debug</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;flags: %s%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="o">?</span> <span class="s">&quot;&lt;NONE&gt;&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ACTIVE</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;ACTIVE &quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_16BIT</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;16BIT &quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_AUTOSZ</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;AUTOSZ &quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_0WS</span><span class="p">)</span>		<span class="o">?</span> <span class="s">&quot;0WS &quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_WRPROT</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;WRPROT &quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_USE_WAIT</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;USE_WAIT &quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_PREFETCH</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;PREFETCH &quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">&gt;=</span> <span class="n">MAX_IO_WIN</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;%s(): map (%d) out of range</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">,</span>
		       <span class="n">map</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="n">SOC_PCMCIA_IO_ACCESS</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">spd_io</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">]</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_timing</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">-=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">+=</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">io_offset</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">io_offset</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Implements the set_mem_map() operation for the in-kernel PCMCIA</span>
<span class="cm"> * service (formerly SS_SetMemMap in Card Services). We configure</span>
<span class="cm"> * the map speed as requested, but override the address ranges</span>
<span class="cm"> * supplied by Card Services.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: 0 on success, -ERRNO on error</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_common_pcmcia_set_mem_map</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pccard_mem_map</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span> <span class="o">=</span> <span class="n">to_soc_pcmcia_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">res</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">speed</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">;</span>

	<span class="n">debug</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;map %u speed %u card_start %08x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">card_start</span><span class="p">);</span>
	<span class="n">debug</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;flags: %s%s%s%s%s%s%s%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>		<span class="o">?</span> <span class="s">&quot;&lt;NONE&gt;&quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ACTIVE</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;ACTIVE &quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_16BIT</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;16BIT &quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_AUTOSZ</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;AUTOSZ &quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_0WS</span><span class="p">)</span>		<span class="o">?</span> <span class="s">&quot;0WS &quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_WRPROT</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;WRPROT &quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ATTRIB</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;ATTRIB &quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">,</span>
		<span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_USE_WAIT</span><span class="p">)</span>	<span class="o">?</span> <span class="s">&quot;USE_WAIT &quot;</span>	<span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">map</span> <span class="o">&gt;=</span> <span class="n">MAX_WIN</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">speed</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">speed</span> <span class="o">=</span> <span class="mi">300</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">speed</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ATTRIB</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_attr</span><span class="p">;</span>
		<span class="n">skt</span><span class="o">-&gt;</span><span class="n">spd_attr</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">]</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
		<span class="n">skt</span><span class="o">-&gt;</span><span class="n">spd_mem</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_mem</span><span class="p">;</span>
		<span class="n">skt</span><span class="o">-&gt;</span><span class="n">spd_attr</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">skt</span><span class="o">-&gt;</span><span class="n">spd_mem</span><span class="p">[</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">]</span> <span class="o">=</span> <span class="n">speed</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_timing</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">static_start</span> <span class="o">=</span> <span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">card_start</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">struct</span> <span class="n">bittbl</span> <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">mask</span><span class="p">;</span>
	<span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bittbl</span> <span class="n">status_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">SS_WRPROT</span><span class="p">,</span>		<span class="s">&quot;SS_WRPROT&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SS_BATDEAD</span><span class="p">,</span>		<span class="s">&quot;SS_BATDEAD&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SS_BATWARN</span><span class="p">,</span>		<span class="s">&quot;SS_BATWARN&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SS_READY</span><span class="p">,</span>		<span class="s">&quot;SS_READY&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SS_DETECT</span><span class="p">,</span>		<span class="s">&quot;SS_DETECT&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SS_POWERON</span><span class="p">,</span>		<span class="s">&quot;SS_POWERON&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SS_STSCHG</span><span class="p">,</span>		<span class="s">&quot;SS_STSCHG&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SS_3VCARD</span><span class="p">,</span>		<span class="s">&quot;SS_3VCARD&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SS_XVCARD</span><span class="p">,</span>		<span class="s">&quot;SS_XVCARD&quot;</span>	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">bittbl</span> <span class="n">conf_bits</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> <span class="n">SS_PWR_AUTO</span><span class="p">,</span>		<span class="s">&quot;SS_PWR_AUTO&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SS_IOCARD</span><span class="p">,</span>		<span class="s">&quot;SS_IOCARD&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SS_RESET</span><span class="p">,</span>		<span class="s">&quot;SS_RESET&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SS_DMA_MODE</span><span class="p">,</span>		<span class="s">&quot;SS_DMA_MODE&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SS_SPKR_ENA</span><span class="p">,</span>		<span class="s">&quot;SS_SPKR_ENA&quot;</span>	<span class="p">},</span>
	<span class="p">{</span> <span class="n">SS_OUTPUT_ENA</span><span class="p">,</span>	<span class="s">&quot;SS_OUTPUT_ENA&quot;</span>	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">dump_bits</span><span class="p">(</span><span class="kt">char</span> <span class="o">**</span><span class="n">p</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">prefix</span><span class="p">,</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">val</span><span class="p">,</span> <span class="k">struct</span> <span class="n">bittbl</span> <span class="o">*</span><span class="n">bits</span><span class="p">,</span> <span class="kt">int</span> <span class="n">sz</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">b</span> <span class="o">=</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">b</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot;%-9s:&quot;</span><span class="p">,</span> <span class="n">prefix</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sz</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mask</span><span class="p">)</span>
			<span class="n">b</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="s">&quot; %s&quot;</span><span class="p">,</span> <span class="n">bits</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
	<span class="o">*</span><span class="n">b</span><span class="o">++</span> <span class="o">=</span> <span class="sc">&#39;\n&#39;</span><span class="p">;</span>
	<span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">b</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * Implements the /sys/class/pcmcia_socket/??/status file.</span>
<span class="cm"> *</span>
<span class="cm"> * Returns: the number of characters added to the buffer</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">show_status</span><span class="p">(</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span> <span class="o">=</span>
		<span class="n">container_of</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">soc_pcmcia_socket</span><span class="p">,</span> <span class="n">socket</span><span class="p">.</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;slot     : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>

	<span class="n">dump_bits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;status&quot;</span><span class="p">,</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">status</span><span class="p">,</span>
		  <span class="n">status_bits</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">status_bits</span><span class="p">));</span>
	<span class="n">dump_bits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;csc_mask&quot;</span><span class="p">,</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">cs_state</span><span class="p">.</span><span class="n">csc_mask</span><span class="p">,</span>
		  <span class="n">status_bits</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">status_bits</span><span class="p">));</span>
	<span class="n">dump_bits</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;cs_flags&quot;</span><span class="p">,</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">cs_state</span><span class="p">.</span><span class="n">flags</span><span class="p">,</span>
		  <span class="n">conf_bits</span><span class="p">,</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">conf_bits</span><span class="p">));</span>

	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Vcc      : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">cs_state</span><span class="p">.</span><span class="n">Vcc</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;Vpp      : %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">cs_state</span><span class="p">.</span><span class="n">Vpp</span><span class="p">);</span>
	<span class="n">p</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s">&quot;IRQ      : %d (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">cs_state</span><span class="p">.</span><span class="n">io_irq</span><span class="p">,</span>
		<span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">pci_irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">show_timing</span><span class="p">)</span>
		<span class="n">p</span> <span class="o">+=</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">show_timing</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="n">p</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">p</span><span class="o">-</span><span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DEVICE_ATTR</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">S_IRUGO</span><span class="p">,</span> <span class="n">show_status</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pccard_operations</span> <span class="n">soc_common_pcmcia_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>			<span class="o">=</span> <span class="n">soc_common_pcmcia_sock_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>		<span class="o">=</span> <span class="n">soc_common_pcmcia_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_status</span>		<span class="o">=</span> <span class="n">soc_common_pcmcia_get_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_socket</span>		<span class="o">=</span> <span class="n">soc_common_pcmcia_set_socket</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_io_map</span>		<span class="o">=</span> <span class="n">soc_common_pcmcia_set_io_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mem_map</span>		<span class="o">=</span> <span class="n">soc_common_pcmcia_set_mem_map</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="n">LIST_HEAD</span><span class="p">(</span><span class="n">soc_pcmcia_sockets</span><span class="p">);</span>
<span class="k">static</span> <span class="n">DEFINE_MUTEX</span><span class="p">(</span><span class="n">soc_pcmcia_sockets_lock</span><span class="p">);</span>

<span class="cp">#ifdef CONFIG_CPU_FREQ</span>
<span class="k">static</span> <span class="kt">int</span>
<span class="nf">soc_pcmcia_notifier</span><span class="p">(</span><span class="k">struct</span> <span class="n">notifier_block</span> <span class="o">*</span><span class="n">nb</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">val</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">cpufreq_freqs</span> <span class="o">*</span><span class="n">freqs</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soc_pcmcia_sockets_lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">soc_pcmcia_sockets</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">frequency_change</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">+=</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">frequency_change</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="n">val</span><span class="p">,</span> <span class="n">freqs</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soc_pcmcia_sockets_lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">notifier_block</span> <span class="n">soc_pcmcia_notifier_block</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">notifier_call</span>	<span class="o">=</span> <span class="n">soc_pcmcia_notifier</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">soc_pcmcia_cpufreq_register</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">cpufreq_register_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soc_pcmcia_notifier_block</span><span class="p">,</span>
					<span class="n">CPUFREQ_TRANSITION_NOTIFIER</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;Unable to register CPU frequency change &quot;</span>
				<span class="s">&quot;notifier for PCMCIA (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">fs_initcall</span><span class="p">(</span><span class="n">soc_pcmcia_cpufreq_register</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">soc_pcmcia_cpufreq_unregister</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cpufreq_unregister_notifier</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soc_pcmcia_notifier_block</span><span class="p">,</span>
		<span class="n">CPUFREQ_TRANSITION_NOTIFIER</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">soc_pcmcia_cpufreq_unregister</span><span class="p">);</span>

<span class="cp">#endif</span>

<span class="kt">void</span> <span class="nf">soc_pcmcia_init_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">,</span>
	<span class="k">struct</span> <span class="n">pcmcia_low_level</span> <span class="o">*</span><span class="n">ops</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops</span> <span class="o">=</span> <span class="n">ops</span><span class="p">;</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">ops</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">pci_irq</span> <span class="o">=</span> <span class="n">NO_IRQ</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ARRAY_SIZE</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">skt</span><span class="o">-&gt;</span><span class="n">stat</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">gpio</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">soc_pcmcia_init_one</span><span class="p">);</span>

<span class="kt">void</span> <span class="nf">soc_pcmcia_remove_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soc_pcmcia_sockets_lock</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">poll_timer</span><span class="p">);</span>

	<span class="n">pcmcia_unregister_socket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>

	<span class="n">soc_pcmcia_hw_shutdown</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>

	<span class="cm">/* should not be required; violates some lowlevel drivers */</span>
	<span class="n">soc_common_pcmcia_config_skt</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dead_socket</span><span class="p">);</span>

	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soc_pcmcia_sockets_lock</span><span class="p">);</span>

	<span class="n">iounmap</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">virt_io</span><span class="p">);</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">virt_io</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_attr</span><span class="p">);</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_mem</span><span class="p">);</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_io</span><span class="p">);</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_skt</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">soc_pcmcia_remove_one</span><span class="p">);</span>

<span class="kt">int</span> <span class="nf">soc_pcmcia_add_one</span><span class="p">(</span><span class="k">struct</span> <span class="n">soc_pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">poll_timer</span><span class="p">);</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">poll_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">soc_common_pcmcia_poll_event</span><span class="p">;</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">poll_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skt</span><span class="p">;</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">poll_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">SOC_PCMCIA_POLL_PERIOD</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">iomem_resource</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_skt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err_1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_skt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_io</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err_2</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_skt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_mem</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err_3</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_skt</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err_4</span><span class="p">;</span>

	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">virt_io</span> <span class="o">=</span> <span class="n">ioremap</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_io</span><span class="p">.</span><span class="n">start</span><span class="p">,</span> <span class="mh">0x10000</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">virt_io</span> <span class="o">==</span> <span class="nb">NULL</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out_err_5</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soc_pcmcia_sockets_lock</span><span class="p">);</span>

	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">soc_pcmcia_sockets</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * We initialize default socket timing here, because</span>
<span class="cm">	 * we are not guaranteed to see a SetIOMap operation at</span>
<span class="cm">	 * runtime.</span>
<span class="cm">	 */</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops</span><span class="o">-&gt;</span><span class="n">set_timing</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">soc_pcmcia_hw_init</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err_6</span><span class="p">;</span>

	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">soc_common_pcmcia_operations</span><span class="p">;</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">features</span> <span class="o">=</span> <span class="n">SS_CAP_STATIC_MAP</span><span class="o">|</span><span class="n">SS_CAP_PCCARD</span><span class="p">;</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">resource_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pccard_static_ops</span><span class="p">;</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">map_size</span> <span class="o">=</span> <span class="n">PAGE_SIZE</span><span class="p">;</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">io_offset</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">virt_io</span><span class="p">;</span>

	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">status</span> <span class="o">=</span> <span class="n">soc_common_pcmcia_skt_state</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_register_socket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err_7</span><span class="p">;</span>

	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">poll_timer</span><span class="p">);</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soc_pcmcia_sockets_lock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">device_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev_attr_status</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_err_8</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>

 <span class="nl">out_err_8:</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soc_pcmcia_sockets_lock</span><span class="p">);</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">poll_timer</span><span class="p">);</span>
	<span class="n">pcmcia_unregister_socket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>

 <span class="nl">out_err_7:</span>
	<span class="n">soc_pcmcia_hw_shutdown</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>
 <span class="nl">out_err_6:</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">soc_pcmcia_sockets_lock</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">virt_io</span><span class="p">);</span>
 <span class="nl">out_err_5:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_attr</span><span class="p">);</span>
 <span class="nl">out_err_4:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_mem</span><span class="p">);</span>
 <span class="nl">out_err_3:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_io</span><span class="p">);</span>
 <span class="nl">out_err_2:</span>
	<span class="n">release_resource</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">res_skt</span><span class="p">);</span>
 <span class="nl">out_err_1:</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">soc_pcmcia_add_one</span><span class="p">);</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;John Dorsey &lt;john+@cs.cmu.edu&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;Linux PCMCIA Card Services: Common SoC support&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual MPL/GPL&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
