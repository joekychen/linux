<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pcmcia › db1xxx_ss.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>db1xxx_ss.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * PCMCIA socket code for the Alchemy Db1xxx/Pb1xxx boards.</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2009 Manuel Lauss &lt;manuel.lauss@gmail.com&gt;</span>
<span class="cm"> *</span>
<span class="cm"> */</span>

<span class="cm">/* This is a fairly generic PCMCIA socket driver suitable for the</span>
<span class="cm"> * following Alchemy Development boards:</span>
<span class="cm"> *  Db1000, Db/Pb1500, Db/Pb1100, Db/Pb1550, Db/Pb1200, Db1300</span>
<span class="cm"> *</span>
<span class="cm"> * The Db1000 is used as a reference:  Per-socket card-, carddetect- and</span>
<span class="cm"> *  statuschange IRQs connected to SoC GPIOs, control and status register</span>
<span class="cm"> *  bits arranged in per-socket groups in an external PLD.  All boards</span>
<span class="cm"> *  listed here use this layout, including bit positions and meanings.</span>
<span class="cm"> *  Of course there are exceptions in later boards:</span>
<span class="cm"> *</span>
<span class="cm"> *	- Pb1100/Pb1500:  single socket only; voltage key bits VS are</span>
<span class="cm"> *			  at STATUS[5:4] (instead of STATUS[1:0]).</span>
<span class="cm"> *	- Au1200-based:	  additional card-eject irqs, irqs not gpios!</span>
<span class="cm"> *	- Db1300:	  Db1200-like, no pwr ctrl, single socket (#1).</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/gpio.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/pm.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/resource.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>
<span class="cp">#include &lt;linux/spinlock.h&gt;</span>

<span class="cp">#include &lt;pcmcia/ss.h&gt;</span>

<span class="cp">#include &lt;asm/mach-au1x00/au1000.h&gt;</span>
<span class="cp">#include &lt;asm/mach-db1x00/bcsr.h&gt;</span>

<span class="cp">#define MEM_MAP_SIZE	0x400000</span>
<span class="cp">#define IO_MAP_SIZE	0x1000</span>

<span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_socket</span>	<span class="n">socket</span><span class="p">;</span>
	<span class="kt">int</span>		<span class="n">nr</span><span class="p">;</span>		<span class="cm">/* socket number */</span>
	<span class="kt">void</span>		<span class="o">*</span><span class="n">virt_io</span><span class="p">;</span>

	<span class="n">phys_addr_t</span>	<span class="n">phys_io</span><span class="p">;</span>
	<span class="n">phys_addr_t</span>	<span class="n">phys_attr</span><span class="p">;</span>
	<span class="n">phys_addr_t</span>	<span class="n">phys_mem</span><span class="p">;</span>

	<span class="cm">/* previous flags for set_socket() */</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">old_flags</span><span class="p">;</span>

	<span class="cm">/* interrupt sources: linux irq numbers! */</span>
	<span class="kt">int</span>	<span class="n">insert_irq</span><span class="p">;</span>	<span class="cm">/* default carddetect irq */</span>
	<span class="kt">int</span>	<span class="n">stschg_irq</span><span class="p">;</span>	<span class="cm">/* card-status-change irq */</span>
	<span class="kt">int</span>	<span class="n">card_irq</span><span class="p">;</span>	<span class="cm">/* card irq */</span>
	<span class="kt">int</span>	<span class="n">eject_irq</span><span class="p">;</span>	<span class="cm">/* db1200/pb1200 have these */</span>

<span class="cp">#define BOARD_TYPE_DEFAULT	0	</span><span class="cm">/* most boards */</span><span class="cp"></span>
<span class="cp">#define BOARD_TYPE_DB1200	1	</span><span class="cm">/* IRQs aren&#39;t gpios */</span><span class="cp"></span>
<span class="cp">#define BOARD_TYPE_PB1100	2	</span><span class="cm">/* VS bits slightly different */</span><span class="cp"></span>
<span class="cp">#define BOARD_TYPE_DB1300	3	</span><span class="cm">/* no power control */</span><span class="cp"></span>
	<span class="kt">int</span>	<span class="n">board_type</span><span class="p">;</span>
<span class="p">};</span>

<span class="cp">#define to_db1x_socket(x) container_of(x, struct db1x_pcmcia_sock, socket)</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1300_card_inserted</span><span class="p">(</span><span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="n">bcsr_read</span><span class="p">(</span><span class="n">BCSR_SIGSTAT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* DB/PB1200: check CPLD SIGSTATUS register bit 10/12 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1200_card_inserted</span><span class="p">(</span><span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">sigstat</span><span class="p">;</span>

	<span class="n">sigstat</span> <span class="o">=</span> <span class="n">bcsr_read</span><span class="p">(</span><span class="n">BCSR_SIGSTAT</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">sigstat</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">8</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/* carddetect gpio: low-active */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1000_card_inserted</span><span class="p">(</span><span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">!</span><span class="n">gpio_get_value</span><span class="p">(</span><span class="n">irq_to_gpio</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">insert_irq</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1x_card_inserted</span><span class="p">(</span><span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">board_type</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BOARD_TYPE_DB1200</span>:
		<span class="k">return</span> <span class="n">db1200_card_inserted</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">case</span> <span class="n">BOARD_TYPE_DB1300</span>:
		<span class="k">return</span> <span class="n">db1300_card_inserted</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="n">db1000_card_inserted</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/* STSCHG tends to bounce heavily when cards are inserted/ejected.</span>
<span class="cm"> * To avoid this, the interrupt is normally disabled and only enabled</span>
<span class="cm"> * after reset to a card has been de-asserted.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">void</span> <span class="nf">set_stschg</span><span class="p">(</span><span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">en</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">stschg_irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">en</span><span class="p">)</span>
			<span class="n">enable_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">stschg_irq</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">disable_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">stschg_irq</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">db1000_pcmcia_cdirq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">pcmcia_parse_events</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">SS_DETECT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">db1000_pcmcia_stschgirq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="n">pcmcia_parse_events</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">SS_STSCHG</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">db1200_pcmcia_cdirq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">data</span><span class="p">;</span>

	<span class="cm">/* Db/Pb1200 have separate per-socket insertion and ejection</span>
<span class="cm">	 * interrupts which stay asserted as long as the card is</span>
<span class="cm">	 * inserted/missing.  The one which caused us to be called</span>
<span class="cm">	 * needs to be disabled and the other one enabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">irq</span> <span class="o">==</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">insert_irq</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">insert_irq</span><span class="p">);</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">eject_irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">disable_irq_nosync</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">eject_irq</span><span class="p">);</span>
		<span class="n">enable_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">insert_irq</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">pcmcia_parse_events</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">SS_DETECT</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1x_pcmcia_setup_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">stschg_irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">stschg_irq</span><span class="p">,</span> <span class="n">db1000_pcmcia_stschgirq</span><span class="p">,</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;pcmcia_stschg&quot;</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Db/Pb1200 have separate per-socket insertion and ejection</span>
<span class="cm">	 * interrupts, which should show edge behaviour but don&#39;t.</span>
<span class="cm">	 * So interrupts are disabled until both insertion and</span>
<span class="cm">	 * ejection handler have been registered and the currently</span>
<span class="cm">	 * active one disabled.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">BOARD_TYPE_DB1200</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">BOARD_TYPE_DB1300</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">insert_irq</span><span class="p">,</span> <span class="n">db1200_pcmcia_cdirq</span><span class="p">,</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;pcmcia_insert&quot;</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>

		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">eject_irq</span><span class="p">,</span> <span class="n">db1200_pcmcia_cdirq</span><span class="p">,</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;pcmcia_eject&quot;</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">free_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">insert_irq</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* enable the currently silent one */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">db1x_card_inserted</span><span class="p">(</span><span class="n">sock</span><span class="p">))</span>
			<span class="n">enable_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">eject_irq</span><span class="p">);</span>
		<span class="k">else</span>
			<span class="n">enable_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">insert_irq</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* all other (older) Db1x00 boards use a GPIO to show</span>
<span class="cm">		 * card detection status:  use both-edge triggers.</span>
<span class="cm">		 */</span>
		<span class="n">irq_set_irq_type</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">insert_irq</span><span class="p">,</span> <span class="n">IRQ_TYPE_EDGE_BOTH</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">insert_irq</span><span class="p">,</span> <span class="n">db1000_pcmcia_cdirq</span><span class="p">,</span>
				  <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;pcmcia_carddetect&quot;</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* all done */</span>

<span class="nl">out1:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">stschg_irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">stschg_irq</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">db1x_pcmcia_free_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">stschg_irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">stschg_irq</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>

	<span class="n">free_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">insert_irq</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">eject_irq</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">free_irq</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">eject_irq</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * configure a PCMCIA socket on the Db1x00 series of boards (and</span>
<span class="cm"> * compatibles).</span>
<span class="cm"> *</span>
<span class="cm"> * 2 external registers are involved:</span>
<span class="cm"> *   pcmcia_status (offset 0x04): bits [0:1/2:3]: read card voltage id</span>
<span class="cm"> *   pcmcia_control(offset 0x10):</span>
<span class="cm"> *	bits[0:1] set vcc for card</span>
<span class="cm"> *	bits[2:3] set vpp for card</span>
<span class="cm"> *	bit 4:	enable data buffers</span>
<span class="cm"> *	bit 7:	reset# for card</span>
<span class="cm"> *	add 8 for second socket.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1x_pcmcia_configure</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">,</span>
				 <span class="k">struct</span> <span class="n">socket_state_t</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">to_db1x_socket</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cr_clr</span><span class="p">,</span> <span class="n">cr_set</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">changed</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">v</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

	<span class="cm">/* card voltage setup */</span>
	<span class="n">cr_clr</span> <span class="o">=</span> <span class="p">(</span><span class="mh">0xf</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span> <span class="cm">/* clear voltage settings */</span>
	<span class="n">cr_set</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">v</span> <span class="o">=</span> <span class="n">p</span> <span class="o">=</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">50</span>:
		<span class="o">++</span><span class="n">v</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">33</span>:
		<span class="o">++</span><span class="n">v</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pcmcia%d unsupported Vcc %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">12</span>:
		<span class="o">++</span><span class="n">p</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">33</span>:
	<span class="k">case</span> <span class="mi">50</span>:
		<span class="o">++</span><span class="n">p</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">0</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pcmcia%d unsupported Vpp %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* sanity check: Vpp must be 0, 12, or Vcc */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span> <span class="o">==</span> <span class="mi">33</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span> <span class="o">==</span> <span class="mi">50</span><span class="p">))</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span> <span class="o">==</span> <span class="mi">33</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;pcmcia%d bad Vcc/Vpp combo (%d %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span><span class="p">);</span>
		<span class="n">v</span> <span class="o">=</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* create new voltage code */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">!=</span> <span class="n">BOARD_TYPE_DB1300</span><span class="p">)</span>
		<span class="n">cr_set</span> <span class="o">|=</span> <span class="p">((</span><span class="n">v</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">|</span> <span class="n">p</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">*</span> <span class="mi">8</span><span class="p">);</span>

	<span class="n">changed</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">^</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">old_flags</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">SS_RESET</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_RESET</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">set_stschg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="cm">/* assert reset, disable io buffers */</span>
			<span class="n">cr_clr</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)));</span>
			<span class="n">cr_clr</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">*</span> <span class="mi">8</span><span class="p">)));</span>
		<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
			<span class="cm">/* de-assert reset, enable io buffers */</span>
			<span class="n">cr_set</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">7</span> <span class="o">+</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
			<span class="n">cr_set</span> <span class="o">|=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">4</span> <span class="o">+</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">*</span> <span class="mi">8</span><span class="p">));</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* update PCMCIA configuration */</span>
	<span class="n">bcsr_mod</span><span class="p">(</span><span class="n">BCSR_PCMCIA</span><span class="p">,</span> <span class="n">cr_clr</span><span class="p">,</span> <span class="n">cr_set</span><span class="p">);</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">old_flags</span> <span class="o">=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">;</span>

	<span class="cm">/* reset was taken away: give card time to initialize properly */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">changed</span> <span class="o">&amp;</span> <span class="n">SS_RESET</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_RESET</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">msleep</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
		<span class="n">set_stschg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* VCC bits at [3:2]/[11:10] */</span>
<span class="cp">#define GET_VCC(cr, socknr)		\</span>
<span class="cp">	((((cr) &gt;&gt; 2) &gt;&gt; ((socknr) * 8)) &amp; 3)</span>

<span class="cm">/* VS bits at [0:1]/[3:2] */</span>
<span class="cp">#define GET_VS(sr, socknr)		\</span>
<span class="cp">	(((sr) &gt;&gt; (2 * (socknr))) &amp; 3)</span>

<span class="cm">/* reset bits at [7]/[15] */</span>
<span class="cp">#define GET_RESET(cr, socknr)		\</span>
<span class="cp">	((cr) &amp; (1 &lt;&lt; (7 + (8 * (socknr)))))</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1x_pcmcia_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">,</span>
				  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">to_db1x_socket</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>
	<span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">cr</span><span class="p">,</span> <span class="n">sr</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">;</span>

	<span class="n">status</span> <span class="o">=</span> <span class="n">db1x_card_inserted</span><span class="p">(</span><span class="n">sock</span><span class="p">)</span> <span class="o">?</span> <span class="n">SS_DETECT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">cr</span> <span class="o">=</span> <span class="n">bcsr_read</span><span class="p">(</span><span class="n">BCSR_PCMCIA</span><span class="p">);</span>
	<span class="n">sr</span> <span class="o">=</span> <span class="n">bcsr_read</span><span class="p">(</span><span class="n">BCSR_STATUS</span><span class="p">);</span>

	<span class="cm">/* PB1100/PB1500: voltage key bits are at [5:4] */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">BOARD_TYPE_PB1100</span><span class="p">)</span>
		<span class="n">sr</span> <span class="o">&gt;&gt;=</span> <span class="mi">4</span><span class="p">;</span>

	<span class="cm">/* determine card type */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">GET_VS</span><span class="p">(</span><span class="n">sr</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:
	<span class="k">case</span> <span class="mi">2</span>:
		<span class="n">status</span> <span class="o">|=</span> <span class="n">SS_3VCARD</span><span class="p">;</span>	<span class="cm">/* 3V card */</span>
	<span class="k">case</span> <span class="mi">3</span>:
		<span class="k">break</span><span class="p">;</span>			<span class="cm">/* 5V card: set nothing */</span>
	<span class="nl">default:</span>
		<span class="n">status</span> <span class="o">|=</span> <span class="n">SS_XVCARD</span><span class="p">;</span>	<span class="cm">/* treated as unsupported in core */</span>
	<span class="p">}</span>

	<span class="cm">/* if Vcc is not zero, we have applied power to a card */</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="n">GET_VCC</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">)</span> <span class="o">?</span> <span class="n">SS_POWERON</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* DB1300: power always on, but don&#39;t tell when no card present */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">==</span> <span class="n">BOARD_TYPE_DB1300</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">SS_DETECT</span><span class="p">))</span>
		<span class="n">status</span> <span class="o">=</span> <span class="n">SS_POWERON</span> <span class="o">|</span> <span class="n">SS_3VCARD</span> <span class="o">|</span> <span class="n">SS_DETECT</span><span class="p">;</span>

	<span class="cm">/* reset de-asserted? then we&#39;re ready */</span>
	<span class="n">status</span> <span class="o">|=</span> <span class="p">(</span><span class="n">GET_RESET</span><span class="p">(</span><span class="n">cr</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">))</span> <span class="o">?</span> <span class="n">SS_READY</span> <span class="o">:</span> <span class="n">SS_RESET</span><span class="p">;</span>

	<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1x_pcmcia_sock_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">db1x_pcmcia_sock_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">au1x00_pcmcia_set_io_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">,</span>
				    <span class="k">struct</span> <span class="n">pccard_io_map</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">to_db1x_socket</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>

	<span class="n">map</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">=</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">virt_io</span><span class="p">;</span>
	<span class="n">map</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">=</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">+</span> <span class="n">IO_MAP_SIZE</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">au1x00_pcmcia_set_mem_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">pccard_mem_map</span> <span class="o">*</span><span class="n">map</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">to_db1x_socket</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">map</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ATTRIB</span><span class="p">)</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">static_start</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">phys_attr</span> <span class="o">+</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">card_start</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">map</span><span class="o">-&gt;</span><span class="n">static_start</span> <span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">phys_mem</span> <span class="o">+</span> <span class="n">map</span><span class="o">-&gt;</span><span class="n">card_start</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pccard_operations</span> <span class="n">db1x_pcmcia_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>			<span class="o">=</span> <span class="n">db1x_pcmcia_sock_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span>		<span class="o">=</span> <span class="n">db1x_pcmcia_sock_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_status</span>		<span class="o">=</span> <span class="n">db1x_pcmcia_get_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_socket</span>		<span class="o">=</span> <span class="n">db1x_pcmcia_configure</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_io_map</span>		<span class="o">=</span> <span class="n">au1x00_pcmcia_set_io_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mem_map</span>		<span class="o">=</span> <span class="n">au1x00_pcmcia_set_mem_map</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">db1x_pcmcia_socket_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="o">*</span><span class="n">r</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">,</span> <span class="n">bid</span><span class="p">;</span>

	<span class="n">sock</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span> <span class="o">=</span> <span class="n">pdev</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">;</span>

	<span class="n">bid</span> <span class="o">=</span> <span class="n">BCSR_WHOAMI_BOARD</span><span class="p">(</span><span class="n">bcsr_read</span><span class="p">(</span><span class="n">BCSR_WHOAMI</span><span class="p">));</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">bid</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">BCSR_WHOAMI_PB1500</span>:
	<span class="k">case</span> <span class="n">BCSR_WHOAMI_PB1500R2</span>:
	<span class="k">case</span> <span class="n">BCSR_WHOAMI_PB1100</span>:
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">=</span> <span class="n">BOARD_TYPE_PB1100</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BCSR_WHOAMI_DB1000</span> <span class="p">...</span> <span class="n">BCSR_WHOAMI_PB1550_SDR</span>:
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">=</span> <span class="n">BOARD_TYPE_DEFAULT</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BCSR_WHOAMI_PB1200</span> <span class="p">...</span> <span class="n">BCSR_WHOAMI_DB1200</span>:
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">=</span> <span class="n">BOARD_TYPE_DB1200</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">BCSR_WHOAMI_DB1300</span>:
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">board_type</span> <span class="o">=</span> <span class="n">BOARD_TYPE_DB1300</span><span class="p">;</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;db1xxx-ss: unknown board %d!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">bid</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>
	<span class="p">};</span>

	<span class="cm">/*</span>
<span class="cm">	 * gather resources necessary and optional nice-to-haves to</span>
<span class="cm">	 * operate a socket:</span>
<span class="cm">	 * This includes IRQs for Carddetection/ejection, the card</span>
<span class="cm">	 *  itself and optional status change detection.</span>
<span class="cm">	 * Also, the memory areas covered by a socket.  For these</span>
<span class="cm">	 *  we require the real 36bit addresses (see the au1000.h</span>
<span class="cm">	 *  header for more information).</span>
<span class="cm">	 */</span>

	<span class="cm">/* card: irq assigned to the card itself. */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="s">&quot;card&quot;</span><span class="p">);</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">card_irq</span> <span class="o">=</span> <span class="n">r</span> <span class="o">?</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* insert: irq which triggers on card insertion/ejection */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="s">&quot;insert&quot;</span><span class="p">);</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">insert_irq</span> <span class="o">=</span> <span class="n">r</span> <span class="o">?</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* stschg: irq which trigger on card status change (optional) */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="s">&quot;stschg&quot;</span><span class="p">);</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">stschg_irq</span> <span class="o">=</span> <span class="n">r</span> <span class="o">?</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="cm">/* eject: irq which triggers on ejection (DB1200/PB1200 only) */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_IRQ</span><span class="p">,</span> <span class="s">&quot;eject&quot;</span><span class="p">);</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">eject_irq</span> <span class="o">=</span> <span class="n">r</span> <span class="o">?</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="cm">/* 36bit PCMCIA Attribute area address */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="s">&quot;pcmcia-attr&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pcmcia%d has no &#39;pseudo-attr&#39; resource!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">phys_attr</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="cm">/* 36bit PCMCIA Memory area address */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="s">&quot;pcmcia-mem&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pcmcia%d has no &#39;pseudo-mem&#39; resource!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">phys_mem</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="cm">/* 36bit PCMCIA IO area address */</span>
	<span class="n">r</span> <span class="o">=</span> <span class="n">platform_get_resource_byname</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">IORESOURCE_MEM</span><span class="p">,</span> <span class="s">&quot;pcmcia-io&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">r</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pcmcia%d has no &#39;pseudo-io&#39; resource!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">phys_io</span> <span class="o">=</span> <span class="n">r</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * PCMCIA client drivers use the inb/outb macros to access</span>
<span class="cm">	 * the IO registers.  Since mips_io_port_base is added</span>
<span class="cm">	 * to the access address of the mips implementation of</span>
<span class="cm">	 * inb/outb, we need to subtract it here because we want</span>
<span class="cm">	 * to access the I/O or MEM address directly, without</span>
<span class="cm">	 * going through this &quot;mips_io_port_base&quot; mechanism.</span>
<span class="cm">	 */</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">virt_io</span> <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">ioremap</span><span class="p">(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">phys_io</span><span class="p">,</span> <span class="n">IO_MAP_SIZE</span><span class="p">)</span> <span class="o">-</span>
				 <span class="n">mips_io_port_base</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">virt_io</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pcmcia%d: cannot remap IO area</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">ops</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">db1x_pcmcia_operations</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">pci_irq</span>	<span class="o">=</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">card_irq</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">features</span>	<span class="o">=</span> <span class="n">SS_CAP_STATIC_MAP</span> <span class="o">|</span> <span class="n">SS_CAP_PCCARD</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">map_size</span>	<span class="o">=</span> <span class="n">MEM_MAP_SIZE</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">io_offset</span>	<span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">virt_io</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span>	<span class="o">=</span> <span class="o">&amp;</span><span class="n">pdev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	<span class="n">sock</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">resource_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pccard_static_ops</span><span class="p">;</span>

	<span class="n">platform_set_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">db1x_pcmcia_setup_irqs</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pcmcia%d cannot setup interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">set_stschg</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_register_socket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_ERR</span> <span class="s">&quot;pcmcia%d failed to register</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out2</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Alchemy Db/Pb1xxx pcmcia%d @ io/attr/mem %09llx&quot;</span>
		<span class="s">&quot;(%p) %09llx %09llx  card/insert/stschg/eject irqs @ %d &quot;</span>
		<span class="s">&quot;%d %d %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">nr</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">phys_io</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">virt_io</span><span class="p">,</span>
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">phys_attr</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">phys_mem</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">card_irq</span><span class="p">,</span>
		<span class="n">sock</span><span class="o">-&gt;</span><span class="n">insert_irq</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">stschg_irq</span><span class="p">,</span> <span class="n">sock</span><span class="o">-&gt;</span><span class="n">eject_irq</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

<span class="nl">out2:</span>
	<span class="n">db1x_pcmcia_free_irqs</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
<span class="nl">out1:</span>
	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">virt_io</span> <span class="o">+</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mips_io_port_base</span><span class="p">));</span>
<span class="nl">out0:</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devexit</span> <span class="nf">db1x_pcmcia_socket_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">pdev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">db1x_pcmcia_sock</span> <span class="o">*</span><span class="n">sock</span> <span class="o">=</span> <span class="n">platform_get_drvdata</span><span class="p">(</span><span class="n">pdev</span><span class="p">);</span>

	<span class="n">db1x_pcmcia_free_irqs</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="n">pcmcia_unregister_socket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>
	<span class="n">iounmap</span><span class="p">((</span><span class="kt">void</span> <span class="o">*</span><span class="p">)(</span><span class="n">sock</span><span class="o">-&gt;</span><span class="n">virt_io</span> <span class="o">+</span> <span class="p">(</span><span class="n">u32</span><span class="p">)</span><span class="n">mips_io_port_base</span><span class="p">));</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">db1x_pcmcia_socket_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span>	<span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span>	<span class="o">=</span> <span class="s">&quot;db1xxx_pcmcia&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>	<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
	<span class="p">.</span><span class="n">probe</span>		<span class="o">=</span> <span class="n">db1x_pcmcia_socket_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span>		<span class="o">=</span> <span class="n">__devexit_p</span><span class="p">(</span><span class="n">db1x_pcmcia_socket_remove</span><span class="p">),</span>
<span class="p">};</span>

<span class="n">module_platform_driver</span><span class="p">(</span><span class="n">db1x_pcmcia_socket_driver</span><span class="p">);</span>

<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PCMCIA Socket Services for Alchemy Db/Pb1x00 boards&quot;</span><span class="p">);</span>
<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;Manuel Lauss&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
