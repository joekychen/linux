<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pcmcia › ds.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ds.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ds.c -- 16-bit PCMCIA core support</span>
<span class="cm"> *</span>
<span class="cm"> * This program is free software; you can redistribute it and/or modify</span>
<span class="cm"> * it under the terms of the GNU General Public License version 2 as</span>
<span class="cm"> * published by the Free Software Foundation.</span>
<span class="cm"> *</span>
<span class="cm"> * The initial developer of the original code is David A. Hinds</span>
<span class="cm"> * &lt;dahinds@users.sourceforge.net&gt;.  Portions created by David A. Hinds</span>
<span class="cm"> * are Copyright (C) 1999 David A. Hinds.  All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * (C) 1999		David A. Hinds</span>
<span class="cm"> * (C) 2003 - 2010	Dominik Brodowski</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/list.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/crc32.h&gt;</span>
<span class="cp">#include &lt;linux/firmware.h&gt;</span>
<span class="cp">#include &lt;linux/kref.h&gt;</span>
<span class="cp">#include &lt;linux/dma-mapping.h&gt;</span>
<span class="cp">#include &lt;linux/slab.h&gt;</span>

<span class="cp">#include &lt;pcmcia/cistpl.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ds.h&gt;</span>
<span class="cp">#include &lt;pcmcia/ss.h&gt;</span>

<span class="cp">#include &quot;cs_internal.h&quot;</span>

<span class="cm">/*====================================================================*/</span>

<span class="cm">/* Module parameters */</span>

<span class="n">MODULE_AUTHOR</span><span class="p">(</span><span class="s">&quot;David Hinds &lt;dahinds@users.sourceforge.net&gt;&quot;</span><span class="p">);</span>
<span class="n">MODULE_DESCRIPTION</span><span class="p">(</span><span class="s">&quot;PCMCIA Driver Services&quot;</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;GPL&quot;</span><span class="p">);</span>


<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcmcia_check_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="o">*</span><span class="n">p_drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pcmcia_device_id</span> <span class="o">*</span><span class="n">did</span> <span class="o">=</span> <span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">id_table</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hash</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">probe</span> <span class="o">||</span> <span class="o">!</span><span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcmcia: %s lacks a requisite callback &quot;</span>
		       <span class="s">&quot;function</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">did</span> <span class="o">&amp;&amp;</span> <span class="n">did</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">hash</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">did</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">strlen</span><span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">hash</span> <span class="o">==</span> <span class="n">did</span><span class="o">-&gt;</span><span class="n">prod_id_hash</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcmcia: %s: invalid hash for &quot;</span>
			       <span class="s">&quot;product string </span><span class="se">\&quot;</span><span class="s">%s</span><span class="se">\&quot;</span><span class="s">: is 0x%x, should &quot;</span>
			       <span class="s">&quot;be 0x%x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">did</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
			       <span class="n">did</span><span class="o">-&gt;</span><span class="n">prod_id_hash</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">hash</span><span class="p">);</span>
			<span class="n">printk</span><span class="p">(</span><span class="n">KERN_DEBUG</span> <span class="s">&quot;pcmcia: see &quot;</span>
				<span class="s">&quot;Documentation/pcmcia/devicetable.txt for &quot;</span>
				<span class="s">&quot;details</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">did</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*======================================================================*/</span>


<span class="k">struct</span> <span class="n">pcmcia_dynid</span> <span class="p">{</span>
	<span class="k">struct</span> <span class="n">list_head</span> 		<span class="n">node</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device_id</span> 	<span class="n">id</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/**</span>
<span class="cm"> * pcmcia_store_new_id - add a new PCMCIA device ID to this driver and re-probe devices</span>
<span class="cm"> * @driver: target device driver</span>
<span class="cm"> * @buf: buffer for scanning device ID data</span>
<span class="cm"> * @count: input size</span>
<span class="cm"> *</span>
<span class="cm"> * Adds a new dynamic PCMCIA device ID to this driver,</span>
<span class="cm"> * and causes the driver to probe for all devices again.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">ssize_t</span>
<span class="nf">pcmcia_store_new_id</span><span class="p">(</span><span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_dynid</span> <span class="o">*</span><span class="n">dynid</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="o">*</span><span class="n">pdrv</span> <span class="o">=</span> <span class="n">to_pcmcia_drv</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">__u16</span> <span class="n">match_flags</span><span class="p">,</span> <span class="n">manf_id</span><span class="p">,</span> <span class="n">card_id</span><span class="p">;</span>
	<span class="n">__u8</span> <span class="n">func_id</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">device_no</span><span class="p">;</span>
	<span class="n">__u32</span> <span class="n">prod_id_hash</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>
	<span class="kt">int</span> <span class="n">fields</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">fields</span> <span class="o">=</span> <span class="n">sscanf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;%hx %hx %hx %hhx %hhx %hhx %x %x %x %x&quot;</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">match_flags</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">manf_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">card_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_id</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">function</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">device_no</span><span class="p">,</span>
			<span class="o">&amp;</span><span class="n">prod_id_hash</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">prod_id_hash</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">prod_id_hash</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="o">&amp;</span><span class="n">prod_id_hash</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">fields</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dynid</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_dynid</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dynid</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="n">dynid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">match_flags</span> <span class="o">=</span> <span class="n">match_flags</span><span class="p">;</span>
	<span class="n">dynid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">manf_id</span> <span class="o">=</span> <span class="n">manf_id</span><span class="p">;</span>
	<span class="n">dynid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">card_id</span> <span class="o">=</span> <span class="n">card_id</span><span class="p">;</span>
	<span class="n">dynid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">func_id</span> <span class="o">=</span> <span class="n">func_id</span><span class="p">;</span>
	<span class="n">dynid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">function</span><span class="p">;</span>
	<span class="n">dynid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">device_no</span> <span class="o">=</span> <span class="n">device_no</span><span class="p">;</span>
	<span class="n">memcpy</span><span class="p">(</span><span class="n">dynid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">.</span><span class="n">prod_id_hash</span><span class="p">,</span> <span class="n">prod_id_hash</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">__u32</span><span class="p">)</span> <span class="o">*</span> <span class="mi">4</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdrv</span><span class="o">-&gt;</span><span class="n">dynids</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_add_tail</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dynid</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pdrv</span><span class="o">-&gt;</span><span class="n">dynids</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdrv</span><span class="o">-&gt;</span><span class="n">dynids</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">driver_attach</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pdrv</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">static</span> <span class="n">DRIVER_ATTR</span><span class="p">(</span><span class="n">new_id</span><span class="p">,</span> <span class="n">S_IWUSR</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pcmcia_store_new_id</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pcmcia_free_dynids</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_dynid</span> <span class="o">*</span><span class="n">dynid</span><span class="p">,</span> <span class="o">*</span><span class="n">n</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">dynids</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">dynid</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">dynids</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dynid</span><span class="o">-&gt;</span><span class="n">node</span><span class="p">);</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">dynid</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">dynids</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span>
<span class="nf">pcmcia_create_newid_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">probe</span> <span class="o">!=</span> <span class="nb">NULL</span><span class="p">)</span>
		<span class="n">error</span> <span class="o">=</span> <span class="n">driver_create_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_new_id</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span>
<span class="nf">pcmcia_remove_newid_file</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">driver_remove_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">drv</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">driver_attr_new_id</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pcmcia_register_driver - register a PCMCIA driver with the bus core</span>
<span class="cm"> * @driver: the &amp;driver being registered</span>
<span class="cm"> *</span>
<span class="cm"> * Registers a PCMCIA driver with the PCMCIA bus core.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pcmcia_register_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">error</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">driver</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">pcmcia_check_driver</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>

	<span class="cm">/* initialize common fields */</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcmcia_bus_type</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">;</span>
	<span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">;</span>
	<span class="n">mutex_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dynids</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">dynids</span><span class="p">.</span><span class="n">list</span><span class="p">);</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;registering driver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">error</span><span class="p">;</span>

	<span class="n">error</span> <span class="o">=</span> <span class="n">pcmcia_create_newid_file</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
		<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pcmcia_register_driver</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pcmcia_unregister_driver - unregister a PCMCIA driver with the bus core</span>
<span class="cm"> * @driver: the &amp;driver being unregistered</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pcmcia_unregister_driver</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="o">*</span><span class="n">driver</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;unregistering driver %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">driver</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
	<span class="n">pcmcia_remove_newid_file</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">drv</span><span class="p">);</span>
	<span class="n">pcmcia_free_dynids</span><span class="p">(</span><span class="n">driver</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pcmcia_unregister_driver</span><span class="p">);</span>


<span class="cm">/* pcmcia_device handling */</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="nf">pcmcia_get_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">tmp_dev</span><span class="p">;</span>
	<span class="n">tmp_dev</span> <span class="o">=</span> <span class="n">get_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tmp_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">tmp_dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcmcia_put_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="p">)</span>
		<span class="n">put_device</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcmcia_release_function</span><span class="p">(</span><span class="k">struct</span> <span class="n">kref</span> <span class="o">*</span><span class="n">ref</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">config_t</span> <span class="o">*</span><span class="n">c</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="k">struct</span> <span class="n">config_t</span><span class="p">,</span> <span class="n">ref</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;releasing config_t</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">c</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcmcia_release_dev</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;releasing device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">pcmcia_put_socket</span><span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
	<span class="n">kref_put</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">function_config</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">,</span> <span class="n">pcmcia_release_function</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_device_probe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="o">*</span><span class="n">p_drv</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">s</span><span class="p">;</span>
	<span class="n">cistpl_config_t</span> <span class="n">cis_config</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev</span> <span class="o">=</span> <span class="n">get_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">p_drv</span> <span class="o">=</span> <span class="n">to_pcmcia_drv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>
	<span class="n">s</span> <span class="o">=</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;trying to bind to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="o">!</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">function_config</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">(</span><span class="o">!</span><span class="n">try_module_get</span><span class="p">(</span><span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">)))</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">put_dev</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* set up some more device information */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">pccard_read_tuple</span><span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">CISTPL_CONFIG</span><span class="p">,</span>
				<span class="o">&amp;</span><span class="n">cis_config</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">=</span> <span class="n">cis_config</span><span class="p">.</span><span class="n">base</span><span class="p">;</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">config_regs</span> <span class="o">=</span> <span class="n">cis_config</span><span class="p">.</span><span class="n">rmask</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;base %x, regs %x&quot;</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">config_base</span><span class="p">,</span>
			<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">config_regs</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;pcmcia: could not parse base and rmask0 of CIS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">config_base</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">config_regs</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">probe</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;binding to %s failed with %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">put_module</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%s bound: Vpp %d.%d, idx %x, IRQ %d&quot;</span><span class="p">,</span> <span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">vpp</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">vpp</span><span class="o">%</span><span class="mi">10</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">config_index</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resources: ioport %pR %pR iomem %pR %pR %pR&quot;</span><span class="p">,</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="mi">4</span><span class="p">]);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">pcmcia_pfc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">device_count</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">device_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">pcmcia_parse_uevents</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">PCMCIA_UEVENT_REQUERY</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

<span class="nl">put_module:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">module_put</span><span class="p">(</span><span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>
<span class="nl">put_dev:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		<span class="n">put_device</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Removes a PCMCIA card from the device tree and socket list.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcmcia_card_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">leftover</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span>	<span class="o">*</span><span class="n">p_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span>	<span class="o">*</span><span class="n">tmp</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">leftover</span> <span class="o">?</span> <span class="o">&amp;</span><span class="n">leftover</span><span class="o">-&gt;</span><span class="n">dev</span> <span class="o">:</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		   <span class="s">&quot;pcmcia_card_remove(%d) %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">,</span>
		   <span class="n">leftover</span> <span class="o">?</span> <span class="n">leftover</span><span class="o">-&gt;</span><span class="n">devname</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">leftover</span><span class="p">)</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">device_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">s</span><span class="o">-&gt;</span><span class="n">device_count</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

	<span class="cm">/* unregister all pcmcia_devices registered with this socket, except leftover */</span>
	<span class="n">list_for_each_entry_safe</span><span class="p">(</span><span class="n">p_dev</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">devices_list</span><span class="p">,</span> <span class="n">socket_device_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span> <span class="o">==</span> <span class="n">leftover</span><span class="p">)</span>
			<span class="k">continue</span><span class="p">;</span>

		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
		<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket_device_list</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;unregistering device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">device_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_device_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="o">*</span><span class="n">p_drv</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">p_drv</span> <span class="o">=</span> <span class="n">to_pcmcia_drv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;removing device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* If we&#39;re removing the primary module driving a</span>
<span class="cm">	 * pseudo multi-function card, we need to unbind</span>
<span class="cm">	 * all devices</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">pcmcia_pfc</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">device_count</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">device_no</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">pcmcia_card_remove</span><span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">p_dev</span><span class="p">);</span>

	<span class="cm">/* detach the &quot;instance&quot; */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_drv</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">)</span>
		<span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">remove</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>

	<span class="cm">/* check for proper unloading */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">_irq</span> <span class="o">||</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">_io</span> <span class="o">||</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">_locked</span><span class="p">)</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;pcmcia: driver %s did not release config properly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			<span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_WIN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">_win</span> <span class="o">&amp;</span> <span class="n">CLIENT_WIN_REQ</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
			<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			  <span class="s">&quot;pcmcia: driver %s did not release window properly</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>

	<span class="cm">/* references from pcmcia_probe_device */</span>
	<span class="n">pcmcia_put_dev</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
	<span class="n">module_put</span><span class="p">(</span><span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">owner</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * pcmcia_device_query -- determine information about a pcmcia device</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_device_query</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cistpl_manfid_t</span> <span class="n">manf_id</span><span class="p">;</span>
	<span class="n">cistpl_funcid_t</span> <span class="n">func_id</span><span class="p">;</span>
	<span class="n">cistpl_vers_1_t</span>	<span class="o">*</span><span class="n">vers1</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">vers1</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">vers1</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">vers1</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pccard_read_tuple</span><span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">BIND_FN_ALL</span><span class="p">,</span>
			       <span class="n">CISTPL_MANFID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">manf_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">=</span> <span class="n">manf_id</span><span class="p">.</span><span class="n">manf</span><span class="p">;</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">card_id</span> <span class="o">=</span> <span class="n">manf_id</span><span class="p">.</span><span class="n">card</span><span class="p">;</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">has_manf_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">has_card_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pccard_read_tuple</span><span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span>
			       <span class="n">CISTPL_FUNCID</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">func_id</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">func_id</span> <span class="o">=</span> <span class="n">func_id</span><span class="p">.</span><span class="n">func</span><span class="p">;</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">has_func_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* rule of thumb: cards with no FUNCID, but with</span>
<span class="cm">		 * common memory device geometry information, are</span>
<span class="cm">		 * probably memory cards (from pcmcia-cs) */</span>
		<span class="n">cistpl_device_geo_t</span> <span class="o">*</span><span class="n">devgeo</span><span class="p">;</span>

		<span class="n">devgeo</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="o">*</span><span class="n">devgeo</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">devgeo</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">vers1</span><span class="p">);</span>
			<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pccard_read_tuple</span><span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span>
				      <span class="n">CISTPL_DEVICE_GEO</span><span class="p">,</span> <span class="n">devgeo</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;mem device geometry probably means &quot;</span>
				   <span class="s">&quot;FUNCID_MEMORY</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
			<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">func_id</span> <span class="o">=</span> <span class="n">CISTPL_FUNCID_MEMORY</span><span class="p">;</span>
			<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">has_func_id</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">devgeo</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pccard_read_tuple</span><span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">BIND_FN_ALL</span><span class="p">,</span> <span class="n">CISTPL_VERS_1</span><span class="p">,</span>
			       <span class="n">vers1</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">min_t</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">vers1</span><span class="o">-&gt;</span><span class="n">ns</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">tmp</span><span class="p">;</span>
			<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">;</span>
			<span class="kt">char</span> <span class="o">*</span><span class="n">new</span><span class="p">;</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">vers1</span><span class="o">-&gt;</span><span class="n">str</span> <span class="o">+</span> <span class="n">vers1</span><span class="o">-&gt;</span><span class="n">ofs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>

			<span class="n">length</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">if</span> <span class="p">((</span><span class="n">length</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">length</span> <span class="o">&gt;</span> <span class="mi">255</span><span class="p">))</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">new</span> <span class="o">=</span> <span class="n">kmalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">length</span><span class="p">,</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">new</span><span class="p">)</span>
				<span class="k">continue</span><span class="p">;</span>

			<span class="n">new</span> <span class="o">=</span> <span class="n">strncpy</span><span class="p">(</span><span class="n">new</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="n">length</span><span class="p">);</span>

			<span class="n">tmp</span> <span class="o">=</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
			<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span><span class="p">;</span>
			<span class="n">kfree</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">kfree</span><span class="p">(</span><span class="n">vers1</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="nf">pcmcia_device_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span>
					       <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">function</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">,</span> <span class="o">*</span><span class="n">tmp_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="n">s</span> <span class="o">=</span> <span class="n">pcmcia_get_socket</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">s</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;adding device to %d, function %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">,</span> <span class="n">function</span><span class="p">);</span>

	<span class="n">p_dev</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_dev</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_put</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">device_no</span> <span class="o">=</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">device_count</span><span class="o">++</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

	<span class="cm">/* max of 2 PFC devices */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">device_no</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">function</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="cm">/* max of 4 devices overall */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">device_no</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>

	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">func</span>   <span class="o">=</span> <span class="n">function</span><span class="p">;</span>

	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">bus</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcmcia_bus_type</span><span class="p">;</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span><span class="p">;</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">release</span> <span class="o">=</span> <span class="n">pcmcia_release_dev</span><span class="p">;</span>
	<span class="cm">/* by default don&#39;t allow DMA */</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="n">DMA_MASK_NONE</span><span class="p">;</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">dma_mask</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dma_mask</span><span class="p">;</span>
	<span class="n">dev_set_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;%d.%d&quot;</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">device_no</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">devname</span> <span class="o">=</span> <span class="n">kasprintf</span><span class="p">(</span><span class="n">GFP_KERNEL</span><span class="p">,</span> <span class="s">&quot;pcmcia%s&quot;</span><span class="p">,</span> <span class="n">dev_name</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">));</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">err_free</span><span class="p">;</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;devname is %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * p_dev-&gt;function_config must be the same for all card functions.</span>
<span class="cm">	 * Note that this is serialized by ops_mutex, so that only one</span>
<span class="cm">	 * such struct will be created.</span>
<span class="cm">	 */</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">tmp_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">devices_list</span><span class="p">,</span> <span class="n">socket_device_list</span><span class="p">)</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">==</span> <span class="n">tmp_dev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">function_config</span> <span class="o">=</span> <span class="n">tmp_dev</span><span class="o">-&gt;</span><span class="n">function_config</span><span class="p">;</span>
			<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">tmp_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>
			<span class="n">kref_get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">function_config</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
		<span class="p">}</span>

	<span class="cm">/* Add to the list in pcmcia_bus_socket */</span>
	<span class="n">list_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket_device_list</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">devices_list</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcmcia_setup_irq</span><span class="p">(</span><span class="n">p_dev</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			<span class="s">&quot;IRQ setup failed -- device might not work</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">function_config</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">config_t</span> <span class="o">*</span><span class="n">c</span><span class="p">;</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;creating config_t</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">c</span> <span class="o">=</span> <span class="n">kzalloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="k">struct</span> <span class="n">config_t</span><span class="p">),</span> <span class="n">GFP_KERNEL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">c</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">err_unreg</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">function_config</span> <span class="o">=</span> <span class="n">c</span><span class="p">;</span>
		<span class="n">kref_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">c</span><span class="o">-&gt;</span><span class="n">ref</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_IO_WIN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_IO</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">&lt;</span> <span class="n">MAX_WIN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">name</span> <span class="o">=</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">;</span>
			<span class="n">c</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">IORESOURCE_MEM</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MAX_IO_WIN</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">function_config</span><span class="o">-&gt;</span><span class="n">io</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">MAX_IO_WIN</span> <span class="o">+</span> <span class="n">MAX_WIN</span><span class="p">);</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">function_config</span><span class="o">-&gt;</span><span class="n">mem</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="n">MAX_IO_WIN</span><span class="p">];</span>

	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		   <span class="s">&quot;pcmcia: registering new device %s (IRQ: %d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">);</span>

	<span class="n">pcmcia_device_query</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">device_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">))</span>
		<span class="k">goto</span> <span class="n">err_unreg</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">p_dev</span><span class="p">;</span>

 <span class="nl">err_unreg:</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="n">list_del</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket_device_list</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

 <span class="nl">err_free:</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">device_count</span><span class="o">--</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">kfree</span><span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
 <span class="nl">err_put:</span>
	<span class="n">pcmcia_put_socket</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>

	<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_card_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">cistpl_longlink_mfc_t</span> <span class="n">mfc</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">no_funcs</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">no_chains</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">resource_setup_done</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;no resources available, delaying card_add</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span> <span class="cm">/* try again, but later... */</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">pcmcia_validate_mem</span><span class="p">(</span><span class="n">s</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;validating mem resources failed, &quot;</span>
		       <span class="s">&quot;delaying card_add</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span> <span class="cm">/* try again, but later... */</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pccard_validate_cis</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">no_chains</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">||</span> <span class="o">!</span><span class="n">no_chains</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;invalid CIS or invalid resources</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pccard_read_tuple</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">BIND_FN_ALL</span><span class="p">,</span> <span class="n">CISTPL_LONGLINK_MFC</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mfc</span><span class="p">))</span>
		<span class="n">no_funcs</span> <span class="o">=</span> <span class="n">mfc</span><span class="p">.</span><span class="n">nfn</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">no_funcs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">s</span><span class="o">-&gt;</span><span class="n">functions</span> <span class="o">=</span> <span class="n">no_funcs</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">no_funcs</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">pcmcia_device_add</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_requery_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">.</span><span class="n">driver</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;update device information</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pcmcia_device_query</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcmcia_requery</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">has_pfc</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">functions</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">pcmcia_card_add</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="k">return</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* some device information might have changed because of a CIS</span>
<span class="cm">	 * update or because we can finally read it correctly... so</span>
<span class="cm">	 * determine it again, overwriting old values if necessary. */</span>
	<span class="n">bus_for_each_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pcmcia_requery_callback</span><span class="p">);</span>

	<span class="cm">/* if the CIS changed, we need to check whether the number of</span>
<span class="cm">	 * functions changed. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">fake_cis</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">old_funcs</span><span class="p">,</span> <span class="n">new_funcs</span><span class="p">;</span>
		<span class="n">cistpl_longlink_mfc_t</span> <span class="n">mfc</span><span class="p">;</span>

		<span class="cm">/* does this cis override add or remove functions? */</span>
		<span class="n">old_funcs</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pccard_read_tuple</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">BIND_FN_ALL</span><span class="p">,</span> <span class="n">CISTPL_LONGLINK_MFC</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">mfc</span><span class="p">))</span>
			<span class="n">new_funcs</span> <span class="o">=</span> <span class="n">mfc</span><span class="p">.</span><span class="n">nfn</span><span class="p">;</span>
		<span class="k">else</span>
			<span class="n">new_funcs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_funcs</span> <span class="o">!=</span> <span class="n">new_funcs</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* we need to re-start */</span>
			<span class="n">pcmcia_card_remove</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
			<span class="n">s</span><span class="o">-&gt;</span><span class="n">functions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">pcmcia_card_add</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* If the PCMCIA device consists of two pseudo devices,</span>
<span class="cm">	 * call pcmcia_device_add() -- which will fail if both</span>
<span class="cm">	 * devices are already registered. */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="n">has_pfc</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">pcmcia_pfc</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">has_pfc</span><span class="p">)</span>
		<span class="n">pcmcia_device_add</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="cm">/* we re-scan all devices, not just the ones connected to this</span>
<span class="cm">	 * socket. This does not matter, though. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus_rescan_devices</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia_bus_type</span><span class="p">))</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="o">&amp;</span><span class="n">s</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;rescanning the bus failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>


<span class="cp">#ifdef CONFIG_PCMCIA_LOAD_CIS</span>

<span class="cm">/**</span>
<span class="cm"> * pcmcia_load_firmware - load CIS from userspace if device-provided is broken</span>
<span class="cm"> * @dev: the pcmcia device which needs a CIS override</span>
<span class="cm"> * @filename: requested filename in /lib/firmware/</span>
<span class="cm"> *</span>
<span class="cm"> * This uses the in-kernel firmware loading mechanism to use a &quot;fake CIS&quot; if</span>
<span class="cm"> * the one provided by the card is broken. The firmware files reside in</span>
<span class="cm"> * /lib/firmware/ in userspace.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">s</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">;</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">firmware</span> <span class="o">*</span><span class="n">fw</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>
	<span class="n">cistpl_longlink_mfc_t</span> <span class="n">mfc</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">old_funcs</span><span class="p">,</span> <span class="n">new_funcs</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">filename</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;trying to load CIS file %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">filename</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">request_firmware</span><span class="p">(</span><span class="o">&amp;</span><span class="n">fw</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span> <span class="o">&gt;=</span> <span class="n">CISTPL_MAX_CIS_SIZE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
			<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;pcmcia: CIS override is too big</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pcmcia_replace_cis</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">data</span><span class="p">,</span> <span class="n">fw</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">))</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">else</span> <span class="p">{</span>
			<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;pcmcia: CIS override failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">release</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* we need to re-start if the number of functions changed */</span>
		<span class="n">old_funcs</span> <span class="o">=</span> <span class="n">s</span><span class="o">-&gt;</span><span class="n">functions</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pccard_read_tuple</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">BIND_FN_ALL</span><span class="p">,</span> <span class="n">CISTPL_LONGLINK_MFC</span><span class="p">,</span>
					<span class="o">&amp;</span><span class="n">mfc</span><span class="p">))</span>
			<span class="n">new_funcs</span> <span class="o">=</span> <span class="n">mfc</span><span class="p">.</span><span class="n">nfn</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">old_funcs</span> <span class="o">!=</span> <span class="n">new_funcs</span><span class="p">)</span>
			<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

		<span class="cm">/* update information */</span>
		<span class="n">pcmcia_device_query</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="cm">/* requery (as number of functions might have changed) */</span>
		<span class="n">pcmcia_parse_uevents</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">PCMCIA_UEVENT_REQUERY</span><span class="p">);</span>
	<span class="p">}</span>
 <span class="nl">release:</span>
	<span class="n">release_firmware</span><span class="p">(</span><span class="n">fw</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else </span><span class="cm">/* !CONFIG_PCMCIA_LOAD_CIS */</span><span class="cp"></span>

<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pcmcia_load_firmware</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">filename</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>


<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">pcmcia_devmatch</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				  <span class="k">const</span> <span class="k">struct</span> <span class="n">pcmcia_device_id</span> <span class="o">*</span><span class="n">did</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_MANF_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_manf_id</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">!=</span> <span class="n">did</span><span class="o">-&gt;</span><span class="n">manf_id</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_CARD_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_card_id</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">card_id</span> <span class="o">!=</span> <span class="n">did</span><span class="o">-&gt;</span><span class="n">card_id</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_FUNCTION</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">func</span> <span class="o">!=</span> <span class="n">did</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_PROD_ID1</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_PROD_ID2</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_PROD_ID3</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_PROD_ID4</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_DEVICE_NO</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;this is a pseudo-multi-function device</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">pcmcia_pfc</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_no</span> <span class="o">!=</span> <span class="n">did</span><span class="o">-&gt;</span><span class="n">device_no</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_FUNC_ID</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_func_id</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">func_id</span> <span class="o">!=</span> <span class="n">did</span><span class="o">-&gt;</span><span class="n">func_id</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* if this is a pseudo-multi-function device,</span>
<span class="cm">		 * we need explicit matches */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">pcmcia_pfc</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device_no</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/* also, FUNC_ID matching needs to be activated by userspace</span>
<span class="cm">		 * after it has re-checked that there is no possible module</span>
<span class="cm">		 * with a prod_id/manf_id/card_id match.</span>
<span class="cm">		 */</span>
		<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">allow_func_id_match</span><span class="p">;</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				<span class="s">&quot;skipping FUNC_ID match until userspace ACK</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_FAKE_CIS</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;device needs a fake CIS</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">fake_cis</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pcmcia_load_firmware</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">did</span><span class="o">-&gt;</span><span class="n">cisfile</span><span class="p">))</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">did</span><span class="o">-&gt;</span><span class="n">match_flags</span> <span class="o">&amp;</span> <span class="n">PCMCIA_DEV_ID_MATCH_ANONYMOUS</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
				<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_manf_id</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_card_id</span> <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">has_func_id</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_bus_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_driver</span> <span class="o">*</span><span class="n">drv</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="o">*</span><span class="n">p_drv</span> <span class="o">=</span> <span class="n">to_pcmcia_drv</span><span class="p">(</span><span class="n">drv</span><span class="p">);</span>
	<span class="k">const</span> <span class="k">struct</span> <span class="n">pcmcia_device_id</span> <span class="o">*</span><span class="n">did</span> <span class="o">=</span> <span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">id_table</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_dynid</span> <span class="o">*</span><span class="n">dynid</span><span class="p">;</span>

	<span class="cm">/* match dynamic devices first */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">dynids</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dynid</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">dynids</span><span class="p">.</span><span class="n">list</span><span class="p">,</span> <span class="n">node</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;trying to match to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcmcia_devmatch</span><span class="p">(</span><span class="n">p_dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dynid</span><span class="o">-&gt;</span><span class="n">id</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;matched to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">dynids</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">dynids</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">while</span> <span class="p">(</span><span class="n">did</span> <span class="o">&amp;&amp;</span> <span class="n">did</span><span class="o">-&gt;</span><span class="n">match_flags</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;trying to match to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">pcmcia_devmatch</span><span class="p">(</span><span class="n">p_dev</span><span class="p">,</span> <span class="n">did</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;matched to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">);</span>
			<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">did</span><span class="o">++</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#ifdef CONFIG_HOTPLUG</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_bus_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_uevent_env</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hash</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>

	<span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="cm">/* calculate hashes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">hash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">strlen</span><span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;SOCKET_NO=%u&quot;</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;DEVICE_NO=%02X&quot;</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">device_no</span><span class="p">))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">add_uevent_var</span><span class="p">(</span><span class="n">env</span><span class="p">,</span> <span class="s">&quot;MODALIAS=pcmcia:m%04Xc%04Xf%02Xfn%02Xpfn%02X&quot;</span>
			   <span class="s">&quot;pa%08Xpb%08Xpc%08Xpd%08X&quot;</span><span class="p">,</span>
			   <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">has_manf_id</span> <span class="o">?</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">has_card_id</span> <span class="o">?</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">card_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">has_func_id</span> <span class="o">?</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">func_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
			   <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span>
			   <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">device_no</span><span class="p">,</span>
			   <span class="n">hash</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
			   <span class="n">hash</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
			   <span class="n">hash</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
			   <span class="n">hash</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#else</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_bus_uevent</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">kobj_uevent_env</span> <span class="o">*</span><span class="n">env</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#endif</span>

<span class="cm">/************************ runtime PM support ***************************/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">pcmcia_dev_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">pcmcia_dev_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">);</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">device_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcmcia_dev_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">PMSG_SUSPEND</span><span class="p">);</span>
	<span class="n">device_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">rc</span><span class="p">;</span>

	<span class="n">device_lock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">rc</span> <span class="o">=</span> <span class="n">pcmcia_dev_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">device_unlock</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">rc</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/************************ per-device sysfs output ***************************/</span>

<span class="cp">#define pcmcia_device_attr(field, test, format)				\</span>
<span class="cp">static ssize_t field##_show (struct device *dev, struct device_attribute *attr, char *buf)		\</span>
<span class="cp">{									\</span>
<span class="cp">	struct pcmcia_device *p_dev = to_pcmcia_dev(dev);		\</span>
<span class="cp">	return p_dev-&gt;test ? sprintf(buf, format, p_dev-&gt;field) : -ENODEV; \</span>
<span class="cp">}</span>

<span class="cp">#define pcmcia_device_stringattr(name, field)					\</span>
<span class="cp">static ssize_t name##_show (struct device *dev, struct device_attribute *attr, char *buf)		\</span>
<span class="cp">{									\</span>
<span class="cp">	struct pcmcia_device *p_dev = to_pcmcia_dev(dev);		\</span>
<span class="cp">	return p_dev-&gt;field ? sprintf(buf, &quot;%s\n&quot;, p_dev-&gt;field) : -ENODEV; \</span>
<span class="cp">}</span>

<span class="n">pcmcia_device_attr</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">socket</span><span class="p">,</span> <span class="s">&quot;0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">pcmcia_device_attr</span><span class="p">(</span><span class="n">func_id</span><span class="p">,</span> <span class="n">has_func_id</span><span class="p">,</span> <span class="s">&quot;0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">pcmcia_device_attr</span><span class="p">(</span><span class="n">manf_id</span><span class="p">,</span> <span class="n">has_manf_id</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">pcmcia_device_attr</span><span class="p">(</span><span class="n">card_id</span><span class="p">,</span> <span class="n">has_card_id</span><span class="p">,</span> <span class="s">&quot;0x%04x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="n">pcmcia_device_stringattr</span><span class="p">(</span><span class="n">prod_id1</span><span class="p">,</span> <span class="n">prod_id</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="n">pcmcia_device_stringattr</span><span class="p">(</span><span class="n">prod_id2</span><span class="p">,</span> <span class="n">prod_id</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="n">pcmcia_device_stringattr</span><span class="p">(</span><span class="n">prod_id3</span><span class="p">,</span> <span class="n">prod_id</span><span class="p">[</span><span class="mi">2</span><span class="p">]);</span>
<span class="n">pcmcia_device_stringattr</span><span class="p">(</span><span class="n">prod_id4</span><span class="p">,</span> <span class="n">prod_id</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pcmcia_show_resources</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">char</span> <span class="o">*</span><span class="n">str</span> <span class="o">=</span> <span class="n">buf</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">PCMCIA_NUM_RESOURCES</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
		<span class="n">str</span> <span class="o">+=</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">str</span><span class="p">,</span> <span class="s">&quot;%pr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">resource</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

	<span class="k">return</span> <span class="n">str</span> <span class="o">-</span> <span class="n">buf</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pcmcia_show_pm_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;off</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;on</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pcmcia_store_pm_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span>
				     <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">((</span><span class="o">!</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;off&quot;</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">runtime_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">strncmp</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;on&quot;</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">runtime_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ret</span> <span class="o">?</span> <span class="n">ret</span> <span class="o">:</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">modalias_show</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">hash</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">};</span>

	<span class="cm">/* calculate hashes */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
			<span class="k">continue</span><span class="p">;</span>
		<span class="n">hash</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">crc32</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
				<span class="n">strlen</span><span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">prod_id</span><span class="p">[</span><span class="n">i</span><span class="p">]));</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot;pcmcia:m%04Xc%04Xf%02Xfn%02Xpfn%02X&quot;</span>
				<span class="s">&quot;pa%08Xpb%08Xpc%08Xpd%08X</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">has_manf_id</span> <span class="o">?</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">manf_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">has_card_id</span> <span class="o">?</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">card_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">has_func_id</span> <span class="o">?</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">func_id</span> <span class="o">:</span> <span class="mi">0</span><span class="p">,</span>
				<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">,</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">device_no</span><span class="p">,</span>
				<span class="n">hash</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">hash</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">hash</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">hash</span><span class="p">[</span><span class="mi">3</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">ssize_t</span> <span class="nf">pcmcia_store_allow_func_id_match</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
		<span class="k">struct</span> <span class="n">device_attribute</span> <span class="o">*</span><span class="n">attr</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">,</span> <span class="kt">size_t</span> <span class="n">count</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">allow_func_id_match</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="n">pcmcia_parse_uevents</span><span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="n">PCMCIA_UEVENT_REQUERY</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">count</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">device_attribute</span> <span class="n">pcmcia_dev_attrs</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">function</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">func_show</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">pm_state</span><span class="p">,</span> <span class="mo">0644</span><span class="p">,</span> <span class="n">pcmcia_show_pm_state</span><span class="p">,</span> <span class="n">pcmcia_store_pm_state</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">resources</span><span class="p">,</span> <span class="mo">0444</span><span class="p">,</span> <span class="n">pcmcia_show_resources</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">func_id</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">manf_id</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">card_id</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">prod_id1</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">prod_id2</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">prod_id3</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">prod_id4</span><span class="p">),</span>
	<span class="n">__ATTR_RO</span><span class="p">(</span><span class="n">modalias</span><span class="p">),</span>
	<span class="n">__ATTR</span><span class="p">(</span><span class="n">allow_func_id_match</span><span class="p">,</span> <span class="mo">0200</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">pcmcia_store_allow_func_id_match</span><span class="p">),</span>
	<span class="n">__ATTR_NULL</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/* PM support, also needed for reset */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_dev_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">pm_message_t</span> <span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="o">*</span><span class="n">p_drv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;suspending</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="n">p_drv</span> <span class="o">=</span> <span class="n">to_pcmcia_drv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_drv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">suspend</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
				   <span class="s">&quot;pcmcia: device %s (driver %s) did &quot;</span>
				   <span class="s">&quot;not want to go to sleep (%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
				   <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">devname</span><span class="p">,</span> <span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
			<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
			<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
			<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">device_no</span> <span class="o">==</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;releasing configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pcmcia_release_configuration</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_dev_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pcmcia_driver</span> <span class="o">*</span><span class="n">p_drv</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">suspended</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resuming</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">)</span>
		<span class="n">p_drv</span> <span class="o">=</span> <span class="n">to_pcmcia_drv</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_drv</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">device_no</span> <span class="o">==</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">func</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_dbg</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;requesting configuration</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_enable_device</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">p_drv</span><span class="o">-&gt;</span><span class="n">resume</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_bus_suspend_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span> <span class="o">=</span> <span class="n">_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span> <span class="o">!=</span> <span class="n">skt</span> <span class="o">||</span> <span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">runtime_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_bus_resume_callback</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span> <span class="n">_data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span> <span class="o">=</span> <span class="n">_data</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span> <span class="o">=</span> <span class="n">to_pcmcia_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span> <span class="o">!=</span> <span class="n">skt</span> <span class="o">||</span> <span class="o">!</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">suspended</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">runtime_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_bus_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;resuming socket %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
	<span class="n">bus_for_each_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">skt</span><span class="p">,</span> <span class="n">pcmcia_bus_resume_callback</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_bus_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;suspending socket %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">skt</span><span class="o">-&gt;</span><span class="n">sock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">bus_for_each_dev</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia_bus_type</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">skt</span><span class="p">,</span>
			     <span class="n">pcmcia_bus_suspend_callback</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">pcmcia_bus_resume</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_bus_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pcmcia_card_remove</span><span class="p">(</span><span class="n">skt</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="n">destroy_cis_cache</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>
	<span class="n">pcmcia_cleanup_irq</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_bus_add</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">pcmcia_pfc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">destroy_cis_cache</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span> <span class="cm">/* to be on the safe side... */</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

	<span class="n">pcmcia_card_add</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcmcia_bus_early_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">skt</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">verify_cis_cache</span><span class="p">(</span><span class="n">skt</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">dev_dbg</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;cis mismatch - different card</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* first, remove the card */</span>
	<span class="n">pcmcia_bus_remove</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>

	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>
	<span class="n">destroy_cis_cache</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>
	<span class="n">kfree</span><span class="p">(</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">fake_cis</span><span class="p">);</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">fake_cis</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">skt</span><span class="o">-&gt;</span><span class="n">functions</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">skt</span><span class="o">-&gt;</span><span class="n">ops_mutex</span><span class="p">);</span>

	<span class="cm">/* now, add the new card */</span>
	<span class="n">pcmcia_bus_add</span><span class="p">(</span><span class="n">skt</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * NOTE: This is racy. There&#39;s no guarantee the card will still be</span>
<span class="cm"> * physically present, even if the call to this function returns</span>
<span class="cm"> * non-NULL. Furthermore, the device driver most likely is unbound</span>
<span class="cm"> * almost immediately, so the timeframe where pcmcia_dev_present</span>
<span class="cm"> * returns NULL is probably really really small.</span>
<span class="cm"> */</span>
<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="nf">pcmcia_dev_present</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">_p_dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">p_dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pcmcia_device</span> <span class="o">*</span><span class="n">ret</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="n">p_dev</span> <span class="o">=</span> <span class="n">pcmcia_get_dev</span><span class="p">(</span><span class="n">_p_dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">p_dev</span><span class="p">)</span>
		<span class="k">return</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p_dev</span><span class="o">-&gt;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="n">p_dev</span><span class="p">;</span>

	<span class="n">pcmcia_put_dev</span><span class="p">(</span><span class="n">p_dev</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL</span><span class="p">(</span><span class="n">pcmcia_dev_present</span><span class="p">);</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pcmcia_callback</span> <span class="n">pcmcia_bus_callback</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add</span> <span class="o">=</span> <span class="n">pcmcia_bus_add</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">pcmcia_bus_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">requery</span> <span class="o">=</span> <span class="n">pcmcia_requery</span><span class="p">,</span>
	<span class="p">.</span><span class="n">validate</span> <span class="o">=</span> <span class="n">pccard_validate_cis</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">pcmcia_bus_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">early_resume</span> <span class="o">=</span> <span class="n">pcmcia_bus_early_resume</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">pcmcia_bus_resume</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__devinit</span> <span class="nf">pcmcia_bus_add_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
					   <span class="k">struct</span> <span class="n">class_interface</span> <span class="o">*</span><span class="n">class_intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">socket</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">socket</span> <span class="o">=</span> <span class="n">pcmcia_get_socket</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">socket</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;PCMCIA obtaining reference to socket failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">sysfs_create_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccard_cis_attr</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCMCIA registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pcmcia_put_socket</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">INIT_LIST_HEAD</span><span class="p">(</span><span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">devices_list</span><span class="p">);</span>
	<span class="n">socket</span><span class="o">-&gt;</span><span class="n">pcmcia_pfc</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">socket</span><span class="o">-&gt;</span><span class="n">device_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">present</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">pccard_register_pcmcia</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pcmcia_bus_callback</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_ERR</span><span class="p">,</span> <span class="n">dev</span><span class="p">,</span> <span class="s">&quot;PCMCIA registration failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pcmcia_put_socket</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcmcia_bus_remove_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span>
				     <span class="k">struct</span> <span class="n">class_interface</span> <span class="o">*</span><span class="n">class_intf</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">socket</span> <span class="o">=</span> <span class="n">dev_get_drvdata</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">socket</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="n">pccard_register_pcmcia</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* unregister any unbound devices */</span>
	<span class="n">mutex_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">skt_mutex</span><span class="p">);</span>
	<span class="n">pcmcia_card_remove</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
	<span class="n">release_cis_mem</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
	<span class="n">mutex_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">skt_mutex</span><span class="p">);</span>

	<span class="n">sysfs_remove_bin_file</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">kobj</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">pccard_cis_attr</span><span class="p">);</span>

	<span class="n">pcmcia_put_socket</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>

	<span class="k">return</span><span class="p">;</span>
<span class="p">}</span>


<span class="cm">/* the pcmcia_bus_interface is used to handle pcmcia socket devices */</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">class_interface</span> <span class="n">pcmcia_bus_interface</span> <span class="n">__refdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">class</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcmcia_socket_class</span><span class="p">,</span>
	<span class="p">.</span><span class="n">add_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcmcia_bus_add_socket</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove_dev</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcmcia_bus_remove_socket</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">struct</span> <span class="n">bus_type</span> <span class="n">pcmcia_bus_type</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;pcmcia&quot;</span><span class="p">,</span>
	<span class="p">.</span><span class="n">uevent</span> <span class="o">=</span> <span class="n">pcmcia_bus_uevent</span><span class="p">,</span>
	<span class="p">.</span><span class="n">match</span> <span class="o">=</span> <span class="n">pcmcia_bus_match</span><span class="p">,</span>
	<span class="p">.</span><span class="n">dev_attrs</span> <span class="o">=</span> <span class="n">pcmcia_dev_attrs</span><span class="p">,</span>
	<span class="p">.</span><span class="n">probe</span> <span class="o">=</span> <span class="n">pcmcia_device_probe</span><span class="p">,</span>
	<span class="p">.</span><span class="n">remove</span> <span class="o">=</span> <span class="n">pcmcia_device_remove</span><span class="p">,</span>
	<span class="p">.</span><span class="n">suspend</span> <span class="o">=</span> <span class="n">pcmcia_dev_suspend</span><span class="p">,</span>
	<span class="p">.</span><span class="n">resume</span> <span class="o">=</span> <span class="n">pcmcia_dev_resume</span><span class="p">,</span>
<span class="p">};</span>


<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_pcmcia_bus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">ret</span> <span class="o">=</span> <span class="n">bus_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia_bus_type</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span> <span class="s">&quot;pcmcia: bus_register error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">class_interface_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia_bus_interface</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">ret</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="n">KERN_WARNING</span>
			<span class="s">&quot;pcmcia: class_interface_register error: %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ret</span><span class="p">);</span>
		<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia_bus_type</span><span class="p">);</span>
		<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">fs_initcall</span><span class="p">(</span><span class="n">init_pcmcia_bus</span><span class="p">);</span> <span class="cm">/* one level after subsys_initcall so that</span>
<span class="cm">			       * pcmcia_socket_class is already registered */</span>


<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_pcmcia_bus</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">class_interface_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia_bus_interface</span><span class="p">);</span>

	<span class="n">bus_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pcmcia_bus_type</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_pcmcia_bus</span><span class="p">);</span>


<span class="n">MODULE_ALIAS</span><span class="p">(</span><span class="s">&quot;ds&quot;</span><span class="p">);</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
