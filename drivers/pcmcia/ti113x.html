<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pcmcia › ti113x.h

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>ti113x.h</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * ti113x.h 1.16 1999/10/25 20:03:34</span>
<span class="cm"> *</span>
<span class="cm"> * The contents of this file are subject to the Mozilla Public License</span>
<span class="cm"> * Version 1.1 (the &quot;License&quot;); you may not use this file except in</span>
<span class="cm"> * compliance with the License. You may obtain a copy of the License</span>
<span class="cm"> * at http://www.mozilla.org/MPL/</span>
<span class="cm"> *</span>
<span class="cm"> * Software distributed under the License is distributed on an &quot;AS IS&quot;</span>
<span class="cm"> * basis, WITHOUT WARRANTY OF ANY KIND, either express or implied. See</span>
<span class="cm"> * the License for the specific language governing rights and</span>
<span class="cm"> * limitations under the License. </span>
<span class="cm"> *</span>
<span class="cm"> * The initial developer of the original code is David A. Hinds</span>
<span class="cm"> * &lt;dahinds@users.sourceforge.net&gt;.  Portions created by David A. Hinds</span>
<span class="cm"> * are Copyright (C) 1999 David A. Hinds.  All Rights Reserved.</span>
<span class="cm"> *</span>
<span class="cm"> * Alternatively, the contents of this file may be used under the</span>
<span class="cm"> * terms of the GNU General Public License version 2 (the &quot;GPL&quot;), in which</span>
<span class="cm"> * case the provisions of the GPL are applicable instead of the</span>
<span class="cm"> * above.  If you wish to allow the use of your version of this file</span>
<span class="cm"> * only under the terms of the GPL and not to allow others to use</span>
<span class="cm"> * your version of this file under the MPL, indicate your decision by</span>
<span class="cm"> * deleting the provisions above and replace them with the notice and</span>
<span class="cm"> * other provisions required by the GPL.  If you do not delete the</span>
<span class="cm"> * provisions above, a recipient may use your version of this file</span>
<span class="cm"> * under either the MPL or the GPL.</span>
<span class="cm"> */</span>

<span class="cp">#ifndef _LINUX_TI113X_H</span>
<span class="cp">#define _LINUX_TI113X_H</span>


<span class="cm">/* Register definitions for TI 113X PCI-to-CardBus bridges */</span>

<span class="cm">/* System Control Register */</span>
<span class="cp">#define TI113X_SYSTEM_CONTROL		0x0080	</span><span class="cm">/* 32 bit */</span><span class="cp"></span>
<span class="cp">#define  TI113X_SCR_SMIROUTE		0x04000000</span>
<span class="cp">#define  TI113X_SCR_SMISTATUS		0x02000000</span>
<span class="cp">#define  TI113X_SCR_SMIENB		0x01000000</span>
<span class="cp">#define  TI113X_SCR_VCCPROT		0x00200000</span>
<span class="cp">#define  TI113X_SCR_REDUCEZV		0x00100000</span>
<span class="cp">#define  TI113X_SCR_CDREQEN		0x00080000</span>
<span class="cp">#define  TI113X_SCR_CDMACHAN		0x00070000</span>
<span class="cp">#define  TI113X_SCR_SOCACTIVE		0x00002000</span>
<span class="cp">#define  TI113X_SCR_PWRSTREAM		0x00000800</span>
<span class="cp">#define  TI113X_SCR_DELAYUP		0x00000400</span>
<span class="cp">#define  TI113X_SCR_DELAYDOWN		0x00000200</span>
<span class="cp">#define  TI113X_SCR_INTERROGATE		0x00000100</span>
<span class="cp">#define  TI113X_SCR_CLKRUN_SEL		0x00000080</span>
<span class="cp">#define  TI113X_SCR_PWRSAVINGS		0x00000040</span>
<span class="cp">#define  TI113X_SCR_SUBSYSRW		0x00000020</span>
<span class="cp">#define  TI113X_SCR_CB_DPAR		0x00000010</span>
<span class="cp">#define  TI113X_SCR_CDMA_EN		0x00000008</span>
<span class="cp">#define  TI113X_SCR_ASYNC_IRQ		0x00000004</span>
<span class="cp">#define  TI113X_SCR_KEEPCLK		0x00000002</span>
<span class="cp">#define  TI113X_SCR_CLKRUN_ENA		0x00000001  </span>

<span class="cp">#define  TI122X_SCR_SER_STEP		0xc0000000</span>
<span class="cp">#define  TI122X_SCR_INTRTIE		0x20000000</span>
<span class="cp">#define  TIXX21_SCR_TIEALL		0x10000000</span>
<span class="cp">#define  TI122X_SCR_CBRSVD		0x00400000</span>
<span class="cp">#define  TI122X_SCR_MRBURSTDN		0x00008000</span>
<span class="cp">#define  TI122X_SCR_MRBURSTUP		0x00004000</span>
<span class="cp">#define  TI122X_SCR_RIMUX		0x00000001</span>

<span class="cm">/* Multimedia Control Register */</span>
<span class="cp">#define TI1250_MULTIMEDIA_CTL		0x0084	</span><span class="cm">/* 8 bit */</span><span class="cp"></span>
<span class="cp">#define  TI1250_MMC_ZVOUTEN		0x80</span>
<span class="cp">#define  TI1250_MMC_PORTSEL		0x40</span>
<span class="cp">#define  TI1250_MMC_ZVEN1		0x02</span>
<span class="cp">#define  TI1250_MMC_ZVEN0		0x01</span>

<span class="cp">#define TI1250_GENERAL_STATUS		0x0085	</span><span class="cm">/* 8 bit */</span><span class="cp"></span>
<span class="cp">#define TI1250_GPIO0_CONTROL		0x0088	</span><span class="cm">/* 8 bit */</span><span class="cp"></span>
<span class="cp">#define TI1250_GPIO1_CONTROL		0x0089	</span><span class="cm">/* 8 bit */</span><span class="cp"></span>
<span class="cp">#define TI1250_GPIO2_CONTROL		0x008a	</span><span class="cm">/* 8 bit */</span><span class="cp"></span>
<span class="cp">#define TI1250_GPIO3_CONTROL		0x008b	</span><span class="cm">/* 8 bit */</span><span class="cp"></span>
<span class="cp">#define TI1250_GPIO_MODE_MASK		0xc0</span>

<span class="cm">/* IRQMUX/MFUNC Register */</span>
<span class="cp">#define TI122X_MFUNC			0x008c	</span><span class="cm">/* 32 bit */</span><span class="cp"></span>
<span class="cp">#define TI122X_MFUNC0_MASK		0x0000000f</span>
<span class="cp">#define TI122X_MFUNC1_MASK		0x000000f0</span>
<span class="cp">#define TI122X_MFUNC2_MASK		0x00000f00</span>
<span class="cp">#define TI122X_MFUNC3_MASK		0x0000f000</span>
<span class="cp">#define TI122X_MFUNC4_MASK		0x000f0000</span>
<span class="cp">#define TI122X_MFUNC5_MASK		0x00f00000</span>
<span class="cp">#define TI122X_MFUNC6_MASK		0x0f000000</span>

<span class="cp">#define TI122X_MFUNC0_INTA		0x00000002</span>
<span class="cp">#define TI125X_MFUNC0_INTB		0x00000001</span>
<span class="cp">#define TI122X_MFUNC1_INTB		0x00000020</span>
<span class="cp">#define TI122X_MFUNC3_IRQSER		0x00001000</span>


<span class="cm">/* Retry Status Register */</span>
<span class="cp">#define TI113X_RETRY_STATUS		0x0090	</span><span class="cm">/* 8 bit */</span><span class="cp"></span>
<span class="cp">#define  TI113X_RSR_PCIRETRY		0x80</span>
<span class="cp">#define  TI113X_RSR_CBRETRY		0x40</span>
<span class="cp">#define  TI113X_RSR_TEXP_CBB		0x20</span>
<span class="cp">#define  TI113X_RSR_MEXP_CBB		0x10</span>
<span class="cp">#define  TI113X_RSR_TEXP_CBA		0x08</span>
<span class="cp">#define  TI113X_RSR_MEXP_CBA		0x04</span>
<span class="cp">#define  TI113X_RSR_TEXP_PCI		0x02</span>
<span class="cp">#define  TI113X_RSR_MEXP_PCI		0x01</span>

<span class="cm">/* Card Control Register */</span>
<span class="cp">#define TI113X_CARD_CONTROL		0x0091	</span><span class="cm">/* 8 bit */</span><span class="cp"></span>
<span class="cp">#define  TI113X_CCR_RIENB		0x80</span>
<span class="cp">#define  TI113X_CCR_ZVENABLE		0x40</span>
<span class="cp">#define  TI113X_CCR_PCI_IRQ_ENA		0x20</span>
<span class="cp">#define  TI113X_CCR_PCI_IREQ		0x10</span>
<span class="cp">#define  TI113X_CCR_PCI_CSC		0x08</span>
<span class="cp">#define  TI113X_CCR_SPKROUTEN		0x02</span>
<span class="cp">#define  TI113X_CCR_IFG			0x01</span>

<span class="cp">#define  TI1220_CCR_PORT_SEL		0x20</span>
<span class="cp">#define  TI122X_CCR_AUD2MUX		0x04</span>

<span class="cm">/* Device Control Register */</span>
<span class="cp">#define TI113X_DEVICE_CONTROL		0x0092	</span><span class="cm">/* 8 bit */</span><span class="cp"></span>
<span class="cp">#define  TI113X_DCR_5V_FORCE		0x40</span>
<span class="cp">#define  TI113X_DCR_3V_FORCE		0x20</span>
<span class="cp">#define  TI113X_DCR_IMODE_MASK		0x06</span>
<span class="cp">#define  TI113X_DCR_IMODE_ISA		0x02</span>
<span class="cp">#define  TI113X_DCR_IMODE_SERIAL	0x04</span>

<span class="cp">#define  TI12XX_DCR_IMODE_PCI_ONLY	0x00</span>
<span class="cp">#define  TI12XX_DCR_IMODE_ALL_SERIAL	0x06</span>

<span class="cm">/* Buffer Control Register */</span>
<span class="cp">#define TI113X_BUFFER_CONTROL		0x0093	</span><span class="cm">/* 8 bit */</span><span class="cp"></span>
<span class="cp">#define  TI113X_BCR_CB_READ_DEPTH	0x08</span>
<span class="cp">#define  TI113X_BCR_CB_WRITE_DEPTH	0x04</span>
<span class="cp">#define  TI113X_BCR_PCI_READ_DEPTH	0x02</span>
<span class="cp">#define  TI113X_BCR_PCI_WRITE_DEPTH	0x01</span>

<span class="cm">/* Diagnostic Register */</span>
<span class="cp">#define TI1250_DIAGNOSTIC		0x0093	</span><span class="cm">/* 8 bit */</span><span class="cp"></span>
<span class="cp">#define  TI1250_DIAG_TRUE_VALUE		0x80</span>
<span class="cp">#define  TI1250_DIAG_PCI_IREQ		0x40</span>
<span class="cp">#define  TI1250_DIAG_PCI_CSC		0x20</span>
<span class="cp">#define  TI1250_DIAG_ASYNC_CSC		0x01</span>

<span class="cm">/* DMA Registers */</span>
<span class="cp">#define TI113X_DMA_0			0x0094	</span><span class="cm">/* 32 bit */</span><span class="cp"></span>
<span class="cp">#define TI113X_DMA_1			0x0098	</span><span class="cm">/* 32 bit */</span><span class="cp"></span>

<span class="cm">/* ExCA IO offset registers */</span>
<span class="cp">#define TI113X_IO_OFFSET(map)		(0x36+((map)&lt;&lt;1))</span>

<span class="cm">/* EnE test register */</span>
<span class="cp">#define ENE_TEST_C9			0xc9	</span><span class="cm">/* 8bit */</span><span class="cp"></span>
<span class="cp">#define ENE_TEST_C9_TLTENABLE		0x02</span>
<span class="cp">#define ENE_TEST_C9_PFENABLE_F0		0x04</span>
<span class="cp">#define ENE_TEST_C9_PFENABLE_F1		0x08</span>
<span class="cp">#define ENE_TEST_C9_PFENABLE		(ENE_TEST_C9_PFENABLE_F0 | ENE_TEST_C9_PFENABLE_F1)</span>
<span class="cp">#define ENE_TEST_C9_WPDISALBLE_F0	0x40</span>
<span class="cp">#define ENE_TEST_C9_WPDISALBLE_F1	0x80</span>
<span class="cp">#define ENE_TEST_C9_WPDISALBLE		(ENE_TEST_C9_WPDISALBLE_F0 | ENE_TEST_C9_WPDISALBLE_F1)</span>

<span class="cm">/*</span>
<span class="cm"> * Texas Instruments CardBus controller overrides.</span>
<span class="cm"> */</span>
<span class="cp">#define ti_sysctl(socket)	((socket)-&gt;private[0])</span>
<span class="cp">#define ti_cardctl(socket)	((socket)-&gt;private[1])</span>
<span class="cp">#define ti_devctl(socket)	((socket)-&gt;private[2])</span>
<span class="cp">#define ti_diag(socket)		((socket)-&gt;private[3])</span>
<span class="cp">#define ti_mfunc(socket)	((socket)-&gt;private[4])</span>
<span class="cp">#define ene_test_c9(socket)	((socket)-&gt;private[5])</span>

<span class="cm">/*</span>
<span class="cm"> * These are the TI specific power management handlers.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_save_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">ti_sysctl</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="o">=</span> <span class="n">config_readl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_SYSTEM_CONTROL</span><span class="p">);</span>
	<span class="n">ti_mfunc</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="o">=</span> <span class="n">config_readl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI122X_MFUNC</span><span class="p">);</span>
	<span class="n">ti_cardctl</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_CARD_CONTROL</span><span class="p">);</span>
	<span class="n">ti_devctl</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_DEVICE_CONTROL</span><span class="p">);</span>
	<span class="n">ti_diag</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI1250_DIAGNOSTIC</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_ENE</span><span class="p">)</span>
		<span class="n">ene_test_c9</span><span class="p">(</span><span class="n">socket</span><span class="p">)</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">ENE_TEST_C9</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_restore_state</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">config_writel</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_SYSTEM_CONTROL</span><span class="p">,</span> <span class="n">ti_sysctl</span><span class="p">(</span><span class="n">socket</span><span class="p">));</span>
	<span class="n">config_writel</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI122X_MFUNC</span><span class="p">,</span> <span class="n">ti_mfunc</span><span class="p">(</span><span class="n">socket</span><span class="p">));</span>
	<span class="n">config_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_CARD_CONTROL</span><span class="p">,</span> <span class="n">ti_cardctl</span><span class="p">(</span><span class="n">socket</span><span class="p">));</span>
	<span class="n">config_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_DEVICE_CONTROL</span><span class="p">,</span> <span class="n">ti_devctl</span><span class="p">(</span><span class="n">socket</span><span class="p">));</span>
	<span class="n">config_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI1250_DIAGNOSTIC</span><span class="p">,</span> <span class="n">ti_diag</span><span class="p">(</span><span class="n">socket</span><span class="p">));</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_ENE</span><span class="p">)</span>
		<span class="n">config_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">ENE_TEST_C9</span><span class="p">,</span> <span class="n">ene_test_c9</span><span class="p">(</span><span class="n">socket</span><span class="p">));</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	Zoom video control for TI122x/113x chips</span>
<span class="cm"> */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_zoom_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">yenta_socket</span><span class="p">,</span> <span class="n">socket</span><span class="p">);</span>

	<span class="cm">/* If we don&#39;t have a Zoom Video switch this is harmless,</span>
<span class="cm">	   we just tristate the unused (ZV) lines */</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_CARD_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">onoff</span><span class="p">)</span>
		<span class="cm">/* Zoom zoom, we will all go together, zoom zoom, zoom zoom */</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">TI113X_CCR_ZVENABLE</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TI113X_CCR_ZVENABLE</span><span class="p">;</span>
	<span class="n">config_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_CARD_CONTROL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> *	The 145x series can also use this. They have an additional</span>
<span class="cm"> *	ZV autodetect mode we don&#39;t use but don&#39;t actually need.</span>
<span class="cm"> *	FIXME: manual says its in func0 and func1 but disagrees with</span>
<span class="cm"> *	itself about this - do we need to force func0, if so we need</span>
<span class="cm"> *	to know a lot more about socket pairings in pcmcia_socket than</span>
<span class="cm"> *	we do now.. uggh.</span>
<span class="cm"> */</span>
 
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti1250_zoom_video</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">onoff</span><span class="p">)</span>
<span class="p">{</span>	
	<span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">yenta_socket</span><span class="p">,</span> <span class="n">socket</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">shift</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">reg</span><span class="p">;</span>

	<span class="n">ti_zoom_video</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">onoff</span><span class="p">);</span>

	<span class="n">reg</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI1250_MULTIMEDIA_CTL</span><span class="p">);</span>
	<span class="n">reg</span> <span class="o">|=</span> <span class="n">TI1250_MMC_ZVOUTEN</span><span class="p">;</span>	<span class="cm">/* ZV bus enable */</span>

	<span class="k">if</span><span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span><span class="o">==</span><span class="mi">1</span><span class="p">)</span>
		<span class="n">shift</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	
	<span class="k">if</span><span class="p">(</span><span class="n">onoff</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">);</span> 	<span class="cm">/* Clear select bit */</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">shift</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">;</span>	<span class="cm">/* Favour our socket */</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">shift</span><span class="p">;</span>	<span class="cm">/* Socket zoom video on */</span>
	<span class="p">}</span>
	<span class="k">else</span>
	<span class="p">{</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">);</span> 	<span class="cm">/* Clear select bit */</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">^</span><span class="n">shift</span><span class="p">)</span><span class="o">&lt;&lt;</span><span class="mi">6</span><span class="p">;</span>	<span class="cm">/* Favour other socket */</span>
		<span class="n">reg</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">shift</span><span class="p">);</span>	<span class="cm">/* Socket zoon video off */</span>
	<span class="p">}</span>

	<span class="n">config_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI1250_MULTIMEDIA_CTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti_set_zv</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span><span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">vendor</span> <span class="o">==</span> <span class="n">PCI_VENDOR_ID_TI</span><span class="p">)</span>
	<span class="p">{</span>
		<span class="k">switch</span><span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
		<span class="p">{</span>
			<span class="cm">/* There may be more .. */</span>
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1220</span>:
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1221</span>:
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1225</span>:
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_4510</span>:
				<span class="n">socket</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">zoom_video</span> <span class="o">=</span> <span class="n">ti_zoom_video</span><span class="p">;</span>
				<span class="k">break</span><span class="p">;</span>	
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1250</span>:
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251A</span>:
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251B</span>:
			<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1450</span>:
				<span class="n">socket</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">zoom_video</span> <span class="o">=</span> <span class="n">ti1250_zoom_video</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/*</span>
<span class="cm"> * Generic TI init - TI has an extension for the</span>
<span class="cm"> * INTCTL register that sets the PCI CSC interrupt.</span>
<span class="cm"> * Make sure we set it correctly at open and init</span>
<span class="cm"> * time</span>
<span class="cm"> * - override: disable the PCI CSC interrupt. This makes</span>
<span class="cm"> *   it possible to use the CSC interrupt to probe the</span>
<span class="cm"> *   ISA interrupts.</span>
<span class="cm"> * - init: set the interrupt to match our PCI state.</span>
<span class="cm"> *   This makes us correctly get PCI CSC interrupt</span>
<span class="cm"> *   events.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">new</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">exca_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">I365_INTCTL</span><span class="p">);</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">I365_INTR_ENA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">new</span> <span class="o">|=</span> <span class="n">I365_INTR_ENA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">!=</span> <span class="n">reg</span><span class="p">)</span>
		<span class="n">exca_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">I365_INTCTL</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">new</span><span class="p">,</span> <span class="n">reg</span> <span class="o">=</span> <span class="n">exca_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">I365_INTCTL</span><span class="p">);</span>

	<span class="n">new</span> <span class="o">=</span> <span class="n">reg</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">I365_INTR_ENA</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">new</span> <span class="o">!=</span> <span class="n">reg</span><span class="p">)</span>
		<span class="n">exca_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">I365_INTCTL</span><span class="p">,</span> <span class="n">new</span><span class="p">);</span>

	<span class="n">ti_set_zv</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti113x_use_isa_irq</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">isa_irq</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">intctl</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">isa_irq_mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isa_probe</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="cm">/* get a free isa int */</span>
	<span class="n">isa_irq_mask</span> <span class="o">=</span> <span class="n">yenta_probe_irq</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">isa_interrupts</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isa_irq_mask</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span> <span class="cm">/* no useable isa irq found */</span>

	<span class="cm">/* choose highest available */</span>
	<span class="k">for</span> <span class="p">(;</span> <span class="n">isa_irq_mask</span><span class="p">;</span> <span class="n">isa_irq</span><span class="o">++</span><span class="p">)</span>
		<span class="n">isa_irq_mask</span> <span class="o">&gt;&gt;=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">socket</span><span class="o">-&gt;</span><span class="n">cb_irq</span> <span class="o">=</span> <span class="n">isa_irq</span><span class="p">;</span>

	<span class="n">exca_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">I365_CSCINT</span><span class="p">,</span> <span class="p">(</span><span class="n">isa_irq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>

	<span class="n">intctl</span> <span class="o">=</span> <span class="n">exca_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">I365_INTCTL</span><span class="p">);</span>
	<span class="n">intctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">I365_INTR_ENA</span> <span class="o">|</span> <span class="n">I365_IRQ_MASK</span><span class="p">);</span>     <span class="cm">/* CSC Enable */</span>
	<span class="n">exca_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">I365_INTCTL</span><span class="p">,</span> <span class="n">intctl</span><span class="p">);</span>

	<span class="n">dev_info</span><span class="p">(</span><span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		<span class="s">&quot;Yenta TI113x: using isa irq %d for CardBus</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">isa_irq</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti113x_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">cardctl</span><span class="p">;</span>

	<span class="n">cardctl</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_CARD_CONTROL</span><span class="p">);</span>
	<span class="n">cardctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">TI113X_CCR_PCI_IRQ_ENA</span> <span class="o">|</span> <span class="n">TI113X_CCR_PCI_IREQ</span> <span class="o">|</span> <span class="n">TI113X_CCR_PCI_CSC</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">)</span>
		<span class="n">cardctl</span> <span class="o">|=</span> <span class="n">TI113X_CCR_PCI_IRQ_ENA</span> <span class="o">|</span> <span class="n">TI113X_CCR_PCI_CSC</span> <span class="o">|</span> <span class="n">TI113X_CCR_PCI_IREQ</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">ti113x_use_isa_irq</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>

	<span class="n">config_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_CARD_CONTROL</span><span class="p">,</span> <span class="n">cardctl</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">ti_override</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/* irqrouting for func0, probes PCI interrupt and ISA interrupts */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti12xx_irqroute_func0</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mfunc</span><span class="p">,</span> <span class="n">mfunc_old</span><span class="p">,</span> <span class="n">devctl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gpio3</span><span class="p">,</span> <span class="n">gpio3_old</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pci_irq_status</span><span class="p">;</span>

	<span class="n">mfunc</span> <span class="o">=</span> <span class="n">mfunc_old</span> <span class="o">=</span> <span class="n">config_readl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI122X_MFUNC</span><span class="p">);</span>
	<span class="n">devctl</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_DEVICE_CONTROL</span><span class="p">);</span>
	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		   <span class="s">&quot;TI: mfunc 0x%08x, devctl 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">mfunc</span><span class="p">,</span> <span class="n">devctl</span><span class="p">);</span>

	<span class="cm">/* make sure PCI interrupts are enabled before probing */</span>
	<span class="n">ti_init</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>

	<span class="cm">/* test PCI interrupts first. only try fixing if return value is 0! */</span>
	<span class="n">pci_irq_status</span> <span class="o">=</span> <span class="n">yenta_probe_cb_irq</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_irq_status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;re here which means PCI interrupts are _not_ delivered. try to</span>
<span class="cm">	 * find the right setting (all serial or parallel)</span>
<span class="cm">	 */</span>
	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		   <span class="s">&quot;TI: probing PCI interrupt failed, trying to fix</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* for serial PCI make sure MFUNC3 is set to IRQSER */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">TI113X_DCR_IMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TI12XX_DCR_IMODE_ALL_SERIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1250</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251A</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251B</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1450</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1451A</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_4450</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_4451</span>:
			<span class="cm">/* these chips have no IRQSER setting in MFUNC3  */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">mfunc</span> <span class="o">=</span> <span class="p">(</span><span class="n">mfunc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TI122X_MFUNC3_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">TI122X_MFUNC3_IRQSER</span><span class="p">;</span>

			<span class="cm">/* write down if changed, probe */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">mfunc</span> <span class="o">!=</span> <span class="n">mfunc_old</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">config_writel</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI122X_MFUNC</span><span class="p">,</span> <span class="n">mfunc</span><span class="p">);</span>

				<span class="n">pci_irq_status</span> <span class="o">=</span> <span class="n">yenta_probe_cb_irq</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
				<span class="k">if</span> <span class="p">(</span><span class="n">pci_irq_status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
					<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					    <span class="s">&quot;TI: all-serial interrupts ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
					<span class="n">mfunc_old</span> <span class="o">=</span> <span class="n">mfunc</span><span class="p">;</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
				<span class="p">}</span>

				<span class="cm">/* not working, back to old value */</span>
				<span class="n">mfunc</span> <span class="o">=</span> <span class="n">mfunc_old</span><span class="p">;</span>
				<span class="n">config_writel</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI122X_MFUNC</span><span class="p">,</span> <span class="n">mfunc</span><span class="p">);</span>

				<span class="k">if</span> <span class="p">(</span><span class="n">pci_irq_status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
					<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>
		<span class="p">}</span>

		<span class="cm">/* serial PCI interrupts not working fall back to parallel */</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;TI: falling back to parallel PCI interrupts</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">devctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TI113X_DCR_IMODE_MASK</span><span class="p">;</span>
		<span class="n">devctl</span> <span class="o">|=</span> <span class="n">TI113X_DCR_IMODE_SERIAL</span><span class="p">;</span> <span class="cm">/* serial ISA could be right */</span>
		<span class="n">config_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_DEVICE_CONTROL</span><span class="p">,</span> <span class="n">devctl</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* parallel PCI interrupts: route INTA */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1250</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251A</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251B</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1450</span>:
		<span class="cm">/* make sure GPIO3 is set to INTA */</span>
		<span class="n">gpio3</span> <span class="o">=</span> <span class="n">gpio3_old</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI1250_GPIO3_CONTROL</span><span class="p">);</span>
		<span class="n">gpio3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TI1250_GPIO_MODE_MASK</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio3</span> <span class="o">!=</span> <span class="n">gpio3_old</span><span class="p">)</span>
			<span class="n">config_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI1250_GPIO3_CONTROL</span><span class="p">,</span> <span class="n">gpio3</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="nl">default:</span>
		<span class="n">gpio3</span> <span class="o">=</span> <span class="n">gpio3_old</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="n">mfunc</span> <span class="o">=</span> <span class="p">(</span><span class="n">mfunc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TI122X_MFUNC0_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">TI122X_MFUNC0_INTA</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mfunc</span> <span class="o">!=</span> <span class="n">mfunc_old</span><span class="p">)</span>
			<span class="n">config_writel</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI122X_MFUNC</span><span class="p">,</span> <span class="n">mfunc</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* time to probe again */</span>
	<span class="n">pci_irq_status</span> <span class="o">=</span> <span class="n">yenta_probe_cb_irq</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_irq_status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mfunc_old</span> <span class="o">=</span> <span class="n">mfunc</span><span class="p">;</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;TI: parallel PCI interrupts ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="cm">/* not working, back to old value */</span>
		<span class="n">mfunc</span> <span class="o">=</span> <span class="n">mfunc_old</span><span class="p">;</span>
		<span class="n">config_writel</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI122X_MFUNC</span><span class="p">,</span> <span class="n">mfunc</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">gpio3</span> <span class="o">!=</span> <span class="n">gpio3_old</span><span class="p">)</span>
			<span class="n">config_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI1250_GPIO3_CONTROL</span><span class="p">,</span> <span class="n">gpio3_old</span><span class="p">);</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_irq_status</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">socket</span><span class="o">-&gt;</span><span class="n">cb_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;Yenta TI: no PCI interrupts. Fish. &quot;</span>
			   <span class="s">&quot;Please report.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* changes the irq of func1 to match that of func0 */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti12xx_align_irqs</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">old_irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">func0</span><span class="p">;</span>

	<span class="cm">/* find func0 device */</span>
	<span class="n">func0</span> <span class="o">=</span> <span class="n">pci_get_slot</span><span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span> <span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x07</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func0</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">old_irq</span><span class="p">)</span>
		<span class="o">*</span><span class="n">old_irq</span> <span class="o">=</span> <span class="n">socket</span><span class="o">-&gt;</span><span class="n">cb_irq</span><span class="p">;</span>
	<span class="n">socket</span><span class="o">-&gt;</span><span class="n">cb_irq</span> <span class="o">=</span> <span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">func0</span><span class="o">-&gt;</span><span class="n">irq</span><span class="p">;</span>

	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">func0</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * ties INTA and INTB together. also changes the devices irq to that of</span>
<span class="cm"> * the function 0 device. call from func1 only.</span>
<span class="cm"> * returns 1 if INTRTIE changed, 0 otherwise.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti12xx_tie_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">,</span> <span class="kt">int</span> <span class="o">*</span><span class="n">old_irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sysctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span><span class="p">;</span>

	<span class="n">sysctl</span> <span class="o">=</span> <span class="n">config_readl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_SYSTEM_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sysctl</span> <span class="o">&amp;</span> <span class="n">TI122X_SCR_INTRTIE</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* align */</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">ti12xx_align_irqs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">old_irq</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="cm">/* tie */</span>
	<span class="n">sysctl</span> <span class="o">|=</span> <span class="n">TI122X_SCR_INTRTIE</span><span class="p">;</span>
	<span class="n">config_writel</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_SYSTEM_CONTROL</span><span class="p">,</span> <span class="n">sysctl</span><span class="p">);</span>

	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* undo what ti12xx_tie_interrupts() did */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti12xx_untie_interrupts</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">,</span> <span class="kt">int</span> <span class="n">old_irq</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">sysctl</span> <span class="o">=</span> <span class="n">config_readl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_SYSTEM_CONTROL</span><span class="p">);</span>
	<span class="n">sysctl</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TI122X_SCR_INTRTIE</span><span class="p">;</span>
	<span class="n">config_writel</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_SYSTEM_CONTROL</span><span class="p">,</span> <span class="n">sysctl</span><span class="p">);</span>

	<span class="n">socket</span><span class="o">-&gt;</span><span class="n">cb_irq</span> <span class="o">=</span> <span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">irq</span> <span class="o">=</span> <span class="n">old_irq</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/* </span>
<span class="cm"> * irqrouting for func1, plays with INTB routing</span>
<span class="cm"> * only touches MFUNC for INTB routing. all other bits are taken</span>
<span class="cm"> * care of in func0 already.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">ti12xx_irqroute_func1</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">mfunc</span><span class="p">,</span> <span class="n">mfunc_old</span><span class="p">,</span> <span class="n">devctl</span><span class="p">,</span> <span class="n">sysctl</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">pci_irq_status</span><span class="p">;</span>

	<span class="n">mfunc</span> <span class="o">=</span> <span class="n">mfunc_old</span> <span class="o">=</span> <span class="n">config_readl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI122X_MFUNC</span><span class="p">);</span>
	<span class="n">devctl</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_DEVICE_CONTROL</span><span class="p">);</span>
	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		   <span class="s">&quot;TI: mfunc 0x%08x, devctl 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">mfunc</span><span class="p">,</span> <span class="n">devctl</span><span class="p">);</span>

	<span class="cm">/* if IRQs are configured as tied, align irq of func1 with func0 */</span>
	<span class="n">sysctl</span> <span class="o">=</span> <span class="n">config_readl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_SYSTEM_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sysctl</span> <span class="o">&amp;</span> <span class="n">TI122X_SCR_INTRTIE</span><span class="p">)</span>
		<span class="n">ti12xx_align_irqs</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

	<span class="cm">/* make sure PCI interrupts are enabled before probing */</span>
	<span class="n">ti_init</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>

	<span class="cm">/* test PCI interrupts first. only try fixing if return value is 0! */</span>
	<span class="n">pci_irq_status</span> <span class="o">=</span> <span class="n">yenta_probe_cb_irq</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_irq_status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * We&#39;re here which means PCI interrupts are _not_ delivered. try to</span>
<span class="cm">	 * find the right setting</span>
<span class="cm">	 */</span>
	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		   <span class="s">&quot;TI: probing PCI interrupt failed, trying to fix</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

	<span class="cm">/* if all serial: set INTRTIE, probe again */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">TI113X_DCR_IMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TI12XX_DCR_IMODE_ALL_SERIAL</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">old_irq</span><span class="p">;</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">ti12xx_tie_interrupts</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pci_irq_status</span> <span class="o">=</span> <span class="n">yenta_probe_cb_irq</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_irq_status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					<span class="s">&quot;TI: all-serial interrupts, tied ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ti12xx_untie_interrupts</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">old_irq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>
	<span class="cm">/* parallel PCI: route INTB, probe again */</span>
	<span class="k">else</span> <span class="p">{</span>
		<span class="kt">int</span> <span class="n">old_irq</span><span class="p">;</span>

		<span class="k">switch</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1250</span>:
			<span class="cm">/* the 1250 has one pin for IRQSER/INTB depending on devctl */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251A</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251B</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1450</span>:
			<span class="cm">/*</span>
<span class="cm">			 *  those have a pin for IRQSER/INTB plus INTB in MFUNC0</span>
<span class="cm">			 *  we alread probed the shared pin, now go for MFUNC0</span>
<span class="cm">			 */</span>
			<span class="n">mfunc</span> <span class="o">=</span> <span class="p">(</span><span class="n">mfunc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TI122X_MFUNC0_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">TI125X_MFUNC0_INTB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="n">mfunc</span> <span class="o">=</span> <span class="p">(</span><span class="n">mfunc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TI122X_MFUNC1_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">TI122X_MFUNC1_INTB</span><span class="p">;</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* write, probe */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">mfunc</span> <span class="o">!=</span> <span class="n">mfunc_old</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">config_writel</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI122X_MFUNC</span><span class="p">,</span> <span class="n">mfunc</span><span class="p">);</span>

			<span class="n">pci_irq_status</span> <span class="o">=</span> <span class="n">yenta_probe_cb_irq</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_irq_status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
					   <span class="s">&quot;TI: parallel PCI interrupts ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">mfunc</span> <span class="o">=</span> <span class="n">mfunc_old</span><span class="p">;</span>
			<span class="n">config_writel</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI122X_MFUNC</span><span class="p">,</span> <span class="n">mfunc</span><span class="p">);</span>

			<span class="k">if</span> <span class="p">(</span><span class="n">pci_irq_status</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* still nothing: set INTRTIE */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">ti12xx_tie_interrupts</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">old_irq</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">pci_irq_status</span> <span class="o">=</span> <span class="n">yenta_probe_cb_irq</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">pci_irq_status</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
				<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
				    <span class="s">&quot;TI: parallel PCI interrupts, tied ok</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
				<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
			<span class="p">}</span>

			<span class="n">ti12xx_untie_interrupts</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">old_irq</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">pci_irq_status</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">socket</span><span class="o">-&gt;</span><span class="n">cb_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;TI: no PCI interrupts. Fish. Please report.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>


<span class="cm">/* Returns true value if the second slot of a two-slot controller is empty */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti12xx_2nd_slot_empty</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">func</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">slot2</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">devfn</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">state</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">ret</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">u32</span> <span class="n">sysctl</span><span class="p">;</span>

	<span class="cm">/* catch the two-slot controllers */</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1220</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1221</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1225</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251A</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251B</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1420</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1450</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1451A</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1520</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1620</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_4520</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_4450</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_4451</span>:
		<span class="cm">/*</span>
<span class="cm">		 * there are way more, but they need to be added in yenta_socket.c</span>
<span class="cm">		 * and pci_ids.h first anyway.</span>
<span class="cm">		 */</span>
		<span class="k">break</span><span class="p">;</span>

	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_XX12</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_X515</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_X420</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_X620</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_XX21_XX11</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_7410</span>:
	<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_7610</span>:
		<span class="cm">/*</span>
<span class="cm">		 * those are either single or dual slot CB with additional functions</span>
<span class="cm">		 * like 1394, smartcard reader, etc. check the TIEALL flag for them</span>
<span class="cm">		 * the TIEALL flag binds the IRQ of all functions together.</span>
<span class="cm">		 * we catch the single slot variants later.</span>
<span class="cm">		 */</span>
		<span class="n">sysctl</span> <span class="o">=</span> <span class="n">config_readl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_SYSTEM_CONTROL</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">sysctl</span> <span class="o">&amp;</span> <span class="n">TIXX21_SCR_TIEALL</span><span class="p">)</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

		<span class="k">break</span><span class="p">;</span>

	<span class="cm">/* single-slot controllers have the 2nd slot empty always :) */</span>
	<span class="nl">default:</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* get other slot */</span>
	<span class="n">devfn</span> <span class="o">=</span> <span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&amp;</span> <span class="o">~</span><span class="mh">0x07</span><span class="p">;</span>
	<span class="n">func</span> <span class="o">=</span> <span class="n">pci_get_slot</span><span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="p">,</span>
	                    <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span> <span class="o">&amp;</span> <span class="mh">0x07</span><span class="p">)</span> <span class="o">?</span> <span class="n">devfn</span> <span class="o">:</span> <span class="n">devfn</span> <span class="o">|</span> <span class="mh">0x01</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">func</span><span class="p">)</span>
		<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * check that the device id of both slots match. this is needed for the</span>
<span class="cm">	 * XX21 and the XX11 controller that share the same device id for single</span>
<span class="cm">	 * and dual slot controllers. return &#39;2nd slot empty&#39;. we already checked</span>
<span class="cm">	 * if the interrupt is tied to another function.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span> <span class="o">!=</span> <span class="n">func</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">slot2</span> <span class="o">=</span> <span class="n">pci_get_drvdata</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">slot2</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* check state */</span>
	<span class="n">yenta_get_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slot2</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">state</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span> <span class="o">&amp;</span> <span class="n">SS_DETECT</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">ret</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

<span class="nl">out:</span>
	<span class="n">pci_dev_put</span><span class="p">(</span><span class="n">func</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * TI specifiy parts for the power hook.</span>
<span class="cm"> *</span>
<span class="cm"> * some TI&#39;s with some CB&#39;s produces interrupt storm on power on. it has been</span>
<span class="cm"> * seen with atheros wlan cards on TI1225 and TI1410. solution is simply to</span>
<span class="cm"> * disable any CB interrupts during this time.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti12xx_power_hook</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">operation</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">yenta_socket</span><span class="p">,</span> <span class="n">socket</span><span class="p">);</span>
	<span class="n">u32</span> <span class="n">mfunc</span><span class="p">,</span> <span class="n">devctl</span><span class="p">,</span> <span class="n">sysctl</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">gpio3</span><span class="p">;</span>

	<span class="cm">/* only POWER_PRE and POWER_POST are interesting */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">operation</span> <span class="o">!=</span> <span class="n">HOOK_POWER_PRE</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">operation</span> <span class="o">!=</span> <span class="n">HOOK_POWER_POST</span><span class="p">))</span>
		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">devctl</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_DEVICE_CONTROL</span><span class="p">);</span>
	<span class="n">sysctl</span> <span class="o">=</span> <span class="n">config_readl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_SYSTEM_CONTROL</span><span class="p">);</span>
	<span class="n">mfunc</span> <span class="o">=</span> <span class="n">config_readl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI122X_MFUNC</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * all serial/tied: only disable when modparm set. always doing it</span>
<span class="cm">	 * would mean a regression for working setups &#39;cos it disables the</span>
<span class="cm">	 * interrupts for both both slots on 2-slot controllers</span>
<span class="cm">	 * (and users of single slot controllers where it&#39;s save have to</span>
<span class="cm">	 * live with setting the modparm, most don&#39;t have to anyway)</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(((</span><span class="n">devctl</span> <span class="o">&amp;</span> <span class="n">TI113X_DCR_IMODE_MASK</span><span class="p">)</span> <span class="o">==</span> <span class="n">TI12XX_DCR_IMODE_ALL_SERIAL</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	    <span class="p">(</span><span class="n">pwr_irqs_off</span> <span class="o">||</span> <span class="n">ti12xx_2nd_slot_empty</span><span class="p">(</span><span class="n">socket</span><span class="p">)))</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1250</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251A</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251B</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1450</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1451A</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_4450</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_4451</span>:
			<span class="cm">/* these chips have no IRQSER setting in MFUNC3  */</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="n">HOOK_POWER_PRE</span><span class="p">)</span>
				<span class="n">mfunc</span> <span class="o">=</span> <span class="p">(</span><span class="n">mfunc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TI122X_MFUNC3_MASK</span><span class="p">);</span>
			<span class="k">else</span>
				<span class="n">mfunc</span> <span class="o">=</span> <span class="p">(</span><span class="n">mfunc</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TI122X_MFUNC3_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="n">TI122X_MFUNC3_IRQSER</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* do the job differently for func0/1 */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span>
	    <span class="p">((</span><span class="n">sysctl</span> <span class="o">&amp;</span> <span class="n">TI122X_SCR_INTRTIE</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	     <span class="p">(</span><span class="n">pwr_irqs_off</span> <span class="o">||</span> <span class="n">ti12xx_2nd_slot_empty</span><span class="p">(</span><span class="n">socket</span><span class="p">))))</span> <span class="p">{</span>
		<span class="cm">/* some bridges are different */</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1250</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251A</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251B</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1450</span>:
			<span class="cm">/* those oldies use gpio3 for INTA */</span>
			<span class="n">gpio3</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI1250_GPIO3_CONTROL</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="n">HOOK_POWER_PRE</span><span class="p">)</span>
				<span class="n">gpio3</span> <span class="o">=</span> <span class="p">(</span><span class="n">gpio3</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">TI1250_GPIO_MODE_MASK</span><span class="p">)</span> <span class="o">|</span> <span class="mh">0x40</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">gpio3</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TI1250_GPIO_MODE_MASK</span><span class="p">;</span>
			<span class="n">config_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI1250_GPIO3_CONTROL</span><span class="p">,</span> <span class="n">gpio3</span><span class="p">);</span>
			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="cm">/* all new bridges are the same */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="n">HOOK_POWER_PRE</span><span class="p">)</span>
				<span class="n">mfunc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TI122X_MFUNC0_MASK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mfunc</span> <span class="o">|=</span> <span class="n">TI122X_MFUNC0_INTA</span><span class="p">;</span>
			<span class="n">config_writel</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI122X_MFUNC</span><span class="p">,</span> <span class="n">mfunc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="k">switch</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">device</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251A</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1251B</span>:
		<span class="k">case</span> <span class="n">PCI_DEVICE_ID_TI_1450</span>:
			<span class="cm">/* those have INTA elsewhere and INTB in MFUNC0 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="n">HOOK_POWER_PRE</span><span class="p">)</span>
				<span class="n">mfunc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TI122X_MFUNC0_MASK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mfunc</span> <span class="o">|=</span> <span class="n">TI125X_MFUNC0_INTB</span><span class="p">;</span>
			<span class="n">config_writel</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI122X_MFUNC</span><span class="p">,</span> <span class="n">mfunc</span><span class="p">);</span>

			<span class="k">break</span><span class="p">;</span>

		<span class="nl">default:</span>
			<span class="cm">/* all new bridges are the same */</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">operation</span> <span class="o">==</span> <span class="n">HOOK_POWER_PRE</span><span class="p">)</span>
				<span class="n">mfunc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">TI122X_MFUNC1_MASK</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">mfunc</span> <span class="o">|=</span> <span class="n">TI122X_MFUNC1_INTB</span><span class="p">;</span>
			<span class="n">config_writel</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI122X_MFUNC</span><span class="p">,</span> <span class="n">mfunc</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti12xx_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u32</span> <span class="n">val</span><span class="p">,</span> <span class="n">val_orig</span><span class="p">;</span>

	<span class="cm">/* make sure that memory burst is active */</span>
	<span class="n">val_orig</span> <span class="o">=</span> <span class="n">val</span> <span class="o">=</span> <span class="n">config_readl</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_SYSTEM_CONTROL</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">disable_clkrun</span> <span class="o">&amp;&amp;</span> <span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;Disabling CLKRUN feature</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TI113X_SCR_KEEPCLK</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TI122X_SCR_MRBURSTUP</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;Enabling burst memory read transactions</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">val</span> <span class="o">|=</span> <span class="n">TI122X_SCR_MRBURSTUP</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">val_orig</span> <span class="o">!=</span> <span class="n">val</span><span class="p">)</span>
		<span class="n">config_writel</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI113X_SYSTEM_CONTROL</span><span class="p">,</span> <span class="n">val</span><span class="p">);</span>

	<span class="cm">/*</span>
<span class="cm">	 * Yenta expects controllers to use CSCINT to route</span>
<span class="cm">	 * CSC interrupts to PCI rather than INTVAL.</span>
<span class="cm">	 */</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI1250_DIAGNOSTIC</span><span class="p">);</span>
	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		   <span class="s">&quot;Using %s to route CSC interrupts to PCI</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TI1250_DIAG_PCI_CSC</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;CSCINT&quot;</span> <span class="o">:</span> <span class="s">&quot;INTVAL&quot;</span><span class="p">);</span>
	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		   <span class="s">&quot;Routing CardBus interrupts to %s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">TI1250_DIAG_PCI_IREQ</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;PCI&quot;</span> <span class="o">:</span> <span class="s">&quot;ISA&quot;</span><span class="p">);</span>

	<span class="cm">/* do irqrouting, depending on function */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">PCI_FUNC</span><span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">devfn</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">ti12xx_irqroute_func0</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">ti12xx_irqroute_func1</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>

	<span class="cm">/* install power hook */</span>
	<span class="n">socket</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">power_hook</span> <span class="o">=</span> <span class="n">ti12xx_power_hook</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ti_override</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
<span class="p">}</span>


<span class="k">static</span> <span class="kt">int</span> <span class="nf">ti1250_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">u8</span> <span class="n">old</span><span class="p">,</span> <span class="n">diag</span><span class="p">;</span>

	<span class="n">old</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI1250_DIAGNOSTIC</span><span class="p">);</span>
	<span class="n">diag</span> <span class="o">=</span> <span class="n">old</span> <span class="o">&amp;</span> <span class="o">~</span><span class="p">(</span><span class="n">TI1250_DIAG_PCI_CSC</span> <span class="o">|</span> <span class="n">TI1250_DIAG_PCI_IREQ</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">cb_irq</span><span class="p">)</span>
		<span class="n">diag</span> <span class="o">|=</span> <span class="n">TI1250_DIAG_PCI_CSC</span> <span class="o">|</span> <span class="n">TI1250_DIAG_PCI_IREQ</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">diag</span> <span class="o">!=</span> <span class="n">old</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
			   <span class="s">&quot;adjusting diagnostic: %02x -&gt; %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
			   <span class="n">old</span><span class="p">,</span> <span class="n">diag</span><span class="p">);</span>
		<span class="n">config_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">TI1250_DIAGNOSTIC</span><span class="p">,</span> <span class="n">diag</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">return</span> <span class="n">ti12xx_override</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
<span class="p">}</span>


<span class="cm">/**</span>
<span class="cm"> * EnE specific part. EnE bridges are register compatible with TI bridges but</span>
<span class="cm"> * have their own test registers and more important their own little problems.</span>
<span class="cm"> * Some fixup code to make everybody happy (TM).</span>
<span class="cm"> */</span>

<span class="cp">#ifdef CONFIG_YENTA_ENE_TUNE</span>
<span class="cm">/*</span>
<span class="cm"> * set/clear various test bits:</span>
<span class="cm"> * Defaults to clear the bit.</span>
<span class="cm"> * - mask (u8) defines what bits to change</span>
<span class="cm"> * - bits (u8) is the values to change them to</span>
<span class="cm"> * -&gt; it&#39;s</span>
<span class="cm"> * 	current = (current &amp; ~mask) | bits</span>
<span class="cm"> */</span>
<span class="cm">/* pci ids of devices that wants to have the bit set */</span>
<span class="cp">#define DEVID(_vend,_dev,_subvend,_subdev,mask,bits) {		\</span>
<span class="cp">		.vendor		= _vend,			\</span>
<span class="cp">		.device		= _dev,				\</span>
<span class="cp">		.subvendor	= _subvend,			\</span>
<span class="cp">		.subdevice	= _subdev,			\</span>
<span class="cp">		.driver_data	= ((mask) &lt;&lt; 8 | (bits)),	\</span>
<span class="cp">	}</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">pci_device_id</span> <span class="n">ene_tune_tbl</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
	<span class="cm">/* Echo Audio products based on motorola DSP56301 and DSP56361 */</span>
	<span class="n">DEVID</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MOTOROLA</span><span class="p">,</span> <span class="mh">0x1801</span><span class="p">,</span> <span class="mh">0xECC0</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="n">ENE_TEST_C9_TLTENABLE</span> <span class="o">|</span> <span class="n">ENE_TEST_C9_PFENABLE</span><span class="p">,</span> <span class="n">ENE_TEST_C9_TLTENABLE</span><span class="p">),</span>
	<span class="n">DEVID</span><span class="p">(</span><span class="n">PCI_VENDOR_ID_MOTOROLA</span><span class="p">,</span> <span class="mh">0x3410</span><span class="p">,</span> <span class="mh">0xECC0</span><span class="p">,</span> <span class="n">PCI_ANY_ID</span><span class="p">,</span>
		<span class="n">ENE_TEST_C9_TLTENABLE</span> <span class="o">|</span> <span class="n">ENE_TEST_C9_PFENABLE</span><span class="p">,</span> <span class="n">ENE_TEST_C9_TLTENABLE</span><span class="p">),</span>

	<span class="p">{}</span>
<span class="p">};</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">ene_tune_bridge</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pci_bus</span> <span class="o">*</span><span class="n">bus</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">yenta_socket</span><span class="p">,</span> <span class="n">socket</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">pci_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="n">id</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="n">u8</span> <span class="n">test_c9</span><span class="p">,</span> <span class="n">old_c9</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">bits</span><span class="p">;</span>

	<span class="n">list_for_each_entry</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">devices</span><span class="p">,</span> <span class="n">bus_list</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">id</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">pci_device_id</span> <span class="o">*</span><span class="p">)</span> <span class="n">pci_match_id</span><span class="p">(</span><span class="n">ene_tune_tbl</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">test_c9</span> <span class="o">=</span> <span class="n">old_c9</span> <span class="o">=</span> <span class="n">config_readb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">ENE_TEST_C9</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">id</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mask</span> <span class="o">=</span> <span class="p">(</span><span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>
		<span class="n">bits</span> <span class="o">=</span> <span class="n">id</span><span class="o">-&gt;</span><span class="n">driver_data</span> <span class="o">&amp;</span> <span class="mh">0xFF</span><span class="p">;</span>

		<span class="n">test_c9</span> <span class="o">=</span> <span class="p">(</span><span class="n">test_c9</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">mask</span><span class="p">)</span> <span class="o">|</span> <span class="n">bits</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">else</span>
		<span class="cm">/* default to clear TLTEnable bit, old behaviour */</span>
		<span class="n">test_c9</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">ENE_TEST_C9_TLTENABLE</span><span class="p">;</span>

	<span class="n">dev_printk</span><span class="p">(</span><span class="n">KERN_INFO</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">socket</span><span class="o">-&gt;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">,</span>
		   <span class="s">&quot;EnE: chaning testregister 0xC9, %02x -&gt; %02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
		   <span class="n">old_c9</span><span class="p">,</span> <span class="n">test_c9</span><span class="p">);</span>
	<span class="n">config_writeb</span><span class="p">(</span><span class="n">socket</span><span class="p">,</span> <span class="n">ENE_TEST_C9</span><span class="p">,</span> <span class="n">test_c9</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">ene_override</span><span class="p">(</span><span class="k">struct</span> <span class="n">yenta_socket</span> <span class="o">*</span><span class="n">socket</span><span class="p">)</span>
<span class="p">{</span>
	<span class="cm">/* install tune_bridge() function */</span>
	<span class="n">socket</span><span class="o">-&gt;</span><span class="n">socket</span><span class="p">.</span><span class="n">tune_bridge</span> <span class="o">=</span> <span class="n">ene_tune_bridge</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">ti1250_override</span><span class="p">(</span><span class="n">socket</span><span class="p">);</span>
<span class="p">}</span>
<span class="cp">#else</span>
<span class="cp">#  define ene_override ti1250_override</span>
<span class="cp">#endif </span><span class="cm">/* !CONFIG_YENTA_ENE_TUNE */</span><span class="cp"></span>

<span class="cp">#endif </span><span class="cm">/* _LINUX_TI113X_H */</span><span class="cp"></span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
