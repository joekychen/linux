<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › pcmcia › i82365.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../index.html"></a><h1>i82365.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*======================================================================</span>

<span class="cm">    Device driver for Intel 82365 and compatible PC Card controllers.</span>

<span class="cm">    i82365.c 1.265 1999/11/10 18:36:21</span>

<span class="cm">    The contents of this file are subject to the Mozilla Public</span>
<span class="cm">    License Version 1.1 (the &quot;License&quot;); you may not use this file</span>
<span class="cm">    except in compliance with the License. You may obtain a copy of</span>
<span class="cm">    the License at http://www.mozilla.org/MPL/</span>

<span class="cm">    Software distributed under the License is distributed on an &quot;AS</span>
<span class="cm">    IS&quot; basis, WITHOUT WARRANTY OF ANY KIND, either express or</span>
<span class="cm">    implied. See the License for the specific language governing</span>
<span class="cm">    rights and limitations under the License.</span>

<span class="cm">    The initial developer of the original code is David A. Hinds</span>
<span class="cm">    &lt;dahinds@users.sourceforge.net&gt;.  Portions created by David A. Hinds</span>
<span class="cm">    are Copyright (C) 1999 David A. Hinds.  All Rights Reserved.</span>

<span class="cm">    Alternatively, the contents of this file may be used under the</span>
<span class="cm">    terms of the GNU General Public License version 2 (the &quot;GPL&quot;), in which</span>
<span class="cm">    case the provisions of the GPL are applicable instead of the</span>
<span class="cm">    above.  If you wish to allow the use of your version of this file</span>
<span class="cm">    only under the terms of the GPL and not to allow others to use</span>
<span class="cm">    your version of this file under the MPL, indicate your decision</span>
<span class="cm">    by deleting the provisions above and replace them with the notice</span>
<span class="cm">    and other provisions required by the GPL.  If you do not delete</span>
<span class="cm">    the provisions above, a recipient may use your version of this</span>
<span class="cm">    file under either the MPL or the GPL.</span>
<span class="cm">    </span>
<span class="cm">======================================================================*/</span>

<span class="cp">#include &lt;linux/module.h&gt;</span>
<span class="cp">#include &lt;linux/moduleparam.h&gt;</span>
<span class="cp">#include &lt;linux/init.h&gt;</span>
<span class="cp">#include &lt;linux/types.h&gt;</span>
<span class="cp">#include &lt;linux/fcntl.h&gt;</span>
<span class="cp">#include &lt;linux/string.h&gt;</span>
<span class="cp">#include &lt;linux/kernel.h&gt;</span>
<span class="cp">#include &lt;linux/errno.h&gt;</span>
<span class="cp">#include &lt;linux/timer.h&gt;</span>
<span class="cp">#include &lt;linux/ioport.h&gt;</span>
<span class="cp">#include &lt;linux/delay.h&gt;</span>
<span class="cp">#include &lt;linux/workqueue.h&gt;</span>
<span class="cp">#include &lt;linux/interrupt.h&gt;</span>
<span class="cp">#include &lt;linux/platform_device.h&gt;</span>
<span class="cp">#include &lt;linux/bitops.h&gt;</span>
<span class="cp">#include &lt;asm/irq.h&gt;</span>
<span class="cp">#include &lt;asm/io.h&gt;</span>

<span class="cp">#include &lt;pcmcia/ss.h&gt;</span>

<span class="cp">#include &lt;linux/isapnp.h&gt;</span>

<span class="cm">/* ISA-bus controllers */</span>
<span class="cp">#include &quot;i82365.h&quot;</span>
<span class="cp">#include &quot;cirrus.h&quot;</span>
<span class="cp">#include &quot;vg468.h&quot;</span>
<span class="cp">#include &quot;ricoh.h&quot;</span>


<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="n">i365_count_irq</span><span class="p">(</span><span class="kt">int</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
<span class="k">static</span> <span class="kr">inline</span> <span class="kt">int</span> <span class="nf">_check_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">int</span> <span class="n">flags</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">i365_count_irq</span><span class="p">,</span> <span class="n">flags</span><span class="p">,</span> <span class="s">&quot;x&quot;</span><span class="p">,</span> <span class="n">i365_count_irq</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">i365_count_irq</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*====================================================================*/</span>

<span class="cm">/* Parameters that can be set with &#39;insmod&#39; */</span>

<span class="cm">/* Default base address for i82365sl and other ISA chips */</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">i365_base</span> <span class="o">=</span> <span class="mh">0x3e0</span><span class="p">;</span>
<span class="cm">/* Should we probe at 0x3e2 for an extra ISA controller? */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">extra_sockets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/* Specify a socket number to ignore */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">ignore</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="cm">/* Bit map or list of interrupts to choose from */</span>
<span class="k">static</span> <span class="n">u_int</span> <span class="n">irq_mask</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">irq_list</span><span class="p">[</span><span class="mi">16</span><span class="p">];</span>
<span class="k">static</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">irq_list_count</span><span class="p">;</span>
<span class="cm">/* The card status change interrupt -- 0 means autoselect */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cs_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="cm">/* Probe for safe interrupts? */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">do_scan</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="cm">/* Poll status interval -- 0 means default to interrupt */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">poll_interval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="cm">/* External clock time, in nanoseconds.  120 ns = 8.33 MHz */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cycle_time</span> <span class="o">=</span> <span class="mi">120</span><span class="p">;</span>

<span class="cm">/* Cirrus options */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">has_dma</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">has_led</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">has_ring</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">dynamic_mode</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">freq_bypass</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">setup_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cmd_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">recov_time</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

<span class="cm">/* Vadem options */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">async_clock</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">cable_mode</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">wakeup</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">i365_base</span><span class="p">,</span> <span class="n">ulong</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">ignore</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">extra_sockets</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">irq_mask</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param_array</span><span class="p">(</span><span class="n">irq_list</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">irq_list_count</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cs_irq</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">async_clock</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cable_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">wakeup</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="n">module_param</span><span class="p">(</span><span class="n">do_scan</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">poll_interval</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cycle_time</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">has_dma</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">has_led</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">has_ring</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">dynamic_mode</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">freq_bypass</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">setup_time</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">cmd_time</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>
<span class="n">module_param</span><span class="p">(</span><span class="n">recov_time</span><span class="p">,</span> <span class="kt">int</span><span class="p">,</span> <span class="mo">0444</span><span class="p">);</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">cirrus_state_t</span> <span class="p">{</span>
    <span class="n">u_char</span>		<span class="n">misc1</span><span class="p">,</span> <span class="n">misc2</span><span class="p">;</span>
    <span class="n">u_char</span>		<span class="n">timer</span><span class="p">[</span><span class="mi">6</span><span class="p">];</span>
<span class="p">}</span> <span class="n">cirrus_state_t</span><span class="p">;</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">vg46x_state_t</span> <span class="p">{</span>
    <span class="n">u_char</span>		<span class="n">ctl</span><span class="p">,</span> <span class="n">ema</span><span class="p">;</span>
<span class="p">}</span> <span class="n">vg46x_state_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">i82365_socket</span> <span class="p">{</span>
    <span class="n">u_short</span>		<span class="n">type</span><span class="p">,</span> <span class="n">flags</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">pcmcia_socket</span>	<span class="n">socket</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">number</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span>	<span class="n">ioaddr</span><span class="p">;</span>
    <span class="n">u_short</span>		<span class="n">psock</span><span class="p">;</span>
    <span class="n">u_char</span>		<span class="n">cs_irq</span><span class="p">,</span> <span class="n">intr</span><span class="p">;</span>
    <span class="k">union</span> <span class="p">{</span>
	<span class="n">cirrus_state_t</span>		<span class="n">cirrus</span><span class="p">;</span>
	<span class="n">vg46x_state_t</span>		<span class="n">vg46x</span><span class="p">;</span>
    <span class="p">}</span> <span class="n">state</span><span class="p">;</span>
<span class="p">};</span>

<span class="cm">/* Where we keep track of our sockets... */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">sockets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">i82365_socket</span> <span class="n">socket</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="p">},</span> <span class="cm">/* ... */</span>
<span class="p">};</span>

<span class="cm">/* Default ISA interrupt mask */</span>
<span class="cp">#define I365_MASK	0xdeb8	</span><span class="cm">/* irq 15,14,12,11,10,9,7,5,4,3 */</span><span class="cp"></span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">grab_irq</span><span class="p">;</span>
<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">isa_lock</span><span class="p">);</span>
<span class="cp">#define ISA_LOCK(n, f) spin_lock_irqsave(&amp;isa_lock, f)</span>
<span class="cp">#define ISA_UNLOCK(n, f) spin_unlock_irqrestore(&amp;isa_lock, f)</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">timer_list</span> <span class="n">poll_timer</span><span class="p">;</span>

<span class="cm">/*====================================================================*/</span>

<span class="cm">/* These definitions must match the pcic table! */</span>
<span class="k">typedef</span> <span class="k">enum</span> <span class="n">pcic_id</span> <span class="p">{</span>
    <span class="n">IS_I82365A</span><span class="p">,</span> <span class="n">IS_I82365B</span><span class="p">,</span> <span class="n">IS_I82365DF</span><span class="p">,</span>
    <span class="n">IS_IBM</span><span class="p">,</span> <span class="n">IS_RF5Cx96</span><span class="p">,</span> <span class="n">IS_VLSI</span><span class="p">,</span> <span class="n">IS_VG468</span><span class="p">,</span> <span class="n">IS_VG469</span><span class="p">,</span>
    <span class="n">IS_PD6710</span><span class="p">,</span> <span class="n">IS_PD672X</span><span class="p">,</span> <span class="n">IS_VT83C469</span><span class="p">,</span>
<span class="p">}</span> <span class="n">pcic_id</span><span class="p">;</span>

<span class="cm">/* Flags for classifying groups of controllers */</span>
<span class="cp">#define IS_VADEM	0x0001</span>
<span class="cp">#define IS_CIRRUS	0x0002</span>
<span class="cp">#define IS_VIA		0x0010</span>
<span class="cp">#define IS_UNKNOWN	0x0400</span>
<span class="cp">#define IS_VG_PWR	0x0800</span>
<span class="cp">#define IS_DF_PWR	0x1000</span>
<span class="cp">#define IS_REGISTERED	0x2000</span>
<span class="cp">#define IS_ALIVE	0x8000</span>

<span class="k">typedef</span> <span class="k">struct</span> <span class="n">pcic_t</span> <span class="p">{</span>
    <span class="kt">char</span>		<span class="o">*</span><span class="n">name</span><span class="p">;</span>
    <span class="n">u_short</span>		<span class="n">flags</span><span class="p">;</span>
<span class="p">}</span> <span class="n">pcic_t</span><span class="p">;</span>

<span class="k">static</span> <span class="n">pcic_t</span> <span class="n">pcic</span><span class="p">[]</span> <span class="o">=</span> <span class="p">{</span>
    <span class="p">{</span> <span class="s">&quot;Intel i82365sl A step&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;Intel i82365sl B step&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;Intel i82365sl DF&quot;</span><span class="p">,</span> <span class="n">IS_DF_PWR</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;IBM Clone&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;Ricoh RF5C296/396&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;VLSI 82C146&quot;</span><span class="p">,</span> <span class="mi">0</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;Vadem VG-468&quot;</span><span class="p">,</span> <span class="n">IS_VADEM</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;Vadem VG-469&quot;</span><span class="p">,</span> <span class="n">IS_VADEM</span><span class="o">|</span><span class="n">IS_VG_PWR</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;Cirrus PD6710&quot;</span><span class="p">,</span> <span class="n">IS_CIRRUS</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;Cirrus PD672x&quot;</span><span class="p">,</span> <span class="n">IS_CIRRUS</span> <span class="p">},</span>
    <span class="p">{</span> <span class="s">&quot;VIA VT83C469&quot;</span><span class="p">,</span> <span class="n">IS_CIRRUS</span><span class="o">|</span><span class="n">IS_VIA</span> <span class="p">},</span>
<span class="p">};</span>

<span class="cp">#define PCIC_COUNT	(sizeof(pcic)/sizeof(pcic_t))</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="n">DEFINE_SPINLOCK</span><span class="p">(</span><span class="n">bus_lock</span><span class="p">);</span>

<span class="k">static</span> <span class="n">u_char</span> <span class="nf">i365_get</span><span class="p">(</span><span class="n">u_short</span> <span class="n">sock</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
    <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">socket</span><span class="p">[</span><span class="n">sock</span><span class="p">].</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">val</span><span class="p">;</span>
	<span class="n">reg</span> <span class="o">=</span> <span class="n">I365_REG</span><span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">sock</span><span class="p">].</span><span class="n">psock</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span> <span class="n">val</span> <span class="o">=</span> <span class="n">inb</span><span class="p">(</span><span class="n">port</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">val</span><span class="p">;</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i365_set</span><span class="p">(</span><span class="n">u_short</span> <span class="n">sock</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
    <span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
    <span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span> <span class="o">=</span> <span class="n">socket</span><span class="p">[</span><span class="n">sock</span><span class="p">].</span><span class="n">ioaddr</span><span class="p">;</span>
	<span class="n">u_char</span> <span class="n">val</span> <span class="o">=</span> <span class="n">I365_REG</span><span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">sock</span><span class="p">].</span><span class="n">psock</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
	<span class="n">outb</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span> <span class="n">outb</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">port</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bus_lock</span><span class="p">,</span><span class="n">flags</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i365_bset</span><span class="p">(</span><span class="n">u_short</span> <span class="n">sock</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span> <span class="n">d</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
    <span class="n">d</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
    <span class="n">i365_set</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i365_bclr</span><span class="p">(</span><span class="n">u_short</span> <span class="n">sock</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">mask</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span> <span class="n">d</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
    <span class="n">d</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
    <span class="n">i365_set</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i365_bflip</span><span class="p">(</span><span class="n">u_short</span> <span class="n">sock</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u_char</span> <span class="n">mask</span><span class="p">,</span> <span class="kt">int</span> <span class="n">b</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span> <span class="n">d</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">b</span><span class="p">)</span>
	<span class="n">d</span> <span class="o">|=</span> <span class="n">mask</span><span class="p">;</span>
    <span class="k">else</span>
	<span class="n">d</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="n">mask</span><span class="p">;</span>
    <span class="n">i365_set</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">d</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_short</span> <span class="nf">i365_get_pair</span><span class="p">(</span><span class="n">u_short</span> <span class="n">sock</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">reg</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_short</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">;</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">reg</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="p">(</span><span class="n">b</span><span class="o">&lt;&lt;</span><span class="mi">8</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">i365_set_pair</span><span class="p">(</span><span class="n">u_short</span> <span class="n">sock</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">reg</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">i365_set</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">reg</span><span class="p">,</span> <span class="n">data</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">);</span>
    <span class="n">i365_set</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">reg</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">data</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*======================================================================</span>

<span class="cm">    Code to save and restore global state information for Cirrus</span>
<span class="cm">    PD67xx controllers, and to set and report global configuration</span>
<span class="cm">    options.</span>

<span class="cm">    The VIA controllers also use these routines, as they are mostly</span>
<span class="cm">    Cirrus lookalikes, without the timing registers.</span>
<span class="cm">    </span>
<span class="cm">======================================================================*/</span>

<span class="cp">#define flip(v,b,f) (v = ((f)&lt;0) ? v : ((f) ? ((v)|(b)) : ((v)&amp;(~b))))</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrus_get_state</span><span class="p">(</span><span class="n">u_short</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">cirrus_state_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">state</span><span class="p">.</span><span class="n">cirrus</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">misc1</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">PD67_MISC_CTL_1</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">misc1</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">PD67_MC1_MEDIA_ENA</span> <span class="o">|</span> <span class="n">PD67_MC1_INPACK_ENA</span><span class="p">);</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">misc2</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">PD67_MISC_CTL_2</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">PD67_TIME_SETUP</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">cirrus_set_state</span><span class="p">(</span><span class="n">u_short</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">u_char</span> <span class="n">misc</span><span class="p">;</span>
    <span class="n">cirrus_state_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">state</span><span class="p">.</span><span class="n">cirrus</span><span class="p">;</span>

    <span class="n">misc</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">PD67_MISC_CTL_2</span><span class="p">);</span>
    <span class="n">i365_set</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">PD67_MISC_CTL_2</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">misc2</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">misc</span> <span class="o">&amp;</span> <span class="n">PD67_MC2_SUSPEND</span><span class="p">)</span> <span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
    <span class="n">misc</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">PD67_MISC_CTL_1</span><span class="p">);</span>
    <span class="n">misc</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">PD67_MC1_MEDIA_ENA</span> <span class="o">|</span> <span class="n">PD67_MC1_INPACK_ENA</span><span class="p">);</span>
    <span class="n">i365_set</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">PD67_MISC_CTL_1</span><span class="p">,</span> <span class="n">misc</span> <span class="o">|</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">misc1</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">6</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="n">i365_set</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">PD67_TIME_SETUP</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">i</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_int</span> <span class="n">__init</span> <span class="nf">cirrus_set_opts</span><span class="p">(</span><span class="n">u_short</span> <span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">i82365_socket</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">s</span><span class="p">];</span>
    <span class="n">cirrus_state_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">state</span><span class="p">.</span><span class="n">cirrus</span><span class="p">;</span>
    <span class="n">u_int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">has_ring</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="n">has_ring</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">flip</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">misc2</span><span class="p">,</span> <span class="n">PD67_MC2_IRQ15_RI</span><span class="p">,</span> <span class="n">has_ring</span><span class="p">);</span>
    <span class="n">flip</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">misc2</span><span class="p">,</span> <span class="n">PD67_MC2_DYNAMIC_MODE</span><span class="p">,</span> <span class="n">dynamic_mode</span><span class="p">);</span>
    <span class="n">flip</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">misc2</span><span class="p">,</span> <span class="n">PD67_MC2_FREQ_BYPASS</span><span class="p">,</span> <span class="n">freq_bypass</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">misc2</span> <span class="o">&amp;</span> <span class="n">PD67_MC2_IRQ15_RI</span><span class="p">)</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; [ring]&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">misc2</span> <span class="o">&amp;</span> <span class="n">PD67_MC2_DYNAMIC_MODE</span><span class="p">)</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; [dyn mode]&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">misc2</span> <span class="o">&amp;</span> <span class="n">PD67_MC2_FREQ_BYPASS</span><span class="p">)</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; [freq bypass]&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">misc1</span> <span class="o">&amp;</span> <span class="n">PD67_MC1_INPACK_ENA</span><span class="p">)</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; [inpack]&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">misc2</span> <span class="o">&amp;</span> <span class="n">PD67_MC2_IRQ15_RI</span><span class="p">)</span>
	<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x8000</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">has_led</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; [led]&quot;</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x1000</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">has_dma</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; [dma]&quot;</span><span class="p">);</span>
	<span class="n">mask</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="mh">0x0600</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_VIA</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">setup_time</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">setup_time</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cmd_time</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd_time</span><span class="p">;</span>
	    <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">cmd_time</span><span class="o">*</span><span class="mi">2</span><span class="o">+</span><span class="mi">4</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">6</span><span class="p">;</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="mi">16</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">recov_time</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">recov_time</span><span class="p">;</span>
	<span class="n">buf</span> <span class="o">+=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">buf</span><span class="p">);</span>
	<span class="n">sprintf</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; [%d/%d/%d] [%d/%d/%d]&quot;</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
		<span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">timer</span><span class="p">[</span><span class="mi">5</span><span class="p">]);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">mask</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*======================================================================</span>

<span class="cm">    Code to save and restore global state information for Vadem VG468</span>
<span class="cm">    and VG469 controllers, and to set and report global configuration</span>
<span class="cm">    options.</span>
<span class="cm">    </span>
<span class="cm">======================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vg46x_get_state</span><span class="p">(</span><span class="n">u_short</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">vg46x_state_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">state</span><span class="p">.</span><span class="n">vg46x</span><span class="p">;</span>
    <span class="n">p</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">VG468_CTL</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">IS_VG469</span><span class="p">)</span>
	<span class="n">p</span><span class="o">-&gt;</span><span class="n">ema</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">VG469_EXT_MODE</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">vg46x_set_state</span><span class="p">(</span><span class="n">u_short</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">vg46x_state_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">state</span><span class="p">.</span><span class="n">vg46x</span><span class="p">;</span>
    <span class="n">i365_set</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">VG468_CTL</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">IS_VG469</span><span class="p">)</span>
	<span class="n">i365_set</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">VG469_EXT_MODE</span><span class="p">,</span> <span class="n">p</span><span class="o">-&gt;</span><span class="n">ema</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_int</span> <span class="n">__init</span> <span class="nf">vg46x_set_opts</span><span class="p">(</span><span class="n">u_short</span> <span class="n">s</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="n">buf</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">vg46x_state_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">state</span><span class="p">.</span><span class="n">vg46x</span><span class="p">;</span>
    
    <span class="n">flip</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ctl</span><span class="p">,</span> <span class="n">VG468_CTL_ASYNC</span><span class="p">,</span> <span class="n">async_clock</span><span class="p">);</span>
    <span class="n">flip</span><span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ema</span><span class="p">,</span> <span class="n">VG469_MODE_CABLE</span><span class="p">,</span> <span class="n">cable_mode</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">VG468_CTL_ASYNC</span><span class="p">)</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; [async]&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ctl</span> <span class="o">&amp;</span> <span class="n">VG468_CTL_INPACK</span><span class="p">)</span>
	<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; [inpack]&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">s</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">IS_VG469</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u_char</span> <span class="n">vsel</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">VG469_VSELECT</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">vsel</span> <span class="o">&amp;</span> <span class="n">VG469_VSEL_EXT_STAT</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; [ext mode]&quot;</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">vsel</span> <span class="o">&amp;</span> <span class="n">VG469_VSEL_EXT_BUS</span><span class="p">)</span>
		<span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; [isa buf]&quot;</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ema</span> <span class="o">&amp;</span> <span class="n">VG469_MODE_CABLE</span><span class="p">)</span>
	    <span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; [cable]&quot;</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">ema</span> <span class="o">&amp;</span> <span class="n">VG469_MODE_COMPAT</span><span class="p">)</span>
	    <span class="n">strcat</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="s">&quot; [c step]&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="mh">0xffff</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*======================================================================</span>

<span class="cm">    Generic routines to get and set controller options</span>
<span class="cm">    </span>
<span class="cm">======================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">get_bridge_state</span><span class="p">(</span><span class="n">u_short</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">i82365_socket</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">s</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_CIRRUS</span><span class="p">)</span>
	<span class="n">cirrus_get_state</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_VADEM</span><span class="p">)</span>
	<span class="n">vg46x_get_state</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">set_bridge_state</span><span class="p">(</span><span class="n">u_short</span> <span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">i82365_socket</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">s</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_CIRRUS</span><span class="p">)</span>
	<span class="n">cirrus_set_state</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
    <span class="k">else</span> <span class="p">{</span>
	<span class="n">i365_set</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">I365_GBLCTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
	<span class="n">i365_set</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">I365_GENCTL</span><span class="p">,</span> <span class="mh">0x00</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">i365_bflip</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">I365_INTCTL</span><span class="p">,</span> <span class="n">I365_INTR_ENA</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_VADEM</span><span class="p">)</span>
	<span class="n">vg46x_set_state</span><span class="p">(</span><span class="n">s</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_int</span> <span class="n">__init</span> <span class="nf">set_bridge_opts</span><span class="p">(</span><span class="n">u_short</span> <span class="n">s</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_short</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">u_int</span> <span class="n">m</span> <span class="o">=</span> <span class="mh">0xffff</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="mi">128</span><span class="p">];</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">s</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">s</span><span class="o">+</span><span class="n">ns</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_ALIVE</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    host opts [%d]: already alive!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
	    <span class="k">continue</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="n">buf</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
	<span class="n">get_bridge_state</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_CIRRUS</span><span class="p">)</span>
	    <span class="n">m</span> <span class="o">=</span> <span class="n">cirrus_set_opts</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_VADEM</span><span class="p">)</span>
	    <span class="n">m</span> <span class="o">=</span> <span class="n">vg46x_set_opts</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">buf</span><span class="p">);</span>
	<span class="n">set_bridge_state</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    host opts [%d]:%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>
	       <span class="p">(</span><span class="o">*</span><span class="n">buf</span><span class="p">)</span> <span class="o">?</span> <span class="n">buf</span> <span class="o">:</span> <span class="s">&quot; none&quot;</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">m</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*======================================================================</span>

<span class="cm">    Interrupt testing code, for ISA and PCI interrupts</span>
<span class="cm">    </span>
<span class="cm">======================================================================*/</span>

<span class="k">static</span> <span class="k">volatile</span> <span class="n">u_int</span> <span class="n">irq_hits</span><span class="p">;</span>
<span class="k">static</span> <span class="n">u_short</span> <span class="n">irq_sock</span><span class="p">;</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">i365_count_irq</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">i365_get</span><span class="p">(</span><span class="n">irq_sock</span><span class="p">,</span> <span class="n">I365_CSC</span><span class="p">);</span>
    <span class="n">irq_hits</span><span class="o">++</span><span class="p">;</span>
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;i82365: -&gt; hit on irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">IRQ_HANDLED</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_int</span> <span class="n">__init</span> <span class="nf">test_irq</span><span class="p">(</span><span class="n">u_short</span> <span class="n">sock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">irq</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;i82365:  testing ISA irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">request_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">i365_count_irq</span><span class="p">,</span> <span class="n">IRQF_PROBE_SHARED</span><span class="p">,</span> <span class="s">&quot;scan&quot;</span><span class="p">,</span>
			<span class="n">i365_count_irq</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="n">irq_hits</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">irq_sock</span> <span class="o">=</span> <span class="n">sock</span><span class="p">;</span>
    <span class="n">msleep</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">irq_hits</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">i365_count_irq</span><span class="p">);</span>
	<span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;i82365:    spurious hit!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Generate one interrupt */</span>
    <span class="n">i365_set</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_CSCINT</span><span class="p">,</span> <span class="n">I365_CSC_DETECT</span> <span class="o">|</span> <span class="p">(</span><span class="n">irq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">));</span>
    <span class="n">i365_bset</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_GENCTL</span><span class="p">,</span> <span class="n">I365_CTL_SW_IRQ</span><span class="p">);</span>
    <span class="n">udelay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>

    <span class="n">free_irq</span><span class="p">(</span><span class="n">irq</span><span class="p">,</span> <span class="n">i365_count_irq</span><span class="p">);</span>

    <span class="cm">/* mask all interrupts */</span>
    <span class="n">i365_set</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_CSCINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;i82365:    hits = %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq_hits</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">irq_hits</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">);</span>
<span class="p">}</span>

<span class="k">static</span> <span class="n">u_int</span> <span class="n">__init</span> <span class="nf">isa_scan</span><span class="p">(</span><span class="n">u_short</span> <span class="n">sock</span><span class="p">,</span> <span class="n">u_int</span> <span class="n">mask0</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_int</span> <span class="n">mask1</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

<span class="cp">#ifdef __alpha__</span>
<span class="cp">#define PIC 0x4d0</span>
    <span class="cm">/* Don&#39;t probe level-triggered interrupts -- reserved for PCI */</span>
    <span class="n">mask0</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">PIC</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">inb</span><span class="p">(</span><span class="n">PIC</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">));</span>
<span class="cp">#endif</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">do_scan</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">set_bridge_state</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
	<span class="n">i365_set</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_CSCINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="k">if</span> <span class="p">((</span><span class="n">mask0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">test_irq</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">mask1</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="k">if</span> <span class="p">((</span><span class="n">mask1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">test_irq</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">i</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">mask1</span> <span class="o">^=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;    ISA irqs (&quot;</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mask1</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;scanned&quot;</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="cm">/* Fallback: just find interrupts that aren&#39;t in use */</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="k">if</span> <span class="p">((</span><span class="n">mask0</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">))</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">_check_irq</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">IRQF_PROBE_SHARED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="n">mask1</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">i</span><span class="p">);</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;default&quot;</span><span class="p">);</span>
	<span class="cm">/* If scan failed, default to polled status */</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cs_irq</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">poll_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="n">poll_interval</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;) = &quot;</span><span class="p">);</span>
    
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">16</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">mask1</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">))</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;%s%d&quot;</span><span class="p">,</span> <span class="p">((</span><span class="n">mask1</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">i</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">?</span> <span class="s">&quot;,&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">),</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mask1</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;none!&quot;</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="n">mask1</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*====================================================================*/</span>

<span class="cm">/* Time conversion functions */</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">to_cycles</span><span class="p">(</span><span class="kt">int</span> <span class="n">ns</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="n">ns</span><span class="o">/</span><span class="n">cycle_time</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">identify</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="n">u_short</span> <span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span> <span class="n">val</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">type</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>

    <span class="cm">/* Use the next free entry in the socket table */</span>
    <span class="n">socket</span><span class="p">[</span><span class="n">sockets</span><span class="p">].</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
    <span class="n">socket</span><span class="p">[</span><span class="n">sockets</span><span class="p">].</span><span class="n">psock</span> <span class="o">=</span> <span class="n">sock</span><span class="p">;</span>
    
    <span class="cm">/* Wake up a sleepy Cirrus controller */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">wakeup</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">i365_bclr</span><span class="p">(</span><span class="n">sockets</span><span class="p">,</span> <span class="n">PD67_MISC_CTL_2</span><span class="p">,</span> <span class="n">PD67_MC2_SUSPEND</span><span class="p">);</span>
	<span class="cm">/* Pause at least 50 ms */</span>
	<span class="n">mdelay</span><span class="p">(</span><span class="mi">50</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sockets</span><span class="p">,</span> <span class="n">I365_IDENT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">)</span>
	<span class="k">return</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">val</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mh">0x82</span>:
	<span class="n">type</span> <span class="o">=</span> <span class="n">IS_I82365A</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x83</span>:
	<span class="n">type</span> <span class="o">=</span> <span class="n">IS_I82365B</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x84</span>:
	<span class="n">type</span> <span class="o">=</span> <span class="n">IS_I82365DF</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mh">0x88</span>: <span class="k">case</span> <span class="mh">0x89</span>: <span class="k">case</span> <span class="mh">0x8a</span>:
	<span class="n">type</span> <span class="o">=</span> <span class="n">IS_IBM</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    
    <span class="cm">/* Check for Vadem VG-468 chips */</span>
    <span class="n">outb</span><span class="p">(</span><span class="mh">0x0e</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
    <span class="n">outb</span><span class="p">(</span><span class="mh">0x37</span><span class="p">,</span> <span class="n">port</span><span class="p">);</span>
    <span class="n">i365_bset</span><span class="p">(</span><span class="n">sockets</span><span class="p">,</span> <span class="n">VG468_MISC</span><span class="p">,</span> <span class="n">VG468_MISC_VADEMREV</span><span class="p">);</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sockets</span><span class="p">,</span> <span class="n">I365_IDENT</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">I365_IDENT_VADEM</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">i365_bclr</span><span class="p">(</span><span class="n">sockets</span><span class="p">,</span> <span class="n">VG468_MISC</span><span class="p">,</span> <span class="n">VG468_MISC_VADEMREV</span><span class="p">);</span>
	<span class="n">type</span> <span class="o">=</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="mi">7</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">)</span> <span class="o">?</span> <span class="n">IS_VG469</span> <span class="o">:</span> <span class="n">IS_VG468</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Check for Ricoh chips */</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sockets</span><span class="p">,</span> <span class="n">RF5C_CHIP_ID</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">==</span> <span class="n">RF5C_CHIP_RF5C296</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">val</span> <span class="o">==</span> <span class="n">RF5C_CHIP_RF5C396</span><span class="p">))</span>
	<span class="n">type</span> <span class="o">=</span> <span class="n">IS_RF5Cx96</span><span class="p">;</span>
    
    <span class="cm">/* Check for Cirrus CL-PD67xx chips */</span>
    <span class="n">i365_set</span><span class="p">(</span><span class="n">sockets</span><span class="p">,</span> <span class="n">PD67_CHIP_INFO</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sockets</span><span class="p">,</span> <span class="n">PD67_CHIP_INFO</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PD67_INFO_CHIP_ID</span><span class="p">)</span> <span class="o">==</span> <span class="n">PD67_INFO_CHIP_ID</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">val</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sockets</span><span class="p">,</span> <span class="n">PD67_CHIP_INFO</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PD67_INFO_CHIP_ID</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">type</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="n">PD67_INFO_SLOTS</span><span class="p">)</span> <span class="o">?</span> <span class="n">IS_PD672X</span> <span class="o">:</span> <span class="n">IS_PD6710</span><span class="p">;</span>
	    <span class="n">i365_set</span><span class="p">(</span><span class="n">sockets</span><span class="p">,</span> <span class="n">PD67_EXT_INDEX</span><span class="p">,</span> <span class="mh">0xe5</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">i365_get</span><span class="p">(</span><span class="n">sockets</span><span class="p">,</span> <span class="n">PD67_EXT_INDEX</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0xe5</span><span class="p">)</span>
		<span class="n">type</span> <span class="o">=</span> <span class="n">IS_VT83C469</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">type</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* identify */</span>

<span class="cm">/*======================================================================</span>

<span class="cm">    See if a card is present, powered up, in IO mode, and already</span>
<span class="cm">    bound to a (non PC Card) Linux driver.  We leave these alone.</span>

<span class="cm">    We make an exception for cards that seem to be serial devices.</span>
<span class="cm">    </span>
<span class="cm">======================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">is_alive</span><span class="p">(</span><span class="n">u_short</span> <span class="n">sock</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span> <span class="n">stat</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="p">;</span>
    
    <span class="n">stat</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_STATUS</span><span class="p">);</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">i365_get_pair</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_IO</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">I365_W_START</span><span class="p">);</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">i365_get_pair</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_IO</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">I365_W_STOP</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">I365_CS_DETECT</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">stat</span> <span class="o">&amp;</span> <span class="n">I365_CS_POWERON</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	<span class="p">(</span><span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_INTCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I365_PC_IOCARD</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
	<span class="p">(</span><span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_ADDRWIN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I365_ENA_IO</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
	<span class="p">((</span><span class="n">start</span> <span class="o">&amp;</span> <span class="mh">0xfeef</span><span class="p">)</span> <span class="o">!=</span> <span class="mh">0x02e8</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="s">&quot;i82365&quot;</span><span class="p">))</span>
	    <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">stop</span><span class="o">-</span><span class="n">start</span><span class="o">+</span><span class="mi">1</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">add_socket</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">,</span> <span class="kt">int</span> <span class="n">psock</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">socket</span><span class="p">[</span><span class="n">sockets</span><span class="p">].</span><span class="n">ioaddr</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>
    <span class="n">socket</span><span class="p">[</span><span class="n">sockets</span><span class="p">].</span><span class="n">psock</span> <span class="o">=</span> <span class="n">psock</span><span class="p">;</span>
    <span class="n">socket</span><span class="p">[</span><span class="n">sockets</span><span class="p">].</span><span class="n">type</span> <span class="o">=</span> <span class="n">type</span><span class="p">;</span>
    <span class="n">socket</span><span class="p">[</span><span class="n">sockets</span><span class="p">].</span><span class="n">flags</span> <span class="o">=</span> <span class="n">pcic</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">flags</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">is_alive</span><span class="p">(</span><span class="n">sockets</span><span class="p">))</span>
	<span class="n">socket</span><span class="p">[</span><span class="n">sockets</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IS_ALIVE</span><span class="p">;</span>
    <span class="n">sockets</span><span class="o">++</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">add_pcic</span><span class="p">(</span><span class="kt">int</span> <span class="n">ns</span><span class="p">,</span> <span class="kt">int</span> <span class="n">type</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_int</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">base</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">isa_irq</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">i82365_socket</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">sockets</span><span class="o">-</span><span class="n">ns</span><span class="p">];</span>

    <span class="n">base</span> <span class="o">=</span> <span class="n">sockets</span><span class="o">-</span><span class="n">ns</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">base</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="n">printk</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;  %s&quot;</span><span class="p">,</span> <span class="n">pcic</span><span class="p">[</span><span class="n">type</span><span class="p">].</span><span class="n">name</span><span class="p">);</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot; ISA-to-PCMCIA at port %#x ofs 0x%02x&quot;</span><span class="p">,</span>
	       <span class="n">t</span><span class="o">-&gt;</span><span class="n">ioaddr</span><span class="p">,</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">psock</span><span class="o">*</span><span class="mh">0x40</span><span class="p">);</span>
    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;, %d socket%s</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="p">((</span><span class="n">ns</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">?</span> <span class="s">&quot;s&quot;</span> <span class="o">:</span> <span class="s">&quot;&quot;</span><span class="p">));</span>

    <span class="cm">/* Set host options, build basic interrupt mask */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">irq_list_count</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">mask</span> <span class="o">=</span> <span class="n">irq_mask</span><span class="p">;</span>
    <span class="k">else</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">irq_list_count</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
	    <span class="n">mask</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">irq_list</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
    <span class="n">mask</span> <span class="o">&amp;=</span> <span class="n">I365_MASK</span> <span class="o">&amp;</span> <span class="n">set_bridge_opts</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">ns</span><span class="p">);</span>
    <span class="cm">/* Scan for ISA interrupts */</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">isa_scan</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">mask</span><span class="p">);</span>
        
    <span class="cm">/* Poll if only two interrupts available */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">poll_interval</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">u_int</span> <span class="n">tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span> <span class="o">&amp;</span> <span class="mh">0xff20</span><span class="p">);</span>
	<span class="n">tmp</span> <span class="o">=</span> <span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-</span><span class="mi">1</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">tmp</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tmp</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="n">poll_interval</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* Only try an ISA cs_irq if this is the first controller */</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">grab_irq</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">cs_irq</span> <span class="o">||</span> <span class="o">!</span><span class="n">poll_interval</span><span class="p">))</span> <span class="p">{</span>
	<span class="cm">/* Avoid irq 12 unless it is explicitly requested */</span>
	<span class="n">u_int</span> <span class="n">cs_mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">&amp;</span> <span class="p">((</span><span class="n">cs_irq</span><span class="p">)</span> <span class="o">?</span> <span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="n">cs_irq</span><span class="p">)</span> <span class="o">:</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span><span class="o">&lt;&lt;</span><span class="mi">12</span><span class="p">));</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">cs_irq</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span> <span class="n">cs_irq</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span> <span class="n">cs_irq</span><span class="o">--</span><span class="p">)</span>
	    <span class="k">if</span> <span class="p">((</span><span class="n">cs_mask</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">cs_irq</span><span class="p">))</span> <span class="o">&amp;&amp;</span>
		<span class="p">(</span><span class="n">_check_irq</span><span class="p">(</span><span class="n">cs_irq</span><span class="p">,</span> <span class="n">IRQF_PROBE_SHARED</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">cs_irq</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">grab_irq</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="n">isa_irq</span> <span class="o">=</span> <span class="n">cs_irq</span><span class="p">;</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot; status change on irq %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">cs_irq</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">isa_irq</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">poll_interval</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="n">poll_interval</span> <span class="o">=</span> <span class="n">HZ</span><span class="p">;</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot; polling interval = %d ms</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
	       <span class="n">poll_interval</span> <span class="o">*</span> <span class="mi">1000</span> <span class="o">/</span> <span class="n">HZ</span><span class="p">);</span>
	
    <span class="p">}</span>
    
    <span class="cm">/* Update socket interrupt information, capabilities */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">ns</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">features</span> <span class="o">|=</span> <span class="n">SS_CAP_PCCARD</span><span class="p">;</span>
	<span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">map_size</span> <span class="o">=</span> <span class="mh">0x1000</span><span class="p">;</span>
	<span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">irq_mask</span> <span class="o">=</span> <span class="n">mask</span><span class="p">;</span>
	<span class="n">t</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cs_irq</span> <span class="o">=</span> <span class="n">isa_irq</span><span class="p">;</span>
    <span class="p">}</span>

<span class="p">}</span> <span class="cm">/* add_pcic */</span>

<span class="cm">/*====================================================================*/</span>

<span class="cp">#ifdef CONFIG_PNP</span>
<span class="k">static</span> <span class="k">struct</span> <span class="n">isapnp_device_id</span> <span class="n">id_table</span><span class="p">[]</span> <span class="n">__initdata</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">{</span> 	<span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;P&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span>
		<span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0e00</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="s">&quot;Intel 82365-Compatible&quot;</span> <span class="p">},</span>
	<span class="p">{</span> 	<span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;P&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span>
		<span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0e01</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="s">&quot;Cirrus Logic CL-PD6720&quot;</span> <span class="p">},</span>
	<span class="p">{</span> 	<span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_ANY_ID</span><span class="p">,</span> <span class="n">ISAPNP_VENDOR</span><span class="p">(</span><span class="sc">&#39;P&#39;</span><span class="p">,</span> <span class="sc">&#39;N&#39;</span><span class="p">,</span> <span class="sc">&#39;P&#39;</span><span class="p">),</span>
		<span class="n">ISAPNP_FUNCTION</span><span class="p">(</span><span class="mh">0x0e02</span><span class="p">),</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span> <span class="s">&quot;VLSI VL82C146&quot;</span> <span class="p">},</span>
	<span class="p">{</span>	<span class="mi">0</span> <span class="p">}</span>
<span class="p">};</span>
<span class="n">MODULE_DEVICE_TABLE</span><span class="p">(</span><span class="n">isapnp</span><span class="p">,</span> <span class="n">id_table</span><span class="p">);</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">i82365_pnpdev</span><span class="p">;</span>
<span class="cp">#endif</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__init</span> <span class="nf">isa_probe</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">id</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">port</span><span class="p">;</span>
<span class="cp">#ifdef CONFIG_PNP</span>
    <span class="k">struct</span> <span class="n">isapnp_device_id</span> <span class="o">*</span><span class="n">devid</span><span class="p">;</span>
    <span class="k">struct</span> <span class="n">pnp_dev</span> <span class="o">*</span><span class="n">dev</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">devid</span> <span class="o">=</span> <span class="n">id_table</span><span class="p">;</span> <span class="n">devid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">;</span> <span class="n">devid</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">dev</span> <span class="o">=</span> <span class="n">pnp_find_dev</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">devid</span><span class="o">-&gt;</span><span class="n">vendor</span><span class="p">,</span> <span class="n">devid</span><span class="o">-&gt;</span><span class="n">function</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">)))</span> <span class="p">{</span>
	
	    <span class="k">if</span> <span class="p">(</span><span class="n">pnp_device_attach</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
	    	<span class="k">continue</span><span class="p">;</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">pnp_activate_dev</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;activate failed</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>

	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pnp_port_valid</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">printk</span><span class="p">(</span><span class="s">&quot;invalid resources ?</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
		<span class="n">pnp_device_detach</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">i365_base</span> <span class="o">=</span> <span class="n">pnp_port_start</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	    <span class="n">i82365_pnpdev</span> <span class="o">=</span> <span class="n">dev</span><span class="p">;</span>
	    <span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="cp">#endif</span>

    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">request_region</span><span class="p">(</span><span class="n">i365_base</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="s">&quot;i82365&quot;</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">sockets</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
	    <span class="n">printk</span><span class="p">(</span><span class="s">&quot;port conflict at %#lx</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i365_base</span><span class="p">);</span>
	<span class="k">return</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="n">id</span> <span class="o">=</span> <span class="n">identify</span><span class="p">(</span><span class="n">i365_base</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">id</span> <span class="o">==</span> <span class="n">IS_I82365DF</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">identify</span><span class="p">(</span><span class="n">i365_base</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">!=</span> <span class="n">id</span><span class="p">))</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">ignore</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>
	    <span class="n">port</span> <span class="o">=</span> <span class="n">i365_base</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="p">((</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">);</span>
	    <span class="n">sock</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;&lt;</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">identify</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">sock</span><span class="p">)</span> <span class="o">==</span> <span class="n">IS_I82365DF</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">add_socket</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">IS_VLSI</span><span class="p">);</span>
		<span class="n">add_pcic</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">IS_VLSI</span><span class="p">);</span>
	    <span class="p">}</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">;</span> <span class="n">i</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">sockets</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">extra_sockets</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="mi">4</span><span class="p">))</span>
		<span class="k">break</span><span class="p">;</span>
	    <span class="n">port</span> <span class="o">=</span> <span class="n">i365_base</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">i</span><span class="o">&gt;&gt;</span><span class="mi">2</span><span class="p">);</span>
	    <span class="n">sock</span> <span class="o">=</span> <span class="p">(</span><span class="n">i</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
	    <span class="n">id</span> <span class="o">=</span> <span class="n">identify</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">sock</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">id</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">continue</span><span class="p">;</span>

	    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="n">ns</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Does the socket exist? */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">ignore</span> <span class="o">==</span> <span class="n">i</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">identify</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">sock</span><span class="o">+</span><span class="n">j</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">))</span>
		    <span class="k">continue</span><span class="p">;</span>
		<span class="cm">/* Check for bad socket decode */</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">sockets</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		    <span class="n">i365_set</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">I365_MEM</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">I365_W_OFF</span><span class="p">,</span> <span class="n">k</span><span class="p">);</span>
		<span class="k">for</span> <span class="p">(</span><span class="n">k</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">k</span> <span class="o">&lt;=</span> <span class="n">sockets</span><span class="p">;</span> <span class="n">k</span><span class="o">++</span><span class="p">)</span>
		    <span class="k">if</span> <span class="p">(</span><span class="n">i365_get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">I365_MEM</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">+</span><span class="n">I365_W_OFF</span><span class="p">)</span> <span class="o">!=</span> <span class="n">k</span><span class="p">)</span>
			<span class="k">break</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="o">&lt;=</span> <span class="n">sockets</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
		<span class="n">add_socket</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">sock</span><span class="o">+</span><span class="n">j</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span> <span class="n">ns</span><span class="o">++</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">ns</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="n">add_pcic</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="n">id</span><span class="p">);</span>
	<span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="n">irqreturn_t</span> <span class="nf">pcic_interrupt</span><span class="p">(</span><span class="kt">int</span> <span class="n">irq</span><span class="p">,</span> <span class="kt">void</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="n">csc</span><span class="p">;</span>
    <span class="n">u_int</span> <span class="n">events</span><span class="p">,</span> <span class="n">active</span><span class="p">;</span>
    <span class="n">u_long</span> <span class="n">flags</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">handled</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pcic_interrupt(%d)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">irq</span><span class="p">);</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">j</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">;</span> <span class="n">j</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">active</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sockets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">cs_irq</span> <span class="o">!=</span> <span class="n">irq</span><span class="p">)</span>
		<span class="k">continue</span><span class="p">;</span>
	    <span class="n">handled</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	    <span class="n">ISA_LOCK</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	    <span class="n">csc</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">I365_CSC</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">((</span><span class="n">csc</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">i365_get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">I365_IDENT</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x70</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">ISA_UNLOCK</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
		<span class="k">continue</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">events</span> <span class="o">=</span> <span class="p">(</span><span class="n">csc</span> <span class="o">&amp;</span> <span class="n">I365_CSC_DETECT</span><span class="p">)</span> <span class="o">?</span> <span class="n">SS_DETECT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">i365_get</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">I365_INTCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I365_PC_IOCARD</span><span class="p">)</span>
		<span class="n">events</span> <span class="o">|=</span> <span class="p">(</span><span class="n">csc</span> <span class="o">&amp;</span> <span class="n">I365_CSC_STSCHG</span><span class="p">)</span> <span class="o">?</span> <span class="n">SS_STSCHG</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="k">else</span> <span class="p">{</span>
		<span class="n">events</span> <span class="o">|=</span> <span class="p">(</span><span class="n">csc</span> <span class="o">&amp;</span> <span class="n">I365_CSC_BVD1</span><span class="p">)</span> <span class="o">?</span> <span class="n">SS_BATDEAD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">events</span> <span class="o">|=</span> <span class="p">(</span><span class="n">csc</span> <span class="o">&amp;</span> <span class="n">I365_CSC_BVD2</span><span class="p">)</span> <span class="o">?</span> <span class="n">SS_BATWARN</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">events</span> <span class="o">|=</span> <span class="p">(</span><span class="n">csc</span> <span class="o">&amp;</span> <span class="n">I365_CSC_READY</span><span class="p">)</span> <span class="o">?</span> <span class="n">SS_READY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	    <span class="p">}</span>
	    <span class="n">ISA_UNLOCK</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;socket %d event 0x%02x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>

	    <span class="k">if</span> <span class="p">(</span><span class="n">events</span><span class="p">)</span>
		<span class="n">pcmcia_parse_events</span><span class="p">(</span><span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">,</span> <span class="n">events</span><span class="p">);</span>

	    <span class="n">active</span> <span class="o">|=</span> <span class="n">events</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">active</span><span class="p">)</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">j</span> <span class="o">==</span> <span class="mi">20</span><span class="p">)</span>
	<span class="n">printk</span><span class="p">(</span><span class="n">KERN_NOTICE</span> <span class="s">&quot;i82365: infinite loop in interrupt handler</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>

    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;pcic_interrupt done</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">IRQ_RETVAL</span><span class="p">(</span><span class="n">handled</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* pcic_interrupt */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">pcic_interrupt_wrapper</span><span class="p">(</span><span class="n">u_long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">pcic_interrupt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>
    <span class="n">poll_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">poll_interval</span><span class="p">;</span>
    <span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">poll_timer</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i365_get_status</span><span class="p">(</span><span class="n">u_short</span> <span class="n">sock</span><span class="p">,</span> <span class="n">u_int</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_int</span> <span class="n">status</span><span class="p">;</span>
    
    <span class="n">status</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_STATUS</span><span class="p">);</span>
    <span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="p">((</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">I365_CS_DETECT</span><span class="p">)</span> <span class="o">==</span> <span class="n">I365_CS_DETECT</span><span class="p">)</span>
	<span class="o">?</span> <span class="n">SS_DETECT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
	
    <span class="k">if</span> <span class="p">(</span><span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_INTCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I365_PC_IOCARD</span><span class="p">)</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">I365_CS_STSCHG</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">SS_STSCHG</span><span class="p">;</span>
    <span class="k">else</span> <span class="p">{</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">I365_CS_BVD1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">SS_BATDEAD</span><span class="p">;</span>
	<span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">I365_CS_BVD2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">SS_BATWARN</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">I365_CS_WRPROT</span><span class="p">)</span> <span class="o">?</span> <span class="n">SS_WRPROT</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">I365_CS_READY</span><span class="p">)</span> <span class="o">?</span> <span class="n">SS_READY</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">I365_CS_POWERON</span><span class="p">)</span> <span class="o">?</span> <span class="n">SS_POWERON</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">sock</span><span class="p">].</span><span class="n">type</span> <span class="o">==</span> <span class="n">IS_VG469</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">status</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">VG469_VSENSE</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">sock</span><span class="p">].</span><span class="n">psock</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
	    <span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VG469_VSENSE_B_VS1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">SS_3VCARD</span><span class="p">;</span>
	    <span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VG469_VSENSE_B_VS2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">SS_XVCARD</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	    <span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VG469_VSENSE_A_VS1</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">SS_3VCARD</span><span class="p">;</span>
	    <span class="o">*</span><span class="n">value</span> <span class="o">|=</span> <span class="p">(</span><span class="n">status</span> <span class="o">&amp;</span> <span class="n">VG469_VSENSE_A_VS2</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">SS_XVCARD</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;GetStatus(%d) = %#4.4x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="o">*</span><span class="n">value</span><span class="p">);</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* i365_get_status */</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i365_set_socket</span><span class="p">(</span><span class="n">u_short</span> <span class="n">sock</span><span class="p">,</span> <span class="n">socket_state_t</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">struct</span> <span class="n">i82365_socket</span> <span class="o">*</span><span class="n">t</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">sock</span><span class="p">];</span>
    <span class="n">u_char</span> <span class="n">reg</span><span class="p">;</span>
    
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SetSocket(%d, flags %#3.3x, Vcc %d, Vpp %d, &quot;</span>
	  <span class="s">&quot;io_irq %d, csc_mask %#2.2x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span>
	  <span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">io_irq</span><span class="p">,</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span><span class="p">);</span>
    
    <span class="cm">/* First set global controller options */</span>
    <span class="n">set_bridge_state</span><span class="p">(</span><span class="n">sock</span><span class="p">);</span>
    
    <span class="cm">/* IO card, RESET flag, IO interrupt */</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">intr</span><span class="p">;</span>
    <span class="n">reg</span> <span class="o">|=</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">io_irq</span><span class="p">;</span>
    <span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_RESET</span><span class="p">)</span> <span class="o">?</span> <span class="mi">0</span> <span class="o">:</span> <span class="n">I365_PC_RESET</span><span class="p">;</span>
    <span class="n">reg</span> <span class="o">|=</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_IOCARD</span><span class="p">)</span> <span class="o">?</span> <span class="n">I365_PC_IOCARD</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">i365_set</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_INTCTL</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
    
    <span class="n">reg</span> <span class="o">=</span> <span class="n">I365_PWR_NORESET</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_PWR_AUTO</span><span class="p">)</span> <span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_PWR_AUTO</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_OUTPUT_ENA</span><span class="p">)</span> <span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_PWR_OUT</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_CIRRUS</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span> <span class="o">==</span> <span class="mi">120</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_VPP1_12V</span><span class="p">;</span>
	    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_VPP1_5V</span><span class="p">;</span>
	    <span class="k">else</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_VCC_5V</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span> <span class="o">==</span> <span class="mi">33</span><span class="p">)</span>
		<span class="n">i365_bset</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">PD67_MISC_CTL_1</span><span class="p">,</span> <span class="n">PD67_MC1_VCC_3V</span><span class="p">);</span>
	    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span>
		<span class="n">i365_bclr</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">PD67_MISC_CTL_1</span><span class="p">,</span> <span class="n">PD67_MC1_VCC_3V</span><span class="p">);</span>
	    <span class="k">else</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_VG_PWR</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span> <span class="o">==</span> <span class="mi">120</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_VPP1_12V</span><span class="p">;</span>
	    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span> <span class="o">==</span> <span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span><span class="p">)</span>
		<span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_VPP1_5V</span><span class="p">;</span>
	    <span class="k">else</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_VCC_5V</span><span class="p">;</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span> <span class="o">==</span> <span class="mi">33</span><span class="p">)</span>
		<span class="n">i365_bset</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">VG469_VSELECT</span><span class="p">,</span> <span class="n">VG469_VSEL_VCC</span><span class="p">);</span>
	    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span> <span class="o">==</span> <span class="mi">50</span><span class="p">)</span>
		<span class="n">i365_bclr</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">VG469_VSELECT</span><span class="p">,</span> <span class="n">VG469_VSEL_VCC</span><span class="p">);</span>
	    <span class="k">else</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_DF_PWR</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">33</span>:   	<span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_VCC_3V</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">50</span>:	<span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_VCC_5V</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">50</span>:   	<span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_VPP1_5V</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">120</span>:	<span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_VPP1_12V</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vcc</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">50</span>:	<span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_VCC_5V</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
	<span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">Vpp</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="mi">0</span>:		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">50</span>:	<span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_VPP1_5V</span> <span class="o">|</span> <span class="n">I365_VPP2_5V</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="mi">120</span>:	<span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_VPP1_12V</span> <span class="o">|</span> <span class="n">I365_VPP2_12V</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
	<span class="nl">default:</span>	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>
    <span class="p">}</span>
    
    <span class="k">if</span> <span class="p">(</span><span class="n">reg</span> <span class="o">!=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_POWER</span><span class="p">))</span>
	<span class="n">i365_set</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_POWER</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>

    <span class="cm">/* Chipset-specific functions */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">t</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_CIRRUS</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Speaker control */</span>
	<span class="n">i365_bflip</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">PD67_MISC_CTL_1</span><span class="p">,</span> <span class="n">PD67_MC1_SPKR_ENA</span><span class="p">,</span>
		   <span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_SPKR_ENA</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="cm">/* Card status change interrupt mask */</span>
    <span class="n">reg</span> <span class="o">=</span> <span class="n">t</span><span class="o">-&gt;</span><span class="n">cs_irq</span> <span class="o">&lt;&lt;</span> <span class="mi">4</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_DETECT</span><span class="p">)</span> <span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_CSC_DETECT</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">SS_IOCARD</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_STSCHG</span><span class="p">)</span> <span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_CSC_STSCHG</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_BATDEAD</span><span class="p">)</span> <span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_CSC_BVD1</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_BATWARN</span><span class="p">)</span> <span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_CSC_BVD2</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">state</span><span class="o">-&gt;</span><span class="n">csc_mask</span> <span class="o">&amp;</span> <span class="n">SS_READY</span><span class="p">)</span> <span class="n">reg</span> <span class="o">|=</span> <span class="n">I365_CSC_READY</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">i365_set</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_CSCINT</span><span class="p">,</span> <span class="n">reg</span><span class="p">);</span>
    <span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_CSC</span><span class="p">);</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* i365_set_socket */</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i365_set_io_map</span><span class="p">(</span><span class="n">u_short</span> <span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pccard_io_map</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_char</span> <span class="n">map</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">;</span>
    
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SetIOMap(%d, %d, %#2.2x, %d ns, &quot;</span>
	  <span class="s">&quot;%#llx-%#llx)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
    <span class="n">map</span> <span class="o">=</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">map</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">&gt;</span> <span class="mh">0xffff</span><span class="p">)</span> <span class="o">||</span>
	<span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">stop</span> <span class="o">&lt;</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">))</span> <span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="cm">/* Turn off the window before changing anything */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_ADDRWIN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I365_ENA_IO</span><span class="p">(</span><span class="n">map</span><span class="p">))</span>
	<span class="n">i365_bclr</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_ADDRWIN</span><span class="p">,</span> <span class="n">I365_ENA_IO</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
    <span class="n">i365_set_pair</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_IO</span><span class="p">(</span><span class="n">map</span><span class="p">)</span><span class="o">+</span><span class="n">I365_W_START</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">);</span>
    <span class="n">i365_set_pair</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_IO</span><span class="p">(</span><span class="n">map</span><span class="p">)</span><span class="o">+</span><span class="n">I365_W_STOP</span><span class="p">,</span> <span class="n">io</span><span class="o">-&gt;</span><span class="n">stop</span><span class="p">);</span>
    <span class="n">ioctl</span> <span class="o">=</span> <span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_IOCTL</span><span class="p">)</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">I365_IOCTL_MASK</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">)</span> <span class="n">ioctl</span> <span class="o">|=</span> <span class="n">I365_IOCTL_WAIT</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_0WS</span><span class="p">)</span> <span class="n">ioctl</span> <span class="o">|=</span> <span class="n">I365_IOCTL_0WS</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_16BIT</span><span class="p">)</span> <span class="n">ioctl</span> <span class="o">|=</span> <span class="n">I365_IOCTL_16BIT</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_AUTOSZ</span><span class="p">)</span> <span class="n">ioctl</span> <span class="o">|=</span> <span class="n">I365_IOCTL_IOCS16</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
    <span class="n">i365_set</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_IOCTL</span><span class="p">,</span> <span class="n">ioctl</span><span class="p">);</span>
    <span class="cm">/* Turn on the window if necessary */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">io</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ACTIVE</span><span class="p">)</span>
	<span class="n">i365_bset</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_ADDRWIN</span><span class="p">,</span> <span class="n">I365_ENA_IO</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* i365_set_io_map */</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">i365_set_mem_map</span><span class="p">(</span><span class="n">u_short</span> <span class="n">sock</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pccard_mem_map</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">u_short</span> <span class="n">base</span><span class="p">,</span> <span class="n">i</span><span class="p">;</span>
    <span class="n">u_char</span> <span class="n">map</span><span class="p">;</span>
    
    <span class="n">pr_debug</span><span class="p">(</span><span class="s">&quot;SetMemMap(%d, %d, %#2.2x, %d ns, %#llx-%#llx, &quot;</span>
	  <span class="s">&quot;%#x)</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">sock</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">,</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">,</span>
	  <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="kt">long</span><span class="p">)</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">,</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">card_start</span><span class="p">);</span>

    <span class="n">map</span> <span class="o">=</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">map</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">map</span> <span class="o">&gt;</span> <span class="mi">4</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">card_start</span> <span class="o">&gt;</span> <span class="mh">0x3ffffff</span><span class="p">)</span> <span class="o">||</span>
	<span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">speed</span> <span class="o">&gt;</span> <span class="mi">1000</span><span class="p">))</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">((</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;</span> <span class="mh">0xffffff</span><span class="p">)</span> <span class="o">||</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;</span> <span class="mh">0xffffff</span><span class="p">))</span>
	<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	
    <span class="cm">/* Turn off the window before changing anything */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i365_get</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_ADDRWIN</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">I365_ENA_MEM</span><span class="p">(</span><span class="n">map</span><span class="p">))</span>
	<span class="n">i365_bclr</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_ADDRWIN</span><span class="p">,</span> <span class="n">I365_ENA_MEM</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
    
    <span class="n">base</span> <span class="o">=</span> <span class="n">I365_MEM</span><span class="p">(</span><span class="n">map</span><span class="p">);</span>
    <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_16BIT</span><span class="p">)</span> <span class="n">i</span> <span class="o">|=</span> <span class="n">I365_MEM_16BIT</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_0WS</span><span class="p">)</span> <span class="n">i</span> <span class="o">|=</span> <span class="n">I365_MEM_0WS</span><span class="p">;</span>
    <span class="n">i365_set_pair</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">base</span><span class="o">+</span><span class="n">I365_W_START</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    
    <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">end</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x0fff</span><span class="p">;</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">to_cycles</span><span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">speed</span><span class="p">))</span> <span class="p">{</span>
    <span class="k">case</span> <span class="mi">0</span>:	<span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">1</span>:	<span class="n">i</span> <span class="o">|=</span> <span class="n">I365_MEM_WS0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="k">case</span> <span class="mi">2</span>:	<span class="n">i</span> <span class="o">|=</span> <span class="n">I365_MEM_WS1</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="nl">default:</span>	<span class="n">i</span> <span class="o">|=</span> <span class="n">I365_MEM_WS1</span> <span class="o">|</span> <span class="n">I365_MEM_WS0</span><span class="p">;</span> <span class="k">break</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">i365_set_pair</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">base</span><span class="o">+</span><span class="n">I365_W_STOP</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    
    <span class="n">i</span> <span class="o">=</span> <span class="p">((</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">card_start</span> <span class="o">-</span> <span class="n">mem</span><span class="o">-&gt;</span><span class="n">res</span><span class="o">-&gt;</span><span class="n">start</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">12</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x3fff</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_WRPROT</span><span class="p">)</span> <span class="n">i</span> <span class="o">|=</span> <span class="n">I365_MEM_WRPROT</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ATTRIB</span><span class="p">)</span> <span class="n">i</span> <span class="o">|=</span> <span class="n">I365_MEM_REG</span><span class="p">;</span>
    <span class="n">i365_set_pair</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">base</span><span class="o">+</span><span class="n">I365_W_OFF</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    
    <span class="cm">/* Turn on the window if necessary */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mem</span><span class="o">-&gt;</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">MAP_ACTIVE</span><span class="p">)</span>
	<span class="n">i365_bset</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">I365_ADDRWIN</span><span class="p">,</span> <span class="n">I365_ENA_MEM</span><span class="p">(</span><span class="n">map</span><span class="p">));</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* i365_set_mem_map */</span>

<span class="cp">#if 0</span><span class="c"> /* driver model ordering issue */</span>
<span class="c">/*======================================================================</span>

<span class="c">    Routines for accessing socket information and register dumps via</span>
<span class="c">    /sys/class/pcmcia_socket/...</span>
<span class="c">    </span>
<span class="c">======================================================================*/</span>

<span class="c">static ssize_t show_info(struct class_device *class_dev, char *buf)</span>
<span class="c">{</span>
<span class="c">	struct i82365_socket *s = container_of(class_dev, struct i82365_socket, socket.dev);</span>
<span class="c">	return sprintf(buf, &quot;type:     %s\npsock:    %d\n&quot;,</span>
<span class="c">		       pcic[s-&gt;type].name, s-&gt;psock);</span>
<span class="c">}</span>

<span class="c">static ssize_t show_exca(struct class_device *class_dev, char *buf)</span>
<span class="c">{</span>
<span class="c">	struct i82365_socket *s = container_of(class_dev, struct i82365_socket, socket.dev);</span>
<span class="c">	unsigned short sock;</span>
<span class="c">	int i;</span>
<span class="c">	ssize_t ret = 0;</span>
<span class="c">	unsigned long flags = 0;</span>

<span class="c">	sock = s-&gt;number;</span>

<span class="c">	ISA_LOCK(sock, flags);</span>
<span class="c">	for (i = 0; i &lt; 0x40; i += 4) {</span>
<span class="c">		ret += sprintf(buf, &quot;%02x %02x %02x %02x%s&quot;,</span>
<span class="c">			       i365_get(sock,i), i365_get(sock,i+1),</span>
<span class="c">			       i365_get(sock,i+2), i365_get(sock,i+3),</span>
<span class="c">			       ((i % 16) == 12) ? &quot;\n&quot; : &quot; &quot;);</span>
<span class="c">		buf += ret;</span>
<span class="c">	}</span>
<span class="c">	ISA_UNLOCK(sock, flags);</span>

<span class="c">	return ret;</span>
<span class="c">}</span>

<span class="c">static CLASS_DEVICE_ATTR(exca, S_IRUGO, show_exca, NULL);</span>
<span class="c">static CLASS_DEVICE_ATTR(info, S_IRUGO, show_info, NULL);</span>
<span class="cp">#endif</span>

<span class="cm">/*====================================================================*/</span>

<span class="cm">/* this is horribly ugly... proper locking needs to be done here at </span>
<span class="cm"> * some time... */</span>
<span class="cp">#define LOCKED(x) do { \</span>
<span class="cp">	int retval; \</span>
<span class="cp">	unsigned long flags; \</span>
<span class="cp">	spin_lock_irqsave(&amp;isa_lock, flags); \</span>
<span class="cp">	retval = x; \</span>
<span class="cp">	spin_unlock_irqrestore(&amp;isa_lock, flags); \</span>
<span class="cp">	return retval; \</span>
<span class="cp">} while (0)</span>
	

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcic_get_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">u_int</span> <span class="o">*</span><span class="n">value</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i82365_socket</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">sock</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_ALIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="o">*</span><span class="n">value</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">LOCKED</span><span class="p">(</span><span class="n">i365_get_status</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">value</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcic_set_socket</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="n">socket_state_t</span> <span class="o">*</span><span class="n">state</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i82365_socket</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">sock</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_ALIVE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">LOCKED</span><span class="p">(</span><span class="n">i365_set_socket</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">state</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcic_set_io_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pccard_io_map</span> <span class="o">*</span><span class="n">io</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i82365_socket</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">sock</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_ALIVE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">LOCKED</span><span class="p">(</span><span class="n">i365_set_io_map</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">io</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcic_set_mem_map</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">pccard_mem_map</span> <span class="o">*</span><span class="n">mem</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">sock</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="k">struct</span> <span class="n">i82365_socket</span><span class="p">,</span> <span class="n">socket</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">number</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">sock</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_ALIVE</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">LOCKED</span><span class="p">(</span><span class="n">i365_set_mem_map</span><span class="p">(</span><span class="n">sock</span><span class="p">,</span> <span class="n">mem</span><span class="p">));</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">int</span> <span class="nf">pcic_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">pcmcia_socket</span> <span class="o">*</span><span class="n">s</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
	<span class="k">struct</span> <span class="n">resource</span> <span class="n">res</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="p">.</span><span class="n">end</span> <span class="o">=</span> <span class="mh">0x1000</span> <span class="p">};</span>
	<span class="n">pccard_io_map</span> <span class="n">io</span> <span class="o">=</span> <span class="p">{</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span> <span class="p">};</span>
	<span class="n">pccard_mem_map</span> <span class="n">mem</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">res</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">res</span><span class="p">,</span> <span class="p">};</span>

	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">io</span><span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">pcic_set_io_map</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">io</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">mem</span><span class="p">.</span><span class="n">map</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
		<span class="n">pcic_set_mem_map</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mem</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>


<span class="k">static</span> <span class="k">struct</span> <span class="n">pccard_operations</span> <span class="n">pcic_operations</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">init</span>			<span class="o">=</span> <span class="n">pcic_init</span><span class="p">,</span>
	<span class="p">.</span><span class="n">get_status</span>		<span class="o">=</span> <span class="n">pcic_get_status</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_socket</span>		<span class="o">=</span> <span class="n">pcic_set_socket</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_io_map</span>		<span class="o">=</span> <span class="n">pcic_set_io_map</span><span class="p">,</span>
	<span class="p">.</span><span class="n">set_mem_map</span>		<span class="o">=</span> <span class="n">pcic_set_mem_map</span><span class="p">,</span>
<span class="p">};</span>

<span class="cm">/*====================================================================*/</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_driver</span> <span class="n">i82365_driver</span> <span class="o">=</span> <span class="p">{</span>
	<span class="p">.</span><span class="n">driver</span> <span class="o">=</span> <span class="p">{</span>
		<span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="s">&quot;i82365&quot;</span><span class="p">,</span>
		<span class="p">.</span><span class="n">owner</span>		<span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">,</span>
	<span class="p">},</span>
<span class="p">};</span>

<span class="k">static</span> <span class="k">struct</span> <span class="n">platform_device</span> <span class="o">*</span><span class="n">i82365_device</span><span class="p">;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">__init</span> <span class="nf">init_i82365</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">ret</span><span class="p">;</span>

    <span class="n">ret</span> <span class="o">=</span> <span class="n">platform_driver_register</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i82365_driver</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="k">goto</span> <span class="n">err_out</span><span class="p">;</span>

    <span class="n">i82365_device</span> <span class="o">=</span> <span class="n">platform_device_alloc</span><span class="p">(</span><span class="s">&quot;i82365&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i82365_device</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">ret</span> <span class="o">=</span> <span class="n">platform_device_add</span><span class="p">(</span><span class="n">i82365_device</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
		    <span class="n">platform_device_put</span><span class="p">(</span><span class="n">i82365_device</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span>
	    <span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENOMEM</span><span class="p">;</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="k">goto</span> <span class="n">err_driver_unregister</span><span class="p">;</span>

    <span class="n">printk</span><span class="p">(</span><span class="n">KERN_INFO</span> <span class="s">&quot;Intel ISA PCIC probe: &quot;</span><span class="p">);</span>
    <span class="n">sockets</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">isa_probe</span><span class="p">();</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">sockets</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">printk</span><span class="p">(</span><span class="s">&quot;not found.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="o">-</span><span class="n">ENODEV</span><span class="p">;</span>
	<span class="k">goto</span> <span class="n">err_dev_unregister</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="cm">/* Set up interrupt handler(s) */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">grab_irq</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">ret</span> <span class="o">=</span> <span class="n">request_irq</span><span class="p">(</span><span class="n">cs_irq</span><span class="p">,</span> <span class="n">pcic_interrupt</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="s">&quot;i82365&quot;</span><span class="p">,</span> <span class="n">pcic_interrupt</span><span class="p">);</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">ret</span><span class="p">)</span>
	<span class="k">goto</span> <span class="n">err_socket_release</span><span class="p">;</span>

    <span class="cm">/* register sockets with the pcmcia core */</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sockets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">dev</span><span class="p">.</span><span class="n">parent</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">i82365_device</span><span class="o">-&gt;</span><span class="n">dev</span><span class="p">;</span>
	    <span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pcic_operations</span><span class="p">;</span>
	    <span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">resource_ops</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">pccard_nonstatic_ops</span><span class="p">;</span>
	    <span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">.</span><span class="n">owner</span> <span class="o">=</span> <span class="n">THIS_MODULE</span><span class="p">;</span>
	    <span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">number</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
	    <span class="n">ret</span> <span class="o">=</span> <span class="n">pcmcia_register_socket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">);</span>
	    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">)</span>
		    <span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">|=</span> <span class="n">IS_REGISTERED</span><span class="p">;</span>

<span class="cp">#if 0</span><span class="c"> /* driver model ordering issue */</span>
<span class="c">	   class_device_create_file(&amp;socket[i].socket.dev,</span>
<span class="c">			   	    &amp;class_device_attr_info);</span>
<span class="c">	   class_device_create_file(&amp;socket[i].socket.dev,</span>
<span class="c">			   	    &amp;class_device_attr_exca);</span>
<span class="cp">#endif</span>
    <span class="p">}</span>

    <span class="cm">/* Finally, schedule a polling interrupt */</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">poll_interval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
	<span class="n">poll_timer</span><span class="p">.</span><span class="n">function</span> <span class="o">=</span> <span class="n">pcic_interrupt_wrapper</span><span class="p">;</span>
	<span class="n">poll_timer</span><span class="p">.</span><span class="n">data</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">init_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">poll_timer</span><span class="p">);</span>
    	<span class="n">poll_timer</span><span class="p">.</span><span class="n">expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">poll_interval</span><span class="p">;</span>
	<span class="n">add_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">poll_timer</span><span class="p">);</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="nl">err_socket_release:</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sockets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Turn off all interrupt sources! */</span>
	<span class="n">i365_set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">I365_CSCINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
<span class="nl">err_dev_unregister:</span>
    <span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">i82365_device</span><span class="p">);</span>
    <span class="n">release_region</span><span class="p">(</span><span class="n">i365_base</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PNP</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i82365_pnpdev</span><span class="p">)</span>
	<span class="n">pnp_disable_dev</span><span class="p">(</span><span class="n">i82365_pnpdev</span><span class="p">);</span>
<span class="cp">#endif</span>
<span class="nl">err_driver_unregister:</span>
    <span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i82365_driver</span><span class="p">);</span>
<span class="nl">err_out:</span>
    <span class="k">return</span> <span class="n">ret</span><span class="p">;</span>
<span class="p">}</span> <span class="cm">/* init_i82365 */</span>

<span class="k">static</span> <span class="kt">void</span> <span class="n">__exit</span> <span class="nf">exit_i82365</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>

    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sockets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	    <span class="k">if</span> <span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">flags</span> <span class="o">&amp;</span> <span class="n">IS_REGISTERED</span><span class="p">)</span>
		    <span class="n">pcmcia_unregister_socket</span><span class="p">(</span><span class="o">&amp;</span><span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">socket</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">platform_device_unregister</span><span class="p">(</span><span class="n">i82365_device</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">poll_interval</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">del_timer_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">poll_timer</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">grab_irq</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
	<span class="n">free_irq</span><span class="p">(</span><span class="n">cs_irq</span><span class="p">,</span> <span class="n">pcic_interrupt</span><span class="p">);</span>
    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">sockets</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
	<span class="cm">/* Turn off all interrupt sources! */</span>
	<span class="n">i365_set</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">I365_CSCINT</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">release_region</span><span class="p">(</span><span class="n">socket</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">ioaddr</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="n">release_region</span><span class="p">(</span><span class="n">i365_base</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
<span class="cp">#ifdef CONFIG_PNP</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">i82365_pnpdev</span><span class="p">)</span>
    		<span class="n">pnp_disable_dev</span><span class="p">(</span><span class="n">i82365_pnpdev</span><span class="p">);</span>
<span class="cp">#endif</span>
    <span class="n">platform_driver_unregister</span><span class="p">(</span><span class="o">&amp;</span><span class="n">i82365_driver</span><span class="p">);</span>
<span class="p">}</span> <span class="cm">/* exit_i82365 */</span>

<span class="n">module_init</span><span class="p">(</span><span class="n">init_i82365</span><span class="p">);</span>
<span class="n">module_exit</span><span class="p">(</span><span class="n">exit_i82365</span><span class="p">);</span>
<span class="n">MODULE_LICENSE</span><span class="p">(</span><span class="s">&quot;Dual MPL/GPL&quot;</span><span class="p">);</span>
<span class="cm">/*====================================================================*/</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:2}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../javascript/docco.min.js"></script>
</html>
