<!DOCTYPE html>
<html><head><title>joekychen/linux » drivers › base › power › runtime.c

</title>
<meta http-equiv="content-type" content="text/html; charset=UTF-8">
<meta name="generator" content="Docco">
<link rel="stylesheet" media="all" href="../../../stylesheets/docco.min.css" />


</head>
<body>
<div id="container">
<div id="background"></div>
<table cellpadding="0" cellspacing="0">
<thead><tr><th class="docs"><a id="home" href="../../../index.html"></a><h1>runtime.c</h1></th><th class="code"></th></tr></thead>
<tbody>


<tr id="section-1"><td class="docs"><div class="pilwrap"><a class="pilcrow" href="#section-1">&#182;</a></div></td><td class="code"><div class="highlight"><pre><span class="cm">/*</span>
<span class="cm"> * drivers/base/power/runtime.c - Helper functions for device runtime PM</span>
<span class="cm"> *</span>
<span class="cm"> * Copyright (c) 2009 Rafael J. Wysocki &lt;rjw@sisk.pl&gt;, Novell Inc.</span>
<span class="cm"> * Copyright (C) 2010 Alan Stern &lt;stern@rowland.harvard.edu&gt;</span>
<span class="cm"> *</span>
<span class="cm"> * This file is released under the GPLv2.</span>
<span class="cm"> */</span>

<span class="cp">#include &lt;linux/sched.h&gt;</span>
<span class="cp">#include &lt;linux/export.h&gt;</span>
<span class="cp">#include &lt;linux/pm_runtime.h&gt;</span>
<span class="cp">#include &lt;trace/events/rpm.h&gt;</span>
<span class="cp">#include &quot;power.h&quot;</span>

<span class="k">static</span> <span class="kt">int</span> <span class="n">rpm_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rpmflags</span><span class="p">);</span>
<span class="k">static</span> <span class="kt">int</span> <span class="n">rpm_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rpmflags</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * update_pm_runtime_accounting - Update the time accounting of power states</span>
<span class="cm"> * @dev: Device to update the accounting for</span>
<span class="cm"> *</span>
<span class="cm"> * In order to be able to have time accounting of the various power states</span>
<span class="cm"> * (as used by programs such as PowerTOP to show the effectiveness of runtime</span>
<span class="cm"> * PM), we need to track the time spent in each state.</span>
<span class="cm"> * update_pm_runtime_accounting must be called each time before the</span>
<span class="cm"> * runtime_status field is updated, to account the time in the old state</span>
<span class="cm"> * correctly.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">update_pm_runtime_accounting</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">now</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">delta</span><span class="p">;</span>

	<span class="n">delta</span> <span class="o">=</span> <span class="n">now</span> <span class="o">-</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">accounting_timestamp</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">accounting_timestamp</span> <span class="o">=</span> <span class="n">now</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disable_depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">return</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">RPM_SUSPENDED</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">suspended_jiffies</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">active_jiffies</span> <span class="o">+=</span> <span class="n">delta</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">static</span> <span class="kt">void</span> <span class="nf">__update_runtime_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="k">enum</span> <span class="n">rpm_status</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">update_pm_runtime_accounting</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">=</span> <span class="n">status</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_runtime_deactivate_timer - Deactivate given device&#39;s suspend timer.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm_runtime_deactivate_timer</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_expires</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">del_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">suspend_timer</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_runtime_cancel_pending - Deactivate suspend timer and cancel requests.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm_runtime_cancel_pending</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_runtime_deactivate_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="cm">/*</span>
<span class="cm">	 * In case there&#39;s a request pending, make sure its work function will</span>
<span class="cm">	 * return without doing anything.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">RPM_REQ_NONE</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/*</span>
<span class="cm"> * pm_runtime_autosuspend_expiration - Get a device&#39;s autosuspend-delay expiration time.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> *</span>
<span class="cm"> * Compute the autosuspend-delay expiration time based on the device&#39;s</span>
<span class="cm"> * power.last_busy time.  If the delay has already expired or is disabled</span>
<span class="cm"> * (negative) or the power.use_autosuspend flag isn&#39;t set, return 0.</span>
<span class="cm"> * Otherwise return the expiration time in jiffies (adjusted to be nonzero).</span>
<span class="cm"> *</span>
<span class="cm"> * This function may be called either with or without dev-&gt;power.lock held.</span>
<span class="cm"> * Either way it can be racy, since power.last_busy may be updated at any time.</span>
<span class="cm"> */</span>
<span class="kt">unsigned</span> <span class="kt">long</span> <span class="nf">pm_runtime_autosuspend_expiration</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">autosuspend_delay</span><span class="p">;</span>
	<span class="kt">long</span> <span class="n">elapsed</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">last_busy</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">use_autosuspend</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">autosuspend_delay</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">autosuspend_delay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autosuspend_delay</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">last_busy</span> <span class="o">=</span> <span class="n">ACCESS_ONCE</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">last_busy</span><span class="p">);</span>
	<span class="n">elapsed</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">-</span> <span class="n">last_busy</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>	<span class="cm">/* jiffies has wrapped around. */</span>

	<span class="cm">/*</span>
<span class="cm">	 * If the autosuspend_delay is &gt;= 1 second, align the timer by rounding</span>
<span class="cm">	 * up to the nearest second.</span>
<span class="cm">	 */</span>
	<span class="n">expires</span> <span class="o">=</span> <span class="n">last_busy</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">autosuspend_delay</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">autosuspend_delay</span> <span class="o">&gt;=</span> <span class="mi">1000</span><span class="p">)</span>
		<span class="n">expires</span> <span class="o">=</span> <span class="n">round_jiffies</span><span class="p">(</span><span class="n">expires</span><span class="p">);</span>
	<span class="n">expires</span> <span class="o">+=</span> <span class="o">!</span><span class="n">expires</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">elapsed</span> <span class="o">&gt;=</span> <span class="n">expires</span> <span class="o">-</span> <span class="n">last_busy</span><span class="p">)</span>
		<span class="n">expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>	<span class="cm">/* Already expired. */</span>

 <span class="nl">out:</span>
	<span class="k">return</span> <span class="n">expires</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_runtime_autosuspend_expiration</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * rpm_check_suspend_allowed - Test whether a device may be suspended.</span>
<span class="cm"> * @dev: Device to test.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpm_check_suspend_allowed</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_error</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disable_depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">atomic_read</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pm_children_suspended</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>

	<span class="cm">/* Pending resume requests take precedence over suspends. */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">((</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">deferred_resume</span>
			<span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">RPM_SUSPENDING</span><span class="p">)</span>
	    <span class="o">||</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span>
			<span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span> <span class="o">==</span> <span class="n">RPM_REQ_RESUME</span><span class="p">))</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">RPM_SUSPENDED</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * __rpm_callback - Run a given runtime PM callback for a given device.</span>
<span class="cm"> * @cb: Runtime PM callback to run.</span>
<span class="cm"> * @dev: Device to run the callback for.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">__rpm_callback</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">),</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span> <span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span><span class="p">)</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">cb</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span><span class="p">)</span>
		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">else</span>
		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rpm_idle - Notify device bus type if the device can be suspended.</span>
<span class="cm"> * @dev: Device to notify the bus type about.</span>
<span class="cm"> * @rpmflags: Flag bits.</span>
<span class="cm"> *</span>
<span class="cm"> * Check if the device&#39;s runtime PM status allows it to be suspended.  If</span>
<span class="cm"> * another idle notification has been started earlier, return immediately.  If</span>
<span class="cm"> * the RPM_ASYNC flag is set then queue an idle-notification request; otherwise</span>
<span class="cm"> * run the -&gt;runtime_idle() callback directly.</span>
<span class="cm"> *</span>
<span class="cm"> * This function must be called under dev-&gt;power.lock with interrupts disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpm_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rpmflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">trace_rpm_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rpmflags</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rpm_check_suspend_allowed</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">;</span>	<span class="cm">/* Conditions are wrong. */</span>

	<span class="cm">/* Idle notifications are allowed only in the RPM_ACTIVE state. */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">!=</span> <span class="n">RPM_ACTIVE</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Any pending request other than an idle notification takes</span>
<span class="cm">	 * precedence over us, except that the timer may be running.</span>
<span class="cm">	 */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span> <span class="o">&amp;&amp;</span>
	    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span> <span class="o">&gt;</span> <span class="n">RPM_REQ_IDLE</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>

	<span class="cm">/* Act as though RPM_NOWAIT is always set. */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">idle_notification</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Pending requests need to be canceled. */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">RPM_REQ_NONE</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">no_callbacks</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Assume -&gt;runtime_idle() callback would have suspended. */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rpm_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rpmflags</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Carry out an asynchronous or a synchronous idle notification. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="n">RPM_ASYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">RPM_REQ_IDLE</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">pm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">idle_notification</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">runtime_idle</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_idle</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_idle</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_idle</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">callback</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_idle</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">callback</span><span class="p">)</span>
		<span class="n">__rpm_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">idle_notification</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">trace_rpm_return_int</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>
	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rpm_callback - Run a given runtime PM callback for a given device.</span>
<span class="cm"> * @cb: Runtime PM callback to run.</span>
<span class="cm"> * @dev: Device to run the callback for.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpm_callback</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">cb</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">),</span> <span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">cb</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">ENOSYS</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">__rpm_callback</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_error</span> <span class="o">=</span> <span class="n">retval</span><span class="p">;</span>
	<span class="k">return</span> <span class="n">retval</span> <span class="o">!=</span> <span class="o">-</span><span class="n">EACCES</span> <span class="o">?</span> <span class="n">retval</span> <span class="o">:</span> <span class="o">-</span><span class="n">EIO</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rpm_suspend - Carry out runtime suspend of given device.</span>
<span class="cm"> * @dev: Device to suspend.</span>
<span class="cm"> * @rpmflags: Flag bits.</span>
<span class="cm"> *</span>
<span class="cm"> * Check if the device&#39;s runtime PM status allows it to be suspended.</span>
<span class="cm"> * Cancel a pending idle notification, autosuspend or suspend. If</span>
<span class="cm"> * another suspend has been started earlier, either return immediately</span>
<span class="cm"> * or wait for it to finish, depending on the RPM_NOWAIT and RPM_ASYNC</span>
<span class="cm"> * flags. If the RPM_ASYNC flag is set then queue a suspend request;</span>
<span class="cm"> * otherwise run the -&gt;runtime_suspend() callback directly. When</span>
<span class="cm"> * -&gt;runtime_suspend succeeded, if a deferred resume was requested while</span>
<span class="cm"> * the callback was running then carry it out, otherwise send an idle</span>
<span class="cm"> * notification for its parent (if the suspend succeeded and both</span>
<span class="cm"> * ignore_children of parent-&gt;power and irq_safe of dev-&gt;power are not set).</span>
<span class="cm"> * If -&gt;runtime_suspend failed with -EAGAIN or -EBUSY, and if the RPM_AUTO</span>
<span class="cm"> * flag is set and the next autosuspend-delay expiration time is in the</span>
<span class="cm"> * future, schedule another autosuspend attempt.</span>
<span class="cm"> *</span>
<span class="cm"> * This function must be called under dev-&gt;power.lock with interrupts disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpm_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rpmflags</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span> <span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">trace_rpm_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rpmflags</span><span class="p">);</span>

 <span class="nl">repeat:</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rpm_check_suspend_allowed</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="p">;</span>	<span class="cm">/* Conditions are wrong. */</span>

	<span class="cm">/* Synchronous suspends are not allowed in the RPM_RESUMING state. */</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">RPM_RESUMING</span> <span class="o">&amp;&amp;</span>
	    <span class="o">!</span><span class="p">(</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="n">RPM_ASYNC</span><span class="p">))</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* If the autosuspend_delay time hasn&#39;t expired yet, reschedule. */</span>
	<span class="k">if</span> <span class="p">((</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="n">RPM_AUTO</span><span class="p">)</span>
	    <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">!=</span> <span class="n">RPM_SUSPENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires</span> <span class="o">=</span> <span class="n">pm_runtime_autosuspend_expiration</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">expires</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="cm">/* Pending requests need to be canceled. */</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">RPM_REQ_NONE</span><span class="p">;</span>

			<span class="cm">/*</span>
<span class="cm">			 * Optimization: If the timer is already running and is</span>
<span class="cm">			 * set to expire at or before the autosuspend delay,</span>
<span class="cm">			 * avoid the overhead of resetting it.  Just let it</span>
<span class="cm">			 * expire; pm_suspend_timer_fn() will take care of the</span>
<span class="cm">			 * rest.</span>
<span class="cm">			 */</span>
			<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_expires</span> <span class="o">&amp;&amp;</span> <span class="n">time_before_eq</span><span class="p">(</span>
			    <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_expires</span><span class="p">,</span> <span class="n">expires</span><span class="p">)))</span> <span class="p">{</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_expires</span> <span class="o">=</span> <span class="n">expires</span><span class="p">;</span>
				<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">suspend_timer</span><span class="p">,</span> <span class="n">expires</span><span class="p">);</span>
			<span class="p">}</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_autosuspends</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Other scheduled or pending requests need to be canceled. */</span>
	<span class="n">pm_runtime_cancel_pending</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">RPM_SUSPENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RPM_ASYNC</span> <span class="o">|</span> <span class="n">RPM_NOWAIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

			<span class="n">cpu_relax</span><span class="p">();</span>

			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Wait for the other suspend running in parallel with us. */</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span>
					<span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">!=</span> <span class="n">RPM_SUSPENDING</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

			<span class="n">schedule</span><span class="p">();</span>

			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">deferred_resume</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">no_callbacks</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_callback</span><span class="p">;</span>	<span class="cm">/* Assume success. */</span>

	<span class="cm">/* Carry out an asynchronous or a synchronous suspend. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="n">RPM_ASYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="p">(</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="n">RPM_AUTO</span><span class="p">)</span> <span class="o">?</span>
		    <span class="n">RPM_REQ_AUTOSUSPEND</span> <span class="o">:</span> <span class="n">RPM_REQ_SUSPEND</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">pm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">__dev_pm_qos_read_value</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* Negative PM QoS constraint means &quot;never suspend&quot;. */</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EPERM</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__update_runtime_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPM_SUSPENDING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">runtime_suspend</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_suspend</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_suspend</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_suspend</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">callback</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_suspend</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rpm_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">fail</span><span class="p">;</span>

 <span class="nl">no_callback:</span>
	<span class="n">__update_runtime_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPM_SUSPENDED</span><span class="p">);</span>
	<span class="n">pm_runtime_deactivate_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
		<span class="n">atomic_add_unless</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">child_count</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">deferred_resume</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rpm_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/* Maybe the parent is now able to suspend. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">ignore_children</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">rpm_idle</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="n">RPM_ASYNC</span><span class="p">);</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">trace_rpm_return_int</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>

 <span class="nl">fail:</span>
	<span class="n">__update_runtime_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPM_ACTIVE</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">deferred_resume</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">EAGAIN</span> <span class="o">||</span> <span class="n">retval</span> <span class="o">==</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

		<span class="cm">/*</span>
<span class="cm">		 * If the callback routine failed an autosuspend, and</span>
<span class="cm">		 * if the last_busy time has been updated so that there</span>
<span class="cm">		 * is a new autosuspend expiration time, automatically</span>
<span class="cm">		 * reschedule another autosuspend.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">((</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="n">RPM_AUTO</span><span class="p">)</span> <span class="o">&amp;&amp;</span>
		    <span class="n">pm_runtime_autosuspend_expiration</span><span class="p">(</span><span class="n">dev</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
		<span class="n">pm_runtime_cancel_pending</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * rpm_resume - Carry out runtime resume of given device.</span>
<span class="cm"> * @dev: Device to resume.</span>
<span class="cm"> * @rpmflags: Flag bits.</span>
<span class="cm"> *</span>
<span class="cm"> * Check if the device&#39;s runtime PM status allows it to be resumed.  Cancel</span>
<span class="cm"> * any scheduled or pending requests.  If another resume has been started</span>
<span class="cm"> * earlier, either return immediately or wait for it to finish, depending on the</span>
<span class="cm"> * RPM_NOWAIT and RPM_ASYNC flags.  Similarly, if there&#39;s a suspend running in</span>
<span class="cm"> * parallel with this function, either tell the other process to resume after</span>
<span class="cm"> * suspending (deferred_resume) or wait for it to finish.  If the RPM_ASYNC</span>
<span class="cm"> * flag is set then queue a resume request; otherwise run the</span>
<span class="cm"> * -&gt;runtime_resume() callback directly.  Queue an idle notification for the</span>
<span class="cm"> * device if the resume succeeded.</span>
<span class="cm"> *</span>
<span class="cm"> * This function must be called under dev-&gt;power.lock with interrupts disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">int</span> <span class="nf">rpm_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rpmflags</span><span class="p">)</span>
	<span class="n">__releases</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span> <span class="n">__acquires</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="p">(</span><span class="o">*</span><span class="n">callback</span><span class="p">)(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">);</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">trace_rpm_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rpmflags</span><span class="p">);</span>

 <span class="nl">repeat:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_error</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disable_depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EACCES</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/*</span>
<span class="cm">	 * Other scheduled or pending requests need to be canceled.  Small</span>
<span class="cm">	 * optimization: If an autosuspend timer is running, leave it running</span>
<span class="cm">	 * rather than cancelling it now only to restart it again in the near</span>
<span class="cm">	 * future.</span>
<span class="cm">	 */</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">RPM_REQ_NONE</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_autosuspends</span><span class="p">)</span>
		<span class="n">pm_runtime_deactivate_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">RPM_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">RPM_RESUMING</span>
	    <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">RPM_SUSPENDING</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">RPM_ASYNC</span> <span class="o">|</span> <span class="n">RPM_NOWAIT</span><span class="p">))</span> <span class="p">{</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">RPM_SUSPENDING</span><span class="p">)</span>
				<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">deferred_resume</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="k">else</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EINPROGRESS</span><span class="p">;</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

			<span class="n">cpu_relax</span><span class="p">();</span>

			<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
		<span class="p">}</span>

		<span class="cm">/* Wait for the operation carried out in parallel with us. */</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span>
					<span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">!=</span> <span class="n">RPM_RESUMING</span>
			    <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">!=</span> <span class="n">RPM_SUSPENDING</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>

			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

			<span class="n">schedule</span><span class="p">();</span>

			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * See if we can skip waking up the parent.  This is safe only if</span>
<span class="cm">	 * power.no_callbacks is set, because otherwise we don&#39;t know whether</span>
<span class="cm">	 * the resume will actually succeed.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">no_callbacks</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disable_depth</span> <span class="o">&gt;</span> <span class="mi">0</span>
		    <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">ignore_children</span>
		    <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">RPM_ACTIVE</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">child_count</span><span class="p">);</span>
			<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
			<span class="k">goto</span> <span class="n">no_callback</span><span class="p">;</span>	<span class="cm">/* Assume success. */</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="cm">/* Carry out an asynchronous or a synchronous resume. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="n">RPM_ASYNC</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">RPM_REQ_RESUME</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
			<span class="n">queue_work</span><span class="p">(</span><span class="n">pm_wq</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Increment the parent&#39;s usage counter and resume it if</span>
<span class="cm">		 * necessary.  Not needed if dev is irq-safe; then the</span>
<span class="cm">		 * parent is permanently resumed.</span>
<span class="cm">		 */</span>
		<span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">skip_parent</span><span class="p">;</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">pm_runtime_get_noresume</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="cm">/*</span>
<span class="cm">		 * We can resume if the parent&#39;s runtime PM is disabled or it</span>
<span class="cm">		 * is set to ignore children.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disable_depth</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">ignore_children</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">rpm_resume</span><span class="p">(</span><span class="n">parent</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">!=</span> <span class="n">RPM_ACTIVE</span><span class="p">)</span>
				<span class="n">retval</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">spin_lock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">repeat</span><span class="p">;</span>
	<span class="p">}</span>
 <span class="nl">skip_parent:</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">no_callbacks</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">no_callback</span><span class="p">;</span>	<span class="cm">/* Assume success. */</span>

	<span class="n">__update_runtime_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPM_RESUMING</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">pm_domain</span><span class="o">-&gt;</span><span class="n">ops</span><span class="p">.</span><span class="n">runtime_resume</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">type</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_resume</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">class</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_resume</span><span class="p">;</span>
	<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">bus</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_resume</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">callback</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="p">)</span>
		<span class="n">callback</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">driver</span><span class="o">-&gt;</span><span class="n">pm</span><span class="o">-&gt;</span><span class="n">runtime_resume</span><span class="p">;</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rpm_callback</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">__update_runtime_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPM_SUSPENDED</span><span class="p">);</span>
		<span class="n">pm_runtime_cancel_pending</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
 <span class="nl">no_callback:</span>
		<span class="n">__update_runtime_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPM_ACTIVE</span><span class="p">);</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">child_count</span><span class="p">);</span>
	<span class="p">}</span>
	<span class="n">wake_up_all</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">retval</span><span class="p">)</span>
		<span class="n">rpm_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPM_ASYNC</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">pm_runtime_put</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">trace_rpm_return_int</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">_THIS_IP_</span><span class="p">,</span> <span class="n">retval</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_runtime_work - Universal runtime PM work function.</span>
<span class="cm"> * @work: Work structure used for scheduling the execution of this function.</span>
<span class="cm"> *</span>
<span class="cm"> * Use @work to get the device object the work is to be done for, determine what</span>
<span class="cm"> * is to be done and execute the appropriate runtime PM function.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm_runtime_work</span><span class="p">(</span><span class="k">struct</span> <span class="n">work_struct</span> <span class="o">*</span><span class="n">work</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="n">container_of</span><span class="p">(</span><span class="n">work</span><span class="p">,</span> <span class="k">struct</span> <span class="n">device</span><span class="p">,</span> <span class="n">power</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>
	<span class="k">enum</span> <span class="n">rpm_request</span> <span class="n">req</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">req</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">RPM_REQ_NONE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="k">switch</span> <span class="p">(</span><span class="n">req</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">case</span> <span class="n">RPM_REQ_NONE</span>:
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPM_REQ_IDLE</span>:
		<span class="n">rpm_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPM_NOWAIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPM_REQ_SUSPEND</span>:
		<span class="n">rpm_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPM_NOWAIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPM_REQ_AUTOSUSPEND</span>:
		<span class="n">rpm_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPM_NOWAIT</span> <span class="o">|</span> <span class="n">RPM_AUTO</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="k">case</span> <span class="n">RPM_REQ_RESUME</span>:
		<span class="n">rpm_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPM_NOWAIT</span><span class="p">);</span>
		<span class="k">break</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_suspend_timer_fn - Timer function for pm_schedule_suspend().</span>
<span class="cm"> * @data: Device pointer passed by pm_schedule_suspend().</span>
<span class="cm"> *</span>
<span class="cm"> * Check if the time is right and queue a suspend request.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">pm_suspend_timer_fn</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">data</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="p">)</span><span class="n">data</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">expires</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="n">expires</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_expires</span><span class="p">;</span>
	<span class="cm">/* If &#39;expire&#39; is after &#39;jiffies&#39; we&#39;ve been called too early. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">expires</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">time_after</span><span class="p">(</span><span class="n">expires</span><span class="p">,</span> <span class="n">jiffies</span><span class="p">))</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
		<span class="n">rpm_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_autosuspends</span> <span class="o">?</span>
		    <span class="p">(</span><span class="n">RPM_ASYNC</span> <span class="o">|</span> <span class="n">RPM_AUTO</span><span class="p">)</span> <span class="o">:</span> <span class="n">RPM_ASYNC</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_schedule_suspend - Set up a timer to submit a suspend request in future.</span>
<span class="cm"> * @dev: Device to suspend.</span>
<span class="cm"> * @delay: Time to wait before submitting a suspend request, in milliseconds.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pm_schedule_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">delay</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="n">rpm_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPM_ASYNC</span><span class="p">);</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">retval</span> <span class="o">=</span> <span class="n">rpm_check_suspend_allowed</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">retval</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="cm">/* Other scheduled or pending requests need to be canceled. */</span>
	<span class="n">pm_runtime_cancel_pending</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_expires</span> <span class="o">=</span> <span class="n">jiffies</span> <span class="o">+</span> <span class="n">msecs_to_jiffies</span><span class="p">(</span><span class="n">delay</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_expires</span> <span class="o">+=</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_expires</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_autosuspends</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">mod_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">suspend_timer</span><span class="p">,</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_expires</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_schedule_suspend</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __pm_runtime_idle - Entry point for runtime idle operations.</span>
<span class="cm"> * @dev: Device to send idle notification for.</span>
<span class="cm"> * @rpmflags: Flag bits.</span>
<span class="cm"> *</span>
<span class="cm"> * If the RPM_GET_PUT flag is set, decrement the device&#39;s usage count and</span>
<span class="cm"> * return immediately if it is larger than zero.  Then carry out an idle</span>
<span class="cm"> * notification, either synchronous or asynchronous.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine may be called in atomic context if the RPM_ASYNC flag is set,</span>
<span class="cm"> * or if pm_runtime_irq_safe() has been called.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__pm_runtime_idle</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rpmflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">might_sleep_if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="n">RPM_ASYNC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="n">RPM_GET_PUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rpm_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rpmflags</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__pm_runtime_idle</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __pm_runtime_suspend - Entry point for runtime put/suspend operations.</span>
<span class="cm"> * @dev: Device to suspend.</span>
<span class="cm"> * @rpmflags: Flag bits.</span>
<span class="cm"> *</span>
<span class="cm"> * If the RPM_GET_PUT flag is set, decrement the device&#39;s usage count and</span>
<span class="cm"> * return immediately if it is larger than zero.  Then carry out a suspend,</span>
<span class="cm"> * either synchronous or asynchronous.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine may be called in atomic context if the RPM_ASYNC flag is set,</span>
<span class="cm"> * or if pm_runtime_irq_safe() has been called.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__pm_runtime_suspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rpmflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">might_sleep_if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="n">RPM_ASYNC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="n">RPM_GET_PUT</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">))</span>
			<span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rpm_suspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rpmflags</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__pm_runtime_suspend</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __pm_runtime_resume - Entry point for runtime resume operations.</span>
<span class="cm"> * @dev: Device to resume.</span>
<span class="cm"> * @rpmflags: Flag bits.</span>
<span class="cm"> *</span>
<span class="cm"> * If the RPM_GET_PUT flag is set, increment the device&#39;s usage count.  Then</span>
<span class="cm"> * carry out a resume, either synchronous or asynchronous.</span>
<span class="cm"> *</span>
<span class="cm"> * This routine may be called in atomic context if the RPM_ASYNC flag is set,</span>
<span class="cm"> * or if pm_runtime_irq_safe() has been called.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__pm_runtime_resume</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">rpmflags</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">retval</span><span class="p">;</span>

	<span class="n">might_sleep_if</span><span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="n">RPM_ASYNC</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">rpmflags</span> <span class="o">&amp;</span> <span class="n">RPM_GET_PUT</span><span class="p">)</span>
		<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">);</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
	<span class="n">retval</span> <span class="o">=</span> <span class="n">rpm_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">rpmflags</span><span class="p">);</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__pm_runtime_resume</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __pm_runtime_set_status - Set runtime PM status of a device.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> * @status: New runtime PM status of the device.</span>
<span class="cm"> *</span>
<span class="cm"> * If runtime PM of the device is disabled or its power.runtime_error field is</span>
<span class="cm"> * different from zero, the status may be changed either to RPM_ACTIVE, or to</span>
<span class="cm"> * RPM_SUSPENDED, as long as that reflects the actual state of the device.</span>
<span class="cm"> * However, if the device has a parent and the parent is not active, and the</span>
<span class="cm"> * parent&#39;s power.ignore_children flag is unset, the device&#39;s status cannot be</span>
<span class="cm"> * set to RPM_ACTIVE, so -EBUSY is returned in that case.</span>
<span class="cm"> *</span>
<span class="cm"> * If successful, __pm_runtime_set_status() clears the power.runtime_error field</span>
<span class="cm"> * and the device parent&#39;s counter of unsuspended children is modified to</span>
<span class="cm"> * reflect the new status.  If the new status is RPM_SUSPENDED, an idle</span>
<span class="cm"> * notification request for the parent is submitted.</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">__pm_runtime_set_status</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">status</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">parent</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">;</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>
	<span class="n">bool</span> <span class="n">notify_parent</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="kt">int</span> <span class="n">error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">!=</span> <span class="n">RPM_ACTIVE</span> <span class="o">&amp;&amp;</span> <span class="n">status</span> <span class="o">!=</span> <span class="n">RPM_SUSPENDED</span><span class="p">)</span>
		<span class="k">return</span> <span class="o">-</span><span class="n">EINVAL</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_error</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disable_depth</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EAGAIN</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">status</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out_set</span><span class="p">;</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">status</span> <span class="o">==</span> <span class="n">RPM_SUSPENDED</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/* It always is possible to set the status to &#39;suspended&#39;. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_add_unless</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">child_count</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
			<span class="n">notify_parent</span> <span class="o">=</span> <span class="o">!</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">ignore_children</span><span class="p">;</span>
		<span class="p">}</span>
		<span class="k">goto</span> <span class="n">out_set</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">parent</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">spin_lock_nested</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">SINGLE_DEPTH_NESTING</span><span class="p">);</span>

		<span class="cm">/*</span>
<span class="cm">		 * It is invalid to put an active child under a parent that is</span>
<span class="cm">		 * not active, has runtime PM enabled and the</span>
<span class="cm">		 * &#39;power.ignore_children&#39; flag unset.</span>
<span class="cm">		 */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disable_depth</span>
		    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">ignore_children</span>
		    <span class="o">&amp;&amp;</span> <span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">!=</span> <span class="n">RPM_ACTIVE</span><span class="p">)</span>
			<span class="n">error</span> <span class="o">=</span> <span class="o">-</span><span class="n">EBUSY</span><span class="p">;</span>
		<span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">RPM_SUSPENDED</span><span class="p">)</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">child_count</span><span class="p">);</span>

		<span class="n">spin_unlock</span><span class="p">(</span><span class="o">&amp;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="k">if</span> <span class="p">(</span><span class="n">error</span><span class="p">)</span>
			<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

 <span class="nl">out_set:</span>
	<span class="n">__update_runtime_status</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">status</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
 <span class="nl">out:</span>
	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">notify_parent</span><span class="p">)</span>
		<span class="n">pm_request_idle</span><span class="p">(</span><span class="n">parent</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">error</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__pm_runtime_set_status</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __pm_runtime_barrier - Cancel pending requests and wait for completions.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> *</span>
<span class="cm"> * Flush all pending requests for the device from pm_wq and wait for all</span>
<span class="cm"> * runtime PM operations involving the device in progress to complete.</span>
<span class="cm"> *</span>
<span class="cm"> * Should be called under dev-&gt;power.lock with interrupts disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">__pm_runtime_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">pm_runtime_deactivate_timer</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">RPM_REQ_NONE</span><span class="p">;</span>
		<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

		<span class="n">cancel_work_sync</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">work</span><span class="p">);</span>

		<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">RPM_SUSPENDING</span>
	    <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">RPM_RESUMING</span>
	    <span class="o">||</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">idle_notification</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">DEFINE_WAIT</span><span class="p">(</span><span class="n">wait</span><span class="p">);</span>

		<span class="cm">/* Suspend, wake-up or idle notification in progress. */</span>
		<span class="k">for</span> <span class="p">(;;)</span> <span class="p">{</span>
			<span class="n">prepare_to_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">,</span>
					<span class="n">TASK_UNINTERRUPTIBLE</span><span class="p">);</span>
			<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">!=</span> <span class="n">RPM_SUSPENDING</span>
			    <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">!=</span> <span class="n">RPM_RESUMING</span>
			    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">idle_notification</span><span class="p">)</span>
				<span class="k">break</span><span class="p">;</span>
			<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

			<span class="n">schedule</span><span class="p">();</span>

			<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
		<span class="p">}</span>
		<span class="n">finish_wait</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">wait</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_runtime_barrier - Flush pending requests and wait for completions.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> *</span>
<span class="cm"> * Prevent the device from being suspended by incrementing its usage counter and</span>
<span class="cm"> * if there&#39;s a pending resume request for the device, wake the device up.</span>
<span class="cm"> * Next, make sure that all pending requests for the device have been flushed</span>
<span class="cm"> * from pm_wq and wait for all runtime PM operations involving the device in</span>
<span class="cm"> * progress to complete.</span>
<span class="cm"> *</span>
<span class="cm"> * Return value:</span>
<span class="cm"> * 1, if there was a resume request pending and the device had to be woken up,</span>
<span class="cm"> * 0, otherwise</span>
<span class="cm"> */</span>
<span class="kt">int</span> <span class="nf">pm_runtime_barrier</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">retval</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">pm_runtime_get_noresume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span>
	    <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span> <span class="o">==</span> <span class="n">RPM_REQ_RESUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">rpm_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="n">retval</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="n">__pm_runtime_barrier</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">pm_runtime_put_noidle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

	<span class="k">return</span> <span class="n">retval</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_runtime_barrier</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __pm_runtime_disable - Disable runtime PM of a device.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> * @check_resume: If set, check if there&#39;s a resume request for the device.</span>
<span class="cm"> *</span>
<span class="cm"> * Increment power.disable_depth for the device and if was zero previously,</span>
<span class="cm"> * cancel all pending runtime PM requests for the device and wait for all</span>
<span class="cm"> * operations in progress to complete.  The device can be either active or</span>
<span class="cm"> * suspended after its runtime PM has been disabled.</span>
<span class="cm"> *</span>
<span class="cm"> * If @check_resume is set and there&#39;s a resume request pending when</span>
<span class="cm"> * __pm_runtime_disable() is called and power.disable_depth is zero, the</span>
<span class="cm"> * function will wake up the device before disabling its runtime PM.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__pm_runtime_disable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">check_resume</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disable_depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disable_depth</span><span class="o">++</span><span class="p">;</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>
	<span class="p">}</span>

	<span class="cm">/*</span>
<span class="cm">	 * Wake up the device if there&#39;s a resume request pending, because that</span>
<span class="cm">	 * means there probably is some I/O to process and disabling runtime PM</span>
<span class="cm">	 * shouldn&#39;t prevent the device from processing the I/O.</span>
<span class="cm">	 */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">check_resume</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span>
	    <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span> <span class="o">==</span> <span class="n">RPM_REQ_RESUME</span><span class="p">)</span> <span class="p">{</span>
		<span class="cm">/*</span>
<span class="cm">		 * Prevent suspends and idle notifications from being carried</span>
<span class="cm">		 * out after we have woken up the device.</span>
<span class="cm">		 */</span>
		<span class="n">pm_runtime_get_noresume</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

		<span class="n">rpm_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

		<span class="n">pm_runtime_put_noidle</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="p">}</span>

	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disable_depth</span><span class="o">++</span><span class="p">)</span>
		<span class="n">__pm_runtime_barrier</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__pm_runtime_disable</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pm_runtime_enable - Enable runtime PM of a device.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_runtime_enable</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">unsigned</span> <span class="kt">long</span> <span class="n">flags</span><span class="p">;</span>

	<span class="n">spin_lock_irqsave</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>

	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disable_depth</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
		<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disable_depth</span><span class="o">--</span><span class="p">;</span>
	<span class="k">else</span>
		<span class="n">dev_warn</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="s">&quot;Unbalanced %s!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">__func__</span><span class="p">);</span>

	<span class="n">spin_unlock_irqrestore</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">,</span> <span class="n">flags</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_runtime_enable</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pm_runtime_forbid - Block runtime PM of a device.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> *</span>
<span class="cm"> * Increase the device&#39;s usage count and clear its power.runtime_auto flag,</span>
<span class="cm"> * so that it cannot be suspended at run time until pm_runtime_allow() is called</span>
<span class="cm"> * for it.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_runtime_forbid</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_auto</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_auto</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">);</span>
	<span class="n">rpm_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_runtime_forbid</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pm_runtime_allow - Unblock runtime PM of a device.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> *</span>
<span class="cm"> * Decrease the device&#39;s usage count and set its power.runtime_auto flag.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_runtime_allow</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_auto</span><span class="p">)</span>
		<span class="k">goto</span> <span class="n">out</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_auto</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">atomic_dec_and_test</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">))</span>
		<span class="n">rpm_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPM_AUTO</span><span class="p">);</span>

 <span class="nl">out:</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_runtime_allow</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pm_runtime_no_callbacks - Ignore runtime PM callbacks for a device.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> *</span>
<span class="cm"> * Set the power.no_callbacks flag, which tells the PM core that this</span>
<span class="cm"> * device is power-managed through its parent and has no runtime PM</span>
<span class="cm"> * callbacks of its own.  The runtime sysfs attributes will be removed.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_runtime_no_callbacks</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">no_callbacks</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">device_is_registered</span><span class="p">(</span><span class="n">dev</span><span class="p">))</span>
		<span class="n">rpm_sysfs_remove</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_runtime_no_callbacks</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pm_runtime_irq_safe - Leave interrupts disabled during callbacks.</span>
<span class="cm"> * @dev: Device to handle</span>
<span class="cm"> *</span>
<span class="cm"> * Set the power.irq_safe flag, which tells the PM core that the</span>
<span class="cm"> * -&gt;runtime_suspend() and -&gt;runtime_resume() callbacks for this device should</span>
<span class="cm"> * always be invoked with the spinlock held and interrupts disabled.  It also</span>
<span class="cm"> * causes the parent&#39;s usage counter to be permanently incremented, preventing</span>
<span class="cm"> * the parent from runtime suspending -- otherwise an irq-safe child might have</span>
<span class="cm"> * to wait for a non-irq-safe parent.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_runtime_irq_safe</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">pm_runtime_get_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_runtime_irq_safe</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * update_autosuspend - Handle a change to a device&#39;s autosuspend settings.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> * @old_delay: The former autosuspend_delay value.</span>
<span class="cm"> * @old_use: The former use_autosuspend value.</span>
<span class="cm"> *</span>
<span class="cm"> * Prevent runtime suspend if the new delay is negative and use_autosuspend is</span>
<span class="cm"> * set; otherwise allow it.  Send an idle notification if suspends are allowed.</span>
<span class="cm"> *</span>
<span class="cm"> * This function must be called under dev-&gt;power.lock with interrupts disabled.</span>
<span class="cm"> */</span>
<span class="k">static</span> <span class="kt">void</span> <span class="nf">update_autosuspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">old_delay</span><span class="p">,</span> <span class="kt">int</span> <span class="n">old_use</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">delay</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">autosuspend_delay</span><span class="p">;</span>

	<span class="cm">/* Should runtime suspend be prevented now? */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">use_autosuspend</span> <span class="o">&amp;&amp;</span> <span class="n">delay</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>

		<span class="cm">/* If it used to be allowed then prevent it. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">old_use</span> <span class="o">||</span> <span class="n">old_delay</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
			<span class="n">atomic_inc</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">);</span>
			<span class="n">rpm_resume</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
		<span class="p">}</span>
	<span class="p">}</span>

	<span class="cm">/* Runtime suspend should be allowed now. */</span>
	<span class="k">else</span> <span class="p">{</span>

		<span class="cm">/* If it used to be prevented then allow it. */</span>
		<span class="k">if</span> <span class="p">(</span><span class="n">old_use</span> <span class="o">&amp;&amp;</span> <span class="n">old_delay</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
			<span class="n">atomic_dec</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">);</span>

		<span class="cm">/* Maybe we can autosuspend now. */</span>
		<span class="n">rpm_idle</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">RPM_AUTO</span><span class="p">);</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_runtime_set_autosuspend_delay - Set a device&#39;s autosuspend_delay value.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> * @delay: Value of the new delay in milliseconds.</span>
<span class="cm"> *</span>
<span class="cm"> * Set the device&#39;s power.autosuspend_delay value.  If it changes to negative</span>
<span class="cm"> * and the power.use_autosuspend flag is set, prevent runtime suspends.  If it</span>
<span class="cm"> * changes the other way, allow runtime suspends.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_runtime_set_autosuspend_delay</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="kt">int</span> <span class="n">delay</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">old_delay</span><span class="p">,</span> <span class="n">old_use</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">old_delay</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">autosuspend_delay</span><span class="p">;</span>
	<span class="n">old_use</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">use_autosuspend</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">autosuspend_delay</span> <span class="o">=</span> <span class="n">delay</span><span class="p">;</span>
	<span class="n">update_autosuspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">old_delay</span><span class="p">,</span> <span class="n">old_use</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">pm_runtime_set_autosuspend_delay</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * __pm_runtime_use_autosuspend - Set a device&#39;s use_autosuspend flag.</span>
<span class="cm"> * @dev: Device to handle.</span>
<span class="cm"> * @use: New value for use_autosuspend.</span>
<span class="cm"> *</span>
<span class="cm"> * Set the device&#39;s power.use_autosuspend flag, and allow or prevent runtime</span>
<span class="cm"> * suspends as needed.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">__pm_runtime_use_autosuspend</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">,</span> <span class="n">bool</span> <span class="n">use</span><span class="p">)</span>
<span class="p">{</span>
	<span class="kt">int</span> <span class="n">old_delay</span><span class="p">,</span> <span class="n">old_use</span><span class="p">;</span>

	<span class="n">spin_lock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
	<span class="n">old_delay</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">autosuspend_delay</span><span class="p">;</span>
	<span class="n">old_use</span> <span class="o">=</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">use_autosuspend</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">use_autosuspend</span> <span class="o">=</span> <span class="n">use</span><span class="p">;</span>
	<span class="n">update_autosuspend</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="n">old_delay</span><span class="p">,</span> <span class="n">old_use</span><span class="p">);</span>
	<span class="n">spin_unlock_irq</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">lock</span><span class="p">);</span>
<span class="p">}</span>
<span class="n">EXPORT_SYMBOL_GPL</span><span class="p">(</span><span class="n">__pm_runtime_use_autosuspend</span><span class="p">);</span>

<span class="cm">/**</span>
<span class="cm"> * pm_runtime_init - Initialize runtime PM fields in given device object.</span>
<span class="cm"> * @dev: Device object to initialize.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_runtime_init</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">=</span> <span class="n">RPM_SUSPENDED</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">idle_notification</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">disable_depth</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">usage_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_error</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

	<span class="n">atomic_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">child_count</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
	<span class="n">pm_suspend_ignore_children</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_auto</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request_pending</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">RPM_REQ_NONE</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">deferred_resume</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">accounting_timestamp</span> <span class="o">=</span> <span class="n">jiffies</span><span class="p">;</span>
	<span class="n">INIT_WORK</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">work</span><span class="p">,</span> <span class="n">pm_runtime_work</span><span class="p">);</span>

	<span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">timer_expires</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
	<span class="n">setup_timer</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">suspend_timer</span><span class="p">,</span> <span class="n">pm_suspend_timer_fn</span><span class="p">,</span>
			<span class="p">(</span><span class="kt">unsigned</span> <span class="kt">long</span><span class="p">)</span><span class="n">dev</span><span class="p">);</span>

	<span class="n">init_waitqueue_head</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">wait_queue</span><span class="p">);</span>
<span class="p">}</span>

<span class="cm">/**</span>
<span class="cm"> * pm_runtime_remove - Prepare for removing a device from device hierarchy.</span>
<span class="cm"> * @dev: Device object being removed from device hierarchy.</span>
<span class="cm"> */</span>
<span class="kt">void</span> <span class="nf">pm_runtime_remove</span><span class="p">(</span><span class="k">struct</span> <span class="n">device</span> <span class="o">*</span><span class="n">dev</span><span class="p">)</span>
<span class="p">{</span>
	<span class="n">__pm_runtime_disable</span><span class="p">(</span><span class="n">dev</span><span class="p">,</span> <span class="nb">false</span><span class="p">);</span>

	<span class="cm">/* Change the status back to &#39;suspended&#39; to match the initial status. */</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">runtime_status</span> <span class="o">==</span> <span class="n">RPM_ACTIVE</span><span class="p">)</span>
		<span class="n">pm_runtime_set_suspended</span><span class="p">(</span><span class="n">dev</span><span class="p">);</span>
	<span class="k">if</span> <span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">power</span><span class="p">.</span><span class="n">irq_safe</span> <span class="o">&amp;&amp;</span> <span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">)</span>
		<span class="n">pm_runtime_put_sync</span><span class="p">(</span><span class="n">dev</span><span class="o">-&gt;</span><span class="n">parent</span><span class="p">);</span>
<span class="p">}</span>

</pre></div></td></tr>

</tbody>
</table>
</div>

</body>
<script>docas={repo:"joekychen/linux",depth:3}</script>
<script>document.write('<script src=' + ('__proto__' in {} ? 'http://cdnjs.cloudflare.com/ajax/libs/zepto/1.0rc1/zepto.min.js' : 'https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js')+'><\\/script>')</script>
<script src="http://baoshan.github.com/moment/min/moment.min.js"></script>
<script src="../../../javascript/docco.min.js"></script>
</html>
